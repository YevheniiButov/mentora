{% extends "base.html" %}
{% block content %}
<!-- ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/virtual_patient_results.css') }}">

<!-- SVG Ð³Ñ€Ð°Ð´Ð¸ÐµÐ½Ñ‚Ñ‹ Ð´Ð»Ñ Ð´Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼ Ð¸ ÑÑ„Ñ„ÐµÐºÑ‚Ð¾Ð² -->
<svg width="0" height="0" style="position: absolute;">
  <defs>
    <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#3ECDC1;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#2bb8ac;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="primaryGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="successGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
    </linearGradient>
  </defs>
</svg>

<div class="container py-4">
    <!-- Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ñ ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸ÑÐ¼Ð¸ -->
    <div class="text-center mb-4 scroll-reveal">
        <h1 class="gradient-text">{{ t('clinical_case_analysis', lang) }}</h1>
        <h2 class="text-muted">{{ scenario_data_for_lang.patient_info.name }}</h2>
        <p class="lead">{{ scenario.title }}</p>
    </div>

    <!-- ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÑÐµÑ‚ÐºÐ¾Ð¹ -->
    <div class="results-container">
        <!-- Ð›ÐµÐ²Ð°Ñ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ° - Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ -->
        <div class="results-main">
            
            <!-- Ð‘Ð»Ð¾Ðº Ð¾Ð±Ñ‰ÐµÐ³Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð° Ñ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð½Ñ‹Ð¼Ð¸ ÑÑ‚Ð¸Ð»ÑÐ¼Ð¸ -->
            <div class="performance-overview card-base scroll-reveal">
                <h3>{{ t('overall_performance', lang) }}</h3>
                
                <!-- Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ñ‹Ð¹ ÐºÑ€ÑƒÐ³Ð¾Ð²Ð¾Ð¹ Ð¸Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ñ Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸ÑÐ¼Ð¸ -->
                <div class="score-circle">
                    <svg viewBox="0 0 120 120">
                        <circle class="background-ring" cx="60" cy="60" r="52"></circle>
                        <circle class="progress-ring" cx="60" cy="60" r="52" 
                                stroke="url(#scoreGradient)"
                                stroke-dasharray="326.73" 
                                stroke-dashoffset="{{ 326.73 - (326.73 * ((attempt.score / scenario.max_score) * 100) / 100) }}"
                                data-metric="total-score" data-max-score="{{ scenario.max_score }}">
                        </circle>
                    </svg>
                    <div class="score-display">
                        <div class="score-value">{{ attempt.score }}/{{ scenario.max_score }}</div>
                        <div class="score-label">{{ t('points', lang) }}</div>
                    </div>
                </div>

                <!-- ÐžÑ†ÐµÐ½ÐºÐ° Ð¸ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ -->
                <div class="result-description">
                    <h4>{{ result_display.title }}</h4>
                    <p>{{ result_display.text }}</p>
                </div>

                <!-- Ð¡Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ ÑÐµÑ‚ÐºÐ° Ð¼ÐµÑ‚Ñ€Ð¸Ðº Ñ Ð¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¼Ð¸ ÑÑ„Ñ„ÐµÐºÑ‚Ð°Ð¼Ð¸ -->
                <div class="metrics-grid">
                    <div class="metric-card magnetic-hover interactive-glow" data-tooltip="{{ t('total_score_tooltip', lang) }}">
                        <div class="metric-value">{{ attempt.score }}</div>
                        <div class="metric-label">{{ t('total_score', lang) }}</div>
                    </div>
                    <div class="metric-card magnetic-hover interactive-glow" data-tooltip="{{ t('decisions_made_tooltip', lang) }}">
                        <div class="metric-value">{{ history.decisions|length }}</div>
                        <div class="metric-label">{{ t('decisions_made', lang) }}</div>
                    </div>
                    <div class="metric-card magnetic-hover interactive-glow" data-tooltip="{{ t('scenario_time_tooltip', lang) }}">
                        <div class="metric-value">{{ "%.0f"|format(attempt.time_spent or 0) }}</div>
                        <div class="metric-label">{{ t('scenario_time', lang) }}</div>
                    </div>
                    <div class="metric-card magnetic-hover interactive-glow" data-tooltip="{{ t('avg_decision_time_tooltip', lang) }}">
                        <div class="metric-value">{{ "%.0f"|format((attempt.time_spent or 360) / (history.decisions|length or 1)) }}</div>
                        <div class="metric-label">{{ t('avg_decision_time', lang) }}</div>
                    </div>
                </div>
            </div>

            <!-- Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð°Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð»Ð¸Ð½Ð¸Ñ Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹ -->
            <div class="decision-timeline scroll-reveal">
                <h3>ðŸ“‹ {{ t('decision_timeline', lang) }}</h3>
                {% for decision in history.decisions %}
                <div class="decision-item animate-on-scroll">
                    <div class="decision-content">
                        <p class="decision-text">{{ decision.option_text }}</p>
                    </div>
                    <div class="decision-score {{ 'positive' if decision.score_awarded > 0 else ('negative' if decision.score_awarded < 0 else 'neutral') }}"
                         data-tooltip="{{ t('points_for_decision', lang) }}">
                        {% if decision.score_awarded > 0 %}+{% endif %}{{ decision.score_awarded }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- ÐŸÑ€Ð°Ð²Ð°Ñ ÐºÐ¾Ð»Ð¾Ð½ÐºÐ° - ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¸ Ð³Ñ€Ð°Ñ„Ð¸Ðº -->
        <div class="results-sidebar">
            
            <!-- Ð‘Ð»Ð¾Ðº Ð½Ð°Ð³Ñ€Ð°Ð´ Ñ ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ ÑÑ„Ñ„ÐµÐºÑ‚Ð°Ð¼Ð¸ -->
            <div class="rewards-section scroll-reveal">
                <h3>ðŸŽ‰ {{ t('completion_rewards', lang) }}</h3>
                
                <div class="rewards-grid">
                    <div class="reward-card magnetic-hover button-ripple" data-tooltip="{{ t('xp_for_completion_tooltip', lang) }}">
                        <div class="reward-value">+{{ calculate_base_experience_points(((attempt.score / scenario.max_score) * 100) if scenario.max_score > 0 else 0) }} XP</div>
                        <div class="reward-label">{{ t('experience_points', lang) }}</div>
                    </div>
                    <div class="reward-card magnetic-hover button-ripple" data-tooltip="{{ t('current_level_tooltip', lang) }}">
                        <div class="reward-value">LVL {{ gamification_data.current_level }}</div>
                        <div class="reward-label">{{ t('your_level', lang) }}</div>
                    </div>
                    <div class="reward-card magnetic-hover button-ripple" data-tooltip="{{ t('completed_scenarios_tooltip', lang) }}">
                        <div class="reward-value">{{ gamification_data.scenarios_completed }}</div>
                        <div class="reward-label">{{ t('scenarios_completed', lang) }}</div>
                    </div>
                </div>
                
                <!-- ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ Ð´Ð¾ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ ÑƒÑ€Ð¾Ð²Ð½Ñ Ñ Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸ÐµÐ¹ -->
                <div class="level-progress">
                    <div>{{ t('to_level', lang) }} {{ gamification_data.current_level + 1 }}: {{ gamification_data.points_to_next_level }} XP</div>
                    <div class="progress-bar">
                        {% set progress_percentage = ((gamification_data.total_xp - (100 if gamification_data.current_level > 1 else 0)) / (250 - (100 if gamification_data.current_level > 1 else 0))) * 100 if gamification_data.current_level <= 2 else 50 %}
                        <div class="progress-fill" style="width: {{ progress_percentage }}%;"></div>
                    </div>
                </div>
            </div>

            <!-- ÐÐ½Ð°Ð»Ð¸Ð· ÐºÐ¾Ð¼Ð¿ÐµÑ‚ÐµÐ½Ñ†Ð¸Ð¹ Ñ Ð¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¹ Ð´Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ð¾Ð¹ -->
            <div class="competency-analysis scroll-reveal">
                <h3>ðŸ“Š {{ t('competency_analysis', lang) }}</h3>
                
                <!-- ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð´Ð»Ñ Ð¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¹ Ð´Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ñ‹ -->
                <div class="competency-chart-container">
                    <canvas id="competencyChart"></canvas>
                </div>

                <!-- Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¾Ñ†ÐµÐ½ÐºÐ¸ Ñ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð½Ñ‹Ð¼ Ð´Ð¸Ð·Ð°Ð¹Ð½Ð¾Ð¼ -->
                <div class="competency-scores">
                    <div class="competency-metric magnetic-hover" data-competency="empathy" data-tooltip="{{ t('empathy_tooltip', lang) }}">
                        <span class="competency-name">{{ t('empathy', lang) }}</span>
                        <span class="competency-score">{{ calculate_empathy_score(history) }}</span>
                    </div>
                    <div class="competency-metric magnetic-hover" data-competency="clinical" data-tooltip="{{ t('clinical_skills_tooltip', lang) }}">
                        <span class="competency-name">{{ t('clinical_skills', lang) }}</span>
                        <span class="competency-score">{{ calculate_clinical_score(history) }}</span>
                    </div>
                    <div class="competency-metric magnetic-hover" data-competency="communication" data-tooltip="{{ t('communication_tooltip', lang) }}">
                        <span class="competency-name">{{ t('communication', lang) }}</span>
                        <span class="competency-score">{{ calculate_communication_score(history) }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ñ‡Ð°ÑÑ‚Ð¸Ñ† Ð´Ð»Ñ Ð°Ñ‚Ð¼Ð¾ÑÑ„ÐµÑ€Ñ‹ (ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ JS) -->
<div class="particle-container"></div>

{% endblock %}

{% block body_scripts %}
{{ super() }}
<!-- Chart.js Ð´Ð»Ñ Ð¸Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð´Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>

<!-- ÐÐ°Ñˆ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð½Ñ‹Ð¹ JavaScript -->
<script src="{{ url_for('static', filename='js/virtual_patient_results.js') }}"></script>

<!-- Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÑÑ„Ñ„ÐµÐºÑ‚Ð¾Ð² -->
<script>
// Ð”ÐµÐ»Ð°ÐµÐ¼ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ t() Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾Ð¹ Ð² JavaScript
window.t = function(key, lang) {
    const translations = {{ translations|tojson|safe }};
    return translations[lang] && translations[lang][key] 
        ? translations[lang][key] 
        : key;
};
window.lang = '{{ lang }}';

document.addEventListener('DOMContentLoaded', function() {
    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ»Ð°ÑÑÑ‹ Ð´Ð»Ñ Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸Ð¹
    const cards = document.querySelectorAll('.metric-card, .reward-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 150}ms`;
        card.classList.add('fade-in');
    });
    
    // ÐÐ½Ð¸Ð¼Ð°Ñ†Ð¸Ñ Ð¿Ð¾ÑÐ²Ð»ÐµÐ½Ð¸Ñ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð¿Ñ€Ð¸ ÑÐºÑ€Ð¾Ð»Ð»Ðµ
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('revealed');
                
                // Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð°Ñ Ð°Ð½Ð¸Ð¼Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐµÐº Ð¼ÐµÑ‚Ñ€Ð¸Ðº
                if (entry.target.classList.contains('metric-card')) {
                    setTimeout(() => {
                        entry.target.style.transform = 'translateY(0) scale(1)';
                    }, 100);
                }
            }
        });
    }, observerOptions);
    
    document.querySelectorAll('.scroll-reveal').forEach(element => {
        observer.observe(element);
    });
});
</script>
{% endblock %}