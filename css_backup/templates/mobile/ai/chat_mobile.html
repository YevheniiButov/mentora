{% extends "mobile_base.html" %}

{% set nav_config = get_navigation_config('ai_chat',
    show_logo=True,
    show_back_button=False,
    show_bottom_nav=True,
    show_profile_button=True,
    show_settings_button=True,
    show_language_selector=True,
    page_title=t('ai_assistant', lang)
) %}

{% block title %}{{ t('ai_assistant', lang) }} - Dental Academy{% endblock %}

{% block extra_css %}
<style>
    /* ===== AI CHAT СТИЛИ ===== */
    .ai-chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 160px);
        background: transparent;
    }
    
    /* Статус AI */
    .ai-status-bar {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 1rem;
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .ai-status-info {
        display: flex;
        align-items: center;
        gap: 8px;
        color: white;
    }
    
    .ai-status-icon {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #3ECDC1;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .ai-provider-selector {
        padding: 4px 12px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.8);
    }
    
    /* Область сообщений */
    .ai-messages-area {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 1rem;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    
    /* Пузырьки сообщений */
    .ai-message {
        max-width: 85%;
        animation: slideInMessage 0.3s ease-out;
    }
    
    @keyframes slideInMessage {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .ai-message.user {
        align-self: flex-end;
    }
    
    .ai-message.assistant {
        align-self: flex-start;
    }
    
    .ai-message-bubble {
        padding: 12px 16px;
        border-radius: 20px;
        position: relative;
        word-wrap: break-word;
        line-height: 1.4;
    }
    
    .ai-message.user .ai-message-bubble {
        background: linear-gradient(135deg, #3ECDC1, #2B9E94);
        color: white;
        border-bottom-right-radius: 8px;
    }
    
    .ai-message.assistant .ai-message-bubble {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-bottom-left-radius: 8px;
    }
    
    .ai-message-time {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 4px;
        text-align: right;
    }
    
    .ai-message.assistant .ai-message-time {
        text-align: left;
    }
    
    /* RAG источники */
    .ai-rag-sources {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .ai-rag-source {
        display: inline-block;
        padding: 2px 6px;
        margin: 2px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        font-size: 10px;
        color: rgba(255, 255, 255, 0.8);
    }
    
    /* Форма ввода */
    .ai-input-area {
        padding: 1rem 0;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        margin-top: auto;
    }
    
    .ai-input-form {
        display: flex;
        gap: 8px;
        padding: 0 1rem;
    }
    
    .ai-input-field {
        flex: 1;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 12px 16px;
        color: white;
        font-size: 14px;
        resize: none;
        min-height: 44px;
        max-height: 120px;
    }
    
    .ai-input-field::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }
    
    .ai-input-field:focus {
        outline: none;
        border-color: #3ECDC1;
        box-shadow: 0 0 0 2px rgba(62, 205, 193, 0.2);
    }
    
    .ai-send-button {
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, #3ECDC1, #2B9E94);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .ai-send-button:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(62, 205, 193, 0.3);
    }
    
    .ai-send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    /* Пустое состояние */
    .ai-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: rgba(255, 255, 255, 0.7);
        text-align: center;
    }
    
    .ai-empty-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.6;
    }
    
    /* Индикатор печати */
    .ai-typing-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 8px 12px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 12px;
    }
    
    .ai-typing-dots {
        display: flex;
        gap: 2px;
    }
    
    .ai-typing-dot {
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        animation: typingDot 1.4s infinite;
    }
    
    .ai-typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .ai-typing-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typingDot {
        0%, 60%, 100% { opacity: 0.3; }
        30% { opacity: 1; }
    }
    
    /* ===== НОВЫЕ СТИЛИ ДЛЯ РЕЖИМОВ ЧАТА ===== */
    
    /* AI Chat Modes */
    .ai-chat-modes {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        margin-bottom: 1rem;
        padding: 16px;
    }
    
    .modes-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    
    .modes-title {
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
        font-weight: 600;
    }
    
    .modes-selector {
        display: flex;
        gap: 6px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 4px;
    }
    
    .mode-btn {
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        min-width: 60px;
        justify-content: center;
    }
    
    .mode-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
    }
    
    .mode-btn.active {
        background: linear-gradient(135deg, #3ECDC1, #2B9E94);
        color: white;
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(62, 205, 193, 0.3);
    }
    
    .mode-btn i {
        font-size: 14px;
    }
    
    /* Quick Actions Panel */
    .quick-actions-panel {
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        padding-top: 12px;
    }
    
    .mode-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: space-between;
    }
    
    .quick-action-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.9);
        padding: 8px 12px;
        border-radius: 16px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        flex: 1;
        min-width: 90px;
        max-width: 120px;
        justify-content: center;
        text-align: center;
    }
    
    .quick-action-btn:hover {
        background: rgba(62, 205, 193, 0.3);
        border-color: rgba(62, 205, 193, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(62, 205, 193, 0.2);
    }
    
    .quick-action-btn:active {
        transform: translateY(0);
    }
    
    .quick-action-btn i {
        font-size: 12px;
    }
    
    /* Enhanced Messages Area */
    .enhanced-messages-area {
        position: relative;
    }
    
    .ai-insights-panel {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        margin-bottom: 16px;
        padding: 16px;
        animation: slideInInsights 0.4s ease-out;
    }
    
    @keyframes slideInInsights {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .insights-content {
        color: rgba(255, 255, 255, 0.9);
    }
    
    .insight-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        border-left: 3px solid #3ECDC1;
    }
    
    .insight-title {
        font-size: 13px;
        font-weight: 600;
        color: #3ECDC1;
        margin-bottom: 6px;
    }
    
    .insight-text {
        font-size: 12px;
        line-height: 1.4;
        color: rgba(255, 255, 255, 0.8);
    }
    
    .insight-stats {
        display: flex;
        gap: 12px;
        margin-top: 8px;
    }
    
    .insight-stat {
        text-align: center;
        flex: 1;
    }
    
    .insight-stat-value {
        font-size: 16px;
        font-weight: bold;
        color: #3ECDC1;
    }
    
    .insight-stat-label {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 2px;
    }
    
    /* Responsive adjustments */
    @media (max-width: 360px) {
        .mode-btn span {
            display: none;
        }
        
        .quick-action-btn {
            min-width: 80px;
            font-size: 10px;
            padding: 6px 8px;
        }
        
        .quick-action-btn span {
            display: none;
        }
    }
    
    /* ===== УЛУЧШЕННЫЕ СТИЛИ ДЛЯ РЕЖИМОВ ИИ (дополнительные) ===== */

    /* Визуализации в чате */
    .chat-visualization {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 16px;
        margin: 12px 0;
        border: 1px solid rgba(62, 205, 193, 0.2);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .viz-title {
        font-size: 15px;
        font-weight: 700;
        margin-bottom: 12px;
        color: #3ECDC1;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .viz-content {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    /* Мини-диаграммы */
    .mini-chart {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px;
        background: rgba(248, 250, 252, 0.8);
        border-radius: 8px;
        border-left: 3px solid transparent;
        transition: all 0.3s ease;
    }

    .mini-chart:hover {
        transform: translateX(4px);
        box-shadow: 0 2px 8px rgba(62, 205, 193, 0.2);
    }

    .chart-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .chart-icon.success { 
        background: linear-gradient(135deg, #28a745, #20c997); 
        border-left-color: #28a745;
    }
    .chart-icon.warning { 
        background: linear-gradient(135deg, #ffc107, #fd7e14); 
        border-left-color: #ffc107;
    }
    .chart-icon.danger { 
        background: linear-gradient(135deg, #dc3545, #e83e8c); 
        border-left-color: #dc3545;
    }
    .chart-icon.info { 
        background: linear-gradient(135deg, #17a2b8, #3ECDC1); 
        border-left-color: #17a2b8;
    }

    .chart-details {
        flex: 1;
    }

    .chart-label {
        font-size: 12px;
        color: #6c757d;
        margin-bottom: 2px;
    }

    .chart-value {
        font-size: 16px;
        font-weight: 700;
        color: #2c3e50;
    }

    .chart-trend {
        font-size: 11px;
        color: #28a745;
        margin-top: 2px;
    }

    /* Интерактивные элементы в сообщениях */
    .interactive-message {
        background: linear-gradient(135deg, rgba(248, 249, 250, 0.9) 0%, rgba(255, 255, 255, 0.9) 100%);
        border: 1px solid rgba(62, 205, 193, 0.3);
        border-radius: 12px;
        padding: 14px;
        margin: 10px 0;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    .message-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        flex-wrap: wrap;
    }

    .message-action-btn {
        padding: 6px 12px;
        border: 1px solid #3ECDC1;
        background: rgba(62, 205, 193, 0.1);
        color: #3ECDC1;
        border-radius: 16px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .message-action-btn:hover {
        background: #3ECDC1;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(62, 205, 193, 0.3);
    }

    .message-action-btn:active {
        transform: translateY(0);
    }

    /* Прогресс бары */
    .progress-container {
        margin: 8px 0;
    }

    .progress-label {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        margin-bottom: 4px;
        color: #495057;
    }

    .progress-bar-container {
        height: 8px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #3ECDC1, #2B9E94);
        border-radius: 4px;
        transition: width 0.6s ease;
        position: relative;
    }

    .progress-bar-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    /* Статистические карточки */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 8px;
        margin: 12px 0;
    }

    .stat-card-mini {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        border: 1px solid rgba(62, 205, 193, 0.2);
        transition: all 0.3s ease;
    }

    .stat-card-mini:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(62, 205, 193, 0.2);
    }

    .stat-value-mini {
        font-size: 18px;
        font-weight: 700;
        color: #3ECDC1;
        margin-bottom: 2px;
    }

    .stat-label-mini {
        font-size: 10px;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Улучшенные анимации для режимов */
    .mode-transition {
        animation: modeSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes modeSlideIn {
        from {
            opacity: 0;
            transform: translateY(-15px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* Режимная панель с улучшенными стилями */
    .mode-indicator {
        position: absolute;
        top: -2px;
        right: -2px;
        width: 8px;
        height: 8px;
        background: #28a745;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    /* Tooltip для быстрых действий */
    .quick-action-btn[title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        white-space: nowrap;
        z-index: 1000;
        margin-bottom: 4px;
    }

    /* Улучшенная мобильная адаптация */
    @media (max-width: 480px) {
        .chat-visualization {
            padding: 12px;
            margin: 8px 0;
        }
        
        .viz-title {
            font-size: 14px;
        }
        
        .mini-chart {
            padding: 8px;
            gap: 8px;
        }
        
        .chart-icon {
            width: 28px;
            height: 28px;
            font-size: 12px;
        }
        
        .chart-details {
            font-size: 11px;
        }
        
        .stats-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        
        .stat-card-mini {
            padding: 8px;
        }
        
        .stat-value-mini {
            font-size: 16px;
        }
        
        .stat-label-mini {
            font-size: 9px;
        }
        
        .message-actions {
            justify-content: space-around;
        }
        
        .message-action-btn {
            font-size: 10px;
            padding: 4px 8px;
        }
        
        .progress-container {
            margin: 6px 0;
        }
        
        .progress-bar-container {
            height: 6px;
        }
    }

    /* Темная тема для новых элементов */
    @media (prefers-color-scheme: dark) {
        .chat-visualization {
            background: rgba(30, 41, 59, 0.95);
            border-color: rgba(62, 205, 193, 0.3);
        }
        
        .interactive-message {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(51, 65, 85, 0.9) 100%);
            border-color: rgba(62, 205, 193, 0.4);
        }
        
        .mini-chart {
            background: rgba(51, 65, 85, 0.8);
        }
        
        .stat-card-mini {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(62, 205, 193, 0.3);
        }
        
        .chart-value,
        .viz-title {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .chart-label,
        .stat-label-mini {
            color: rgba(255, 255, 255, 0.6);
        }
    }

    /* ===== КОНЕЦ УЛУЧШЕННЫХ СТИЛЕЙ ===== */
</style>
{% endblock %}

{% block content %}
<div class="ai-chat-container">
    <!-- Статус бар AI -->
    <div class="ai-status-bar">
        <div class="ai-status-info">
            <div class="ai-status-icon"></div>
            <span>
                {% if has_configured_ai %}
                    {{ t('ai_ready', lang) or 'AI готов к работе' }}
                {% else %}
                    {{ t('ai_setup_required', lang) or 'Требуется настройка AI' }}
                {% endif %}
            </span>
        </div>
        <div class="ai-provider-selector">
            {% if user_providers %}
                {{ user_providers[0].provider|title }}
            {% else %}
                {{ t('no_provider', lang) or 'Нет провайдера' }}
            {% endif %}
        </div>
    </div>

    <!-- AI Chat Modes (НОВОЕ - добавить после header) -->
    <div class="ai-chat-modes" id="aiChatModes">
        <div class="modes-header">
            <span class="modes-title">Режим ИИ:</span>
            <div class="modes-selector">
                <button class="mode-btn active" data-mode="chat" id="chatMode">
                    <i class="bi bi-chat-dots"></i>
                    <span>Чат</span>
                </button>
                <button class="mode-btn" data-mode="analysis" id="analysisMode">
                    <i class="bi bi-graph-up"></i>
                    <span>Анализ</span>
                </button>
                <button class="mode-btn" data-mode="trainer" id="trainerMode">
                    <i class="bi bi-person-check"></i>
                    <span>Тренер</span>
                </button>
            </div>
        </div>
        
        <!-- Quick Actions Panel -->
        <div class="quick-actions-panel" id="quickActionsPanel">
            <!-- Контент меняется в зависимости от режима -->
            <div class="quick-actions-content" id="quickActionsContent">
                <!-- Chat Mode Actions -->
                <div class="mode-actions" data-mode="chat">
                    <button class="quick-action-btn" onclick="askQuickQuestion('Какие темы мне лучше изучить?')">
                        <i class="bi bi-lightbulb"></i>
                        <span>Что изучать?</span>
                    </button>
                    <button class="quick-action-btn" onclick="askQuickQuestion('Как подготовиться к BIG экзамену?')">
                        <i class="bi bi-book"></i>
                        <span>Подготовка к экзамену</span>
                    </button>
                    <button class="quick-action-btn" onclick="askQuickQuestion('Покажи мой прогресс')">
                        <i class="bi bi-graph-up"></i>
                        <span>Мой прогресс</span>
                    </button>
                </div>
                
                <!-- Analysis Mode Actions -->
                <div class="mode-actions" data-mode="analysis" style="display: none;">
                    <button class="quick-action-btn" onclick="requestAnalysis('exam_readiness')">
                        <i class="bi bi-clipboard-check"></i>
                        <span>Готовность к экзамену</span>
                    </button>
                    <button class="quick-action-btn" onclick="requestAnalysis('weak_areas')">
                        <i class="bi bi-exclamation-triangle"></i>
                        <span>Слабые области</span>
                    </button>
                    <button class="quick-action-btn" onclick="requestAnalysis('study_plan')">
                        <i class="bi bi-calendar-check"></i>
                        <span>План обучения</span>
                    </button>
                </div>
                
                <!-- Trainer Mode Actions -->
                <div class="mode-actions" data-mode="trainer" style="display: none;">
                    <button class="quick-action-btn" onclick="requestTraining('recommendations')">
                        <i class="bi bi-arrow-right-circle"></i>
                        <span>Рекомендации</span>
                    </button>
                    <button class="quick-action-btn" onclick="requestTraining('practice')">
                        <i class="bi bi-play-circle"></i>
                        <span>Практика</span>
                    </button>
                    <button class="quick-action-btn" onclick="requestTraining('motivation')">
                        <i class="bi bi-heart"></i>
                        <span>Мотивация</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Messages Area (расширить существующую) -->
    <div class="enhanced-messages-area">
        <!-- Добавить перед существующими сообщениями -->
        <div class="ai-insights-panel" id="aiInsightsPanel" style="display: none;">
            <div class="insights-content" id="insightsContent">
                <!-- Здесь будут визуализации и инсайты -->
            </div>
        </div>
        
        <!-- Область сообщений -->
        <div class="ai-messages-area" id="messagesArea">
            {% if recent_conversations %}
                {% for conversation in recent_conversations %}
                    <div class="ai-message user">
                        <div class="ai-message-bubble">
                            {{ conversation.user_message }}
                        </div>
                        <div class="ai-message-time">
                            {{ conversation.created_at.strftime('%H:%M') }}
                        </div>
                    </div>
                    <div class="ai-message assistant">
                        <div class="ai-message-bubble">
                            {{ conversation.ai_response }}
                            {% if conversation.sources %}
                                <div class="ai-rag-sources">
                                    {% for source in conversation.sources %}
                                        <span class="ai-rag-source">{{ source.title }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="ai-message-time">
                            {{ conversation.created_at.strftime('%H:%M') }}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="ai-empty-state">
                    <div class="ai-empty-icon">🤖</div>
                    <h3>{{ t('ai_welcome', lang) or 'Добро пожаловать в AI-ассистента!' }}</h3>
                    <p>{{ t('ai_welcome_desc', lang) or 'Задайте любой вопрос по стоматологии' }}</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Форма ввода -->
    <div class="ai-input-area">
        <form class="ai-input-form" id="chatForm">
            <textarea 
                class="ai-input-field" 
                id="messageInput"
                placeholder="{{ t('ai_input_placeholder', lang) or 'Введите ваш вопрос...' }}"
                rows="1"></textarea>
            <button type="submit" class="ai-send-button" id="sendButton">
                <i class="bi bi-send-fill"></i>
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const messagesArea = document.getElementById('messagesArea');
    
    // Автоизменение размера textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // Отправка сообщения
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;
        
        // Добавляем сообщение пользователя
        addUserMessage(message);
        
        // Очищаем поле ввода
        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        // Показываем индикатор печати
        showTypingIndicator();
        
        // Отправляем запрос к AI
        sendToAI(message);
    });
    
    function addUserMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'ai-message user';
        messageDiv.innerHTML = `
            <div class="ai-message-bubble">${escapeHtml(message)}</div>
            <div class="ai-message-time">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</div>
        `;
        messagesArea.appendChild(messageDiv);
        scrollToBottom();
    }
    
    function addAIMessage(response, sources = []) {
        // Убираем индикатор печати
        removeTypingIndicator();
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'ai-message assistant';
        
        let sourcesHtml = '';
        if (sources && sources.length > 0) {
            sourcesHtml = '<div class="ai-rag-sources">';
            sources.forEach(source => {
                sourcesHtml += `<span class="ai-rag-source">${escapeHtml(source.title || source)}</span>`;
            });
            sourcesHtml += '</div>';
        }
        
        messageDiv.innerHTML = `
            <div class="ai-message-bubble">
                ${escapeHtml(response)}
                ${sourcesHtml}
            </div>
            <div class="ai-message-time">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</div>
        `;
        messagesArea.appendChild(messageDiv);
        scrollToBottom();
    }
    
    function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'ai-message assistant';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <div class="ai-message-bubble">
                <div class="ai-typing-indicator">
                    <span>AI печатает</span>
                    <div class="ai-typing-dots">
                        <div class="ai-typing-dot"></div>
                        <div class="ai-typing-dot"></div>
                        <div class="ai-typing-dot"></div>
                    </div>
                </div>
            </div>
        `;
        messagesArea.appendChild(typingDiv);
        scrollToBottom();
    }
    
    function removeTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) {
            indicator.remove();
        }
    }
    
    function sendToAI(message) {
        fetch(`/{{ lang }}/ai-assistant/chat`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                message: message,
                use_rag: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                addAIMessage(`Ошибка: ${data.error}`);
            } else {
                addAIMessage(data.response, data.sources);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addAIMessage('Произошла ошибка при обращении к AI');
        })
        .finally(() => {
            removeTypingIndicator();
        });
    }
    
    function scrollToBottom() {
        setTimeout(() => {
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }, 100);
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Удаляем пустое состояние при первом сообщении
    const emptyState = messagesArea.querySelector('.ai-empty-state');
    if (emptyState) {
        chatForm.addEventListener('submit', function() {
            emptyState.remove();
        }, { once: true });
    }
    
    // ===== НОВЫЕ ФУНКЦИИ ДЛЯ РЕЖИМОВ ЧАТА =====
    
    // Глобальная переменная для текущего режима
    let currentChatMode = 'chat';
    
    // Инициализация режимов чата
    function initializeChatModes() {
        const modeButtons = document.querySelectorAll('.mode-btn');
        
        modeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const mode = this.dataset.mode;
                switchChatMode(mode);
            });
        });
    }
    
    // Переключение режима чата
    function switchChatMode(newMode) {
        if (currentChatMode === newMode) return;
        
        // Обновляем активную кнопку
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(newMode + 'Mode').classList.add('active');
        
        // Переключаем быстрые действия
        document.querySelectorAll('.mode-actions').forEach(actions => {
            actions.style.display = 'none';
        });
        document.querySelector(`.mode-actions[data-mode="${newMode}"]`).style.display = 'flex';
        
        // Обновляем плейсхолдер
        updateInputPlaceholder(newMode);
        
        // Скрываем инсайты при переключении из режима анализа
        if (currentChatMode === 'analysis' && newMode !== 'analysis') {
            hideInsightsPanel();
        }
        
        currentChatMode = newMode;
        
        // Добавляем системное сообщение о переключении режима
        addSystemMessage(getModeWelcomeMessage(newMode));
    }
    
    // Обновление плейсхолдера ввода
    function updateInputPlaceholder(mode) {
        const placeholders = {
            chat: 'Введите ваш вопрос...',
            analysis: 'Запросите анализ данных...',
            trainer: 'Что хотите изучить или тренировать?'
        };
        
        messageInput.placeholder = placeholders[mode] || placeholders.chat;
    }
    
    // Получение приветственного сообщения для режима
    function getModeWelcomeMessage(mode) {
        const messages = {
            chat: '💬 Режим "Чат" активирован. Задавайте любые вопросы!',
            analysis: '📊 Режим "Анализ" активирован. Запросите анализ вашего прогресса.',
            trainer: '🎯 Режим "Тренер" активирован. Получайте персональные рекомендации!'
        };
        
        return messages[mode] || messages.chat;
    }
    
    // Добавление системного сообщения
    function addSystemMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'ai-message system';
        messageDiv.style.alignSelf = 'center';
        messageDiv.style.maxWidth = '90%';
        messageDiv.innerHTML = `
            <div class="ai-message-bubble" style="background: rgba(62, 205, 193, 0.2); color: rgba(255, 255, 255, 0.9); text-align: center; font-size: 12px;">
                ${message}
            </div>
        `;
        messagesArea.appendChild(messageDiv);
        scrollToBottom();
    }
    
    // Быстрые вопросы для режима чата
    window.askQuickQuestion = function(question) {
        messageInput.value = question;
        chatForm.dispatchEvent(new Event('submit'));
    };
    
    // Запрос анализа для режима анализа
    window.requestAnalysis = function(analysisType) {
        showInsightsPanel();
        
        const analysisMessages = {
            exam_readiness: 'Анализирую вашу готовность к экзамену...',
            weak_areas: 'Определяю ваши слабые области...',
            study_plan: 'Создаю персональный план обучения...'
        };
        
        // Показываем сообщение о начале анализа
        addAIMessage(analysisMessages[analysisType] || 'Выполняю анализ...');
        
        // Симулируем загрузку анализа
        setTimeout(() => {
            displayAnalysisResults(analysisType);
        }, 2000);
    };
    
    // Запрос тренировки для режима тренера
    window.requestTraining = function(trainingType) {
        const trainingMessages = {
            recommendations: 'Подготавливаю персональные рекомендации...',
            practice: 'Подбираю практические задания...',
            motivation: 'Формирую мотивационный план...'
        };
        
        addAIMessage(trainingMessages[trainingType] || 'Подготавливаю материал...');
        
        // Симулируем ответ тренера
        setTimeout(() => {
            displayTrainingResults(trainingType);
        }, 1500);
    };
    
    // Показать панель инсайтов
    function showInsightsPanel() {
        const panel = document.getElementById('aiInsightsPanel');
        if (panel) {
            panel.style.display = 'block';
        }
    }
    
    // Скрыть панель инсайтов
    function hideInsightsPanel() {
        const panel = document.getElementById('aiInsightsPanel');
        if (panel) {
            panel.style.display = 'none';
        }
    }
    
    // Отображение результатов анализа
    function displayAnalysisResults(analysisType) {
        const content = document.getElementById('insightsContent');
        
        const analysisResults = {
            exam_readiness: `
                <div class="insight-card">
                    <div class="insight-title">📊 Готовность к экзамену</div>
                    <div class="insight-text">Ваша текущая готовность к BIG экзамену составляет 75%</div>
                    <div class="insight-stats">
                        <div class="insight-stat">
                            <div class="insight-stat-value">75%</div>
                            <div class="insight-stat-label">Готовность</div>
                        </div>
                        <div class="insight-stat">
                            <div class="insight-stat-value">6</div>
                            <div class="insight-stat-label">Слабых тем</div>
                        </div>
                        <div class="insight-stat">
                            <div class="insight-stat-value">14</div>
                            <div class="insight-stat-label">Дней до цели</div>
                        </div>
                    </div>
                </div>
            `,
            weak_areas: `
                <div class="insight-card">
                    <div class="insight-title">⚠️ Слабые области</div>
                    <div class="insight-text">Обнаружены следующие области для улучшения:</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">1. Эндодонтия</div>
                    <div class="insight-text">Точность ответов: 45% • Рекомендуется дополнительная практика</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">2. Пародонтология</div>
                    <div class="insight-text">Точность ответов: 60% • Изучите клинические случаи</div>
                </div>
            `,
            study_plan: `
                <div class="insight-card">
                    <div class="insight-title">📅 Персональный план обучения</div>
                    <div class="insight-text">Оптимальный план на следующие 2 недели:</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">Неделя 1: Эндодонтия</div>
                    <div class="insight-text">3 часа теории + 2 часа практики ежедневно</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">Неделя 2: Пародонтология</div>
                    <div class="insight-text">2 часа теории + 3 часа клинических случаев</div>
                </div>
            `
        };
        
        content.innerHTML = analysisResults[analysisType] || '<div class="insight-card"><div class="insight-text">Анализ завершен!</div></div>';
        
        // Добавляем сообщение в чат
        addAIMessage(`Анализ "${analysisType}" завершен! Результаты отображены выше.`);
    }
    
    // Отображение результатов тренировки
    function displayTrainingResults(trainingType) {
        const trainingResults = {
            recommendations: 'На основе вашего прогресса рекомендую сосредоточиться на эндодонтии и пародонтологии. Начните с теоретических основ, затем переходите к клиническим случаям.',
            practice: 'Подготовил для вас 5 практических заданий по слабым темам. Начните с простых случаев и постепенно переходите к более сложным.',
            motivation: 'Помните: каждый правильный ответ приближает вас к цели! Вы уже прошли 60% пути. Сделайте перерыв, когда устанете, и празднуйте маленькие победы! 🎉'
        };
        
        addAIMessage(trainingResults[trainingType] || 'Тренировка готова!');
    }
    
    // Модификация существующей функции отправки для учета режима
    const originalSendToAI = sendToAI;
    sendToAI = function(message) {
        // Добавляем информацию о режиме к сообщению
        const enhancedMessage = {
            message: message,
            mode: currentChatMode,
            use_rag: true
        };
        
        fetch(`/{{ lang }}/ai-assistant/chat`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify(enhancedMessage)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                addAIMessage(`Ошибка: ${data.error}`);
            } else {
                addAIMessage(data.response, data.sources);
                
                // Если это режим анализа, показываем дополнительные инсайты
                if (currentChatMode === 'analysis' && data.insights) {
                    showInsightsPanel();
                    displayInsights(data.insights);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addAIMessage('Произошла ошибка при обращении к AI');
        })
        .finally(() => {
            removeTypingIndicator();
        });
    };
    
    // Инициализируем режимы чата при загрузке
    initializeChatModes();
});
</script>
{% endblock %} 