{% extends "mobile_base.html" %}

{% set nav_config = get_navigation_config('ai_chat',
    show_logo=True,
    show_back_button=False,
    show_bottom_nav=True,
    show_profile_button=True,
    show_settings_button=True,
    show_language_selector=True,
    page_title=t('ai_assistant', lang)
) %}

{% block title %}{{ t('ai_assistant', lang) }} - Dental Academy{% endblock %}

{% block extra_css %}
<style>
    /* ===== AI CHAT –°–¢–ò–õ–ò ===== */
    .ai-chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 160px);
        background: transparent;
    }
    
    /* –°—Ç–∞—Ç—É—Å AI */
    .ai-status-bar {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        margin-bottom: 1rem;
        border-radius: 12px;
        padding: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .ai-status-info {
        display: flex;
        align-items: center;
        gap: 8px;
        color: white;
    }
    
    .ai-status-icon {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #3ECDC1;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    
    .ai-provider-selector {
        padding: 4px 12px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.8);
    }
    
    /* –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π */
    .ai-messages-area {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 1rem;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    
    /* –ü—É–∑—ã—Ä—å–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π */
    .ai-message {
        max-width: 85%;
        animation: slideInMessage 0.3s ease-out;
    }
    
    @keyframes slideInMessage {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .ai-message.user {
        align-self: flex-end;
    }
    
    .ai-message.assistant {
        align-self: flex-start;
    }
    
    .ai-message-bubble {
        padding: 12px 16px;
        border-radius: 20px;
        position: relative;
        word-wrap: break-word;
        line-height: 1.4;
    }
    
    .ai-message.user .ai-message-bubble {
        background: linear-gradient(135deg, #3ECDC1, #2B9E94);
        color: white;
        border-bottom-right-radius: 8px;
    }
    
    .ai-message.assistant .ai-message-bubble {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-bottom-left-radius: 8px;
    }
    
    .ai-message-time {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 4px;
        text-align: right;
    }
    
    .ai-message.assistant .ai-message-time {
        text-align: left;
    }
    
    /* RAG –∏—Å—Ç–æ—á–Ω–∏–∫–∏ */
    .ai-rag-sources {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .ai-rag-source {
        display: inline-block;
        padding: 2px 6px;
        margin: 2px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        font-size: 10px;
        color: rgba(255, 255, 255, 0.8);
    }
    
    /* –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ */
    .ai-input-area {
        padding: 1rem 0;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        margin-top: auto;
    }
    
    .ai-input-form {
        display: flex;
        gap: 8px;
        padding: 0 1rem;
    }
    
    .ai-input-field {
        flex: 1;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 12px 16px;
        color: white;
        font-size: 14px;
        resize: none;
        min-height: 44px;
        max-height: 120px;
    }
    
    .ai-input-field::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }
    
    .ai-input-field:focus {
        outline: none;
        border-color: #3ECDC1;
        box-shadow: 0 0 0 2px rgba(62, 205, 193, 0.2);
    }
    
    .ai-send-button {
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, #3ECDC1, #2B9E94);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .ai-send-button:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 15px rgba(62, 205, 193, 0.3);
    }
    
    .ai-send-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
    .ai-empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        color: rgba(255, 255, 255, 0.7);
        text-align: center;
    }
    
    .ai-empty-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.6;
    }
    
    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ */
    .ai-typing-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 8px 12px;
        color: rgba(255, 255, 255, 0.7);
        font-size: 12px;
    }
    
    .ai-typing-dots {
        display: flex;
        gap: 2px;
    }
    
    .ai-typing-dot {
        width: 4px;
        height: 4px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.5);
        animation: typingDot 1.4s infinite;
    }
    
    .ai-typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .ai-typing-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes typingDot {
        0%, 60%, 100% { opacity: 0.3; }
        30% { opacity: 1; }
    }
    
    /* ===== –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –†–ï–ñ–ò–ú–û–í –ß–ê–¢–ê ===== */
    
    /* AI Chat Modes */
    .ai-chat-modes {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        margin-bottom: 1rem;
        padding: 16px;
    }
    
    .modes-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
    }
    
    .modes-title {
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
        font-weight: 600;
    }
    
    .modes-selector {
        display: flex;
        gap: 6px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        padding: 4px;
    }
    
    .mode-btn {
        background: transparent;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        min-width: 60px;
        justify-content: center;
    }
    
    .mode-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
    }
    
    .mode-btn.active {
        background: linear-gradient(135deg, #3ECDC1, #2B9E94);
        color: white;
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(62, 205, 193, 0.3);
    }
    
    .mode-btn i {
        font-size: 14px;
    }
    
    /* Quick Actions Panel */
    .quick-actions-panel {
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        padding-top: 12px;
    }
    
    .mode-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: space-between;
    }
    
    .quick-action-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.9);
        padding: 8px 12px;
        border-radius: 16px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        flex: 1;
        min-width: 90px;
        max-width: 120px;
        justify-content: center;
        text-align: center;
    }
    
    .quick-action-btn:hover {
        background: rgba(62, 205, 193, 0.3);
        border-color: rgba(62, 205, 193, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(62, 205, 193, 0.2);
    }
    
    .quick-action-btn:active {
        transform: translateY(0);
    }
    
    .quick-action-btn i {
        font-size: 12px;
    }
    
    /* Enhanced Messages Area */
    .enhanced-messages-area {
        position: relative;
    }
    
    .ai-insights-panel {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        margin-bottom: 16px;
        padding: 16px;
        animation: slideInInsights 0.4s ease-out;
    }
    
    @keyframes slideInInsights {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .insights-content {
        color: rgba(255, 255, 255, 0.9);
    }
    
    .insight-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        border-left: 3px solid #3ECDC1;
    }
    
    .insight-title {
        font-size: 13px;
        font-weight: 600;
        color: #3ECDC1;
        margin-bottom: 6px;
    }
    
    .insight-text {
        font-size: 12px;
        line-height: 1.4;
        color: rgba(255, 255, 255, 0.8);
    }
    
    .insight-stats {
        display: flex;
        gap: 12px;
        margin-top: 8px;
    }
    
    .insight-stat {
        text-align: center;
        flex: 1;
    }
    
    .insight-stat-value {
        font-size: 16px;
        font-weight: bold;
        color: #3ECDC1;
    }
    
    .insight-stat-label {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 2px;
    }
    
    /* Responsive adjustments */
    @media (max-width: 360px) {
        .mode-btn span {
            display: none;
        }
        
        .quick-action-btn {
            min-width: 80px;
            font-size: 10px;
            padding: 6px 8px;
        }
        
        .quick-action-btn span {
            display: none;
        }
    }
    
    /* ===== –£–õ–£–ß–®–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –†–ï–ñ–ò–ú–û–í –ò–ò (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ) ===== */

    /* –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ —á–∞—Ç–µ */
    .chat-visualization {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 16px;
        margin: 12px 0;
        border: 1px solid rgba(62, 205, 193, 0.2);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .viz-title {
        font-size: 15px;
        font-weight: 700;
        margin-bottom: 12px;
        color: #3ECDC1;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .viz-content {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    /* –ú–∏–Ω–∏-–¥–∏–∞–≥—Ä–∞–º–º—ã */
    .mini-chart {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px;
        background: rgba(248, 250, 252, 0.8);
        border-radius: 8px;
        border-left: 3px solid transparent;
        transition: all 0.3s ease;
    }

    .mini-chart:hover {
        transform: translateX(4px);
        box-shadow: 0 2px 8px rgba(62, 205, 193, 0.2);
    }

    .chart-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .chart-icon.success { 
        background: linear-gradient(135deg, #28a745, #20c997); 
        border-left-color: #28a745;
    }
    .chart-icon.warning { 
        background: linear-gradient(135deg, #ffc107, #fd7e14); 
        border-left-color: #ffc107;
    }
    .chart-icon.danger { 
        background: linear-gradient(135deg, #dc3545, #e83e8c); 
        border-left-color: #dc3545;
    }
    .chart-icon.info { 
        background: linear-gradient(135deg, #17a2b8, #3ECDC1); 
        border-left-color: #17a2b8;
    }

    .chart-details {
        flex: 1;
    }

    .chart-label {
        font-size: 12px;
        color: #6c757d;
        margin-bottom: 2px;
    }

    .chart-value {
        font-size: 16px;
        font-weight: 700;
        color: #2c3e50;
    }

    .chart-trend {
        font-size: 11px;
        color: #28a745;
        margin-top: 2px;
    }

    /* –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö */
    .interactive-message {
        background: linear-gradient(135deg, rgba(248, 249, 250, 0.9) 0%, rgba(255, 255, 255, 0.9) 100%);
        border: 1px solid rgba(62, 205, 193, 0.3);
        border-radius: 12px;
        padding: 14px;
        margin: 10px 0;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    .message-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        flex-wrap: wrap;
    }

    .message-action-btn {
        padding: 6px 12px;
        border: 1px solid #3ECDC1;
        background: rgba(62, 205, 193, 0.1);
        color: #3ECDC1;
        border-radius: 16px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .message-action-btn:hover {
        background: #3ECDC1;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(62, 205, 193, 0.3);
    }

    .message-action-btn:active {
        transform: translateY(0);
    }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä—ã */
    .progress-container {
        margin: 8px 0;
    }

    .progress-label {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        margin-bottom: 4px;
        color: #495057;
    }

    .progress-bar-container {
        height: 8px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #3ECDC1, #2B9E94);
        border-radius: 4px;
        transition: width 0.6s ease;
        position: relative;
    }

    .progress-bar-fill::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    /* –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 8px;
        margin: 12px 0;
    }

    .stat-card-mini {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        border: 1px solid rgba(62, 205, 193, 0.2);
        transition: all 0.3s ease;
    }

    .stat-card-mini:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(62, 205, 193, 0.2);
    }

    .stat-value-mini {
        font-size: 18px;
        font-weight: 700;
        color: #3ECDC1;
        margin-bottom: 2px;
    }

    .stat-label-mini {
        font-size: 10px;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —Ä–µ–∂–∏–º–æ–≤ */
    .mode-transition {
        animation: modeSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes modeSlideIn {
        from {
            opacity: 0;
            transform: translateY(-15px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    /* –†–µ–∂–∏–º–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ —Å—Ç–∏–ª—è–º–∏ */
    .mode-indicator {
        position: absolute;
        top: -2px;
        right: -2px;
        width: 8px;
        height: 8px;
        background: #28a745;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    /* Tooltip –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π */
    .quick-action-btn[title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        white-space: nowrap;
        z-index: 1000;
        margin-bottom: 4px;
    }

    /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –º–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width: 480px) {
        .chat-visualization {
            padding: 12px;
            margin: 8px 0;
        }
        
        .viz-title {
            font-size: 14px;
        }
        
        .mini-chart {
            padding: 8px;
            gap: 8px;
        }
        
        .chart-icon {
            width: 28px;
            height: 28px;
            font-size: 12px;
        }
        
        .chart-details {
            font-size: 11px;
        }
        
        .stats-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }
        
        .stat-card-mini {
            padding: 8px;
        }
        
        .stat-value-mini {
            font-size: 16px;
        }
        
        .stat-label-mini {
            font-size: 9px;
        }
        
        .message-actions {
            justify-content: space-around;
        }
        
        .message-action-btn {
            font-size: 10px;
            padding: 4px 8px;
        }
        
        .progress-container {
            margin: 6px 0;
        }
        
        .progress-bar-container {
            height: 6px;
        }
    }

    /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
    @media (prefers-color-scheme: dark) {
        .chat-visualization {
            background: rgba(30, 41, 59, 0.95);
            border-color: rgba(62, 205, 193, 0.3);
        }
        
        .interactive-message {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(51, 65, 85, 0.9) 100%);
            border-color: rgba(62, 205, 193, 0.4);
        }
        
        .mini-chart {
            background: rgba(51, 65, 85, 0.8);
        }
        
        .stat-card-mini {
            background: rgba(30, 41, 59, 0.9);
            border-color: rgba(62, 205, 193, 0.3);
        }
        
        .chart-value,
        .viz-title {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .chart-label,
        .stat-label-mini {
            color: rgba(255, 255, 255, 0.6);
        }
    }

    /* ===== –ö–û–ù–ï–¶ –£–õ–£–ß–®–ï–ù–ù–´–• –°–¢–ò–õ–ï–ô ===== */
</style>
{% endblock %}

{% block content %}
<div class="ai-chat-container">
    <!-- –°—Ç–∞—Ç—É—Å –±–∞—Ä AI -->
    <div class="ai-status-bar">
        <div class="ai-status-info">
            <div class="ai-status-icon"></div>
            <span>
                {% if has_configured_ai %}
                    {{ t('ai_ready', lang) or 'AI –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ' }}
                {% else %}
                    {{ t('ai_setup_required', lang) or '–¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ AI' }}
                {% endif %}
            </span>
        </div>
        <div class="ai-provider-selector">
            {% if user_providers %}
                {{ user_providers[0].provider|title }}
            {% else %}
                {{ t('no_provider', lang) or '–ù–µ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞' }}
            {% endif %}
        </div>
    </div>

    <!-- AI Chat Modes (–ù–û–í–û–ï - –¥–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ header) -->
    <div class="ai-chat-modes" id="aiChatModes">
        <div class="modes-header">
            <span class="modes-title">–†–µ–∂–∏–º –ò–ò:</span>
            <div class="modes-selector">
                <button class="mode-btn active" data-mode="chat" id="chatMode">
                    <i class="bi bi-chat-dots"></i>
                    <span>–ß–∞—Ç</span>
                </button>
                <button class="mode-btn" data-mode="analysis" id="analysisMode">
                    <i class="bi bi-graph-up"></i>
                    <span>–ê–Ω–∞–ª–∏–∑</span>
                </button>
                <button class="mode-btn" data-mode="trainer" id="trainerMode">
                    <i class="bi bi-person-check"></i>
                    <span>–¢—Ä–µ–Ω–µ—Ä</span>
                </button>
            </div>
        </div>
        
        <!-- Quick Actions Panel -->
        <div class="quick-actions-panel" id="quickActionsPanel">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –º–µ–Ω—è–µ—Ç—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ -->
            <div class="quick-actions-content" id="quickActionsContent">
                <!-- Chat Mode Actions -->
                <div class="mode-actions" data-mode="chat">
                    <button class="quick-action-btn" onclick="askQuickQuestion('–ö–∞–∫–∏–µ —Ç–µ–º—ã –º–Ω–µ –ª—É—á—à–µ –∏–∑—É—á–∏—Ç—å?')">
                        <i class="bi bi-lightbulb"></i>
                        <span>–ß—Ç–æ –∏–∑—É—á–∞—Ç—å?</span>
                    </button>
                    <button class="quick-action-btn" onclick="askQuickQuestion('–ö–∞–∫ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ BIG —ç–∫–∑–∞–º–µ–Ω—É?')">
                        <i class="bi bi-book"></i>
                        <span>–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —ç–∫–∑–∞–º–µ–Ω—É</span>
                    </button>
                    <button class="quick-action-btn" onclick="askQuickQuestion('–ü–æ–∫–∞–∂–∏ –º–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å')">
                        <i class="bi bi-graph-up"></i>
                        <span>–ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å</span>
                    </button>
                </div>
                
                <!-- Analysis Mode Actions -->
                <div class="mode-actions" data-mode="analysis" style="display: none;">
                    <button class="quick-action-btn" onclick="requestAnalysis('exam_readiness')">
                        <i class="bi bi-clipboard-check"></i>
                        <span>–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —ç–∫–∑–∞–º–µ–Ω—É</span>
                    </button>
                    <button class="quick-action-btn" onclick="requestAnalysis('weak_areas')">
                        <i class="bi bi-exclamation-triangle"></i>
                        <span>–°–ª–∞–±—ã–µ –æ–±–ª–∞—Å—Ç–∏</span>
                    </button>
                    <button class="quick-action-btn" onclick="requestAnalysis('study_plan')">
                        <i class="bi bi-calendar-check"></i>
                        <span>–ü–ª–∞–Ω –æ–±—É—á–µ–Ω–∏—è</span>
                    </button>
                </div>
                
                <!-- Trainer Mode Actions -->
                <div class="mode-actions" data-mode="trainer" style="display: none;">
                    <button class="quick-action-btn" onclick="requestTraining('recommendations')">
                        <i class="bi bi-arrow-right-circle"></i>
                        <span>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</span>
                    </button>
                    <button class="quick-action-btn" onclick="requestTraining('practice')">
                        <i class="bi bi-play-circle"></i>
                        <span>–ü—Ä–∞–∫—Ç–∏–∫–∞</span>
                    </button>
                    <button class="quick-action-btn" onclick="requestTraining('motivation')">
                        <i class="bi bi-heart"></i>
                        <span>–ú–æ—Ç–∏–≤–∞—Ü–∏—è</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Messages Area (—Ä–∞—Å—à–∏—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é) -->
    <div class="enhanced-messages-area">
        <!-- –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ -->
        <div class="ai-insights-panel" id="aiInsightsPanel" style="display: none;">
            <div class="insights-content" id="insightsContent">
                <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –∏–Ω—Å–∞–π—Ç—ã -->
            </div>
        </div>
        
        <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
        <div class="ai-messages-area" id="messagesArea">
            {% if recent_conversations %}
                {% for conversation in recent_conversations %}
                    <div class="ai-message user">
                        <div class="ai-message-bubble">
                            {{ conversation.user_message }}
                        </div>
                        <div class="ai-message-time">
                            {{ conversation.created_at.strftime('%H:%M') }}
                        </div>
                    </div>
                    <div class="ai-message assistant">
                        <div class="ai-message-bubble">
                            {{ conversation.ai_response }}
                            {% if conversation.sources %}
                                <div class="ai-rag-sources">
                                    {% for source in conversation.sources %}
                                        <span class="ai-rag-source">{{ source.title }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="ai-message-time">
                            {{ conversation.created_at.strftime('%H:%M') }}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="ai-empty-state">
                    <div class="ai-empty-icon">ü§ñ</div>
                    <h3>{{ t('ai_welcome', lang) or '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞!' }}</h3>
                    <p>{{ t('ai_welcome_desc', lang) or '–ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –ø–æ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏–∏' }}</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ -->
    <div class="ai-input-area">
        <form class="ai-input-form" id="chatForm">
            <textarea 
                class="ai-input-field" 
                id="messageInput"
                placeholder="{{ t('ai_input_placeholder', lang) or '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å...' }}"
                rows="1"></textarea>
            <button type="submit" class="ai-send-button" id="sendButton">
                <i class="bi bi-send-fill"></i>
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const messagesArea = document.getElementById('messagesArea');
    
    // –ê–≤—Ç–æ–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        addUserMessage(message);
        
        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        messageInput.value = '';
        messageInput.style.height = 'auto';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        showTypingIndicator();
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ AI
        sendToAI(message);
    });
    
    function addUserMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'ai-message user';
        messageDiv.innerHTML = `
            <div class="ai-message-bubble">${escapeHtml(message)}</div>
            <div class="ai-message-time">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</div>
        `;
        messagesArea.appendChild(messageDiv);
        scrollToBottom();
    }
    
    function addAIMessage(response, sources = []) {
        // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        removeTypingIndicator();
        
        const messageDiv = document.createElement('div');
        messageDiv.className = 'ai-message assistant';
        
        let sourcesHtml = '';
        if (sources && sources.length > 0) {
            sourcesHtml = '<div class="ai-rag-sources">';
            sources.forEach(source => {
                sourcesHtml += `<span class="ai-rag-source">${escapeHtml(source.title || source)}</span>`;
            });
            sourcesHtml += '</div>';
        }
        
        messageDiv.innerHTML = `
            <div class="ai-message-bubble">
                ${escapeHtml(response)}
                ${sourcesHtml}
            </div>
            <div class="ai-message-time">${new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</div>
        `;
        messagesArea.appendChild(messageDiv);
        scrollToBottom();
    }
    
    function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'ai-message assistant';
        typingDiv.id = 'typingIndicator';
        typingDiv.innerHTML = `
            <div class="ai-message-bubble">
                <div class="ai-typing-indicator">
                    <span>AI –ø–µ—á–∞—Ç–∞–µ—Ç</span>
                    <div class="ai-typing-dots">
                        <div class="ai-typing-dot"></div>
                        <div class="ai-typing-dot"></div>
                        <div class="ai-typing-dot"></div>
                    </div>
                </div>
            </div>
        `;
        messagesArea.appendChild(typingDiv);
        scrollToBottom();
    }
    
    function removeTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) {
            indicator.remove();
        }
    }
    
    function sendToAI(message) {
        fetch(`/{{ lang }}/ai-assistant/chat`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                message: message,
                use_rag: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                addAIMessage(`–û—à–∏–±–∫–∞: ${data.error}`);
            } else {
                addAIMessage(data.response, data.sources);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addAIMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ AI');
        })
        .finally(() => {
            removeTypingIndicator();
        });
    }
    
    function scrollToBottom() {
        setTimeout(() => {
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }, 100);
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
    const emptyState = messagesArea.querySelector('.ai-empty-state');
    if (emptyState) {
        chatForm.addEventListener('submit', function() {
            emptyState.remove();
        }, { once: true });
    }
    
    // ===== –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ï–ñ–ò–ú–û–í –ß–ê–¢–ê =====
    
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞
    let currentChatMode = 'chat';
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∂–∏–º–æ–≤ —á–∞—Ç–∞
    function initializeChatModes() {
        const modeButtons = document.querySelectorAll('.mode-btn');
        
        modeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const mode = this.dataset.mode;
                switchChatMode(mode);
            });
        });
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —á–∞—Ç–∞
    function switchChatMode(newMode) {
        if (currentChatMode === newMode) return;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(newMode + 'Mode').classList.add('active');
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
        document.querySelectorAll('.mode-actions').forEach(actions => {
            actions.style.display = 'none';
        });
        document.querySelector(`.mode-actions[data-mode="${newMode}"]`).style.display = 'flex';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
        updateInputPlaceholder(newMode);
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Å–∞–π—Ç—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ –∞–Ω–∞–ª–∏–∑–∞
        if (currentChatMode === 'analysis' && newMode !== 'analysis') {
            hideInsightsPanel();
        }
        
        currentChatMode = newMode;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞
        addSystemMessage(getModeWelcomeMessage(newMode));
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ –≤–≤–æ–¥–∞
    function updateInputPlaceholder(mode) {
        const placeholders = {
            chat: '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å...',
            analysis: '–ó–∞–ø—Ä–æ—Å–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö...',
            trainer: '–ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑—É—á–∏—Ç—å –∏–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å?'
        };
        
        messageInput.placeholder = placeholders[mode] || placeholders.chat;
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–µ–∂–∏–º–∞
    function getModeWelcomeMessage(mode) {
        const messages = {
            chat: 'üí¨ –†–µ–∂–∏–º "–ß–∞—Ç" –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ó–∞–¥–∞–≤–∞–π—Ç–µ –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã!',
            analysis: 'üìä –†–µ–∂–∏–º "–ê–Ω–∞–ª–∏–∑" –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ó–∞–ø—Ä–æ—Å–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –≤–∞—à–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.',
            trainer: 'üéØ –†–µ–∂–∏–º "–¢—Ä–µ–Ω–µ—Ä" –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ü–æ–ª—É—á–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏!'
        };
        
        return messages[mode] || messages.chat;
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    function addSystemMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'ai-message system';
        messageDiv.style.alignSelf = 'center';
        messageDiv.style.maxWidth = '90%';
        messageDiv.innerHTML = `
            <div class="ai-message-bubble" style="background: rgba(62, 205, 193, 0.2); color: rgba(255, 255, 255, 0.9); text-align: center; font-size: 12px;">
                ${message}
            </div>
        `;
        messagesArea.appendChild(messageDiv);
        scrollToBottom();
    }
    
    // –ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Ä–µ–∂–∏–º–∞ —á–∞—Ç–∞
    window.askQuickQuestion = function(question) {
        messageInput.value = question;
        chatForm.dispatchEvent(new Event('submit'));
    };
    
    // –ó–∞–ø—Ä–æ—Å –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è —Ä–µ–∂–∏–º–∞ –∞–Ω–∞–ª–∏–∑–∞
    window.requestAnalysis = function(analysisType) {
        showInsightsPanel();
        
        const analysisMessages = {
            exam_readiness: '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –≤–∞—à—É –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —ç–∫–∑–∞–º–µ–Ω—É...',
            weak_areas: '–û–ø—Ä–µ–¥–µ–ª—è—é –≤–∞—à–∏ —Å–ª–∞–±—ã–µ –æ–±–ª–∞—Å—Ç–∏...',
            study_plan: '–°–æ–∑–¥–∞—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –æ–±—É—á–µ–Ω–∏—è...'
        };
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –∞–Ω–∞–ª–∏–∑–∞
        addAIMessage(analysisMessages[analysisType] || '–í—ã–ø–æ–ª–Ω—è—é –∞–Ω–∞–ª–∏–∑...');
        
        // –°–∏–º—É–ª–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∞–Ω–∞–ª–∏–∑–∞
        setTimeout(() => {
            displayAnalysisResults(analysisType);
        }, 2000);
    };
    
    // –ó–∞–ø—Ä–æ—Å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Ç—Ä–µ–Ω–µ—Ä–∞
    window.requestTraining = function(trainingType) {
        const trainingMessages = {
            recommendations: '–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏...',
            practice: '–ü–æ–¥–±–∏—Ä–∞—é –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è...',
            motivation: '–§–æ—Ä–º–∏—Ä—É—é –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–ª–∞–Ω...'
        };
        
        addAIMessage(trainingMessages[trainingType] || '–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞—é –º–∞—Ç–µ—Ä–∏–∞–ª...');
        
        // –°–∏–º—É–ª–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —Ç—Ä–µ–Ω–µ—Ä–∞
        setTimeout(() => {
            displayTrainingResults(trainingType);
        }, 1500);
    };
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å –∏–Ω—Å–∞–π—Ç–æ–≤
    function showInsightsPanel() {
        const panel = document.getElementById('aiInsightsPanel');
        if (panel) {
            panel.style.display = 'block';
        }
    }
    
    // –°–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –∏–Ω—Å–∞–π—Ç–æ–≤
    function hideInsightsPanel() {
        const panel = document.getElementById('aiInsightsPanel');
        if (panel) {
            panel.style.display = 'none';
        }
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
    function displayAnalysisResults(analysisType) {
        const content = document.getElementById('insightsContent');
        
        const analysisResults = {
            exam_readiness: `
                <div class="insight-card">
                    <div class="insight-title">üìä –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —ç–∫–∑–∞–º–µ–Ω—É</div>
                    <div class="insight-text">–í–∞—à–∞ —Ç–µ–∫—É—â–∞—è –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ BIG —ç–∫–∑–∞–º–µ–Ω—É —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 75%</div>
                    <div class="insight-stats">
                        <div class="insight-stat">
                            <div class="insight-stat-value">75%</div>
                            <div class="insight-stat-label">–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å</div>
                        </div>
                        <div class="insight-stat">
                            <div class="insight-stat-value">6</div>
                            <div class="insight-stat-label">–°–ª–∞–±—ã—Ö —Ç–µ–º</div>
                        </div>
                        <div class="insight-stat">
                            <div class="insight-stat-value">14</div>
                            <div class="insight-stat-label">–î–Ω–µ–π –¥–æ —Ü–µ–ª–∏</div>
                        </div>
                    </div>
                </div>
            `,
            weak_areas: `
                <div class="insight-card">
                    <div class="insight-title">‚ö†Ô∏è –°–ª–∞–±—ã–µ –æ–±–ª–∞—Å—Ç–∏</div>
                    <div class="insight-text">–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –æ–±–ª–∞—Å—Ç–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è:</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">1. –≠–Ω–¥–æ–¥–æ–Ω—Ç–∏—è</div>
                    <div class="insight-text">–¢–æ—á–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤: 45% ‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">2. –ü–∞—Ä–æ–¥–æ–Ω—Ç–æ–ª–æ–≥–∏—è</div>
                    <div class="insight-text">–¢–æ—á–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤: 60% ‚Ä¢ –ò–∑—É—á–∏—Ç–µ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ —Å–ª—É—á–∞–∏</div>
                </div>
            `,
            study_plan: `
                <div class="insight-card">
                    <div class="insight-title">üìÖ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –æ–±—É—á–µ–Ω–∏—è</div>
                    <div class="insight-text">–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ 2 –Ω–µ–¥–µ–ª–∏:</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">–ù–µ–¥–µ–ª—è 1: –≠–Ω–¥–æ–¥–æ–Ω—Ç–∏—è</div>
                    <div class="insight-text">3 —á–∞—Å–∞ —Ç–µ–æ—Ä–∏–∏ + 2 —á–∞—Å–∞ –ø—Ä–∞–∫—Ç–∏–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ</div>
                </div>
                <div class="insight-card">
                    <div class="insight-title">–ù–µ–¥–µ–ª—è 2: –ü–∞—Ä–æ–¥–æ–Ω—Ç–æ–ª–æ–≥–∏—è</div>
                    <div class="insight-text">2 —á–∞—Å–∞ —Ç–µ–æ—Ä–∏–∏ + 3 —á–∞—Å–∞ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏—Ö —Å–ª—É—á–∞–µ–≤</div>
                </div>
            `
        };
        
        content.innerHTML = analysisResults[analysisType] || '<div class="insight-card"><div class="insight-text">–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!</div></div>';
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
        addAIMessage(`–ê–Ω–∞–ª–∏–∑ "${analysisType}" –∑–∞–≤–µ—Ä—à–µ–Ω! –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –≤—ã—à–µ.`);
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
    function displayTrainingResults(trainingType) {
        const trainingResults = {
            recommendations: '–ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é —Å–æ—Å—Ä–µ–¥–æ—Ç–æ—á–∏—Ç—å—Å—è –Ω–∞ —ç–Ω–¥–æ–¥–æ–Ω—Ç–∏–∏ –∏ –ø–∞—Ä–æ–¥–æ–Ω—Ç–æ–ª–æ–≥–∏–∏. –ù–∞—á–Ω–∏—Ç–µ —Å —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Å–Ω–æ–≤, –∑–∞—Ç–µ–º –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–º —Å–ª—É—á–∞—è–º.',
            practice: '–ü–æ–¥–≥–æ—Ç–æ–≤–∏–ª –¥–ª—è –≤–∞—Å 5 –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞–Ω–∏–π –ø–æ —Å–ª–∞–±—ã–º —Ç–µ–º–∞–º. –ù–∞—á–Ω–∏—Ç–µ —Å –ø—Ä–æ—Å—Ç—ã—Ö —Å–ª—É—á–∞–µ–≤ –∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–º.',
            motivation: '–ü–æ–º–Ω–∏—Ç–µ: –∫–∞–∂–¥—ã–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –ø—Ä–∏–±–ª–∏–∂–∞–µ—Ç –≤–∞—Å –∫ —Ü–µ–ª–∏! –í—ã —É–∂–µ –ø—Ä–æ—à–ª–∏ 60% –ø—É—Ç–∏. –°–¥–µ–ª–∞–π—Ç–µ –ø–µ—Ä–µ—Ä—ã–≤, –∫–æ–≥–¥–∞ —É—Å—Ç–∞–Ω–µ—Ç–µ, –∏ –ø—Ä–∞–∑–¥–Ω—É–π—Ç–µ –º–∞–ª–µ–Ω—å–∫–∏–µ –ø–æ–±–µ–¥—ã! üéâ'
        };
        
        addAIMessage(trainingResults[trainingType] || '–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –≥–æ—Ç–æ–≤–∞!');
    }
    
    // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–ª—è —É—á–µ—Ç–∞ —Ä–µ–∂–∏–º–∞
    const originalSendToAI = sendToAI;
    sendToAI = function(message) {
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–∂–∏–º–µ –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
        const enhancedMessage = {
            message: message,
            mode: currentChatMode,
            use_rag: true
        };
        
        fetch(`/{{ lang }}/ai-assistant/chat`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify(enhancedMessage)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                addAIMessage(`–û—à–∏–±–∫–∞: ${data.error}`);
            } else {
                addAIMessage(data.response, data.sources);
                
                // –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–∂–∏–º –∞–Ω–∞–ª–∏–∑–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å–∞–π—Ç—ã
                if (currentChatMode === 'analysis' && data.insights) {
                    showInsightsPanel();
                    displayInsights(data.insights);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addAIMessage('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ AI');
        })
        .finally(() => {
            removeTypingIndicator();
        });
    };
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∂–∏–º—ã —á–∞—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    initializeChatModes();
});
</script>
{% endblock %} 