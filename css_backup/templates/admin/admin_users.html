{% extends "base.html" %}

{# --- Только текст для тега <title> --- #}
{% block title %}
    {% if lang == 'ru' %}Админ: Управление пользователями{% else %}Admin: Manage Users{% endif %}
{% endblock %}


{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">
        {% if lang == 'ru' %}Админ: Управление пользователями{% else %}Admin: Manage Users{% endif %}
    </h1>

    {# --- Отображение Flash-сообщений ОДИН РАЗ --- #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          {# Используем стандартные классы alert Bootstrap #}
          <div class="alert alert-{{ category if category in ['success', 'danger', 'warning', 'info'] else 'secondary' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    {# --- Таблица или список пользователей --- #}
    <div class="list-group">
        {% for user in users %}
        <div class="list-group-item list-group-item-action flex-column align-items-start mb-3 shadow-sm">
            {# Форма для РЕДАКТИРОВАНИЯ пользователя #}
            <form method="post" action="{{ url_for('admin_bp.users', lang=lang) }}" class="user-edit-form">
                <input type="hidden" name="user_id" value="{{ user.id }}">
                {# Добавляем action=save для ясности #}
                <input type="hidden" name="action" value="save">

                <div class="d-flex w-100 justify-content-between mb-2">
                    <h5 class="mb-1">ID: {{ user.id }} - {{ user.name }}</h5>
                    {# Форма для УДАЛЕНИЯ пользователя (отдельная!) #}
                    <form method="post" action="{{ url_for('admin_bp.delete_user', lang=lang, user_id=user.id) }}" style="display: inline;" onsubmit="return confirm('{% if lang == 'ru' %}Вы уверены, что хотите удалить пользователя {{ user.name }}?{% else %}Are you sure you want to delete user {{ user.name }}?{% endif %}');">
                      <button type="submit" class="btn btn-danger btn-sm">
                          <i class="bi bi-trash"></i> {% if lang == 'ru' %}Удалить{% else %}Delete{% endif %}
                      </button>
                    </form>
                </div>

                {# Используем Bootstrap grid для полей формы #}
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="name_{{ user.id }}" class="form-label">{% if lang == 'ru' %}Имя{% else %}Name{% endif %}:</label>
                        <input type="text" id="name_{{ user.id }}" name="name" value="{{ user.name }}" class="form-control">
                    </div>
                    <div class="col-md-6">
                        <label for="email_{{ user.id }}" class="form-label">Email:</label>
                        <input type="email" id="email_{{ user.id }}" name="email" value="{{ user.email }}" class="form-control">
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-auto">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="has_subscription" id="sub_{{ user.id }}" {% if user.has_subscription %}checked{% endif %}>
                            <label class="form-check-label" for="sub_{{ user.id }}">
                                {% if lang == 'ru' %}Подписка{% else %}Has Subscription{% endif %}
                            </label>
                        </div>
                    </div>
                     {# !!! ДОБАВЛЕНО ПОЛЕ "Is Admin" !!! #}
                    <div class="col-auto">
                         <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_admin" id="admin_{{ user.id }}" {% if user.role == 'admin' %}checked{% endif %}>
                            <label class="form-check-label" for="admin_{{ user.id }}">
                                {% if lang == 'ru' %}Администратор{% else %}Is Admin{% endif %}
                            </label>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-sm">
                    <i class="bi bi-save"></i> {% if lang == 'ru' %}Сохранить{% else %}Save Changes{% endif %}
                </button>

            </form> {# Конец формы редактирования #}
        </div> {# Конец list-group-item #}
        {% else %}
            <p>{% if lang == 'ru' %}Пользователи не найдены.{% else %}No users found.{% endif %}</p>
        {% endfor %}
    </div> {# Конец list-group #}

</div> {# Конец container #}
{% endblock %}