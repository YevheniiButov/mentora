{% extends "base.html" %}

{% block title %}
    {% if lang == 'ru' %}Результаты теста{% else %}Test Results{% endif %} - {{ test.title }}
{% endblock %}

{% block styles %}
<style>
    .results-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 0 20px;
    }
    
    .result-card {
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .score-circle {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 0 auto 2rem;
        border: 10px solid;
    }
    
    .score-circle.good {
        border-color: #28a745;
        color: #28a745;
    }
    
    .score-circle.average {
        border-color: #ffc107;
        color: #ffc107;
    }
    
    .score-circle.poor {
        border-color: #dc3545;
        color: #dc3545;
    }
    
    .score-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
    }
    
    .score-label {
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    
    .score-details {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 2rem;
    }
    
    .detail-item {
        text-align: center;
    }
    
    .detail-value {
        font-size: 1.5rem;
        font-weight: 600;
    }
    
    .detail-label {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .answers-summary {
        margin-top: 2rem;
    }
    
    .actions {
        margin-top: 2rem;
        display: flex;
        justify-content: center;
        gap: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="results-container py-5">
    <!-- Хлебные крошки для навигации -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main_bp.home', lang=lang) }}">{% if lang == 'ru' %}Главная{% else %}Home{% endif %}</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('learning_map_bp.learning_map', lang=lang) }}">{% if lang == 'ru' %}Карта обучения{% else %}Learning Map{% endif %}</a></li>
            <li class="breadcrumb-item active" aria-current="page">
                {% if lang == 'ru' %}Результаты теста{% else %}Test Results{% endif %}
            </li>
        </ol>
    </nav>

    <div class="result-card">
        <h1 class="h3 text-center mb-4">{{ test.title }}</h1>
        
        <!-- Процент выполнения в круге -->
        {% set score_class = 'good' if percentage >= 80 else ('average' if percentage >= 60 else 'poor') %}
        <div class="score-circle {{ score_class }}">
            <div class="score-value">{{ percentage }}%</div>
            <div class="score-label">{% if lang == 'ru' %}Результат{% else %}Score{% endif %}</div>
        </div>
        
        <!-- Детали результата -->
        <div class="score-details">
            <div class="detail-item">
                <div class="detail-value">{{ correct_answers }}</div>
                <div class="detail-label">{% if lang == 'ru' %}Правильных ответов{% else %}Correct answers{% endif %}</div>
            </div>
            <div class="detail-item">
                <div class="detail-value">{{ answered_questions }}</div>
                <div class="detail-label">{% if lang == 'ru' %}Всего вопросов{% else %}Total answered{% endif %}</div>
            </div>
            <div class="detail-item">
                <div class="detail-value">{{ total_questions }}</div>
                <div class="detail-label">{% if lang == 'ru' %}Вопросов в тесте{% else %}Test questions{% endif %}</div>
            </div>
        </div>
        
        <!-- Сообщение о результате -->
        <div class="text-center mb-4">
            {% if percentage >= 80 %}
                <h4 class="text-success">
                    <i class="bi bi-emoji-smile"></i> 
                    {% if lang == 'ru' %}Отличный результат!{% else %}Great job!{% endif %}
                </h4>
                <p>{% if lang == 'ru' %}
                    Вы успешно прошли тест и продемонстрировали отличное понимание материала.
                   {% else %}
                    You have successfully passed the test and demonstrated excellent understanding of the material.
                   {% endif %}
                </p>
            {% elif percentage >= 60 %}
                <h4 class="text-warning">
                    <i class="bi bi-emoji-neutral"></i> 
                    {% if lang == 'ru' %}Хороший результат{% else %}Good effort{% endif %}
                </h4>
                <p>{% if lang == 'ru' %}
                    Вы справились с тестом, но есть возможности для улучшения знаний.
                   {% else %}
                    You've passed the test, but there's room for improvement.
                   {% endif %}
                </p>
            {% else %}
                <h4 class="text-danger">
                    <i class="bi bi-emoji-frown"></i> 
                    {% if lang == 'ru' %}Нужно еще поработать{% else %}Needs improvement{% endif %}
                </h4>
                <p>{% if lang == 'ru' %}
                    Рекомендуем повторно изучить материал и попробовать тест еще раз.
                   {% else %}
                    We recommend reviewing the material and trying the test again.
                   {% endif %}
                </p>
            {% endif %}
        </div>
        
        <!-- Действия -->
        <div class="actions">
            {% if test.module_id %}
                <a href="{{ url_for('lesson_bp.lesson_view', lang=lang, module_id=test.module_id, lesson_index=0) }}" class="btn btn-primary">
                    <i class="bi bi-journal-text me-1"></i> 
                    {% if lang == 'ru' %}Вернуться к модулю{% else %}Return to module{% endif %}
                </a>
            {% endif %}
            
            <a href="{{ url_for('learning_map_bp.learning_map', lang=lang) }}" class="btn btn-outline-primary">
                <i class="bi bi-map me-1"></i>
                {% if lang == 'ru' %}Карта обучения{% else %}Learning map{% endif %}
            </a>
            
            {% if not percentage >= 80 %}
            <a href="{{ url_for('tests_bp.start_final_test', lang=lang, subject_id=test.subject_id) }}" class="btn btn-outline-secondary">                    <i class="bi bi-arrow-repeat me-1"></i>
                    {% if lang == 'ru' %}Пройти тест снова{% else %}Retry test{% endif %}
                </a>
            {% endif %}
        </div>
    </div>
    
    {% if attempts and percentage < 100 %}
    <!-- Подробный обзор ответов (необязательно) -->
    <div class="answers-summary">
        <h4 class="mb-3">{% if lang == 'ru' %}Обзор ответов{% else %}Answer review{% endif %}</h4>
        <div class="list-group">
            {% for attempt in attempts %}
                <div class="list-group-item list-group-item-action flex-column align-items-start {% if attempt.is_correct %}list-group-item-success{% else %}list-group-item-danger{% endif %}">
                    <div class="d-flex w-100 justify-content-between mb-2">
                        <h5 class="mb-1">{{ attempt.question.text }}</h5>
                        <small>
                            {% if attempt.is_correct %}
                                <span class="badge bg-success">{% if lang == 'ru' %}Верно{% else %}Correct{% endif %}</span>
                            {% else %}
                                <span class="badge bg-danger">{% if lang == 'ru' %}Неверно{% else %}Incorrect{% endif %}</span>
                            {% endif %}
                        </small>
                    </div>
                    <p class="mb-1">
                        {% if lang == 'ru' %}Ваш ответ:{% else %}Your answer:{% endif %} 
                        <strong>{{ attempt.selected_option }}</strong>
                    </p>
                    {% if not attempt.is_correct %}
                        <p class="mb-1">
                            {% if lang == 'ru' %}Правильный ответ:{% else %}Correct answer:{% endif %} 
                            <strong>{{ attempt.question.correct_answer }}</strong>
                        </p>
                    {% endif %}
                    {% if attempt.question.explanation %}
                        <small class="text-muted">
                            {{ attempt.question.explanation }}
                        </small>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}