{# templates/register.html #}
{% extends "base.html" %}

{# --- SEO --- #}
{% block title %}
    {% if lang == 'ru' %}Регистрация - Become a Tandarts{% elif lang == 'uk' %}Реєстрація - Become a Tandarts{% elif lang == 'nl' %}Registratie - Become a Tandarts{% elif lang == 'es' %}Registro - Become a Tandarts{% elif lang == 'tr' %}Kayıt - Become a Tandarts{% elif lang == 'fa' %}ثبت نام - Become a Tandarts{% else %}Register - Become a Tandarts{% endif %}
{% endblock %}
{% block meta_description %}
    {% if lang == 'ru' %}Создайте аккаунт на платформе Become a Tandarts для доступа к учебным материалам.{% elif lang == 'uk' %}Створіть обліковий запис на платформі Become a Tandarts для доступу до навчальних матеріалів.{% elif lang == 'nl' %}Maak een account aan op het Become a Tandarts platform om toegang te krijgen tot leermateriaal.{% elif lang == 'es' %}Crea una cuenta en la plataforma Become a Tandarts para acceder a los materiales de aprendizaje.{% elif lang == 'tr' %}Öğrenim materyallerine erişmek için Become a Tandarts platformunda bir hesap oluşturun.{% elif lang == 'fa' %}برای دسترسی به مطالب آموزشی، یک حساب کاربری در پلتفرم Become a Tandarts ایجاد کنید.{% else %}Create an account on the Become a Tandarts platform to access learning materials.{% endif %}
{% endblock %}
{# --- End SEO --- #}

{% block styles %}
{{ super() }}
<style>
  /* Стили для современной страницы регистрации с эффектами glassmorphism */
  .register-container {
    position: relative;
    padding: 3rem 0;
    min-height: calc(100vh - 70px);
    display: flex;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    overflow: hidden;
  }
  
  /* Анимированные плавающие фигуры на фоне - как на главной странице */
  .register-container::before {
    content: '';
    position: absolute;
    inset: 0;
    background: 
      radial-gradient(circle at 20% 20%, rgba(62, 205, 193, 0.15) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(108, 92, 231, 0.15) 0%, transparent 50%);
    z-index: 0;
  }
  
  .register-container::after {
    content: '';
    position: absolute;
    width: 350px;
    height: 350px;
    background: linear-gradient(90deg, rgba(108, 92, 231, 0.3), rgba(108, 92, 231, 0.1));
    border-radius: 50%;
    filter: blur(90px);
    bottom: -150px;
    right: -150px;
    animation: float-2 18s infinite alternate ease-in-out;
    z-index: 0;
  }
  
  /* Дополнительные плавающие элементы на фоне */
  .bg-floating-shape {
    position: absolute;
    border-radius: 50%;
    filter: blur(50px);
    z-index: 0;
    opacity: 0.5;
    pointer-events: none;
  }
  
  .shape-1 {
    width: 200px;
    height: 200px;
    background: linear-gradient(45deg, rgba(62, 205, 193, 0.3), rgba(62, 205, 193, 0.1));
    top: 15%;
    right: 10%;
    animation: float-shape-1 20s infinite alternate ease-in-out;
  }
  
  .shape-2 {
    width: 150px;
    height: 150px;
    background: linear-gradient(45deg, rgba(108, 92, 231, 0.2), rgba(108, 92, 231, 0.05));
    bottom: 20%;
    left: 10%;
    animation: float-shape-2 17s infinite alternate ease-in-out;
  }
  
  .shape-3 {
    width: 100px;
    height: 100px;
    background: linear-gradient(45deg, rgba(255, 209, 102, 0.2), rgba(255, 209, 102, 0.05));
    top: 30%;
    left: 20%;
    animation: float-shape-3 15s infinite alternate ease-in-out;
  }
  
  .shape-4 {
    width: 120px;
    height: 120px;
    background: linear-gradient(45deg, rgba(113, 128, 245, 0.2), rgba(113, 128, 245, 0.05));
    bottom: 30%;
    right: 20%;
    animation: float-shape-4 19s infinite alternate ease-in-out;
  }
  
  @keyframes float-shape-1 {
    0% { transform: translate(0, 0) rotate(0deg) scale(1); }
    100% { transform: translate(40px, -30px) rotate(10deg) scale(1.1); }
  }
  
  @keyframes float-shape-2 {
    0% { transform: translate(0, 0) rotate(0deg) scale(1); }
    100% { transform: translate(-30px, 40px) rotate(-15deg) scale(1.2); }
  }
  
  @keyframes float-shape-3 {
    0% { transform: translate(0, 0) rotate(0deg) scale(1); }
    100% { transform: translate(20px, 20px) rotate(5deg) scale(0.9); }
  }
  
  @keyframes float-shape-4 {
    0% { transform: translate(0, 0) rotate(0deg) scale(1); }
    100% { transform: translate(-20px, -10px) rotate(-5deg) scale(1.1); }
  }
  
  @keyframes float-1 {
    0% { transform: translate(0, 0) rotate(0deg); }
    100% { transform: translate(80px, 80px) rotate(10deg); }
  }
  
  @keyframes float-2 {
    0% { transform: translate(0, 0) rotate(0deg); }
    100% { transform: translate(-100px, -50px) rotate(-15deg); }
  }
  
  .register-card {
    border: none;
    border-radius: 24px;
    overflow: hidden;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
    background: rgba(255, 255, 255, 0.7);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.3);
  }
  
  .register-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
  }
  
  .register-steps {
    display: flex;
    justify-content: center;
    margin-bottom: 2rem;
  }
  
  .register-step {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background: rgba(241, 241, 241, 0.6);
    margin: 0 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #aaa;
    position: relative;
    transition: all 0.3s ease;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    opacity: 0.7;
  }
  
  .register-step::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 2px;
    background: rgba(224, 224, 224, 0.6);
    right: -20px;
    top: 50%;
    transform: translateY(-50%);
  }
  
  .register-step:last-child::after {
    display: none;
  }
  
  .register-step.active {
    background: linear-gradient(135deg, rgba(62, 205, 193, 0.9) 0%, rgba(43, 182, 172, 0.9) 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(62, 205, 193, 0.3);
    border: 1px solid rgba(62, 205, 193, 0.5);
  }
  
  .register-step.completed {
    background: rgba(43, 182, 172, 0.8);
    color: white;
    border: 1px solid rgba(43, 182, 172, 0.5);
  }
  
  .register-step.completed i {
    font-size: 14px;
  }
  
  .form-section {
    transition: all 0.5s ease;
    opacity: 1;
    transform: translateX(0);
  }
  
  .form-group {
    position: relative;
    margin-bottom: 1.5rem;
  }
  
  .form-control {
    border-radius: 12px;
    padding: 12px 15px;
    border: 1px solid rgba(224, 224, 224, 0.8);
    background: rgba(255, 255, 255, 0.7);
    transition: all 0.3s;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
    opacity: 1;
  }
  
  .form-control:focus {
    border-color: rgba(62, 205, 193, 0.6);
    box-shadow: 0 0 0 3px rgba(62, 205, 193, 0.2);
    background: rgba(255, 255, 255, 0.9);
  }
  
  .form-label {
    font-weight: 500;
    margin-bottom: 8px;
    background: linear-gradient(90deg, #3ecdc1, #2bb6ac);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    display: inline-block;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, #3ecdc1 0%, #2bb6ac 100%);
    border: none;
    border-radius: 12px;
    padding: 12px 18px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(62, 205, 193, 0.15);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    position: relative;
    overflow: hidden;
    z-index: 1;
  }
  
  .btn-primary::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0));
    transform: skewX(-25deg);
    transition: all 0.75s;
    z-index: -1;
  }
  
  .btn-primary:hover {
    transform: translateY(-3px);
    box-shadow: 0 7px 14px rgba(62, 205, 193, 0.3);
    background: linear-gradient(135deg, #3ecdc1 0%, #2bb6ac 70%);
  }
  
  .btn-primary:hover::before {
    left: 100%;
  }
  
  .btn-secondary {
    background: rgba(108, 92, 231, 0.1);
    color: #6c5ce7;
    border: 1px solid rgba(108, 92, 231, 0.3);
    border-radius: 12px;
    padding: 12px 18px;
    font-weight: 500;
    transition: all 0.3s;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
  }
  
  .btn-secondary:hover {
    background: rgba(108, 92, 231, 0.2);
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(108, 92, 231, 0.15);
  }
  
  /* Улучшенная анимация загрузки */
  .register-loader {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.98);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.5s ease;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    overflow: hidden;
  }
  
  .register-loader.active {
    opacity: 1;
    visibility: visible;
  }
  
  /* Добавление плавающих элементов на экране загрузки */
  .floating-shape {
    position: absolute;
    border-radius: 50%;
    filter: blur(40px);
    opacity: 0.6;
    z-index: -1;
  }
  
  .shape-1 {
    width: 150px;
    height: 150px;
    background: linear-gradient(90deg, #3ecdc1, #2bb6ac);
    top: 20%;
    left: 20%;
    animation: float-loader-1 15s infinite alternate ease-in-out;
  }
  
  .shape-2 {
    width: 180px;
    height: 180px;
    background: linear-gradient(90deg, #6c5ce7, #a29bfe);
    bottom: 20%;
    right: 20%;
    animation: float-loader-2 18s infinite alternate ease-in-out;
  }
  
  .shape-3 {
    width: 120px;
    height: 120px;
    background: linear-gradient(90deg, #0984e3, #74b9ff);
    bottom: 30%;
    left: 30%;
    animation: float-loader-3 20s infinite alternate ease-in-out;
  }
  
  @keyframes float-loader-1 {
    0% { transform: translate(0, 0) rotate(0deg); }
    100% { transform: translate(40px, 40px) rotate(15deg); }
  }
  
  @keyframes float-loader-2 {
    0% { transform: translate(0, 0) rotate(0deg); }
    100% { transform: translate(-50px, -30px) rotate(-10deg); }
  }
  
  @keyframes float-loader-3 {
    0% { transform: translate(0, 0) rotate(0deg); }
    100% { transform: translate(30px, -40px) rotate(20deg); }
  }
  
  .loader-logo {
    width: 120px;
    height: 120px;
    margin-bottom: 1.5rem;
    animation: pulse 2s infinite ease-in-out;
    position: relative;
    z-index: 1;
  }
  
  .loader-logo::after {
    content: '';
    position: absolute;
    width: 140px;
    height: 140px;
    background: radial-gradient(circle, rgba(62, 205, 193, 0.3) 0%, rgba(255, 255, 255, 0) 70%);
    border-radius: 50%;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    z-index: -1;
    animation: pulse-glow 2s infinite ease-in-out;
  }
  
  .loader-logo img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  
  .loader-slogan {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 2rem;
    background: linear-gradient(90deg, #3ecdc1, #6c5ce7);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    opacity: 0;
    transform: translateY(20px);
    animation: fadeInUp 1s forwards 0.5s;
  }
  
  .loader-progress {
    width: 250px;
    height: 6px;
    background: rgba(241, 241, 241, 0.8);
    border-radius: 3px;
    overflow: hidden;
    position: relative;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
  }
  
  .loader-progress-bar {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 0;
    background: linear-gradient(90deg, #3ecdc1 0%, #6c5ce7 100%);
    animation: progressBar 3s ease-out forwards;
    border-radius: 3px;
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  
  @keyframes pulse-glow {
    0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
    50% { opacity: 0.6; transform: translate(-50%, -50%) scale(1.2); }
  }
  
  @keyframes fadeInUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes progressBar {
    0% { width: 0; }
    30% { width: 50%; }
    60% { width: 80%; }
    100% { width: 100%; }
  }
  
  /* Эффект "плавающей" метки */
  .focused .form-label {
    transform: translateY(-25px) scale(0.85);
    opacity: 1;
  }
  
  /* Адаптивность */
  @media (max-width: 768px) {
    .register-container {
      padding: 2rem 0;
    }
    
    .loader-slogan {
      font-size: 1.5rem;
    }
  }
</style>
{% endblock %}

{% block content %}
  {# Новый контейнер с современным дизайном #}
  <div class="register-container main-content-padding">
    {# Добавляем плавающие элементы для фона #}
    <div class="bg-floating-shape shape-1"></div>
    <div class="bg-floating-shape shape-2"></div>
    <div class="bg-floating-shape shape-3"></div>
    <div class="bg-floating-shape shape-4"></div>
    
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-7">
          <div class="register-card card shadow">
            <div class="card-body p-4 p-md-5">
              
              <h2 class="card-title text-center mb-4">
                {% if lang == 'ru' %}Создание аккаунта
                {% elif lang == 'uk' %}Створення акаунта
                {% elif lang == 'nl' %}Account aanmaken
                {% elif lang == 'es' %}Crear cuenta
                {% elif lang == 'tr' %}Hesap Oluştur
                {% elif lang == 'fa' %}ایجاد حساب کاربری
                {% else %}Create Account
                {% endif %}
              </h2>
              
              {# Индикатор шагов #}
              <div class="register-steps">
                <div class="register-step active">1</div>
                <div class="register-step">2</div>
                <div class="register-step">
                  <i class="bi bi-check"></i>
                </div>
              </div>

              {# Отображение flash-сообщений (ошибки, успех) #}
              {% include '_flash_messages.html' ignore missing %}

              {# Форма регистрации, использующая Flask-WTF #}
              <form id="registerForm" method="POST" action="{{ url_for('auth_bp.register', lang=lang) }}" novalidate>
                {{ form.hidden_tag() }} {# CSRF токен - ОБЯЗАТЕЛЬНО! #}
                <input type="hidden" name="animation_completed" id="animationCompletedField" value="0">

                {# Секция 1: Персональные данные #}
                <div class="form-section" id="section1">
                  <div class="text-center mb-4">
                    <h5>
                      {% if lang == 'ru' %}Персональная информация
                      {% elif lang == 'uk' %}Персональна інформація
                      {% elif lang == 'nl' %}Persoonlijke informatie
                      {% elif lang == 'es' %}Información personal
                      {% elif lang == 'tr' %}Kişisel Bilgiler
                      {% elif lang == 'fa' %}اطلاعات شخصی
                      {% else %}Personal Information
                      {% endif %}
                    </h5>
                  </div>
                
                  {# --- Поле Имя (Name) --- #}
                  <div class="form-group mb-3">
                    {{ form.name.label(class="form-label") }}
                    {% set name_placeholder %}
                        {%- if lang == 'ru' %}Ваше полное имя{% elif lang == 'uk' %}Ваше повне ім'я{% elif lang == 'nl' %}Uw volledige naam{% elif lang == 'es' %}Tu nombre completo{% elif lang == 'tr' %}Tam adınız{% elif lang == 'fa' %}نام کامل شما{% else %}Your Full Name{% endif -%}
                    {% endset %}
                    {% if form.name.errors %}
                      {{ form.name(class="form-control is-invalid", placeholder=name_placeholder) }}
                      <div class="invalid-feedback">
                        {% for error in form.name.errors %}<span>{{ error }}</span>{% endfor %}
                      </div>
                    {% else %}
                      {{ form.name(class="form-control", placeholder=name_placeholder) }}
                    {% endif %}
                  </div>

                  {# --- Поле Email --- #}
                  <div class="form-group mb-3">
                    {{ form.email.label(class="form-label") }}
                     {% set email_placeholder %}
                        {%- if lang == 'ru' %}Ваш email{% elif lang == 'uk' %}Ваш email{% elif lang == 'nl' %}Uw e-mailadres{% elif lang == 'es' %}Tu correo electrónico{% elif lang == 'tr' %}E-posta adresiniz{% elif lang == 'fa' %}ایمیل شما{% else %}Your Email{% endif -%}
                    {% endset %}
                    {% if form.email.errors %}
                      {{ form.email(class="form-control is-invalid", placeholder=email_placeholder) }}
                      <div class="invalid-feedback">
                        {% for error in form.email.errors %}<span>{{ error }}</span>{% endfor %}
                      </div>
                    {% else %}
                      {{ form.email(class="form-control", placeholder=email_placeholder) }}
                    {% endif %}
                  </div>

                  <div class="d-flex justify-content-center mt-4 mb-2">
                    <button type="button" class="btn btn-primary px-4 next-btn">
                      {% if lang == 'ru' %}Продолжить
                      {% elif lang == 'uk' %}Продовжити
                      {% elif lang == 'nl' %}Doorgaan
                      {% elif lang == 'es' %}Continuar
                      {% elif lang == 'tr' %}Devam et
                      {% elif lang == 'fa' %}ادامه
                      {% else %}Continue
                      {% endif %}
                    </button>
                  </div>
                </div>

                {# Секция 2: Пароли #}
                <div class="form-section d-none" id="section2">
                  <div class="text-center mb-4">
                    <h5>
                      {% if lang == 'ru' %}Создание пароля
                      {% elif lang == 'uk' %}Створення пароля
                      {% elif lang == 'nl' %}Wachtwoord aanmaken
                      {% elif lang == 'es' %}Creación de contraseña
                      {% elif lang == 'tr' %}Şifre oluştur
                      {% elif lang == 'fa' %}ایجاد رمز عبور
                      {% else %}Create Password
                      {% endif %}
                    </h5>
                  </div>
                
                  {# --- Поле Пароль (Password) --- #}
                  <div class="form-group mb-3">
                    {{ form.password.label(class="form-label") }}
                     {% set password_placeholder %}
                        {%- if lang == 'ru' %}Минимум 6 символов{% elif lang == 'uk' %}Мінімум 6 символів{% elif lang == 'nl' %}Minstens 6 tekens{% elif lang == 'es' %}Mínimo 6 caracteres{% elif lang == 'tr' %}En az 6 karakter{% elif lang == 'fa' %}حداقل ۶ کاراکتر{% else %}Minimum 6 characters{% endif -%}
                    {% endset %}
                    {% if form.password.errors %}
                        {{ form.password(class="form-control is-invalid", placeholder=password_placeholder) }}
                        <div class="invalid-feedback">
                            {% for error in form.password.errors %}<span>{{ error }}</span>{% endfor %}
                        </div>
                    {% else %}
                        {{ form.password(class="form-control", placeholder=password_placeholder) }}
                    {% endif %}
                  </div>

                  {# --- Поле Подтверждение Пароля (Confirm Password) --- #}
                  <div class="form-group mb-3">
                    {{ form.confirm_password.label(class="form-label") }}
                     {% set confirm_placeholder %}
                        {%- if lang == 'ru' %}Повторите пароль{% elif lang == 'uk' %}Повторіть пароль{% elif lang == 'nl' %}Herhaal wachtwoord{% elif lang == 'es' %}Repite la contraseña{% elif lang == 'tr' %}Şifreyi tekrar girin{% elif lang == 'fa' %}تکرار رمز عبور{% else %}Repeat Password{% endif -%}
                    {% endset %}
                    {% if form.confirm_password.errors %}
                        {{ form.confirm_password(class="form-control is-invalid", placeholder=confirm_placeholder) }}
                        <div class="invalid-feedback">
                            {% for error in form.confirm_password.errors %}<span>{{ error }}</span>{% endfor %}
                        </div>
                    {% else %}
                        {{ form.confirm_password(class="form-control", placeholder=confirm_placeholder) }}
                    {% endif %}
                  </div>

                  <div class="d-flex justify-content-between mt-4 mb-2">
                    <button type="button" class="btn btn-secondary px-3 prev-btn">
                      {% if lang == 'ru' %}Назад
                      {% elif lang == 'uk' %}Назад
                      {% elif lang == 'nl' %}Terug
                      {% elif lang == 'es' %}Atrás
                      {% elif lang == 'tr' %}Geri
                      {% elif lang == 'fa' %}بازگشت
                      {% else %}Back
                      {% endif %}
                    </button>
                    {{ form.submit(class="btn btn-primary px-4", id="submitBtn") }}
                  </div>
                </div>

              </form> {# Конец формы #}

              {# --- Ссылка на вход --- #}
              <div class="text-center mt-4">
                {% if lang == 'ru' %}Уже есть аккаунт?{% elif lang == 'uk' %}Вже є акаунт?{% elif lang == 'nl' %}Heeft u al een account?{% elif lang == 'es' %}¿Ya tienes una cuenta?{% elif lang == 'tr' %}Zaten bir hesabınız var mı?{% elif lang == 'fa' %}حساب کاربری دارید؟{% else %}Already have an account?{% endif %}
                <a href="{{ url_for('auth_bp.login', lang=lang) }}" class="text-decoration-none">
                    {% if lang == 'ru' %}Войти{% elif lang == 'uk' %}Увійти{% elif lang == 'nl' %}Inloggen{% elif lang == 'es' %}Iniciar sesión{% elif lang == 'tr' %}Giriş yap{% elif lang == 'fa' %}ورود{% else %}Log In{% endif %}
                </a>
              </div>
              
            </div> {# Конец card-body #}
          </div> {# Конец card #}
        </div> {# Конец col #}
      </div> {# Конец row #}
    </div> {# Конец container #}
  </div> {# Конец регистрации #}
  
  {# Анимация загрузки с логотипом и слоганом #}
  <div class="register-loader" id="registerLoader">
    <div class="floating-shape shape-1"></div>
    <div class="floating-shape shape-2"></div>
    <div class="floating-shape shape-3"></div>
    <div class="loader-logo">
      <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Become a Tandarts">
    </div>
    <div class="loader-slogan">
      {% if lang == 'ru' %}Начинаем ваше BIG путешествие...
      {% elif lang == 'uk' %}Розпочинаємо ваша BIG подорож...
      {% elif lang == 'nl' %}Je BIG reis begint...
      {% elif lang == 'es' %}Comenzando tu viaje BIG...
      {% elif lang == 'tr' %}BIG yolculuğunuz başlıyor...
      {% elif lang == 'fa' %}سفر BIG شما آغاز می شود...
      {% else %}Starting your BIG journey...
      {% endif %}
    </div>
    <div class="loader-progress">
      <div class="loader-progress-bar"></div>
    </div>
  </div>
{% endblock %}

{% block body_scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Элементы интерфейса
  const form = document.getElementById('registerForm');
  const section1 = document.getElementById('section1');
  const section2 = document.getElementById('section2');
  const step1 = document.querySelector('.register-step:nth-child(1)');
  const step2 = document.querySelector('.register-step:nth-child(2)');
  const step3 = document.querySelector('.register-step:nth-child(3)');
  const nextBtn = document.querySelector('.next-btn');
  const prevBtn = document.querySelector('.prev-btn');
  const submitBtn = document.getElementById('submitBtn');
  const loader = document.getElementById('registerLoader');
  const formInputs = document.querySelectorAll('.form-control');
  const animationField = document.getElementById('animationCompletedField');
  
  // Скрываем анимацию загрузки, если она не должна быть активна
  if (loader.classList.contains('active')) {
    // Если страница загружена и анимация активна, скрываем её
    setTimeout(() => {
      loader.classList.remove('active');
    }, 300);
  }
  
  // Анимация при загрузке страницы
  setTimeout(() => {
    document.querySelectorAll('.register-step').forEach(step => {
      step.style.opacity = 1;
    });
    
    formInputs.forEach((input, index) => {
      setTimeout(() => {
        input.style.opacity = 1;
        input.style.transform = 'translateY(0)';
        
        // Проверка заполненных полей при загрузке
        if (input.value.trim() !== '') {
          input.parentElement.classList.add('focused');
        }
      }, index * 100);
    });
  }, 200);
  
  // Эффект фокуса на полях формы
  formInputs.forEach(input => {
    // Установка начальных стилей для анимации
    input.style.opacity = 0;
    input.style.transform = 'translateY(10px)';
    
    // События фокуса и потери фокуса
    input.addEventListener('focus', function() {
      this.parentElement.classList.add('focused');
    });
    
    input.addEventListener('blur', function() {
      if (!this.value.trim()) {
        this.parentElement.classList.remove('focused');
      }
    });
    
    // Событие ввода для обновления состояния
    input.addEventListener('input', function() {
      if (this.value.trim()) {
        this.parentElement.classList.add('focused');
      } else {
        this.parentElement.classList.remove('focused');
      }
    });
  });
  
  // Управление шагами формы с анимацией
  if (nextBtn) {
    nextBtn.addEventListener('click', function() {
      // Валидация первого шага
      const nameInput = form.querySelector('[name="name"]');
      const emailInput = form.querySelector('[name="email"]');
      let isValid = true;
      
      if (!nameInput.value.trim()) {
        nameInput.classList.add('is-invalid');
        isValid = false;
      } else {
        nameInput.classList.remove('is-invalid');
      }
      
      if (!emailInput.value.trim() || !emailInput.value.includes('@')) {
        emailInput.classList.add('is-invalid');
        isValid = false;
      } else {
        emailInput.classList.remove('is-invalid');
      }
      
      if (isValid) {
        // Анимация перехода между шагами
        section1.style.opacity = 0;
        section1.style.transform = 'translateX(-20px)';
        
        setTimeout(() => {
          section1.classList.add('d-none');
          section2.classList.remove('d-none');
          section2.style.opacity = 0;
          section2.style.transform = 'translateX(20px)';
          
          setTimeout(() => {
            section2.style.opacity = 1;
            section2.style.transform = 'translateX(0)';
            
            step1.classList.remove('active');
            step1.classList.add('completed');
            step2.classList.add('active');
          }, 50);
        }, 300);
      }
    });
  }
  
  if (prevBtn) {
    prevBtn.addEventListener('click', function() {
      // Анимация перехода между шагами в обратном порядке
      section2.style.opacity = 0;
      section2.style.transform = 'translateX(20px)';
      
      setTimeout(() => {
        section2.classList.add('d-none');
        section1.classList.remove('d-none');
        section1.style.opacity = 0;
        section1.style.transform = 'translateX(-20px)';
        
        setTimeout(() => {
          section1.style.opacity = 1;
          section1.style.transform = 'translateX(0)';
          
          step2.classList.remove('active');
          step1.classList.remove('completed');
          step1.classList.add('active');
        }, 50);
      }, 300);
    });
  }
  
  // Показать анимацию загрузки при отправке формы с улучшенными эффектами
  if (form && submitBtn) {
    form.addEventListener('submit', function(e) {
      // Получаем все данные из формы
      const formData = new FormData(form);
      const passwordInput = form.querySelector('[name="password"]');
      const confirmInput = form.querySelector('[name="confirm_password"]');
      
      // Проверяем валидность формы перед отправкой
      let isValid = true;
      
      if (!passwordInput.value || passwordInput.value.length < 6) {
        passwordInput.classList.add('is-invalid');
        isValid = false;
      } else {
        passwordInput.classList.remove('is-invalid');
      }
      
      if (!confirmInput.value || confirmInput.value !== passwordInput.value) {
        confirmInput.classList.add('is-invalid');
        isValid = false;
      } else {
        confirmInput.classList.remove('is-invalid');
      }
      
      if (!isValid) {
        e.preventDefault();
        return false;
      }
      
      // Останавливаем стандартную отправку формы
      e.preventDefault();
      
      // Анимация заполнения шага 3
      setTimeout(() => {
        step2.classList.remove('active');
        step2.classList.add('completed');
        step3.classList.add('active');
        
        // Показываем анимацию загрузки с задержкой для эффекта завершения
        setTimeout(() => {
          loader.classList.add('active');
          
          // Установка таймера для защиты от зависания
          const safetyTimer = setTimeout(() => {
            loader.classList.remove('active');
          }, 10000);
          
          // Отправляем форму после анимации с помощью XMLHttpRequest
          setTimeout(() => {
            // Создаем и отправляем запрос
            const xhr = new XMLHttpRequest();
            xhr.open('POST', form.action, true);
            
            // Добавляем CSRF-токен и заголовки для правильной обработки формы
            xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            // Получаем CSRF-токен из формы
            const csrfToken = form.querySelector('input[name="csrf_token"]').value;
            
            // Обработка ответа
            xhr.onload = function() {
              if (xhr.status >= 200 && xhr.status < 400) {
                // В случае успешного ответа, перенаправляем пользователя
                window.location.href = '{{ url_for("auth_bp.login", lang=lang) }}';
              } else {
                // Если ошибка, просто перезагружаем страницу
                window.location.reload();
              }
              clearTimeout(safetyTimer);
            };
            
            // В случае ошибки связи
            xhr.onerror = function() {
              window.location.reload();
              clearTimeout(safetyTimer);
            };
            
            // Формируем данные с включенным CSRF-токеном
            const formData = new URLSearchParams(new FormData(form)).toString();
            
            // Отправляем данные
            xhr.send(formData);
          }, 2000);
        }, 500);
      }, 300);
    });
  }
});
</script>
{% endblock %}