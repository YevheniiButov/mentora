/**
 * Mobile Navigation System
 * –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –∏ –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é
 */
class MobileNavigation {
    constructor() {
        this.currentPage = window.location.pathname;
        this.isTransitioning = false;
        this.init();
    }
    
    init() {
        console.log('üöÄ Mobile Navigation - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
        
        // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        this.setupBottomNavigation();
        this.setupPageTransitions();
        this.setupBackButton();
        this.setupThemeToggle();
        this.setupProfileMenu();
        
        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
        this.preloadPages();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é
        this.updateActiveNavigation();
        
        console.log('‚úÖ Mobile Navigation - –≥–æ—Ç–æ–≤–æ!');
    }
    
    setupBottomNavigation() {
        const navItems = document.querySelectorAll('.nav-item');
        
        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                const targetUrl = item.getAttribute('href');
                const targetPage = item.getAttribute('data-page');
                
                // –ù–ï –±–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ö–æ–¥—ã –Ω–∞ –≤–Ω–µ—à–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (AI, –∏ —Ç.–¥.)
                if (targetUrl && (targetUrl.includes('/ai-assistant') || targetUrl.includes('/ai/') || 
                    targetUrl.includes('/virtual-patient') || targetUrl.includes('/admin'))) {
                    // –ü–æ–∑–≤–æ–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥
                    return;
                }
                
                // –ù–ï –±–ª–æ–∫–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é - —ç—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
                // e.preventDefault();
                
                if (this.isTransitioning) {
                    e.preventDefault();
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞ —Ç–æ–π –ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —É–∂–µ –Ω–∞—Ö–æ–¥–∏–º—Å—è
                if (targetUrl && this.isCurrentPage(targetUrl)) {
                    e.preventDefault();
                    return;
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å, –Ω–æ –ù–ï –±–ª–æ–∫–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ö–æ–¥
                this.addVisualFeedback(item);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞
                this.updateActiveNavigationFor(targetPage);
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–∫—Ç–∏–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
            this.addHapticFeedback(item);
        });
    }
    
    isCurrentPage(url) {
        const currentPath = window.location.pathname;
        return currentPath === url || currentPath.includes(url.split('/').pop());
    }
    
    navigateToPage(url, page) {
        console.log(`üì± –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞: ${url} (${page})`);
        
        this.isTransitioning = true;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é
        this.updateActiveNavigationFor(page);
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞
        this.animatePageTransition(() => {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            this.loadPage(url);
        });
    }
    
    updateActiveNavigation() {
        const currentPath = window.location.pathname;
        const navItems = document.querySelectorAll('.nav-item');
        
        navItems.forEach(item => {
            item.classList.remove('active');
            
            const itemHref = item.getAttribute('href');
            const itemPage = item.getAttribute('data-page');
            
            // –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            if (this.isActivePageFor(currentPath, itemPage, itemHref)) {
                item.classList.add('active');
            }
        });
    }
    
    isActivePageFor(currentPath, page, href) {
        // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        switch(page) {
            case 'home':
                return currentPath.includes('/mobile') && !currentPath.includes('/learning') 
                       && !currentPath.includes('/tests') && !currentPath.includes('/virtual-patient');
            case 'learning':
                return currentPath.includes('/learning') || currentPath.includes('/subject') 
                       || currentPath.includes('/lesson') || currentPath.includes('/module');
            case 'tests':
                return currentPath.includes('/tests') || currentPath.includes('/test');
            case 'patients':
                return currentPath.includes('/virtual-patient');
            case 'ai':
                return currentPath.includes('/ai');
            default:
                return currentPath === href;
        }
    }
    
    updateActiveNavigationFor(page) {
        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ —Ç–µ–∫—É—â–µ–π
        const activeItem = document.querySelector(`[data-page="${page}"]`);
        if (activeItem) {
            activeItem.classList.add('active');
        }
    }
    
    animatePageTransition(callback) {
        const content = document.getElementById('mainContent');
        
        if (!content) {
            callback();
            return;
        }
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
        content.style.transform = 'translateX(-100%)';
        content.style.opacity = '0';
        
        setTimeout(() => {
            callback();
        }, 300);
    }
    
    loadPage(url) {
        // –ü—Ä–æ—Å—Ç–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ AJAX –∑–∞–≥—Ä—É–∑–∫—É)
        window.location.href = url;
    }
    
    setupPageTransitions() {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ
        const content = document.getElementById('mainContent');
        if (content) {
            content.style.transform = 'translateX(0)';
            content.style.opacity = '1';
        }
    }
    
    setupBackButton() {
        const backBtn = document.querySelector('.back-btn');
        if (backBtn) {
            backBtn.addEventListener('click', (e) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É –∫–Ω–æ–ø–∫–∏ href
                const href = backBtn.getAttribute('href');
                if (href && href !== '#') {
                    // –ü–æ–∑–≤–æ–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø–æ href
                    return;
                }
                
                // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç href –∏–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π - –¥–µ–ª–∞–µ–º preventDefault
                e.preventDefault();
                this.goBack();
            });
            
            this.addHapticFeedback(backBtn);
        }
    }
    
    goBack() {
        console.log('‚¨ÖÔ∏è –í–æ–∑–≤—Ä–∞—Ç –Ω–∞–∑–∞–¥');
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫—É–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è
        const currentPath = window.location.pathname;
        
        if (currentPath.includes('/lesson/') || currentPath.includes('/module/')) {
            // –ò–∑ —É—Ä–æ–∫–∞/–º–æ–¥—É–ª—è - –≤ –∫–∞—Ä—Ç—É –æ–±—É—á–µ–Ω–∏—è
            const lang = this.extractLangFromPath(currentPath);
            window.location.href = `/${lang}/mobile/learning`;
        } else if (currentPath.includes('/subject/')) {
            // –ò–∑ –ø—Ä–µ–¥–º–µ—Ç–∞ - –≤ –∫–∞—Ä—Ç—É –æ–±—É—á–µ–Ω–∏—è
            const lang = this.extractLangFromPath(currentPath);
            window.location.href = `/${lang}/mobile/learning`;
        } else {
            // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é - –±—Ä–∞—É–∑–µ—Ä–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è
            window.history.back();
        }
    }
    
    extractLangFromPath(path) {
        const parts = path.split('/');
        return parts[1] || 'en';
    }
    
    setupThemeToggle() {
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                this.toggleTheme();
            });
            
            this.addHapticFeedback(themeToggle);
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É
        const savedTheme = localStorage.getItem('mobile_theme') || 'light';
        this.applyTheme(savedTheme);
    }
    
    toggleTheme() {
        const currentTheme = document.body.getAttribute('data-theme') || 'light';
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        
        this.applyTheme(newTheme);
        localStorage.setItem('mobile_theme', newTheme);
        
        console.log(`üé® –¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞: ${currentTheme} ‚Üí ${newTheme}`);
    }
    
    applyTheme(theme) {
        document.body.setAttribute('data-theme', theme);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∞-—Ç–µ–≥ —Ü–≤–µ—Ç–∞ –±—Ä–∞—É–∑–µ—Ä–∞
        const metaThemeColor = document.querySelector('meta[name="theme-color"]');
        if (metaThemeColor) {
            metaThemeColor.setAttribute('content', 
                theme === 'dark' ? '#0f172a' : '#1a1a2e'
            );
        }
    }
    
    setupProfileMenu() {
        const profileMenu = document.getElementById('profileMenu');
        if (profileMenu) {
            profileMenu.addEventListener('click', () => {
                this.showProfileMenu();
            });
            
            this.addHapticFeedback(profileMenu);
        }
    }
    
    showProfileMenu() {
        // –ü—Ä–æ—Å—Ç–æ–µ –º–µ–Ω—é (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
        const currentLang = this.extractLangFromPath(window.location.pathname);
        const isAuthenticated = document.querySelector('.nav-item') !== null; // –ü—Ä–∏–º–µ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        
        if (isAuthenticated) {
            window.location.href = `/${currentLang}/mobile/profile`;
        } else {
            window.location.href = `/${currentLang}/mobile/auth/login`;
        }
    }
    
    preloadPages() {
        const currentLang = this.extractLangFromPath(window.location.pathname);
        
        // –ö–ª—é—á–µ–≤—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏
        const keyPages = [
            `/${currentLang}/mobile/learning`,
            `/${currentLang}/mobile/tests`, 
            `/${currentLang}/virtual-patient`,
            `/${currentLang}/ai-assistant`
        ];
        
        keyPages.forEach(page => {
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = page;
            document.head.appendChild(link);
        });
        
        console.log('üîÑ –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü –∑–∞–ø—É—â–µ–Ω–∞');
    }
    
    addHapticFeedback(element) {
        element.addEventListener('touchstart', () => {
            // –¢–∞–∫—Ç–∏–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±—ã–ª–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
            if (navigator.vibrate && document.hasStoredUserActivation) {
                navigator.vibrate(50);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
            element.style.transform = 'scale(0.95)';
            
            setTimeout(() => {
                element.style.transform = '';
            }, 150);
        }, { passive: true });
    }
    
    addVisualFeedback(element) {
        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è
        element.style.transform = 'scale(0.95)';
        element.style.opacity = '0.8';
        
        setTimeout(() => {
            element.style.transform = '';
            element.style.opacity = '';
        }, 150);
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
function goBack() {
    if (window.mobileNav) {
        window.mobileNav.goBack();
    } else {
        window.history.back();
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', () => {
    window.mobileNav = new MobileNavigation();
});

// –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä
window.addEventListener('popstate', () => {
    if (window.mobileNav) {
        setTimeout(() => {
            window.mobileNav.updateActiveNavigation();
        }, 100);
    }
});

console.log('üì± Navigation.js –∑–∞–≥—Ä—É–∂–µ–Ω'); 