# Система уведомлений ИИ аналитики

## Обзор

Система уведомлений ИИ аналитики автоматически отслеживает критические метрики системы искусственного интеллекта и отправляет алерты администраторам при превышении пороговых значений.

## Компоненты системы

### 1. AINotificationManager (`utils/ai_notifications.py`)

Основной класс для управления уведомлениями:

- **Мониторинг метрик**: Отслеживает процент ошибок, удовлетворенность пользователей, время ответа ИИ
- **Пороговые значения**: Настраиваемые критические и предупредительные уровни
- **Email уведомления**: Автоматическая отправка HTML и текстовых уведомлений
- **Логирование**: Детальное логирование всех алертов

### 2. Административный интерфейс (`templates/admin/notification_settings.html`)

Веб-интерфейс для управления настройками:

- **Настройка порогов**: Интерактивное изменение пороговых значений
- **Статус системы**: Отображение состояния SMTP и получателей
- **История алертов**: Просмотр истории уведомлений
- **Тестирование**: Отправка тестовых уведомлений

### 3. API endpoints (`routes/admin_routes.py`)

REST API для управления системой:

- `GET /admin/api/notification-settings` - получение настроек
- `POST /admin/api/update-notification-settings` - обновление настроек
- `POST /admin/api/test-notification` - отправка тестового уведомления
- `POST /admin/api/run-alert-check` - ручная проверка алертов
- `GET /admin/api/alert-history` - получение истории алертов

## Отслеживаемые метрики

### Критические метрики

1. **Процент ошибок ИИ**
   - Критический: 15%
   - Предупреждение: 10%

2. **Удовлетворенность пользователей**
   - Критический: ниже 60%
   - Предупреждение: ниже 70%

3. **Время ответа ИИ**
   - Критический: больше 5 сек
   - Предупреждение: больше 3 сек

4. **Здоровье системы**
   - Критический: ниже 80%

### Трендовые метрики

1. **Падение активности пользователей**
   - Предупреждение: падение на 30% за день

2. **Снижение ИИ взаимодействий**
   - Предупреждение: падение на 40% за день

## Настройка

### 1. SMTP конфигурация

Добавьте в конфигурацию приложения:

```python
# config.py
SMTP_HOST = 'smtp.gmail.com'
SMTP_PORT = 587
SMTP_USERNAME = 'your-email@gmail.com'
SMTP_PASSWORD = 'your-app-password'
SMTP_USE_TLS = True
```

### 2. Администраторы

Убедитесь, что у пользователей с ролью 'admin' указаны email адреса:

```python
# В базе данных
user.role = 'admin'
user.email = 'admin@example.com'
```

## Использование

### Доступ к интерфейсу

1. Войдите как администратор
2. Перейдите по адресу: `/{lang}/admin/ai-notifications`
3. Настройте пороговые значения
4. Протестируйте отправку уведомлений

### Программное использование

```python
from utils.ai_notifications import AINotificationManager

# Создание менеджера
manager = AINotificationManager()

# Проверка алертов
alerts = manager.process_alerts(send_notifications=True)

# Получение настроек
settings = manager.get_notification_settings()

# Обновление порогов
new_thresholds = {
    'error_rate_critical': 0.20,
    'satisfaction_warning': 0.75
}
manager.update_thresholds(new_thresholds)
```

### Периодическая проверка

Для автоматической проверки алертов настройте cron задачу:

```bash
# Каждые 15 минут
*/15 * * * * cd /path/to/app && python -c "from utils.ai_notifications import run_periodic_check; run_periodic_check()"
```

## Типы уведомлений

### Критические алерты
- Отправляются немедленно
- Красный цвет в email
- Требуют немедленного внимания

### Предупреждения
- Группируются при множественных алертах
- Желтый цвет в email
- Требуют мониторинга

### Тестовые уведомления
- Синий цвет в email
- Для проверки работоспособности системы

## Структура email уведомлений

### HTML версия
- Цветовое кодирование по серьезности
- Детальная информация о метриках
- Рекомендуемые действия
- Ссылки на административную панель

### Текстовая версия
- Простой текстовый формат
- Вся необходимая информация
- Совместимость со всеми email клиентами

## Безопасность

- Доступ только для администраторов
- Проверка прав на всех endpoints
- Валидация входных данных
- Логирование всех действий

## Мониторинг

### Логи
Все события записываются в логи приложения:

```
2024-01-01 12:00:00 - ai_notifications - WARNING - ИИ Алерт [error_rate]: Процент ошибок составляет 12%
2024-01-01 12:00:01 - ai_notifications - INFO - Email уведомление отправлено: error_rate -> ['admin@example.com']
```

### Метрики системы
- Количество отправленных алертов
- Время последней проверки
- Статус SMTP соединения
- Количество активных администраторов

## Расширение системы

### Добавление новых метрик

1. Обновите `check_critical_metrics()` в `AINotificationManager`
2. Добавьте новые пороговые значения в `default_thresholds`
3. Обновите интерфейс настроек

### Интеграция с внешними системами

Система поддерживает расширение для интеграции с:
- Slack
- Telegram
- SMS сервисы
- Системы мониторинга (Prometheus, Grafana)

## Устранение неполадок

### Уведомления не отправляются
1. Проверьте SMTP настройки
2. Убедитесь, что у админов указаны email
3. Проверьте логи на ошибки

### Ложные срабатывания
1. Настройте пороговые значения
2. Проверьте качество данных аналитики
3. Добавьте фильтры для исключений

### Производительность
1. Оптимизируйте частоту проверок
2. Используйте кэширование для метрик
3. Настройте индексы в базе данных

## Версионность

- **v1.0**: Базовая система уведомлений
- **v1.1**: Веб-интерфейс управления
- **v1.2**: API endpoints и история алертов
- **v1.3**: Группировка уведомлений и улучшенная отчетность 