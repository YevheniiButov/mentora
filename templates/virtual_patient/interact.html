{% extends "base.html" %}

{% block title %}{{ scenario_model_obj.title }} - Virtual Patient{% endblock %}

{% block styles %}
{{ super() }}
<style>
    

    .virtual-patient-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    .patient-interface {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .conversation-area {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .patient-header {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .patient-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: 3px solid rgba(255,255,255,0.3);
        object-fit: cover;
    }

    .patient-info h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
    }

    .patient-details {
        font-size: 0.9rem;
        opacity: 0.9;
        margin: 0.25rem 0 0;
    }

    .conversation-content {
        padding: 2rem;
    }

    .patient-statement {
        background: var(--background-light);
        border-left: 4px solid var(--primary-color);
        padding: 1.5rem;
        border-radius: 0 12px 12px 0;
        margin-bottom: 2rem;
        position: relative;
    }

    .patient-statement .emotion-indicator {
        position: absolute;
        top: -8px;
        right: 1rem;
        background: var(--primary-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .emotion-concerned { background: var(--warning-color); color: #333; }
    .emotion-angry { background: var(--danger-color); color: white; } /* –£–±–µ–¥–∏–º—Å—è —á—Ç–æ —Ç–µ–∫—Å—Ç –≤–∏–¥–µ–Ω */
    .emotion-happy { background: var(--success-color); color: white; } /* –£–±–µ–¥–∏–º—Å—è —á—Ç–æ —Ç–µ–∫—Å—Ç –≤–∏–¥–µ–Ω */
    .emotion-neutral { background: var(--info-color); color: white; } /* –£–±–µ–¥–∏–º—Å—è —á—Ç–æ —Ç–µ–∫—Å—Ç –≤–∏–¥–µ–Ω */
    .emotion-confused { background: #6c757d; color: white; } /* –ü—Ä–∏–º–µ—Ä –¥–ª—è confused */


    /* –ù–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è –∑–∞–º–µ—Ç–æ–∫ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∞ */
    .dentist-notes {
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        border: 1px solid #bbdefb;
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        position: relative;
    }

    .dentist-notes::before {
        content: "üë®‚Äç‚öïÔ∏è"; /* –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–∫–æ–Ω–∫—É Bootstrap, –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã */
        position: absolute;
        top: -12px;
        left: 1rem;
        background: white;
        padding: 0 0.5rem;
        font-size: 1.2rem;
    }

    .dentist-notes h4 {
        color: #1976d2;
        margin: 0 0 0.75rem;
        font-size: 0.95rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .dentist-notes p {
        margin: 0;
        color: #424242;
        line-height: 1.5;
        font-style: italic;
    }

    .response-options {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .response-option {
        background: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1.25rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
        font-size: 1rem;
        line-height: 1.5;
        position: relative;
    }

    .response-option:hover {
        border-color: var(--primary-color);
        background: rgba(62, 205, 193, 0.05);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .response-option.selected {
        border-color: var(--primary-color);
        background: rgba(62, 205, 193, 0.1);
    }

    .score-indicator {
        position: absolute;
        top: -8px;
        right: 1rem;
        background: var(--text-secondary);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .score-indicator.score-positive { background: var(--success-color); } /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ */
    .score-indicator.score-negative { background: var(--danger-color); }
    .score-indicator.score-neutral { background: var(--text-secondary); }


    .response-option.revealed .score-indicator {
        opacity: 1;
    }

    .sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .progress-card, .info-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        padding: 1.5rem;
    }

    .progress-card h3, .info-card h3 {
        margin: 0 0 1rem;
        font-size: 1.1rem;
        color: var(--text-primary);
    }

    .score-display {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        text-align: center;
        margin-bottom: 0.5rem;
    }

    .score-label {
        text-align: center;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .decision-history {
        max-height: 200px;
        overflow-y: auto;
    }

    .decision-item {
        padding: 0.75rem;
        border-left: 3px solid var(--border-color);
        margin-bottom: 0.75rem;
        background: var(--background-light);
        border-radius: 0 8px 8px 0;
        font-size: 0.85rem;
    }
    
    /* –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ score_change –≤ –∏—Å—Ç–æ—Ä–∏–∏ */
    .decision-score-positive { color: var(--success-color); font-weight: bold; }
    .decision-score-negative { color: var(--danger-color); font-weight: bold; }
    .decision-score-neutral { color: var(--text-secondary); }


    .decision-good { border-left-color: var(--success-color); } /* –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∏–ª–∏ —É–±—Ä–∞—Ç—å, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –æ—á–∫–æ–≤ */
    .decision-poor { border-left-color: var(--danger-color); }

    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        justify-content: center;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
    }

    .btn-secondary {
        background: var(--background-light);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
        background: var(--border-color);
        color: var(--text-primary);
    }

    @media (max-width: 768px) {
        .patient-interface {
            grid-template-columns: 1fr;
        }
        
        .virtual-patient-container {
            padding: 1rem;
        }
    }

    .dentist-notes {
        animation: slideInFromTop 0.5s ease-out;
    }

    @keyframes slideInFromTop {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .dentist-notes.new-note {
        animation: pulse 2s ease-in-out;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.02); }
    }
</style>
{% endblock %}

{% block content %}
<div class="virtual-patient-container">
    <div class="patient-interface">
        <div class="conversation-area">
            <div class="patient-header">
                {# –ò—Å–ø–æ–ª—å–∑—É–µ–º global_patient_info –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è #}
                <img src="{{ url_for('static', filename='images/virtual_patients/' + (global_patient_info.image or 'patient_default.jpg')) }}"
                     alt="{{ scenario_data_for_lang.patient_info.name|default(t('patient', lang=lang)) }}" class="patient-avatar">
                <div class="patient-info">
                    {# –ò—Å–ø–æ–ª—å–∑—É–µ–º scenario_data_for_lang –¥–ª—è –∏–º–µ–Ω–∏ (–ø–µ—Ä–µ–≤–æ–¥–∏–º–∞—è —á–∞—Å—Ç—å) #}
                    <h3>{{ scenario_data_for_lang.patient_info.name|default(global_patient_info.name)|default(t('patient', lang=lang)) }}</h3>
                    <div class="patient-details">
                        {# –ò—Å–ø–æ–ª—å–∑—É–µ–º global_patient_info –¥–ª—è –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏ –ø–æ–ª–∞ #}
                        {{ global_patient_info.age|default('N/A') }} {{ t('years_old', lang=lang) if global_patient_info.age else '' }}, 
                        {% if global_patient_info.gender == 'male' %}
                            {{ t('male', lang=lang) }}
                        {% elif global_patient_info.gender == 'female' %}
                            {{ t('female', lang=lang) }}
                        {% else %}
                            {{ global_patient_info.gender|default('N/A') }}
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="conversation-content">
                <div class="patient-statement">
                    <span class="emotion-indicator emotion-{{ current_node.patient_emotion|default('neutral') }}">
                        {{ current_node.patient_emotion|default('neutral')|title }}
                    </span>
                    <p>{{ current_node.patient_statement|default(t('error_loading_statement', lang=lang)) }}</p>
                </div>
                
                {% if dentist_notes and dentist_notes.should_display and (dentist_notes.clinical_observations or dentist_notes.diagnostic_hints or dentist_notes.examination_results) %}
                <div class="dentist-notes" id="dentist-notes-block"> {# –ò–∑–º–µ–Ω–µ–Ω–æ ID, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å JS, –µ—Å–ª–∏ –æ–Ω –∏—â–µ—Ç #dentist-notes #}
                    {% if dentist_notes.clinical_observations %}
                        <h4>{{ t('clinical_observations_title', lang=lang) | default('–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è') }}</h4>
                        <p>{{ dentist_notes.clinical_observations }}</p>
                    {% endif %}
                    {% if dentist_notes.diagnostic_hints %}
                        <h4 style="margin-top: 0.75rem;">{{ t('diagnostic_hints_title', lang=lang) | default('–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏') }}</h4>
                        <p>{{ dentist_notes.diagnostic_hints }}</p>
                    {% endif %}
                     {% if dentist_notes.examination_results %}
                        <h4 style="margin-top: 0.75rem;">{{ t('examination_results_title', lang=lang) | default('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è') }}</h4>
                        <p>{{ dentist_notes.examination_results }}</p>
                    {% endif %}
                </div>
                {% endif %}
                
                {% if not is_final and current_node.options %}
                <div class="response-options" id="response-options">
                    {% for option in current_node.options %}
                    <button class="response-option" 
                            data-option-index="{{ loop.index0 }}"
                            data-score="{{ option.score|default(0) }}"
                            data-feedback="{{ option.feedback|default('') }}" {# –î–ª—è JS, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω —Ñ–∏–¥–±–µ–∫ #}
                            data-empathy="{{ option.empathy_level|default('neutral') }}" {# –î–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ —Å–∫–æ—Ä–∏–Ω–≥–∞ #}
                            >
                        {{ option.text }}
                        {# –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –±–∞–ª–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–π JS –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ #}
                        <span class="score-indicator score-{{ 'positive' if (option.score|default(0)) > 0 else ('negative' if (option.score|default(0)) < 0 else 'neutral') }}">
                            {% if (option.score|default(0)) > 0 %}+{% endif %}{{ option.score|default(0) }}
                        </span>
                    </button>
                    {% endfor %}
                </div>
                {% elif is_final %}
                <div class="scenario-complete">
                    <h3>{{ t('scenario_completed_title', lang=lang) | default('–°—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω') }}</h3>
                    <p>{{ t('scenario_completed_text', lang=lang) | default('–°–ø–∞—Å–∏–±–æ –∑–∞ —É—á–∞—Å—Ç–∏–µ –≤ –¥–∞–Ω–Ω–æ–º –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–º —Å–ª—É—á–∞–µ.') }}</p>
                </div>
                {% else %}
                 <div class="patient-statement">
                    <p>{{ t('no_options_available', lang=lang) | default('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞. –í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –∫–æ–Ω–µ—Ü –≤–µ—Ç–∫–∏ –∏–ª–∏ –æ—à–∏–±–∫–∞ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏.') }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="sidebar">
            <div class="progress-card">
                <h3>{{ t('your_score', lang=lang) | default('–í–∞—à —Å—á–µ—Ç') }}</h3>
                <div class="score-display" id="current-score">{{ attempt.score|default(0) }}</div>
                <div class="score-label">{{ t('of_max_score', lang=lang, max_score=(scenario_model_obj.max_score|default(100))) | default("–∏–∑ " ~ (scenario_model_obj.max_score|default(100)) ~ " –±–∞–ª–ª–æ–≤") }}</div>
            </div>
            
            <div class="info-card">
                <h3>{{ t('medical_history_title', lang=lang) | default('–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è') }}</h3>
                {# –ò—Å–ø–æ–ª—å–∑—É–µ–º scenario_data_for_lang –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –±–æ–ª–µ–∑–Ω–∏ #}
                <p>{{ scenario_data_for_lang.patient_info.medical_history|default(t('not_specified', lang=lang)) }}</p>
            </div>
            
            <div class="info-card">
                <h3>{{ t('decision_history_title', lang=lang) | default('–ò—Å—Ç–æ—Ä–∏—è —Ä–µ—à–µ–Ω–∏–π') }}</h3>
                <div class="decision-history" id="decision-history">
                    {% if history and history.decisions %}
                        {% for decision in history.decisions %}
                        <div class="decision-item">
                            {{ decision.option_text|truncate(50) if decision.option_text else t('action_taken', lang=lang) }}
                            {# –ò—Å–ø–æ–ª—å–∑—É–µ–º final_score –∏–∑ decision_record, –µ—Å–ª–∏ –æ–Ω —Ç–∞–º –µ—Å—Ç—å (–∏–∑ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ select_option) #}
                            {% set score_to_display = decision.final_score if decision.final_score is defined else decision.score_awarded if decision.score_awarded is defined else decision.score %}
                            <span style="float: right;" class="decision-score-{{ 'positive' if score_to_display > 0 else ('negative' if score_to_display < 0 else 'neutral') }}">
                                {% if score_to_display > 0 %}+{% endif %}{{ score_to_display }}
                            </span>
                            {# –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å feedback, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å –≤ decision.feedback #}
                            {% if decision.feedback and decision.feedback|length > 0 %}
                                <small style="display: block; margin-top: 4px; opacity: 0.7;"><em>{{ decision.feedback|join(' ') }}</em></small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <p>{{ t('no_decisions_yet', lang=lang) | default('–†–µ—à–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ –ø—Ä–∏–Ω—è—Ç–æ.') }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="action-buttons">
        {% if not is_final %}
        <button class="btn btn-secondary" onclick="confirmExitScenario()">
            <i class="bi bi-arrow-left"></i>
            {{ t('exit_scenario_button', lang=lang) | default('–í—ã–π—Ç–∏ –∏–∑ —Å—Ü–µ–Ω–∞—Ä–∏—è') }}
        </button>
        {# –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞, –µ—Å–ª–∏ –ª–æ–≥–∏–∫–∞ –Ω–µ —á–∏—Å—Ç–æ –Ω–∞ –≤—ã–±–æ—Ä–µ –æ–ø—Ü–∏–π #}
        {% else %}
        <button class="btn btn-primary" onclick="window.location.href='{{ url_for('virtual_patient_bp.results', lang=lang, attempt_id=attempt.id) }}'">
            <i class="bi bi-chart-line"></i>
            {{ t('view_results_button', lang=lang) | default('–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã') }}
        </button>
        <button class="btn btn-secondary" onclick="window.location.href='{{ url_for('virtual_patient_bp.scenarios_list', lang=lang) }}'">
            <i class="bi bi-list"></i>
            {{ t('to_scenarios_list_button', lang=lang) | default('–ö —Å–ø–∏—Å–∫—É —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤') }}
        </button>
        {% endif %}
    </div>
</div>
{% endblock %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
{% block body_scripts %}
{{ super() }} {# –ï—Å–ª–∏ –≤ base.html –µ—Å—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –≤ —ç—Ç–æ–º –±–ª–æ–∫–µ #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const responseOptionsContainer = document.getElementById('response-options');
    const currentScoreElement = document.getElementById('current-score');
    const decisionHistoryElement = document.getElementById('decision-history');
    let interactionDisabled = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–ª–∏–∫–æ–≤

    if (responseOptionsContainer) {
        responseOptionsContainer.addEventListener('click', function(event) {
            const selectedButton = event.target.closest('.response-option');
            if (!selectedButton || interactionDisabled) return; 

            interactionDisabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–∞–ª—å–Ω–µ–π—à–∏–µ –∫–ª–∏–∫–∏
            
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö –∫–Ω–æ–ø–æ–∫ –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –∫ —Ç–µ–∫—É—â–µ–π
            document.querySelectorAll('.response-option').forEach(btn => btn.classList.remove('selected'));
            selectedButton.classList.add('selected');
            
            const optionIndex = selectedButton.getAttribute('data-option-index');
            // const baseScore = parseInt(selectedButton.getAttribute('data-score')); // –ë–∞–∑–æ–≤—ã–π –±–∞–ª–ª –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞
            // const feedbackText = selectedButton.getAttribute('data-feedback');
            // const empathyLevel = selectedButton.getAttribute('data-empathy');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –±–∞–ª–ª–æ–≤ –¥–ª—è –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
            document.querySelectorAll('.response-option').forEach(opt => {
                opt.classList.add('revealed');
                opt.style.pointerEvents = 'none'; // –î–µ–ª–∞–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏ –Ω–µ–∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏
            });
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—ã–±–æ—Ä –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetch('{{ url_for("virtual_patient_bp.select_option", lang=lang) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // CSRF —Ç–æ–∫–µ–Ω, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Flask-WTF –∏–ª–∏ Flask-SeaSurf
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                },
                body: JSON.stringify({
                    attempt_id: {{ attempt.id }},
                    option_index: parseInt(optionIndex),
                    decision_time: 5 // –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è, –ª—É—á—à–µ –∏–∑–º–µ—Ä—è—Ç—å
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    if (currentScoreElement) {
                        currentScoreElement.textContent = data.score;
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ—à–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é (–µ—Å–ª–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ, –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω–µ—Ç –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é)
                    if (decisionHistoryElement && selectedButton) {
                        const newDecision = document.createElement('div');
                        newDecision.className = 'decision-item';
                        
                        let scoreToDisplay = data.score_change; // –ò—Å–ø–æ–ª—å–∑—É–µ–º score_change –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
                        let scoreClass = 'neutral';
                        if (scoreToDisplay > 0) scoreClass = 'positive';
                        else if (scoreToDisplay < 0) scoreClass = 'negative';

                        newDecision.innerHTML = `
                            ${selectedButton.textContent.trim().split('\n')[0].substring(0, 50)}...
                            <span style="float: right;" class="decision-score-${scoreClass}">
                                ${scoreToDisplay > 0 ? '+' : ''}${scoreToDisplay}
                            </span>
                        `;
                        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–¥–±–µ–∫ –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
                        if (data.score_feedback && Array.isArray(data.score_feedback) && data.score_feedback.length > 0) {
                            const feedbackP = document.createElement('small');
                            feedbackP.style.display = 'block';
                            feedbackP.style.marginTop = '4px';
                            feedbackP.style.opacity = '0.7';
                            feedbackP.innerHTML = `<em>${data.score_feedback.join('; ')}</em>`;
                            newDecision.appendChild(feedbackP);
                        }

                        decisionHistoryElement.appendChild(newDecision);
                        decisionHistoryElement.scrollTop = decisionHistoryElement.scrollHeight;
                    }
                    
                    // –ê–Ω–∏–º–∏—Ä—É–µ–º –∑–∞–º–µ—Ç–∫–∏ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∞, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –∏ –ø—Ä–∏—à–ª–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
                    const dentistNotesBlock = document.getElementById('dentist-notes-block');
                    if (data.clinical_notes && dentistNotesBlock) { // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç clinical_notes
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫
                        // –ü—Ä–∏–º–µ—Ä: dentistNotesBlock.querySelector('p').textContent = data.clinical_notes;
                        // dentistNotesBlock.style.display = 'block'; // –ï—Å–ª–∏ –æ–Ω –±—ã–ª —Å–∫—Ä—ã—Ç
                        dentistNotesBlock.classList.add('new-note'); // –î–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
                        setTimeout(() => dentistNotesBlock.classList.remove('new-note'), 2000);
                    }
                    
                    setTimeout(() => {
                        if (data.is_final && data.next_url) {
                            window.location.href = data.next_url;
                        } else if (!data.is_final) {
                            window.location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É–∑–ª–∞
                        } else {
                            // –§–∏–Ω–∞–ª—å–Ω—ã–π —É–∑–µ–ª, –Ω–æ –Ω–µ—Ç next_url (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —É–∂–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
                            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É "–ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º", –µ—Å–ª–∏ –µ–µ –µ—â–µ –Ω–µ—Ç
                             const actionButtons = document.querySelector('.action-buttons');
                             if(actionButtons && !actionButtons.querySelector('.btn-primary')){ // –µ—Å–ª–∏ –Ω–µ—Ç –∫–Ω–æ–ø–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                                const resultsButton = document.createElement('button');
                                resultsButton.className = 'btn btn-primary';
                                resultsButton.innerHTML = `<i class="bi bi-chart-line"></i> {{ t('view_results_button', lang=lang) }}`;
                                resultsButton.onclick = () => window.location.href = '{{ url_for("virtual_patient_bp.results", lang=lang, attempt_id=attempt.id) }}';
                                actionButtons.prepend(resultsButton);
                             }
                        }
                    }, 1500); // –ó–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–µ–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–±–æ—Ä–∞
                } else {
                    alert(('Error') + ': ' + data.message);
                    interactionDisabled = false; // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º, –µ—Å–ª–∏ –æ—à–∏–±–∫–∞
                     document.querySelectorAll('.response-option').forEach(opt => {
                        opt.style.pointerEvents = 'auto';
                        opt.classList.remove('selected', 'revealed');
                    });
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                alert(('An error occurred while processing your choice.'));
                interactionDisabled = false; // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ
                 document.querySelectorAll('.response-option').forEach(opt => {
                    opt.style.pointerEvents = 'auto';
                    opt.classList.remove('selected', 'revealed');
                });
            });
        });
    }
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è "–Ω–æ–≤—ã—Ö" –∑–∞–º–µ—Ç–æ–∫ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∞, –µ—Å–ª–∏ –æ–Ω–∏ —É–∂–µ –µ—Å—Ç—å –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    const dentistNotesBlockInitial = document.getElementById('dentist-notes-block');
    if (dentistNotesBlockInitial && dentistNotesBlockInitial.offsetParent !== null) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –≤–∏–¥–∏–º
        dentistNotesBlockInitial.style.opacity = '0'; // –î–ª—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
            dentistNotesBlockInitial.style.opacity = '1';
            dentistNotesBlockInitial.classList.add('new-note'); // –î–ª—è –ø—É–ª—å—Å–∞—Ü–∏–∏
             setTimeout(() => dentistNotesBlockInitial.classList.remove('new-note'), 2000);
        }, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è transition/animation
    }
});

function confirmExitScenario() {
    if (confirm("{{ t('confirm_exit_scenario', lang=lang) | default('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ —Å—Ü–µ–Ω–∞—Ä–∏—è? –í–∞—à —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞.') }}")) {
        window.location.href='{{ url_for("virtual_patient_bp.scenarios_list", lang=lang) }}';
    }
}
</script>
{% endblock %}