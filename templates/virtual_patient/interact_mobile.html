<!-- –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è virtual_patient/interact_mobile.html -->

{% extends "base.html" %}

{% block title %}{{ scenario.title }} - Virtual Patient{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    :root {
        --mobile-padding: 1rem;
        --mobile-gap: 0.75rem;
        --touch-target-size: 44px;
        --swipe-threshold: 50px;
    }

    .mobile-virtual-patient {
        min-height: 100vh;
        background: var(--background-light);
        padding: 0;
        overflow-x: hidden;
    }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è —à–∞–ø–∫–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞ */
    .mobile-patient-header {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        padding: 1rem;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .patient-summary {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .mobile-patient-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 2px solid rgba(255,255,255,0.3);
        object-fit: cover;
    }

    .patient-basic-info h3 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
    }

    .patient-basic-info .details {
        font-size: 0.85rem;
        opacity: 0.9;
        margin: 0.25rem 0 0;
    }

    .mobile-score-display {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: rgba(255,255,255,0.2);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    /* Swipeable –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .conversation-container {
        position: relative;
        height: calc(100vh - 140px);
        overflow: hidden;
    }

    .conversation-card {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 -4px 16px rgba(0,0,0,0.1);
        transform: translateY(100%);
        transition: transform 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .conversation-card.active {
        transform: translateY(0);
    }

    .card-handle {
        width: 40px;
        height: 4px;
        background: #ccc;
        border-radius: 2px;
        margin: 8px auto;
        cursor: grab;
    }

    .card-content {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* –ú–æ–±–∏–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è */
    .patient-message {
        background: var(--background-light);
        border-radius: 16px 16px 16px 4px;
        padding: 1rem;
        margin-bottom: 1rem;
        position: relative;
    }

    .message-emotion {
        position: absolute;
        top: -8px;
        right: 1rem;
        background: var(--primary-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 500;
    }

    .mobile-dentist-notes {
        background: linear-gradient(135deg, #e8f4f8, #f0e8ff);
        border: 1px solid #d1ecf1;
        border-radius: 12px;
        padding: 1rem;
        margin: 1rem 0;
        position: relative;
        animation: slideInUp 0.5s ease;
    }

    .mobile-dentist-notes::before {
        content: "üîç";
        position: absolute;
        top: -12px;
        left: 1rem;
        background: white;
        padding: 0 0.5rem;
        font-size: 1rem;
    }

    /* –ú–æ–±–∏–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ */
    .mobile-response-options {
        padding: 0 1rem 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        max-height: 50vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    .mobile-response-option {
        background: white;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1rem;
        text-align: left;
        font-size: 0.95rem;
        line-height: 1.4;
        position: relative;
        transition: all 0.3s ease;
        min-height: var(--touch-target-size);
        display: flex;
        align-items: center;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
    }

    .mobile-response-option:active {
        transform: scale(0.98);
        background: rgba(62, 205, 193, 0.05);
    }

    .mobile-response-option.selected {
        border-color: var(--primary-color);
        background: rgba(62, 205, 193, 0.1);
    }

    .mobile-score-badge {
        position: absolute;
        top: -6px;
        right: 0.75rem;
        background: var(--text-secondary);
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 600;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .mobile-response-option.revealed .mobile-score-badge {
        opacity: 1;
    }

    /* –ú–æ–±–∏–ª—å–Ω–∞—è –Ω–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å */
    .mobile-bottom-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid var(--border-color);
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        z-index: 50;
    }

    .mobile-nav-btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        min-height: var(--touch-target-size);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        -webkit-tap-highlight-color: transparent;
    }

    .mobile-nav-btn.secondary {
        background: var(--background-light);
        color: var(--text-secondary);
    }

    .mobile-nav-btn.primary {
        background: var(--primary-color);
        color: white;
    }

    .mobile-nav-btn:active {
        transform: scale(0.95);
    }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä */
    .mobile-progress {
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        height: 3px;
        background: rgba(255,255,255,0.3);
        z-index: 99;
    }

    .mobile-progress-fill {
        height: 100%;
        background: rgba(255,255,255,0.8);
        width: 0%;
        transition: width 0.5s ease;
    }

    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    .mobile-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: none;
        align-items: flex-end;
        justify-content: center;
    }

    .mobile-modal.show {
        display: flex;
    }

    .mobile-modal-content {
        background: white;
        border-radius: 16px 16px 0 0;
        padding: 1.5rem;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        transform: translateY(100%);
        transition: transform 0.3s ease;
    }

    .mobile-modal.show .mobile-modal-content {
        transform: translateY(0);
    }

    /* –ñ–µ—Å—Ç—ã –∏ –∞–Ω–∏–º–∞—Ü–∏–∏ */
    .swipe-indicator {
        position: absolute;
        bottom: 1rem;
        left: 50%;
        transform: translateX(-50%);
        color: var(--text-secondary);
        font-size: 0.8rem;
        opacity: 0.7;
        animation: bounce 2s infinite;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateX(-50%) translateY(0); }
        40% { transform: translateX(-50%) translateY(-10px); }
        60% { transform: translateX(-50%) translateY(-5px); }
    }

    @keyframes slideInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
    @media (prefers-color-scheme: dark) {
        .mobile-virtual-patient {
            background: #1a1a1a;
        }
        
        .conversation-card, .mobile-response-option, .mobile-bottom-panel {
            background: #2d2d2d;
            color: white;
        }
        
        .patient-message {
            background: #3a3a3a;
        }
        
        .mobile-dentist-notes {
            background: linear-gradient(135deg, #2a3a4a, #3a2a4a);
            border-color: #4a4a4a;
        }
    }

    /* –õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è */
    @media screen and (orientation: landscape) and (max-height: 500px) {
        .mobile-patient-header {
            padding: 0.5rem 1rem;
        }
        
        .patient-summary {
            gap: 0.5rem;
        }
        
        .mobile-patient-avatar {
            width: 40px;
            height: 40px;
        }
        
        .conversation-container {
            height: calc(100vh - 100px);
        }
        
        .mobile-response-options {
            flex-direction: row;
            flex-wrap: wrap;
            padding: 0.5rem;
        }
        
        .mobile-response-option {
            flex: 1;
            min-width: calc(50% - 0.375rem);
            padding: 0.75rem;
        }
    }

    /* Accessibility —É–ª—É—á—à–µ–Ω–∏—è */
    @media (prefers-reduced-motion: reduce) {
        .conversation-card,
        .mobile-modal-content,
        .mobile-response-option,
        .mobile-nav-btn {
            transition: none;
        }
        
        .swipe-indicator {
            animation: none;
        }
    }

    /* High contrast mode */
    @media (prefers-contrast: high) {
        .mobile-response-option {
            border-width: 3px;
        }
        
        .mobile-response-option.selected {
            border-color: #000;
            background: #ffff00;
            color: #000;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="mobile-virtual-patient">
    <!-- –ú–æ–±–∏–ª—å–Ω–∞—è —à–∞–ø–∫–∞ -->
    <div class="mobile-patient-header">
        <div class="patient-summary">
            <img src="{{ url_for('static', filename='images/virtual_patients/' + scenario_data.patient_info.image) }}" 
                 alt="Patient" class="mobile-patient-avatar">
            <div class="patient-basic-info">
                <h3>{{ scenario_data.patient_info.name }}</h3>
                <div class="details">{{ scenario_data.patient_info.age }} –ª–µ—Ç, {{ scenario_data.patient_info.gender }}</div>
            </div>
        </div>
        <div class="mobile-score-display">
            <span id="mobile-score">{{ attempt.score }}</span>/{{ scenario.max_score }}
        </div>
    </div>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
    <div class="mobile-progress">
        <div class="mobile-progress-fill" id="mobile-progress-fill"></div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="conversation-container">
        <div class="conversation-card active">
            <div class="card-handle"></div>
            <div class="card-content">
                <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞ -->
                <div class="patient-message">
                    <span class="message-emotion">{{ current_node.patient_emotion or 'neutral' }}</span>
                    <p>{{ current_node.patient_statement }}</p>
                </div>

                <!-- –ó–∞–º–µ—Ç–∫–∏ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∞ (–º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è) -->
                {% if current_node.notes_dentist %}
                <div class="mobile-dentist-notes">
                    <h4 style="margin: 0 0 0.5rem; font-size: 0.9rem; color: #1976d2;">–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è</h4>
                    <p style="margin: 0; font-size: 0.85rem; line-height: 1.4;">{{ current_node.notes_dentist }}</p>
                </div>
                {% endif %}

                <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ (–º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è) -->
                {% if not is_final %}
                <div class="mobile-response-options" id="mobile-response-options">
                    {% for option in current_node.options %}
                    <button class="mobile-response-option" 
                            data-option-index="{{ loop.index0 }}"
                            data-score="{{ option.score }}"
                            aria-label="–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ {{ loop.index }}">
                        {{ option.text }}
                        <span class="mobile-score-badge score-{{ 'positive' if option.score > 0 else 'negative' if option.score < 0 else 'neutral' }}">
                            {% if option.score > 0 %}+{% endif %}{{ option.score }}
                        </span>
                    </button>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–≤–∞–π–ø–∞ -->
                {% if not is_final %}
                <div class="swipe-indicator">
                    <i class="bi bi-chevron-up"></i>
                    –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
    <div class="mobile-bottom-panel">
        <button class="mobile-nav-btn secondary" onclick="showMobileMenu()">
            <i class="bi bi-list"></i>
            –ú–µ–Ω—é
        </button>
        
        {% if is_final %}
        <button class="mobile-nav-btn primary" onclick="window.location.href='{{ url_for('virtual_patient_bp.results', lang=lang, attempt_id=attempt.id) }}'">
            <i class="bi bi-chart-line"></i>
            –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
        </button>
        {% else %}
        <button class="mobile-nav-btn secondary" onclick="showHint()" id="hint-btn">
            <i class="bi bi-lightbulb"></i>
            –ü–æ–¥—Å–∫–∞–∑–∫–∞
        </button>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é -->
<div class="mobile-modal" id="mobile-menu-modal">
    <div class="mobile-modal-content">
        <h3>–ú–µ–Ω—é —Å—Ü–µ–Ω–∞—Ä–∏—è</h3>
        <div style="margin-top: 1rem;">
            <button class="mobile-nav-btn secondary" style="width: 100%; margin-bottom: 1rem;" onclick="showPatientHistory()">
                <i class="bi bi-file-medical"></i>
                –ò—Å—Ç–æ—Ä–∏—è –±–æ–ª–µ–∑–Ω–∏
            </button>
            <button class="mobile-nav-btn secondary" style="width: 100%; margin-bottom: 1rem;" onclick="showDecisionHistory()">
                <i class="bi bi-clock-history"></i>
                –ò—Å—Ç–æ—Ä–∏—è —Ä–µ—à–µ–Ω–∏–π
            </button>
            <button class="mobile-nav-btn secondary" style="width: 100%; margin-bottom: 1rem;" onclick="window.location.href='{{ url_for('virtual_patient_bp.scenarios_list', lang=lang) }}'">
                <i class="bi bi-arrow-left"></i>
                –í—ã–π—Ç–∏ –∏–∑ —Å—Ü–µ–Ω–∞—Ä–∏—è
            </button>
            <button class="mobile-nav-btn secondary" style="width: 100%;" onclick="closeMobileModal('mobile-menu-modal')">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ –±–æ–ª–µ–∑–Ω–∏ -->
<div class="mobile-modal" id="patient-history-modal">
    <div class="mobile-modal-content">
        <h3>–ò—Å—Ç–æ—Ä–∏—è –±–æ–ª–µ–∑–Ω–∏</h3>
        <div style="margin-top: 1rem;">
            <p><strong>–ò–º—è:</strong> {{ scenario_data.patient_info.name }}</p>
            <p><strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> {{ scenario_data.patient_info.age }} –ª–µ—Ç</p>
            <p><strong>–ü–æ–ª:</strong> {{ scenario_data.patient_info.gender }}</p>
            <p><strong>–ê–Ω–∞–º–Ω–µ–∑:</strong></p>
            <p style="background: var(--background-light); padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
                {{ scenario_data.patient_info.medical_history }}
            </p>
            <button class="mobile-nav-btn primary" style="width: 100%; margin-top: 1rem;" onclick="closeMobileModal('patient-history-modal')">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–µ—à–µ–Ω–∏–π -->
<div class="mobile-modal" id="decision-history-modal">
    <div class="mobile-modal-content">
        <h3>–ò—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö —Ä–µ—à–µ–Ω–∏–π</h3>
        <div style="margin-top: 1rem;" id="mobile-decision-list">
            {% for decision in history.decisions %}
            <div style="background: var(--background-light); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid {{ '#28a745' if decision.score > 0 else '#dc3545' }};">
                <div style="font-weight: 500; margin-bottom: 0.5rem;">{{ decision.option_text|truncate(80) }}</div>
                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                    –ë–∞–ª–ª—ã: {% if decision.score > 0 %}+{% endif %}{{ decision.score }}
                </div>
            </div>
            {% endfor %}
        </div>
        <button class="mobile-nav-btn primary" style="width: 100%; margin-top: 1rem;" onclick="closeMobileModal('decision-history-modal')">
            –ó–∞–∫—Ä—ã—Ç—å
        </button>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const responseOptions = document.querySelectorAll('.mobile-response-option');
    const mobileScore = document.getElementById('mobile-score');
    const progressFill = document.getElementById('mobile-progress-fill');
    let selectedOption = null;
    let touchStartY = 0;
    let touchCurrentY = 0;
    
    // Touch —Å–æ–±—ã—Ç–∏—è –¥–ª—è —Å–≤–∞–π–ø–æ–≤
    const conversationCard = document.querySelector('.conversation-card');
    
    conversationCard.addEventListener('touchstart', function(e) {
        touchStartY = e.touches[0].clientY;
    }, { passive: true });
    
    conversationCard.addEventListener('touchmove', function(e) {
        touchCurrentY = e.touches[0].clientY;
        const diff = touchCurrentY - touchStartY;
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Å–≤–∞–π–ø—ã
        if (Math.abs(diff) > var(--swipe-threshold)) {
            e.preventDefault();
        }
    }, { passive: false });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
    responseOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (selectedOption) return;
            
            selectedOption = this;
            const optionIndex = this.getAttribute('data-option-index');
            const score = parseInt(this.getAttribute('data-score'));
            
            // –¢–∞–∫—Ç–∏–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
            
            // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
            this.classList.add('selected');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–ª–ª—ã –¥–ª—è –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
            responseOptions.forEach(opt => {
                opt.classList.add('revealed');
                opt.style.pointerEvents = 'none';
            });
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—ã–±–æ—Ä
            submitMobileChoice(optionIndex, score);
        });
    });
    
    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—ã–±–æ—Ä–∞
    function submitMobileChoice(optionIndex, score) {
        fetch('{{ url_for("virtual_patient_bp.select_option", lang=lang) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            },
            body: JSON.stringify({
                attempt_id: {{ attempt.id }},
                option_index: parseInt(optionIndex),
                decision_time: Date.now() - pageLoadTime
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç
                mobileScore.textContent = data.score;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–¥–±–µ–∫
                if (data.score_feedback && data.score_feedback.length > 0) {
                    showMobileFeedback(data.score_feedback);
                }
                
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
                setTimeout(() => {
                    if (data.is_final) {
                        if (data.next_url) {
                            window.location.href = data.next_url;
                        }
                    } else {
                        window.location.reload();
                    }
                }, 2000);
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –≤—ã–±–æ—Ä–∞.');
        });
    }
    
    // –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Ä–µ—à–µ–Ω–∏—è
    const pageLoadTime = Date.now();
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–ø—Ä–∏–º–µ—Ä–Ω–æ–µ)
    const totalSteps = 10; // –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤
    const currentStep = {{ history.decisions|length + 1 }};
    const progressPercent = (currentStep / totalSteps) * 100;
    progressFill.style.width = Math.min(100, progressPercent) + '%';
});

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
function showMobileMenu() {
    showMobileModal('mobile-menu-modal');
}

function showPatientHistory() {
    closeMobileModal('mobile-menu-modal');
    showMobileModal('patient-history-modal');
}

function showDecisionHistory() {
    closeMobileModal('mobile-menu-modal');
    showMobileModal('decision-history-modal');
}

function showMobileModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }
}

function closeMobileModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
}

function showHint() {
    // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É (–º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–∑–∂–µ)
    alert('–ü–æ–¥—Å–∫–∞–∑–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏!');
}

function showMobileFeedback(feedbackArray) {
    const feedbackText = feedbackArray.join('\n');
    
    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 70px;
        left: 1rem;
        right: 1rem;
        background: var(--primary-color);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        z-index: 1001;
        animation: slideInUp 0.3s ease;
        font-size: 0.9rem;
        line-height: 1.4;
    `;
    notification.textContent = feedbackText;
    
    document.body.appendChild(notification);
    
    // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        notification.style.animation = 'slideOutUp 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–µ–π –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('mobile-modal')) {
        e.target.classList.remove('show');
        document.body.style.overflow = '';
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–Ω–∞–∑–∞–¥" –Ω–∞ Android
window.addEventListener('popstate', function(e) {
    const openModal = document.querySelector('.mobile-modal.show');
    if (openModal) {
        openModal.classList.remove('show');
        document.body.style.overflow = '';
        history.pushState(null, null, window.location.href);
    }
});

// –ë–ª–æ–∫–∏—Ä—É–µ–º zoom –ø—Ä–∏ –¥–≤–æ–π–Ω–æ–º —Ç–∞–ø–µ
let lastTouchEnd = 0;
document.addEventListener('touchend', function(event) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) {
        event.preventDefault();
    }
    lastTouchEnd = now;
}, false);
</script>
{% endblock %}