{% extends "base.html" %}
{% block content %}
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/virtual_patient_results.css') }}">

<!-- SVG –≥—Ä–∞–¥–∏–µ–Ω—Ç—ã –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º –∏ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ -->
<svg width="0" height="0" style="position: absolute;">
  <defs>
    <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#3ECDC1;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#2bb8ac;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="primaryGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="successGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
    </linearGradient>
  </defs>
</svg>

<div class="container py-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∞–Ω–∏–º–∞—Ü–∏—è–º–∏ -->
    <div class="text-center mb-4 scroll-reveal">
        <h1 class="gradient-text">–ê–Ω–∞–ª–∏–∑ –∫–ª–∏–Ω–∏—á–µ—Å–∫–æ–≥–æ —Å–ª—É—á–∞—è</h1>
        <h2 class="text-muted">{{ scenario_data_for_lang.patient_info.name }}</h2>
        <p class="lead">{{ scenario.title }}</p>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å –Ω–æ–≤–æ–π —Å–µ—Ç–∫–æ–π -->
    <div class="results-container">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="results-main">
            
            <!-- –ë–ª–æ–∫ –æ–±—â–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ —Å—Ç–∏–ª—è–º–∏ -->
            <div class="performance-overview card-base scroll-reveal">
                <h3>–û–±—â–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h3>
                
                <!-- –£–ª—É—á—à–µ–Ω–Ω—ã–π –∫—Ä—É–≥–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å –∞–Ω–∏–º–∞—Ü–∏—è–º–∏ -->
                <div class="score-circle">
                    <svg viewBox="0 0 120 120">
                        <circle class="background-ring" cx="60" cy="60" r="52"></circle>
                        <circle class="progress-ring" cx="60" cy="60" r="52" 
                                stroke="url(#scoreGradient)"
                                stroke-dasharray="326.73" 
                                stroke-dashoffset="{{ 326.73 - (326.73 * ((attempt.score / scenario.max_score) * 100) / 100) }}"
                                data-metric="total-score" data-max-score="{{ scenario.max_score }}">
                        </circle>
                    </svg>
                    <div class="score-display">
                        <div class="score-value">{{ attempt.score }}/{{ scenario.max_score }}</div>
                        <div class="score-label">–ë–∞–ª–ª—ã</div>
                    </div>
                </div>

                <!-- –û—Ü–µ–Ω–∫–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
                <div class="result-description">
                    <h4>{{ result_display.title }}</h4>
                    <p>{{ result_display.text }}</p>
                </div>

                <!-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–µ—Ç–∫–∞ –º–µ—Ç—Ä–∏–∫ —Å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ -->
                <div class="metrics-grid">
                    <div class="metric-card magnetic-hover interactive-glow" data-tooltip="–û–±—â–∏–π –Ω–∞–±—Ä–∞–Ω–Ω—ã–π –±–∞–ª–ª –∑–∞ —Å—Ü–µ–Ω–∞—Ä–∏–π">
                        <div class="metric-value">{{ attempt.score }}</div>
                        <div class="metric-label">–û–±—â–∏–π –±–∞–ª–ª</div>
                    </div>
                    <div class="metric-card magnetic-hover interactive-glow" data-tooltip="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–Ω—è—Ç—ã—Ö —Ä–µ—à–µ–Ω–∏–π –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏">
                        <div class="metric-value">{{ history.decisions|length }}</div>
                        <div class="metric-label">–ü—Ä–∏–Ω—è—Ç–æ —Ä–µ—à–µ–Ω–∏–π</div>
                    </div>
                    <div class="metric-card magnetic-hover interactive-glow" data-tooltip="–û–±—â–µ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è –≤ –º–∏–Ω—É—Ç–∞—Ö">
                        <div class="metric-value">{{ "%.0f"|format(attempt.time_spent or 0) }}</div>
                        <div class="metric-label">–í—Ä–µ–º—è —Å—Ü–µ–Ω–∞—Ä–∏—è</div>
                    </div>
                    <div class="metric-card magnetic-hover interactive-glow" data-tooltip="–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –ø—Ä–∏–Ω—è—Ç–∏—è –æ–¥–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è">
                        <div class="metric-value">{{ "%.0f"|format((attempt.time_spent or 360) / (history.decisions|length or 1)) }}</div>
                        <div class="metric-label">–°—Ä. –≤—Ä–µ–º—è —Ä–µ—à–µ–Ω–∏—è</div>
                    </div>
                </div>
            </div>

            <!-- –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ª–∏–Ω–∏—è —Ä–µ—à–µ–Ω–∏–π -->
            <div class="decision-timeline scroll-reveal">
                <h3>üìã –í—Ä–µ–º–µ–Ω–Ω–∞—è –ª–∏–Ω–∏—è —Ä–µ—à–µ–Ω–∏–π</h3>
                {% for decision in history.decisions %}
                <div class="decision-item animate-on-scroll">
                    <div class="decision-content">
                        <p class="decision-text">{{ decision.option_text }}</p>
                    </div>
                    <div class="decision-score {{ 'positive' if decision.score_awarded > 0 else ('negative' if decision.score_awarded < 0 else 'neutral') }}"
                         data-tooltip="–ë–∞–ª–ª—ã –∑–∞ —ç—Ç–æ —Ä–µ—à–µ–Ω–∏–µ">
                        {% if decision.score_awarded > 0 %}+{% endif %}{{ decision.score_awarded }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –≥—Ä–∞—Ñ–∏–∫ -->
        <div class="results-sidebar">
            
            <!-- –ë–ª–æ–∫ –Ω–∞–≥—Ä–∞–¥ —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞–º–∏ -->
            <div class="rewards-section scroll-reveal">
                <h3>üéâ –ù–∞–≥—Ä–∞–¥—ã –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ</h3>
                
                <div class="rewards-grid">
                    <div class="reward-card magnetic-hover button-ripple" data-tooltip="–û—á–∫–∏ –æ–ø—ã—Ç–∞ –∑–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è">
                        <div class="reward-value">+{{ calculate_base_experience_points(((attempt.score / scenario.max_score) * 100) if scenario.max_score > 0 else 0) }} XP</div>
                        <div class="reward-label">–û—á–∫–∏ –æ–ø—ã—Ç–∞</div>
                    </div>
                    <div class="reward-card magnetic-hover button-ripple" data-tooltip="–í–∞—à —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –≤ —Å–∏—Å—Ç–µ–º–µ">
                        <div class="reward-value">LVL {{ gamification_data.current_level }}</div>
                        <div class="reward-label">–í–∞—à —É—Ä–æ–≤–µ–Ω—å</div>
                    </div>
                    <div class="reward-card magnetic-hover button-ripple" data-tooltip="–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤">
                        <div class="reward-value">{{ gamification_data.scenarios_completed }}</div>
                        <div class="reward-label">–°—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                    </div>
                </div>
                
                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π -->
                <div class="level-progress">
                    <div>–î–æ —É—Ä–æ–≤–Ω—è {{ gamification_data.current_level + 1 }}: {{ gamification_data.points_to_next_level }} XP</div>
                    <div class="progress-bar">
                        {% set progress_percentage = ((gamification_data.total_xp - (100 if gamification_data.current_level > 1 else 0)) / (250 - (100 if gamification_data.current_level > 1 else 0))) * 100 if gamification_data.current_level <= 2 else 50 %}
                        <div class="progress-fill" style="width: {{ progress_percentage }}%;"></div>
                    </div>
                </div>
            </div>

            <!-- –ê–Ω–∞–ª–∏–∑ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π —Å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –¥–∏–∞–≥—Ä–∞–º–º–æ–π -->
            <div class="competency-analysis scroll-reveal">
                <h3>üìä –ê–Ω–∞–ª–∏–∑ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π</h3>
                
                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã -->
                <div class="competency-chart-container">
                    <canvas id="competencyChart"></canvas>
                </div>

                <!-- –î–µ—Ç–∞–ª—å–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º -->
                <div class="competency-scores">
                    <div class="competency-metric magnetic-hover" data-competency="empathy" data-tooltip="–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –ø–æ–Ω–∏–º–∞—Ç—å –∏ —Ä–∞–∑–¥–µ–ª—è—Ç—å —á—É–≤—Å—Ç–≤–∞ –ø–∞—Ü–∏–µ–Ω—Ç–∞">
                        <span class="competency-name">–≠–º–ø–∞—Ç–∏—è</span>
                        <span class="competency-score">{{ calculate_empathy_score(history) }}</span>
                    </div>
                    <div class="competency-metric magnetic-hover" data-competency="clinical" data-tooltip="–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –∑–Ω–∞–Ω–∏—è –∏ –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏">
                        <span class="competency-name">–ö–ª–∏–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏</span>
                        <span class="competency-score">{{ calculate_clinical_score(history) }}</span>
                    </div>
                    <div class="competency-metric magnetic-hover" data-competency="communication" data-tooltip="–ù–∞–≤—ã–∫–∏ –æ–±—â–µ–Ω–∏—è –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–∞—Ü–∏–µ–Ω—Ç–æ–º">
                        <span class="competency-name">–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è</span>
                        <span class="competency-score">{{ calculate_communication_score(history) }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –°–∏—Å—Ç–µ–º–∞ —á–∞—Å—Ç–∏—Ü –¥–ª—è –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã (—Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ JS) -->
<div class="particle-container"></div>

{% endblock %}

{% block body_scripts %}
{{ super() }}
<!-- Chart.js –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>

<!-- –ù–∞—à —É–ª—É—á—à–µ–Ω–Ω—ã–π JavaScript -->
<script src="{{ url_for('static', filename='js/virtual_patient_results.js') }}"></script>

<!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π
    const cards = document.querySelectorAll('.metric-card, .reward-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 150}ms`;
        card.classList.add('fade-in');
    });
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('revealed');
                
                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –º–µ—Ç—Ä–∏–∫
                if (entry.target.classList.contains('metric-card')) {
                    setTimeout(() => {
                        entry.target.style.transform = 'translateY(0) scale(1)';
                        entry.target.style.opacity = '1';
                    }, 100);
                }
            }
        });
    }, observerOptions);
    
    // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
    document.querySelectorAll('.scroll-reveal').forEach(el => {
        observer.observe(el);
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è tooltips
    const tooltipElements = document.querySelectorAll('[data-tooltip]');
    tooltipElements.forEach(element => {
        element.classList.add('tooltip');
    });
    
    // Celebration —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –Ω–∞–≥—Ä–∞–¥
    document.querySelectorAll('.reward-card').forEach(card => {
        card.addEventListener('click', function() {
            // –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏—è
            this.style.transform = 'scale(1.1)';
            setTimeout(() => {
                this.style.transform = 'scale(1)';
            }, 200);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            if (window.vpResults && window.vpResults.showNotification) {
                window.vpResults.showNotification('–ù–∞–≥—Ä–∞–¥–∞ –æ—Ç–º–µ—á–µ–Ω–∞! üèÜ', 'success');
            }
        });
    });
    
    console.log('‚úÖ Enhanced Virtual Patient Results initialized!');
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —á–∞—Å—Ç–∏—Ü (–µ—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
if (!document.querySelector('.particle')) {
    setTimeout(() => {
        const particleContainer = document.querySelector('.particle-container');
        if (particleContainer && !particleContainer.children.length) {
            for (let i = 0; i < 5; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 20}s`;
                particleContainer.appendChild(particle);
            }
        }
    }, 1000);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–ª—è graceful degradation
window.addEventListener('error', function(e) {
    console.warn('Non-critical error in VP Results:', e.message);
});
</script>

<!-- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π CSS –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ (inline) -->
<style>
/* –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø–æ–∫–∞–∑–∞ */
.scroll-reveal {
    opacity: 0;
    transform: translateY(30px);
    transition: all 800ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.scroll-reveal.revealed {
    opacity: 1;
    transform: translateY(0);
}

.fade-in {
    animation: fadeInUp 600ms ease-out forwards;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* –ü–ª–∞–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –Ω–∏–∑–∫–æ—Å–∫–æ—Ä–æ—Å—Ç–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π */
.metric-card, .reward-card {
    transition: all 0.3s ease;
}

.metric-card:hover, .reward-card:hover {
    transform: translateY(-4px);
}

/* –ë–∞–∑–æ–≤–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ */
.results-container {
    display: block;
}

@supports (display: grid) {
    .results-container {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 2rem;
    }
}

@media (max-width: 992px) {
    .results-container {
        display: block !important;
    }
    
    .results-sidebar {
        margin-top: 2rem;
    }
}
</style>
{% endblock %}