{% extends "admin/base_admin.html" %}

{% block title %}Загрузка контента по модулям{% endblock %}

{% block styles %}
{{ super() }}
<style>
  .content-uploader {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 2rem;
  }
  
  .structure-tree {
    max-height: 70vh;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    background: white;
  }
  
  .tree-item {
    margin-bottom: 1rem;
  }
  
  .path-section {
    border: 1px solid #e3f2fd;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    background: #fafafa;
  }
  
  .path-header {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    padding: 1rem;
    border-radius: 8px 8px 0 0;
    font-weight: 600;
  }
  
  .subject-section {
    border-left: 3px solid #4caf50;
    margin: 1rem;
    padding-left: 1rem;
  }
  
  .subject-header {
    color: #388e3c;
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .module-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
  }
  
  .module-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    border-color: #3498db;
  }
  
  .module-header {
    background: #f5f5f5;
    padding: 1rem;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: between;
    align-items: center;
  }
  
  .module-title {
    font-weight: 600;
    margin: 0;
    flex-grow: 1;
  }
  
  .module-status {
    display: flex;
    gap: 0.5rem;
  }
  
  .status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  
  .status-yes {
    background: #d4edda;
    color: #155724;
  }
  
  .status-no {
    background: #f8d7da;
    color: #721c24;
  }
  
  .module-body {
    padding: 1rem;
  }
  
  .upload-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }
  
  .upload-item {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
  }
  
  .upload-item:hover {
    border-color: #3498db;
    background: #f0f8ff;
  }
  
  .upload-item.has-file {
    border-color: #28a745;
    background: #d4edda;
  }
  
  .upload-item.has-error {
    border-color: #dc3545;
    background: #f8d7da;
  }
  
  .upload-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    color: #6c757d;
  }
  
  .upload-item.has-file .upload-icon {
    color: #28a745;
  }
  
  .upload-item.has-error .upload-icon {
    color: #dc3545;
  }
  
  .file-input {
    display: none;
  }
  
  .upload-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: end;
  }
  
  .bulk-actions {
    position: sticky;
    top: 0;
    background: white;
    padding: 1rem;
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 1rem;
    z-index: 10;
  }
  
  .progress-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
  }
  
  .summary-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
  }
  
  .summary-number {
    font-size: 2rem;
    font-weight: 700;
    color: #3498db;
  }
  
  .summary-label {
    color: #6c757d;
    font-size: 0.875rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Загрузка контента по модулям</h2>
    <div>
      <button type="button" class="btn btn-outline-success" id="upload-all-btn">
        <i class="bi bi-cloud-upload"></i> Загрузить все
      </button>
      <button type="button" class="btn btn-outline-primary" id="refresh-btn">
        <i class="bi bi-arrow-clockwise"></i> Обновить статус
      </button>
    </div>
  </div>
  
  <!-- Сводка по прогрессу -->
  <div class="progress-summary" id="progress-summary">
    <div class="summary-card">
      <div class="summary-number" id="total-modules">0</div>
      <div class="summary-label">Всего модулей</div>
    </div>
    <div class="summary-card">
      <div class="summary-number" id="modules-with-theory">0</div>
      <div class="summary-label">С теорией</div>
    </div>
    <div class="summary-card">
      <div class="summary-number" id="modules-with-tests">0</div>
      <div class="summary-label">С тестами</div>
    </div>
    <div class="summary-card">
      <div class="summary-number" id="complete-modules">0</div>
      <div class="summary-label">Полностью готовы</div>
    </div>
  </div>
  
  <!-- Основной контейнер с деревом структуры -->
  <div class="content-uploader">
    <div class="structure-tree" id="structure-tree">
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Загрузка...</span>
        </div>
        <p class="mt-2">Загрузка структуры модулей...</p>
      </div>
    </div>
  </div>
</div>

<!-- Глобальный индикатор загрузки -->
<div class="modal fade" id="uploadProgressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Загрузка файлов</h5>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div class="progress">
            <div class="progress-bar" id="upload-progress-bar" role="progressbar" style="width: 0%"></div>
          </div>
        </div>
        <div id="upload-status-text">Подготовка к загрузке...</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block body_scripts %}
{{ super() }}
<script>
const API_BASE_URL = '/{{ lang }}/admin/api';
const CSRF_TOKEN = document.querySelector('meta[name="csrf-token"]').content;

let modulesData = [];

// Инициализация страницы
document.addEventListener('DOMContentLoaded', function() {
  loadModulesStructure();
  
  // Обработчики кнопок
  document.getElementById('upload-all-btn').addEventListener('click', uploadAllModules);
  document.getElementById('refresh-btn').addEventListener('click', loadModulesStructure);
});

// Загрузка структуры модулей
function loadModulesStructure() {
  fetch(`${API_BASE_URL}/modules-structure`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        modulesData = data.data;
        renderModulesStructure();
        updateProgressSummary();
      } else {
        showError('Не удалось загрузить структуру модулей');
      }
    })
    .catch(error => {
      console.error('Error loading modules structure:', error);
      showError('Ошибка при загрузке структуры модулей');
    });
}

// Отрисовка структуры модулей
function renderModulesStructure() {
  const container = document.getElementById('structure-tree');
  
  let html = '';
  
  modulesData.forEach(path => {
    html += `
      <div class="path-section">
        <div class="path-header">
          <i class="bi bi-${path.icon} me-2"></i>
          ${path.name}
        </div>
        <div class="path-content">
    `;
    
    path.subjects.forEach(subject => {
      html += `
        <div class="subject-section">
          <div class="subject-header">
            <i class="bi bi-${subject.icon}"></i>
            <span>${subject.name}</span>
          </div>
      `;
      
      subject.modules.forEach(module => {
        html += renderModuleCard(module, path.id, subject.id);
      });
      
      html += `</div>`;
    });
    
    html += `
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  
  // Инициализируем обработчики событий для загрузки файлов
  initializeFileInputs();
}

// Отрисовка карточки модуля
function renderModuleCard(module, pathId, subjectId) {
  const hasTheory = module.has_theory || false;
  const hasTests = module.has_tests || false;
  
  return `
    <div class="module-card" data-module-id="${module.id}">
      <div class="module-header">
        <h5 class="module-title">${module.title}</h5>
        <div class="module-status">
          <span class="status-badge ${hasTheory ? 'status-yes' : 'status-no'}">
            <i class="bi bi-journal-text"></i> Теория
          </span>
          <span class="status-badge ${hasTests ? 'status-yes' : 'status-no'}">
            <i class="bi bi-question-circle"></i> Тесты
          </span>
        </div>
      </div>
      <div class="module-body">
        <div class="upload-group">
          <div class="upload-item ${hasTheory ? 'has-file' : ''}" onclick="triggerFileUpload('theory-${module.id}')">
            <div class="upload-icon">
              <i class="bi bi-journal-text"></i>
            </div>
            <div>
              <strong>Теория (Learning Cards)</strong><br>
              <small class="text-muted">Файл с флеш-карточками</small>
            </div>
            <input type="file" 
                   id="theory-${module.id}" 
                   class="file-input" 
                   accept=".json"
                   onchange="handleFileSelect(this, ${module.id}, 'theory')">
            ${hasTheory ? '<div class="mt-2"><i class="bi bi-check-circle text-success"></i> Загружен</div>' : ''}
          </div>
          
          <div class="upload-item ${hasTests ? 'has-file' : ''}" onclick="triggerFileUpload('tests-${module.id}')">
            <div class="upload-icon">
              <i class="bi bi-question-circle"></i>
            </div>
            <div>
              <strong>Тесты</strong><br>
              <small class="text-muted">Файл с вопросами и ответами</small>
            </div>
            <input type="file" 
                   id="tests-${module.id}" 
                   class="file-input" 
                   accept=".json"
                   onchange="handleFileSelect(this, ${module.id}, 'tests')">
            ${hasTests ? '<div class="mt-2"><i class="bi bi-check-circle text-success"></i> Загружен</div>' : ''}
          </div>
        </div>
        
        <div class="upload-actions">
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="previewModule(${module.id})">
            <i class="bi bi-eye"></i> Предпросмотр
          </button>
          <button type="button" class="btn btn-sm btn-primary" onclick="uploadModule(${module.id})">
            <i class="bi bi-cloud-upload"></i> Загрузить
          </button>
        </div>
      </div>
    </div>
  `;
}

// Инициализация обработчиков для файловых input'ов
function initializeFileInputs() {
  // Drag & Drop поддержка
  document.querySelectorAll('.upload-item').forEach(item => {
    item.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.style.borderColor = '#3498db';
      this.style.backgroundColor = '#f0f8ff';
    });
    
    item.addEventListener('dragleave', function(e) {
      e.preventDefault();
      this.style.borderColor = '#ddd';
      this.style.backgroundColor = '';
    });
    
    item.addEventListener('drop', function(e) {
      e.preventDefault();
      this.style.borderColor = '#ddd';
      this.style.backgroundColor = '';
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const fileInput = this.querySelector('.file-input');
        fileInput.files = files;
        fileInput.dispatchEvent(new Event('change'));
      }
    });
  });
}

// Активация загрузки файла
function triggerFileUpload(inputId) {
  document.getElementById(inputId).click();
}

// Обработка выбора файла
function handleFileSelect(input, moduleId, type) {
  const file = input.files[0];
  if (!file) return;
  
  // Проверяем тип файла
  if (!file.name.endsWith('.json')) {
    alert('Файл должен быть в формате JSON');
    input.value = '';
    return;
  }
  
  // Читаем и валидируем содержимое файла
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const content = JSON.parse(e.target.result);
      
      // Логируем содержимое для отладки
      console.log('Содержимое файла:', content);
      console.log('Тип файла:', type);
      
      // Валидируем структуру в зависимости от типа
      if (type === 'theory') {
        validateTheoryFile(content);
      } else if (type === 'tests') {
        validateTestsFile(content);
      }
      
      // Обновляем UI - показываем, что файл готов к загрузке
      const uploadItem = input.closest('.upload-item');
      uploadItem.classList.add('has-file');
      uploadItem.classList.remove('has-error');
      
      // Добавляем/обновляем информацию о файле
      let fileInfo = uploadItem.querySelector('.file-info');
      if (!fileInfo) {
        fileInfo = document.createElement('div');
        fileInfo.className = 'file-info mt-2';
        uploadItem.appendChild(fileInfo);
      }
      
      // ИСПРАВЛЕННЫЙ ПОДСЧЕТ ЭЛЕМЕНТОВ
      let itemCount = 0;
      if (type === 'theory') {
        // Считаем карточки с типом 'learning'
        itemCount = content.filter(item => item.type === 'learning').length;
      } else if (type === 'tests') {
        // Считаем вопросы с типом 'test'
        itemCount = content.filter(item => item.type === 'test').length;
      }
      
      fileInfo.innerHTML = `
        <small class="text-success">
          <i class="bi bi-file-earmark-check"></i> 
          ${file.name} (${itemCount} ${type === 'theory' ? 'карточек' : 'вопросов'})
        </small>
      `;
      
      console.log(`Файл ${file.name}: найдено ${itemCount} элементов типа ${type}`);
      
    } catch (error) {
      // Ошибка валидации - показываем подробную информацию
      const uploadItem = input.closest('.upload-item');
      uploadItem.classList.add('has-error');
      uploadItem.classList.remove('has-file');
      
      console.error('Ошибка при обработке файла:', error);
      alert('Ошибка в файле: ' + error.message);
      input.value = '';
    }
  };
  
  reader.readAsText(file);
}

function validateTheoryFile(content) {
    console.log('Validating theory file:', content);
    
    // Проверяем, что это массив
    if (!Array.isArray(content)) {
        throw new Error('Файл с теорией должен содержать массив карточек');
    }
    
    if (content.length === 0) {
        throw new Error('Массив карточек не может быть пустым');
    }
    
    // Проверяем каждую карточку
    content.forEach((card, index) => {
        if (typeof card !== 'object' || card === null) {
            throw new Error(`Карточка ${index + 1} должна быть объектом`);
        }
        
        // Проверяем обязательные поля
        const requiredFields = ['card_id', 'question', 'answer', 'module_title'];
        for (const field of requiredFields) {
            if (!card.hasOwnProperty(field)) {
                throw new Error(`Карточка ${index + 1} должна содержать поле "${field}"`);
            }
        }
        
        // Проверяем тип карточки
        if (card.type !== 'learning') {
            throw new Error(`Карточка ${index + 1} должна иметь тип "learning", найдено: "${card.type}"`);
        }
        
        // Проверяем, что question и answer не пустые
        if (typeof card.question !== 'string' || card.question.trim() === '') {
            throw new Error(`Карточка ${index + 1}: поле "question" должно быть непустой строкой`);
        }
        
        if (typeof card.answer !== 'string' || card.answer.trim() === '') {
            throw new Error(`Карточка ${index + 1}: поле "answer" должно быть непустой строкой`);
        }
        
        // Проверяем, что module_title не пустой
        if (typeof card.module_title !== 'string' || card.module_title.trim() === '') {
            throw new Error(`Карточка ${index + 1}: поле "module_title" должно быть непустой строкой`);
        }
    });
  
  console.log(`Валидация успешна: найдено ${content.length} карточек для изучения`);
}

function validateTestsFile(content) {
    console.log('Validating tests file:', content);
    
    // Проверяем, что это массив
    if (!Array.isArray(content)) {
        throw new Error('Файл с тестами должен содержать массив вопросов');
    }
    
    if (content.length === 0) {
        throw new Error('Массив вопросов не может быть пустым');
    }
    
    // Проверяем каждый вопрос
    content.forEach((question, index) => {
        if (typeof question !== 'object' || question === null) {
            throw new Error(`Вопрос ${index + 1} должен быть объектом`);
        }
        
        // Проверяем обязательные поля
        const requiredFields = ['card_id', 'question', 'answer', 'options', 'module_title'];
        for (const field of requiredFields) {
            if (!question.hasOwnProperty(field)) {
                throw new Error(`Вопрос ${index + 1} должен содержать поле "${field}"`);
            }
        }
    
    // Проверяем тип вопроса
    if (question.type !== 'test') {
      throw new Error(`Вопрос ${index + 1} должен иметь тип "test", найдено: "${question.type}"`);
    }
    
    // Проверяем поле question
    if (typeof question.question !== 'string' || question.question.trim() === '') {
      throw new Error(`Вопрос ${index + 1}: поле "question" должно быть непустой строкой`);
    }
    
    // Проверяем поле options
    if (!Array.isArray(question.options)) {
      throw new Error(`Вопрос ${index + 1}: поле "options" должно быть массивом`);
    }
    
    if (question.options.length < 2) {
      throw new Error(`Вопрос ${index + 1}: должно быть минимум 2 варианта ответа`);
    }
    
    // Проверяем каждый вариант ответа
    question.options.forEach((option, optionIndex) => {
      if (typeof option !== 'string' || option.trim() === '') {
        throw new Error(`Вопрос ${index + 1}, вариант ${optionIndex + 1}: должен быть непустой строкой`);
      }
    });
    
    // Проверяем поле answer (должно быть A, B, C, D)
    const validAnswers = ['A', 'B', 'C', 'D', 'E', 'F'];
    if (!validAnswers.includes(question.answer)) {
      throw new Error(`Вопрос ${index + 1}: поле "answer" должно быть одним из: ${validAnswers.join(', ')} (найдено: "${question.answer}")`);
    }
    
    // Проверяем, что ответ соответствует количеству опций
    const answerIndex = question.answer.charCodeAt(0) - 'A'.charCodeAt(0);
    if (answerIndex >= question.options.length) {
      throw new Error(`Вопрос ${index + 1}: ответ "${question.answer}" не соответствует количеству опций (${question.options.length})`);
    }
  });
  
  console.log(`Валидация успешна: найдено ${content.length} тестовых вопросов`);
}

// Загрузка отдельного модуля
function uploadModule(moduleId) {
  const theoryInput = document.getElementById(`theory-${moduleId}`);
  const testsInput = document.getElementById(`tests-${moduleId}`);
  
  const formData = new FormData();
  formData.append('module_id', moduleId);
  
  if (theoryInput.files[0]) {
    formData.append('theory_file', theoryInput.files[0]);
  }
  
  if (testsInput.files[0]) {
    formData.append('tests_file', testsInput.files[0]);
  }
  
  if (!theoryInput.files[0] && !testsInput.files[0]) {
    alert('Выберите хотя бы один файл для загрузки');
    return;
  }
  
  // Показываем прогресс загрузки
  const button = document.querySelector(`[onclick="uploadModule(${moduleId})"]`);
  const originalText = button.innerHTML;
  button.innerHTML = '<i class="bi bi-cloud-upload"></i> Загрузка...';
  button.disabled = true;
  
  fetch(`${API_BASE_URL}/upload-module-content`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': CSRF_TOKEN
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      let message = 'Модуль успешно обновлен';
      if (data.uploaded) {
        message += `\nТеория: ${data.uploaded.theory} карточек\nТесты: ${data.uploaded.tests} вопросов`;
      }
      alert(message);
      
      // Очищаем выбранные файлы
      theoryInput.value = '';
      testsInput.value = '';
      
      // Обновляем статус модуля в UI
      setTimeout(() => {
        loadModulesStructure();
      }, 500);
    } else {
      alert('Ошибка при загрузке: ' + (data.message || 'неизвестная ошибка'));
    }
  })
  .catch(error => {
    console.error('Error uploading module:', error);
    alert('Ошибка при загрузке модуля');
  })
  .finally(() => {
    button.innerHTML = originalText;
    button.disabled = false;
  });
}

// Предпросмотр содержимого модуля
function previewModule(moduleId) {
  // Открыть в новом окне страницу с предпросмотром содержимого модуля
  window.open(`${API_BASE_URL}/preview-module/${moduleId}`, '_blank');
}

// Массовая загрузка всех модулей
function uploadAllModules() {
  const modulesToUpload = [];
  
  // Собираем все модули, для которых выбраны файлы
  document.querySelectorAll('[data-module-id]').forEach(card => {
    const moduleId = card.dataset.moduleId;
    const theoryInput = document.getElementById(`theory-${moduleId}`);
    const testsInput = document.getElementById(`tests-${moduleId}`);
    
    if (theoryInput.files[0] || testsInput.files[0]) {
      modulesToUpload.push({
        id: moduleId,
        theoryFile: theoryInput.files[0],
        testsFile: testsInput.files[0]
      });
    }
  });
  
  if (modulesToUpload.length === 0) {
    alert('Не выбрано файлов для загрузки');
    return;
  }
  
  if (!confirm(`Загрузить ${modulesToUpload.length} модулей?`)) {
    return;
  }
  
  // Показываем модальное окно с прогрессом
  const modal = new bootstrap.Modal(document.getElementById('uploadProgressModal'));
  modal.show();
  
  // Загружаем модули по очереди
  uploadModulesSequentially(modulesToUpload, 0, modal);
}

// Последовательная загрузка модулей
function uploadModulesSequentially(modules, index, modal) {
  if (index >= modules.length) {
    // Все модули загружены
    document.getElementById('upload-status-text').textContent = 'Загрузка завершена!';
    setTimeout(() => {
      modal.hide();
      loadModulesStructure(); // Обновляем структуру
    }, 1500);
    return;
  }
  
  const module = modules[index];
  const progress = Math.round(((index + 1) / modules.length) * 100);
  
  // Обновляем прогресс
  document.getElementById('upload-progress-bar').style.width = progress + '%';
  document.getElementById('upload-status-text').textContent = 
    `Загрузка модуля ${index + 1} из ${modules.length}...`;
  
  // Подготавливаем данные для загрузки
  const formData = new FormData();
  formData.append('module_id', module.id);
  
  if (module.theoryFile) {
    formData.append('theory_file', module.theoryFile);
  }
  
  if (module.testsFile) {
    formData.append('tests_file', module.testsFile);
  }
  
  // Загружаем модуль
  fetch(`${API_BASE_URL}/upload-module-content`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': CSRF_TOKEN
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Продолжаем с следующим модулем
      uploadModulesSequentially(modules, index + 1, modal);
    } else {
      throw new Error(data.message || 'неизвестная ошибка');
    }
  })
  .catch(error => {
    console.error('Error uploading module:', error);
    document.getElementById('upload-status-text').textContent = 
      `Ошибка при загрузке модуля ${index + 1}: ${error.message}`;
    
    setTimeout(() => modal.hide(), 2000);
  });
}

// Обновление сводки прогресса
function updateProgressSummary() {
  let totalModules = 0;
  let modulesWithTheory = 0;
  let modulesWithTests = 0;
  let completeModules = 0;
  
  modulesData.forEach(path => {
    path.subjects.forEach(subject => {
      subject.modules.forEach(module => {
        totalModules++;
        if (module.has_theory) modulesWithTheory++;
        if (module.has_tests) modulesWithTests++;
        if (module.has_theory && module.has_tests) completeModules++;
      });
    });
  });
  
  document.getElementById('total-modules').textContent = totalModules;
  document.getElementById('modules-with-theory').textContent = modulesWithTheory;
  document.getElementById('modules-with-tests').textContent = modulesWithTests;
  document.getElementById('complete-modules').textContent = completeModules;
}

// Показ ошибки
function showError(message) {
  alert(message);
}
</script>
{% endblock %}