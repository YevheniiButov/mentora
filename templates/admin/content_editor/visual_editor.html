{% extends "admin/base_admin.html" %}

{% block title %}Visual Editor{% endblock %}
{% block page_title %}Visual Editor{% endblock %}

{% block styles %}
<style>
.editor-container {
    height: calc(100vh - 200px);
    display: flex;
    flex-direction: column;
}

.editor-toolbar {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-bottom: none;
    padding: 10px;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.editor-main {
    flex: 1;
    display: flex;
    border: 1px solid #dee2e6;
}

.editor-sidebar {
    width: 300px;
    background: #f8f9fa;
    border-right: 1px solid #dee2e6;
    overflow-y: auto;
}

.editor-content {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.editor-workspace {
    flex: 1;
    background: white;
    overflow-y: auto;
    padding: 20px;
}

.editor-preview {
    flex: 1;
    background: white;
    overflow-y: auto;
    padding: 20px;
    border-left: 1px solid #dee2e6;
}

.editor-tab {
    padding: 10px 20px;
    background: #e9ecef;
    border: none;
    cursor: pointer;
}

.editor-tab.active {
    background: white;
    border-bottom: 2px solid #3ECDC1;
}

.component-palette {
    padding: 15px;
}

.component-item {
    padding: 10px;
    margin: 5px 0;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.component-item:hover {
    background: #e9ecef;
    border-color: #3ECDC1;
}

.properties-panel {
    padding: 15px;
}

.property-group {
    margin-bottom: 15px;
}

.property-group h6 {
    color: #6c757d;
    font-size: 0.875rem;
    margin-bottom: 8px;
}

.workspace-area {
    min-height: 500px;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin: 10px;
    transition: all 0.2s;
}

.workspace-area.drag-over {
    border-color: #3ECDC1;
    background: #f0f9ff;
}

.content-block {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 15px;
    margin: 10px 0;
    position: relative;
    cursor: move;
}

.content-block:hover {
    border-color: #3ECDC1;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.content-block.selected {
    border-color: #3ECDC1;
    box-shadow: 0 0 0 2px rgba(62, 205, 193, 0.2);
}

.block-actions {
    position: absolute;
    top: 5px;
    right: 5px;
    display: none;
}

.content-block:hover .block-actions {
    display: block;
}

.block-actions .btn {
    padding: 2px 6px;
    font-size: 0.75rem;
}

.autosave-indicator {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.875rem;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s;
}

.autosave-indicator.show {
    opacity: 1;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Breadcrumbs -->
    <nav aria-label="breadcrumb" class="px-4 py-3 bg-light border-bottom">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <a href="{{ url_for('admin_bp.dashboard', lang=lang) }}" class="btn btn-secondary">
                    <i class="bi bi-house"></i> Dashboard
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('content_editor.dashboard', lang=lang) }}">Content Editor</a>
            </li>
            <li class="breadcrumb-item active">Visual Editor</li>
        </ol>
    </nav>

    <!-- Editor Toolbar -->
    <div class="editor-toolbar">
        <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" onclick="saveContent()">
                <i class="bi bi-save"></i> Сохранить
            </button>
            <button class="btn btn-outline-success btn-sm" onclick="publishContent()">
                <i class="bi bi-check-circle"></i> Опубликовать
            </button>
            <button class="btn btn-outline-info btn-sm" onclick="previewContent()">
                <i class="bi bi-eye"></i> Предпросмотр
            </button>
        </div>
        
        <div class="ms-auto d-flex align-items-center gap-2">
            <select class="form-select form-select-sm" style="width: auto;" id="templateSelect">
                <option value="">Выберите шаблон</option>
                {% for template in templates %}
                <option value="{{ template.id }}">{{ template.name }}</option>
                {% endfor %}
            </select>
            
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autosaveToggle" checked>
                <label class="form-check-label" for="autosaveToggle">Автосохранение</label>
            </div>
        </div>
    </div>

    <!-- Main Editor -->
    <div class="editor-main">
        <!-- Sidebar -->
        <div class="editor-sidebar">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#components" type="button">
                        <i class="bi bi-puzzle"></i> Компоненты
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#properties" type="button">
                        <i class="bi bi-gear"></i> Свойства
                    </button>
                </li>
            </ul>
            
            <div class="tab-content">
                <!-- Components Tab -->
                <div class="tab-pane fade show active" id="components">
                    <div class="component-palette">
                        <h6 class="mb-3">Доступные компоненты</h6>
                        
                        <div class="component-item" draggable="true" data-component="text">
                            <i class="bi bi-text-paragraph me-2"></i>
                            <strong>Текстовый блок</strong>
                            <small class="d-block text-muted">Обычный текст с форматированием</small>
                        </div>
                        
                        <div class="component-item" draggable="true" data-component="image">
                            <i class="bi bi-image me-2"></i>
                            <strong>Изображение</strong>
                            <small class="d-block text-muted">Загрузка и отображение изображений</small>
                        </div>
                        
                        <div class="component-item" draggable="true" data-component="video">
                            <i class="bi bi-play-circle me-2"></i>
                            <strong>Видео</strong>
                            <small class="d-block text-muted">Встраивание видео контента</small>
                        </div>
                        
                        <div class="component-item" draggable="true" data-component="quiz">
                            <i class="bi bi-question-circle me-2"></i>
                            <strong>Тест</strong>
                            <small class="d-block text-muted">Интерактивные вопросы</small>
                        </div>
                        
                        <div class="component-item" draggable="true" data-component="table">
                            <i class="bi bi-table me-2"></i>
                            <strong>Таблица</strong>
                            <small class="d-block text-muted">Структурированные данные</small>
                        </div>
                        
                        <div class="component-item" draggable="true" data-component="code">
                            <i class="bi bi-code-slash me-2"></i>
                            <strong>Код</strong>
                            <small class="d-block text-muted">Блоки кода с подсветкой</small>
                        </div>
                    </div>
                </div>
                
                <!-- Properties Tab -->
                <div class="tab-pane fade" id="properties">
                    <div class="properties-panel">
                        <h6 class="mb-3">Свойства страницы</h6>
                        
                        <div class="property-group">
                            <label class="form-label">Заголовок</label>
                            <input type="text" class="form-control" id="pageTitle" value="{{ page.title|default('') }}">
                        </div>
                        
                        <div class="property-group">
                            <label class="form-label">Статус</label>
                            <select class="form-select" id="pageStatus">
                                <option value="draft" {{ 'selected' if page.status == 'draft' else '' }}>Черновик</option>
                                <option value="published" {{ 'selected' if page.status == 'published' else '' }}>Опубликовано</option>
                            </select>
                        </div>
                        
                        <div class="property-group">
                            <label class="form-label">Язык</label>
                            <select class="form-select" id="pageLanguage">
                                <option value="en" {{ 'selected' if page.language == 'en' else '' }}>English</option>
                                <option value="ru" {{ 'selected' if page.language == 'ru' else '' }}>Русский</option>
                                <option value="nl" {{ 'selected' if page.language == 'nl' else '' }}>Nederlands</option>
                            </select>
                        </div>
                        
                        <div class="property-group">
                            <label class="form-label">Метаданные</label>
                            <textarea class="form-control" id="pageMetadata" rows="3" placeholder="JSON метаданные">{{ page.page_metadata|default('{}') }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Content Area -->
        <div class="editor-content">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#workspace" type="button">
                        <i class="bi bi-pencil"></i> Редактор
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#preview" type="button">
                        <i class="bi bi-eye"></i> Предпросмотр
                    </button>
                </li>
            </ul>
            
            <div class="tab-content">
                <!-- Workspace Tab -->
                <div class="tab-pane fade show active" id="workspace">
                    <div class="editor-workspace">
                        <div class="workspace-area" id="workspaceArea">
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-arrow-down-circle fs-1"></i>
                                <p class="mt-3">Перетащите компоненты сюда для создания контента</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Preview Tab -->
                <div class="tab-pane fade" id="preview">
                    <div class="editor-preview" id="previewArea">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-eye fs-1"></i>
                            <p class="mt-3">Предпросмотр будет доступен после добавления контента</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Autosave Indicator -->
<div class="autosave-indicator" id="autosaveIndicator">
    <i class="bi bi-check-circle me-2"></i>Автосохранение выполнено
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPageId = {{ page.id|default('null') }};
let autosaveInterval;
let contentData = {{ page.content_data|default('{}')|safe }};

// Drag and Drop functionality
document.addEventListener('DOMContentLoaded', function() {
    const workspaceArea = document.getElementById('workspaceArea');
    const componentItems = document.querySelectorAll('.component-item');
    
    // Drag start
    componentItems.forEach(item => {
        item.addEventListener('dragstart', function(e) {
            e.dataTransfer.setData('text/plain', this.dataset.component);
        });
    });
    
    // Drag over
    workspaceArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('drag-over');
    });
    
    // Drag leave
    workspaceArea.addEventListener('dragleave', function(e) {
        this.classList.remove('drag-over');
    });
    
    // Drop
    workspaceArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        
        const componentType = e.dataTransfer.getData('text/plain');
        addComponent(componentType);
    });
    
    // Initialize autosave
    if (document.getElementById('autosaveToggle').checked) {
        startAutosave();
    }
    
    // Load existing content
    loadExistingContent();
});

function addComponent(type) {
    const workspaceArea = document.getElementById('workspaceArea');
    const componentId = 'component_' + Date.now();
    
    let componentHtml = '';
    switch(type) {
        case 'text':
            componentHtml = `
                <div class="content-block" data-component-id="${componentId}" data-type="text">
                    <div class="block-actions">
                        <button class="btn btn-sm btn-outline-danger" onclick="removeComponent('${componentId}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div contenteditable="true" class="component-content">
                        <p>Введите текст здесь...</p>
                    </div>
                </div>
            `;
            break;
        case 'image':
            componentHtml = `
                <div class="content-block" data-component-id="${componentId}" data-type="image">
                    <div class="block-actions">
                        <button class="btn btn-sm btn-outline-danger" onclick="removeComponent('${componentId}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="component-content">
                        <div class="text-center p-4 border border-dashed">
                            <i class="bi bi-image fs-1 text-muted"></i>
                            <p class="mt-2">Перетащите изображение сюда или кликните для загрузки</p>
                            <input type="file" class="d-none" accept="image/*" onchange="handleImageUpload(this, '${componentId}')">
                        </div>
                    </div>
                </div>
            `;
            break;
        // Add more component types here
    }
    
    workspaceArea.insertAdjacentHTML('beforeend', componentHtml);
    
    // Clear placeholder if it's the first component
    const placeholder = workspaceArea.querySelector('.text-center.text-muted');
    if (placeholder) {
        placeholder.remove();
    }
    
    // Update content data
    updateContentData();
}

function removeComponent(componentId) {
    const component = document.querySelector(`[data-component-id="${componentId}"]`);
    if (component) {
        component.remove();
        updateContentData();
    }
}

function updateContentData() {
    const components = document.querySelectorAll('.content-block');
    contentData = {
        components: []
    };
    
    components.forEach(component => {
        const componentData = {
            id: component.dataset.componentId,
            type: component.dataset.type,
            content: component.querySelector('.component-content').innerHTML
        };
        contentData.components.push(componentData);
    });
}

function loadExistingContent() {
    if (contentData && contentData.components) {
        contentData.components.forEach(component => {
            addComponent(component.type);
        });
    }
}

function saveContent() {
    updateContentData();
    
    const saveData = {
        page_id: currentPageId,
        title: document.getElementById('pageTitle').value,
        content_data: contentData,
        status: document.getElementById('pageStatus').value,
        language: document.getElementById('pageLanguage').value,
        metadata: document.getElementById('pageMetadata').value
    };
    
    fetch('{{ url_for("content_editor.save_content", lang=lang) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify(saveData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Контент сохранен успешно', 'success');
            if (data.page_id) {
                currentPageId = data.page_id;
            }
        } else {
            showNotification('Ошибка сохранения: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Ошибка сохранения', 'error');
    });
}

function publishContent() {
    document.getElementById('pageStatus').value = 'published';
    saveContent();
}

function previewContent() {
    updateContentData();
    
    const previewData = {
        content_data: JSON.stringify(contentData)
    };
    
    fetch('{{ url_for("content_editor.preview_content", lang=lang) }}?' + new URLSearchParams(previewData))
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('previewArea').innerHTML = data.preview_html;
        } else {
            showNotification('Ошибка предпросмотра: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Ошибка предпросмотра', 'error');
    });
}

function startAutosave() {
    autosaveInterval = setInterval(() => {
        if (document.getElementById('autosaveToggle').checked) {
            updateContentData();
            autosaveContent();
        }
    }, 30000); // Autosave every 30 seconds
}

function autosaveContent() {
    if (!currentPageId) return;
    
    const saveData = {
        page_id: currentPageId,
        content_data: contentData,
        metadata: document.getElementById('pageMetadata').value
    };
    
    fetch('{{ url_for("content_editor.autosave_content", lang=lang) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify(saveData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAutosaveIndicator();
        }
    })
    .catch(error => {
        console.error('Autosave error:', error);
    });
}

function showAutosaveIndicator() {
    const indicator = document.getElementById('autosaveIndicator');
    indicator.classList.add('show');
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 2000);
}

function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Event listeners
document.getElementById('autosaveToggle').addEventListener('change', function() {
    if (this.checked) {
        startAutosave();
    } else {
        clearInterval(autosaveInterval);
    }
});

// Save on page unload
window.addEventListener('beforeunload', function() {
    if (document.getElementById('autosaveToggle').checked) {
        autosaveContent();
    }
});
</script>
{% endblock %} 