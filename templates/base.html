<!DOCTYPE html>
<html lang="{{ lang }}" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}{% endblock %} - Dental Academy</title>
  <meta name="description" content="{% block meta_description %}Платформа для подготовки к BIG экзамену для стоматологов в Нидерландах.{% endblock %}">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#3ECDC1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Dental Academy">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/icon-192.png') }}">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

  <!-- Favicon -->
  <link rel="icon" href="{{ url_for('static', filename='favicon.png') }}" />
  
  <!-- Preconnect for Performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Flag Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@6.6.6/css/flag-icons.min.css" />

  <!-- ПРАВИЛЬНЫЙ ПОРЯДОК: СНАЧАЛА ТЕМЫ, ПОТОМ УНИВЕРСАЛЬНЫЕ СТИЛИ -->
  
  <!-- 1. СИСТЕМА ТЕМ (базовые переменные) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/themes/themes.css') }}">
  
  <!-- 2. Основные стили -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/unified-theme.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  
  <!-- 3. Универсальные стили из index.html (используют переменные тем) -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/universal-styles.css') }}">
  
  <!-- 4. Универсальная система лейаутов -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/universal-layout-system.css') }}">
  
  <!-- Page-specific styles -->
  {% block page_styles %}{% endblock %}
  {% block styles %}{% endblock %}
  {% block extra_css %}{% endblock %}
</head>
<body class="modern-app {% if request.endpoint == 'learning_map_bp.learning_map' %}learning-map-page{% endif %}">
  <!-- HEADER INCLUDE -->
  {% include 'includes/_header.html' %}

  <!-- Flash Messages Container -->
  <div class="flash-container" id="flash-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash-message alert alert-{{ 'danger' if category == 'error' else category }}" 
               data-category="{{ category }}" role="alert">
            <div class="flash-content">
              <div class="flash-icon">
                {% if category == 'success' %}
                  <i class="bi bi-check-circle-fill"></i>
                {% elif category == 'error' or category == 'danger' %}
                  <i class="bi bi-exclamation-triangle-fill"></i>
                {% elif category == 'warning' %}
                  <i class="bi bi-exclamation-circle-fill"></i>
                {% else %}
                  <i class="bi bi-info-circle-fill"></i>
                {% endif %}
              </div>
              <div class="flash-text">{{ message }}</div>
              <button type="button" class="flash-close" onclick="this.parentElement.parentElement.remove()">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  <!-- Main Content -->
  <main class="main-content">
    {% block content %}{% endblock %}
  </main>
  


  <!-- FOOTER INCLUDE -->
  {% include 'includes/_footer.html' %}

  <!-- Loading Indicator -->
  <div class="loading-indicator" id="loading-indicator">
    <div class="loading-spinner">
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- React (for existing components) -->
  <script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>

  <!-- Theme Controller -->
  <script src="{{ url_for('static', filename='js/theme-controller.js') }}"></script>

  <!-- Glass Effects для стеклянной темы -->
  <script src="{{ url_for('static', filename='js/glass-effects.js') }}"></script>

  <!-- Legacy JS -->
  <script src="{{ url_for('static', filename='js/simple-counters.js') }}"></script>
  <script src="{{ url_for('static', filename='js/modern_flash_messages.js') }}"></script>
  <script src="{{ url_for('static', filename='js/api.js') }}"></script>
  
  <!-- Универсальные скрипты из index.html -->
  <script src="{{ url_for('static', filename='js/universal-scripts.js') }}"></script>

  <!-- Global Application Scripts -->
  <script>
    // Global App Configuration
    window.AppConfig = {
      currentLanguage: '{{ g.lang }}',
      isAuthenticated: "{{ 'true' if current_user.is_authenticated else 'false' }}",
      userId: "{{ current_user.id if current_user.is_authenticated else 'null' }}",
      csrfToken: '{{ csrf_token() }}',
      apiBaseUrl: '/api'
    };

    // Flash Messages System
    class FlashMessagesSystem {
      constructor() {
        this.container = document.getElementById('flash-container');
        this.init();
      }

      init() {
        if (!this.container) return;
        
        // Auto-hide flash messages after 5 seconds
        const messages = this.container.querySelectorAll('.flash-message');
        messages.forEach(message => {
          setTimeout(() => {
            message.classList.add('fade-out');
            setTimeout(() => message.remove(), 300);
          }, 5000);
        });
      }
    }

    // Initialize systems when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      new FlashMessagesSystem();
    });
  </script>

  <!-- Page-specific scripts -->
  {% block page_scripts %}{% endblock %}
  {% block scripts %}{% endblock %}
  {% block body_scripts %}{% endblock %}
</body>
</html>

<style>
/* ===== ИСПРАВЛЕННЫЕ БАЗОВЫЕ СТИЛИ ПРИЛОЖЕНИЯ ===== */
.modern-app {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background-color: var(--bg-primary);
  color: var(--text-primary);
  transition: all var(--transition-slow);
  min-height: 100vh;
  overflow-x: hidden;
  padding-top: 0 !important;
  margin: 0;
}

.modern-app.loaded {
  animation: fadeIn 0.5s ease-out;
}

.modern-app.loading {
  overflow: hidden;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* ===== КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ ДЛЯ MAIN-CONTENT ===== */
.main-content {
  /* УБИРАЕМ ВСЕ ОГРАНИЧЕНИЯ */
  margin-top: 0 !important;
  min-height: auto !important;
  max-height: none !important;
  height: auto !important;
  padding-top: 0 !important;
  overflow: visible !important;
  position: relative;
  z-index: 1;
}

/* Только hero-section получает padding-top для отступа от header */
.main-content .hero-section {
  padding-top: var(--header-height, 70px) !important;
  margin-top: 0 !important;
}

/* Все остальные секции НЕ должны иметь отступов */
.main-content section:not(.hero-section) {
  margin-top: 0 !important;
  padding-top: 0 !important;
  position: relative;
  z-index: 1;
  display: block !important;
  opacity: 1 !important;
  height: auto !important;
  max-height: none !important;
  overflow: visible !important;
}

/* Обеспечиваем видимость всех контейнеров */
.container, .container-fluid {
  position: relative;
  z-index: 1;
  display: block !important;
  height: auto !important;
  min-height: auto !important;
  max-height: none !important;
  overflow: visible !important;
}

/* Убираем верхний отступ для страницы карты обучения */
.learning-map-page .main-content {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

/* ===== FLASH MESSAGES ===== */
.flash-container {
  position: fixed;
  top: calc(var(--header-height, 70px) + 20px); /* Позиционируем относительно шапки */
  right: 20px;
  z-index: 1050;
  max-width: 400px;
  pointer-events: none;
}

.flash-message {
  pointer-events: auto;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xl);
  margin-bottom: 1rem;
  opacity: 0;
  transform: translateX(100%);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(20px);
  overflow: hidden;
}

.flash-message.show {
  opacity: 1;
  transform: translateX(0);
}

.flash-message.hiding {
  opacity: 0;
  transform: translateX(100%);
}

.flash-content {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  padding: 1rem;
}

.flash-icon {
  flex-shrink: 0;
  font-size: 1.25rem;
  margin-top: 0.125rem;
}

.flash-text {
  flex: 1;
  font-weight: 500;
  line-height: 1.4;
}

.flash-close {
  flex-shrink: 0;
  background: none;
  border: none;
  color: var(--text-tertiary);
  font-size: 1.25rem;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all var(--transition-normal);
}

.flash-close:hover {
  background: var(--glass-bg);
  color: var(--text-primary);
}

/* Flash message types */
.flash-message.alert-success {
  border-left: 4px solid var(--success-color);
}

.flash-message.alert-success .flash-icon {
  color: var(--success-color);
}

.flash-message.alert-danger,
.flash-message.alert-error {
  border-left: 4px solid var(--danger-color);
}

.flash-message.alert-danger .flash-icon,
.flash-message.alert-error .flash-icon {
  color: var(--danger-color);
}

.flash-message.alert-warning {
  border-left: 4px solid var(--warning-color);
}

.flash-message.alert-warning .flash-icon {
  color: var(--warning-color);
}

.flash-message.alert-info {
  border-left: 4px solid var(--info-color);
}

.flash-message.alert-info .flash-icon {
  color: var(--info-color);
}

/* ===== LOADING INDICATOR ===== */
.loading-indicator {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(5px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.loading-indicator.active {
  opacity: 1;
  visibility: visible;
}

.loading-spinner {
  position: relative;
  width: 60px;
  height: 60px;
}

.spinner-ring {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border: 3px solid transparent;
  border-top: 3px solid var(--primary-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.spinner-ring:nth-child(2) {
  animation-delay: 0.1s;
  border-top-color: var(--secondary-color);
}

.spinner-ring:nth-child(3) {
  animation-delay: 0.2s;
  border-top-color: var(--accent-color);
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ===== RESPONSIVE DESIGN ===== */
@media (max-width: 768px) {
  .flash-container {
    left: 15px;
    right: 15px;
    top: calc(var(--header-mobile-height, 60px) + 15px);
    max-width: none;
  }

  .flash-content {
    padding: 0.75rem;
    gap: 0.5rem;
  }

  .flash-icon {
    font-size: 1.1rem;
  }

  .flash-text {
    font-size: 0.9rem;
  }
  
  .main-content {
    margin-top: var(--header-mobile-height, 60px);
    min-height: calc(100vh - var(--header-mobile-height, 60px));
  }
}

/* ===== ACCESSIBILITY ===== */
@media (prefers-reduced-motion: reduce) {
  .flash-message {
    transition: none;
  }
  
  .loading-indicator {
    transition: none;
  }
  
  .spinner-ring {
    animation: none;
  }
  
  .modern-app.loaded {
    animation: none;
  }
}

/* ===== HIGH CONTRAST MODE ===== */
@media (prefers-contrast: high) {
  .flash-message {
    border-width: 2px;
  }
  
  .flash-close:hover {
    background: var(--text-primary);
    color: var(--bg-primary);
  }
}

/* ===== PRINT STYLES ===== */
@media print {
  .flash-container,
  .loading-indicator,
  .modern-header {
    display: none !important;
  }
  
  .main-content {
    margin-top: 0 !important;
  }
}
</style>