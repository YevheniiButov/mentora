{% extends "mobile_base.html" %}

{% block title %}{{ lesson.title }} - {{ t('dental_academy', lang) }}{% endblock %}

{% block head_extra %}
<!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–∞-—Ç–µ–≥–∏ –¥–ª—è —É—Ä–æ–∫–æ–≤ -->
<meta name="description" content="{{ lesson.description or t('learn_dentistry', lang) }}">
<meta property="og:title" content="{{ lesson.title }}">
<meta property="og:description" content="{{ lesson.description or t('learn_dentistry', lang) }}">
{% endblock %}

{% block body_start %}
<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –¥–ª—è —É—Ä–æ–∫–∞ -->
{% set breadcrumbs = [
    {'title': 'learning', 'url': url_for('mobile.learning_map', lang=lang)},
    {'title': lesson.module.subject.name if lesson.module and lesson.module.subject else 'subject', 'url': url_for('mobile.subject_view', lang=lang, subject_id=lesson.module.subject_id) if lesson.module else '#'},
    {'title': lesson.title, 'url': None}
] %}

{% set progress_data = {
    'current': current_section or 1,
    'total': total_sections or 1,
    'percentage': ((current_section or 1) / (total_sections or 1) * 100) | round
} %}

{% set nav_config = get_navigation_config('lesson',
    breadcrumbs=breadcrumbs,
    show_back_button=True,
    show_progress=True,
    progress_data=progress_data,
    show_bottom_nav=True
) %}
{% endblock %}

{% block content %}
<div class="lesson-container">
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —É—Ä–æ–∫–∞ -->
    <div class="lesson-content">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–∫–∞ -->
        <div class="lesson-header">
            <h1 class="lesson-title">{{ lesson.title }}</h1>
            
            <div class="lesson-meta">
                <span class="meta-item">
                    <i class="bi bi-clock"></i>
                    {{ lesson.estimated_time or t('15_min', lang) or '15 –º–∏–Ω' }}
                </span>
                <span class="meta-item">
                    <i class="bi bi-bar-chart"></i>
                    {{ lesson.difficulty or t('medium', lang) or '–°—Ä–µ–¥–Ω–∏–π' }}
                </span>
                {% if lesson.views %}
                <span class="meta-item">
                    <i class="bi bi-eye"></i>
                    {{ lesson.views }}
                </span>
                {% endif %}
            </div>
            
            {% if lesson.description %}
            <p class="lesson-description">{{ lesson.description }}</p>
            {% endif %}
        </div>

        <!-- –¢–µ–ª–æ —É—Ä–æ–∫–∞ -->
        <div class="lesson-body" id="lessonBody">
            {% if lesson.content %}
                {{ lesson.content | safe }}
            {% else %}
                <div class="lesson-highlight">
                    <h3>ü¶∑ {{ t('welcome_to_lesson', lang) or '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —É—Ä–æ–∫!' }}</h3>
                    <p>{{ t('lesson_intro_text', lang) or '–≠—Ç–æ—Ç —É—Ä–æ–∫ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –∏–∑—É—á–∏—Ç—å –æ—Å–Ω–æ–≤—ã —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏–∏. –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–π—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è.' }}</p>
                </div>

                <h2>{{ t('basic_concepts', lang) or '–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è' }}</h2>
                <p>{{ t('concepts_intro', lang) or '–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –º—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–∏–º –∫–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–Ω–∞—Ç—å –∫–∞–∂–¥–æ–º—É —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥—É.' }}</p>

                <div class="lesson-note">
                    <strong>üí° {{ t('important', lang) or '–í–∞–∂–Ω–æ' }}:</strong> {{ t('practical_attention', lang) or '–û–±—Ä–∞—Ç–∏—Ç–µ –æ—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑—É—á–µ–Ω–Ω–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞.' }}
                </div>

                <h3>{{ t('practical_recommendations', lang) or '–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏' }}</h3>
                <ul>
                    <li>{{ t('follow_aseptic_rules', lang) or '–í—Å–µ–≥–¥–∞ —Å–æ–±–ª—é–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –∞—Å–µ–ø—Ç–∏–∫–∏ –∏ –∞–Ω—Ç–∏—Å–µ–ø—Ç–∏–∫–∏' }}</li>
                    <li>{{ t('use_quality_materials', lang) or '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã' }}</li>
                    <li>{{ t('keep_detailed_docs', lang) or '–í–µ–¥–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é' }}</li>
                    <li>{{ t('continuous_learning', lang) or '–ü–æ—Å—Ç–æ—è–Ω–Ω–æ –ø–æ–≤—ã—à–∞–π—Ç–µ —Å–≤–æ—é –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏—é' }}</li>
                </ul>

                <div class="lesson-warning">
                    <strong>‚ö†Ô∏è {{ t('attention', lang) or '–í–Ω–∏–º–∞–Ω–∏–µ' }}:</strong> {{ t('educational_only', lang) or '–î–∞–Ω–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª–µ–π –∏ –Ω–µ –∑–∞–º–µ–Ω—è–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—É—é –º–µ–¥–∏—Ü–∏–Ω—Å–∫—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.' }}
                </div>

                <h3>{{ t('conclusion', lang) or '–ó–∞–∫–ª—é—á–µ–Ω–∏–µ' }}</h3>
                <p>{{ t('continuous_practice', lang) or '–ò–∑—É—á–µ–Ω–∏–µ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏–∏ —Ç—Ä–µ–±—É–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–Ω–∞–Ω–∏–π. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∏–∑—É—á–∞—Ç—å –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥–∏–∫–∏ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –≤ –æ–±–ª–∞—Å—Ç–∏ —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏–∏.' }}</p>
            {% endif %}
        </div>
    </div>

    <!-- –ü–ª–∞–≤–∞—é—â–∏–µ –∫–Ω–æ–ø–∫–∏ -->
    <div class="floating-actions">
        <button class="floating-btn" onclick="toggleNotes()" title="{{ t('notes', lang) or '–ó–∞–º–µ—Ç–∫–∏' }}">
            <i class="bi bi-journal-text"></i>
        </button>
        <button class="floating-btn" onclick="openAIAssistant()" title="{{ t('ai_assistant', lang) or 'AI –ø–æ–º–æ—â–Ω–∏–∫' }}">
            <i class="bi bi-robot"></i>
        </button>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —É—Ä–æ–∫–∞–º -->
    <nav class="lesson-navigation">
        <button class="nav-btn secondary" id="prevBtn" onclick="previousLesson()" 
                {% if not previous_lesson %}disabled{% endif %}>
            <i class="bi bi-chevron-left"></i>
            {{ t('back', lang) or '–ù–∞–∑–∞–¥' }}
        </button>
        
        <div class="lesson-actions">
            <button class="action-btn" onclick="toggleBookmark()" title="{{ t('bookmark', lang) or '–ó–∞–∫–ª–∞–¥–∫–∞' }}">
                <i class="bi bi-bookmark"></i>
            </button>
            <button class="action-btn" onclick="shareLesson()" title="{{ t('share', lang) or '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è' }}">
                <i class="bi bi-share"></i>
            </button>
            <button class="action-btn" onclick="openAIAssistant()" title="{{ t('ai_assistant', lang) or 'AI –ø–æ–º–æ—â–Ω–∏–∫' }}">
                <i class="bi bi-robot"></i>
            </button>
        </div>
        
        <button class="nav-btn" id="nextBtn" onclick="nextLesson()">
            {% if next_lesson %}
                {{ t('next', lang) or '–î–∞–ª–µ–µ' }}
                <i class="bi bi-chevron-right"></i>
            {% else %}
                {{ t('complete', lang) or '–ó–∞–≤–µ—Ä—à–∏—Ç—å' }}
                <i class="bi bi-check-circle"></i>
            {% endif %}
        </button>
    </nav>
</div>
{% endblock %}

{% block styles_extra %}
<style>
/* ===== LESSON SPECIFIC STYLES ===== */
.lesson-container {
    padding-bottom: 100px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ —É—Ä–æ–∫–∞ */
}

.lesson-content {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: var(--border-radius, 12px);
    margin: 1rem;
    padding: 2rem 1.5rem;
    min-height: calc(100vh - 200px);
}

.lesson-header {
    margin-bottom: 2rem;
    text-align: center;
}

.lesson-title {
    color: white;
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
    line-height: 1.3;
}

.lesson-meta {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.meta-item {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.85rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.lesson-description {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
    line-height: 1.5;
    text-align: center;
    margin-bottom: 0;
}

/* ===== LESSON BODY ===== */
.lesson-body {
    color: white;
    line-height: 1.6;
}

.lesson-body h1,
.lesson-body h2,
.lesson-body h3,
.lesson-body h4 {
    color: white;
    margin: 2rem 0 1rem;
    font-weight: 600;
}

.lesson-body h1 { font-size: 1.5rem; }
.lesson-body h2 { font-size: 1.3rem; }
.lesson-body h3 { font-size: 1.1rem; }
.lesson-body h4 { font-size: 1rem; }

.lesson-body p {
    margin-bottom: 1.5rem;
    color: rgba(255, 255, 255, 0.9);
}

.lesson-body ul,
.lesson-body ol {
    margin: 1rem 0 1.5rem 1.5rem;
    color: rgba(255, 255, 255, 0.9);
}

.lesson-body li {
    margin-bottom: 0.5rem;
}

.lesson-body img {
    width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 1.5rem 0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.lesson-highlight {
    background: rgba(62, 205, 193, 0.1);
    border: 1px solid rgba(62, 205, 193, 0.3);
    border-radius: 8px;
    padding: 1.5rem;
    margin: 1.5rem 0;
}

.lesson-note {
    background: rgba(59, 130, 246, 0.1);
    border-left: 4px solid #3b82f6;
    padding: 1rem 1.5rem;
    margin: 1.5rem 0;
    border-radius: 0 8px 8px 0;
}

.lesson-warning {
    background: rgba(239, 68, 68, 0.1);
    border-left: 4px solid #ef4444;
    padding: 1rem 1.5rem;
    margin: 1.5rem 0;
    border-radius: 0 8px 8px 0;
}

/* ===== FLOATING ACTIONS ===== */
.floating-actions {
    position: fixed;
    top: 50%;
    right: 1rem;
    transform: translateY(-50%);
    z-index: 997;
}

.floating-btn {
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    margin-bottom: 0.5rem;
    font-size: 1.2rem;
}

.floating-btn:hover,
.floating-btn:active {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.1);
}

/* ===== LESSON NAVIGATION ===== */
.lesson-navigation {
    position: fixed;
    bottom: 80px; /* –ù–∞–¥ bottom navigation */
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    z-index: 998;
}

.nav-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.nav-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background: #6b7280;
}

.nav-btn.secondary {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: rgba(255, 255, 255, 0.8);
}

.lesson-actions {
    display: flex;
    gap: 0.5rem;
}

.action-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    width: 40px;
    height: 40px;
    border-radius: 8px;
    color: rgba(255, 255, 255, 0.8);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.action-btn:hover,
.action-btn:active {
    background: rgba(255, 255, 255, 0.2);
    transform: scale(1.05);
}

.action-btn.active {
    background: rgba(62, 205, 193, 0.2);
    border-color: #3ecdc1;
    color: #3ecdc1;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 480px) {
    .lesson-content {
        margin: 0.5rem;
        padding: 1.5rem 1rem;
    }
    
    .lesson-meta {
        gap: 1rem;
    }
}

@media (max-width: 360px) {
    .lesson-navigation {
        padding: 0.75rem;
    }
    
    .nav-btn {
        padding: 0.625rem 1rem;
        font-size: 0.85rem;
    }
    
    .floating-actions {
        right: 0.5rem;
    }
}

/* ===== –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê ===== */
[data-theme="dark"] .lesson-navigation {
    background: rgba(31, 41, 55, 0.95);
}

[data-theme="dark"] .nav-btn.secondary {
    border-color: rgba(156, 163, 175, 0.3);
    color: rgba(156, 163, 175, 0.8);
}

[data-theme="dark"] .action-btn {
    background: rgba(75, 85, 99, 0.3);
    border-color: rgba(156, 163, 175, 0.2);
    color: rgba(156, 163, 175, 0.8);
}

/* ===== –ê–ù–ò–ú–ê–¶–ò–ò ===== */
.lesson-content {
    animation: fadeIn 0.6s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}

{% block scripts_extra %}
<script>
// Lesson specific functionality
let currentSection = {{ current_section or 1 }};
let totalSections = {{ total_sections or 1 }};
let lessonProgress = 0;
let isBookmarked = false;
let notesVisible = false;

// Initialize lesson
document.addEventListener('DOMContentLoaded', function() {
    setupScrollTracking();
    loadUserProgress();
    updateProgressBar();
});

function updateProgressBar() {
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ header —á–µ—Ä–µ–∑ nav_config
    const progressFill = document.querySelector('.progress-fill');
    if (progressFill) {
        lessonProgress = (currentSection / totalSections) * 100;
        progressFill.style.width = lessonProgress + '%';
    }
    saveProgress();
}

function setupScrollTracking() {
    let ticking = false;
    
    window.addEventListener('scroll', () => {
        if (!ticking) {
            requestAnimationFrame(() => {
                const scrolled = window.pageYOffset;
                const maxScroll = document.body.scrollHeight - window.innerHeight;
                const scrollProgress = Math.min((scrolled / maxScroll) * 100, 100);
                
                // Update progress based on scroll
                if (scrollProgress > lessonProgress) {
                    lessonProgress = scrollProgress;
                    const progressFill = document.querySelector('.progress-fill');
                    if (progressFill) {
                        progressFill.style.width = lessonProgress + '%';
                    }
                    saveProgress();
                }
                
                ticking = false;
            });
            ticking = true;
        }
    }, { passive: true });
}

function saveProgress() {
    // Save lesson progress to localStorage or send to server
    const progressData = {
        lessonId: {{ lesson.id }},
        progress: lessonProgress,
        currentSection: currentSection,
        timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('lesson_progress_{{ lesson.id }}', JSON.stringify(progressData));
    
    // Send to server if user is authenticated
    {% if current_user.is_authenticated %}
    fetch('/{{ lang }}/mobile/api/lesson/{{ lesson.id }}/progress', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(progressData)
    }).catch(console.error);
    {% endif %}
}

function loadUserProgress() {
    const saved = localStorage.getItem('lesson_progress_{{ lesson.id }}');
    if (saved) {
        const data = JSON.parse(saved);
        lessonProgress = data.progress || 0;
        currentSection = data.currentSection || 1;
        updateProgressBar();
    }
}

function toggleBookmark() {
    isBookmarked = !isBookmarked;
    const bookmarkBtns = document.querySelectorAll('.action-btn .bi-bookmark, .action-btn .bi-bookmark-fill');
    
    bookmarkBtns.forEach(btn => {
        if (isBookmarked) {
            btn.classList.remove('bi-bookmark');
            btn.classList.add('bi-bookmark-fill');
            btn.parentElement.classList.add('active');
        } else {
            btn.classList.remove('bi-bookmark-fill');
            btn.classList.add('bi-bookmark');
            btn.parentElement.classList.remove('active');
        }
    });
    
    const message = isBookmarked ? 
        ({{ t('lesson_bookmarked', lang) | tojson }} || '–£—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∑–∞–∫–ª–∞–¥–∫–∏') : 
        ({{ t('lesson_unbookmarked', lang) | tojson }} || '–£—Ä–æ–∫ —É–¥–∞–ª–µ–Ω –∏–∑ –∑–∞–∫–ª–∞–¥–æ–∫');
    
    if (window.mobileApp && window.mobileApp.showNotification) {
        window.mobileApp.showNotification(message, isBookmarked ? 'success' : 'info');
    }
}

function toggleNotes() {
    notesVisible = !notesVisible;
    
    if (notesVisible) {
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∑–∞–º–µ—Ç–∫–∞–º–∏
        if (window.mobileApp && window.mobileApp.showNotification) {
            window.mobileApp.showNotification({{ t('notes_in_development', lang) | tojson }} || '–§—É–Ω–∫—Ü–∏—è –∑–∞–º–µ—Ç–æ–∫ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
        }
    }
}

function shareLesson() {
    if (navigator.share) {
        navigator.share({
            title: '{{ lesson.title }}',
            text: {{ t('studying_dentistry', lang) | tojson }} || '–ò–∑—É—á–∞—é —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—é –≤ Dental Academy',
            url: window.location.href
        }).catch(console.error);
    } else {
        // Fallback - copy to clipboard
        navigator.clipboard.writeText(window.location.href).then(() => {
            if (window.mobileApp && window.mobileApp.showNotification) {
                window.mobileApp.showNotification({{ t('link_copied', lang) | tojson }} || '–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
            }
        }).catch(() => {
            if (window.mobileApp && window.mobileApp.showNotification) {
                window.mobileApp.showNotification({{ t('copy_failed', lang) | tojson }} || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É', 'error');
            }
        });
    }
}

function openAIAssistant() {
    // –û—Ç–∫—Ä—ã—Ç—å AI –ø–æ–º–æ—â–Ω–∏–∫–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —É—Ä–æ–∫–∞
    const lessonTitle = document.querySelector('.lesson-title')?.textContent || '';
    const lessonContent = document.querySelector('.lesson-body')?.textContent?.slice(0, 500) || '';
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —É—Ä–æ–∫–∞ –≤ sessionStorage –¥–ª—è AI
    sessionStorage.setItem('aiContext', JSON.stringify({
        type: 'lesson',
        lesson_id: {{ lesson.id }},
        lesson_title: lessonTitle,
        lesson_content: lessonContent
    }));
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É AI
    window.location.href = '{{ url_for("ai.ai_chat", lang=lang) }}';
}

function previousLesson() {
    {% if previous_lesson %}
        window.location.href = '{{ url_for("mobile.lesson_view", lang=lang, lesson_id=previous_lesson.id) }}';
    {% endif %}
}

function nextLesson() {
    {% if next_lesson %}
        // Mark current lesson as completed and go to next
        markLessonCompleted();
        window.location.href = '{{ url_for("mobile.lesson_view", lang=lang, lesson_id=next_lesson.id) }}';
    {% else %}
        // Complete the lesson and return to subject/module
        markLessonCompleted();
        {% if lesson.module and lesson.module.subject_id %}
            window.location.href = '{{ url_for("mobile.subject_view", lang=lang, subject_id=lesson.module.subject_id) }}';
        {% else %}
            window.location.href = '{{ url_for("mobile.learning_map", lang=lang) }}';
        {% endif %}
    {% endif %}
}

function markLessonCompleted() {
    lessonProgress = 100;
    saveProgress();
    
    {% if current_user.is_authenticated %}
    fetch('/{{ lang }}/mobile/api/lesson/{{ lesson.id }}/complete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    }).catch(console.error);
    {% endif %}
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft' && !document.getElementById('prevBtn').disabled) {
        previousLesson();
    } else if (e.key === 'ArrowRight') {
        nextLesson();
    } else if (e.key === 'b' && e.ctrlKey) {
        e.preventDefault();
        toggleBookmark();
    }
});
</script>
{% endblock %} 