{% extends "mobile_base.html" %}

{% set nav_config = get_navigation_config('virtual_patient_results',
    show_logo=True,
    show_back_button=True,
    show_bottom_nav=True,
    show_profile_button=True,
    show_settings_button=True,
    show_language_selector=True,
    page_title=t('results', lang)
) %}

{% block title %}{{ t('results', lang) }} - Virtual Patient - Dental Academy{% endblock %}

{% block extra_css %}
<style>
    /* === –†–ï–ó–£–õ–¨–¢–ê–¢–´ –í–ò–†–¢–£–ê–õ–¨–ù–û–ì–û –ü–ê–¶–ò–ï–ù–¢–ê === */
    
    .results-header {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        text-align: center;
        color: white;
    }

    .score-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        margin: 0 auto 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        font-size: 2rem;
        font-weight: bold;
        color: white;
    }

    .score-excellent {
        background: linear-gradient(135deg, #28a745, #20c997);
    }

    .score-good {
        background: linear-gradient(135deg, #17a2b8, #20c997);
    }

    .score-needs-improvement {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
    }

    .score-poor {
        background: linear-gradient(135deg, #dc3545, #e83e8c);
    }

    .results-summary {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        color: white;
    }

    .feedback-section {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        color: white;
    }

    .feedback-item {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .feedback-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }

    .feedback-positive {
        border-left: 4px solid #28a745;
        padding-left: 1rem;
    }

    .feedback-negative {
        border-left: 4px solid #dc3545;
        padding-left: 1rem;
    }

    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 2rem;
    }

    .action-btn {
        background: linear-gradient(135deg, #3ECDC1, #44A08D);
        border: none;
        color: white;
        padding: 1rem 2rem;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(62, 205, 193, 0.4);
        color: white;
    }

    .action-btn.secondary {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .action-btn.secondary:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.5);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin: 1.5rem 0;
    }

    .stat-item {
        text-align: center;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.9rem;
        opacity: 0.8;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        margin: 1rem 0;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        border-radius: 4px;
        transition: width 1s ease;
    }

    .badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        margin: 0.25rem 0.25rem 0.25rem 0;
    }

    .badge-success {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
    }

    .badge-warning {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        color: white;
    }

    .badge-danger {
        background: linear-gradient(135deg, #dc3545, #e83e8c);
        color: white;
    }

    .timeline {
        position: relative;
        padding-left: 2rem;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 1rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background: rgba(255, 255, 255, 0.3);
    }

    .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        margin-left: 1rem;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -1.5rem;
        top: 1rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #3ECDC1;
        border: 3px solid rgba(255, 255, 255, 0.1);
    }

    .certificate-badge {
        text-align: center;
        margin: 2rem 0;
        padding: 2rem;
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 193, 7, 0.2));
        border: 2px solid rgba(255, 215, 0, 0.4);
        border-radius: 20px;
        color: #ffd700;
        font-weight: bold;
    }

    .certificate-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
<div class="results-header">
    <div class="score-circle {{ score_class }}">
        {{ final_score }}%
    </div>
    <h2>{{ performance_text }}</h2>
    <p>{{ scenario_title or '–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ü–∏–µ–Ω—Ç' }}</p>
</div>

<!-- –°–≤–æ–¥–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
<div class="results-summary">
    <h3>üìä {{ t('summary', lang) or '–°–≤–æ–¥–∫–∞' }}</h3>
    
    <div class="stats-grid">
        <div class="stat-item">
            <div class="stat-value">{{ total_time or '15' }}</div>
            <div class="stat-label">{{ t('minutes', lang) or '–º–∏–Ω—É—Ç' }}</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ correct_decisions or 0 }}/{{ total_decisions or 1 }}</div>
            <div class="stat-label">{{ t('correct_decisions', lang) or '–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π' }}</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ patient_satisfaction or 50 }}%</div>
            <div class="stat-label">{{ t('patient_satisfaction', lang) or '—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å' }}</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">{{ clinical_accuracy or 70 }}%</div>
            <div class="stat-label">{{ t('clinical_accuracy', lang) or '–∫–ª–∏–Ω–∏—á–µ—Å–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å' }}</div>
        </div>
    </div>
    
    <div class="progress-bar">
        <div class="progress-fill {{ score_class }}" style="width: {{ final_score }}%;"></div>
    </div>
</div>

<!-- –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å -->
{% if feedback_items %}
<div class="feedback-section">
    <h3>üí¨ {{ t('feedback', lang) or '–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å' }}</h3>
    
    {% for feedback in feedback_items %}
    <div class="feedback-item {{ 'feedback-positive' if feedback.positive else 'feedback-negative' }}">
        <strong>{{ feedback.title }}</strong>
        <p>{{ feedback.description }}</p>
        {% if feedback.badges %}
            {% for badge in feedback.badges %}
                <span class="badge badge-{{ badge.type }}">{{ badge.text }}</span>
            {% endfor %}
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏–π -->
{% if timeline_items %}
<div class="feedback-section">
    <h3>‚è∞ {{ t('action_timeline', lang) or '–•—Ä–æ–Ω–æ–ª–æ–≥–∏—è –¥–µ–π—Å—Ç–≤–∏–π' }}</h3>
    
    <div class="timeline">
        {% for item in timeline_items %}
        <div class="timeline-item">
            <strong>{{ item.time }}</strong> - {{ item.action }}
            <br><small>{{ item.result }}</small>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (–µ—Å–ª–∏ –∑–∞—Å–ª—É–∂–µ–Ω) -->
{% if earned_certificate %}
<div class="certificate-badge">
    <div class="certificate-icon">üèÜ</div>
    <h3>{{ t('certificate_earned', lang) or '–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ø–æ–ª—É—á–µ–Ω!' }}</h3>
    <p>{{ certificate_text or '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º –ø–∞—Ü–∏–µ–Ω—Ç–æ–º' }}</p>
</div>
{% endif %}

<!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
<div class="action-buttons">
    <a href="{{ retry_url or url_for('virtual_patient_bp.start_scenario', lang=lang, scenario_id=scenario_id) }}" 
       class="action-btn">
        <i class="bi bi-arrow-repeat"></i>
        {{ t('try_again', lang) or '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞' }}
    </a>
    
    <a href="{{ next_scenario_url or url_for('virtual_patient_bp.scenarios_list', lang=lang) }}" 
       class="action-btn secondary">
        <i class="bi bi-arrow-right"></i>
        {{ t('next_case', lang) or '–°–ª–µ–¥—É—é—â–∏–π —Å–ª—É—á–∞–π' }}
    </a>
    
    <a href="{{ url_for('virtual_patient_bp.scenarios_list', lang=lang) }}" 
       class="action-btn secondary">
        <i class="bi bi-list"></i>
        {{ t('all_cases', lang) or '–í—Å–µ —Å–ª—É—á–∞–∏' }}
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä–∞
    const progressFill = document.querySelector('.progress-fill');
    if (progressFill) {
        const targetWidth = progressFill.style.width;
        progressFill.style.width = '0%';
        
        setTimeout(() => {
            progressFill.style.width = targetWidth;
        }, 500);
    }
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const elements = document.querySelectorAll('.results-summary, .feedback-section, .certificate-badge');
    elements.forEach((element, index) => {
        element.style.opacity = '0';
        element.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            element.style.transition = 'all 0.6s ease';
            element.style.opacity = '1';
            element.style.transform = 'translateY(0)';
        }, index * 200 + 300);
    });
    
    // –¢–∞–∫—Ç–∏–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –¥–ª—è –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.action-btn').forEach(btn => {
        btn.addEventListener('touchstart', function() {
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        });
    });
    
    console.log('üìä Virtual Patient Results - –≥–æ—Ç–æ–≤!');
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
function saveResults() {
    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
function shareResults() {
    if (navigator.share) {
        navigator.share({
            title: '{{ scenario_title or "–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ü–∏–µ–Ω—Ç" }}',
            text: `–Ø –Ω–∞–±—Ä–∞–ª {{ final_score }}% –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º —Å–ª—É—á–∞–µ!`,
            url: window.location.href
        });
    } else {
        // Fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤ –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Web Share API
        const shareText = `–Ø –Ω–∞–±—Ä–∞–ª {{ final_score }}% –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º —Å–ª—É—á–∞–µ: {{ scenario_title or "–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ø–∞—Ü–∏–µ–Ω—Ç" }}`;
        
        if (navigator.clipboard) {
            navigator.clipboard.writeText(shareText);
            alert('{{ t("copied_to_clipboard", lang) or "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!" }}');
        }
    }
}
</script>
{% endblock %} 