{% extends "mobile_base.html" %}

{% set nav_config = get_navigation_config('virtual_patient_interact',
    show_logo=True,
    show_back_button=True,
    show_bottom_nav=False,
    show_profile_button=False,
    show_settings_button=False,
    show_language_selector=False,
    page_title=scenario_model_obj.title
) %}

{% block title %}{{ scenario_model_obj.title }} - Virtual Patient - Dental Academy{% endblock %}

{% block extra_css %}
<style>
    /* === –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–û–ì–û –†–ï–ñ–ò–ú–ê === */
    
    /* –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω –¥–ª—è –ø–æ–≥—Ä—É–∂–µ–Ω–∏—è */
    body {
        height: 100vh;
        overflow: hidden;
        position: fixed;
        width: 100%;
    }

    /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω */
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
            radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(255, 107, 107, 0.3) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(60, 206, 193, 0.3) 0%, transparent 50%);
        animation: backgroundShift 10s ease-in-out infinite;
    }

    @keyframes backgroundShift {
        0%, 100% { transform: translate(0, 0) scale(1); }
        33% { transform: translate(-20px, -10px) scale(1.1); }
        66% { transform: translate(20px, 10px) scale(0.9); }
    }

    /* === –ö–û–ù–¢–ï–ô–ù–ï–†–´ –î–õ–Ø –≠–§–§–ï–ö–¢–û–í === */
    .patient-photo-container {
        position: relative;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        overflow: visible;
    }

    .patient-photo {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
        transition: filter 0.5s ease;
    }

    /* === –§–ò–ó–ò–û–õ–û–ì–ò–ß–ï–°–ö–ò–ï –≠–§–§–ï–ö–¢–´ === */
    
    /* –ö–∞–ø–ª–∏ –ø–æ—Ç–∞ */
    .sweat-drop {
        position: absolute;
        width: 3px;
        height: 3px;
        background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.3) 100%);
        border-radius: 50%;
        box-shadow: 0 1px 3px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.8);
        animation: sweatDrop 2.5s ease-in-out infinite;
        opacity: 0;
        z-index: 5;
    }

    @keyframes sweatDrop {
        0% { 
            opacity: 0; 
            transform: translateY(-5px) scale(0.5);
        }
        15% { 
            opacity: 1; 
            transform: translateY(0) scale(1);
        }
        85% { 
            opacity: 0.8; 
            transform: translateY(25px) scale(0.8);
        }
        100% { 
            opacity: 0; 
            transform: translateY(35px) scale(0.3);
        }
    }

    .sweat-drop:nth-child(1) { top: 10%; left: 45%; animation-delay: 0s; }
    .sweat-drop:nth-child(2) { top: 15%; left: 20%; animation-delay: 0.8s; }
    .sweat-drop:nth-child(3) { top: 12%; left: 75%; animation-delay: 1.6s; }
    .sweat-drop:nth-child(4) { top: 25%; left: 30%; animation-delay: 2.2s; }

    /* –°–ª–µ–∑—ã */
    .tear-drop {
        position: absolute;
        width: 2px;
        height: 15px;
        background: linear-gradient(180deg, rgba(255,255,255,0.9) 0%, rgba(200,230,255,0.7) 100%);
        border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 2px rgba(255,255,255,0.9);
        animation: tearDrop 3.5s ease-in-out infinite;
        opacity: 0;
        z-index: 5;
    }

    @keyframes tearDrop {
        0% { 
            opacity: 0; 
            transform: translateY(-2px) scale(0.3);
        }
        20% { 
            opacity: 1; 
            transform: translateY(0) scale(1);
        }
        80% { 
            opacity: 0.9; 
            transform: translateY(35px) scale(0.8);
        }
        100% { 
            opacity: 0; 
            transform: translateY(45px) scale(0.5);
        }
    }

    .tear-drop.left { top: 40%; left: 25%; animation-delay: 0s; }
    .tear-drop.right { top: 42%; right: 25%; animation-delay: 1.2s; }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥—ã—Ö–∞–Ω–∏—è */
    .breathing-indicator {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        animation: breathing 4s ease-in-out infinite;
    }

    @keyframes breathing {
        0%, 100% { transform: scale(1); opacity: 0.3; }
        50% { transform: scale(1.05); opacity: 0.6; }
    }

    /* === –ò–ù–¢–ï–†–§–ï–ô–° –î–ò–ê–õ–û–ì–ê === */
    .dialogue-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-top: 2px solid rgba(255, 255, 255, 0.2);
        padding: 1.5rem;
        max-height: 50vh;
        overflow-y: auto;
        z-index: 200;
    }

    .dialogue-text {
        color: white;
        font-size: 1.1rem;
        line-height: 1.6;
        margin-bottom: 1.5rem;
        text-align: center;
    }

    .choices-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .choice-button {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 15px;
        padding: 1rem 1.5rem;
        color: white;
        font-size: 1rem;
        line-height: 1.4;
        transition: all 0.3s ease;
        cursor: pointer;
        text-align: left;
    }

    .choice-button:hover {
        background: rgba(62, 205, 193, 0.3);
        border-color: rgba(62, 205, 193, 0.6);
        transform: translateY(-2px);
    }

    .choice-button:active {
        transform: translateY(0);
    }

    /* === –°–¢–ê–¢–£–° –ü–ê–¶–ò–ï–ù–¢–ê === */
    .patient-status-area {
        position: fixed;
        top: calc(var(--header-height) + 1rem);
        left: 1rem;
        right: 1rem;
        display: flex;
        justify-content: center;
        z-index: 150;
    }

    .patient-display {
        width: 200px;
        height: 200px;
        position: relative;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 3px solid rgba(255, 255, 255, 0.3);
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    /* === –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô === */
    .action-buttons {
        position: fixed;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        z-index: 150;
    }

    .action-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.6);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .action-btn:hover {
        background: rgba(62, 205, 193, 0.6);
        border-color: rgba(62, 205, 193, 0.8);
        transform: scale(1.1);
    }

    /* === –ü–†–û–ì–†–ï–°–° –ë–ê–† === */
    .progress-container {
        position: fixed;
        top: calc(var(--header-height) + 0.5rem);
        left: 1rem;
        right: 1rem;
        z-index: 100;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3ECDC1, #44A08D);
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    /* === –ê–ù–ò–ú–ê–¶–ò–ò === */
    .fade-in {
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .slide-up {
        animation: slideUp 0.4s ease-out;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä -->
<div class="progress-container">
    <div class="progress-bar">
        <div class="progress-fill" style="width: {{ progress_percentage or 0 }}%"></div>
    </div>
</div>

<!-- –û–±–ª–∞—Å—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞ -->
<div class="patient-status-area">
    <div class="patient-display" id="patientDisplay">
        {% if patient_image %}
            <div class="patient-photo-container">
                <img src="{{ patient_image }}" alt="Patient" class="patient-photo" id="patientPhoto">
                
                <!-- –§–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —ç—Ñ—Ñ–µ–∫—Ç—ã -->
                <div class="breathing-indicator" id="breathingIndicator"></div>
                
                <!-- –ö–∞–ø–ª–∏ –ø–æ—Ç–∞ (–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ —Å—Ç—Ä–µ—Å—Å–µ) -->
                <div class="sweat-drop" style="display: none;"></div>
                <div class="sweat-drop" style="display: none;"></div>
                <div class="sweat-drop" style="display: none;"></div>
                <div class="sweat-drop" style="display: none;"></div>
                
                <!-- –°–ª–µ–∑—ã (–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –±–æ–ª–∏) -->
                <div class="tear-drop left" style="display: none;"></div>
                <div class="tear-drop right" style="display: none;"></div>
            </div>
        {% else %}
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 3rem;">
                üë§
            </div>
        {% endif %}
    </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
<div class="action-buttons">
    <button class="action-btn" onclick="showPatientHistory()" title="{{ t('patient_history', lang) or '–ò—Å—Ç–æ—Ä–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞' }}">
        <i class="bi bi-file-medical"></i>
    </button>
    <button class="action-btn" onclick="takeNotes()" title="{{ t('take_notes', lang) or '–ó–∞–º–µ—Ç–∫–∏' }}">
        <i class="bi bi-pencil"></i>
    </button>
    <button class="action-btn" onclick="showHints()" title="{{ t('hints', lang) or '–ü–æ–¥—Å–∫–∞–∑–∫–∏' }}">
        <i class="bi bi-lightbulb"></i>
    </button>
</div>

<!-- –î–∏–∞–ª–æ–≥–æ–≤–∞—è –æ–±–ª–∞—Å—Ç—å -->
<div class="dialogue-container slide-up" id="dialogueContainer">
    <div class="dialogue-text" id="dialogueText">
        {{ current_step.description or '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –∫ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º—É –ø–∞—Ü–∏–µ–Ω—Ç—É. –ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?' }}
    </div>
    
    <div class="choices-container" id="choicesContainer">
        {% if choices %}
            {% for choice in choices %}
                <button class="choice-button" onclick="makeChoice({{ choice.id }})">
                    {{ choice.text }}
                </button>
            {% endfor %}
        {% else %}
            <button class="choice-button" onclick="makeChoice('start')">
                {{ t('start_examination', lang) or '–ù–∞—á–∞—Ç—å –æ—Å–º–æ—Ç—Ä' }}
            </button>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞
let patientState = {
    stress: 0,
    pain: 0,
    breathing: 'normal'
};

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞
function updatePatientState(newState) {
    Object.assign(patientState, newState);
    
    const photo = document.getElementById('patientPhoto');
    const sweatDrops = document.querySelectorAll('.sweat-drop');
    const tearDrops = document.querySelectorAll('.tear-drop');
    
    // –≠—Ñ—Ñ–µ–∫—Ç—ã —Å—Ç—Ä–µ—Å—Å–∞
    if (patientState.stress > 50) {
        sweatDrops.forEach(drop => drop.style.display = 'block');
        if (photo) photo.style.filter = 'brightness(0.9) saturate(1.2)';
    } else {
        sweatDrops.forEach(drop => drop.style.display = 'none');
    }
    
    // –≠—Ñ—Ñ–µ–∫—Ç—ã –±–æ–ª–∏
    if (patientState.pain > 70) {
        tearDrops.forEach(drop => drop.style.display = 'block');
        if (photo) photo.style.filter = 'brightness(0.8) saturate(1.3) hue-rotate(10deg)';
    } else {
        tearDrops.forEach(drop => drop.style.display = 'none');
    }
    
    // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    if (patientState.stress <= 50 && patientState.pain <= 70) {
        if (photo) photo.style.filter = 'none';
    }
}

// –í—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è
function makeChoice(choiceId) {
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–∫—Ç–∏–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
    if (navigator.vibrate) {
        navigator.vibrate(50);
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—ã–±–æ—Ä –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch(`/{{ lang }}/virtual-patient/choice`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
            scenario_id: '{{ scenario_model_obj.id }}',
            choice_id: choiceId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateDialogue(data.next_step);
            updateProgress(data.progress);
            
            if (data.patient_state) {
                updatePatientState(data.patient_state);
            }
            
            if (data.completed) {
                setTimeout(() => {
                    window.location.href = data.results_url;
                }, 2000);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞
function updateDialogue(step) {
    const dialogueText = document.getElementById('dialogueText');
    const choicesContainer = document.getElementById('choicesContainer');
    
    if (dialogueText) {
        dialogueText.textContent = step.description;
        dialogueText.classList.add('fade-in');
    }
    
    if (choicesContainer && step.choices) {
        choicesContainer.innerHTML = '';
        step.choices.forEach(choice => {
            const button = document.createElement('button');
            button.className = 'choice-button';
            button.textContent = choice.text;
            button.onclick = () => makeChoice(choice.id);
            choicesContainer.appendChild(button);
        });
        choicesContainer.classList.add('slide-up');
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function updateProgress(percentage) {
    const progressFill = document.querySelector('.progress-fill');
    if (progressFill) {
        progressFill.style.width = percentage + '%';
    }
}

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function showPatientHistory() {
    // –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–∞—Ü–∏–µ–Ω—Ç–∞
    alert('{{ t("patient_history_placeholder", lang) or "–ò—Å—Ç–æ—Ä–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö" }}');
}

function takeNotes() {
    // –û—Ç–∫—Ä—ã—Ç—å –±–ª–æ–∫–Ω–æ—Ç
    alert('{{ t("notes_placeholder", lang) or "–§—É–Ω–∫—Ü–∏—è –∑–∞–º–µ—Ç–æ–∫ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö" }}');
}

function showHints() {
    // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏
    alert('{{ t("hints_placeholder", lang) or "–ü–æ–¥—Å–∫–∞–∑–∫–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö" }}');
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∑—É–º–∞
    document.addEventListener('touchmove', function(e) {
        if (e.scale !== 1) {
            e.preventDefault();
        }
    }, { passive: false });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–∞—Ü–∏–µ–Ω—Ç–∞
    updatePatientState({
        stress: {{ patient_stress or 0 }},
        pain: {{ patient_pain or 0 }}
    });
    
    console.log('üè• Virtual Patient Interactive Mode - –≥–æ—Ç–æ–≤!');
});
</script>
{% endblock %}