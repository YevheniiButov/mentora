{% extends "mobile_base.html" %}

{% block title %}{{ t('profile', g.lang)|default('Профиль') }} - Dental Academy{% endblock %}
{% block mobile_title %}{{ t('profile', g.lang)|default('Профиль') }}{% endblock %}

{% block styles %}
{{ super() }}
<style>
/* Mobile Profile Specific Styles */
.mobile-profile-header {
  background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
  color: white;
  padding: 24px 16px;
  margin: -16px -16px 20px -16px;
  text-align: center;
  position: relative;
  overflow: hidden;
}

.mobile-profile-header::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  border-radius: 50%;
}

.mobile-profile-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 32px;
  margin: 0 auto 16px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  position: relative;
  z-index: 1;
}

.mobile-profile-name {
  font-size: 24px;
  font-weight: 700;
  margin-bottom: 4px;
  position: relative;
  z-index: 1;
}

.mobile-profile-email {
  font-size: 14px;
  opacity: 0.9;
  margin-bottom: 16px;
  position: relative;
  z-index: 1;
}

.mobile-profile-stats {
  display: flex;
  justify-content: center;
  gap: 24px;
  position: relative;
  z-index: 1;
}

.mobile-profile-stat {
  text-align: center;
}

.mobile-profile-stat-value {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 2px;
}

.mobile-profile-stat-label {
  font-size: 12px;
  opacity: 0.8;
}

.mobile-profile-sections {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.mobile-profile-section {
  background: var(--mobile-bg-primary);
  border-radius: 16px;
  border: 1px solid var(--mobile-border);
  overflow: hidden;
}

.mobile-section-header {
  padding: 16px;
  border-bottom: 1px solid var(--mobile-border);
  background: var(--mobile-bg-secondary);
}

.mobile-section-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--mobile-text-primary);
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.mobile-section-icon {
  font-size: 18px;
  color: var(--primary-color);
}

.mobile-section-content {
  padding: 0;
}

.mobile-menu-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  border-bottom: 1px solid var(--mobile-border);
  color: var(--mobile-text-primary);
  text-decoration: none;
  transition: all var(--mobile-transition-fast);
  background: none;
  border-left: none;
  border-right: none;
  border-top: none;
  width: 100%;
  cursor: pointer;
}

.mobile-menu-item:last-child {
  border-bottom: none;
}

.mobile-menu-item:active {
  background: var(--mobile-bg-secondary);
  transform: scale(0.98);
}

.mobile-menu-item-content {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}

.mobile-menu-item-icon {
  width: 20px;
  font-size: 18px;
  color: var(--mobile-text-secondary);
}

.mobile-menu-item-text {
  flex: 1;
}

.mobile-menu-item-title {
  font-size: 16px;
  font-weight: 500;
  color: var(--mobile-text-primary);
  margin: 0 0 2px 0;
}

.mobile-menu-item-subtitle {
  font-size: 13px;
  color: var(--mobile-text-secondary);
  margin: 0;
}

.mobile-menu-item-arrow,
.mobile-menu-item-value {
  color: var(--mobile-text-tertiary);
  font-size: 14px;
}

.mobile-menu-item-toggle {
  position: relative;
  width: 48px;
  height: 28px;
  background: var(--mobile-bg-tertiary);
  border-radius: 14px;
  transition: all var(--mobile-transition-normal);
  cursor: pointer;
}

.mobile-menu-item-toggle.active {
  background: var(--primary-color);
}

.mobile-menu-item-toggle::before {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 24px;
  height: 24px;
  background: white;
  border-radius: 50%;
  transition: all var(--mobile-transition-normal);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.mobile-menu-item-toggle.active::before {
  transform: translateX(20px);
}

.mobile-progress-section {
  padding: 20px 16px;
}

.mobile-progress-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--mobile-text-primary);
  margin: 0 0 16px 0;
  text-align: center;
}

.mobile-progress-circle {
  width: 120px;
  height: 120px;
  margin: 0 auto 20px;
  position: relative;
}

.mobile-progress-svg {
  width: 100%;
  height: 100%;
  transform: rotate(-90deg);
}

.mobile-progress-bg {
  fill: none;
  stroke: var(--mobile-bg-tertiary);
  stroke-width: 8;
}

.mobile-progress-fill {
  fill: none;
  stroke: var(--primary-color);
  stroke-width: 8;
  stroke-linecap: round;
  transition: stroke-dashoffset 1s ease-out;
}

.mobile-progress-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

.mobile-progress-percent {
  font-size: 24px;
  font-weight: 700;
  color: var(--mobile-text-primary);
  margin-bottom: 4px;
}

.mobile-progress-label {
  font-size: 12px;
  color: var(--mobile-text-secondary);
}

.mobile-achievements-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
  gap: 12px;
  padding: 16px;
}

.mobile-achievement {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  padding: 12px 8px;
  border-radius: 12px;
  transition: all var(--mobile-transition-fast);
}

.mobile-achievement.earned {
  background: rgba(62, 205, 193, 0.1);
}

.mobile-achievement.locked {
  opacity: 0.5;
}

.mobile-achievement:active {
  transform: scale(0.95);
}

.mobile-achievement-icon {
  font-size: 28px;
  margin-bottom: 8px;
  color: var(--primary-color);
}

.mobile-achievement.locked .mobile-achievement-icon {
  color: var(--mobile-text-tertiary);
}

.mobile-achievement-title {
  font-size: 11px;
  font-weight: 600;
  color: var(--mobile-text-primary);
  line-height: 1.2;
  margin-bottom: 2px;
}

.mobile-achievement-desc {
  font-size: 10px;
  color: var(--mobile-text-secondary);
  line-height: 1.2;
}

.mobile-stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 16px;
  padding: 16px;
}

.mobile-stat-card {
  background: var(--mobile-bg-secondary);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  border: 1px solid var(--mobile-border);
}

.mobile-stat-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: rgba(62, 205, 193, 0.1);
  color: var(--primary-color);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  margin: 0 auto 12px;
}

.mobile-stat-value {
  font-size: 20px;
  font-weight: 700;
  color: var(--mobile-text-primary);
  margin-bottom: 4px;
}

.mobile-stat-label {
  font-size: 12px;
  color: var(--mobile-text-secondary);
}

.mobile-danger-zone {
  margin-top: 24px;
}

.mobile-danger-item {
  color: #dc2626;
}

.mobile-danger-item .mobile-menu-item-icon {
  color: #dc2626;
}

.mobile-danger-item:active {
  background: rgba(220, 38, 38, 0.1);
}

/* Language selector */
.mobile-language-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  padding: 16px;
}

.mobile-language-option {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px;
  border: 2px solid var(--mobile-border);
  border-radius: 12px;
  background: var(--mobile-bg-primary);
  color: var(--mobile-text-primary);
  text-decoration: none;
  transition: all var(--mobile-transition-fast);
  font-size: 14px;
  font-weight: 500;
}

.mobile-language-option:active {
  transform: scale(0.95);
}

.mobile-language-option.active {
  border-color: var(--primary-color);
  background: rgba(62, 205, 193, 0.1);
  color: var(--primary-color);
}

.mobile-language-flag {
  font-size: 18px;
}

/* Responsive adjustments */
@media (max-width: 360px) {
  .mobile-profile-stats {
    gap: 16px;
  }
  
  .mobile-achievements-grid {
    grid-template-columns: repeat(4, 1fr);
  }
  
  .mobile-stats-grid {
    grid-template-columns: 1fr;
  }
}
</style>
{% endblock %}

{% block mobile_content %}

<!-- Profile Header -->
<div class="mobile-profile-header">
  <div class="mobile-profile-avatar">
    <i class="bi bi-person-fill"></i>
  </div>
  <h1 class="mobile-profile-name">{{ current_user.name }}</h1>
  <p class="mobile-profile-email">{{ current_user.email }}</p>
  
  <div class="mobile-profile-stats">
    <div class="mobile-profile-stat">
      <div class="mobile-profile-stat-value">{{ stats.overall_progress|default(0) }}%</div>
      <div class="mobile-profile-stat-label">{{ t('progress', g.lang)|default('Прогресс') }}</div>
    </div>
    <div class="mobile-profile-stat">
      <div class="mobile-profile-stat-value">{{ stats.completed_lessons|default(0) }}</div>
      <div class="mobile-profile-stat-label">{{ t('lessons', g.lang)|default('Уроков') }}</div>
    </div>
    <div class="mobile-profile-stat">
      <div class="mobile-profile-stat-value">{{ stats.active_days|default(0) }}</div>
      <div class="mobile-profile-stat-label">{{ t('days', g.lang)|default('Дней') }}</div>
    </div>
  </div>
</div>

<div class="mobile-profile-sections">
  
  <!-- Overall Progress Section -->
  <div class="mobile-profile-section">
    <div class="mobile-section-header">
      <h2 class="mobile-section-title">
        <i class="mobile-section-icon bi bi-graph-up"></i>
        {{ t('overall_progress', g.lang)|default('Общий прогресс') }}
      </h2>
    </div>
    <div class="mobile-progress-section">
      <h3 class="mobile-progress-title">{{ t('learning_progress', g.lang)|default('Прогресс обучения') }}</h3>
      
      <div class="mobile-progress-circle">
        <svg class="mobile-progress-svg" viewBox="0 0 120 120">
          <circle class="mobile-progress-bg" cx="60" cy="60" r="50"></circle>
          <circle class="mobile-progress-fill" cx="60" cy="60" r="50" 
                  stroke-dasharray="314" 
                  stroke-dashoffset="{{ 314 - (314 * (stats.overall_progress|default(0)) / 100) }}"
                  id="mobile-progress-circle"></circle>
        </svg>
        <div class="mobile-progress-text">
          <div class="mobile-progress-percent">{{ stats.overall_progress|default(0) }}%</div>
          <div class="mobile-progress-label">{{ t('completed', g.lang)|default('Завершено') }}</div>
        </div>
      </div>
      
      <div class="mobile-stats-grid">
        <div class="mobile-stat-card">
          <div class="mobile-stat-icon">
            <i class="bi bi-clock"></i>
          </div>
          <div class="mobile-stat-value">{{ stats.total_time_spent|default(0) }}</div>
          <div class="mobile-stat-label">{{ t('minutes', g.lang)|default('Минут') }}</div>
        </div>
        
        <div class="mobile-stat-card">
          <div class="mobile-stat-icon">
            <i class="bi bi-calendar-check"></i>
          </div>
          <div class="mobile-stat-value">{{ stats.streak_days|default(0) }}</div>
          <div class="mobile-stat-label">{{ t('streak', g.lang)|default('Дней подряд') }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Achievements Section -->
  <div class="mobile-profile-section">
    <div class="mobile-section-header">
      <h2 class="mobile-section-title">
        <i class="mobile-section-icon bi bi-trophy"></i>
        {{ t('achievements', g.lang)|default('Достижения') }}
      </h2>
    </div>
    <div class="mobile-achievements-grid">
      {% set sample_achievements = [
        {'id': 1, 'title': 'Первые шаги', 'desc': '1 урок', 'icon': 'bi-play-fill', 'earned': true},
        {'id': 2, 'title': 'Марафонец', 'desc': '7 дней подряд', 'icon': 'bi-fire', 'earned': true},
        {'id': 3, 'title': 'Эксперт', 'desc': '50 уроков', 'icon': 'bi-star-fill', 'earned': false},
        {'id': 4, 'title': 'Мастер', 'desc': '100 уроков', 'icon': 'bi-crown', 'earned': false},
        {'id': 5, 'title': 'Быстрый', 'desc': 'Урок за 5 мин', 'icon': 'bi-lightning-fill', 'earned': true},
        {'id': 6, 'title': 'Перфекционист', 'desc': '100% точность', 'icon': 'bi-bullseye', 'earned': false}
      ] %}
      
      {% for achievement in sample_achievements %}
      <div class="mobile-achievement {% if achievement.earned %}earned{% else %}locked{% endif %}">
        <div class="mobile-achievement-icon">
          <i class="{{ achievement.icon }}"></i>
        </div>
        <div class="mobile-achievement-title">{{ achievement.title }}</div>
        <div class="mobile-achievement-desc">{{ achievement.desc }}</div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Account Settings Section -->
  <div class="mobile-profile-section">
    <div class="mobile-section-header">
      <h2 class="mobile-section-title">
        <i class="mobile-section-icon bi bi-person-gear"></i>
        {{ t('account_settings', g.lang)|default('Настройки аккаунта') }}
      </h2>
    </div>
    <div class="mobile-section-content">
      
      <a href="{{ url_for('main_bp.edit_profile', lang=g.lang) }}" class="mobile-menu-item">
        <div class="mobile-menu-item-content">
          <i class="mobile-menu-item-icon bi bi-person"></i>
          <div class="mobile-menu-item-text">
            <div class="mobile-menu-item-title">{{ t('edit_profile', g.lang)|default('Редактировать профиль') }}</div>
            <div class="mobile-menu-item-subtitle">{{ t('name_email_password', g.lang)|default('Имя, email, пароль') }}</div>
          </div>
        </div>
        <i class="mobile-menu-item-arrow bi bi-chevron-right"></i>
      </a>
      
      <button class="mobile-menu-item" id="mobile-notifications-toggle">
        <div class="mobile-menu-item-content">
          <i class="mobile-menu-item-icon bi bi-bell"></i>
          <div class="mobile-menu-item-text">
            <div class="mobile-menu-item-title">{{ t('notifications', g.lang)|default('Уведомления') }}</div>
            <div class="mobile-menu-item-subtitle">{{ t('push_notifications', g.lang)|default('Push-уведомления') }}</div>
          </div>
        </div>
        <div class="mobile-menu-item-toggle" id="notifications-toggle"></div>
      </button>
      
      <button class="mobile-menu-item" id="mobile-theme-toggle">
        <div class="mobile-menu-item-content">
          <i class="mobile-menu-item-icon bi bi-moon theme-icon"></i>
          <div class="mobile-menu-item-text">
            <div class="mobile-menu-item-title">
              <span class="theme-text">{{ t('dark_theme', g.lang)|default('Темная тема') }}</span>
            </div>
            <div class="mobile-menu-item-subtitle">{{ t('theme_description', g.lang)|default('Переключить цветовую схему') }}</div>
          </div>
        </div>
        <div class="mobile-menu-item-toggle" id="theme-toggle"></div>
      </button>
      
    </div>
  </div>

  <!-- Language Section -->
  <div class="mobile-profile-section">
    <div class="mobile-section-header">
      <h2 class="mobile-section-title">
        <i class="mobile-section-icon bi bi-globe"></i>
        {{ t('language', g.lang)|default('Язык') }}
      </h2>
    </div>
    <div class="mobile-language-grid">
      <a href="#" class="mobile-language-option {% if g.lang == 'en' %}active{% endif %}" data-lang="en">
        <span class="mobile-language-flag">🇺🇸</span>
        English
      </a>
      <a href="#" class="mobile-language-option {% if g.lang == 'ru' %}active{% endif %}" data-lang="ru">
        <span class="mobile-language-flag">🇷🇺</span>
        Русский
      </a>
      <a href="#" class="mobile-language-option {% if g.lang == 'nl' %}active{% endif %}" data-lang="nl">
        <span class="mobile-language-flag">🇳🇱</span>
        Nederlands
      </a>
      <a href="#" class="mobile-language-option {% if g.lang == 'uk' %}active{% endif %}" data-lang="uk">
        <span class="mobile-language-flag">🇺🇦</span>
        Українська
      </a>
      <a href="#" class="mobile-language-option {% if g.lang == 'es' %}active{% endif %}" data-lang="es">
        <span class="mobile-language-flag">🇪🇸</span>
        Español
      </a>
      <a href="#" class="mobile-language-option {% if g.lang == 'pt' %}active{% endif %}" data-lang="pt">
        <span class="mobile-language-flag">🇵🇹</span>
        Português
      </a>
      <a href="#" class="mobile-language-option {% if g.lang == 'tr' %}active{% endif %}" data-lang="tr">
        <span class="mobile-language-flag">🇹🇷</span>
        Türkçe
      </a>
      <a href="#" class="mobile-language-option {% if g.lang == 'fa' %}active{% endif %}" data-lang="fa">
        <span class="mobile-language-flag">🇮🇷</span>
        فارسی
      </a>
    </div>
  </div>

  <!-- Help & Support Section -->
  <div class="mobile-profile-section">
    <div class="mobile-section-header">
      <h2 class="mobile-section-title">
        <i class="mobile-section-icon bi bi-question-circle"></i>
        {{ t('help_support', g.lang)|default('Помощь и поддержка') }}
      </h2>
    </div>
    <div class="mobile-section-content">
      
      <a href="{{ url_for('main_bp.help', lang=g.lang) }}" class="mobile-menu-item">
        <div class="mobile-menu-item-content">
          <i class="mobile-menu-item-icon bi bi-book"></i>
          <div class="mobile-menu-item-text">
            <div class="mobile-menu-item-title">{{ t('help_center', g.lang)|default('Центр помощи') }}</div>
            <div class="mobile-menu-item-subtitle">{{ t('faq_guides', g.lang)|default('FAQ и руководства') }}</div>
          </div>
        </div>
        <i class="mobile-menu-item-arrow bi bi-chevron-right"></i>
      </a>
      
      <a href="{{ url_for('main_bp.contact', lang=g.lang) }}" class="mobile-menu-item">
        <div class="mobile-menu-item-content">
          <i class="mobile-menu-item-icon bi bi-envelope"></i>
          <div class="mobile-menu-item-text">
            <div class="mobile-menu-item-title">{{ t('contact_us', g.lang)|default('Связаться с нами') }}</div>
            <div class="mobile-menu-item-subtitle">{{ t('support_team', g.lang)|default('Команда поддержки') }}</div>
          </div>
        </div>
        <i class="mobile-menu-item-arrow bi bi-chevron-right"></i>
      </a>
      
      <a href="{{ url_for('main_bp.privacy', lang=g.lang) }}" class="mobile-menu-item">
        <div class="mobile-menu-item-content">
          <i class="mobile-menu-item-icon bi bi-shield-check"></i>
          <div class="mobile-menu-item-text">
            <div class="mobile-menu-item-title">{{ t('privacy_policy', g.lang)|default('Политика конфиденциальности') }}</div>
          </div>
        </div>
        <i class="mobile-menu-item-arrow bi bi-chevron-right"></i>
      </a>
      
    </div>
  </div>

  <!-- Danger Zone -->
  <div class="mobile-profile-section mobile-danger-zone">
    <div class="mobile-section-header">
      <h2 class="mobile-section-title">
        <i class="mobile-section-icon bi bi-exclamation-triangle" style="color: #dc2626;"></i>
        {{ t('danger_zone', g.lang)|default('Опасная зона') }}
      </h2>
    </div>
    <div class="mobile-section-content">
      
      <button class="mobile-menu-item mobile-danger-item" id="mobile-clear-data-btn">
        <div class="mobile-menu-item-content">
          <i class="mobile-menu-item-icon bi bi-trash"></i>
          <div class="mobile-menu-item-text">
            <div class="mobile-menu-item-title">{{ t('clear_data', g.lang)|default('Очистить данные') }}</div>
            <div class="mobile-menu-item-subtitle">{{ t('reset_progress', g.lang)|default('Сбросить весь прогресс') }}</div>
          </div>
        </div>
        <i class="mobile-menu-item-arrow bi bi-chevron-right"></i>
      </button>
      
      <a href="{{ url_for('auth_bp.logout', lang=g.lang) }}" class="mobile-menu-item mobile-danger-item">
        <div class="mobile-menu-item-content">
          <i class="mobile-menu-item-icon bi bi-box-arrow-right"></i>
          <div class="mobile-menu-item-text">
            <div class="mobile-menu-item-title">{{ t('logout', g.lang)|default('Выйти') }}</div>
            <div class="mobile-menu-item-subtitle">{{ t('logout_description', g.lang)|default('Выйти из аккаунта') }}</div>
          </div>
        </div>
        <i class="mobile-menu-item-arrow bi bi-chevron-right"></i>
      </a>
      
    </div>
  </div>

</div>

{% endblock %}

{% block mobile_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize toggles
  initializeToggles();
  
  // Initialize language selector
  initializeLanguageSelector();
  
  // Initialize danger zone actions
  initializeDangerZone();
  
  // Animate progress circle
  animateProgressCircle();
  
  // Initialize achievements
  initializeAchievements();
});

function initializeToggles() {
  // Theme toggle
  const themeToggle = document.getElementById('theme-toggle');
  const themeButton = document.getElementById('mobile-theme-toggle');
  
  if (themeToggle && themeButton) {
    const currentTheme = localStorage.getItem('theme') || 'light';
    themeToggle.classList.toggle('active', currentTheme === 'dark');
    
    themeButton.addEventListener('click', function() {
      if (window.mobileApp) {
        window.mobileApp.toggleTheme();
        themeToggle.classList.toggle('active');
      }
    });
  }
  
  // Notifications toggle
  const notificationsToggle = document.getElementById('notifications-toggle');
  const notificationsButton = document.getElementById('mobile-notifications-toggle');
  
  if (notificationsToggle && notificationsButton) {
    const notificationsEnabled = localStorage.getItem('notifications') === 'true';
    notificationsToggle.classList.toggle('active', notificationsEnabled);
    
    notificationsButton.addEventListener('click', function() {
      const isEnabled = notificationsToggle.classList.contains('active');
      const newState = !isEnabled;
      
      notificationsToggle.classList.toggle('active', newState);
      localStorage.setItem('notifications', newState.toString());
      
      if (newState) {
        requestNotificationPermission();
      }
      
      if (window.mobileApp) {
        window.mobileApp.showToast(
          newState ? 'Уведомления включены' : 'Уведомления отключены', 
          'success'
        );
      }
    });
  }
}

function requestNotificationPermission() {
  if ('Notification' in window) {
    Notification.requestPermission().then(function(permission) {
      if (permission === 'granted') {
        if (window.mobileApp) {
          window.mobileApp.showToast('Разрешение на уведомления получено', 'success');
        }
      } else {
        if (window.mobileApp) {
          window.mobileApp.showToast('Разрешение на уведомления отклонено', 'warning');
        }
      }
    });
  }
}

function initializeLanguageSelector() {
  const languageOptions = document.querySelectorAll('.mobile-language-option');
  
  languageOptions.forEach(option => {
    option.addEventListener('click', function(e) {
      e.preventDefault();
      
      const newLang = this.dataset.lang;
      const currentPath = window.location.pathname;
      const pathParts = currentPath.split('/');
      
      // Update URL language
      const supportedLangs = ['en', 'ru', 'nl', 'uk', 'es', 'pt', 'tr', 'fa'];
      if (pathParts.length > 1 && supportedLangs.includes(pathParts[1])) {
        pathParts[1] = newLang;
      } else {
        pathParts.splice(1, 0, newLang);
      }
      
      const newPath = pathParts.join('/');
      
      if (window.mobileApp) {
        window.mobileApp.showToast('Изменение языка...', 'info', 1000);
      }
      
      setTimeout(() => {
        window.location.href = newPath;
      }, 500);
    });
  });
}

function initializeDangerZone() {
  const clearDataBtn = document.getElementById('mobile-clear-data-btn');
  
  if (clearDataBtn) {
    clearDataBtn.addEventListener('click', function() {
      if (confirm('Вы уверены, что хотите очистить все данные? Это действие нельзя отменить.')) {
        if (window.mobileApp) {
          window.mobileApp.showToast('Очистка данных...', 'info');
        }
        
        // Clear local data
        localStorage.clear();
        sessionStorage.clear();
        
        // Send request to server to clear user progress
        fetch('/api/clear-user-data', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
          }
        }).then(response => response.json())
        .then(data => {
          if (data.success) {
            if (window.mobileApp) {
              window.mobileApp.showToast('Данные успешно очищены', 'success');
            }
            setTimeout(() => {
              window.location.reload();
            }, 1000);
          }
        }).catch(error => {
          console.error('Error clearing data:', error);
          if (window.mobileApp) {
            window.mobileApp.showToast('Ошибка при очистке данных', 'error');
          }
        });
      }
    });
  }
}

function animateProgressCircle() {
  const progressCircle = document.getElementById('mobile-progress-circle');
  if (progressCircle) {
    // Animate the circle on load
    const currentOffset = progressCircle.style.strokeDashoffset || progressCircle.getAttribute('stroke-dashoffset');
    progressCircle.style.strokeDashoffset = '314';
    
    setTimeout(() => {
      progressCircle.style.strokeDashoffset = currentOffset;
    }, 500);
  }
}

function initializeAchievements() {
  const achievements = document.querySelectorAll('.mobile-achievement');
  
  achievements.forEach(achievement => {
    achievement.addEventListener('click', function() {
      const title = this.querySelector('.mobile-achievement-title').textContent;
      const desc = this.querySelector('.mobile-achievement-desc').textContent;
      const isEarned = this.classList.contains('earned');
      
      let message = `${title}: ${desc}`;
      if (isEarned) {
        message += ' ✓ Получено!';
      } else {
        message += ' - Пока не получено';
      }
      
      if (window.mobileApp) {
        window.mobileApp.showToast(message, isEarned ? 'success' : 'info', 3000);
      }
    });
  });
}

// Handle offline/online status
window.addEventListener('offline', function() {
  if (window.mobileApp) {
    window.mobileApp.showToast('Оффлайн режим - некоторые функции недоступны', 'warning');
  }
});

window.addEventListener('online', function() {
  if (window.mobileApp) {
    window.mobileApp.showToast('Соединение восстановлено', 'success');
  }
});
</script>
{% endblock %}