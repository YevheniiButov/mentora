{% extends "mobile_base.html" %}

{% set nav_config = get_navigation_config('settings',
    show_logo=True,
    show_back_button=True,
    show_bottom_nav=True,
    show_profile_button=True,
    show_settings_button=False,
    show_language_selector=True,
    page_title=t('settings', lang)
) %}

{% block title %}{{ t('settings', lang) }} - {{ t('dental_academy', lang) }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/mobile-settings.css') }}">
{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- Заголовок -->
    <div class="settings-header">
        <h1>{{ t('settings', lang) or 'Настройки' }}</h1>
        <p class="settings-subtitle">{{ t('customize_your_experience', lang) or 'Настройте ваш опыт обучения' }}</p>
    </div>

    <!-- Индикатор загрузки -->
    <div class="loading-indicator" id="loadingIndicator">
        <div class="spinner"></div>
        <p>{{ t('loading_settings', lang) or 'Загрузка настроек...' }}</p>
    </div>

    <!-- Форма настроек -->
    <form id="settingsForm" class="settings-form" style="display: none;">
        
        <!-- Раздел: Внешний вид -->
        <div class="settings-section">
            <div class="section-header">
                <i class="bi bi-palette"></i>
                <h2>{{ t('appearance', lang) or 'Внешний вид' }}</h2>
            </div>
            
            <div class="setting-item">
                <label for="theme">{{ t('theme', lang) or 'Тема оформления' }}</label>
                <select id="theme" name="theme" class="setting-select">
                    <option value="auto">{{ t('auto', lang) or 'Автоматическая' }}</option>
                    <option value="light">{{ t('light', lang) or 'Светлая' }}</option>
                    <option value="dark">{{ t('dark', lang) or 'Темная' }}</option>
                </select>
            </div>

            <div class="setting-item">
                <label for="fontSize">{{ t('font_size', lang) or 'Размер шрифта' }}</label>
                <select id="fontSize" name="font_size" class="setting-select">
                    <option value="small">{{ t('small', lang) or 'Маленький' }}</option>
                    <option value="medium">{{ t('medium', lang) or 'Средний' }}</option>
                    <option value="large">{{ t('large', lang) or 'Большой' }}</option>
                </select>
            </div>

            <div class="setting-item">
                <label for="language">{{ t('interface_language', lang) or 'Язык интерфейса' }}</label>
                <select id="language" name="language" class="setting-select">
                    <option value="en">English</option>
                    <option value="ru">Русский</option>
                    <option value="nl">Nederlands</option>
                    <option value="uk">Українська</option>
                    <option value="es">Español</option>
                    <option value="pt">Português</option>
                    <option value="tr">Türkçe</option>
                    <option value="fa">فارسی</option>
                    <option value="ar">العربية</option>
                </select>
            </div>
        </div>

        <!-- Раздел: AI и интеграции -->
        <div class="settings-section">
            <div class="section-header">
                <i class="bi bi-robot"></i>
                <h2>{{ t('ai_integrations', lang) or 'AI и интеграции' }}</h2>
            </div>
            
            <div class="setting-item">
                <label for="openaiKey">{{ t('openai_api_key', lang) or 'OpenAI API ключ' }}</label>
                <div class="input-group">
                    <input type="password" id="openaiKey" name="openai_key" 
                           placeholder="sk-..." class="setting-input"
                           autocomplete="off">
                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility('openaiKey')">
                        <i class="bi bi-eye" id="openaiKeyIcon"></i>
                    </button>
                </div>
                <small class="help-text">{{ t('openai_key_help', lang) or 'Используется для персонализированных AI рекомендаций' }}</small>
            </div>

            <div class="setting-item">
                <div class="setting-toggle">
                    <label class="toggle-label">
                        <span>{{ t('ai_suggestions', lang) or 'AI подсказки' }}</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="aiSuggestions" name="ai_suggestions">
                            <span class="slider"></span>
                        </div>
                    </label>
                </div>
                <small class="help-text">{{ t('ai_suggestions_help', lang) or 'Получать персонализированные рекомендации по обучению' }}</small>
            </div>

            <div class="setting-item">
                <div class="setting-toggle">
                    <label class="toggle-label">
                        <span>{{ t('personalized_learning', lang) or 'Персонализация обучения' }}</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="personalizedLearning" name="personalized_learning">
                            <span class="slider"></span>
                        </div>
                    </label>
                </div>
                <small class="help-text">{{ t('personalized_learning_help', lang) or 'Адаптация контента под ваш уровень знаний' }}</small>
            </div>
        </div>

        <!-- Раздел: Уведомления -->
        <div class="settings-section">
            <div class="section-header">
                <i class="bi bi-bell"></i>
                <h2>{{ t('notifications', lang) or 'Уведомления' }}</h2>
            </div>
            
            <div class="setting-item">
                <div class="setting-toggle">
                    <label class="toggle-label">
                        <span>{{ t('push_notifications', lang) or 'Push-уведомления' }}</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="pushNotifications" name="push_notifications">
                            <span class="slider"></span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-toggle">
                    <label class="toggle-label">
                        <span>{{ t('daily_reminders', lang) or 'Ежедневные напоминания' }}</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="dailyReminders" name="daily_reminders">
                            <span class="slider"></span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <label for="reminderTime">{{ t('reminder_time', lang) or 'Время напоминаний' }}</label>
                <input type="time" id="reminderTime" name="reminder_time" 
                       value="09:00" class="setting-input">
            </div>

            <div class="setting-item">
                <div class="setting-toggle">
                    <label class="toggle-label">
                        <span>{{ t('progress_notifications', lang) or 'Уведомления о прогрессе' }}</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="progressNotifications" name="progress_notifications">
                            <span class="slider"></span>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <!-- Раздел: Обучение -->
        <div class="settings-section">
            <div class="section-header">
                <i class="bi bi-book"></i>
                <h2>{{ t('learning', lang) or 'Обучение' }}</h2>
            </div>
            
            <div class="setting-item">
                <div class="setting-toggle">
                    <label class="toggle-label">
                        <span>{{ t('auto_play_videos', lang) or 'Автовоспроизведение видео' }}</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="autoPlayVideos" name="auto_play_videos">
                            <span class="slider"></span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <div class="setting-toggle">
                    <label class="toggle-label">
                        <span>{{ t('offline_mode', lang) or 'Оффлайн режим' }}</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="offlineMode" name="offline_mode">
                            <span class="slider"></span>
                        </div>
                    </label>
                </div>
                <small class="help-text">{{ t('offline_mode_help', lang) or 'Сохранять контент для просмотра без интернета' }}</small>
            </div>

            <div class="setting-item">
                <label for="dailyGoal">{{ t('daily_goal', lang) or 'Дневная цель' }} (<span id="dailyGoalValue">3</span> {{ t('lessons', lang) or 'урока' }})</label>
                <input type="range" id="dailyGoal" name="daily_goal" 
                       min="1" max="20" value="3" class="setting-range">
                <div class="range-labels">
                    <span>1</span>
                    <span>20</span>
                </div>
            </div>

            <div class="setting-item">
                <label for="contentDifficulty">{{ t('content_difficulty', lang) or 'Сложность контента' }}</label>
                <select id="contentDifficulty" name="content_difficulty" class="setting-select">
                    <option value="beginner">{{ t('beginner', lang) or 'Новичок' }}</option>
                    <option value="intermediate">{{ t('intermediate', lang) or 'Средний' }}</option>
                    <option value="advanced">{{ t('advanced', lang) or 'Продвинутый' }}</option>
                </select>
            </div>
        </div>

        <!-- Раздел: Приватность и безопасность -->
        <div class="settings-section">
            <div class="section-header">
                <i class="bi bi-shield-check"></i>
                <h2>{{ t('privacy_security', lang) or 'Приватность и безопасность' }}</h2>
            </div>
            
            <div class="setting-item">
                <div class="setting-toggle">
                    <label class="toggle-label">
                        <span>{{ t('analytics_data_collection', lang) or 'Аналитика и сбор данных' }}</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="analyticsEnabled" name="analytics_enabled">
                            <span class="slider"></span>
                        </div>
                    </label>
                </div>
                <small class="help-text">{{ t('analytics_help', lang) or 'Помогает нам улучшить приложение' }}</small>
            </div>

            <div class="setting-item">
                <div class="setting-toggle">
                    <label class="toggle-label">
                        <span>{{ t('data_sharing', lang) or 'Обмен данными с партнерами' }}</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="dataSharing" name="data_sharing">
                            <span class="slider"></span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <button type="button" class="action-button secondary" onclick="clearCache()">
                    <i class="bi bi-trash"></i>
                    {{ t('clear_app_cache', lang) or 'Очистить кэш приложения' }}
                </button>
                <small class="help-text">{{ t('clear_cache_help', lang) or 'Освободит место на устройстве' }}</small>
            </div>

            <div class="setting-item">
                <button type="button" class="action-button danger" onclick="showDataExportModal()">
                    <i class="bi bi-download"></i>
                    {{ t('export_delete_data', lang) or 'Экспорт/удаление данных' }}
                </button>
                <small class="help-text">{{ t('data_export_help', lang) or 'Скачать или удалить ваши персональные данные' }}</small>
            </div>
        </div>

        <!-- Кнопки действий -->
        <div class="settings-actions">
            <button type="button" class="action-button secondary" onclick="resetToDefaults()">
                <i class="bi bi-arrow-clockwise"></i>
                {{ t('reset_to_defaults', lang) or 'Сбросить к настройкам по умолчанию' }}
            </button>
            
            <button type="submit" class="action-button primary" id="saveButton">
                <i class="bi bi-check-lg"></i>
                {{ t('save_changes', lang) or 'Сохранить изменения' }}
            </button>
        </div>
    </form>

    <!-- Уведомления -->
    <div id="notification" class="notification" style="display: none;">
        <div class="notification-content">
            <i class="notification-icon"></i>
            <span class="notification-text"></span>
        </div>
    </div>
</div>

<!-- Модальное окно экспорта данных -->
<div id="dataExportModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>{{ t('data_management', lang) or 'Управление данными' }}</h3>
            <button class="modal-close" onclick="hideDataExportModal()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>{{ t('data_export_description', lang) or 'Вы можете экспортировать или удалить свои персональные данные в соответствии с правилами GDPR.' }}</p>
            
            <div class="data-action">
                <button class="action-button primary" onclick="exportUserData()">
                    <i class="bi bi-download"></i>
                    {{ t('export_data', lang) or 'Экспортировать данные' }}
                </button>
                <small>{{ t('export_data_help', lang) or 'Скачать архив со всеми вашими данными' }}</small>
            </div>
            
            <div class="data-action">
                <button class="action-button danger" onclick="confirmDeleteAccount()">
                    <i class="bi bi-trash"></i>
                    {{ t('delete_account', lang) or 'Удалить аккаунт' }}
                </button>
                <small>{{ t('delete_account_help', lang) or 'Полностью удалить аккаунт и все данные' }}</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/mobile-settings.js') }}"></script>
<script>
    // Инициализация настроек
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof MobileSettings !== 'undefined') {
            window.settingsManager = new MobileSettings({
                lang: '{{ lang }}',
                apiEndpoint: '{{ url_for("mobile.api_get_settings", lang=lang) }}',
                saveEndpoint: '{{ url_for("mobile.api_save_settings", lang=lang) }}',
                openaiKeyEndpoint: '{{ url_for("mobile.api_save_openai_key", lang=lang) }}',
                resetEndpoint: '{{ url_for("mobile.api_reset_settings", lang=lang) }}',
                clearCacheEndpoint: '{{ url_for("mobile.api_clear_cache", lang=lang) }}'
            });
        }
    });
</script>
{% endblock %} 