{% extends "base.html" %}
{% block title %}Создать новую тему{% endblock %}

{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/forum.css') }}">
<!-- Подключаем SimpleMDE для редактора Markdown -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
{% endblock %}

{% block content %}
<div class="container main-content-padding pt-4 forum-page-content"><div class="container py-4 main-content-padding">

    <div class="row justify-content-center">
        <div class="col-lg-9 col-md-11">
            <!-- Навигационные хлебные крошки -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('main_bp.index', lang=lang) }}">Главная</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('forum_bp.forum_home', lang=lang) }}">Форум</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Создать тему</li>
                </ol>
            </nav>
            
            <div class="card shadow-sm border-0 rounded-3">
                <div class="card-header bg-white py-3 border-bottom">
                    <h1 class="fs-3 mb-0">Создание новой темы</h1>
                </div>
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('forum_bp.new_topic', lang=lang) }}" novalidate>
                        {{ form.hidden_tag() }}
                        
                        <!-- Название темы -->
                        <div class="mb-4">
                            {{ form.title.label(class="form-label fw-semibold") }}
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="bi bi-chat-left-text"></i>
                                </span>
                                {{ form.title(class="form-control border-start-0" + (" is-invalid" if form.title.errors else ""), placeholder="Введите название темы...") }}
                            </div>
                            {% if form.title.errors %}
                            <div class="invalid-feedback d-block mt-1">
                                {% for error in form.title.errors %}
                                <div><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text mt-1">Хорошее название темы привлекает больше участников дискуссии.</div>
                        </div>
                        
                        <!-- Категория -->
                        <div class="mb-4">
                            <label for="category" class="form-label fw-semibold">Категория</label>
                            <select class="form-select" id="category" name="category">
                                <option value="" selected>Выберите категорию...</option>
                                <option value="general">Общие вопросы</option>
                                <option value="tutorials">Учебные материалы</option>
                                <option value="questions">Вопросы и ответы</option>
                                <option value="events">События и анонсы</option>
                            </select>
                            <div class="form-text">Выберите подходящую категорию для вашей темы.</div>
                        </div>
                        
                        <!-- Метки -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">Метки</label>
                            <input type="text" class="form-control" id="tags" name="tags" 
                                   placeholder="Например: обучение, стоматология, советы (разделяйте запятыми)">
                            <div class="form-text">Метки помогают другим пользователям найти вашу тему. Добавьте до 5 меток.</div>
                        </div>
                        
                        <!-- Текст сообщения -->
                        <div class="mb-4">
                            {{ form.body.label(class="form-label fw-semibold") }}
                            <div class="editor-toolbar-info small mb-1">
                                <span class="text-muted">Поддерживается Markdown и базовое форматирование</span>
                                <button type="button" class="btn btn-sm btn-link p-0 ms-2" 
                                        data-bs-toggle="modal" data-bs-target="#markdownHelp">
                                    Справка по форматированию
                                </button>
                            </div>
                            {{ form.body(class="form-control markdown-editor" + (" is-invalid" if form.body.errors else ""), rows="12", placeholder="Опишите вашу тему подробно...") }}
                            {% if form.body.errors %}
                            <div class="invalid-feedback d-block mt-1">
                                {% for error in form.body.errors %}
                                <div><i class="bi bi-exclamation-circle me-1"></i>{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- Настройки темы -->
                        <div class="mb-4">
                            <div class="form-label fw-semibold">Настройки темы</div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notify" name="notify" checked>
                                <label class="form-check-label" for="notify">
                                    Получать уведомления об ответах в этой теме
                                </label>
                            </div>
                        </div>
                        
                        <!-- Предпросмотр и кнопки управления -->
                        <div class="d-flex flex-column flex-sm-row justify-content-between">
                            <a href="{{ url_for('forum_bp.forum_home', lang=lang) }}" class="btn btn-outline-secondary mb-3 mb-sm-0">
                                <i class="bi bi-arrow-left me-1"></i> Вернуться
                            </a>
                            <div>
                                <button type="button" id="preview-btn" class="btn btn-outline-primary me-2">
                                    <i class="bi bi-eye me-1"></i> Предпросмотр
                                </button>
                                {{ form.submit(class="btn btn-primary px-4") }}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Контейнер для предпросмотра -->
            <div id="preview-container" class="card shadow-sm border-0 rounded-3 mt-4 d-none">
                <div class="card-header bg-white py-3 border-bottom">
                    <h3 class="fs-4 mb-0">Предпросмотр</h3>
                </div>
                <div class="card-body p-4">
                    <h4 id="preview-title" class="mb-3"></h4>
                    <div id="preview-content" class="forum-post-card post-content"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно с помощью по Markdown -->
<div class="modal fade" id="markdownHelp" tabindex="-1" aria-labelledby="markdownHelpLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="markdownHelpLabel">Справка по форматированию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6>Базовое форматирование</h6>
                        <ul class="list-unstyled">
                            <li><code>**жирный текст**</code> → <strong>жирный текст</strong></li>
                            <li><code>*курсив*</code> → <em>курсив</em></li>
                            <li><code>[ссылка](https://example.com)</code> → <a href="#">ссылка</a></li>
                        </ul>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>Списки</h6>
                        <ul class="list-unstyled">
                            <li><code>* Пункт списка</code> → Маркированный список</li>
                            <li><code>1. Пункт списка</code> → Нумерованный список</li>
                        </ul>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6>Заголовки</h6>
                        <ul class="list-unstyled">
                            <li><code># Заголовок 1</code></li>
                            <li><code>## Заголовок 2</code></li>
                            <li><code>### Заголовок 3</code></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>Цитаты и код</h6>
                        <ul class="list-unstyled">
                            <li><code>> Цитата</code> → Блок цитаты</li>
                            <li><code>`код`</code> → <code>код</code></li>
                            <li><code>```код в несколько строк```</code> → Блок кода</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Инициализация SimpleMDE редактора
        var simplemde = new SimpleMDE({
            element: document.querySelector(".markdown-editor"),
            spellChecker: false,
            status: false,
            toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list", "|", "link", "image", "code", "table", "|", "preview", "side-by-side", "fullscreen"],
            placeholder: "Опишите вашу тему подробно...",
        });
        
        // Функция предпросмотра
        document.getElementById('preview-btn').addEventListener('click', function() {
            var previewContainer = document.getElementById('preview-container');
            var previewTitle = document.getElementById('preview-title');
            var previewContent = document.getElementById('preview-content');
            var titleInput = document.querySelector('input[name="title"]');
            
            // Получаем данные из формы
            var title = titleInput.value.trim();
            var content = simplemde.value();
            
            // Проверяем, что есть что показывать
            if (!title && !content) {
                alert('Введите название и содержание темы для предпросмотра');
                return;
            }
            
            // Показываем контейнер предпросмотра
            previewContainer.classList.remove('d-none');
            
            // Заполняем данные
            previewTitle.textContent = title || 'Название темы';
            previewContent.innerHTML = marked.parse(content || 'Содержание темы...');
            
            // Прокручиваем к предпросмотру
            previewContainer.scrollIntoView({ behavior: 'smooth' });
        });
    });
</script>
{% endblock %}