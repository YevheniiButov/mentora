{% extends "base.html" %}

{% block title %}{{ t('assessment_results_title', lang) | default('Результаты оценки') }} - Dental Academy{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/assessment.css') }}">
{% endblock %}

{% block content %}
<div class="assessment-container">
    <div class="assessment-card">
        <!-- Заголовок результатов -->
        <div class="assessment-header">
            <h1>{{ t('assessment_results_title', lang) | default('Результаты оценки') }}</h1>
            <p>{{ t('assessment_completed', lang) | default('Оценка завершена') }} - {{ completion_date }}</p>
        </div>
        
        <!-- Основной контент -->
        <div class="results-section">
            <!-- Общий результат -->
            <div class="results-grid">
                <div class="score-overview">
                    <div class="score-circle-modern" style="--score-angle: {{ results.overall_score * 3.6 }}deg">
                        <div class="score-value">{{ results.overall_score }}%</div>
                    </div>
                    <div class="score-status status-{{ results.skill_level | lower }}">
                        <i class="bi bi-check-circle"></i>
                        {{ results.skill_level }}
                    </div>
                </div>
                
                <div class="quick-stats">
                    <div class="stat-item">
                        <div class="stat-value">{{ results.correct_answers }}/{{ results.total_questions }}</div>
                        <div class="stat-label">{{ t('correct_answers', lang) | default('Правильно') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ results.completion_time }}</div>
                        <div class="stat-label">{{ t('completion_time', lang) | default('Время') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ results.accuracy }}%</div>
                        <div class="stat-label">{{ t('accuracy', lang) | default('Точность') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ results.total_questions }}</div>
                        <div class="stat-label">{{ t('total_questions', lang) | default('Вопросов') }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Результаты по категориям -->
            <div class="category-breakdown">
                <h3>{{ t('category_results', lang) | default('Результаты по категориям') }}</h3>
                {% for category in results.categories %}
                <div class="category-item">
                    <div class="category-icon" style="background: {{ category.gradient }};">
                        <i class="bi bi-{{ category.icon }}"></i>
                    </div>
                    <div class="category-info">
                        <div class="category-name">{{ category.category_name }}</div>
                        <div class="category-bar">
                            <div class="category-fill" style="width: {{ category.score }}%"></div>
                        </div>
                    </div>
                    <div class="category-score">{{ category.score }}%</div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Рекомендации -->
            <div class="recommendations-section">
                <h3>{{ t('recommendations', lang) | default('Рекомендации') }}</h3>
                {% for recommendation in results.recommendations %}
                <div class="recommendation-item">
                    <div class="recommendation-icon" style="background: {{ recommendation.gradient }};">
                        <i class="bi bi-{{ recommendation.icon }}"></i>
                    </div>
                    <div class="recommendation-content">
                        <div class="recommendation-title">{{ recommendation.title }}</div>
                        <div class="recommendation-description">{{ recommendation.description }}</div>
                        <div class="recommendation-meta">
                            <span><i class="bi bi-clock"></i> {{ recommendation.duration }}</span>
                            <span><i class="bi bi-people"></i> {{ recommendation.difficulty }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Действия -->
            <div class="actions-section">
                <button class="btn-create-plan" onclick="createLearningPlan()">
                    <i class="bi bi-plus-circle"></i>
                    {{ t('create_learning_plan', lang) | default('Создать план обучения') }}
                </button>
                
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="retakeAssessment()">
                        <i class="bi bi-arrow-repeat"></i>
                        {{ t('retake_assessment', lang) | default('Пересдать оценку') }}
                    </button>
                    
                    <button class="btn btn-secondary" onclick="viewDetailedResults()">
                        <i class="bi bi-graph-up"></i>
                        {{ t('view_detailed_results', lang) | default('Подробные результаты') }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Анимация появления результатов
document.addEventListener('DOMContentLoaded', function() {
    // Анимация прогресс-баров
    const progressBars = document.querySelectorAll('.category-fill');
    progressBars.forEach((bar, index) => {
        setTimeout(() => {
            const width = bar.style.width;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.width = width;
            }, 100);
        }, index * 200);
    });
    
    // Анимация появления карточек
    const cards = document.querySelectorAll('.category-item, .recommendation-item');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});

// Функции действий
function createLearningPlan() {
    window.location.href = '{{ url_for("assessment_bp.create_learning_plan", lang=lang, attempt_id=attempt.id) }}';
}

function retakeAssessment() {
    if (confirm('{{ t("retake_confirmation", lang) | default("Вы уверены, что хотите пересдать оценку?") }}')) {
        window.location.href = '{{ url_for("assessment_bp.intro", lang=lang) }}';
    }
}

function viewDetailedResults() {
    // Открыть модальное окно с подробными результатами
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <h3>{{ t('detailed_results', lang) | default('Подробные результаты') }}</h3>
                <button onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="detailed-stats">
                    <h4>{{ t('performance_breakdown', lang) | default('Детализация производительности') }}</h4>
                    <div class="stats-table">
                        <div class="stat-row">
                            <span>{{ t('total_time', lang) | default('Общее время') }}</span>
                            <span>{{ results.completion_time }}</span>
                        </div>
                        <div class="stat-row">
                            <span>{{ t('average_time_per_question', lang) | default('Среднее время на вопрос') }}</span>
                            {% if results.time_spent is number and results.total_questions %}
                                <span>{{ (results.time_spent / results.total_questions) | round(1) }} сек</span>
                            {% else %}
                                <span>{{ results.time_spent }}</span>
                            {% endif %}
                        </div>
                        <div class="stat-row">
                            <span>{{ t('questions_answered', lang) | default('Отвечено вопросов') }}</span>
                            <span>{{ results.correct_answers + (results.incorrect_answers if results.incorrect_answers is defined else 0) }}</span>
                        </div>
                        <div class="stat-row">
                            <span>{{ t('questions_skipped', lang) | default('Пропущено вопросов') }}</span>
                            <span>{{ results.total_questions - (results.correct_answers + (results.incorrect_answers if results.incorrect_answers is defined else 0)) }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="category-details">
                    <h4>{{ t('category_analysis', lang) | default('Анализ по категориям') }}</h4>
                    {% for category in results.categories %}
                    <div class="category-detail">
                        <div class="category-header">
                            <span class="category-name">{{ category.category_name }}</span>
                            <span class="category-score">{{ category.score }}%</span>
                        </div>
                        <div class="category-stats">
                            <span>{{ category.correct }}/{{ category.total }} {{ t('correct', lang) | default('правильно') }}</span>
                            <span>{{ category.time_spent }} {{ t('seconds', lang) | default('секунд') }}</span>
                        </div>
                        <div class="category-description">{{ category.description }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Добавляем стили для модального окна
const modalStyles = document.createElement('style');
modalStyles.textContent = `
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .modal-content {
        background: white;
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .stats-table {
        margin: 20px 0;
    }
    
    .stat-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .category-detail {
        margin: 15px 0;
        padding: 15px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
    }
`;
document.head.appendChild(modalStyles);
</script>
{% endblock %}
