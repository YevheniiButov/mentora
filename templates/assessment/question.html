{% extends "base.html" %}

{% block title %}{{ t('question', lang) | default('Вопрос') }} {{ question_num }} {{ t('of', lang) | default('из') }} {{ total_questions }} - Dental Academy{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/assessment.css') }}">
<style>
/* Критически важные стили для опций с высокой специфичностью */
.assessment-container .options-grid .option {
  display: grid !important;
  grid-template-columns: auto 1fr !important;
  gap: 12px !important;
  padding: 16px !important;
  border: 2px solid #e5e7eb !important;
  border-radius: 8px !important;
  cursor: pointer !important;
  transition: all 0.15s ease !important;
  background: white !important;
  margin-bottom: 8px !important;
  position: relative !important;
  z-index: 10 !important;
  user-select: none !important;
}

.assessment-container .options-grid .option:hover {
  border-color: #93c5fd !important;
  background: #eff6ff !important;
  transform: translateY(-1px) !important;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1) !important;
}

.assessment-container .options-grid .option.selected {
  border-color: #3b82f6 !important;
  background: #eff6ff !important;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
}

.assessment-container .options-grid .option .option-letter {
  width: 32px !important;
  height: 32px !important;
  background: #f3f4f6 !important;
  color: #374151 !important;
  border-radius: 6px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-weight: 600 !important;
  font-size: 14px !important;
  transition: all 0.15s ease !important;
}

.assessment-container .options-grid .option.selected .option-letter {
  background: #3b82f6 !important;
  color: white !important;
}

.assessment-container .options-grid .option .option-text {
  font-size: 16px !important;
  color: #111827 !important;
  line-height: 1.5 !important;
  align-self: center !important;
}

/* Убеждаемся, что опции кликабельны */
.assessment-container .options-grid .option * {
  pointer-events: none !important;
}

.assessment-container .options-grid .option {
  pointer-events: auto !important;
}
</style>
{% endblock %}

{% block content %}
<div class="assessment-container">
    <div class="assessment-card">
        <!-- Заголовок с прогрессом -->
        <div class="assessment-header">
            <h1>{{ t('assessment_title', lang) | default('Оценка знаний') }}</h1>
            <p>{{ t('question_progress', lang) | default('Вопрос') }} {{ question_num }} {{ t('of', lang) | default('из') }} {{ total_questions }}</p>
        </div>
        
        <!-- Прогресс секция -->
        <div class="progress-section">
            <div class="progress-header">
                <div class="progress-info">
                    <div class="progress-circle">
                        <span>{{ (question_num / total_questions * 100) | round }}%</span>
                    </div>
                    <div class="progress-text">
                        <div class="progress-title">{{ t('progress', lang) | default('Прогресс') }}</div>
                        <div class="progress-subtitle">{{ question_num }} / {{ total_questions }}</div>
                    </div>
                </div>
                <div class="timer-badge" id="timer">
                    <i class="bi bi-clock"></i>
                    <span id="time-remaining">
                        <span id="minutes">--</span>:<span id="seconds">--</span>
                    </span>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ (question_num / total_questions * 100) | round }}%"></div>
            </div>
        </div>
        
        <!-- Контент вопроса -->
        <div class="question-section">
            <div class="question-header">
                <div class="question-number">{{ question_num }}</div>
                <div class="question-category">{{ question.category.name if question.category else 'Общие знания' }}</div>
                <div class="question-difficulty difficulty-{{ 'medium' if question.difficulty_level == 3 else 'easy' if question.difficulty_level <= 2 else 'hard' }}">
                    {% if question.difficulty_level == 1 %}Новичок
                    {% elif question.difficulty_level == 2 %}Начинающий
                    {% elif question.difficulty_level == 3 %}Средний
                    {% elif question.difficulty_level == 4 %}Продвинутый
                    {% elif question.difficulty_level == 5 %}Эксперт
                    {% else %}Средний{% endif %}
                </div>
            </div>
            
            <div class="question-text">
                {{ question.question_text }}
            </div>
            
            <div class="options-grid">
                {% for option in question.get_options() %}
                <div class="option" data-option-index="{{ loop.index0 }}" onclick="selectOption(this, {{ loop.index0 }})">
                    <div class="option-letter">{{ ['A', 'B', 'C', 'D'][loop.index0] }}</div>
                    <div class="option-text">{{ option }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Контрольные кнопки -->
        <div class="controls-section">
            {% if question_num > 1 %}
            <button class="btn btn-secondary" onclick="previousQuestion()">
                <i class="bi bi-arrow-left"></i>
                {{ t('previous', lang) | default('Назад') }}
            </button>
            {% else %}
            <button class="btn btn-secondary" onclick="exitAssessment()">
                <i class="bi bi-x-circle"></i>
                {{ t('exit', lang) | default('Выйти') }}
            </button>
            {% endif %}
            
            <div class="question-counter">
                {{ question_num }} / {{ total_questions }}
            </div>
            
            {% if question_num < total_questions %}
            <button class="btn btn-primary" id="next-btn" disabled onclick="nextQuestion()">
                {{ t('next', lang) | default('Далее') }}
                <i class="bi bi-arrow-right"></i>
            </button>
            {% else %}
            <button class="btn btn-success" id="finish-btn" disabled onclick="finishAssessment()">
                {{ t('finish', lang) | default('Завершить') }}
                <i class="bi bi-check-circle"></i>
            </button>
            {% endif %}
        </div>
    </div>
</div>

<script>
console.log('Assessment script loaded');

let selectedOption = null;
let startTime = Date.now();
let timeLimit = {{ remaining_time | default(3600) }}; // Время из маршрута

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing assessment...');
    
    // Инициализируем таймер
    initTimer();
    
    // Добавляем обработчики событий для всех опций
    const options = document.querySelectorAll('.option');
    console.log('Found options:', options.length);
    
    options.forEach((option, index) => {
        console.log('Adding click handler to option', index);
        
        // Добавляем несколько типов обработчиков для надежности
        option.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Option clicked:', index);
            selectOption(this, index);
        });
        
        option.addEventListener('touchstart', function(e) {
            e.preventDefault();
            console.log('Option touched:', index);
            selectOption(this, index);
        });
    });
    
    // Восстанавливаем выбранный ответ, если он был
    {% if existing_answer %}
    const savedAnswer = {{ existing_answer.user_answer | default('null') }};
    if (savedAnswer !== null) {
        selectOption(document.querySelectorAll('.option')[savedAnswer], savedAnswer);
    }
    {% endif %}
});

// Инициализация таймера
function initTimer() {
    updateTimer();
    setInterval(updateTimer, 1000);
}

function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const remaining = timeLimit - elapsed;
    
    if (remaining <= 0) {
        finishAssessment();
        return;
    }
    
    const minutes = Math.floor(remaining / 60);
    const seconds = remaining % 60;
    
    document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
    document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
    
    // Изменение цвета таймера при приближении к концу
    const timer = document.getElementById('timer');
    timer.classList.remove('warning', 'danger');
    if (remaining <= 300) { // 5 минут
        timer.classList.add('danger');
    } else if (remaining <= 600) { // 10 минут
        timer.classList.add('warning');
    }
}

// Выбор варианта ответа
function selectOption(element, optionIndex) {
    console.log('selectOption called with:', element, optionIndex);
    
    // Убираем выделение со всех опций
    document.querySelectorAll('.option').forEach(opt => {
        opt.classList.remove('selected');
    });
    
    // Выделяем выбранную опцию
    element.classList.add('selected');
    selectedOption = optionIndex;
    
    console.log('Selected option:', selectedOption);
    
    // Активируем кнопку "Далее"
    const nextBtn = document.getElementById('next-btn');
    const finishBtn = document.getElementById('finish-btn');
    if (nextBtn) {
        nextBtn.disabled = false;
        console.log('Next button enabled');
    }
    if (finishBtn) {
        finishBtn.disabled = false;
        console.log('Finish button enabled');
    }
}

// Отключение beforeunload
function disableBeforeUnload() {
    window.removeEventListener('beforeunload', beforeUnloadHandler);
}

// Обработчик beforeunload (вынос в отдельную функцию для удобства)
function beforeUnloadHandler(e) {
    if (selectedOption !== null) {
        e.preventDefault();
        e.returnValue = '';
    }
}
window.addEventListener('beforeunload', beforeUnloadHandler);

// Навигация по вопросам
function nextQuestion() {
    if (selectedOption === null) return;
    disableBeforeUnload();
    saveAnswer();
    window.location.href = '{{ url_for("assessment_bp.question", lang=lang, question_num=question_num + 1) }}';
}

function previousQuestion() {
    disableBeforeUnload();
    window.location.href = '{{ url_for("assessment_bp.question", lang=lang, question_num=question_num - 1) }}';
}

function finishAssessment() {
    if (selectedOption !== null) {
        disableBeforeUnload();
        saveAnswer();
    }
    disableBeforeUnload();
    window.location.href = '{{ url_for("assessment_bp.complete", lang=lang) }}';
}

function exitAssessment() {
    disableBeforeUnload();
    if (confirm('{{ t("exit_confirmation", lang) | default("Вы уверены, что хотите выйти? Прогресс будет потерян.") }}')) {
        window.location.href = '{{ url_for("assessment_bp.intro", lang=lang) }}';
    }
}

// Сохранение ответа
function saveAnswer() {
    fetch('{{ url_for("assessment_bp.submit_answer", lang=lang) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify({
            question_id: {{ question.id }},
            answer: selectedOption,
            time_spent: Math.floor((Date.now() - startTime) / 1000)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('Error saving answer:', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}
</script>
{% endblock %}
