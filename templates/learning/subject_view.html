{% extends "base.html" %}

{% block title %}{{ t('learning_map', lang) }} - Become a Tandarts{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/learning_map.css') }}">

<style>
  /* Принудительные стили для кнопок разделов */
  .learning-path-button[data-path="1"], button[data-path="1"], .knowledge-center {
    background: linear-gradient(135deg, #3498db, #2980b9) !important;
    color: white !important;
  }
  .learning-path-button[data-path="2"], button[data-path="2"], .communication {
    background: linear-gradient(135deg, #7d5fff, #5352ed) !important;
    color: white !important;
  }
  .learning-path-button[data-path="3"], button[data-path="3"], .preclinical {
    background: linear-gradient(135deg, #4EB5B1, #3a8c88) !important;
    color: white !important;
  }
  .learning-path-button[data-path="4"], button[data-path="4"], .workstation {
    background: linear-gradient(135deg, #ff7675, #e74c3c) !important;
    color: white !important;
  }
  .learning-path-button[data-path="5"], button[data-path="5"], .bi-toets {
    background: linear-gradient(135deg, #f1c40f, #f39c12) !important;
    color: white !important;
  }
  .learning-path-button[data-path="6"], button[data-path="6"], .virtual-patients {
    background: linear-gradient(135deg, #667eea, #764ba2) !important;
    color: white !important;
  }

  /* Стили для сетки предметов */
  .subjects-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 1.5rem;
  }
  .subject-card {
    border-radius: var(--radius-xl, 16px);
    overflow: hidden;
    box-shadow: var(--shadow-md, 0 4px 16px rgba(0,0,0,0.08));
    transition: transform 0.3s, box-shadow 0.3s;
  }
  .subject-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg, 0 8px 24px rgba(0,0,0,0.12));
  }
  .subject-link {
    display: block;
    text-decoration: none;
    color: white;
  }

  /* Дополнительные стили для улучшенного приветственного экрана */
  .welcome-recommendations { margin-top: 2rem; }
  .recommendations-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-top: 1.5rem; }
  .recommendation-card { border-radius: 16px; padding: 1.25rem; color: white; position: relative; overflow: hidden; transition: transform 0.3s, box-shadow 0.3s; }
  .recommendation-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.15), transparent 70%); pointer-events: none; }
  .blue-gradient { background: linear-gradient(135deg, #3498db, #2980b9); }
  .purple-gradient { background: linear-gradient(135deg, #7d5fff, #5352ed); }
  .teal-gradient { background: linear-gradient(135deg, #4EB5B1, #3a8c88); }
  .recommendation-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); }
  .recommendation-icon { width: 40px; height: 40px; background-color: rgba(255, 255, 255, 0.15); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem; font-size: 1.25rem; }
  .recommendation-content h4 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
  .recommendation-content p { font-size: 0.9rem; opacity: 0.9; margin-bottom: 1.25rem; }
  .rec-button { background-color: rgba(255, 255, 255, 0.15); border: none; color: white; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.2s, transform 0.2s; }
  .rec-button:hover { background-color: rgba(255, 255, 255, 0.25); transform: translateY(-2px); }
  .rec-button:active { transform: scale(0.98); }

  /* Глобальный лоадер */
  .global-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background-color: rgba(255, 255, 255, 0.8); z-index: 9999; }
  .spinner { width: 50px; height: 50px; border: 5px solid rgba(62, 205, 193, 0.2); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s ease-in-out infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Статический пульсирующий логотип */
  .static-favicon-logo {
    width: 80px;
    height: 80px;
    animation: pulse-logo 2s infinite;
    filter: drop-shadow(0 4px 20px rgba(62, 205, 193, 0.3));
  }
  
  @keyframes pulse-logo {
    0%, 100% { 
      transform: scale(1);
      opacity: 1;
    }
    50% { 
      transform: scale(1.1);
      opacity: 0.8;
    }
  }

  /* Интерактивная карточка */
  .interactive-element { perspective: 1000px; margin: 2rem auto; max-width: 400px; }
  .interactive-card { position: relative; width: 100%; height: 200px; transition: transform 0.8s; transform-style: preserve-3d; cursor: pointer; }
  .interactive-card.flipped { transform: rotateY(180deg); }
  .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 16px; padding: 2rem; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
  .card-front { background: linear-gradient(135deg, #3ECDC1, #2BB6AC); color: white; }
  .card-back { background: linear-gradient(135deg, #6C5CE7, #8983F3); color: white; transform: rotateY(180deg); }
</style>
{% endblock %}

{% block content %}
<div class="learning-map-container">
    <div class="main-container">
        <div class="left-column">
            <div class="section-header">
                <h2>{{ t('exam', lang) }}</h2>
            </div>
            
            <div class="learning-paths">
                {% for path in learning_paths %}
                <div class="learning-path-item">
                    <button 
                        class="learning-path-button {% if path.id == 1 %}knowledge-center{% elif path.id == 2 %}communication{% elif path.id == 3 %}preclinical{% elif path.id == 4 %}workstation{% elif path.id == 5 %}bi-toets{% elif path.id == 6 %}virtual-patients{% endif %}" 
                        data-path="{{ path.id }}"
                    >
                        <div class="path-button-content">
                            {% if path.id == 1 %}
                                <svg class="icon" width="20" height="20" viewBox="0 0 24 24">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" fill="none" stroke="currentColor" stroke-width="2"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" fill="none" stroke="currentColor" stroke-width="2"></path>
                                </svg>
                            {% elif path.id == 2 %}
                                <svg class="icon" width="20" height="20" viewBox="0 0 24 24">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" fill="none" stroke="currentColor" stroke-width="2"></path>
                                </svg>
                            {% elif path.id == 3 %}
                                <svg class="icon" width="20" height="20" viewBox="0 0 24 24">
                                    <path d="M9 3h6v2H9zM8 3h8l-1 9-2 2h-2l-2-2z" fill="none" stroke="currentColor" stroke-width="2"></path>
                                    <path d="M8 14v.5A5.5 5.5 0 0 0 13.5 20h1a5.5 5.5 0 0 0 5.5-5.5V14" fill="none" stroke="currentColor" stroke-width="2"></path>
                                </svg>
                            {% elif path.id == 4 %}
                                <svg class="icon" width="20" height="20" viewBox="0 0 24 24">
                                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" fill="none" stroke="currentColor" stroke-width="2"></path>
                                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1" fill="none" stroke="currentColor" stroke-width="2"></rect>
                                </svg>
                            {% elif path.id == 5 %}
                                <svg class="icon" width="20" height="20" viewBox="0 0 24 24">
                                    <path d="M9 11H7a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2h-2m-6 0V3a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v8m-6 0h6" fill="none" stroke="currentColor" stroke-width="2"></path>
                                </svg>
                            {% elif path.id == 6 %}
                                <svg class="icon" width="20" height="20" viewBox="0 0 24 24">
                                    <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5z" fill="currentColor"/>
                                </svg>
                            {% else %}
                                <svg class="icon" width="20" height="20" viewBox="0 0 24 24">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" fill="none" stroke="currentColor" stroke-width="2"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" fill="none" stroke="currentColor" stroke-width="2"></path>
                                </svg>
                            {% endif %}
                            <span>{{ path.name }}</span>
                        </div>
                        <svg class="chevron-icon" width="20" height="20" viewBox="0 0 24 24">
                            <polyline points="9 18 15 12 9 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></polyline>
                        </svg>
                    </button>
                    
                    <div class="subject-list {% if selected_subject and selected_subject.learning_path_id == path.id %}expanded{% endif %}" id="path-{{ path.id }}-subjects">
                        {% if path.id == 6 %}
                            <a href="{{ url_for('virtual_patient_bp.scenarios_list', lang=lang) }}" class="subject-item">
                                <span class="subject-name">{{ t('clinical_cases', lang) | default('Клинические случаи') }}</span>
                                <div class="subject-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: {{ path.vp_stats.percentage if path.vp_stats else 0 }}%"></div>
                                    </div>
                                    <span class="progress-percent">
                                        {% if path.vp_stats %}
                                            {{ path.vp_stats.completed }}/{{ path.vp_stats.total }}
                                        {% else %}
                                            {{ t('view_all', lang) | default('Все') }}
                                        {% endif %}
                                    </span>
                                </div>
                            </a>
                        {% else %}
                            {% for subject_item in subjects if subject_item.learning_path_id == path.id %}
                            <a href="{{ url_for('subject_view_bp.view_subject', lang=lang, subject_id=subject_item.id) }}" 
                               class="subject-item {% if selected_subject and selected_subject.id == subject_item.id %}active{% endif %}">
                                <span class="subject-name">{{ subject_item.name }}</span>
                                <div class="subject-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: {{ subject_item.progress|default(0) }}%"></div>
                                    </div>
                                    <span class="progress-percent">{{ subject_item.progress|default(0) }}%</span>
                                </div>
                            </a>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="middle-column">
            <div class="page-header">
                <div class="breadcrumb">
                    {% if selected_subject and selected_subject.learning_path %}
                        <span>{{ selected_subject.learning_path.name }}</span>
                        <span class="separator">/</span>
                        <span class="active">{{ selected_subject.name }}</span>
                    {% elif selected_path %}
                        <span class="active">{{ selected_path.name }}</span>
                    {% endif %}
                </div>
                <h1>{% if selected_subject %}{{ selected_subject.name }}{% elif selected_path %}{{ selected_path.name }}{% endif %}</h1>
                <p>{% if selected_subject %}{{ selected_subject.description|default('') }}{% elif selected_path %}{{ selected_path.description|default(t('select_subject_from_left_list', lang)) }}{% endif %}</p>
            </div>

            {% if selected_subject %}
            <div class="subject-content">
                {% if subject_modules %}
                <div class="modules-grid">
                    {% for module in subject_modules %}
                    <div class="module-card" data-module-id="{{ module.id }}">
                        <div class="module-card-content {% if loop.index % 4 == 1 %}blue-gradient{% elif loop.index % 4 == 2 %}purple-gradient{% elif loop.index % 4 == 3 %}teal-gradient{% else %}red-gradient{% endif %}">
                            <div class="module-icon">
                                <svg class="icon" width="24" height="24" viewBox="0 0 24 24">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" fill="none" stroke="currentColor" stroke-width="2"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" fill="none" stroke="currentColor" stroke-width="2"></path>
                                </svg>
                            </div>
                            <div class="module-info">
                                <h3>{{ module.title }}</h3>
                                <p>{{ module.description|default('')|truncate(80) }}</p>
                                <div class="module-footer">
                                    <div class="module-progress">
                                        <div class="progress-bar-container"><div class="progress-bar-fill" style="width: {{ module.progress }}%;"></div></div>
                                        <div class="progress-text"><span>{{ module.progress }}%</span><span>{{ module.completed_lessons }}/{{ module.total_lessons }}</span></div>
                                    </div>
                                    {% if module.is_premium and not user.has_subscription %}<span class="badge premium-badge">{{ t('premium', lang) }}</span>{% endif %}
                                    <a href="{{ url_for('learning_map_bp.start_module_redirect', lang=lang, module_id=module.id) }}" class="module-btn">
                                        {% if module.progress == 100 %}{{ t('repeat', lang) }}{% elif module.progress > 0 %}{{ t('continue', lang) }}{% else %}{{ t('start', lang) }}{% endif %}
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-9"></path><path d="M13 2v7h7"></path><path d="M18 22v-8"></path><path d="M15 17l3 3 3-3"></path></svg>
                    </div>
                    <h3>{{ t('no_modules_yet', lang) }}</h3>
                    <p>{{ t('modules_coming_soon', lang) }}</p>
                </div>
                {% endif %}

                {% if virtual_patients %}
                <div class="virtual-patients-section">
                    <h3 class="virtual-patients-title">
                        <div class="vp-icon">
                            <i class="bi bi-person-hearts"></i>
                        </div>
                        {{ t('virtual_patients_title', lang) | default('Виртуальные пациенты') }}
                    </h3>
                    
                    <div class="virtual-patients-grid">
                        {% for scenario in virtual_patients %}
                        <div class="vp-card">
                            <div>
                                <div class="vp-card-header">
                                    <div class="vp-title">{{ scenario.title }}</div>
                                    <div class="vp-difficulty difficulty-{{ scenario.difficulty|default('medium')|lower }}">
                                        {{ scenario.difficulty|default('medium')|title }}
                                    </div>
                                </div>
                                
                                <div class="vp-description">
                                    {{ scenario.description|default('')|truncate(120) }}
                                </div>
                                
                                {% if scenario.user_progress and scenario.user_progress.attempts_count > 0 %}
                                <div class="vp-progress">
                                    <div class="vp-progress-bar">
                                        <div class="vp-progress-fill" style="width: {{ scenario.user_progress.percentage|default(0) }}%"></div>
                                    </div>
                                    <div class="vp-progress-text">
                                        <span>
                                            {% if scenario.user_progress.completed %}
                                                {{ t('completed', lang) }}
                                            {% else %}
                                                {{ t('in_progress_attempts', lang, count=scenario.user_progress.attempts_count) | default(scenario.user_progress.attempts_count ~ " " ~ t('attempts_short', lang)) }}
                                            {% endif %}
                                        </span>
                                        <span>{{ scenario.user_progress.score|default(0) }}/{{ scenario.user_progress.max_score|default(100) }}</span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            
                            <div class="vp-actions">
                                {% if scenario.is_premium and not user.has_subscription %}
                                <a href="{{ url_for('main_bp.subscribe', lang=lang) }}" class="vp-btn premium">
                                    <i class="bi bi-star-fill me-1"></i> {{ t('premium', lang) }}
                                </a>
                                {% else %}
                                <a href="{{ url_for('virtual_patient_bp.start_scenario', lang=lang, scenario_id=scenario.id) }}" 
                                   class="vp-btn {% if scenario.user_progress and scenario.user_progress.completed %}completed{% endif %}">
                                    <i class="bi bi-play-fill me-1"></i>
                                    {% if scenario.user_progress and scenario.user_progress.completed %}
                                        {{ t('try_again', lang) }}
                                    {% elif scenario.user_progress and scenario.user_progress.attempts_count > 0 %}
                                        {{ t('continue_vp', lang) | default(t('continue', lang)) }}
                                    {% else %}
                                        {{ t('start', lang) }}
                                    {% endif %}
                                </a>
                                {% endif %}
                                
                                {% if scenario.user_progress and scenario.user_progress.completed and scenario.user_progress.best_attempt_id %}
                                <a href="{{ url_for('virtual_patient_bp.results', lang=lang, attempt_id=scenario.user_progress.best_attempt_id) }}" 
                                   class="vp-btn">
                                    <i class="bi bi-chart-line me-1"></i> {{ t('results', lang) }}
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="view-all-vp">
                        <a href="{{ url_for('subject_view_bp.all_virtual_patients', lang=lang) }}">
                            {{ t('view_all_scenarios', lang) }} <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
                {% elif selected_subject %}
                <div class="virtual-patients-section">
                     <h3 class="virtual-patients-title">
                        <div class="vp-icon"><i class="bi bi-person-hearts"></i></div>
                         {{ t('virtual_patients_title', lang) | default('Виртуальные пациенты') }}
                    </h3>
                    <div class="vp-empty-state">
                        <div class="vp-empty-icon"><i class="bi bi-person-x"></i></div>
                        <p>{{ t('no_virtual_patients_for_subject', lang) }}</p>
                         <div class="view-all-vp" style="margin-top:1rem;">
                            <a href="{{ url_for('subject_view_bp.all_virtual_patients', lang=lang) }}">
                                {{ t('view_all_scenarios', lang) }} <i class="bi bi-arrow-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
                </div>
            {% elif selected_path %}
            <div class="subjects-grid">
                {% set filtered_subjects = subjects|selectattr("learning_path_id", "equalto", selected_path.id)|list %}
                {% if filtered_subjects %}
                    {% for subject_item_path_filtered in filtered_subjects %}
                    <div class="subject-card {% if loop.index % 4 == 1 %}blue-gradient{% elif loop.index % 4 == 2 %}purple-gradient{% elif loop.index % 4 == 3 %}teal-gradient{% else %}red-gradient{% endif %}">
                        <a href="{{ url_for('subject_view_bp.view_subject', lang=lang, subject_id=subject_item_path_filtered.id) }}" class="subject-link">
                            <div class="card-content">
                                <div class="card-icon"><svg class="icon" width="24" height="24" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" fill="none" stroke="currentColor" stroke-width="2"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" fill="none" stroke="currentColor" stroke-width="2"></path></svg></div>
                                <div class="card-info">
                                    <h3>{{ subject_item_path_filtered.name }}</h3>
                                    <p>{{ subject_item_path_filtered.description|default('')|truncate(80) }}</p>
                                    <div class="card-footer">
                                        <div class="progress-bar-container"><div class="progress-bar-fill" style="width: {{ subject_item_path_filtered.progress|default(0) }}%;"></div></div>
                                        <span>{{ subject_item_path_filtered.progress|default(0) }}%</span>
                                    </div>
                                </div>
                            </div>
                        </a>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-icon"><svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg></div>
                        <h3>{{ t('no_subjects', lang)|default('Нет предметов') }}</h3>
                        <p>{{ t('subjects_coming_soon', lang)|default('Предметы скоро появятся') }}</p>
                    </div>
                {% endif %}
            </div>
            {% else %}
            <div class="welcome-screen">
              <div class="welcome-header">
                <div class="welcome-icon">
                  <img src="{{ url_for('static', filename='favicon.png') }}" alt="Dental Academy" class="static-favicon-logo">
                </div>
                <h2>{{ t('welcome_title', lang)|default('Добро пожаловать в Become a Tandarts!') }}</h2>
                <p class="welcome-subtitle">{{ t('welcome_subtitle', lang)|default('Ваш путь к успешной подготовке к BIG экзамену') }}</p>
              </div>
              
              <div class="welcome-content">
                <div class="welcome-description">
                  <p>{{ t('welcome_description', lang)|default('Наша интерактивная платформа поможет вам эффективно подготовиться к экзамену. Выберите раздел для начала обучения или ознакомьтесь с рекомендуемыми темами.') }}</p>
                </div>
                
                <div class="interactive-element">
                  <div class="interactive-card" id="interactiveCardWelcome">
                    <div class="card-front">
                      <h4>{{ t('did_you_know', lang)|default('Знаете ли вы?') }}</h4>
                      <p>{{ t('click_to_learn', lang)|default('Нажмите, чтобы узнать интересный факт о стоматологии') }}</p>
                    </div>
                    <div class="card-back">
                      <h4>{{ t('fun_fact', lang)|default('Интересный факт') }}</h4>
                      <p>{{ t('tooth_fact', lang)|default('Зубная эмаль — самая твёрдая ткань человеческого организма!') }}</p>
                    </div>
                  </div>
                </div>
                
                <div class="welcome-steps">
                  <h3>{{ t('getting_started', lang)|default('С чего начать?') }}</h3>
                  <div class="steps-grid">
                    <div class="step-card knowledge-center"><div class="step-icon"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" fill="none" stroke="currentColor" stroke-width="2"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" fill="none" stroke="currentColor" stroke-width="2"></path></svg></div><div class="step-content"><h4>{{ t('knowledge_center', lang)|default('Центр знаний') }}</h4><p>{{ t('knowledge_center_desc', lang)|default('Теоретические основы и ключевые концепции') }}</p><button class="btn-start" data-path="1">{{ t('start', lang)|default('Начать') }}</button></div></div>
                    <div class="step-card communication"><div class="step-icon"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" fill="none" stroke="currentColor" stroke-width="2"></path></svg></div><div class="step-content"><h4>{{ t('communication', lang)|default('Коммуникация') }}</h4><p>{{ t('communication_desc', lang)|default('Отработка навыков общения с пациентами') }}</p><button class="btn-start" data-path="2">{{ t('start', lang)|default('Начать') }}</button></div></div>
                    <div class="step-card preclinical"><div class="step-icon"><svg width="24" height="24" viewBox="0 0 24 24"><path d="M9 3h6v2H9zM8 3h8l-1 9-2 2h-2l-2-2z" fill="none" stroke="currentColor" stroke-width="2"></path><path d="M8 14v.5A5.5 5.5 0 0 0 13.5 20h1a5.5 5.5 0 0 0 5.5-5.5V14" fill="none" stroke="currentColor" stroke-width="2"></path></svg></div><div class="step-content"><h4>{{ t('preclinical_skills', lang)|default('Доклинические навыки') }}</h4><p>{{ t('preclinical_desc', lang)|default('Базовые стоматологические процедуры') }}</p><button class="btn-start" data-path="3">{{ t('start', lang)|default('Начать') }}</button></div></div>
                  </div>
                </div>
                
                {% if current_user.is_authenticated and stats and stats.completed_lessons > 0 %}
                <div class="welcome-stats">
                  <h3>{{ t('your_progress', lang)|default('Ваш прогресс') }}</h3>
                  <div class="stats-summary">
                    <div class="stat-item"><div class="stat-value">{{ stats.completed_lessons }}</div><div class="stat-label">{{ t('lessons_completed', lang)|default('уроков завершено') }}</div></div>
                    <div class="stat-item"><div class="stat-value">{{ stats.overall_progress }}%</div><div class="stat-label">{{ t('overall_progress', lang)|default('общий прогресс') }}</div></div>
                    <div class="stat-item"><div class="stat-value">{{ stats.active_days }}</div><div class="stat-label">{{ t('days_active', lang)|default('дней активности') }}</div></div>
                  </div>
                </div>
                {% endif %}
                
                {% if recommendations and recommendations|length > 0 %}
                <div class="welcome-recommendations">
                  <h3>{{ t('recommended_for_you', lang)|default('Рекомендуемые для вас') }}</h3>
                  <div class="recommendations-cards">
                    {% for rec in recommendations %}
                    <div class="recommendation-card {% if loop.index0 % 3 == 0 %}blue-gradient{% elif loop.index0 % 3 == 1 %}purple-gradient{% else %}teal-gradient{% endif %}">
                      <div class="recommendation-icon"><i class="bi bi-{% if rec.icon %}{{ rec.icon }}{% else %}journal-text{% endif %}"></i></div>
                      <div class="recommendation-content">
                        <h4>{{ rec.title }}</h4>
                        <p>{{ rec.subject_name }}</p>
                        <button class="rec-button" onclick="startModule({{ rec.module_id }})">{{ t('continue', lang)|default('Продолжить') }}</button>
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}
            <div class="floating-shape shape-1"></div>
            <div class="floating-shape shape-2"></div>
            <div class="floating-shape shape-3"></div>
            <div class="floating-shape shape-4"></div>
        </div>

        <div class="right-column">
            <div class="stats-section">
                <h2>{{ t('overall_progress', lang) }}</h2>
                <div class="progress-circle-container">
                    <div class="progress-circle" data-progress="{{ stats.overall_progress|default(0) }}">
                        <div class="circle-background"></div>
                        <div class="circle-progress" style="transform: rotate({{ stats.overall_progress|default(0) * 1.8 }}deg)"></div>
                        <div class="circle-text">{{ stats.overall_progress|default(0) }}%</div>
                    </div>
                </div>
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon blue"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg></div>
                        <div class="stat-content"><span class="stat-label">{{ t('lessons_completed', lang) }}</span></div>
                        <div class="stat-value">{{ stats.completed_lessons|default(0) }}/{{ stats.total_lessons|default(0) }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg></div>
                        <div class="stat-content"><span class="stat-label">{{ t('total_time', lang) }}</span></div>
                        <div class="stat-value">{{ stats.total_time_spent|default(0) }} {{ t('min', lang) }}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg></div>
                        <div class="stat-content"><span class="stat-label">{{ t('days_active', lang) }}</span></div>
                        <div class="stat-value">{{ stats.active_days|default(0) }}</div>
                    </div>
                </div>
            </div>
            
            <div class="countdown-section">
                <h2>{{ t('countdown', lang) }}</h2>
                <div class="day-counter"><span class="days-number">{{ stats.days_until_exam|default(0) }}</span><span class="days-label">{{ t('days_until_exam', lang) }}</span></div>
                <div class="exam-date"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><span>{{ stats.next_exam_date or t('not_scheduled', lang) }}</span></div>
                <button class="schedule-button" id="schedule-exam-button">{{ t('schedule_exam', lang) }}</button>
            </div>
            
            <div class="recommendations-section">
                <h2>{{ t('recommendations', lang) }}</h2>
                <div class="recommendations-list">
                    {% if recommendations and recommendations|length > 0 %}
                        {% for rec in recommendations %}
                        <div class="recommendation-item">
                            <div class="rec-icon {% if loop.index % 2 == 0 %}purple{% else %}blue{% endif %}"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" fill="none" stroke="currentColor" stroke-width="2"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" fill="none" stroke="currentColor" stroke-width="2"></path></svg></div>
                            <div class="rec-info"><h4>{{ rec.title }}</h4><span>{{ rec.subject_name }}</span></div>
                            <button class="rec-action" onclick="startModule({{ rec.module_id }})"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></polyline></svg></button>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="empty-recommendations"><p>{{ t('no_recommendations', lang) }}</p></div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="examDateModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">{{ t('schedule_exam', lang) }}</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                <div class="modal-body"><form id="examDateForm"><div class="mb-3"><label for="examDate" class="form-label">{{ t('select_date', lang) }}</label><input type="date" class="form-control" id="examDate" name="examDate"></div></form></div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('cancel', lang) }}</button><button type="button" class="btn btn-primary" id="saveExamDate">{{ t('save', lang) }}</button></div>
            </div>
        </div>
    </div>
</div>
<div class="interactive-element"> <div class="interactive-card" id="interactiveCardFooter">
    <div class="card-front">
      <h4>{{ t('did_you_know', lang)|default('Знаете ли вы?') }}</h4>
      <p>{{ t('click_to_learn', lang)|default('Нажмите, чтобы узнать интересный факт о стоматологии') }}</p>
    </div>
    <div class="card-back">
      <h4>{{ t('fun_fact', lang)|default('Интересный факт') }}</h4>
      <p>{{ t('tooth_fact', lang)|default('Зубная эмаль — самая твёрдая ткань человеческого организма!') }}</p>
    </div>
  </div>
</div>
{% endblock %}

{% block body_scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/subject-navigation.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Обработчики кнопок для начала обучения на приветственном экране
  const startButtons = document.querySelectorAll('.btn-start');
  startButtons.forEach(button => {
    button.addEventListener('click', function() {
      const pathId = this.getAttribute('data-path');
      window.location.href = `/{{ lang }}/learning-map/path/${pathId}`;
    });
  });
  
  // Обработчик для интерактивной карточки с фактом (на приветственном экране)
  const interactiveCardWelcome = document.getElementById('interactiveCardWelcome');
  if (interactiveCardWelcome) {
    interactiveCardWelcome.addEventListener('click', function() {
      this.classList.toggle('flipped');
    });
  }

  // Обработчик для интерактивной карточки с фактом (в футере)
  const interactiveCardFooter = document.getElementById('interactiveCardFooter');
  if (interactiveCardFooter) {
    interactiveCardFooter.addEventListener('click', function() {
      this.classList.toggle('flipped');
    });
  }

  // JavaScript для анимации виртуальных пациентов
  const vpCards = document.querySelectorAll('.vp-card');
  if (vpCards.length > 0) {
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry, index) => {
            if (entry.isIntersecting) {
                setTimeout(() => {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }, index * 100);
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);
    vpCards.forEach(card => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(card);
    });
  }
  
  const vpProgressBars = document.querySelectorAll('.vp-progress-fill');
  vpProgressBars.forEach(bar => {
      const width = bar.style.width;
      bar.style.width = '0%';
      setTimeout(() => {
          bar.style.width = width;
      }, 500);
  });

  // Обработчик для мобильной навигации виртуальных пациентов
  const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
  mobileNavItems.forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      const pathId = this.getAttribute('data-path');
      if (pathId === '6') {
        window.location.href = '{{ url_for("virtual_patient_bp.scenarios_list", lang=lang) }}';
      } else if (pathId) {
        window.location.href = `/{{ lang }}/learning-map/path/${pathId}`;
      }
    });
  });
});

function startModule(moduleId) {
    window.location.href = `/{{ lang }}/learning-map/module/${moduleId}/start`;
}
</script>
{% endblock %}