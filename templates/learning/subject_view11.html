{% extends "base.html" %}

{% block title %}{% if t is defined %}{{ t('learning_map', g.lang) }} - {{ t('app_title', g.lang) }}{% else %}Learning Map - Dental Academy{% endif %}{% endblock %}

{% block meta_description %}{% if t is defined %}{{ t('learning_map_description', g.lang) }}{% else %}Интерактивная карта обучения для подготовки к BIG экзамену стоматологов в Нидерландах{% endif %}{% endblock %}

{% block styles %}
{{ super() }}

<style>
  /* Специфичные стили для subject_view - дополнения к основной дизайн-системе */
  
  /* Дополнительные градиенты для совместимости */
  .gradient-knowledge { background: linear-gradient(135deg, #3498db, #2980b9); }
  .gradient-communication { background: linear-gradient(135deg, #7d5fff, #5352ed); }
  .gradient-preclinical { background: linear-gradient(135deg, #4EB5B1, #3a8c88); }
  .gradient-workstation { background: linear-gradient(135deg, #ff7675, #e74c3c); }
  .gradient-bitoets { background: linear-gradient(135deg, #f1c40f, #f39c12); }
  .gradient-dutch { background: linear-gradient(135deg, #84cc16, #65a30d); }
  .gradient-virtual { background: linear-gradient(135deg, #667eea, #764ba2); }
  
  /* Улучшенные стили для мобильных устройств */
  @media (max-width: 768px) {
    .animated-logo {
      width: 80px;
      height: 80px;
    }
    
    .animated-logo::before {
      width: 60px;
      height: 60px;
    }
    
    .animated-logo::after {
      font-size: 2rem;
    }
    
    .welcome-icon {
      width: 100px;
      height: 100px;
    }
  }
  
  /* Дополнительные стили для плавности анимаций */
  .learning-path-button {
    will-change: transform;
  }
  
  .subject-item {
    will-change: transform;
  }
  
  .interactive-card {
    will-change: transform;
  }
  
  /* Устранение мерцания при hover */
  .recommendation-card,
  .step-card,
  .module-card,
  .subject-card {
    backface-visibility: hidden;
    transform: translateZ(0);
  }
</style>
{% endblock %}

{% block content %}
<div class="learning-map-container">
    <div class="main-container">
        <!-- Левая навигационная колонка -->
        <div class="left-column">
            <div class="section-header">
                <h2 data-translate="exam">{% if t is defined %}{{ t('exam', g.lang) }}{% else %}Learning Map{% endif %}</h2>
            </div>
            
            <div class="learning-paths">
                {% for path in learning_paths %}
                <div class="learning-path-item">
                    <button 
                        class="learning-path-button {% if path.id == 1 %}knowledge-center{% elif path.id == 2 %}communication{% elif path.id == 3 %}preclinical{% elif path.id == 4 %}workstation{% elif path.id == 5 %}bi-toets{% elif path.id == 6 %}virtual-patients{% endif %}" 
                        data-path="{{ path.id }}"
                    >
                        <div class="path-button-content">
                            {% if path.id == 1 %}
                                <svg class="icon" width="20" height="20" viewBox="0 0 24 24">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" fill="none" stroke="currentColor" stroke-width="2"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" fill="none" stroke="currentColor" stroke-width="2"></path>
                                </svg>
                            {% elif path.id == 2 %}
                                <svg class="icon" width="20" height="20" viewBox="0 0 24 24">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" fill="none" stroke="currentColor" stroke-width="2"></path>
                                </svg>
                            {% elif path.id == 3 %}
                                <svg class="icon" width="20" height="20" viewBox="0 0 24 24">
                                    <path d="M9 3h6v2H9zM8 3h8l-1 9-2 2h-2l-2-2z" fill="none" stroke="currentColor" stroke-width="2"></path>
                                    <path d="M8 14v.5A5.5 5.5 0 0 0 13.5 20h1a5.5 5.5 0 0 0 5.5-5.5V14" fill="none" stroke="currentColor" stroke-width="2"></path>
                                </svg>
                            {% elif path.id == 4 %}
                                <svg class="icon" width="20" height="20" viewBox="0 0 24 24">
                                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" fill="none" stroke="currentColor" stroke-width="2"></path>
                                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1" fill="none" stroke="currentColor" stroke-width="2"></rect>
                                </svg>
                            {% elif path.id == 5 %}
                                <svg class="icon" width="20" height="20" viewBox="0 0 24 24">
                                    <path d="M9 11H7a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2h-2m-6 0V3a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v8m-6 0h6" fill="none" stroke="currentColor" stroke-width="2"></path>
                                </svg>
                            {% elif path.id == 6 %}
                                <svg class="icon" width="20" height="20" viewBox="0 0 24 24">
                                    <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" fill="currentColor"/>
                                </svg>
                            {% else %}
                                <svg class="icon" width="20" height="20" viewBox="0 0 24 24">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" fill="none" stroke="currentColor" stroke-width="2"></path>
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" fill="none" stroke="currentColor" stroke-width="2"></path>
                                </svg>
                            {% endif %}
                            <span>{{ path.name }}</span>
                        </div>
                        <svg class="chevron-icon" width="20" height="20" viewBox="0 0 24 24">
                            <polyline points="9 18 15 12 9 6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></polyline>
                        </svg>
                    </button>
                    
                    <div class="subject-list {% if selected_subject and selected_subject.learning_path_id == path.id %}expanded{% endif %}" id="path-{{ path.id }}-subjects">
                        {% if path.id == 6 %}
                            <a href="{{ url_for('virtual_patient_bp.scenarios_list', lang=lang) }}" class="subject-item">
                                <span class="subject-name">{{ t('clinical_cases', lang) | default('Клинические случаи') }}</span>
                                <div class="subject-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: {{ path.vp_stats.percentage if path.vp_stats else 0 }}%"></div>
                                    </div>
                                    <span class="progress-percent">
                                        {% if path.vp_stats %}
                                            {{ path.vp_stats.completed }}/{{ path.vp_stats.total }}
                                        {% else %}
                                            {{ t('view_all', lang) | default('Все') }}
                                        {% endif %}
                                    </span>
                                </div>
                            </a>
                        {% else %}
                            {% for subject_item in subjects if subject_item.learning_path_id == path.id %}
                            <a href="{{ url_for('subject_view_bp.view_subject', lang=lang, subject_id=subject_item.id) }}" 
                               class="subject-item {% if selected_subject and selected_subject.id == subject_item.id %}active{% endif %}">
                                <span class="subject-name">{{ subject_item.name }}</span>
                                <div class="subject-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: {{ subject_item.progress|default(0) }}%"></div>
                                    </div>
                                    <span class="progress-percent">{{ subject_item.progress|default(0) }}%</span>
                                </div>
                            </a>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        <!-- Основной контент -->
        <div class="middle-column">
            <div class="page-header">
                <nav class="breadcrumb" aria-label="Навигационная цепочка">
                    <span data-translate="learning_map">{% if t is defined %}{{ t('learning_map', g.lang) }}{% else %}Карта обучения{% endif %}</span>
                    {% if selected_subject and selected_subject.learning_path %}
                        <span class="separator" aria-hidden="true">/</span>
                        <span data-translate="{{ selected_subject.learning_path.name_key if selected_subject.learning_path.name_key else selected_subject.learning_path.name|lower|replace(' ', '_') }}">
                            {% if t is defined %}{{ t(selected_subject.learning_path.name_key if selected_subject.learning_path.name_key else selected_subject.learning_path.name|lower|replace(' ', '_'), g.lang) }}{% else %}{{ selected_subject.learning_path.name }}{% endif %}
                        </span>
                        <span class="separator" aria-hidden="true">/</span>
                        <span class="active" data-translate="{{ selected_subject.name_key if selected_subject.name_key else selected_subject.name|lower|replace(' ', '_') }}">
                            {% if t is defined %}{{ t(selected_subject.name_key if selected_subject.name_key else selected_subject.name|lower|replace(' ', '_'), g.lang) }}{% else %}{{ selected_subject.name }}{% endif %}
                        </span>
                    {% elif selected_path %}
                        <span class="separator" aria-hidden="true">/</span>
                        <span class="active" data-translate="{{ selected_path.name_key if selected_path.name_key else selected_path.name|lower|replace(' ', '_') }}">
                            {% if t is defined %}{{ t(selected_path.name_key if selected_path.name_key else selected_path.name|lower|replace(' ', '_'), g.lang) }}{% else %}{{ selected_path.name }}{% endif %}
                        </span>
                    {% endif %}
                </nav>
                
                <h1>
                    {% if selected_subject %}
                        <span data-translate="{{ selected_subject.name_key if selected_subject.name_key else selected_subject.name|lower|replace(' ', '_') }}">
                            {% if t is defined %}{{ t(selected_subject.name_key if selected_subject.name_key else selected_subject.name|lower|replace(' ', '_'), g.lang) }}{% else %}{{ selected_subject.name }}{% endif %}
                        </span>
                    {% elif selected_path %}
                        <span data-translate="{{ selected_path.name_key if selected_path.name_key else selected_path.name|lower|replace(' ', '_') }}">
                            {% if t is defined %}{{ t(selected_path.name_key if selected_path.name_key else selected_path.name|lower|replace(' ', '_'), g.lang) }}{% else %}{{ selected_path.name }}{% endif %}
                        </span>
                    {% else %}
                        <span data-translate="welcome_message">{% if t is defined %}{{ t('welcome_message', g.lang) }}{% else %}Добро пожаловать!{% endif %}</span>
                    {% endif %}
                </h1>
                
                <p>
                    {% if selected_subject %}
                        <span data-translate="{{ selected_subject.description_key if selected_subject.description_key else 'subject_description' }}">
                            {% if t is defined %}{{ t(selected_subject.description_key if selected_subject.description_key else 'subject_description', g.lang) }}{% else %}{{ selected_subject.description|default('') }}{% endif %}
                        </span>
                    {% elif selected_path %}
                        <span data-translate="{{ selected_path.description_key if selected_path.description_key else 'select_subject_from_left_list' }}">
                            {% if t is defined %}{{ t(selected_path.description_key if selected_path.description_key else 'select_subject_from_left_list', g.lang) }}{% else %}{{ selected_path.description|default('Выберите предмет из списка слева') }}{% endif %}
                        </span>
                    {% else %}
                        <span data-translate="select_category_message">{% if t is defined %}{{ t('select_category_message', g.lang) }}{% else %}Выберите категорию для начала обучения{% endif %}</span>
                    {% endif %}
                </p>
            </div>

            {% if selected_subject %}
                <!-- Модули выбранного предмета -->
                <div class="subject-content">
                    {% if subject_modules %}
                    <div class="modules-grid">
                        {% for module in subject_modules %}
                        <div class="module-card" data-module-id="{{ module.id }}">
                            <div class="module-card-content {% if loop.index % 4 == 1 %}gradient-knowledge{% elif loop.index % 4 == 2 %}gradient-communication{% elif loop.index % 4 == 3 %}gradient-preclinical{% else %}gradient-workstation{% endif %}">
                                <div class="module-icon">
                                    <i class="bi bi-{{ module.icon|default('book') }}" aria-hidden="true"></i>
                                </div>
                                <div class="module-info">
                                    <h3 data-translate="{{ module.title_key if module.title_key else module.title|lower|replace(' ', '_') }}">
                                        {% if t is defined %}{{ t(module.title_key if module.title_key else module.title|lower|replace(' ', '_'), g.lang) }}{% else %}{{ module.title }}{% endif %}
                                    </h3>
                                    <p data-translate="{{ module.description_key if module.description_key else 'module_description' }}">
                                        {% if t is defined %}{{ t(module.description_key if module.description_key else 'module_description', g.lang) }}{% else %}{{ module.description|default('')|truncate(80) }}{% endif %}
                                    </p>
                                    <div class="module-footer">
                                        <div class="module-progress">
                                            <div class="progress-bar-container">
                                                <div class="progress-bar-fill" style="width: {{ module.progress|default(0) }}%;" 
                                                     role="progressbar" 
                                                     aria-valuenow="{{ module.progress|default(0) }}" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100"
                                                     aria-label="Прогресс модуля: {{ module.progress|default(0) }}%"></div>
                                            </div>
                                            <div class="progress-text">
                                                <span>{{ module.progress|default(0) }}%</span>
                                                <span>{{ module.completed_lessons|default(0) }}/{{ module.total_lessons|default(0) }}</span>
                                            </div>
                                        </div>
                                        {% if module.is_premium and not (current_user and current_user.has_subscription) %}
                                            <span class="badge premium-badge">
                                                <i class="bi bi-star" aria-hidden="true"></i>
                                                <span data-translate="premium">{% if t is defined %}{{ t('premium', g.lang) }}{% else %}Premium{% endif %}</span>
                                            </span>
                                        {% endif %}
                                        <a href="{{ url_for('learning_map_bp.start_module_redirect', lang=g.lang, module_id=module.id) if url_for else '#' }}" 
                                           class="module-btn">
                                            {% if module.progress == 100 %}
                                                <span data-translate="repeat">{% if t is defined %}{{ t('repeat', g.lang) }}{% else %}Повторить{% endif %}</span>
                                            {% elif module.progress > 0 %}
                                                <span data-translate="continue">{% if t is defined %}{{ t('continue', g.lang) }}{% else %}Продолжить{% endif %}</span>
                                            {% else %}
                                                <span data-translate="start">{% if t is defined %}{{ t('start', g.lang) }}{% else %}Начать{% endif %}</span>
                                            {% endif %}
                                            <i class="bi bi-arrow-right ms-1" aria-hidden="true"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="bi bi-journal-x" style="font-size: 4rem; opacity: 0.5;" aria-hidden="true"></i>
                        </div>
                        <h3 data-translate="no_modules_yet">{% if t is defined %}{{ t('no_modules_yet', g.lang) }}{% else %}Модули пока недоступны{% endif %}</h3>
                        <p data-translate="modules_coming_soon">{% if t is defined %}{{ t('modules_coming_soon', g.lang) }}{% else %}Модули появятся в ближайшее время{% endif %}</p>
                    </div>
                    {% endif %}

                    <!-- Виртуальные пациенты для выбранного предмета -->
                    {% if virtual_patients %}
                    <div class="virtual-patients-section">
                        <h3 class="virtual-patients-title">
                            <div class="vp-icon">
                                <i class="bi bi-person-hearts" aria-hidden="true"></i>
                            </div>
                            <span data-translate="virtual_patients_title">{% if t is defined %}{{ t('virtual_patients_title', g.lang) }}{% else %}Виртуальные пациенты{% endif %}</span>
                        </h3>
                        
                        <div class="virtual-patients-grid">
                            {% for scenario in virtual_patients %}
                            <div class="vp-card">
                                <div>
                                    <div class="vp-card-header">
                                        <div class="vp-title" data-translate="{{ scenario.title_key if scenario.title_key else scenario.title|lower|replace(' ', '_') }}">
                                            {% if t is defined %}{{ t(scenario.title_key if scenario.title_key else scenario.title|lower|replace(' ', '_'), g.lang) }}{% else %}{{ scenario.title }}{% endif %}
                                        </div>
                                        <div class="vp-difficulty difficulty-{{ scenario.difficulty|default('medium')|lower }}">
                                            <span data-translate="difficulty_{{ scenario.difficulty|default('medium')|lower }}">
                                                {% if t is defined %}{{ t('difficulty_' + scenario.difficulty|default('medium')|lower, g.lang) }}{% else %}{{ scenario.difficulty|default('Medium')|title }}{% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div class="vp-description" data-translate="{{ scenario.description_key if scenario.description_key else 'scenario_description' }}">
                                        {% if t is defined %}{{ t(scenario.description_key if scenario.description_key else 'scenario_description', g.lang) }}{% else %}{{ scenario.description|default('')|truncate(120) }}{% endif %}
                                    </div>
                                    
                                    {% if scenario.user_progress and scenario.user_progress.attempts_count > 0 %}
                                    <div class="vp-progress">
                                        <div class="vp-progress-bar">
                                            <div class="vp-progress-fill" style="width: {{ scenario.user_progress.percentage|default(0) }}%"
                                                 role="progressbar" 
                                                 aria-valuenow="{{ scenario.user_progress.percentage|default(0) }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100"
                                                 aria-label="Прогресс сценария: {{ scenario.user_progress.percentage|default(0) }}%"></div>
                                        </div>
                                        <div class="vp-progress-text">
                                            <span>
                                                {% if scenario.user_progress.completed %}
                                                    <span data-translate="completed">{% if t is defined %}{{ t('completed', g.lang) }}{% else %}Завершено{% endif %}</span>
                                                {% else %}
                                                    {{ scenario.user_progress.attempts_count }} 
                                                    <span data-translate="attempts_short">{% if t is defined %}{{ t('attempts_short', g.lang) }}{% else %}попыток{% endif %}</span>
                                                {% endif %}
                                            </span>
                                            <span>{{ scenario.user_progress.score|default(0) }}/{{ scenario.user_progress.max_score|default(100) }}</span>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <div class="vp-actions">
                                    {% if scenario.is_premium and not (current_user and current_user.has_subscription) %}
                                    <a href="{{ url_for('main_bp.subscribe', lang=g.lang) if url_for else '#' }}" class="vp-btn premium">
                                        <i class="bi bi-star-fill me-1" aria-hidden="true"></i>
                                        <span data-translate="premium">{% if t is defined %}{{ t('premium', g.lang) }}{% else %}Premium{% endif %}</span>
                                    </a>
                                    {% else %}
                                    <a href="{{ url_for('virtual_patient_bp.start_scenario', lang=g.lang, scenario_id=scenario.id) if url_for else '#' }}" 
                                       class="vp-btn {% if scenario.user_progress and scenario.user_progress.completed %}completed{% endif %}">
                                        <i class="bi bi-play-fill me-1" aria-hidden="true"></i>
                                        {% if scenario.user_progress and scenario.user_progress.completed %}
                                            <span data-translate="try_again">{% if t is defined %}{{ t('try_again', g.lang) }}{% else %}Попробовать снова{% endif %}</span>
                                        {% elif scenario.user_progress and scenario.user_progress.attempts_count > 0 %}
                                            <span data-translate="continue_vp">{% if t is defined %}{{ t('continue_vp', g.lang) }}{% else %}{% if t is defined %}{{ t('continue', g.lang) }}{% else %}Продолжить{% endif %}{% endif %}</span>
                                        {% else %}
                                            <span data-translate="start">{% if t is defined %}{{ t('start', g.lang) }}{% else %}Начать{% endif %}</span>
                                        {% endif %}
                                    </a>
                                    {% endif %}
                                    
                                    {% if scenario.user_progress and scenario.user_progress.completed and scenario.user_progress.best_attempt_id %}
                                    <a href="{{ url_for('virtual_patient_bp.results', lang=g.lang, attempt_id=scenario.user_progress.best_attempt_id) if url_for else '#' }}" 
                                       class="vp-btn">
                                        <i class="bi bi-chart-line me-1" aria-hidden="true"></i>
                                        <span data-translate="results">{% if t is defined %}{{ t('results', g.lang) }}{% else %}Результаты{% endif %}</span>
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="view-all-vp">
                            <a href="{{ url_for('subject_view_bp.all_virtual_patients', lang=g.lang) if url_for else '#' }}">
                                <span data-translate="view_all_scenarios">{% if t is defined %}{{ t('view_all_scenarios', g.lang) }}{% else %}Посмотреть все сценарии{% endif %}</span>
                                <i class="bi bi-arrow-right ms-1" aria-hidden="true"></i>
                            </a>
                        </div>
                    </div>
                    {% elif selected_subject %}
                    <div class="virtual-patients-section">
                        <h3 class="virtual-patients-title">
                            <div class="vp-icon"><i class="bi bi-person-hearts" aria-hidden="true"></i></div>
                            <span data-translate="virtual_patients_title">{% if t is defined %}{{ t('virtual_patients_title', g.lang) }}{% else %}Виртуальные пациенты{% endif %}</span>
                        </h3>
                        <div class="vp-empty-state">
                            <div class="vp-empty-icon"><i class="bi bi-person-x" aria-hidden="true"></i></div>
                            <p data-translate="no_virtual_patients_for_subject">{% if t is defined %}{{ t('no_virtual_patients_for_subject', g.lang) }}{% else %}Для этого предмета пока нет виртуальных пациентов{% endif %}</p>
                            <div class="view-all-vp" style="margin-top:1rem;">
                                <a href="{{ url_for('subject_view_bp.all_virtual_patients', lang=g.lang) if url_for else '#' }}">
                                    <span data-translate="view_all_scenarios">{% if t is defined %}{{ t('view_all_scenarios', g.lang) }}{% else %}Посмотреть все сценарии{% endif %}</span>
                                    <i class="bi bi-arrow-right ms-1" aria-hidden="true"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
            {% elif selected_path %}
                <!-- Предметы выбранного пути обучения -->
                <div class="subjects-grid">
                    {% set filtered_subjects = subjects|selectattr("learning_path_id", "equalto", selected_path.id)|list if subjects else [] %}
                    {% if filtered_subjects %}
                        {% for subject_item_path_filtered in filtered_subjects %}
                        <div class="subject-card {% if loop.index % 4 == 1 %}gradient-knowledge{% elif loop.index % 4 == 2 %}gradient-communication{% elif loop.index % 4 == 3 %}gradient-preclinical{% else %}gradient-workstation{% endif %}">
                            <a href="{{ url_for('subject_view_bp.view_subject', lang=g.lang, subject_id=subject_item_path_filtered.id) if url_for else '#' }}" class="subject-link">
                                <div class="card-content">
                                    <div class="card-icon">
                                        <i class="bi bi-{{ subject_item_path_filtered.icon|default('book') }}" aria-hidden="true"></i>
                                    </div>
                                    <div class="card-info">
                                        <h3 data-translate="{{ subject_item_path_filtered.name_key if subject_item_path_filtered.name_key else subject_item_path_filtered.name|lower|replace(' ', '_') }}">
                                            {% if t is defined %}{{ t(subject_item_path_filtered.name_key if subject_item_path_filtered.name_key else subject_item_path_filtered.name|lower|replace(' ', '_'), g.lang) }}{% else %}{{ subject_item_path_filtered.name }}{% endif %}
                                        </h3>
                                        <p data-translate="{{ subject_item_path_filtered.description_key if subject_item_path_filtered.description_key else 'subject_description' }}">
                                            {% if t is defined %}{{ t(subject_item_path_filtered.description_key if subject_item_path_filtered.description_key else 'subject_description', g.lang) }}{% else %}{{ subject_item_path_filtered.description|default('')|truncate(80) }}{% endif %}
                                        </p>
                                        <div class="card-footer">
                                            <div class="progress-bar-container">
                                                <div class="progress-bar-fill" style="width: {{ subject_item_path_filtered.progress|default(0) }}%;"
                                                     role="progressbar" 
                                                     aria-valuenow="{{ subject_item_path_filtered.progress|default(0) }}" 
                                                     aria-valuemin="0" 
                                                     aria-valuemax="100"
                                                     aria-label="Прогресс предмета: {{ subject_item_path_filtered.progress|default(0) }}%"></div>
                                            </div>
                                            <span>{{ subject_item_path_filtered.progress|default(0) }}%</span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <div class="empty-icon">
                                <i class="bi bi-folder-x" style="font-size: 4rem; opacity: 0.5;" aria-hidden="true"></i>
                            </div>
                            <h3 data-translate="no_subjects">{% if t is defined %}{{ t('no_subjects', g.lang) }}{% else %}Нет предметов{% endif %}</h3>
                            <p data-translate="subjects_coming_soon">{% if t is defined %}{{ t('subjects_coming_soon', g.lang) }}{% else %}Предметы скоро появятся{% endif %}</p>
                        </div>
                    {% endif %}
                </div>
                
            {% else %}
                <!-- ИСПРАВЛЕННЫЙ приветственный экран -->
                <div class="welcome-screen">
                    <div class="welcome-header">
                        <div class="welcome-icon">
                            <div class="animated-logo">
                                <!-- Новая структура логотипа без старой иконки -->
                            </div>
                        </div>
                        <h2 data-translate="welcome_title">{% if t is defined %}{{ t('welcome_title', g.lang) }}{% else %}Добро пожаловать в Dental Academy!{% endif %}</h2>
                        <p class="welcome-subtitle" data-translate="welcome_subtitle">{% if t is defined %}{{ t('welcome_subtitle', g.lang) }}{% else %}Ваш путь к успешной подготовке к BIG экзамену{% endif %}</p>
                    </div>
                    
                    <div class="welcome-content">
                        <div class="welcome-description">
                            <p data-translate="welcome_description">{% if t is defined %}{{ t('welcome_description', g.lang) }}{% else %}Наша интерактивная платформа поможет вам эффективно подготовиться к экзамену. Выберите раздел для начала обучения или ознакомьтесь с рекомендуемыми темами.{% endif %}</p>
                        </div>
                        
                        <!-- Интерактивная карточка с фактом -->
                        <div class="interactive-element">
                            <div class="interactive-card" 
                                 id="interactiveCardWelcome"
                                 tabindex="0"
                                 role="button"
                                 aria-label="Нажмите, чтобы перевернуть карточку c интересным фактом">
                                <div class="card-front">
                                    <h4 data-translate="did_you_know">{% if t is defined %}{{ t('did_you_know', g.lang) }}{% else %}Знаете ли вы?{% endif %}</h4>
                                    <p data-translate="click_to_learn">{% if t is defined %}{{ t('click_to_learn', g.lang) }}{% else %}Нажмите, чтобы узнать интересный факт о стоматологии{% endif %}</p>
                                </div>
                                <div class="card-back">
                                    <h4 data-translate="fun_fact">{% if t is defined %}{{ t('fun_fact', g.lang) }}{% else %}Интересный факт{% endif %}</h4>
                                    <p data-translate="tooth_fact">{% if t is defined %}{{ t('tooth_fact', g.lang) }}{% else %}Зубная эмаль — самая твёрдая ткань человеческого организма!{% endif %}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Рекомендуемые пути обучения -->
                        <div class="welcome-steps">
                            <h3 data-translate="getting_started">{% if t is defined %}{{ t('getting_started', g.lang) }}{% else %}С чего начать?{% endif %}</h3>
                            <div class="steps-grid">
                                {% for path in learning_paths[:3] %}
                                <div class="step-card {% if path.id == 1 %}gradient-knowledge{% elif path.id == 2 %}gradient-communication{% else %}gradient-preclinical{% endif %}">
                                    <div class="step-icon">
                                        {% if path.id == 1 %}
                                            <i class="bi bi-book" aria-hidden="true"></i>
                                        {% elif path.id == 2 %}
                                            <i class="bi bi-chat-heart" aria-hidden="true"></i>
                                        {% else %}
                                            <i class="bi bi-hospital" aria-hidden="true"></i>
                                        {% endif %}
                                    </div>
                                    <div class="step-content">
                                        <h4 data-translate="{{ path.name_key if path.name_key else path.name|lower|replace(' ', '_') }}">
                                            {% if t is defined %}{{ t(path.name_key if path.name_key else path.name|lower|replace(' ', '_'), g.lang) }}{% else %}{{ path.name }}{% endif %}
                                        </h4>
                                        <p data-translate="{{ path.description_key if path.description_key else 'path_description' }}">
                                            {% if t is defined %}{{ t(path.description_key if path.description_key else 'path_description', g.lang) }}{% else %}{{ path.description|default('Описание пути обучения') }}{% endif %}
                                        </p>
                                        <button class="btn-start" onclick="navigateToCategory({{ path.id }})" type="button">
                                            <span data-translate="start">{% if t is defined %}{{ t('start', g.lang) }}{% else %}Начать{% endif %}</span>
                                            <i class="bi bi-arrow-right ms-1" aria-hidden="true"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Статистика (если пользователь авторизован) -->
                        {% if current_user and current_user.is_authenticated and stats and stats.completed_lessons > 0 %}
                        <div class="welcome-stats">
                            <h3 data-translate="your_progress">{% if t is defined %}{{ t('your_progress', g.lang) }}{% else %}Ваш прогресс{% endif %}</h3>
                            <div class="stats-summary">
                                <div class="stat-item">
                                    <div class="stat-value">{{ stats.completed_lessons }}</div>
                                    <div class="stat-label" data-translate="lessons_completed">{% if t is defined %}{{ t('lessons_completed', g.lang) }}{% else %}уроков завершено{% endif %}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">{{ stats.overall_progress }}%</div>
                                    <div class="stat-label" data-translate="overall_progress_lower">{% if t is defined %}{{ t('overall_progress_lower', g.lang) }}{% else %}общий прогресс{% endif %}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">{{ stats.active_days }}</div>
                                    <div class="stat-label" data-translate="days_active_lower">{% if t is defined %}{{ t('days_active_lower', g.lang) }}{% else %}дней активности{% endif %}</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- ИСПРАВЛЕННЫЕ рекомендации -->
                        {% if recommendations and recommendations|length > 0 %}
                        <div class="welcome-recommendations">
                            <h3 data-translate="recommended_for_you">{% if t is defined %}{{ t('recommended_for_you', g.lang) }}{% else %}Рекомендуемые для вас{% endif %}</h3>
                            <div class="recommendations-cards">
                                {% for rec in recommendations %}
                                <div class="recommendation-card {% if loop.index0 % 3 == 0 %}gradient-knowledge{% elif loop.index0 % 3 == 1 %}gradient-communication{% else %}gradient-preclinical{% endif %}">
                                    <div class="recommendation-icon">
                                        <i class="bi bi-{{ rec.icon|default('journal-text') }}" aria-hidden="true"></i>
                                    </div>
                                    <div class="recommendation-content">
                                        <h4 data-translate="{{ rec.title_key if rec.title_key else rec.title|lower|replace(' ', '_') }}">
                                            {% if t is defined %}{{ t(rec.title_key if rec.title_key else rec.title|lower|replace(' ', '_'), g.lang) }}{% else %}{{ rec.title }}{% endif %}
                                        </h4>
                                        <p data-translate="{{ rec.subject_name_key if rec.subject_name_key else 'subject_name' }}">
                                            {% if t is defined %}{{ t(rec.subject_name_key if rec.subject_name_key else 'subject_name', g.lang) }}{% else %}{{ rec.subject_name }}{% endif %}
                                        </p>
                                        <button class="rec-button" onclick="startModule({{ rec.module_id }})" type="button">
                                            <span data-translate="continue">{% if t is defined %}{{ t('continue', g.lang) }}{% else %}Продолжить{% endif %}</span>
                                            <i class="bi bi-arrow-right ms-1" aria-hidden="true"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Правая колонка со статистикой -->
        <div class="right-column">
            <div class="stats-section">
                <h2 data-translate="overall_progress">{% if t is defined %}{{ t('overall_progress', g.lang) }}{% else %}Общий прогресс{% endif %}</h2>
                <div class="progress-circle-container">
                    <div class="progress-circle" data-progress="{{ stats.overall_progress|default(0) }}">
                        <div class="circle-background"></div>
                        <div class="circle-progress" style="transform: rotate({{ (stats.overall_progress|default(0) * 3.6)|int }}deg)"></div>
                        <div class="circle-text">{{ stats.overall_progress|default(0) }}%</div>
                    </div>
                </div>
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <i class="bi bi-journal-check" aria-hidden="true"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-label" data-translate="lessons_completed">{% if t is defined %}{{ t('lessons_completed', g.lang) }}{% else %}Уроков завершено{% endif %}</span>
                            <div class="stat-value">{{ stats.completed_lessons|default(0) }}/{{ stats.total_lessons|default(0) }}</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">
                            <i class="bi bi-clock" aria-hidden="true"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-label" data-translate="total_time">{% if t is defined %}{{ t('total_time', g.lang) }}{% else %}Общее время{% endif %}</span>
                            <div class="stat-value">{{ stats.total_time_spent|default(0) }} {% if t is defined %}{{ t('min', g.lang) }}{% else %}мин{% endif %}</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <i class="bi bi-graph-up" aria-hidden="true"></i>
                        </div>
                        <div class="stat-content">
                            <span class="stat-label" data-translate="days_active">{% if t is defined %}{{ t('days_active', g.lang) }}{% else %}Дней активности{% endif %}</span>
                            <div class="stat-value">{{ stats.active_days|default(0) }}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="countdown-section">
                <h2 data-translate="countdown">{% if t is defined %}{{ t('countdown', g.lang) }}{% else %}Обратный отсчет{% endif %}</h2>
                <div class="day-counter">
                    <span class="days-number">{{ stats.days_until_exam|default(0) }}</span>
                    <span class="days-label" data-translate="days_until_exam">{% if t is defined %}{{ t('days_until_exam', g.lang) }}{% else %}дней до экзамена{% endif %}</span>
                </div>
                <div class="exam-date">
                    <i class="bi bi-calendar3" aria-hidden="true"></i>
                    <span>{{ stats.next_exam_date or (t('not_scheduled', g.lang) if t is defined else 'не назначена') }}</span>
                </div>
                <button class="schedule-button" id="schedule-exam-button" data-bs-toggle="modal" data-bs-target="#examDateModal" type="button">
                    <span data-translate="schedule_exam">{% if t is defined %}{{ t('schedule_exam', g.lang) }}{% else %}Запланировать экзамен{% endif %}</span>
                </button>
            </div>
            
            <div class="recommendations-section">
                <h2 data-translate="recommendations">{% if t is defined %}{{ t('recommendations', g.lang) }}{% else %}Рекомендации{% endif %}</h2>
                <div class="recommendations-list">
                    {% if recommendations and recommendations|length > 0 %}
                        {% for rec in recommendations[:3] %}
                        <div class="recommendation-item">
                            <div class="rec-icon {% if loop.index % 2 == 0 %}purple{% else %}blue{% endif %}">
                                <i class="bi bi-{{ rec.icon|default('journal-text') }}" aria-hidden="true"></i>
                            </div>
                            <div class="rec-info">
                                <h4 data-translate="{{ rec.title_key if rec.title_key else rec.title|lower|replace(' ', '_') }}">
                                    {% if t is defined %}{{ t(rec.title_key if rec.title_key else rec.title|lower|replace(' ', '_'), g.lang) }}{% else %}{{ rec.title }}{% endif %}
                                </h4>
                                <span data-translate="{{ rec.subject_name_key if rec.subject_name_key else 'subject_name' }}">
                                    {% if t is defined %}{{ t(rec.subject_name_key if rec.subject_name_key else 'subject_name', g.lang) }}{% else %}{{ rec.subject_name }}{% endif %}
                                </span>
                            </div>
                            <button class="rec-action" onclick="startModule({{ rec.module_id }})" title="{% if t is defined %}{{ t('start', g.lang) }}{% else %}Начать{% endif %}" type="button">
                                <i class="bi bi-arrow-right" aria-hidden="true"></i>
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="empty-recommendations">
                        <p data-translate="no_recommendations">{% if t is defined %}{{ t('no_recommendations', g.lang) }}{% else %}Пока нет рекомендаций{% endif %}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Мобильная навигация -->
    <nav class="mobile-nav" aria-label="Мобильная навигация">
        <div class="mobile-nav-container">
            {% for path in learning_paths %}
            <a href="{{ url_for('subject_view_bp.view_category', lang=g.lang, category_id=path.id) if url_for else '#' }}" 
               class="mobile-nav-item {% if selected_path and selected_path.id == path.id %}active{% endif %}" 
               data-category="{{ path.slug if path.slug else path.name|lower|replace(' ', '-') }}"
               data-path="{{ path.id }}"
               role="tab">
                <div class="mobile-nav-icon">
                    {% if path.id == 1 %}
                        <i class="bi bi-book" aria-hidden="true"></i>
                    {% elif path.id == 2 %}
                        <i class="bi bi-chat-heart" aria-hidden="true"></i>
                    {% elif path.id == 3 %}
                        <i class="bi bi-hospital" aria-hidden="true"></i>
                    {% elif path.id == 4 %}
                        <i class="bi bi-clipboard-data" aria-hidden="true"></i>
                    {% elif path.id == 5 %}
                        <i class="bi bi-award" aria-hidden="true"></i>
                    {% elif path.id == 6 %}
                        <i class="bi bi-people" aria-hidden="true"></i>
                    {% elif path.id == 7 %}
                        <i class="bi bi-translate" aria-hidden="true"></i>
                    {% else %}
                        <i class="bi bi-folder" aria-hidden="true"></i>
                    {% endif %}
                </div>
                <span class="mobile-nav-label" data-translate="{{ path.short_name_key or path.name_key if path.short_name_key or path.name_key else path.name|lower|replace(' ', '_') }}">
                    {% if t is defined %}{{ t(path.short_name_key or path.name_key if path.short_name_key or path.name_key else path.name|lower|replace(' ', '_'), g.lang) }}{% else %}{{ path.name }}{% endif %}
                </span>
            </a>
            {% endfor %}
        </div>
    </nav>
</div>

<!-- Модальное окно для планирования экзамена -->
<div class="modal fade" id="examDateModal" tabindex="-1" aria-labelledby="examDateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="examDateModalLabel" data-translate="schedule_exam">{% if t is defined %}{{ t('schedule_exam', g.lang) }}{% else %}Запланировать экзамен{% endif %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <form id="examDateForm">
                    <div class="mb-3">
                        <label for="examDate" class="form-label" data-translate="select_date">{% if t is defined %}{{ t('select_date', g.lang) }}{% else %}Выберите дату{% endif %}</label>
                        <input type="date" class="form-control" id="examDate" name="examDate" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-translate="cancel">{% if t is defined %}{{ t('cancel', g.lang) }}{% else %}Отмена{% endif %}</button>
                <button type="button" class="btn btn-primary" id="saveExamDate" data-translate="save">{% if t is defined %}{{ t('save', g.lang) }}{% else %}Сохранить{% endif %}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_scripts %}
{{ super() }}

<script>

</script>
{% endblock %}