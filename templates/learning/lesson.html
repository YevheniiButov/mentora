{% extends "base.html" %}

{% block title %}
    {% if lang == 'ru' %}–£—Ä–æ–∫: {{ lesson.title }}{% else %}Lesson: {{ lesson.title }}{% endif %} - Dental Academy
{% endblock %}

{% block styles %}
    {{ super() }}
    <!-- –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å—Ç–∏–ª–µ–π -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/themes/themes.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/universal-styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/universal-layout-system.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/learning_map.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/category-navigation.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/learning-map-modules.css') }}">
{% endblock %}

{% block content %}
<div class="learning-map-container">
    <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã -->
    <div class="floating-shape shape-1"></div>
    <div class="floating-shape shape-2"></div>
    <div class="floating-shape shape-3"></div>
    <div class="floating-shape shape-4"></div>
    
    <div class="main-container">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ —Å –ø–æ–¥—Ç–µ–º–∞–º–∏ -->
        <div class="left-column">
            <div class="section-header">
                <h2>{% if lang == 'ru' %}–ü–æ–¥—Ç–µ–º—ã{% else %}Subtopics{% endif %}</h2>
            </div>
            
            <div class="subtopics-list">
                {% for subtopic in subtopics_with_progress %}
                <a href="{{ url_for('modules_bp.subtopic_lessons_list', lang=lang, module_id=module.id, slug=subtopic.slug) }}" 
                   class="subject-item {% if subtopic.is_current %}active{% endif %}">
                    <span class="subject-name">{{ subtopic.name }}</span>
                    <div class="subject-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ subtopic.progress_percent }}%"></div>
                        </div>
                        <span class="progress-percent">{{ subtopic.progress_percent }}%</span>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —É—Ä–æ–∫–∞ -->
        <div class="middle-column">
            <div class="page-header">
                <div class="breadcrumb">
                    {% if module %}<span>{{ module.title }}</span><span class="separator">/</span>{% endif %}
                    <span class="active">{{ lesson.title }}</span>
                </div>
                <h1>{{ lesson.title }}</h1>
            </div>

            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å —É—Ä–æ–∫–∞ -->
            <div class="lesson-progress glass-effect">
                <div class="progress-info">
                    {% if lang == 'ru' %}–£—Ä–æ–∫{% else %}Lesson{% endif %} {{ lesson_index + 1 }} / {{ total_lessons }}
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ (lesson_index + 1) / total_lessons * 100 }}%"></div>
                </div>
                <div class="progress-info">{{ (lesson_index + 1) / total_lessons * 100 | round(2) }}%</div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —É—Ä–æ–∫–∞ -->
            <div class="lesson-content">
                <div class="lesson-header-actions">
                    <h1>{{ lesson.title }}</h1>
                    
                    {% if current_user.is_authenticated and (current_user.role == 'admin' or current_user.role == 'content_admin' or current_user.role == 'super_admin') %}
                    <div class="lesson-admin-actions">
                        <a href="{{ url_for('content_editor.editor_interface', lang=lang, lesson_id=lesson.id) }}" 
                           class="btn btn-outline-primary btn-sm" 
                           title="{% if lang == 'ru' %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –≤–∏–∑—É–∞–ª—å–Ω–æ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ{% else %}Edit with Visual Editor{% endif %}">
                            <i class="bi bi-palette"></i>
                            {% if lang == 'ru' %}–í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä{% else %}Visual Editor{% endif %}
                        </a>
                    </div>
                    {% endif %}
                </div>
                
                {% if processed_content and processed_content.type == 'learning_cards' %}
                    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—É—á–∞—é—â–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ -->
                    {% for card in processed_content.cards %}
                        <div class="content-card">
                            <h3 class="card-question">{{ card.question }}</h3>
                            <div class="card-answer">{{ card.answer|safe }}</div>
                            {% if card.tags %}
                                <div class="card-tags">
                                    {% for tag in card.tags %}
                                        <span class="tag">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                
                {% elif processed_content and processed_content.type == 'quiz' %}
                    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ -->
                    {% for question in processed_content.questions %}
                        <div class="content-card">
                            <h3 class="card-question">–í–æ–ø—Ä–æ—Å {{ loop.index }}: {{ question.question }}</h3>
                            <div class="test-options">
                                {% for option in question.options %}
                                    <div class="test-option {% if question.answer == loop.index0|string or question.answer == ['A', 'B', 'C', 'D'][loop.index0] %}correct{% endif %}">
                                        <strong>{{ ['A', 'B', 'C', 'D'][loop.index0] }})</strong> {{ option }}
                                        {% if question.answer == loop.index0|string or question.answer == ['A', 'B', 'C', 'D'][loop.index0] %}
                                            <i class="bi bi-check-circle-fill text-success float-end"></i>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                            {% if question.explanation %}
                                <div class="quiz-explanation mt-3">
                                    <h4>–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:</h4>
                                    <p>{{ question.explanation }}</p>
                                </div>
                            {% endif %}
                            {% if question.tags %}
                                <div class="card-tags">
                                    {% for tag in question.tags %}
                                        <span class="tag">{{ tag }}</span>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                
                {% else %}
                    <!-- –ü—Ä–æ—Å—Ç–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
                    <div class="content-card">
                        {% if processed_content and processed_content.content %}
                            {{ processed_content.content|safe }}
                        {% elif lesson.content %}
                            {{ lesson.content|safe }}
                        {% else %}
                            <p>{% if lang == 'ru' %}–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —ç—Ç–æ–≥–æ —É—Ä–æ–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.{% else %}Content for this lesson is missing.{% endif %}</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            
            <!-- –≠–∫—Ä–∞–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞ -->
            <div class="completion-screen universal-card" id="completion-screen" style="display: none;">
                <div class="completion-content">
                    <!-- –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è -->
                    <div class="celebration-animation">
                        <div class="confetti"></div>
                        <div class="trophy-icon">
                            <i class="bi bi-trophy-fill"></i>
                        </div>
                    </div>
                    
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è -->
                    <div class="completion-header">
                        <h2>üéâ {% if lang == 'ru' %}–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!{% else %}Congratulations!{% endif %}</h2>
                        <p>{% if lang == 'ru' %}–£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω{% else %}Lesson completed{% endif %}: <strong>{{ lesson.title }}</strong></p>
                    </div>
                    
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è -->
                    <div class="completion-stats">
                        <div class="stat-grid">
                            <div class="completion-stat">
                                <div class="stat-icon">
                                    <i class="bi bi-check-circle-fill"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">100%</div>
                                    <div class="stat-label">{% if lang == 'ru' %}–ü—Ä–æ–≥—Ä–µ—Å—Å{% else %}Progress{% endif %}</div>
                                </div>
                            </div>
                            
                            <div class="completion-stat">
                                <div class="stat-icon">
                                    <i class="bi bi-clock-fill"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value" id="time-spent">-</div>
                                    <div class="stat-label">{% if lang == 'ru' %}–í—Ä–µ–º—è –∏–∑—É—á–µ–Ω–∏—è{% else %}Time spent{% endif %}</div>
                                </div>
                            </div>
                            
                            <div class="completion-stat">
                                <div class="stat-icon">
                                    <i class="bi bi-star-fill"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">{{ lesson_index + 1 }}/{{ total_lessons }}</div>
                                    <div class="stat-label">{% if lang == 'ru' %}–£—Ä–æ–∫ –≤ –º–æ–¥—É–ª–µ{% else %}Lesson in module{% endif %}</div>
                                </div>
                            </div>
                            
                            <div class="completion-stat">
                                <div class="stat-icon">
                                    <i class="bi bi-graph-up"></i>
                                </div>
                                <div class="stat-info">
                                    <div class="stat-value">{{ module.title }}</div>
                                    <div class="stat-label">{% if lang == 'ru' %}–ú–æ–¥—É–ª—å{% else %}Module{% endif %}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
                    <div class="achievements-section" id="achievements-section" style="display: none;">
                        <h3>üèÜ {% if lang == 'ru' %}–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã{% else %}Achievements unlocked{% endif %}</h3>
                        <div class="achievements-list" id="achievements-list">
                            <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
                        </div>
                    </div>
                    
                    <!-- –î–µ–π—Å—Ç–≤–∏—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è -->
                    <div class="completion-actions">
                        <div class="primary-actions">
                            {% if lesson_index + 1 < total_lessons %}
                                <button class="universal-button success" id="continue-learning-btn">
                                    <i class="bi bi-arrow-right"></i>
                                    {% if lang == 'ru' %}–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫{% else %}Next Lesson{% endif %}
                                </button>
                            {% else %}
                                <button class="universal-button success" id="continue-learning-btn">
                                    <i class="bi bi-check-circle"></i>
                                    {% if lang == 'ru' %}–ó–∞–≤–µ—Ä—à–∏—Ç—å –º–æ–¥—É–ª—å{% else %}Complete Module{% endif %}
                                </button>
                            {% endif %}
                            <button class="universal-button primary" onclick="window.location.href='{{ url_for('modules_bp.module_view', lang=lang, module_id=module.id) }}'">
                                <i class="bi bi-grid"></i>
                                {% if lang == 'ru' %}–ö –º–æ–¥—É–ª—é{% else %}Back to Module{% endif %}
                            </button>
                        </div>
                        
                        <div class="secondary-actions">
                            <button class="universal-button secondary" onclick="window.location.reload()">
                                <i class="bi bi-arrow-repeat"></i>
                                {% if lang == 'ru' %}–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —É—Ä–æ–∫{% else %}Retake Lesson{% endif %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —É—Ä–æ–∫–∞–º -->
            <div class="lesson-navigation">
                {% if lesson_index > 0 %}
                    <a href="{{ url_for('lesson_bp.lesson_view', lang=lang, module_id=module.id, lesson_index=lesson_index - 1) }}" class="nav-button">
                        <i class="bi bi-arrow-left"></i>
                        {% if lang == 'ru' %}–ü—Ä–µ–¥—ã–¥—É—â–∏–π —É—Ä–æ–∫{% else %}Previous Lesson{% endif %}
                    </a>
                {% else %}
                    <a href="{{ url_for('modules_bp.module_view', lang=lang, module_id=module.id) }}" class="nav-button">
                        <i class="bi bi-arrow-left"></i>
                        {% if lang == 'ru' %}–ö –º–æ–¥—É–ª—é{% else %}Back to Module{% endif %}
                    </a>
                {% endif %}
                
                <button class="complete-button" onclick="markAsCompleted()">
                    <i class="bi bi-check-circle"></i>
                    {% if lang == 'ru' %}–ó–∞–≤–µ—Ä—à–∏—Ç—å —É—Ä–æ–∫{% else %}Complete Lesson{% endif %}
                </button>
                
                {% if lesson_index + 1 < total_lessons %}
                    <a href="{{ url_for('lesson_bp.lesson_view', lang=lang, module_id=module.id, lesson_index=lesson_index + 1) }}" class="nav-button">
                        {% if lang == 'ru' %}–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫{% else %}Next Lesson{% endif %}
                        <i class="bi bi-arrow-right"></i>
                    </a>
                {% else %}
                    <a href="{{ url_for('modules_bp.module_view', lang=lang, module_id=module.id) }}" class="nav-button">
                        {% if lang == 'ru' %}–ó–∞–≤–µ—Ä—à–∏—Ç—å –º–æ–¥—É–ª—å{% else %}Complete Module{% endif %}
                        <i class="bi bi-check-circle"></i>
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/universal-category-system.js') }}"></script>
<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–π
document.addEventListener('DOMContentLoaded', function() {
    // –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ universal-category-system.js
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
    
    // –ó–∞—Å–µ–∫–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∏–∑—É—á–µ–Ω–∏—è —É—Ä–æ–∫–∞
    window.lessonStartTime = Date.now();
});

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–∫–∞
function markAsCompleted() {
    fetch(`{{ url_for('learning_map_bp.mark_lesson_completed', lang=lang, lesson_id=lesson.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            showCompletionScreen();
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —ç–∫—Ä–∞–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
function showCompletionScreen() {
    // –°–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —É—Ä–æ–∫–∞
    const lessonContent = document.querySelector('.lesson-content');
    const lessonNavigation = document.querySelector('.lesson-navigation');
    const completionScreen = document.getElementById('completion-screen');
    
    if (lessonContent) lessonContent.style.display = 'none';
    if (lessonNavigation) lessonNavigation.style.display = 'none';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    completionScreen.style.display = 'block';
    completionScreen.classList.add('show');
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    const endTime = Date.now();
    const timeSpent = Math.floor((endTime - window.lessonStartTime) / 1000 / 60); // –≤ –º–∏–Ω—É—Ç–∞—Ö
    
    document.getElementById('time-spent').textContent = `${timeSpent} –º–∏–Ω`;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    showAchievements(timeSpent);
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ"
    const continueBtn = document.getElementById('continue-learning-btn');
    if (continueBtn) {
        continueBtn.addEventListener('click', function() {
            {% if lesson_index + 1 < total_lessons %}
                window.location.href = '{{ url_for("lesson_bp.lesson_view", lang=lang, module_id=module.id, lesson_index=lesson_index + 1) }}';
            {% else %}
                window.location.href = '{{ url_for("modules_bp.module_view", lang=lang, module_id=module.id) }}';
            {% endif %}
        });
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
function showAchievements(timeSpent) {
    const achievementsSection = document.getElementById('achievements-section');
    const achievementsList = document.getElementById('achievements-list');
    const achievements = [];
    
    // –õ–æ–≥–∏–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
    if (timeSpent <= 5) {
        achievements.push({ icon: '‚ö°', text: '{% if lang == "ru" %}–ë—ã—Å—Ç—Ä–æ–µ –∏–∑—É—á–µ–Ω–∏–µ!{% else %}Fast learning!{% endif %}' });
    }
    
    if (timeSpent >= 10) {
        achievements.push({ icon: 'üìö', text: '{% if lang == "ru" %}–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ!{% else %}Thorough study!{% endif %}' });
    }
    
    achievements.push({ icon: 'üéØ', text: '{% if lang == "ru" %}–£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω!{% else %}Lesson completed!{% endif %}' });
    
    if (achievements.length > 0) {
        achievementsList.innerHTML = achievements.map(achievement => 
            `<div class="achievement-badge">
                <span>${achievement.icon}</span>
                <span>${achievement.text}</span>
            </div>`
        ).join('');
        achievementsSection.style.display = 'block';
    }
}
</script>
{% endblock %}