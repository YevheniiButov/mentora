{% extends "base.html" %}

{% block title %}–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±—É—á–µ–Ω–∏–µ - –ü—Ä–∞–∫—Ç–∏–∫–∞{% endblock %}

{% block extra_css %}
<style>
.practice-session-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

.session-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    text-align: center;
}

.question-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin-bottom: 30px;
    overflow: hidden;
}

.question-header {
    background: #f8f9fa;
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
}

.question-number {
    font-size: 1.2em;
    font-weight: bold;
    color: #667eea;
}

.question-text {
    padding: 30px;
    font-size: 1.1em;
    line-height: 1.6;
}

.options-container {
    padding: 0 30px 30px;
}

.option {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.option:hover {
    background: #e9ecef;
    border-color: #667eea;
}

.option.selected {
    background: #667eea;
    color: white;
    border-color: #667eea;
}

.option.correct {
    background: #28a745;
    color: white;
    border-color: #28a745;
}

.option.incorrect {
    background: #dc3545;
    color: white;
    border-color: #dc3545;
}

.explanation {
    background: #e7f3ff;
    border-left: 4px solid #667eea;
    padding: 20px;
    margin: 20px 30px;
    border-radius: 5px;
    display: none;
}

.session-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    text-align: center;
}

.stat-value {
    font-size: 2em;
    font-weight: bold;
    color: #667eea;
}

.stat-label {
    color: #666;
    margin-top: 5px;
}

.session-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 30px;
}

.btn-session {
    padding: 12px 25px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
}

.btn-primary {
    background: #28a745;
    color: white;
}

.btn-primary:hover {
    background: #218838;
    color: white;
    transform: translateY(-2px);
}

.btn-secondary {
    background: #f8f9fa;
    color: #333;
    border: 1px solid #ddd;
}

.btn-secondary:hover {
    background: #e9ecef;
    color: #333;
    transform: translateY(-2px);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.progress-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #667eea;
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    z-index: 1000;
}
</style>
{% endblock %}

{% block content %}
<div class="practice-session-container">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–µ—Å—Å–∏–∏ -->
    <div class="session-header">
        <h1>üí™ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å–µ—Å—Å–∏—è</h1>
        <p>–ù–µ–¥–µ–ª—è {{ current_week }} ‚Ä¢ {{ current_session.type|title }} ‚Ä¢ {{ current_session.duration }}—á</p>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–∏ -->
    <div class="session-stats">
        <div class="stat-card">
            <div class="stat-value" id="questions-answered">0</div>
            <div class="stat-label">–í–æ–ø—Ä–æ—Å–æ–≤ –æ—Ç–≤–µ—á–µ–Ω–æ</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="correct-answers">0</div>
            <div class="stat-label">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="accuracy">0%</div>
            <div class="stat-label">–¢–æ—á–Ω–æ—Å—Ç—å</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="time-spent">0:00</div>
            <div class="stat-label">–í—Ä–µ–º—è</div>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–æ–ø—Ä–æ—Å–∞ -->
    <div class="question-container" id="question-container">
        <div class="question-header">
            <div class="question-number">–í–æ–ø—Ä–æ—Å <span id="current-question">1</span> –∏–∑ <span id="total-questions">{{ practice_questions|length }}</span></div>
        </div>
        
        <div class="question-text" id="question-text">
            <!-- –¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –∑–¥–µ—Å—å -->
        </div>
        
        <div class="options-container" id="options-container">
            <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–¥–µ—Å—å -->
        </div>
        
        <div class="explanation" id="explanation">
            <!-- –û–±—ä—è—Å–Ω–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ –∑–¥–µ—Å—å -->
        </div>
    </div>

    <!-- –î–µ–π—Å—Ç–≤–∏—è —Å–µ—Å—Å–∏–∏ -->
    <div class="session-actions">
        <a href="{{ url_for('dashboard.learning_plan', plan_id=plan.id) }}" class="btn-session btn-secondary">
            <i class="bi bi-arrow-left"></i>
            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ø–ª–∞–Ω—É
        </a>
        <button class="btn-session btn-primary" id="next-question" disabled>
            <i class="bi bi-arrow-right"></i>
            –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
        </button>
        <button class="btn-session btn-primary" id="complete-session" style="display: none;">
            <i class="bi bi-check-circle"></i>
            –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é
        </button>
    </div>
</div>

<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ -->
<div class="progress-indicator" id="progress-indicator">
    –í–æ–ø—Ä–æ—Å <span id="progress-current">1</span> –∏–∑ <span id="progress-total">{{ practice_questions|length }}</span>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const questions = {{ practice_questions|tojson }};
    let currentQuestionIndex = 0;
    let questionsAnswered = 0;
    let correctAnswers = 0;
    let startTime = Date.now();
    let selectedAnswer = null;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    loadQuestion(currentQuestionIndex);
    updateStats();
    
    function loadQuestion(index) {
        if (index >= questions.length) {
            showCompletion();
            return;
        }
        
        const question = questions[index];
        document.getElementById('question-text').innerHTML = question.text;
        document.getElementById('current-question').textContent = index + 1;
        document.getElementById('progress-current').textContent = index + 1;
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = '';
        
        const options = JSON.parse(question.options);
        options.forEach((option, optionIndex) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option';
            optionDiv.textContent = option;
            optionDiv.dataset.option = optionIndex;
            optionDiv.addEventListener('click', () => selectOption(optionDiv, option));
            optionsContainer.appendChild(optionDiv);
        });
        
        // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
        selectedAnswer = null;
        document.getElementById('next-question').disabled = true;
        document.getElementById('explanation').style.display = 'none';
    }
    
    function selectOption(optionElement, answer) {
        // –£–±—Ä–∞—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–±–æ—Ä
        document.querySelectorAll('.option').forEach(opt => {
            opt.classList.remove('selected');
        });
        
        // –í—ã–±—Ä–∞—Ç—å –Ω–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
        optionElement.classList.add('selected');
        selectedAnswer = answer;
        document.getElementById('next-question').disabled = false;
    }
    
    function checkAnswer() {
        const question = questions[currentQuestionIndex];
        const isCorrect = selectedAnswer === question.correct_answer;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        document.querySelectorAll('.option').forEach(option => {
            const optionText = option.textContent;
            if (optionText === question.correct_answer) {
                option.classList.add('correct');
            } else if (optionText === selectedAnswer && !isCorrect) {
                option.classList.add('incorrect');
            }
        });
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
        if (question.explanation) {
            const explanation = document.getElementById('explanation');
            explanation.innerHTML = `<strong>–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:</strong> ${question.explanation}`;
            explanation.style.display = 'block';
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        questionsAnswered++;
        if (isCorrect) correctAnswers++;
        updateStats();
        
        // –û—Ç–∫–ª—é—á–∏—Ç—å –≤—ã–±–æ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
        document.querySelectorAll('.option').forEach(option => {
            option.style.pointerEvents = 'none';
        });
    }
    
    function updateStats() {
        document.getElementById('questions-answered').textContent = questionsAnswered;
        document.getElementById('correct-answers').textContent = correctAnswers;
        
        const accuracy = questionsAnswered > 0 ? Math.round((correctAnswers / questionsAnswered) * 100) : 0;
        document.getElementById('accuracy').textContent = accuracy + '%';
        
        const timeSpent = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(timeSpent / 60);
        const seconds = timeSpent % 60;
        document.getElementById('time-spent').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function showCompletion() {
        document.getElementById('question-container').innerHTML = `
            <div style="text-align: center; padding: 50px;">
                <h2>üéâ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
                <p>–í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ ${questionsAnswered} –≤–æ–ø—Ä–æ—Å–æ–≤</p>
                <p>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${correctAnswers} –∏–∑ ${questionsAnswered}</p>
                <p>–¢–æ—á–Ω–æ—Å—Ç—å: ${Math.round((correctAnswers / questionsAnswered) * 100)}%</p>
            </div>
        `;
        
        document.getElementById('next-question').style.display = 'none';
        document.getElementById('complete-session').style.display = 'inline-block';
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('next-question').addEventListener('click', function() {
        if (selectedAnswer) {
            checkAnswer();
            
            setTimeout(() => {
                currentQuestionIndex++;
                loadQuestion(currentQuestionIndex);
            }, 2000);
        }
    });
    
    document.getElementById('complete-session').addEventListener('click', function() {
        const timeSpent = Math.floor((Date.now() - startTime) / 1000 / 60); // –≤ –º–∏–Ω—É—Ç–∞—Ö
        
        fetch('{{ url_for("learning.complete_automated_session") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                questions_answered: questionsAnswered,
                correct_answers: correctAnswers,
                time_spent: timeSpent
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.completed) {
                    window.location.href = data.redirect_url;
                } else {
                    window.location.href = data.redirect_url;
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏');
        });
    });
});
</script>
{% endblock %} 