{% extends "mobile_base.html" %}

{% block title %}{{ lesson.title }} | Dental Academy{% endblock %}
{% block meta_description %}Изучите урок "{{ lesson.title }}" - {{ lesson.description }}{% endblock %}

{% block mobile_title %}{{ lesson.title }}{% endblock %}

{% block mobile_header_left %}
<a href="{{ url_for('modules_bp.module_view', module_id=lesson.module.id, lang=current_language) }}" class="mobile-header-action">
  <i class="bi bi-arrow-left"></i>
</a>
{% endblock %}

{% block mobile_header_actions %}
<button class="mobile-header-action" id="mobile-theme-toggle" aria-label="{{ t('toggle_theme') }}">
  <i class="bi bi-moon theme-icon"></i>
</button>

<button class="mobile-header-action" id="mobile-share-button" aria-label="{{ t('share') }}">
  <i class="bi bi-share"></i>
</button>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
  /* Стили для мобильного отображения урока */
  .mobile-lesson-container {
    padding: var(--mobile-padding);
  }
  
  .mobile-lesson-header {
    margin-bottom: 1.5rem;
  }
  
  .mobile-lesson-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    font-size: 0.85rem;
    color: var(--mobile-text-secondary);
    margin: 0.5rem 0 1rem;
  }
  
  .mobile-lesson-meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--mobile-bg-tertiary);
    padding: 0.4rem 0.75rem;
    border-radius: 100px;
  }
  
  .mobile-lesson-content {
    line-height: 1.6;
    font-size: 1rem;
  }
  
  .mobile-lesson-content h2 {
    font-size: 1.4rem;
    margin: 1.5rem 0 1rem;
    color: var(--mobile-text-primary);
    font-weight: 600;
  }
  
  .mobile-lesson-content h3 {
    font-size: 1.2rem;
    margin: 1.2rem 0 0.8rem;
    color: var(--mobile-text-primary);
    font-weight: 600;
  }
  
  .mobile-lesson-content p {
    margin-bottom: 1rem;
    color: var(--mobile-text-primary);
  }
  
  .mobile-lesson-content img {
    max-width: 100%;
    border-radius: 12px;
    margin: 1rem 0;
  }
  
  .mobile-lesson-content ul, .mobile-lesson-content ol {
    margin: 0.8rem 0 1rem 1.2rem;
  }
  
  .mobile-lesson-content li {
    margin-bottom: 0.5rem;
  }
  
  .mobile-lesson-card {
    background: var(--mobile-bg-secondary);
    border-radius: 16px;
    padding: 1.2rem;
    margin: 1.5rem 0;
    border-left: 4px solid var(--primary-color);
  }
  
  .mobile-lesson-card-title {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--mobile-text-primary);
  }
  
  .mobile-complete-button {
    position: fixed;
    bottom: calc(var(--mobile-nav-height) + 1rem);
    left: var(--mobile-padding);
    right: var(--mobile-padding);
    padding: 0.9rem;
    background: var(--primary-color);
    color: white;
    border-radius: 12px;
    font-weight: 600;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    z-index: 90;
    box-shadow: 0 4px 12px rgba(62, 205, 193, 0.3);
    transition: transform 0.2s ease;
  }
  
  .mobile-complete-button:active {
    transform: scale(0.98);
  }
  
  .mobile-complete-button.completed {
    background: #2ecc71;
  }
  
  .mobile-lesson-progress {
    height: 4px;
    background: var(--mobile-bg-tertiary);
    border-radius: 2px;
    margin: 1.5rem 0;
    overflow: hidden;
  }
  
  .mobile-lesson-progress-bar {
    height: 100%;
    background: var(--primary-color);
    width: 0;
    transition: width 0.3s ease;
  }
  
  .mobile-lesson-navigation {
    display: flex;
    gap: 1rem;
    margin: 2rem 0 4rem;
  }
  
  .mobile-lesson-nav-button {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: var(--mobile-bg-tertiary);
    color: var(--mobile-text-primary);
    border-radius: 12px;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.9rem;
  }
  
  .mobile-lesson-nav-button.prev {
    justify-content: flex-start;
  }
  
  .mobile-lesson-nav-button.next {
    justify-content: flex-end;
  }
  
  /* Отступ внизу для плавающей кнопки */
  .mobile-bottom-spacing {
    height: 5rem;
  }
</style>
{% endblock %}

{% block mobile_content %}
<div class="mobile-lesson-container">
  <!-- Lesson Header -->
  <div class="mobile-lesson-header">
    <div class="mobile-lesson-meta">
      <div class="mobile-lesson-meta-item">
        <i class="bi bi-clock"></i>
        <span>{{ lesson.reading_time|default('10') }} {{ t('minutes') }}</span>
      </div>
      
      <div class="mobile-lesson-meta-item">
        <i class="bi bi-book"></i>
        <span>{{ lesson.difficulty|default('Базовый') }}</span>
      </div>
    </div>
    
    <!-- Reading Progress Bar -->
    <div class="mobile-lesson-progress" id="reading-progress">
      <div class="mobile-lesson-progress-bar" id="reading-progress-bar"></div>
    </div>
  </div>
  
  <!-- Lesson Content -->
  <div class="mobile-lesson-content">
    {{ lesson.content|safe }}
    
    <!-- Important Info Card -->
    <div class="mobile-lesson-card">
      <div class="mobile-lesson-card-title">{{ t('important_info') }}</div>
      <p>{{ lesson.important_info|default('Обратите внимание на ключевые моменты этого урока для лучшего понимания темы.')|safe }}</p>
    </div>
  </div>
  
  <!-- Lesson Navigation -->
  <div class="mobile-lesson-navigation">
    {% if prev_lesson %}
    <a href="{{ url_for('lesson_bp.lesson_view', lesson_id=prev_lesson.id, lang=current_language) }}" class="mobile-lesson-nav-button prev">
      <i class="bi bi-arrow-left"></i>
      {{ t('previous') }}
    </a>
    {% else %}
    <div class="mobile-lesson-nav-button prev" style="opacity: 0.5; pointer-events: none;">
      <i class="bi bi-arrow-left"></i>
      {{ t('previous') }}
    </div>
    {% endif %}
    
    {% if next_lesson %}
    <a href="{{ url_for('lesson_bp.lesson_view', lesson_id=next_lesson.id, lang=current_language) }}" class="mobile-lesson-nav-button next">
      {{ t('next') }}
      <i class="bi bi-arrow-right"></i>
    </a>
    {% else %}
    <div class="mobile-lesson-nav-button next" style="opacity: 0.5; pointer-events: none;">
      {{ t('next') }}
      <i class="bi bi-arrow-right"></i>
    </div>
    {% endif %}
  </div>
  
  <!-- Bottom spacing -->
  <div class="mobile-bottom-spacing"></div>
</div>

<!-- Floating Complete Button -->
<button id="mobile-complete-button" class="mobile-complete-button">
  <i class="bi bi-check-circle-fill"></i>
  {{ t('mark_as_complete') }}
</button>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Reading progress tracking
  function updateReadingProgress() {
    const scrollPosition = window.scrollY;
    const scrollHeight = document.documentElement.scrollHeight - window.innerHeight;
    const scrollPercentage = (scrollPosition / scrollHeight) * 100;
    
    const progressBar = document.getElementById('reading-progress-bar');
    if (progressBar) {
      progressBar.style.width = scrollPercentage + '%';
    }
  }
  
  window.addEventListener('scroll', updateReadingProgress);
  updateReadingProgress(); // Initial call
  
  // Mark as complete functionality
  const completeButton = document.getElementById('mobile-complete-button');
  
  if (completeButton) {
    completeButton.addEventListener('click', function() {
      // Show loading state
      completeButton.innerHTML = '<i class="bi bi-hourglass-split"></i> {{ t("processing") }}';
      completeButton.disabled = true;
      
      // Make API request to mark lesson as complete
      fetch('/api/lessons/{{ lesson.id }}/complete', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': '{{ csrf_token() }}'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update button appearance
          completeButton.innerHTML = '<i class="bi bi-check-circle-fill"></i> {{ t("completed") }}';
          completeButton.classList.add('completed');
          
          // Show success message
          const toast = document.createElement('div');
          toast.className = 'mobile-toast mobile-toast-success show';
          toast.innerHTML = `
            <div class="mobile-toast-content">
              <div class="mobile-toast-icon"><i class="bi bi-check-circle"></i></div>
              <div class="mobile-toast-text">${data.message || '{{ t("lesson_completed") }}'}</div>
            </div>
          `;
          document.body.appendChild(toast);
          
          setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
          }, 3000);
          
          // Redirect to next lesson if available
          {% if next_lesson %}
          setTimeout(() => {
            window.location.href = '{{ url_for("lesson_bp.lesson_view", lesson_id=next_lesson.id, lang=current_language) }}';
          }, 2000);
          {% endif %}
        } else {
          // Reset button on error
          completeButton.innerHTML = '<i class="bi bi-check-circle-fill"></i> {{ t("mark_as_complete") }}';
          completeButton.disabled = false;
          
          // Show error message
          const toast = document.createElement('div');
          toast.className = 'mobile-toast mobile-toast-error show';
          toast.innerHTML = `
            <div class="mobile-toast-content">
              <div class="mobile-toast-icon"><i class="bi bi-x-circle"></i></div>
              <div class="mobile-toast-text">${data.message || '{{ t("error_completing_lesson") }}'}</div>
            </div>
          `;
          document.body.appendChild(toast);
          
          setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        // Reset button
        completeButton.innerHTML = '<i class="bi bi-check-circle-fill"></i> {{ t("mark_as_complete") }}';
        completeButton.disabled = false;
        
        // Show error message
        const toast = document.createElement('div');
        toast.className = 'mobile-toast mobile-toast-error show';
        toast.innerHTML = `
          <div class="mobile-toast-content">
            <div class="mobile-toast-icon"><i class="bi bi-x-circle"></i></div>
            <div class="mobile-toast-text">{{ t("network_error") }}</div>
          </div>
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      });
    });
  }
  
  // Share functionality
  const shareButton = document.getElementById('mobile-share-button');
  if (shareButton && navigator.share) {
    shareButton.style.display = 'flex';
    shareButton.addEventListener('click', async () => {
      try {
        await navigator.share({
          title: '{{ lesson.title }} | Dental Academy',
          text: '{{ lesson.description }}',
          url: window.location.href
        });
      } catch (error) {
        console.log('Ошибка при попытке поделиться:', error);
      }
    });
  } else if (shareButton) {
    shareButton.style.display = 'none';
  }
});
</script>
{% endblock %} 