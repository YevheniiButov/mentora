# –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã –≤ –Ω–∞—á–∞–ª–æ routes/main_routes.py

from mobile_integration import render_adaptive_template, mobile_template_manager
from utils.mobile_detection import get_user_stats, get_app_stats, get_mobile_detector

# –ó–∞–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–æ—É—Ç –¥–æ–º–∞—à–Ω–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ —ç—Ç–æ—Ç:

@main_bp.route('/<string:lang>/')
@main_bp.route('/<string:lang>/index')
@main_bp.route('/<string:lang>/home')
def home(lang):
    """
    –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤—ã–±–æ—Ä–æ–º —à–∞–±–ª–æ–Ω–∞
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —è–∑—ã–∫–∞
    if lang not in current_app.config.get('SUPPORTED_LANGUAGES', ['en']):
        lang = current_app.config.get('DEFAULT_LANGUAGE', 'en')
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫ –≤ g
    g.lang = lang
    g.current_language = lang  # –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å mobile_base.html
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    stats = get_app_stats()
    user_data = get_user_stats()
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
    detector = get_mobile_detector()
    
    # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    print(f"üè† Home route called with lang: {lang}")
    print(f"üì± Is mobile device: {detector.is_mobile_device}")
    print(f"üë§ User authenticated: {current_user.is_authenticated}")
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    mobile_template_manager.register_mobile_template('index.html', 'welcome_mobile.html')
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É
    return render_adaptive_template(
        'index.html', 
        stats=stats,
        user_data=user_data,
        current_language=lang,
        supported_languages=current_app.config.get('SUPPORTED_LANGUAGES', []),
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è mobile_base.html
        has_pending_tests=False,  # TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ—Å—Ç–æ–≤
        get_country_code=lambda code: {
            'en': 'gb', 'nl': 'nl', 'ru': 'ru', 'uk': 'ua',
            'es': 'es', 'pt': 'pt', 'tr': 'tr', 'fa': 'ir'
        }.get(code, code)
    )

# –ù–æ–≤—ã–π API —Ä–æ—É—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
@main_bp.route('/api/<string:lang>/welcome-stats')
def api_welcome_stats(lang):
    """
    API endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
    """
    try:
        stats = get_app_stats()
        user_data = get_user_stats() if current_user.is_authenticated else None
        
        return jsonify({
            'success': True,
            'stats': stats,
            'user_data': user_data,
            'device_type': 'mobile' if is_mobile_device() else 'desktop'
        })
        
    except Exception as e:
        current_app.logger.error(f"Error getting welcome stats: {e}")
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

# –†–æ—É—Ç –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –º–æ–±–∏–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
@main_bp.route('/<string:lang>/mobile-welcome')
def mobile_welcome(lang):
    """
    –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
    """
    if lang not in current_app.config.get('SUPPORTED_LANGUAGES', ['en']):
        lang = current_app.config.get('DEFAULT_LANGUAGE', 'en')
    
    g.lang = lang
    g.current_language = lang
    
    stats = get_app_stats()
    user_data = get_user_stats()
    
    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–±–∏–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω
    return render_template(
        'welcome_mobile.html',
        stats=stats,
        user_data=user_data,
        current_language=lang,
        supported_languages=current_app.config.get('SUPPORTED_LANGUAGES', []),
        has_pending_tests=False,
        get_country_code=lambda code: {
            'en': 'gb', 'nl': 'nl', 'ru': 'ru', 'uk': 'ua',
            'es': 'es', 'pt': 'pt', 'tr': 'tr', 'fa': 'ir'
        }.get(code, code)
    )

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ä–æ—É—Ç –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —è–∑—ã–∫–∞ (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
@main_bp.route('/set-language/<string:lang>')
def set_language(lang):
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —è–∑—ã–∫ –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    """
    if lang in current_app.config.get('SUPPORTED_LANGUAGES', ['en']):
        session['lang'] = lang
        flash(f'Language changed to {lang}', 'success')
    
    # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –Ω–æ–≤—ã–º —è–∑—ã–∫–æ–º
    return redirect(url_for('main_bp.home', lang=lang))

# Middleware –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ mobile detection (–¥–æ–±–∞–≤–∏—Ç—å –≤ app.py)
"""
–í app.py –¥–æ–±–∞–≤–∏—Ç—å:

from mobile_detection import setup_mobile_detection, mobile_detection_middleware

# –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
setup_mobile_detection(app)
mobile_detection_middleware(app)
"""
# –í app.py –¥–æ–±–∞–≤–∏—Ç—å —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã –ø–æ—Å–ª–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö:

from mobile_integration import init_mobile_integration
from utils.mobile_detection import setup_mobile_detection

# –í —Ñ—É–Ω–∫—Ü–∏–∏ create_app() –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Blueprint'–æ–≤ –¥–æ–±–∞–≤–∏—Ç—å:

def create_app(test_config=None):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    # –ü–û–°–õ–ï —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—Å–µ—Ö Blueprint'–æ–≤ –¥–æ–±–∞–≤–∏—Ç—å:
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–±–∏–ª—å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
    init_mobile_integration(app)
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    setup_mobile_detection(app)
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π —à–∞–±–ª–æ–Ω–æ–≤
    from mobile_integration import mobile_template_manager
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —à–∞–±–ª–æ–Ω–æ–≤
    additional_mappings = {
        'index.html': 'welcome_mobile.html',
        'big-info.html': 'big-info_mobile.html',
        'demo.html': 'demo_mobile.html',
    }
    
    for desktop, mobile in additional_mappings.items():
        mobile_template_manager.register_mobile_template(desktop, mobile)
    
    print("‚úÖ Mobile integration and detection initialized")
    
    # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    return 
    
    # üîß –ß–µ–∫-–ª–∏—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π mobile_integration.py

## ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

**–ù–ï –°–û–ó–î–ê–í–ê–¢–¨** –∫–æ—Ä–Ω–µ–≤–æ–π `mobile_detection.py` - –±—É–¥–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç!

**–°–û–ó–î–ê–¢–¨:**
1. **utils/mobile_detection.py** - ‚úÖ –°–æ–∑–¥–∞–Ω (–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π)
2. **templates/welcome_mobile.html** - ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è mobile_base.html  
3. **static/css/welcome-mobile.css** - ‚úÖ –°–æ–∑–¥–∞–Ω
4. **static/js/welcome-mobile.js** - ‚úÖ –°–æ–∑–¥–∞–Ω  
5. **static/manifest.json** - ‚úÖ –°–æ–∑–¥–∞–Ω
6. **static/sw.js** - ‚úÖ –°–æ–∑–¥–∞–Ω

## üîß –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° –°–£–©–ï–°–¢–í–£–Æ–©–ï–ô –°–ò–°–¢–ï–ú–û–ô

### 1. –í app.py –¥–æ–±–∞–≤–∏—Ç—å:
```python
# –ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–æ–≤
from mobile_integration import init_mobile_integration
from utils.mobile_detection import setup_mobile_detection

# –í —Ñ—É–Ω–∫—Ü–∏–∏ create_app() –ü–û–°–õ–ï —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Blueprint'–æ–≤:
init_mobile_integration(app)
setup_mobile_detection(app)

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —à–∞–±–ª–æ–Ω–æ–≤
from mobile_integration import mobile_template_manager
mobile_template_manager.register_mobile_template('index.html', 'welcome_mobile.html')
```

### 2. –í routes/main_routes.py –∏–∑–º–µ–Ω–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –Ω–∞:
```python
from mobile_integration import render_adaptive_template, mobile_template_manager
from utils.mobile_detection import get_user_stats, get_app_stats, get_mobile_detector
```

### 3. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã (–µ—Å–ª–∏ –µ—Å—Ç—å):
- ~~`mobile_detection.py`~~ (–≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞)
- ~~`index_mobile.html`~~ (–µ—Å–ª–∏ —ç—Ç–æ —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª)

## üì± –õ–û–ì–ò–ö–ê –†–ê–ë–û–¢–´ –° –°–£–©–ï–°–¢–í–£–Æ–©–ï–ô –°–ò–°–¢–ï–ú–û–ô

1. **mobile_integration.py** - –≥–ª–∞–≤–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —à–∞–±–ª–æ–Ω–æ–≤
2. **utils/mobile_detection.py** - –¥–µ—Ç–µ–∫—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç mobile_integration)
3. **welcome_mobile.html** - –Ω–æ–≤—ã–π –∫—Ä–∞—Å–∏–≤—ã–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω
4. **mobile_base.html** - –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±–∞–∑–æ–≤—ã–π –º–æ–±–∏–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω

## üéØ –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê –ò–ù–¢–ï–ì–†–ê–¶–ò–ò

‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –≤–∞—à–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π
‚úÖ **–†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å** - –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –ø–æ–ª–æ–º–∫–∏ —Å—Ç–∞—Ä—ã—Ö
‚úÖ **–ß–∏—Å—Ç–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞–ø–∫–∏ (utils/)
‚úÖ **API –ø–æ–¥–¥–µ—Ä–∂–∫–∞** - –≤—Å–µ API endpoints –∏–∑ mobile_integration.py —Ä–∞–±–æ—Ç–∞—é—Ç
‚úÖ **–î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã** - –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å @mobile_route, @force_mobile_template

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

1. **–î–µ—Å–∫—Ç–æ–ø**: `http://localhost:5000/en/` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç index.html
2. **–ú–æ–±–∏–ª—å–Ω—ã–π**: `http://localhost:5000/en/` ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç welcome_mobile.html
3. **API**: `http://localhost:5000/mobile-api/device-info` ‚Üí –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
4. **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ**: `http://localhost:5000/en/?mobile_mode=force_mobile` ‚Üí –≤—Å–µ–≥–¥–∞ –º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è

## üéÆ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò

–¢–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ mobile_integration.py:

```python
# –í —Ä–æ—É—Ç–∞—Ö –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
@mobile_route('/my-page')
@force_mobile_template('my_template.html')
def my_page():
    return render_adaptive_template('my_template.html')

# –í —à–∞–±–ª–æ–Ω–∞—Ö –¥–æ—Å—Ç—É–ø–Ω—ã —Ñ–∏–ª—å—Ç—Ä—ã
{{ image_path | mobile_image('small') }}
{{ long_text | mobile_truncate(50) }}
```

## üîß –ù–ê–°–¢–†–û–ô–ö–ê –†–ï–ñ–ò–ú–û–í

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å —Ä–µ–∂–∏–º—ã —á–µ—Ä–µ–∑ API:
```javascript
// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è
fetch('/mobile-api/toggle-mode', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({mode: 'force_mobile'})
});
```

## üé® –ö–ê–°–¢–û–ú–ò–ó–ê–¶–ò–Ø

- **–°—Ç–∏–ª–∏**: `static/css/welcome-mobile.css`
- **–°–∫—Ä–∏–ø—Ç—ã**: `static/js/welcome-mobile.js`  
- **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —à–∞–±–ª–æ–Ω–æ–≤**: —á–µ—Ä–µ–∑ `mobile_template_manager.register_mobile_template()`
- **–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞**: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `utils/mobile_detection.py`

## ‚ö†Ô∏è –í–ê–ñ–ù–û

- –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å mobile_integration.py –ù–ï –∑–∞—Ç—Ä–∞–≥–∏–≤–∞–µ—Ç—Å—è
- –í—Å–µ —Å—Ç–∞—Ä—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —à–∞–±–ª–æ–Ω–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å  
- –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–π welcome —ç–∫—Ä–∞–Ω –∏ —É–ª—É—á—à–µ–Ω–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å mobile_base.html —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞