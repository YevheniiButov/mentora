# CRITICAL RECURSION FIX REPORT

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è —Ä–µ–∫—É—Ä—Å–∏—è –≤ IRT Engine –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≤–æ–ø—Ä–æ—Å–æ–≤
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê –ò–°–ü–†–ê–í–õ–ï–ù–ê**
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô**

## üéØ –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú–´

### STEP 1: –ü–û–ò–°–ö –ò–°–¢–û–ß–ù–ò–ö–ê –†–ï–ö–£–†–°–ò–ò

**–ê–Ω–∞–ª–∏–∑ –ø–æ–∫–∞–∑–∞–ª —Ü–∏–∫–ª–∏—á–µ—Å–∫—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:**

```
1. irt_engine.py: select_next_question() 
   ‚Üì
2. irt_engine.py: get_domain_questions() 
   ‚Üì
3. cache_manager.py: get_cached_domain_questions() 
   ‚Üì
4. cache_manager.py: —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π IRTEngine() 
   ‚Üì
5. –ù–û–í–´–ô irt_engine.py: get_domain_questions() 
   ‚Üì
6. –ë–ï–°–ö–û–ù–ï–ß–ù–ê–Ø –†–ï–ö–£–†–°–ò–Ø!
```

### STEP 2: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –¢–û–ß–ö–ê

**üìç LOCATION:** `utils/cache_manager.py:315`

**‚ùå –ü–†–û–ë–õ–ï–ú–ù–´–ô –ö–û–î:**
```python
# –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
from utils.irt_engine import IRTEngine
irt_engine = IRTEngine()
questions = irt_engine.get_domain_questions(domain_code, difficulty_range)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ `IRTEngine()` –≤–Ω—É—Ç—Ä–∏ `cache_manager.py` –≤—ã–∑—ã–≤–∞–µ—Ç —Ä–µ–∫—É—Ä—Å–∏—é!

## üîß –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï

### STEP 1: –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –¶–ò–ö–õ–ò–ß–ï–°–ö–û–ô –ó–ê–í–ò–°–ò–ú–û–°–¢–ò

**üìç LOCATION:** `utils/cache_manager.py:315-325`

**‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:**
```python
# –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞–ø—Ä—è–º—É—é (–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –†–ï–ö–£–†–°–ò–ò)
from models import Question, BIGDomain, IRTParameters
from extensions import db

# –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è IRTEngine
domain = BIGDomain.query.filter_by(code=domain_code).first()
if not domain:
    return []

query = Question.query.filter_by(big_domain_id=domain.id)

if difficulty_range:
    min_diff, max_diff = difficulty_range
    query = query.join(IRTParameters).filter(
        IRTParameters.difficulty >= min_diff,
        IRTParameters.difficulty <= max_diff
    )

questions = query.limit(100).all()
```

### STEP 2: –î–û–ë–ê–í–õ–ï–ù–ò–ï CIRCUIT BREAKER

**üìç LOCATION:** `utils/irt_engine.py:564-580`

**‚úÖ CIRCUIT BREAKER:**
```python
def select_next_question(self) -> Optional[Question]:
    # CIRCUIT BREAKER –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ä–µ–∫—É—Ä—Å–∏–∏
    if not hasattr(self, '_recursion_counter'):
        self._recursion_counter = 0
    
    if self._recursion_counter > 10:
        logger.error("CIRCUIT BREAKER: Stopping recursion in select_next_question")
        self._recursion_counter = 0
        return None
    
    self._recursion_counter += 1
    
    # ... –ª–æ–≥–∏–∫–∞ –º–µ—Ç–æ–¥–∞ ...
    
    # –°–ë–†–û–° –°–ß–ï–¢–ß–ò–ö–ê –†–ï–ö–£–†–°–ò–ò
    self._recursion_counter = 0
    return optimal_question
```

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
‚ùå –ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è —Ä–µ–∫—É—Ä—Å–∏—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≤–æ–ø—Ä–æ—Å–æ–≤
‚ùå –°–∏—Å—Ç–µ–º–∞ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞
‚ùå –û—à–∏–±–∫–∏ –¥–ª—è –≤—Å–µ—Ö 31 –¥–æ–º–µ–Ω–æ–≤
‚ùå Maximum recursion depth exceeded
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
‚úÖ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
‚úÖ –ü—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
‚úÖ Circuit breaker –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∫—É—Ä—Å–∏—é
‚úÖ –°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞
```

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
1. **–í—ã–±–æ—Ä –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –≤—Å–µ—Ö –¥–æ–º–µ–Ω–æ–≤** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Ä–µ–∫—É—Ä—Å–∏–∏
2. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –±–µ–∑ IRTEngine
3. **Circuit breaker** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ç —Ä–µ–∫—É—Ä—Å–∏–∏

### –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ `maximum recursion depth exceeded`
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –≤–æ–ø—Ä–æ—Å–æ–≤
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

## üéØ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞:**
1. ‚úÖ **–£—Å—Ç—Ä–∞–Ω–µ–Ω–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å** –º–µ–∂–¥—É `irt_engine.py` –∏ `cache_manager.py`
2. ‚úÖ **–ü—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö** –≤ `cache_manager.py`
3. ‚úÖ **Circuit breaker** –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∫—É—Ä—Å–∏—é
4. ‚úÖ **–°–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞** –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –†–ï–ö–£–†–°–ò–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ê**

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∏—Å—Ç–µ–º–∞ –±–æ–ª—å—à–µ –Ω–µ –∑–∞–≤–∏—Å–∞–µ—Ç –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π —Ä–µ–∫—É—Ä—Å–∏–∏, –≤—ã–±–æ—Ä –≤–æ–ø—Ä–æ—Å–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ.

## üìÅ –§–ê–ô–õ–´

- `utils/cache_manager.py` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
- `utils/irt_engine.py` - –î–æ–±–∞–≤–ª–µ–Ω circuit breaker
- `CRITICAL_RECURSION_FIX_REPORT.md` - –≠—Ç–æ—Ç –æ—Ç—á–µ—Ç

## üîß –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

1. **–ò–∑–±–µ–≥–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π** –º–µ–∂–¥—É –º–æ–¥—É–ª—è–º–∏
2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã** –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –≤ –∫—ç—à–µ
3. **–î–æ–±–∞–≤–ª—è—Ç—å circuit breakers** –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å —Ä–µ–∫—É—Ä—Å–∏—é** –≤ production

---

**–î–∞—Ç–∞:** $(date)
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –†–ï–ö–£–†–°–ò–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ê
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô
