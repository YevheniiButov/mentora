# QUESTION SELECTION FIX REPORT

## üéØ –ü–†–û–ë–õ–ï–ú–ê

**–û—à–∏–±–∫–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –≤–æ–ø—Ä–æ—Å 25 —Ä–∞–∑ –≤–º–µ—Å—Ç–æ —Ä–∞–∑–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.

**–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –≤–æ–ø—Ä–æ—Å—ã.

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ IRT engine.

## üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê

### 1. –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã
**–§–∞–π–ª:** `utils/irt_engine.py`
**–ú–µ—Ç–æ–¥:** `select_next_question()`

**–ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥:**
```python
# –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –¥–æ–º–µ–Ω–æ–≤
responses = self.session.responses.all()
domain_question_counts = {}
answered_question_ids = set()

for response in responses:
    question = response.question  # ‚Üê –ü–†–û–ë–õ–ï–ú–ê: detached –æ–±—ä–µ–∫—Ç—ã
    answered_question_ids.add(question.id)
```

### 2. –í—ã—è–≤–ª–µ–Ω–∏–µ –ø—Ä–∏—á–∏–Ω
- **Detached –æ–±—ä–µ–∫—Ç—ã** –≤ SQLAlchemy session
- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ** –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
- **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä—è–º–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏** –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- **–ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è** –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤—ã–±–æ—Ä–∞ –≤–æ–ø—Ä–æ—Å–æ–≤

## üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ `select_next_question`
```python
def select_next_question(self) -> Optional[Question]:
    """–í—ã–±—Ä–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤"""
    if not self.session:
        return None
    
    try:
        # –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞–ø—Ä—è–º—É—é
        answered_questions = DiagnosticResponse.query.filter_by(
            session_id=self.session.id
        ).with_entities(DiagnosticResponse.question_id).all()
        
        answered_question_ids = {q[0] for q in answered_questions}
        logger.info(f"Session {self.session.id} already answered questions: {answered_question_ids}")
        
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –µ—â–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
        total_questions = Question.query.count()
        if len(answered_question_ids) >= total_questions:
            logger.warning(f"All {total_questions} questions have been answered")
            return None
        
        # –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –¥–æ–º–µ–Ω–æ–≤
        responses = self.session.responses.all()
        domain_question_counts = {}
        
        for response in responses:
            question = response.question
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º big_domain –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ –ø–æ–ª—è domain
            if hasattr(question, 'big_domain') and question.big_domain:
                domain_code = question.big_domain.code
                domain_question_counts[domain_code] = domain_question_counts.get(domain_code, 0) + 1
    except Exception as e:
        logger.error(f"Error getting answered questions: {e}")
        answered_question_ids = set()
        domain_question_counts = {}
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ `select_next_question_by_domain`
```python
def select_next_question_by_domain(self, domain_code: str, current_ability: float = 0.0, answered_question_ids: set = None) -> Optional[Question]:
    """–í—ã–±—Ä–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö"""
    if answered_question_ids is None:
        answered_question_ids = set()
    
    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –ø—Ä—è–º—ã–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
        questions = self.get_domain_questions(domain_code)
        logger.info(f"Found {len(questions)} questions for domain {domain_code}")
        
        # –ò—Å–∫–ª—é—á–∏—Ç—å —É–∂–µ –æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
        available_questions = [q for q in questions if q.id not in answered_question_ids]
        logger.info(f"Available questions after filtering: {len(available_questions)}")
        
        if not available_questions:
            logger.warning(f"No available questions for domain {domain_code} after filtering answered questions: {answered_question_ids}")
            return None
    except Exception as e:
        logger.error(f"Error selecting question for domain {domain_code}: {e}")
        return None
```

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
```python
# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
logger.info(f"Session {self.session.id} already answered questions: {answered_question_ids}")

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
logger.info(f"Available questions after filtering: {len(available_questions)}")

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
logger.info(f"Selected question {optimal_question.id} for session {session_id}")
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
```python
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –µ—â–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
total_questions = Question.query.count()
if len(answered_question_ids) >= total_questions:
    logger.warning(f"All {total_questions} questions have been answered")
    return None
```

## üìä –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –≤–æ–ø—Ä–æ—Å 132 –¥–≤–∞–¥—Ü–∞—Ç—å –ø—è—Ç—å —Ä–∞–∑
‚ùå –ê–ª–≥–æ—Ä–∏—Ç–º –Ω–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã
‚ùå Detached –æ–±—ä–µ–∫—Ç—ã –≤—ã–∑—ã–≤–∞—é—Ç –æ—à–∏–±–∫–∏
‚ùå –ù–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
‚úÖ –ò—Å–∫–ª—é—á–µ–Ω–∏–µ —É–∂–µ –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ –≤—ã–±–æ—Ä–∞
‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ SQLAlchemy
```

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç `test_question_selection_fix.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

1. **–¢–µ—Å—Ç –ª–æ–≥–∏–∫–∏ –≤—ã–±–æ—Ä–∞ –≤–æ–ø—Ä–æ—Å–æ–≤:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—ã–±–æ—Ä –ø–µ—Ä–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
   - –°–∏–º—É–ª–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã
   - –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –≤—ã–±–æ—Ä —Ä–∞–∑–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –Ω–µ –≤—ã–±–∏—Ä–∞—é—Ç—Å—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –≤–æ–ø—Ä–æ—Å—ã

2. **–¢–µ—Å—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
   - –°–∏–º—É–ª–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç—ã –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤
   - –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤

**–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–º–∏—Å—è –≤–æ–ø—Ä–æ—Å–∞–º–∏ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

## üéØ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å—Ç—Ä–∞–Ω–∏–ª–æ –ø—Ä–æ–±–ª–µ–º—É —Å –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–º–∏—Å—è –≤–æ–ø—Ä–æ—Å–∞–º–∏.

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ç–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞—é—Ç —Ä–∞–∑–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ, —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã.

## üìÅ –§–ê–ô–õ–´

- `utils/irt_engine.py` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
- `test_question_selection_fix.py` - –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
- `QUESTION_SELECTION_FIX_REPORT.md` - –≠—Ç–æ—Ç –æ—Ç—á–µ—Ç

---

**–î–∞—Ç–∞:** $(date)
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–ï–®–ï–ù–û
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô
