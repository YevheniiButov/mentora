{% extends "base.html" %}

{% block title %}{{ module.title }} - Mentora{% endblock %}

{% block styles %}
    {{ super() }}
    <!-- Используем ТЕ ЖЕ стили что и в subject_view -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/learning_map.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/category-navigation.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/universal-layout-system.css') }}">
    <!-- Унифицированная система статистики -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/unified-stats.css') }}">
{% endblock %}

{% block content %}
<!-- Используем ТОТ ЖЕ контейнер и классы -->
<div class="learning-map-container">
    <!-- Те же декоративные элементы -->
    <div class="floating-shape shape-1"></div>
    <div class="floating-shape shape-2"></div>
    <div class="floating-shape shape-3"></div>
    <div class="floating-shape shape-4"></div>
    
    <div class="main-container">
        <!-- ЛЕВАЯ КОЛОНКА: Модули -->
        <div class="left-column">
            <div class="section-header">
                <h2>{{ t('modules', lang) }}</h2>
            </div>
            
            <!-- Используем ТУ ЖЕ структуру .learning-paths -->
            <div class="learning-paths">
                {% for module_data in modules_with_progress %}
                <div class="learning-path-item">
                    <a href="{{ url_for('modules_bp.module_view', lang=lang, module_id=module_data.module.id) }}" 
                       class="learning-path-button {% if module_data.is_current %}active{% endif %}">
                        <div class="path-button-content">
                            <i class="bi bi-{{ module_data.module.icon|default('book') }}"></i>
                            <span>{{ module_data.module.title }}</span>
                        </div>
                        <div class="subject-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ module_data.progress }}%"></div>
                            </div>
                            <span class="progress-percent">{{ module_data.progress }}%</span>
                        </div>
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- СРЕДНЯЯ КОЛОНКА: Остается как есть -->
        <div class="middle-column">
            <div class="page-header">
                <div class="breadcrumb">
                    <span>{{ current_subject.name if current_subject else t('modules', lang) }}</span>
                    <span class="separator">/</span>
                    <span class="active">{{ module.title }}</span>
                </div>
                <div class="module-header-actions">
                    <div>
                <h1>{{ module.title }}</h1>
                <p>{{ module.description|default('') }}</p>
                    </div>
                    
                    {% if current_user.is_authenticated and (current_user.role == 'admin' or current_user.role == 'content_admin' or current_user.role == 'super_admin') %}
                    <div class="module-admin-actions">
                        <a href="{{ url_for('content_editor.editor_interface', lang=lang, module_id=module.id) }}" 
                           class="btn btn-outline-primary btn-sm" 
                           title="{% if lang == 'ru' %}Создать контент для модуля{% else %}Create content for module{% endif %}">
                            <i class="bi bi-plus-circle"></i>
                            {% if lang == 'ru' %}Создать контент{% else %}Create Content{% endif %}
                        </a>
                        <a href="{{ url_for('content_editor.pages_list', lang=lang, module_id=module.id) }}" 
                           class="btn btn-outline-secondary btn-sm" 
                           title="{% if lang == 'ru' %}Управление страницами модуля{% else %}Manage module pages{% endif %}">
                            <i class="bi bi-file-text"></i>
                            {% if lang == 'ru' %}Страницы{% else %}Pages{% endif %}
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Содержимое модуля -->
            <div class="subject-content">
                {% if topics_with_subtopics %}
                <!-- Компактные модули без статистики -->
                <div class="modules-grid-compact">
                    {% for topic_data in topics_with_subtopics %}
                    <div class="module-card-compact" data-module-id="{{ topic_data.topic.slug }}">
                        <div class="module-icon-compact">
                            <i class="bi bi-book"></i>
                        </div>
                        <div class="module-info-compact">
                            <h3>{{ topic_data.topic.name }}</h3>
                        </div>
                        <a href="{{ url_for('modules_bp.subtopic_lessons_list', lang=lang, module_id=module.id, slug=topic_data.topic.slug) }}" 
                           class="module-btn-compact">
                            {% if topic_data.progress_percent == 100 %}{{ t('repeat', lang) if t else 'Repeat' }}
                            {% elif topic_data.progress_percent > 0 %}{{ t('continue', lang) if t else 'Continue' }}
                            {% else %}{{ t('start', lang) if t else 'Start' }}{% endif %}
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert alert-info">
                    {% if lang == 'ru' %}
                        В этом модуле пока нет подтем.
                        <br><small>Возможно, контент еще не был импортирован в базу данных.</small>
                    {% else %}
                        No subtopics in this module yet.
                        <br><small>Content may not have been imported to the database yet.</small>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- ПРАВАЯ КОЛОНКА: Точно такая же как в subject_view -->
        <div class="right-column">
            <div class="stats-section">
                <h2>{{ t('overall_progress', lang) }}</h2>
                <div class="progress-circle-container">
                    <div class="progress-circle" 
                         data-progress="{{ stats.overall_progress|default(0) }}"
                         role="progressbar" 
                         aria-valuenow="{{ stats.overall_progress|default(0) }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100"
                         aria-label="Overall progress">
                        <div class="circle-background"></div>
                        <div class="circle-progress" style="transform: rotate({{ (stats.overall_progress|default(0)) * 1.8 }}deg)"></div>
                        <div class="progress-circle-text">{{ stats.overall_progress|default(0) }}%</div>
                    </div>
                </div>
                <div class="stats-cards">
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <i class="bi bi-journal-check"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">{{ t('lessons_completed', lang) }}</div>
                            <div class="stat-value" data-stat="completed-lessons">{{ stats.completed_lessons|default(0) }}/{{ stats.total_lessons|default(0) }}</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">
                            <i class="bi bi-clock"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">{{ t('total_time', lang) }}</div>
                            <div class="stat-value" data-stat="time-spent">{{ stats.total_time_spent|default(0) }} {{ t('min', lang) }}</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <i class="bi bi-calendar-check"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">{{ t('days_active', lang) }}</div>
                            <div class="stat-value" data-stat="active-days">{{ stats.active_days|default(0) }}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="countdown-section">
                <h2>{{ t('countdown', lang) }}</h2>
                <div class="day-counter">
                    <span class="days-number">{{ stats.days_until_exam|default(0) }}</span>
                    <span class="days-label">{{ t('days_until_exam', lang) }}</span>
                </div>
                <div class="exam-date">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <span>{{ stats.next_exam_date or t('not_scheduled', lang) }}</span>
                </div>
            </div>
            
            <div class="recommendations-section">
                <h2>{{ t('recommendations', lang) }}</h2>
                <div class="recommendations-list">
                    {% if recommendations and recommendations|length > 0 %}
                        {% for rec in recommendations %}
                        <div class="recommendation-item">
                            <div class="rec-icon {% if loop.index % 2 == 0 %}purple{% else %}blue{% endif %}">
                                <i class="bi bi-book"></i>
                            </div>
                            <div class="rec-info">
                                <h4>{{ rec.title }}</h4>
                                <span>{{ rec.subject_name }}</span>
                            </div>
                            <button class="rec-action" onclick="window.location.href='/{{ lang }}/modules/{{ rec.module_id }}'">
                                <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="empty-recommendations">
                        <p>{{ t('no_recommendations', lang) }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Используем ТЕ ЖЕ скрипты -->
<script src="{{ url_for('static', filename='js/subject_view.js') }}"></script>
<script src="{{ url_for('static', filename='js/subject-navigation.js') }}"></script>
<!-- Унифицированная система статистики -->
<script src="{{ url_for('static', filename='js/unified-stats.js') }}"></script>
{% endblock %}