<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{{ t('learning_map', lang)|default('Learning Map') }} - {{ t('modern_style', lang)|default('Modern Style') }}</title>
    
    <!-- Favicon -->
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" />
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}" />
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/favicon.png') }}">
    
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Flag Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@6.6.6/css/flag-icons.min.css" />
    
    <!-- Bootstrap JS (load first) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Lottie Player Web Component -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@2.0.2/dist/lottie-player.js"></script>
    
    <!-- Alpine.js (load last) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --secondary-color: #6366f1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow-x: hidden;
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 50%, #dbeafe 100%);
            min-height: 100vh;
            position: relative;
        }

        /* ===== МОРФИРУЮЩИЕ ФОРМЫ ===== */
        .morphing-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
            pointer-events: none;
        }

        .shape {
            position: absolute;
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            filter: blur(60px);
            opacity: 0.2;
            animation: morph 20s ease-in-out infinite;
        }

        .shape-1 {
            width: 400px;
            height: 400px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            top: -10%;
            left: -10%;
            animation-duration: 25s;
        }

        .shape-2 {
            width: 500px;
            height: 500px;
            background: linear-gradient(45deg, #4834d4, #686de0);
            top: 40%;
            right: -15%;
            animation-duration: 30s;
            animation-delay: -10s;
        }

        .shape-3 {
            width: 350px;
            height: 350px;
            background: linear-gradient(45deg, #00d2d3, #54a0ff);
            bottom: -10%;
            left: 40%;
            animation-duration: 35s;
            animation-delay: -20s;
        }

        @keyframes morph {
            0%, 100% {
                border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
                transform: translate(0, 0) rotate(0deg);
            }
            25% {
                border-radius: 70% 30% 50% 50% / 30% 30% 70% 70%;
                transform: translate(50px, 50px) rotate(90deg);
            }
            50% {
                border-radius: 50% 60% 30% 40% / 60% 30% 70% 40%;
                transform: translate(0, 100px) rotate(180deg);
            }
            75% {
                border-radius: 60% 40% 60% 40% / 70% 50% 50% 50%;
                transform: translate(-50px, 50px) rotate(270deg);
            }
        }

        /* ===== ШАПКА (идентичная оригинальной из _header.html) ===== */
        
        /* ПОЛНОЕ ПЕРЕОПРЕДЕЛЕНИЕ BOOTSTRAP СТИЛЕЙ */
        header.modern-header {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            height: 70px !important;
            min-height: 70px !important;
            max-height: 70px !important;
            z-index: 1000 !important;
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px) !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
            display: flex !important;
            align-items: center !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow: visible !important;
        }

        header.modern-header nav.navbar {
            width: 100% !important;
            height: 100% !important;
            min-height: 100% !important;
            max-height: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-wrap: nowrap !important;
        }

        header.modern-header nav.navbar .container {
            width: 100% !important;
            max-width: 1200px !important;
            height: 100% !important;
            min-height: 100% !important;
            max-height: 100% !important;
            margin: 0 auto !important;
            padding: 0 1.5rem !important;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            flex-wrap: nowrap !important;
            flex-direction: row !important;
        }

        header.modern-header .navbar-brand {
            display: flex !important;
            align-items: center !important;
            height: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
            flex-shrink: 0 !important;
            order: 1 !important;
            text-decoration: none;
            transition: transform 0.3s ease;
        }

        header.modern-header .navbar-brand:hover {
            transform: scale(1.05);
        }

        header.modern-header .navbar-brand img {
            height: 40px !important;
            width: auto !important;
            max-height: 40px !important;
            object-fit: contain !important;
            transition: all 0.3s ease;
        }

        header.modern-header .navbar-brand:hover img {
            filter: brightness(1.1);
        }

        header.modern-header .navbar-collapse {
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            flex: 1 !important;
            height: 100% !important;
            margin: 0 1rem !important;
            flex-wrap: nowrap !important;
            flex-direction: row !important;
            order: 2 !important;
        }

        header.modern-header .navbar-nav {
            display: flex !important;
            align-items: center !important;
            flex-direction: row !important;
            height: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            list-style: none !important;
            flex-wrap: nowrap !important;
            gap: 0.5rem !important;
        }

        header.modern-header .navbar-nav .nav-item {
            display: flex !important;
            align-items: center !important;
            height: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        header.modern-header .navbar-nav .nav-link {
            display: flex !important;
            align-items: center !important;
            height: auto !important;
            padding: 0.5rem 1rem !important;
            margin: 0 !important;
            color: #64748b !important;
            text-decoration: none !important;
            border-radius: 8px !important;
            transition: all 0.3s ease !important;
            white-space: nowrap !important;
            flex-shrink: 0 !important;
            font-weight: 500;
            position: relative;
        }

        header.modern-header .navbar-nav .nav-link::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transform: translateX(-50%);
            transition: width 0.3s ease;
        }

        header.modern-header .navbar-nav .nav-link:hover {
            color: #3b82f6 !important;
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        header.modern-header .navbar-nav .nav-link:hover::before {
            width: 80%;
        }

        header.modern-header .navbar-nav .nav-link.active {
            color: #3b82f6 !important;
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        header.modern-header .navbar-nav .nav-link.active::before {
            width: 80%;
        }

        header.modern-header .navbar-actions {
            display: flex !important;
            align-items: center !important;
            height: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            gap: 0.5rem !important;
            flex-wrap: nowrap !important;
            flex-direction: row !important;
            flex-shrink: 0 !important;
        }

        header.modern-header .dropdown {
            position: relative !important;
            z-index: 9999 !important;
        }

        header.modern-header .btn,
        header.modern-header .language-btn-modern,
        header.modern-header .user-btn-modern {
            display: flex !important;
            align-items: center !important;
            height: auto !important;
            padding: 0.5rem 1rem !important;
            margin: 0 !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            border-radius: 8px !important;
            background: rgba(255, 255, 255, 0.8) !important;
            color: #333 !important;
            text-decoration: none !important;
            transition: all 0.3s ease !important;
            white-space: nowrap !important;
            flex-shrink: 0 !important;
            cursor: pointer !important;
            pointer-events: auto !important;
        }

        header.modern-header .btn:hover,
        header.modern-header .language-btn-modern:hover,
        header.modern-header .user-btn-modern:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 1) !important;
        }

        header.modern-header .dropdown-menu {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            backdrop-filter: blur(10px);
            padding: 0.5rem;
            margin-top: 0.5rem;
            animation: dropdownSlide 0.3s ease;
            min-width: 220px;
            z-index: 10000 !important;
            position: absolute !important;
            max-height: 70vh !important;
            overflow-y: auto !important;
        }
        

        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        header.modern-header .dropdown-item {
            color: #64748b;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
            text-decoration: none;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        header.modern-header .dropdown-item:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            transform: translateX(5px);
        }

        header.modern-header .dropdown-item.active {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
        }

        header.modern-header .dropdown-item.text-danger {
            color: #ef4444;
        }

        header.modern-header .dropdown-item.text-danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        header.modern-header .dropdown-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            margin-bottom: 0.5rem;
        }

        header.modern-header .dropdown-divider {
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin: 0.5rem 0;
        }

        header.modern-header .navbar-toggler {
            display: none !important;
            order: 3 !important;
            border: none;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            width: 40px;
            height: 40px;
            position: relative;
            transition: all 0.3s ease;
        }

        header.modern-header .navbar-toggler:focus {
            box-shadow: none;
        }

        header.modern-header .hamburger-line {
            display: block;
            width: 20px;
            height: 2px;
            background: #1e293b;
            margin: 4px auto;
            transition: all 0.3s ease;
            border-radius: 1px;
        }

        header.modern-header .navbar-toggler:not(.collapsed) .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        header.modern-header .navbar-toggler:not(.collapsed) .hamburger-line:nth-child(2) {
            opacity: 0;
        }

        header.modern-header .navbar-toggler:not(.collapsed) .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        /* Мобильные устройства */
        @media (max-width: 992px) {
            header.modern-header {
                height: 60px !important;
                min-height: 60px !important;
                max-height: 60px !important;
            }
            
            header.modern-header .navbar-brand img {
                height: 32px !important;
                max-height: 32px !important;
            }
            
            header.modern-header .navbar-toggler {
                display: block !important;
            }
            
            header.modern-header .navbar-collapse {
                position: absolute !important;
                top: 100% !important;
                left: 0 !important;
                right: 0 !important;
                background: rgba(255, 255, 255, 0.98) !important;
                backdrop-filter: blur(20px) !important;
                border-radius: 0 0 16px 16px !important;
                padding: 1rem !important;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
                flex-direction: column !important;
                align-items: stretch !important;
                height: auto !important;
                z-index: 1001 !important;
                display: none !important;
            }
            
            header.modern-header .navbar-collapse.show {
                display: flex !important;
            }
            
            header.modern-header .navbar-nav {
                flex-direction: column !important;
                width: 100% !important;
                height: auto !important;
                gap: 0.5rem !important;
            }
            
            header.modern-header .navbar-actions {
                flex-direction: column !important;
                width: 100% !important;
                height: auto !important;
                margin-top: 1rem !important;
                padding-top: 1rem !important;
                border-top: 1px solid rgba(0, 0, 0, 0.1) !important;
            }
        }

        /* ПЛАНШЕТЫ (768px - 1024px) */
        @media (min-width: 768px) and (max-width: 1024px) {
            header.modern-header {
                height: 65px !important;
            }
            
            header.modern-header .navbar-brand img {
                height: 36px !important;
            }
            
            header.modern-header .navbar-collapse {
                position: static !important;
                display: flex !important;
                flex-direction: row !important;
                background: transparent !important;
                backdrop-filter: none !important;
                border-radius: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                height: 100% !important;
                z-index: auto !important;
            }
            
            header.modern-header .navbar-nav {
                flex-direction: row !important;
                height: 100% !important;
                gap: 0.25rem !important;
            }
            
            header.modern-header .navbar-actions {
                flex-direction: row !important;
                height: 100% !important;
                margin-top: 0 !important;
                padding-top: 0 !important;
                border-top: none !important;
                gap: 0.25rem !important;
            }
            
            header.modern-header .navbar-toggler {
                display: none !important;
            }
            
            header.modern-header .nav-link,
            header.modern-header .btn {
                padding: 0.4rem 0.8rem !important;
                font-size: 0.9rem !important;
            }
        }

        /* ТОЛЬКО ТЕЛЕФОНЫ (до 768px) */
        @media (max-width: 767px) {
            header.modern-header {
                height: 60px !important;
            }
            
            header.modern-header .navbar-brand img {
                height: 32px !important;
            }
            
            header.modern-header .navbar-toggler {
                display: block !important;
            }
            
            header.modern-header .navbar-collapse {
                position: absolute !important;
                top: 100% !important;
                left: 0 !important;
                right: 0 !important;
                background: rgba(255, 255, 255, 0.98) !important;
                backdrop-filter: blur(20px) !important;
                border-radius: 0 0 16px 16px !important;
                padding: 1rem !important;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
                flex-direction: column !important;
                align-items: stretch !important;
                height: auto !important;
                z-index: 1001 !important;
                display: none !important;
            }
            
            header.modern-header .navbar-collapse.show {
                display: flex !important;
            }
            
            /* ИСПРАВЛЕНИЕ ДЛЯ МОБИЛЬНЫХ DROPDOWN */
            header.modern-header .dropdown-menu {
                position: static !important;
                width: 100% !important;
                margin-top: 0.5rem !important;
                border: none !important;
                box-shadow: none !important;
                max-height: none !important;
                overflow-y: visible !important;
                background: transparent !important;
                backdrop-filter: none !important;
                padding: 0 !important;
                animation: none !important;
            }
            
            /* КАСТОМНОЕ МЕНЮ ЯЗЫКОВ - ПОКАЗЫВАЕМ ВСЕ */
            header.modern-header .language-dropdown .dropdown-menu {
                position: static !important;
                width: 100% !important;
                margin-top: 0.5rem !important;
                border: none !important;
                box-shadow: none !important;
                max-height: none !important;
                overflow-y: visible !important;
                background: transparent !important;
                backdrop-filter: none !important;
                padding: 0 !important;
                animation: none !important;
            }
            
            /* ЛИШНИЕ ЯЗЫКИ НА МОБИЛЬНЫХ - ПОКАЗЫВАЕМ ВСЕ */
            header.modern-header .language-menu {
                max-height: none !important;
                overflow-y: visible !important;
                height: auto !important;
            }
            
            /* КОМПАКТНЫЕ ЭЛЕМЕНТЫ ДЛЯ МОБИЛЬНЫХ */
            header.modern-header .dropdown-item {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.85rem !important;
                margin-bottom: 0.2rem !important;
                border-radius: 6px !important;
                background: rgba(255, 255, 255, 0.9) !important;
                border: 1px solid rgba(0, 0, 0, 0.05) !important;
                display: flex !important;
                align-items: center !important;
                gap: 0.5rem !important;
            }
            
            header.modern-header .dropdown-item:hover {
                background: rgba(59, 130, 246, 0.1) !important;
                border-color: rgba(59, 130, 246, 0.2) !important;
            }
            
            header.modern-header .dropdown-item.active {
                background: linear-gradient(135deg, #3b82f6, #8b5cf6) !important;
                color: white !important;
                border-color: transparent !important;
            }
            
            /* УБИРАЕМ ОГРАНИЧЕНИЕ ВЫСОТЫ ДЛЯ МОБИЛЬНЫХ */
            header.modern-header .dropdown {
                max-height: none !important;
                overflow: visible !important;
            }
        }

        /* ===== КОНТЕЙНЕР ===== */
        .learning-map-container {
            position: relative;
            z-index: 2;
            margin-top: 70px;
            min-height: calc(100vh - 70px);
            padding: 2rem;
            max-width: 1800px;
            margin-left: auto;
            margin-right: auto;
        }

        /* ===== ПРАВИЛЬНЫЙ 2-КОЛОНОЧНЫЙ LAYOUT ===== */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            align-items: start;
        }
        

        /* Левая колонка */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* Правая колонка - sticky */
        .sidebar-description {
            position: sticky;
            top: 90px;
            height: fit-content;
        }

        /* Узлы на блоке (как на скриншоте) */
        .learning-tabs {
            position: relative;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 4.5rem 1.5rem 1.5rem 1.5rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-top: 50px;
        }

        .tabs-container {
            position: absolute;
            top: -42px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1.5rem;
            z-index: 10;
        }

        .tab-circle {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.4s ease;
        }

        .tab-circle:hover .circle-button {
            transform: scale(1.1);
        }

        .circle-button {
            width: 85px;
            height: 85px;
            border-radius: 50%;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s ease;
            position: relative;
        }

        .tab-circle:nth-child(1) .circle-button { background: linear-gradient(135deg, #a855f7, #6366f1); }
        .tab-circle:nth-child(2) .circle-button { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
        .tab-circle:nth-child(3) .circle-button { background: linear-gradient(135deg, #f97316, #dc2626); }
        .tab-circle:nth-child(4) .circle-button { background: linear-gradient(135deg, #ec4899, #f43f5e); }
        .tab-circle:nth-child(5) .circle-button { background: linear-gradient(135deg, #eab308, #f97316); }
        .tab-circle:nth-child(6) .circle-button { background: linear-gradient(135deg, #22c55e, #16a34a); }

        .circle-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .circle-button i {
            font-size: 2rem;
            color: white;
        }

        .circle-glow {
            position: absolute;
            inset: -15px;
            border-radius: 50%;
            opacity: 0;
            filter: blur(20px);
            transition: opacity 0.4s ease;
            z-index: -1;
        }

        .tab-circle:nth-child(1) .circle-glow { background: linear-gradient(135deg, #a855f7, #6366f1); }
        .tab-circle:nth-child(2) .circle-glow { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
        .tab-circle:nth-child(3) .circle-glow { background: linear-gradient(135deg, #f97316, #dc2626); }
        .tab-circle:nth-child(4) .circle-glow { background: linear-gradient(135deg, #ec4899, #f43f5e); }
        .tab-circle:nth-child(5) .circle-glow { background: linear-gradient(135deg, #eab308, #f97316); }
        .tab-circle:nth-child(6) .circle-glow { background: linear-gradient(135deg, #22c55e, #16a34a); }

        .tab-circle.active .circle-glow {
            opacity: 0.7;
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 0.9; }
        }

        .tab-status-badge {
            position: absolute;
            top: -3px;
            right: -3px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #22c55e;
            border: 2px solid rgba(15, 23, 42, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .tab-status-badge i {
            font-size: 0.75rem !important;
        }

        .tab-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: #64748b;
            text-align: center;
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .beta-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.15rem 0.4rem;
            font-size: 0.6rem;
            font-weight: 800;
            letter-spacing: 0.5px;
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
            border-radius: 8px;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
            animation: betaPulse 2s ease-in-out infinite;
        }

        @keyframes betaPulse {
            0%, 100% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.05); opacity: 1; }
        }

        .tab-circle.active .tab-label {
            color: #3b82f6;
        }

        .tab-circle.disabled {
            cursor: not-allowed;
        }

        .tab-circle.disabled .circle-button {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tab-circle.disabled:hover .circle-button {
            transform: none;
        }

        .tab-circle.disabled .circle-glow {
            opacity: 0 !important;
        }

        /* Карточки 3x2 или 4x1 для игр */
        .cards-area {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }
        
        /* Для игр - 4 карточки в ряд */
        .cards-area:has(.info-card[data-games="true"]) {
            grid-template-columns: repeat(4, 1fr);
        }

        .info-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 1.75rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            min-height: 180px;
        }

        .test-card {
            position: relative;
            overflow: hidden;
            border: none;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
        }

        .test-card .card-icon {
            background: rgba(255, 255, 255, 0.2) !important;
            color: white !important;
        }

        .test-card .play-badge {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            animation: playPulse 2s ease-in-out infinite;
        }

        @keyframes playPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        .info-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .info-card.clickable-card {
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .info-card.clickable-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.2);
        }

        .play-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .info-card.clickable-card:hover .play-badge {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }

        /* Banner card styles */
        .info-card.banner-card {
            min-height: 280px;
            overflow: hidden;
            position: relative;
        }

        .info-card.banner-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 50px rgba(59, 130, 246, 0.3);
        }

        .game-banner {
            transition: all 0.3s ease;
        }

        .info-card.banner-card:hover .game-banner {
            transform: scale(1.02);
        }

        /* Games banner styles */
        .games-banner {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .games-banner:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .card-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            flex-shrink: 0;
        }

        .card-icon.progress { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
        .card-icon.legend { background: linear-gradient(135deg, #8b5cf6, #6366f1); }
        .card-icon.stats { background: linear-gradient(135deg, #f59e0b, #ef4444); }
        .card-icon.module { background: linear-gradient(135deg, #22c55e, #16a34a); }

        .card-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1e293b;
        }

        .card-subtitle {
            font-size: 0.85rem;
            color: #64748b;
        }

        .progress-percentage {
            font-weight: 700;
            color: #3b82f6;
            font-size: 1.5rem;
        }

        .progress-bar-container {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 999px;
            margin: 0.5rem 0;
        }

        .progress-bar {
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
            transition: width 0.5s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #64748b;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            color: #64748b;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .stats-row:last-child {
            border-bottom: none;
        }

        .stats-label {
            color: #64748b;
            font-size: 0.9rem;
        }

        .stats-value {
            font-weight: 700;
            color: #1e293b;
            font-size: 1.1rem;
        }

        /* Описание */
        .description-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .description-card h3 {
            color: #1e293b;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .description-card h3 i {
            font-size: 1.75rem;
            color: #3b82f6;
        }

        .description-card p {
            color: #64748b;
            line-height: 1.7;
            margin-bottom: 1rem;
        }

        .description-card h4 {
            color: #1e293b;
            font-size: 1.125rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }
        
        /* Archive Sidebar Stats */
        .archive-sidebar-stats {
            margin-top: 1rem;
        }
        
        .sidebar-stat-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.2s;
        }
        
        .sidebar-stat-item:hover {
            background: #f1f3f5;
            transform: translateX(2px);
        }
        
        .sidebar-stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .sidebar-stat-info {
            flex: 1;
        }
        
        .sidebar-stat-label {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        
        .sidebar-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1a202c;
            line-height: 1.2;
        }
        
        .sidebar-stat-avg {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }

        /* IRT Diagnostic Styles */
        .irt-actions {
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        .irt-actions .btn {
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .irt-actions .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .irt-actions .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .irt-actions .btn-outline-primary {
            border: 2px solid #3b82f6;
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        .irt-actions .btn-outline-primary:hover {
            background: #3b82f6;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .irt-actions .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .diagnostic-options h5 {
            color: #374151;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .diagnostic-options .btn small {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .description-card ul {
            list-style: none;
            padding: 0;
        }

        .description-card ul li {
            color: #64748b;
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .description-card ul li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #22c55e;
            font-weight: bold;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .sidebar-description {
                position: static;
            }
        }

        @media (max-width: 768px) {
            /* Контейнер карты обучения */
            .learning-map-container {
                padding: 1rem;
                margin-top: 60px;
            }
            
            /* Узлы - горизонтальная прокрутка для мобильных */
            .learning-tabs {
                padding: 3rem 0 1rem 0;
                margin-top: 30px;
                overflow: visible;
            }
            
            .tabs-container {
                top: -30px;
                left: 0;
                transform: none;
                gap: 1rem;
                flex-wrap: nowrap;
                justify-content: flex-start;
                overflow-x: auto;
                overflow-y: visible;
                padding: 0 1rem 1rem 1rem;
                width: 100%;
                /* Плавная прокрутка */
                scroll-behavior: smooth;
                -webkit-overflow-scrolling: touch;
                /* Скрываем scrollbar но оставляем функциональность */
                scrollbar-width: none; /* Firefox */
                -ms-overflow-style: none; /* IE and Edge */
            }
            
            .tabs-container::-webkit-scrollbar {
                display: none; /* Chrome, Safari, Opera */
            }
            
            /* Индикатор прокрутки - убран */
            /* .learning-tabs::after {
                content: '← Свайп →';
                position: absolute;
                bottom: 0.5rem;
                left: 50%;
                transform: translateX(-50%);
                font-size: 0.7rem;
                color: #94a3b8;
                opacity: 0.6;
                pointer-events: none;
            } */
            
            .tab-circle {
                margin: 0;
                flex-shrink: 0;
            }
            
            .circle-button {
                width: 65px;
                height: 65px;
            }
            
            .circle-inner {
                width: 57px;
                height: 57px;
            }
            
            .circle-button i {
                font-size: 1.6rem;
            }
            
            .circle-glow {
                width: 75px;
                height: 75px;
            }
            
            .tab-status-badge {
                width: 22px;
                height: 22px;
                top: -5px;
                right: -5px;
            }
            
            .tab-status-badge i {
                font-size: 0.7rem !important;
            }
            
            .tab-label {
                font-size: 0.75rem;
                margin-top: 0.35rem;
                white-space: nowrap;
            }
            
            /* Карточки - одна колонка */
            .cards-area {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            /* Для игр на мобильных - 2 колонки */
            .cards-area:has(.info-card[data-games="true"]) {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .info-card {
                min-height: 150px;
            }
            
            /* Описание */
            .description-card {
                padding: 1.5rem;
            }
            
            .description-card h3 {
                font-size: 1.25rem;
            }
            
            .description-card h4 {
                font-size: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            /* Компактные узлы для маленьких экранов */
            .circle-button {
                width: 55px;
                height: 55px;
            }
            
            .circle-inner {
                width: 48px;
                height: 48px;
            }
            
            .circle-button i {
                font-size: 1.4rem;
            }
            
            .circle-glow {
                width: 65px;
                height: 65px;
            }
            
            .tab-label {
                font-size: 0.7rem;
            }
            
            .tabs-container {
                gap: 0.75rem;
            }
        }

        /* ===== INDIVIDUAL PLAN STYLES ===== */
        .individual-plan-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ===== SIMPLIFIED DAILY FLOW STYLES ===== */
        .daily-plan-card {
            background: linear-gradient(to bottom, #ffffff 0%, #f8fafc 100%);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(15, 23, 42, 0.08), 0 2px 8px rgba(15, 23, 42, 0.04);
            border: 1px solid rgba(226, 232, 240, 0.8);
            margin-bottom: 32px;
            backdrop-filter: blur(10px);
        }

        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 36px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
            gap: 24px;
        }

        .plan-header-left {
            display: flex;
            flex-direction: column;
            gap: 14px;
            flex: 1;
        }

        .plan-header h2 {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            letter-spacing: -0.5px;
        }

        /* Countdown Timer Styles */
        .countdown-timer {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid rgba(56, 189, 248, 0.2);
            border-radius: 16px;
            font-size: 13px;
            font-weight: 600;
            color: #0369a1;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(14, 165, 233, 0.12);
        }

        .countdown-timer i {
            font-size: 18px;
            animation: tick 2s ease-in-out infinite;
            color: #0284c7;
        }

        @keyframes tick {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .countdown-timer .countdown-label {
            color: #0369a1;
            font-weight: 500;
            font-size: 12px;
        }

        .countdown-timer .countdown-time {
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 15px;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: #0c4a6e;
            min-width: 85px;
            text-align: center;
        }

        .countdown-timer.countdown-warning {
            background: linear-gradient(135deg, #fef9c3 0%, #fef08a 100%);
            border-color: rgba(250, 204, 21, 0.3);
            color: #a16207;
            box-shadow: 0 2px 8px rgba(250, 204, 21, 0.18);
        }

        .countdown-timer.countdown-warning i {
            color: #ca8a04;
        }

        .countdown-timer.countdown-warning .countdown-label,
        .countdown-timer.countdown-warning .countdown-time {
            color: #a16207;
        }

        .countdown-timer.countdown-urgent {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: rgba(248, 113, 113, 0.3);
            color: #991b1b;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            box-shadow: 0 2px 12px rgba(239, 68, 68, 0.25);
        }

        .countdown-timer.countdown-urgent i {
            color: #dc2626;
            animation: tick 0.8s ease-in-out infinite;
        }

        .countdown-timer.countdown-urgent .countdown-label,
        .countdown-timer.countdown-urgent .countdown-time {
            color: #991b1b;
        }

        @keyframes pulse {
            0%, 100% { 
                box-shadow: 0 2px 12px rgba(239, 68, 68, 0.25), 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            50% { 
                box-shadow: 0 2px 16px rgba(239, 68, 68, 0.35), 0 0 0 6px rgba(239, 68, 68, 0);
            }
        }

        .plan-status {
            padding: 10px 20px;
            border-radius: 24px;
            font-weight: 600;
            font-size: 13px;
            letter-spacing: 0.3px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .plan-status.status-pending {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #b45309;
        }

        .plan-status.status-in-progress {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
        }

        .plan-status.status-completed {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
        }

        .plan-items {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-bottom: 36px;
        }

        .plan-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 28px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.04);
        }

        .plan-item:hover:not(.locked) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.1);
        }

        .plan-item.completed {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #4ade80;
            box-shadow: 0 4px 16px rgba(34, 197, 94, 0.12);
        }

        .plan-item.in-progress {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-color: #60a5fa;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.12);
        }

        .plan-item.locked {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-color: #cbd5e1;
            opacity: 0.5;
        }

        .item-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .item-number {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 18px;
            color: #64748b;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.1);
            transition: all 0.3s ease;
        }

        .plan-item.completed .item-number {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .plan-item.in-progress .item-number {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .item-info h3 {
            font-size: 19px;
            font-weight: 700;
            color: #0f172a;
            margin: 0 0 6px 0;
            letter-spacing: -0.3px;
        }

        .item-info p {
            font-size: 14px;
            color: #64748b;
            margin: 0;
            font-weight: 500;
        }

        .item-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .item-progress {
            font-size: 15px;
            color: #475569;
            font-weight: 600;
        }

        .item-status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .item-status-badge {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            color: #475569;
        }

        .item-status-badge.in-progress {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
        }

        .item-status-badge.locked {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #94a3b8;
            box-shadow: none;
        }

        .connector {
            height: 3px;
            background: linear-gradient(to right, #e2e8f0 0%, #cbd5e1 50%, #e2e8f0 100%);
            margin: 0 28px;
            transition: all 0.4s ease;
            position: relative;
            border-radius: 2px;
        }

        .connector.active {
            background: linear-gradient(to right, #10b981 0%, #22c55e 50%, #10b981 100%);
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.3);
        }

        .plan-actions {
            margin-bottom: 32px;
        }

        .action-group {
            text-align: center;
        }

        .btn-primary.btn-large {
            padding: 18px 40px;
            font-size: 17px;
            font-weight: 700;
            border-radius: 16px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.35);
            letter-spacing: 0.3px;
        }

        .btn-primary.btn-large:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 32px rgba(59, 130, 246, 0.45);
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        }

        .btn-primary.btn-large:active {
            transform: translateY(-1px);
        }

        .completion-group {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            padding: 28px;
            border-radius: 20px;
            border: 2px solid #4ade80;
            box-shadow: 0 4px 16px rgba(34, 197, 94, 0.12);
        }

        .completion-title {
            font-size: 22px;
            font-weight: 800;
            color: #0f172a;
            margin: 0 0 24px 0;
            text-align: center;
            letter-spacing: -0.3px;
        }

        .repeat-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-outline {
            padding: 14px 24px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 12px;
            background: white;
            color: #3b82f6;
            border: 2px solid #3b82f6;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.12);
        }

        .btn-outline:hover {
            background: #3b82f6;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.25);
        }

        .btn-outline:active {
            transform: translateY(0);
        }

        .daily-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 28px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.04);
        }

        .stat-box {
            text-align: center;
        }

        .stat-label {
            display: block;
            font-size: 11px;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .stat-value {
            display: block;
            font-size: 26px;
            font-weight: 800;
            background: linear-gradient(135deg, #0f172a 0%, #334155 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .daily-plan-card {
                padding: 24px 20px;
                margin: 0 -10px 24px -10px;
                border-radius: 16px;
                box-shadow: 0 4px 16px rgba(15, 23, 42, 0.08);
            }

            .plan-header {
                flex-direction: column;
                gap: 14px;
                align-items: flex-start;
                padding-bottom: 20px;
            }

            .plan-header-left {
                width: 100%;
            }

            .plan-header h2 {
                font-size: 26px;
                font-weight: 800;
            }

            .countdown-timer {
                font-size: 12px;
                padding: 8px 14px;
                border-radius: 12px;
            }

            .countdown-timer i {
                font-size: 16px;
            }

            .countdown-timer .countdown-time {
                font-size: 14px;
                min-width: 75px;
            }

            .plan-item {
                padding: 20px;
                border-radius: 16px;
            }

            .item-left {
                gap: 14px;
            }

            .item-number {
                width: 42px;
                height: 42px;
                font-size: 16px;
                border-radius: 12px;
            }

            .item-info h3 {
                font-size: 17px;
                font-weight: 700;
            }

            .item-info p {
                font-size: 13px;
            }

            .connector {
                margin: 0 20px;
            }

            .btn-primary.btn-large {
                padding: 16px 32px;
                font-size: 16px;
                border-radius: 14px;
            }

            .plan-status {
                padding: 8px 16px;
                font-size: 12px;
            }

            .item-status-badge {
                padding: 6px 12px;
                font-size: 12px;
            }

            .repeat-buttons {
                flex-direction: column;
            }

            .daily-stats {
                grid-template-columns: 1fr;
                gap: 16px;
                padding: 16px;
            }
        }

        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .plan-header h2 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #1a202c;
        }

        .streak-widget {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            padding: 12px 20px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        .streak-animation {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        
        .streak-info {
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .streak-icon {
            font-size: 24px;
            color: #ff6b6b;
        }

        .streak-count {
            font-size: 24px;
            font-weight: bold;
        }

        .streak-label {
            font-size: 14px;
        }

        .daily-tasks-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .daily-tasks-card h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #1a202c;
        }

        /* Daily Tasks Rotation Styles */
        .daily-tasks-rotation-container {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .cycle-info {
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
            text-align: center;
        }
        
        .cycle-day {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .cycle-progress {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .cycle-progress-bar {
            height: 100%;
            background: white;
            transition: width 0.3s ease;
        }
        
        .cycle-text {
            font-size: 14px;
            opacity: 0.9;
        }
        
        /* Planner Calendar Styles */
        .planner-calendar-container {
            padding: 2rem;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        
        .planner-calendar {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 0.15rem;
            margin-top: 0.75rem;
            max-width: 500px;
        }
        
        .planner-calendar-week {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
            gap: 0.15rem;
            margin-bottom: 0.15rem;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 2px;
            padding: 0.15rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            width: 100%;
            max-width: 70px;
        }
        
        /* Mobile adaptation for planner calendar */
        @media (max-width: 768px) {
            .planner-calendar-container {
                padding: 1rem;
            }
            
            .planner-calendar {
                grid-template-columns: repeat(7, 1fr);
                gap: 0.3rem;
                margin-top: 1rem;
            }
            
            /* На мобильных календарь из 28 дней будет в 4 строки по 7 дней */
            .calendar-day {
                min-height: 40px;
                padding: 0.3rem;
            }
            
            .day-number {
                font-size: 0.9rem;
            }
            
            /* На мобильных для планировщика меняем layout на колонку */
            .learning-map-container:has(.planner-calendar-container) .main-layout {
                grid-template-columns: 1fr !important;
            }
            
            .learning-map-container:has(.planner-calendar-container) .sidebar-description {
                position: relative !important;
                top: auto !important;
                margin-top: 1.5rem;
            }
            
        }
        
        .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            border-color: var(--primary-color);
        }
        
        .calendar-day.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .calendar-day.selected .day-number {
            color: white;
        }
        
        .calendar-day.today {
            border-color: #10b981;
            border-width: 2px;
        }
        
        .calendar-day.big-test {
            background: #f59e0b;
            color: white;
            border-color: #f59e0b;
        }
        
        .calendar-day.big-test .day-number {
            color: white;
        }
        
        .calendar-day.locked {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        .calendar-day.locked .day-number {
            color: #9ca3af;
        }
        
        .calendar-day.locked:hover {
            transform: none;
            box-shadow: none;
        }
        
        .day-number {
            font-size: 0.75rem;
            font-weight: 500;
            color: #1a202c;
        }
        
        .planner-calendar-wrapper {
            width: 100%;
        }
        
        .task-card {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .task-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .task-card.completed {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .task-card .task-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            margin-right: 15px;
            color: white;
            font-size: 24px;
        }
        
        .task-card.completed .task-icon {
            background: #28a745;
        }
        
        .task-card .task-info {
            flex: 1;
        }
        
        .task-card .task-info h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .task-card .task-info p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }
        
        .task-status {
            display: flex;
            align-items: center;
        }
        
        .btn-start-task {
            padding: 8px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-start-task:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .tasks-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 20px 0;
        }

        .task-stat {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .task-icon {
            font-size: 32px;
            color: var(--primary-color, #3b82f6);
        }

        .task-info strong {
            display: block;
            font-size: 24px;
            color: #0066cc;
            font-weight: 700;
        }

        .task-info small {
            color: #6c757d;
            font-size: 0.85rem;
        }

        .daily-progress {
            margin: 20px 0;
        }

        .progress-bar {
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0066cc, #4ca0ff);
            transition: width 0.3s ease;
        }

        .progress-text {
            margin-top: 8px;
            text-align: center;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .btn-large {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #0066cc, #4ca0ff);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-large:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
        }

        .categories-section {
            margin: 32px 0;
        }

        .categories-section h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #1a202c;
        }

        .categories-accordion {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .category-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .category-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .category-header:hover {
            background: #f8f9fa;
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .category-icon {
            font-size: 28px;
        }

        .category-info h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a202c;
        }

        .category-info small {
            color: #6c757d;
            font-size: 0.85rem;
        }

        .category-stats {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progress-percent {
            font-size: 18px;
            font-weight: 600;
        }

        .progress-high { color: #28a745; }
        .progress-medium { color: #ffc107; }
        .progress-low { color: #dc3545; }

        .category-content {
            padding: 16px 20px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .category-progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .category-content p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 32px;
        }

        .stat-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .stat-icon {
            font-size: 32px;
            color: var(--primary-color, #3b82f6);
        }

        .category-icon {
            font-size: 28px;
            color: var(--text-muted, #6c757d);
        }

        .stat-card strong {
            display: block;
            font-size: 24px;
            color: #0066cc;
            font-weight: 700;
        }

        .stat-card small {
            color: #6c757d;
            font-size: 0.85rem;
        }

        /* Mobile responsive for Individual Plan */
        @media (max-width: 768px) {
            .tasks-summary,
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .plan-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .individual-plan-container {
                padding: 15px;
            }

            .daily-tasks-card {
                padding: 20px;
            }

            .task-stat {
                padding: 12px;
            }

            .task-icon {
                font-size: 24px;
            }

            .task-info strong {
                font-size: 20px;
            }
        }

        /* ===== PROGRESS TAB STYLES ===== */
        .progress-dashboard {
            width: 100%;
            max-width: 1400px; /* Wide max-width for desktop */
            margin: 0 auto;
            padding: 20px;
        }

        .progress-header {
            margin-bottom: 32px;
        }

        .progress-header h2 {
            font-size: 32px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .subtitle {
            color: #6c757d;
            font-size: 16px;
        }

        /* Metrics Grid - RESPONSIVE */
        .metrics-grid {
            display: grid;
            gap: 16px;
            margin-bottom: 40px;
            /* Mobile: 1 column */
            grid-template-columns: 1fr;
        }

        @media (min-width: 576px) {
            .metrics-grid {
                /* Small screens: 2 columns */
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 992px) {
            .metrics-grid {
                /* Desktop: 4 columns */
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .metric-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 24px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .metric-card.primary {
            background: linear-gradient(135deg, rgba(0,102,204,0.1), white);
            border-left: 4px solid #0066cc;
        }

        .metric-card.accent {
            background: linear-gradient(135deg, rgba(255,107,107,0.1), white);
            border-left: 4px solid #ff6b6b;
        }

        .metric-card.success {
            background: linear-gradient(135deg, rgba(40,167,69,0.1), white);
            border-left: 4px solid #28a745;
        }

        .metric-card.info {
            background: linear-gradient(135deg, rgba(23,162,184,0.1), white);
            border-left: 4px solid #17a2b8;
        }

        .metric-icon i {
            font-size: 40px;
        }

        .metric-card.primary .metric-icon i { color: #0066cc; }
        .metric-card.success .metric-icon i { color: #28a745; }
        .metric-card.info .metric-icon i { color: #17a2b8; }

        .metric-info {
            display: flex;
            flex-direction: column;
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #212529;
            line-height: 1;
        }

        .metric-label {
            font-size: 14px;
            color: #6c757d;
            margin-top: 4px;
        }
        
        /* Premium tab - smaller metric values (half size) */
        .premium-access-container .metric-value {
            font-size: 16px; /* 32px / 2 = 16px */
        }
        
        .premium-access-container .metric-label {
            font-size: 12px; /* 14px / 2 = 7px, но сделаю 12px для читаемости */
        }

        /* Categories Progress */
        .categories-progress-section {
            margin-bottom: 40px;
        }

        .categories-progress-section h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .categories-list {
            display: grid;
            gap: 16px;
            /* Mobile: 1 column */
            grid-template-columns: 1fr;
        }

        @media (min-width: 992px) {
            .categories-list {
                /* Desktop: 2 columns */
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .category-progress-item {
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }

        .category-progress-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .category-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .category-name {
            font-weight: 600;
            font-size: 16px;
        }

        .category-percentage {
            font-weight: bold;
            font-size: 18px;
        }

        .category-progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .category-meta {
            font-size: 14px;
            color: #6c757d;
        }

        /* Activity Heatmap */
        .activity-section {
            margin-bottom: 40px;
        }

        .activity-section h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .activity-heatmap {
            display: grid;
            grid-template-columns: repeat(auto-fill, 16px);
            gap: 4px;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            max-width: 100%;
        }

        @media (min-width: 992px) {
            .activity-heatmap {
                /* Desktop: bigger squares */
                grid-template-columns: repeat(auto-fill, 20px);
            }
        }

        .activity-day {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            background: #e9ecef;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        @media (min-width: 992px) {
            .activity-day {
                width: 20px;
                height: 20px;
            }
        }

        .activity-day:hover {
            transform: scale(1.2);
        }

        .activity-day.level-0 { background: #ebedf0; }
        .activity-day.level-1 { background: #c6e48b; }
        .activity-day.level-2 { background: #7bc96f; }
        .activity-day.level-3 { background: #239a3b; }
        .activity-day.level-4 { background: #196127; }

        .activity-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 12px;
            color: #6c757d;
        }

        .legend-colors {
            display: flex;
            gap: 4px;
        }

        .legend-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-box.level-0 { background: #ebedf0; }
        .legend-box.level-1 { background: #c6e48b; }
        .legend-box.level-2 { background: #7bc96f; }
        .legend-box.level-3 { background: #239a3b; }
        .legend-box.level-4 { background: #196127; }

        /* Sessions List */
        .sessions-section {
            margin-bottom: 40px;
        }

        .sessions-section h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .sessions-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .session-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }

        .session-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .session-icon i {
            font-size: 32px;
            color: #0066cc;
        }

        .session-info {
            flex: 1;
        }

        .session-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .session-meta {
            font-size: 14px;
            color: #6c757d;
        }

        .session-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .badge-success {
            background: rgba(40,167,69,0.1);
            color: #28a745;
        }

        .badge-warning {
            background: rgba(255,193,7,0.1);
            color: #ffc107;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .empty-state i {
            font-size: 64px;
            color: #dee2e6;
            margin-bottom: 16px;
        }

        .empty-state p {
            color: #6c757d;
            margin-bottom: 20px;
        }

        .empty-state .btn-primary {
            padding: 12px 24px;
            background: linear-gradient(135deg, #0066cc, #4ca0ff);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .empty-state .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,102,204,0.3);
        }

        /* Achievements */
        .achievements-section {
            margin-bottom: 40px;
        }

        .achievements-section h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .badges-grid {
            display: grid;
            gap: 20px;
            /* Mobile: 2 columns */
            grid-template-columns: repeat(2, 1fr);
        }

        @media (min-width: 576px) {
            .badges-grid {
                /* Tablet: 3 columns */
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 992px) {
            .badges-grid {
                /* Desktop: 4 columns */
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .badge-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.2s ease;
        }

        .badge-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .badge-item.locked {
            opacity: 0.4;
        }

        .badge-item.earned {
            background: linear-gradient(135deg, rgba(255,215,0,0.1), white);
            border: 2px solid #ffd700;
        }

        .badge-animation-container {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .lock-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 50%;
            backdrop-filter: blur(2px);
        }

        .lock-overlay i {
            font-size: 32px;
            color: #adb5bd;
        }

        .badge-item.earned .lock-overlay {
            display: none;
        }

        .badge-name {
            margin-top: 12px;
            font-weight: 600;
            font-size: 14px;
        }

        .badge-requirement {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }

        .badge-progress {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }

        /* Old badge-locked class - kept for backwards compatibility */
        .badge-locked {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 50%;
        }

        .badge-locked i {
            font-size: 32px;
            color: #adb5bd;
        }

        /* Fix for dropdown menus in header */
        .dropdown-menu {
            display: none;
        }
        
        .dropdown-menu.show {
            display: block !important;
        }
        
        .dropdown-toggle::after {
            display: none;
        }
        
        /* Ensure dropdown menus are visible when shown */
        .dropdown-menu[data-bs-popper] {
            display: block !important;
        }
        
        /* Learning Categories Accordion */
        .learning-categories-accordion-section {
            margin: 40px 0;
        }
        
        .learning-categories-accordion-section h3 {
            font-size: 24px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .subtitle-small {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .accordion {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .accordion-item {
            border: none;
            border-bottom: 1px solid #e9ecef;
        }
        
        .accordion-item:last-child {
            border-bottom: none;
        }
        
        .accordion-button {
            background-color: white;
            border: none;
            padding: 20px 24px;
            font-size: 16px;
            font-weight: 600;
            color: #1a1a2e;
            display: flex;
            align-items: center;
            width: 100%;
            text-align: left;
            transition: background-color 0.2s;
        }
        
        .accordion-button:not(.collapsed) {
            background-color: #f8f9fa;
            color: #1a1a2e;
        }
        
        .accordion-button:hover {
            background-color: #f8f9fa;
        }
        
        .accordion-button:focus {
            box-shadow: none;
            border: none;
        }
        
        .accordion-body {
            padding: 24px;
            background-color: white;
        }
        
        .category-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 576px) {
            .category-stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .stat-label {
            font-size: 13px;
            color: #6c757d;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1a1a2e;
        }
        
        .category-progress-bar-detailed {
            margin-top: 16px;
        }
        
        /* Mobile responsive for Progress tab */
        @media (max-width: 768px) {
            .progress-dashboard {
                padding: 15px;
                max-width: 600px; /* Constrain width on mobile */
            }

            .progress-header h2 {
                font-size: 24px;
            }

            .metric-card {
                padding: 16px;
            }

            .metric-value {
                font-size: 24px;
            }

            .activity-heatmap {
                grid-template-columns: repeat(auto-fill, 12px);
                gap: 3px;
                padding: 15px;
            }

            .activity-day {
                width: 12px;
                height: 12px;
            }
        }

        /* Tablet responsive */
        @media (min-width: 769px) and (max-width: 1199px) {
            .progress-dashboard {
                max-width: 900px; /* Medium width on tablet */
            }
        }

        /* ===== BEAUTIFUL MODAL STYLES ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.2s ease;
            padding: 20px;
            overflow-y: auto;
        }
        
        /* Celebration Overlay */
        .celebration-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            cursor: pointer;
        }

        .celebration-content {
            text-align: center;
            animation: scaleIn 0.5s ease;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .celebration-content h3 {
            color: white;
            font-size: 24px;
            margin-top: 20px;
            animation: fadeIn 0.5s ease 0.3s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 20px;
            color: #6c757d;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f8f9fa;
            color: #000;
        }

        .modal-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #0066cc, #4ca0ff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .modal-icon i {
            font-size: 40px;
            color: white;
        }

        .modal-card h3 {
            text-align: center;
            font-size: 28px;
            margin-bottom: 16px;
            color: #212529;
        }

        .modal-description {
            text-align: center;
            color: #6c757d;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 32px;
        }

        .modal-features {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
            padding: 24px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .feature {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            text-align: center;
        }

        .feature i {
            font-size: 28px;
            color: #0066cc;
        }

        .feature span {
            font-size: 14px;
            color: #495057;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 14px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: #e9ecef;
            color: #495057;
        }

        .btn-secondary:hover {
            background: #dee2e6;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0066cc, #4ca0ff);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 102, 204, 0.3);
        }

        /* Mobile responsive */
        @media (max-width: 576px) {
            .modal-overlay {
                padding: 10px;
                align-items: flex-start;
                padding-top: 80px;
            }
            
            .modal-card {
                padding: 20px 15px;
                max-width: 100%;
                width: 100%;
                margin: 0;
                border-radius: 16px;
            }
            
            .modal-icon {
                width: 60px;
                height: 60px;
                margin-bottom: 16px;
            }
            
            .modal-icon i {
                font-size: 30px;
            }
            
            .modal-card h3 {
                font-size: 22px;
                margin-bottom: 12px;
            }
            
            .modal-description {
                font-size: 14px;
                margin-bottom: 20px;
            }
            
            .modal-features {
                flex-direction: column;
                gap: 12px;
                padding: 16px;
                margin-bottom: 20px;
            }
            
            .feature {
                flex-direction: row;
                justify-content: flex-start;
                text-align: left;
                gap: 12px;
            }
            
            .feature i {
                font-size: 20px;
                min-width: 20px;
            }
            
            .feature span {
                font-size: 13px;
            }
            
            .modal-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .modal-buttons button {
                padding: 12px 20px;
                font-size: 15px;
            }
        }
        
        /* Extra small screens (iPhone SE) */
        @media (max-width: 375px) {
            .modal-overlay {
                padding: 5px;
                padding-top: 70px;
            }
            
            .modal-card {
                padding: 15px 12px;
                border-radius: 12px;
            }
            
            .modal-icon {
                width: 50px;
                height: 50px;
                margin-bottom: 12px;
            }
            
            .modal-icon i {
                font-size: 24px;
            }
            
            .modal-card h3 {
                font-size: 20px;
                margin-bottom: 10px;
            }
            
            .modal-description {
                font-size: 13px;
                margin-bottom: 16px;
            }
            
            .modal-features {
                padding: 12px;
                margin-bottom: 16px;
                gap: 8px;
            }
            
            .feature {
                gap: 8px;
            }
            
            .feature i {
                font-size: 18px;
                min-width: 18px;
            }
            
            .feature span {
                font-size: 12px;
            }
            
            .modal-buttons button {
                padding: 10px 16px;
                font-size: 14px;
            }
        }

        /* ============================================================
           VIRTUAL PATIENT SECTION STYLES
           ============================================================ */

        .training-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            border: 1px solid #e0e7ff;
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }

        .training-section:hover {
            box-shadow: 0 8px 24px rgba(0, 102, 204, 0.08);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            gap: 20px;
        }

        .header-content {
            flex: 1;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #1a1a2e;
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title i {
            color: #0066cc;
            font-size: 24px;
        }

        .section-subtitle {
            font-size: 14px;
            color: #666;
            margin: 0;
        }

        .header-stats {
            display: flex;
            gap: 20px;
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e7ff;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .stat-label {
            color: #666;
            font-weight: 500;
        }

        .stat-value {
            color: #0066cc;
            font-weight: 700;
            font-size: 16px;
        }

        /* VP Content */
        .vp-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* VP Cards Container */
        .vp-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }


        .vp-card {
            background: white;
            border: 2px solid #e0e7ff;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .vp-card:hover {
            border-color: #0066cc;
            box-shadow: 0 8px 20px rgba(0, 102, 204, 0.15);
            transform: translateY(-4px);
        }

        .vp-card.vp-current {
            border-color: #0066cc;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
        }

        .vp-card.vp-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            grid-column: 1 / -1;
        }

        .vp-empty-icon {
            font-size: 48px;
            color: #ccc;
            margin-bottom: 16px;
        }

        .vp-card h4 {
            margin: 0;
            color: #1a1a2e;
            font-weight: 600;
        }

        .vp-card p {
            margin: 8px 0 0 0;
            color: #666;
            font-size: 14px;
        }

        .vp-empty-hint {
            font-size: 12px;
            color: #999;
            margin-top: 12px !important;
        }

        /* VP Card Header */
        .vp-card-header {
            padding: 16px;
            background: linear-gradient(135deg, #f0f4ff 0%, #f8f9ff 100%);
            border-bottom: 1px solid #e0e7ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .vp-difficulty {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .difficulty-easy {
            background: #d4f4dd;
            color: #10b981;
        }

        .difficulty-medium {
            background: #fef3c7;
            color: #f59e0b;
        }

        .difficulty-hard {
            background: #fee2e2;
            color: #ef4444;
        }

        .vp-estimated-time {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #666;
            font-size: 13px;
            font-weight: 500;
        }

        .vp-estimated-time i {
            color: #0066cc;
        }

        /* VP Card Body */
        .vp-card-body {
            padding: 16px;
            flex: 1;
        }

        .vp-card-title {
            font-size: 16px;
            font-weight: 700;
            color: #1a1a2e;
            margin: 0 0 8px 0;
        }

        .vp-card-description {
            font-size: 13px;
            color: #666;
            margin: 0 0 12px 0;
            line-height: 1.5;
        }

        .vp-specialty {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .specialty-badge {
            display: inline-block;
            padding: 6px 12px;
            background: #e0e7ff;
            color: #0066cc;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
        }

        /* VP Card Footer */
        .vp-card-footer {
            padding: 16px;
            background: #f8f9ff;
            border-top: 1px solid #e0e7ff;
        }

        .vp-in-progress {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: #d4f4dd;
            color: #10b981;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .vp-in-progress i {
            animation: spin 2s linear infinite;
        }

        /* VP Stats Grid */
        .vp-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e0e7ff;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-color: #0066cc;
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.1);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #e0e7ff 0%, #f0f4ff 100%);
            border-radius: 12px;
            font-size: 24px;
            color: #0066cc;
        }

        .stat-info {
            flex: 1;
        }

        .stat-title {
            display: block;
            font-size: 12px;
            color: #666;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .stat-number {
            display: block;
            font-size: 20px;
            font-weight: 700;
            color: #0066cc;
        }

        /* VP Recent Sessions */
        .vp-recent-sessions {
            margin-top: 20px;
        }

        .recent-title {
            font-size: 14px;
            font-weight: 700;
            color: #1a1a2e;
            margin: 0 0 12px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sessions-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border: 1px solid #e0e7ff;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .session-item:hover {
            background: #f8f9ff;
            border-color: #0066cc;
        }

        .session-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .session-title {
            font-size: 13px;
            font-weight: 600;
            color: #1a1a2e;
        }

        .session-date {
            font-size: 12px;
            color: #999;
        }

        .session-score {
            margin-left: 12px;
        }

        .score-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
            text-align: center;
            min-width: 50px;
        }

        .score-excellent {
            background: #d4f4dd;
            color: #10b981;
        }

        .score-good {
            background: #d4e8ff;
            color: #0066cc;
        }

        .score-needs-improvement {
            background: #fef3c7;
            color: #f59e0b;
        }

        .score-poor {
            background: #fee2e2;
            color: #ef4444;
        }

        /* VP Loading */
        .vp-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 24px;
            background: white;
            border: 1px solid #e0e7ff;
            border-radius: 12px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e7ff;
            border-top-color: #0066cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        .vp-loading p {
            color: #666;
            font-size: 14px;
        }

        /* Animations */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .section-header {
                flex-direction: column;
            }
            
            .header-stats {
                width: 100%;
                justify-content: space-around;
            }
            
            .vp-cards-container {
                grid-template-columns: 1fr;
            }
            
            .vp-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .training-section {
                padding: 16px;
            }
        }
        
        [x-cloak] {
            display: none !important;
        }
        
        /* Guided tour */
        body.tour-active {
            overflow: hidden;
        }
        
        .tour-highlight {
            position: relative;
            z-index: 10005;
            box-shadow: 0 0 0 9999px rgba(13, 23, 44, 0.65);
            border-radius: 14px;
            transition: box-shadow 0.3s ease, transform 0.3s ease;
            outline: 3px solid rgba(59, 130, 246, 0.4);
            outline-offset: 6px;
        }
        
        .tour-highlight:before {
            content: '';
            position: absolute;
            inset: -8px;
            border-radius: 18px;
            border: 2px solid rgba(59, 130, 246, 0.35);
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .tour-highlight {
                box-shadow: 0 0 0 3000px rgba(13, 23, 44, 0.6);
                outline-width: 2px;
                outline-offset: 4px;
            }
        }
        
        .tour-scrim {
            position: fixed;
            inset: 0;
            background: rgba(10, 15, 35, 0.45);
            backdrop-filter: blur(2px);
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .tour-scrim.active {
            opacity: 1;
        }
        
        .tour-tooltip {
            position: fixed;
            z-index: 10006;
            background: #ffffff;
            color: #1a1a2e;
            padding: 20px 24px;
            border-radius: 18px;
            width: 320px;
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.25);
            border: 1px solid rgba(59, 130, 246, 0.1);
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .tour-tooltip h5 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .tour-tooltip p {
            font-size: 0.95rem;
            color: #4a5568;
            line-height: 1.6;
            margin-bottom: 16px;
        }
        
        .tour-tooltip .tour-controls {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }
        
        .tour-tooltip .tour-controls button {
            flex: 1;
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .tour-tooltip .tour-controls button:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.2);
        }
        
        .tour-tooltip .tour-controls .secondary-btn {
            background: #eef2ff;
            color: #3b82f6;
        }
        
        .tour-tooltip .tour-controls .primary-btn {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: #fff;
        }
        
        .tour-tooltip .tour-controls .finish-btn {
            background: linear-gradient(135deg, #16a34a, #22c55e);
            color: #fff;
        }
        
        .tour-tooltip-step-1 { top: 210px; left: 140px; }
        .tour-tooltip-step-2 { top: 420px; left: 220px; }
        .tour-tooltip-step-3 { top: 360px; right: 160px; }
        .tour-tooltip-step-4 { top: 210px; left: 420px; }
        .tour-tooltip-step-5 { top: 160px; right: 320px; }
        .tour-tooltip-step-6 { top: 110px; right: 140px; }
        
        .tour-start-button {
            position: fixed;
            right: 28px;
            bottom: 28px;
            z-index: 10004;
            background: rgba(37, 99, 235, 0.15);
            color: #2563eb;
            border: 1px solid rgba(37, 99, 235, 0.35);
            border-radius: 50%;
            width: 54px;
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
            cursor: pointer;
            backdrop-filter: blur(6px);
            box-shadow: 0 14px 30px rgba(37, 99, 235, 0.25);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .tour-start-button:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 18px 38px rgba(37, 99, 235, 0.3);
        }
        
        .tour-intro-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.92), rgba(30, 64, 175, 0.85));
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10008;
            backdrop-filter: blur(6px);
        }
        
        .tour-intro-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 28px;
            padding: 48px;
            max-width: 520px;
            width: 90%;
            text-align: center;
            color: #f8fafc;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
        }
        
        .tour-intro-logo {
            width: 160px;
            height: auto;
            margin: 0 auto 24px auto;
        }
        
        .tour-intro-card h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 16px;
        }
        
        .tour-intro-card p {
            font-size: 1rem;
            line-height: 1.7;
            color: rgba(226, 232, 240, 0.9);
            margin-bottom: 24px;
        }
        
        .tour-dont-show-checkbox {
            margin-bottom: 24px;
            display: flex;
            justify-content: center;
        }
        
        .tour-dont-show-checkbox label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            color: rgba(226, 232, 240, 0.9);
            font-size: 0.95rem;
            user-select: none;
        }
        
        .tour-dont-show-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #3b82f6;
            border-radius: 4px;
        }
        
        .tour-dont-show-checkbox label:hover {
            color: #f8fafc;
        }
        
        .tour-intro-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .tour-intro-actions button {
            min-width: 180px;
            padding: 12px 20px;
            border-radius: 999px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .tour-intro-actions button.primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: #fff;
            box-shadow: 0 16px 40px rgba(59, 130, 246, 0.35);
        }
        
        .tour-intro-actions button.secondary {
            background: rgba(248, 250, 252, 0.12);
            color: #e2e8f0;
            border: 1px solid rgba(148, 163, 184, 0.25);
        }
        
        .tour-intro-actions button:hover {
            transform: translateY(-2px);
        }
        
        .tour-intro-actions button.primary:hover {
            box-shadow: 0 22px 50px rgba(59, 130, 246, 0.4);
        }
        
        @media (max-width: 1024px) {
            .tour-tooltip {
                width: 280px;
            }
            
            .tour-tooltip-step-2 { top: 440px; left: 120px; }
            .tour-tooltip-step-3 { top: 400px; right: 80px; }
            .tour-tooltip-step-4 { top: 220px; left: 360px; }
            .tour-tooltip-step-5 { top: 150px; right: 220px; }
            .tour-tooltip-step-6 { top: 110px; right: 80px; }
        }
        
        @media (max-width: 768px) {
            .tour-tooltip {
                width: calc(100% - 40px);
                left: 20px !important;
                right: 20px !important;
                top: auto !important;
                bottom: 20px !important;
            }
            
            .tour-highlight:before {
                inset: -4px;
            }
            
            .tour-intro-card {
                padding: 32px 24px;
            }
        }

        /* Hide residual Debug Info block on learning map */
        .debug-section { display: none !important; }
        
        /* Premium Access Styles - Compact Metric Blocks */
        .premium-access-container {
            background: #ffffff;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            text-align: left;
        }
        
        /* Premium Header */
        .premium-header {
            margin-bottom: 32px;
        }
        
        .premium-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a2e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .premium-header h2 i {
            color: #f59e0b;
        }
        
        .premium-header .subtitle {
            color: #666;
            font-size: 16px;
            margin: 0;
        }
        
        /* Premium Metrics Grid - 3 columns */
        .premium-metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        @media (max-width: 1024px) {
            .premium-metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .premium-access-container {
                padding: 24px;
            }
            
            .premium-metrics-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================================
           ARCHIVE SECTION STYLES - MODERN GLASS MORPHISM
           ============================================================ */
        
        .archive-container {
            /* Белый фон-карточка, как у других вкладок */
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px) !important;
            border-radius: 20px !important;
            padding: 2rem !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08) !important;
            width: 100% !important;
        }
        
        .archive-container .archive-categories {
            display: flex !important;
            flex-wrap: wrap !important;
            gap: 0.75rem !important;
            margin-bottom: 1.5rem !important;
        }
        
        .archive-container .category-btn {
            background: rgba(255, 255, 255, 0.7) !important;
            backdrop-filter: blur(30px) !important;
            border: 1px solid rgba(255, 255, 255, 0.9) !important;
            border-radius: 12px !important;
            padding: 0.75rem 1.25rem !important;
            cursor: pointer !important;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
            display: flex !important;
            align-items: center !important;
            gap: 0.625rem !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03), 0 8px 16px rgba(0, 0, 0, 0.06) !important;
            position: relative !important;
            overflow: hidden !important;
            white-space: nowrap !important;
        }
        
        .archive-container .category-btn:hover {
            transform: translateY(-2px) !important;
            border-color: rgba(62, 205, 193, 0.4) !important;
            background: rgba(255, 255, 255, 0.85) !important;
            box-shadow: 0 4px 12px rgba(62, 205, 193, 0.15) !important;
        }
        
        .archive-container .category-btn.active {
            background: linear-gradient(135deg, rgba(62, 205, 193, 0.95) 0%, rgba(50, 163, 154, 0.95) 100%) !important;
            color: white !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
            box-shadow: 0 4px 12px rgba(62, 205, 193, 0.25) !important;
        }
        
        .archive-container .category-icon {
            font-size: 1.25rem !important;
            color: #3ECDC1 !important;
            transition: all 0.3s ease !important;
        }
        
        .archive-container .category-btn.active .category-icon {
            color: white !important;
        }
        
        .archive-container .category-text {
            display: flex !important;
            align-items: center !important;
            gap: 0.5rem !important;
        }
        
        .archive-container .category-title {
            font-size: 0.9rem !important;
            font-weight: 600 !important;
            color: #1a202c !important;
            margin: 0 !important;
        }
        
        .archive-container .category-btn.active .category-title {
            color: white !important;
        }
        
        .archive-container .category-count {
            font-size: 0.75rem !important;
            color: #94a3b8 !important;
            background: rgba(255, 255, 255, 0.5) !important;
            padding: 0.125rem 0.5rem !important;
            border-radius: 8px !important;
        }
        
        .archive-container .category-btn.active .category-count {
            color: white !important;
            background: rgba(255, 255, 255, 0.2) !important;
        }
        
        .archive-container .archive-filters {
            display: flex !important;
            gap: 0.75rem !important;
            margin-bottom: 1.5rem !important;
            flex-wrap: wrap !important;
        }
        
        .archive-container .filter-search {
            flex: 1 !important;
            min-width: 220px !important;
            padding: 0.625rem 0.875rem 0.625rem 2.5rem !important;
            border: 1.5px solid rgba(62, 205, 193, 0.2) !important;
            border-radius: 10px !important;
            background: rgba(255, 255, 255, 0.6) !important;
            backdrop-filter: blur(20px) !important;
            font-size: 0.875rem !important;
        }
        
        .archive-container .filter-search-wrapper {
            position: relative !important;
            flex: 1 !important;
            min-width: 220px !important;
        }
        
        .archive-container .filter-search-wrapper i {
            position: absolute !important;
            left: 0.875rem !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            color: #cbd5e1 !important;
            pointer-events: none !important;
            font-size: 0.875rem !important;
        }
        
        .archive-container .filter-select {
            padding: 0.625rem 0.875rem !important;
            border: 1.5px solid rgba(62, 205, 193, 0.2) !important;
            border-radius: 10px !important;
            background: rgba(255, 255, 255, 0.6) !important;
            backdrop-filter: blur(20px) !important;
            min-width: 140px !important;
            font-size: 0.875rem !important;
        }
        
        .archive-container .archive-items {
            display: grid !important;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)) !important;
            gap: 1rem !important;
            margin-bottom: 1.5rem !important;
        }
        
        .archive-container .archive-item {
            background: rgba(255, 255, 255, 0.65) !important;
            backdrop-filter: blur(25px) !important;
            border: 1.5px solid rgba(62, 205, 193, 0.15) !important;
            border-radius: 14px !important;
            padding: 1.25rem !important;
            cursor: pointer !important;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03), 0 8px 16px rgba(0, 0, 0, 0.06) !important;
            display: flex !important;
            flex-direction: column !important;
            gap: 0.75rem !important;
        }
        
        .archive-container .archive-item:hover {
            transform: translateY(-4px) !important;
            border-color: rgba(62, 205, 193, 0.4) !important;
            background: rgba(255, 255, 255, 0.8) !important;
            box-shadow: 0 4px 12px rgba(62, 205, 193, 0.2) !important;
        }
        
        .archive-container .item-score-badge {
            position: absolute !important;
            top: 1rem !important;
            right: 1rem !important;
            padding: 0.375rem 0.75rem !important;
            border-radius: 20px !important;
            font-weight: 600 !important;
            font-size: 0.8rem !important;
            color: white !important;
            z-index: 2 !important;
        }
        
        .archive-container .item-score-badge.score-high {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
        }
        
        .archive-container .item-score-badge.score-medium {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
        }
        
        .archive-container .item-score-badge.score-low {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
        }
        
        .archive-container .item-header {
            padding-right: 3.5rem !important;
        }
        
        .archive-container .item-title {
            font-size: 1rem !important;
            font-weight: 600 !important;
            color: #1a202c !important;
            margin: 0 !important;
            line-height: 1.4 !important;
        }
        
        .archive-container .item-meta {
            display: flex !important;
            gap: 0.625rem !important;
            flex-wrap: wrap !important;
            padding-bottom: 0.75rem !important;
            border-bottom: 1px solid rgba(62, 205, 193, 0.1) !important;
        }
        
        .archive-container .meta-item {
            display: flex !important;
            align-items: center !important;
            gap: 0.375rem !important;
            background: rgba(62, 205, 193, 0.08) !important;
            padding: 0.375rem 0.625rem !important;
            border-radius: 8px !important;
            color: #64748b !important;
            font-size: 0.8rem !important;
        }
        
        .archive-container .meta-item i {
            color: #3ECDC1 !important;
            font-size: 0.875rem !important;
        }
        
        .archive-container .item-footer {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }
        
        .archive-container .item-category {
            font-size: 0.7rem !important;
            font-weight: 600 !important;
            color: #3ECDC1 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }
        
        .archive-container .item-arrow {
            color: #cbd5e1 !important;
            font-size: 1.125rem !important;
            transition: all 0.3s ease !important;
        }
        
        .archive-container .archive-item:hover .item-arrow {
            color: #3ECDC1 !important;
            transform: translateX(3px) !important;
        }
        
        .archive-container .archive-pagination {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            gap: 1rem !important;
            margin-top: 1.5rem !important;
        }
        
        .archive-container .page-btn {
            width: 36px !important;
            height: 36px !important;
            border: 1.5px solid rgba(62, 205, 193, 0.2) !important;
            border-radius: 8px !important;
            background: rgba(255, 255, 255, 0.6) !important;
            backdrop-filter: blur(20px) !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            font-size: 0.875rem !important;
        }
        
        .archive-container .page-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(62, 205, 193, 0.9) 0%, rgba(50, 163, 154, 0.9) 100%) !important;
            color: white !important;
            transform: translateY(-2px) !important;
        }
        
        .archive-container .page-info {
            font-size: 0.875rem !important;
            color: #64748b !important;
            font-weight: 500 !important;
        }
        
        .archive-container .archive-loading {
            padding: 3rem 0 !important;
            text-align: center !important;
        }
        
        .archive-container .archive-empty {
            padding: 3rem 0 !important;
            text-align: center !important;
            color: #94a3b8 !important;
        }
        
        @media (max-width: 768px) {
            .archive-container {
                padding: 1.25rem !important;
            }
            
            .archive-container .archive-categories {
                gap: 0.5rem !important;
            }
            
            .archive-container .category-btn {
                padding: 0.625rem 1rem !important;
                font-size: 0.85rem !important;
            }
            
            .archive-container .category-icon {
                font-size: 1.125rem !important;
            }
            
            .archive-container .archive-filters {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            .archive-container .archive-items {
                grid-template-columns: 1fr !important;
                gap: 0.75rem !important;
            }
            
            .archive-container .archive-item {
                padding: 1rem !important;
            }
        }
    </style>
    <script>
      // Remove residual Debug Info blocks at runtime (safety net)
      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.debug-section').forEach(function(el){ el.remove(); });
      });
    </script>
</head>
<body>
    <!-- Морфирующие формы -->
    <div class="morphing-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>

    <!-- Header (идентичная оригинальной) -->
    <header class="modern-header">
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <!-- Logo -->
                <a class="navbar-brand" href="/en/">
                    <div class="logo-container">
                        <img class="logo logo-light" src="/static/images/logo.png" alt="Mentora" height="40" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="logo-text" style="display:none; font-size: 1.5rem; font-weight: 800; color: #1e293b;">MENTORA</div>
                    </div>
                </a>
                
                <!-- Mobile Toggle -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
                
                <!-- Navigation -->
                <div class="collapse navbar-collapse" id="navbarMain">
                    <ul class="navbar-nav me-auto">
                        <!-- Home -->
                        <li class="nav-item">
                            <a class="nav-link" href="/{{ lang }}/">{{ t('home', lang)|default('Home') }}</a>
                        </li>
                        
                        <!-- Learning Map -->
                        <li class="nav-item">
                            <a class="nav-link active" href="/{{ lang }}/learning-map">{{ t('learning_map', lang)|default('Learning Map') }}</a>
                        </li>
                        
                        <!-- Knowledge Base скрыта от пользователей -->
                        <!-- <li class="nav-item">
                            <a class="nav-link" :class="{'tour-highlight': tourActive && tourStep === 5}" href="/{{ lang }}/knowledge-base">{{ t('knowledge_base', lang)|default('Knowledge Base') }}</a>
                        </li> -->
                        
                        <!-- Community -->
                        <li class="nav-item">
                            <a class="nav-link" :class="{'tour-highlight': tourActive && tourStep === 5}" href="/{{ lang }}/community">{{ t('community', lang)|default('Community') }}</a>
                        </li>
                        
                        <!-- About BIG -->
                        <li class="nav-item">
                            <a class="nav-link" href="/{{ lang }}/big-info">{{ t('about_big', lang)|default('About BIG') }}</a>
                        </li>
                    </ul>
                    
                    <!-- Right Side Actions -->
                    <div class="navbar-actions d-flex align-items-center">
                        <!-- Language Dropdown -->
                        <div class="dropdown me-3 language-dropdown" style="position: relative; z-index: 9999;">
                            <button class="btn language-btn-modern" 
                                    :class="{'tour-highlight': tourActive && tourStep === 6}"
                                    type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false"
                                    title="{{ t('language', lang)|default('Language') }}: {{ lang|upper }}">
                                <span class="language-icon"><i class="bi bi-globe2"></i></span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end language-menu" aria-labelledby="languageDropdown">
                                {% from "includes/_macros.html" import language_url %}
                                <li><a class="dropdown-item {% if lang == 'nl' %}active{% endif %}" href="{{ language_url('nl') }}"><span class="fi fi-nl me-2"></span> Nederlands{% if lang == 'nl' %} <i class="bi bi-check-lg ms-1"></i>{% endif %}</a></li>
                                <li><a class="dropdown-item {% if lang == 'en' %}active{% endif %}" href="{{ language_url('en') }}"><span class="fi fi-gb me-2"></span> English{% if lang == 'en' %} <i class="bi bi-check-lg ms-1"></i>{% endif %}</a></li>
                                <li><a class="dropdown-item {% if lang == 'es' %}active{% endif %}" href="{{ language_url('es') }}"><span class="fi fi-es me-2"></span> Español{% if lang == 'es' %} <i class="bi bi-check-lg ms-1"></i>{% endif %}</a></li>
                                <li><a class="dropdown-item {% if lang == 'pt' %}active{% endif %}" href="{{ language_url('pt') }}"><span class="fi fi-pt me-2"></span> Português{% if lang == 'pt' %} <i class="bi bi-check-lg ms-1"></i>{% endif %}</a></li>
                                <li><a class="dropdown-item {% if lang == 'uk' %}active{% endif %}" href="{{ language_url('uk') }}"><span class="fi fi-ua me-2"></span> Українська{% if lang == 'uk' %} <i class="bi bi-check-lg ms-1"></i>{% endif %}</a></li>
                                <li><a class="dropdown-item {% if lang == 'fa' %}active{% endif %}" href="{{ language_url('fa') }}"><span class="fi fi-ir me-2"></span> فارسی{% if lang == 'fa' %} <i class="bi bi-check-lg ms-1"></i>{% endif %}</a></li>
                                <li><a class="dropdown-item {% if lang == 'ar' %}active{% endif %}" href="{{ language_url('ar') }}"><span class="fi fi-sa me-2"></span> العربية{% if lang == 'ar' %} <i class="bi bi-check-lg ms-1"></i>{% endif %}</a></li>
                                <li><a class="dropdown-item {% if lang == 'tr' %}active{% endif %}" href="{{ language_url('tr') }}"><span class="fi fi-tr me-2"></span> Türkçe{% if lang == 'tr' %} <i class="bi bi-check-lg ms-1"></i>{% endif %}</a></li>
                                <li><a class="dropdown-item {% if lang == 'ru' %}active{% endif %}" href="{{ language_url('ru') }}"><span class="fi fi-ru me-2"></span> Русский{% if lang == 'ru' %} <i class="bi bi-check-lg ms-1"></i>{% endif %}</a></li>
                            </ul>
                        </div>
                        
                        <!-- User Menu -->
                        <div class="dropdown" style="position: relative; z-index: 1002;">
                            <button class="btn user-btn-modern" 
                                    type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false"
                                    title="User Menu">
                                <span class="user-icon"><i class="bi bi-person-circle"></i></span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end user-dropdown" aria-labelledby="userDropdown">
                                <!-- User Info Header -->
                                <li class="dropdown-header">
                                    <i class="bi bi-person-badge fs-5 me-1"></i> <strong>{{ current_user.get_display_name() if current_user.is_authenticated else 'Dr. John Doe' }}</strong>
                                    <br>
                                    <small class="text-muted">
                                        {% if current_user.is_authenticated and current_user.profession == 'tandarts' %}
                                            {{ t('dentist', lang)|default('Dentist') }}
                                        {% elif current_user.is_authenticated and current_user.profession == 'huisarts' %}
                                            {{ t('general_practitioner', lang)|default('General Practitioner') }}
                                        {% else %}
                                            {{ t('medical_professional', lang)|default('Medical Professional') }}
                                        {% endif %}
                                    </small>
                                </li>
                                
                                <li><hr class="dropdown-divider"></li>
                                
                                <!-- Profile -->
                                <li><a class="dropdown-item" href="/en/profile">
                                    <i class="bi bi-person-gear fs-5 me-2"></i>
                                    Edit profile
                                </a></li>
                                
                                <li><hr class="dropdown-divider"></li>
                                
                                <!-- Logout -->
                                <li><a class="dropdown-item text-danger" href="/auth/en/logout">
                                    <i class="bi bi-box-arrow-right fs-5 me-2"></i>
                                    Logout
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main -->
    <div x-data="learningMapApp()" x-init="init()" :class="{'tour-active': tourActive}" class="learning-map-container">
        <button type="button" class="tour-start-button" x-show="!showTourOverlay && !tourActive" @click="restartTour()" x-transition.opacity title="{{ t('tour_start_button', lang)|default('Start guided tour') }}" aria-label="{{ t('tour_start_button', lang)|default('Start guided tour') }}">
            ?
        </button>
        
        <div class="tour-intro-overlay" x-show="showTourOverlay" x-transition.opacity x-cloak>
            <div class="tour-intro-card">
                <img src="/static/images/logo.png" alt="Mentora" class="tour-intro-logo" loading="lazy">
                <h2>{{ t('tour_intro_title', lang)|default('Welcome to your Learning Map') }}</h2>
                <p>{{ t('tour_intro_body', lang)|default('Let us guide you through the main sections so you always know where to start.') }}</p>
                <div class="tour-dont-show-checkbox">
                    <label>
                        <input type="checkbox" x-model="dontShowTourAgain">
                        <span>{{ t('tour_dont_show_again', lang)|default("Don't show this again") }}</span>
                    </label>
                </div>
                <div class="tour-intro-actions">
                    <button class="primary" @click="startTour(true)">{{ t('tour_start_button', lang)|default('Start guided tour') }}</button>
                    <button class="secondary" @click="skipTour()">{{ t('tour_skip_button', lang)|default('Skip for now') }}</button>
                </div>
            </div>
        </div>
        
        <div class="tour-scrim" x-show="tourActive" :class="{'active': tourActive}" x-transition.opacity x-cloak></div>
        
        <div class="tour-tooltip" x-show="tourActive && tourStep > 0" :class="'tour-tooltip-step-' + tourStep" x-transition.opacity x-cloak>
            <template x-if="tourStep === 1">
                <div>
                    <h5>{{ t('tour_step1_title', lang)|default('Navigation') }}</h5>
                    <p>{{ t('tour_step1_body', lang)|default("This is your main learning panel. Each icon opens a dedicated section. You're currently in Individual Learning.") }}</p>
                </div>
            </template>
            <template x-if="tourStep === 2">
                <div>
                    <h5>{{ t('tour_step2_title', lang)|default('Today\'s tasks') }}</h5>
                    <p>{{ t('tour_step2_body', lang)|default('Here you see your daily assignments. New items appear on schedule and the timer shows when they refresh.') }}</p>
                </div>
            </template>
            <template x-if="tourStep === 3">
                <div>
                    <h5>{{ t('tour_step3_title', lang)|default('Context help') }}</h5>
                    <p>{{ t('tour_step3_body', lang)|default('Use the tips on the right to understand how each section works and how to get the best results.') }}</p>
                </div>
            </template>
            <template x-if="tourStep === 4">
                <div>
                    <h5>{{ t('tour_step4_title', lang)|default('Track your progress') }}</h5>
                    <p>{{ t('tour_step4_body', lang)|default('Switch to the Progress tab anytime to see your achievements and learning statistics.') }}</p>
                </div>
            </template>
            <template x-if="tourStep === 5">
                <div>
                    <h5>{{ t('tour_step5_title', lang)|default('Explore resources') }}</h5>
                    <p>{{ t('tour_step5_body', lang)|default('Knowledge Base offers structured materials, and Community connects you with peers for discussion.') }}</p>
                </div>
            </template>
            <template x-if="tourStep === 6">
                <div>
                    <h5>{{ t('tour_step6_title', lang)|default('Choose your language') }}</h5>
                    <p>{{ t('tour_step6_body', lang)|default('Use the language menu to switch the interface instantly. The system remembers your choice.') }}</p>
                </div>
            </template>
            
            <div class="tour-controls">
                <button class="secondary-btn" x-show="tourStep > 1" @click="prevTourStep()">{{ t('tour_prev_button', lang)|default('Back') }}</button>
                <button class="secondary-btn" x-show="tourStep === 1" @click="skipTour()">{{ t('tour_skip_button', lang)|default('Skip') }}</button>
                <template x-if="tourStep < 6">
                    <button class="primary-btn" @click="nextTourStep()">{{ t('tour_next_button', lang)|default('Next') }}</button>
                </template>
                <template x-if="tourStep === 6">
                    <button class="finish-btn" @click="endTour()">{{ t('tour_finish_button', lang)|default('Finish') }}</button>
                </template>
            </div>
        </div>
        
        <div class="main-layout">
            
            <!-- ЛЕВАЯ КОЛОНКА: УЗЛЫ + КАРТОЧКИ -->
            <div class="left-column">
                
                <!-- Узлы на блоке -->
                <div class="learning-tabs" :class="{'tour-highlight': tourActive && tourStep === 1}">
                    <div class="tabs-container">
                        <!-- Individual Tab - Always Enabled (FIRST) -->
                        <div class="tab-circle" :class="{ 'active': activeTab === 'individual' }" @click="selectTab('individual')">
                            <div class="circle-button">
                                <div class="circle-glow"></div>
                                <div class="circle-inner"><i class="bi bi-person-fill"></i></div>
                                <div class="tab-status-badge" style="background: #22c55e;"><i class="bi bi-check-circle-fill"></i></div>
                            </div>
                            <div class="tab-label">
                                {{ t('individual_plan', lang)|default('Individual') }}
                                <span class="beta-badge">{{ t('beta', lang)|default('BETA') }}</span>
                            </div>
                        </div>

                        <!-- IRT Tab - Always Enabled -->
                        <div class="tab-circle" :class="{ 'active': activeTab === 'irt' }" @click="selectTab('irt')">
                            <div class="circle-button">
                                <div class="circle-glow"></div>
                                <div class="circle-inner"><i class="bi bi-cpu-fill"></i></div>
                                <div class="tab-status-badge" style="background: #22c55e;"><i class="bi bi-check-circle-fill"></i></div>
                            </div>
                            <div class="tab-label">
                                {{ t('irt', lang)|default('IRT') }}
                                <span class="beta-badge">{{ t('beta', lang)|default('BETA') }}</span>
                            </div>
                        </div>

                        <!-- Premium Tab - только для премиум пользователей -->
                        <div class="tab-circle" 
                             x-show="enabledTabs.includes('premium')"
                             :class="{ 'active': activeTab === 'premium' }" 
                             @click="selectTab('premium')">
                            <div class="circle-button">
                                <div class="circle-glow"></div>
                                <div class="circle-inner"><i class="bi bi-star-fill"></i></div>
                                <div class="tab-status-badge" style="background: #f59e0b;"><i class="bi bi-star-fill"></i></div>
                            </div>
                            <div class="tab-label">{{ t('premium', lang)|default('Premium') }}</div>
                        </div>

                        <!-- Games Tab - Always Enabled -->
                        <div class="tab-circle" :class="{ 'active': activeTab === 'games' }" @click="selectTab('games')">
                            <div class="circle-button">
                                <div class="circle-glow"></div>
                                <div class="circle-inner"><i class="bi bi-controller"></i></div>
                                <div class="tab-status-badge" style="background: #22c55e;"><i class="bi bi-check-circle-fill"></i></div>
                            </div>
                            <div class="tab-label">{{ t('games', lang)|default('Games') }}</div>
                        </div>

                        <!-- Progress Tab - Always Enabled -->
                        <div class="tab-circle" :class="{ 'active': activeTab === 'progress', 'tour-highlight': tourActive && tourStep === 4 }" @click="selectTab('progress')">
                            <div class="circle-button">
                                <div class="circle-glow"></div>
                                <div class="circle-inner"><i class="bi bi-graph-up"></i></div>
                            </div>
                            <div class="tab-label">{{ t('progress', lang)|default('Progress') }}</div>
                        </div>

                        <!-- Planner Tab - Always Enabled -->
                        <div class="tab-circle" :class="{ 'active': activeTab === 'planner' }" @click="selectTab('planner')">
                            <div class="circle-button">
                                <div class="circle-glow"></div>
                                <div class="circle-inner"><i class="bi bi-calendar-check-fill"></i></div>
                            </div>
                            <div class="tab-label">{{ t('planner', lang)|default('Planner') }}</div>
                        </div>

                        <!-- Archive Tab - Always Enabled -->
                        <div class="tab-circle" :class="{ 'active': activeTab === 'archive' }" @click="selectTab('archive')">
                            <div class="circle-button">
                                <div class="circle-glow"></div>
                                <div class="circle-inner"><i class="bi bi-archive-fill"></i></div>
                            </div>
                            <div class="tab-label">{{ t('archive', lang)|default('Archive') }}</div>
                        </div>
                    </div>
                </div>
                
                <!-- ARCHIVE TAB CONTENT - в левой колонке -->
                <div x-show="activeTab === 'archive'" 
                     x-data="archiveComponent()"
                     @load="init()"
                     class="archive-container">
                    
                    <!-- Category Tabs - Красивые карточки -->
                    <div class="archive-categories">
                        <button @click="activeCategory = 'english'; pagination = null; loadItems()" 
                                :class="{ 'active': activeCategory === 'english' }"
                                class="category-btn">
                            <div class="category-icon">
                                <i class="bi bi-book-fill"></i>
                            </div>
                            <div class="category-text">
                                <div class="category-title">{{ t('english_passages', lang)|default('English Passages') }}</div>
                                <div class="category-count" x-text="(stats?.english?.total || 0) + ' items'"></div>
                            </div>
                        </button>
                        <button @click="activeCategory = 'terms'; pagination = null; loadItems()" 
                                :class="{ 'active': activeCategory === 'terms' }"
                                class="category-btn">
                            <div class="category-icon">
                                <i class="bi bi-card-list"></i>
                            </div>
                            <div class="category-text">
                                <div class="category-title">{{ t('dutch_terms', lang)|default('Dutch Terms') }}</div>
                                <div class="category-count" x-text="(stats?.terms?.total || 0) + ' items'"></div>
                            </div>
                        </button>
                        <button @click="activeCategory = 'tests'; pagination = null; loadItems()" 
                                :class="{ 'active': activeCategory === 'tests' }"
                                class="category-btn">
                            <div class="category-icon">
                                <i class="bi bi-clipboard-check"></i>
                            </div>
                            <div class="category-text">
                                <div class="category-title">{{ t('medical_tests', lang)|default('Medical Tests') }}</div>
                                <div class="category-count" x-text="(stats?.tests?.total || 0) + ' items'"></div>
                            </div>
                        </button>
                        <button @click="activeCategory = 'virtual-patients'; pagination = null; loadItems()" 
                                :class="{ 'active': activeCategory === 'virtual-patients' }"
                                class="category-btn">
                            <div class="category-icon">
                                <i class="bi bi-person-check"></i>
                            </div>
                            <div class="category-text">
                                <div class="category-title">{{ t('virtual_patients', lang)|default('Virtual Patients') }}</div>
                                <div class="category-count" x-text="(stats?.virtual_patients?.total || 0) + ' items'"></div>
                            </div>
                        </button>
                    </div>

                    <!-- Filters - Поиск и сортировка -->
                    <div class="archive-filters">
                        <div class="filter-search-wrapper">
                            <i class="bi bi-search"></i>
                            <input type="text" 
                                   x-model="searchQuery" 
                                   @input.debounce.300ms="loadItems()"
                                   placeholder="{{ t('search_placeholder', lang)|default('Search items...') }}"
                                   class="filter-search">
                        </div>
                        
                        <select x-model="sortBy" @change="loadItems()" class="filter-select">
                            <option value="date">{{ t('sort_by_date', lang)|default('Sort by Date') }}</option>
                            <option value="score">{{ t('sort_by_score', lang)|default('Sort by Score') }}</option>
                            <option value="time">{{ t('sort_by_time', lang)|default('Sort by Time') }}</option>
                        </select>
                        
                        <select x-model="sortOrder" @change="loadItems()" class="filter-select">
                            <option value="desc">{{ t('descending', lang)|default('Descending') }}</option>
                            <option value="asc">{{ t('ascending', lang)|default('Ascending') }}</option>
                        </select>
                    </div>

                    <!-- Items Grid - Красивые карточки элементов -->
                    <div class="archive-items" x-show="!loading && items.length > 0">
                        <template x-for="item in items" :key="item.id">
                            <div class="archive-item" @click="viewItem(item)">
                                <!-- Score Badge -->
                                <div class="item-score-badge" 
                                     :class="getScoreClass(item.score_percentage || item.score || item.accuracy || 0)">
                                    <span x-text="formatScore(item)"></span>
                                </div>
                                <!-- Item Header -->
                                <div class="item-header">
                                    <h4 class="item-title" x-text="item.title || item.term_nl || item.session_type_label || 'Unknown'"></h4>
                                </div>
                                <!-- Item Meta Info -->
                                <div class="item-meta">
                                    <!-- Date -->
                                    <div class="meta-item" x-show="item.completed_at || item.last_reviewed || item.started_at">
                                        <i class="bi bi-calendar3"></i>
                                        <span x-text="formatDate(item.completed_at || item.last_reviewed || item.started_at)"></span>
                                    </div>
                                    <!-- Time -->
                                    <div class="meta-item" x-show="item.time_spent">
                                        <i class="bi bi-clock"></i>
                                        <span x-text="formatTime(item.time_spent)"></span>
                                    </div>
                                    <!-- Questions -->
                                    <div class="meta-item" x-show="item.total_questions || item.questions_answered">
                                        <i class="bi bi-question-circle"></i>
                                        <span x-text="(item.total_questions || item.questions_answered) + ' Q'"></span>
                                    </div>
                                </div>
                                <!-- Item Footer - Description -->
                                <div class="item-footer">
                                    <div class="item-category" x-text="getCategoryLabel()"></div>
                                    <div class="item-arrow">
                                        <i class="bi bi-chevron-right"></i>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Pagination -->
                    <div class="archive-pagination" x-show="pagination && pagination.pages > 1">
                        <button @click="changePage((pagination?.page || 1) - 1)" 
                                :disabled="!pagination || pagination.page <= 1"
                                class="page-btn prev-btn"
                                title="{{ t('previous', lang)|default('Previous') }}">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        
                        <div class="page-info">
                            <span x-text="pagination?.page || 1"></span>
                            <span class="page-separator">/</span>
                            <span x-text="pagination?.pages || 1"></span>
                        </div>
                        
                        <button @click="changePage((pagination?.page || 1) + 1)" 
                                :disabled="!pagination || pagination.page >= pagination.pages"
                                class="page-btn next-btn"
                                title="{{ t('next', lang)|default('Next') }}">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>

                    <!-- Loading State -->
                    <div class="archive-loading" x-show="loading">
                        <div class="spinner"></div>
                        <p>{{ t('loading', lang)|default('Loading...') }}</p>
                    </div>

                    <!-- Empty State -->
                    <div class="archive-empty" x-show="!loading && items.length === 0">
                        <i class="bi bi-inbox"></i>
                        <h3>{{ t('no_items', lang)|default('No items found') }}</h3>
                        <p>{{ t('no_items_description', lang)|default('Try changing your filters or search terms') }}</p>
                    </div>
                </div>

                <!-- Карточки -->
                <div class="cards-area" x-show="activeTab !== 'individual' && activeTab !== 'planner' && activeTab !== 'archive'">
                    
                    <!-- IRT Test Cards -->
                    <div class="info-card test-card" x-show="activeTab === 'irt'" @click="startIRTTest(30)" style="cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <div class="card-header" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                            <div class="card-icon" style="background: rgba(255,255,255,0.2);"><i class="bi bi-lightning-charge-fill"></i></div>
                            <div>
                                <div class="card-title" style="color: white;">{{ t('quick_test', lang)|default('Quick Test') }}</div>
                                <div class="card-subtitle" style="color: rgba(255,255,255,0.9);">30 {{ t('questions', lang)|default('questions') }}</div>
                            </div>
                        </div>
                        <div style="padding: 1rem 0;">
                            <p style="margin: 0; font-size: 0.9rem; color: rgba(255,255,255,0.95);">
                                {{ t('quick_test_description', lang)|default('Fast knowledge check. Results shown at the end.') }}
                            </p>
                        </div>
                        <div class="play-badge" style="background: rgba(255,255,255,0.3);">
                            <i class="bi bi-play-circle-fill"></i>
                        </div>
                    </div>

                    <div class="info-card test-card" x-show="activeTab === 'irt'" @click="startIRTTest(60)" style="cursor: pointer; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                        <div class="card-header" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                            <div class="card-icon" style="background: rgba(255,255,255,0.2);"><i class="bi bi-speedometer2"></i></div>
                            <div>
                                <div class="card-title" style="color: white;">{{ t('full_test', lang)|default('Full Test') }}</div>
                                <div class="card-subtitle" style="color: rgba(255,255,255,0.9);">60 questions</div>
                            </div>
                        </div>
                        <div style="padding: 1rem 0;">
                            <p style="margin: 0; font-size: 0.9rem; color: rgba(255,255,255,0.95);">
                                Comprehensive assessment covering all domains.
                            </p>
                        </div>
                        <div class="play-badge" style="background: rgba(255,255,255,0.3);">
                            <i class="bi bi-play-circle-fill"></i>
                        </div>
                    </div>

                    <div class="info-card test-card" x-show="activeTab === 'irt'" @click="startLearningMode()" style="cursor: pointer; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                        <div class="card-header" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                            <div class="card-icon" style="background: rgba(255,255,255,0.2);"><i class="bi bi-book-fill"></i></div>
                            <div>
                                <div class="card-title" style="color: white;">{{ t('learning_mode', lang)|default('Learning Mode') }}</div>
                                <div class="card-subtitle" style="color: rgba(255,255,255,0.9);">30 questions with explanations</div>
                            </div>
                        </div>
                        <div style="padding: 1rem 0;">
                            <p style="margin: 0; font-size: 0.9rem; color: rgba(255,255,255,0.95);">
                                Study mode: see correct answer and explanation after each question.
                            </p>
                        </div>
                        <div class="play-badge" style="background: rgba(255,255,255,0.3);">
                            <i class="bi bi-play-circle-fill"></i>
                        </div>
                    </div>

                    <!-- Games Cards (for games tab) -->
                    <template x-for="module in displayModules" :key="module.id" x-show="activeTab === 'games'">
                        <div class="info-card" 
                             :class="{ 'clickable-card': module.url }" 
                             @click="module.url ? window.location.href = module.url : null"
                             :style="module.url ? 'cursor: pointer;' : ''"
                             data-games="true">
                            <div class="card-header">
                                <div class="card-icon module"><i :class="`bi bi-${module.icon}`"></i></div>
                                <div>
                                    <div class="card-title" x-text="module.title"></div>
                                    <div class="card-subtitle" x-text="module.subtitle"></div>
                                </div>
                            </div>
                            <div x-show="module.url" class="play-badge">
                                <i class="bi bi-play-circle-fill"></i>
                            </div>
                        </div>
                    </template>

                </div>
                
                <!-- Баннер для игр (под играми) -->
                <div x-show="activeTab === 'games'" class="games-banner" @click="window.location.href = '/games/dentist-dash'" style="
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
                    border-radius: 20px;
                    padding: 1.5rem;
                    margin-top: 2rem;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    position: relative;
                    overflow: hidden;
                    min-height: 120px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">
                    <!-- Твое изображение -->
                    <img src="/static/images/superment.png" 
                         alt="Super Mentora Banner" 
                         style="
                            width: 100%;
                            max-width: 600px;
                            height: auto;
                            border-radius: 12px;
                            cursor: pointer;
                            transition: transform 0.3s ease;
                         "
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                         onmouseover="this.style.transform='scale(1.02)'"
                         onmouseout="this.style.transform='scale(1)'">
                    
                    <!-- Fallback если изображение не найдено -->
                    <div style="display: none; width: 100%; max-width: 600px; height: 100px; background: linear-gradient(45deg, #0a0a0a 0%, #1a0a0a 50%, #2a0a00 100%); border: 2px solid #444; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-family: 'Courier New', monospace; color: #fff; text-align: center; padding: 1rem;">
                        <div>
                            <div style="font-size: 14px; font-weight: bold; margin-bottom: 0.5rem;">
                                <span style="color: #ff0000; font-style: italic;">SUPER</span>
                                <span style="margin: 0 8px; color: #fff;">MENTORA</span>
                            </div>
                            <div style="font-size: 10px; line-height: 1.2;">
                                Epic 8-bit platformer with Mario & Contra gameplay!<br>
                                Jump, dash, shoot, explore caves with lava & bats!<br>
                                Features RAMBO character in jungle mode! 💪
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PLANNER TAB CONTENT - CALENDAR -->
                <div x-show="activeTab === 'planner'" 
                     class="planner-calendar-container" 
                     x-data="plannerCalendar()"
                     @planner-day-selected.window="plannerSelectedDayPlan = $event.detail"
                     :data-tab="activeTab === 'planner' ? 'planner' : ''">
                    <h2 style="margin-bottom: 1rem; color: #1a202c; font-size: 1.5rem;">
                        <i class="bi bi-calendar-check-fill" style="color: var(--primary-color); margin-right: 0.5rem;"></i>
                        {{ t('learning_planner', lang)|default('Learning Planner') }}
                    </h2>
                    
                    <p style="color: #666; margin-bottom: 1.5rem;">
                        {{ t('planner_description', lang)|default('Plan your learning schedule for the next 28 study days. Complete BIG test on day 14 to unlock days 15-28.') }}
                    </p>
                    
                    <!-- Cycle Info Badge - Compact -->
                    <div x-show="currentCycleInfo" style="margin-bottom: 1rem; padding: 0.5rem 0.75rem; background: #f3f4f6; border-left: 3px solid #10b981; border-radius: 4px; font-size: 0.875rem; color: #4b5563;">
                        <span style="font-weight: 500;">{{ t('current_cycle', lang)|default('Cycle') }}</span>
                        <span style="font-weight: 600; color: #1a202c;" x-text="currentCycleInfo?.cycle || 1"></span>
                        <span style="margin: 0 0.5rem; color: #9ca3af;">•</span>
                        <span x-text="(currentCycleInfo?.day_in_cycle || 1) + ' / 28'"></span>
                        <span style="margin: 0 0.5rem; color: #9ca3af;">•</span>
                        <span>{{ t('difficulty', lang)|default('Difficulty') }}: <span style="font-weight: 600;" x-text="'x' + (currentCycleInfo?.config?.multiplier || 1).toFixed(1)"></span></span>
                    </div>
                    
                    <!-- Calendar Grid - 28 days in compact table format (4 rows x 7 columns) -->
                    <div class="planner-calendar-wrapper" x-show="!loading && !error">
                        <div class="planner-calendar" x-show="studyDays && studyDays.length > 0">
                            <template x-for="day in studyDays" :key="day.study_day">
                                <div 
                                    class="calendar-day"
                                    :class="{
                                        'today': day.is_today,
                                        'selected': selectedDay === day.study_day,
                                        'big-test': day.is_big_test_day,
                                        'locked': day.is_locked
                                    }"
                                    @click="!day.is_locked && selectDay(day.study_day)"
                                >
                                    <div class="day-number" x-text="day.study_day"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div x-show="loading" style="text-align: center; padding: 2rem; color: #666;">
                        <i class="bi bi-arrow-repeat" style="animation: spin 1s linear infinite; font-size: 2rem;"></i>
                        <p>{{ t('loading', lang)|default('Loading...') }}</p>
                    </div>
                    
                    <!-- Error State -->
                    <div x-show="error" style="padding: 1rem; background: #fee2e2; border-radius: 8px; color: #dc2626; margin-top: 1rem;">
                        <i class="bi bi-exclamation-triangle"></i>
                        <span x-text="error"></span>
                    </div>
                </div>

                <!-- INDIVIDUAL PLAN TAB CONTENT - SIMPLIFIED DAILY FLOW -->
                <div x-show="activeTab === 'individual'" class="individual-plan-container">
                    
                    <!-- TODAY'S PLAN CARD -->
                    <div class="daily-plan-card" :class="{'tour-highlight': tourActive && tourStep === 2}">
                    <div class="plan-header">
                            <div class="plan-header-left">
                                <h2>Vandaag te doen</h2>
                                <!-- Countdown Timer -->
                                <div class="countdown-timer" 
                                     :class="{ 'countdown-warning': timeUntilMidnight.hours < 2, 'countdown-urgent': timeUntilMidnight.hours < 1 }">
                                    <i class="bi bi-clock"></i>
                                    <span class="countdown-label">{{ t('time_left', lang) | default('Tot reset') }}:</span>
                                    <span class="countdown-time" x-text="formatCountdown()"></span>
                                </div>
                            </div>
                            <span class="plan-status" :class="'status-' + getTodayStatus()">
                                <span x-text="getTodayCompletionPercentage() + '%'"></span> voltooid
                            </span>
                    </div>

                        <!-- PLAN ITEMS WITH PROGRESS - Dynamic from planner -->
                        <div class="plan-items" x-show="dailyTasksData && dailyTasksData.tasks">
                            <template x-for="(task, index) in (dailyTasksData?.tasks || [])" :key="task.type">
                                <div>
                                    <div class="plan-item" 
                                         :class="{ 
                                             'completed': getTaskCompleted(task.type), 
                                             'in-progress': getTaskInProgress(task.type)
                                         }">
                                <div class="item-left">
                                            <div class="item-number" x-text="index + 1"></div>
                                    <div class="item-info">
                                                <h3 class="item-title" x-text="task.title"></h3>
                                                <p class="item-description" x-text="getTaskDescription(task)"></p>
                                </div>
                            </div>
                                <div class="item-right">
                                            <span class="item-progress" x-show="!getTaskCompleted(task.type) && getTaskProgress(task.type) > 0">
                                                <span x-text="getTaskProgressText(task)"></span>
                                    </span>
                                            <span class="item-status-badge" x-show="getTaskCompleted(task.type)">
                                        <i class="bi bi-check-circle-fill"></i> Klaar
                                    </span>
                                            <span class="item-status-badge in-progress" x-show="getTaskInProgress(task.type)">
                                        <i class="bi bi-play-circle"></i> Bezig
                                    </span>
                                </div>
                            </div>
                            
                            <!-- PROGRESS BAR BETWEEN ITEMS -->
                                    <div class="connector" 
                                         x-show="dailyTasksData && dailyTasksData.tasks && index < dailyTasksData.tasks.length - 1"
                                         :class="{ 'active': getTaskCompleted(task.type) }">
                            </div>
                        </div>
                            </template>
                        </div>
                        
                        <!-- Loading state -->
                        <div x-show="!dailyTasksData" class="plan-items" style="text-align: center; padding: 2rem;">
                            <i class="bi bi-arrow-repeat" style="animation: spin 1s linear infinite; font-size: 2rem; color: #666;"></i>
                            <p style="color: #666; margin-top: 1rem;">{{ t('loading', lang)|default('Loading tasks...') }}</p>
                    </div>

                        <!-- DAILY TASKS CONTAINER (for rotation logic) -->
                        <div id="dailyTasksContainer" class="daily-tasks-rotation-container" style="display: none;">
                            <!-- Will be populated by loadDailyTasks() -->
                        </div>

                        <!-- ACTION BUTTONS - Dynamic from planner -->
                        <div class="plan-actions" x-show="dailyTasksData && dailyTasksData.tasks">
                            <template x-for="(task, index) in (dailyTasksData?.tasks || [])" :key="task.type">
                                <div class="action-group" 
                                     x-show="dailyTasksData && dailyTasksData.tasks && !getTaskCompleted(task.type) && (index === 0 || getTaskCompleted(dailyTasksData.tasks[index - 1].type))">
                                <button 
                                    class="btn-primary btn-large"
                                        @click="startTask(task.type)"
                                        x-text="getTaskInProgress(task.type) ? 'Doorgaan →' : 'Start →'"
                                >
                                </button>
                                    </div>
                            </template>

                            <!-- REPEAT OPTIONS (All completed) -->
                            <div class="action-group completion-group" 
                                 x-show="areAllTasksCompleted()">
                                <h3 class="completion-title">
                                    <i class="bi bi-star-fill"></i> Goed gedaan! Wil je herhalen?
                                </h3>
                                <div class="repeat-buttons">
                                    <template x-for="task in (dailyTasksData?.tasks || [])" :key="task.type">
                                    <button 
                                        class="btn-outline"
                                            @click="startTask(task.type)"
                                    >
                                            <i class="bi bi-arrow-clockwise"></i> <span x-text="task.title + ' herhalen'"></span>
                                    </button>
                                    </template>
                            </div>
                            </div>
                        </div>
                        
                <!-- DAILY STATS -->
                <div class="daily-stats">
                    <div class="stat-box">
                        <span class="stat-label">Punten vandaag</span>
                        <span class="stat-value" x-text="todayScore">0</span>
                            </div>
                    <div class="stat-box">
                        <span class="stat-label">Studietijd</span>
                        <span class="stat-value" x-text="studyTimeToday">0 min</span>
                        </div>
                    <div class="stat-box">
                        <span class="stat-label">Voortgang</span>
                        <span class="stat-value" x-text="getTodayCompletionPercentage() + '%'">0%</span>
                    </div>
                            </div>
                            
                <!-- DEBUG BUTTON (временно для тестирования) -->
                <div class="debug-section" style="margin-top: 20px; padding: 16px; background: #f0f0f0; border-radius: 8px;">
                    <h4 style="margin: 0 0 12px 0; color: #666;">Debug Info</h4>
                    <button 
                        class="btn btn-sm btn-outline" 
                        @click="loadTodayProgress()"
                        style="margin-right: 8px;"
                    >
                        🔄 Обновить прогресс
                                </button>
                    <button 
                        class="btn btn-sm btn-outline" 
                        @click="console.log('Tests:', {completed: testsCompleted, inProgress: testsInProgress, progress: testsProgress})"
                    >
                        📊 Логи тестов
                                </button>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        <div>Tests: <span x-text="testsCompleted ? '✅' : '❌'"></span> | Progress: <span x-text="testsProgress + '%'"></span></div>
                        <div>Terms: <span x-text="termsCompleted ? '✅' : '❌'"></span> | Progress: <span x-text="termsProgress + '%'"></span></div>
                        <div>VP: <span x-text="vpCompleted ? '✅' : '❌'"></span> | Progress: <span x-text="vpInProgress ? '🔄' : '⏸️'"></span></div>
                            </div>
                        </div>
                    </div>

                        </div>
                <!-- END SIMPLIFIED DAILY FLOW -->

                <!-- ============================================ -->
                <!-- PREMIUM TAB CONTENT -->
                <!-- ============================================ -->
                <div x-show="activeTab === 'premium'" class="premium-access-container">
                    <!-- Header -->
                    <div class="premium-header">
                        <h2><i class="bi bi-star-fill"></i> {{ t('premium_access', lang)|default('Premium Access') }}</h2>
                        <p class="subtitle">{{ t('unlimited_access_description', lang)|default('Unlimited access to all learning sections') }}</p>
                    </div>
                    
                    <!-- Compact Metric Blocks (4 blocks) -->
                    <div class="premium-metrics-grid">
                        <!-- Tests Block -->
                        <div class="metric-card primary" @click="startPremiumTest('quick')" style="cursor: pointer;">
                            <div class="metric-icon">
                                <i class="bi bi-pencil-square"></i>
                            </div>
                            <div class="metric-info">
                                <div class="metric-value">{{ t('practice_tests', lang)|default('Tests') }}</div>
                                <div class="metric-label">{{ t('unlimited_test_access', lang)|default('Unlimited access to all questions') }}</div>
                            </div>
                        </div>
                        
                        <!-- Terms Block -->
                        <div class="metric-card success" @click="startPremiumTerms()" style="cursor: pointer;">
                            <div class="metric-icon">
                                <i class="bi bi-book-half"></i>
                            </div>
                            <div class="metric-info">
                                <div class="metric-value">{{ t('medical_terms', lang)|default('Terms') }}</div>
                                <div class="metric-label">{{ t('unlimited_terms_access', lang)|default('Study all medical terms') }}</div>
                            </div>
                        </div>
                        
                        <!-- English Reading Block -->
                        <div class="metric-card info" @click="startPremiumEnglish()" style="cursor: pointer;">
                            <div class="metric-icon">
                                <i class="bi bi-globe"></i>
                            </div>
                            <div class="metric-info">
                                <div class="metric-value">{{ t('english_reading', lang)|default('English') }}</div>
                                <div class="metric-label">{{ t('unlimited_english_access', lang)|default('All reading passages') }}</div>
                            </div>
                        </div>
                        
                        <!-- Virtual Patients Block -->
                        <div class="metric-card accent" @click="startPremiumVP()" style="cursor: pointer;">
                            <div class="metric-icon">
                                <i class="bi bi-heart-pulse-fill"></i>
                            </div>
                            <div class="metric-info">
                                <div class="metric-value">{{ t('virtual_patients', lang)|default('VP') }}</div>
                                <div class="metric-label">{{ t('unlimited_vp_access', lang)|default('All scenarios available') }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ============================================ -->
                <!-- PROGRESS TAB CONTENT -->
                <!-- ============================================ -->
                <div x-show="activeTab === 'progress'" class="progress-dashboard">
                    
                    <!-- Loading indicator -->
                    <div x-show="isLoadingProgress" class="progress-loading-overlay" style="
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(255, 255, 255, 0.9);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 1000;
                        border-radius: 12px;
                    ">
                        <div style="text-align: center;">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p style="margin-top: 1rem; color: #666;">{{ t('loading_progress', lang)|default('Loading progress...') }}</p>
                        </div>
                    </div>
                    
                    <!-- Header with overall stats -->
                    <div class="progress-header">
                        <h2><i class="bi bi-graph-up"></i> {{ t('your_progress', lang)|default('Your Progress') }}</h2>
                        <p class="subtitle">{{ t('overview_learning_results', lang)|default('Overview of your learning results') }}</p>
                    </div>
                    
                    <!-- Categories progress breakdown -->
                    <div class="categories-progress-section">
                        <h3><i class="bi bi-bar-chart-line"></i> {{ t('progress_per_category', lang)|default('Progress per Category') }}</h3>
                        
                        <div class="categories-list">
                            <template x-for="category in categories" :key="category.id">
                                <div class="category-progress-item">
                                    <div class="category-header-row">
                                        <span class="category-name" x-text="category.name"></span>
                                        <span class="category-percentage" :class="getProgressClass(category.percentage)" x-text="category.percentage + '%'"></span>
                                    </div>
                                    <div class="category-progress-bar">
                                        <div class="progress-fill" 
                                             :style="{width: category.percentage + '%', backgroundColor: category.color}">
                                        </div>
                                    </div>
                                    <div class="category-meta">
                                        <span x-text="category.completed_domains + '/' + category.domains_count + ' {{ t('completed', lang)|default('completed') }}'"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Learning Categories Accordion -->
                    <div class="learning-categories-accordion-section">
                        <h3><i class="bi bi-grid-3x3-gap"></i> {{ t('learning_categories', lang)|default('Learning Categories') }}</h3>
                        <p class="subtitle-small">{{ t('progress_by_category_description', lang)|default('Your progress across different learning activities') }}</p>
                        
                        <div class="accordion" id="learningCategoriesAccordion">
                            <!-- Tests Category -->
                            <div class="accordion-item" x-show="progressData && progressData.category_progress">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" :class="{ 'collapsed': !categoryAccordionOpen.tests }" 
                                            @click="categoryAccordionOpen.tests = !categoryAccordionOpen.tests"
                                            :aria-expanded="categoryAccordionOpen.tests ? 'true' : 'false'">
                                        <i class="bi" :class="progressData?.category_progress?.tests?.icon || 'bi-lightning-charge-fill'" 
                                           :style="{color: progressData?.category_progress?.tests?.color || '#667eea'}" 
                                           style="font-size: 1.2rem; margin-right: 0.75rem;"></i>
                                        <span x-text="(lang === 'ru' || lang === 'uk') ? (progressData?.category_progress?.tests?.name || 'Тесты') : (progressData?.category_progress?.tests?.name_en || 'Tests')"></span>
                                        <span class="badge ms-auto me-2" 
                                              :style="{backgroundColor: progressData?.category_progress?.tests?.color || '#667eea', color: 'white'}">
                                            <span x-text="(progressData?.category_progress?.tests?.progress_percent || 0) + '%'"></span>
                                        </span>
                                    </button>
                                </h2>
                                <div class="accordion-collapse collapse" :class="{ 'show': categoryAccordionOpen.tests }">
                                    <div class="accordion-body">
                                        <div class="category-stats-grid">
                                            <div class="stat-item">
                                                <div class="stat-label">{{ t('total_completed', lang)|default('Total Completed') }}</div>
                                                <div class="stat-value" x-text="progressData?.category_progress?.tests?.total_completed || 0"></div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-label">{{ t('completed_today', lang)|default('Completed Today') }}</div>
                                                <div class="stat-value" x-text="progressData?.category_progress?.tests?.completed_today || 0"></div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-label">{{ t('average_score', lang)|default('Average Score') }}</div>
                                                <div class="stat-value" x-text="(progressData?.category_progress?.tests?.avg_score || 0) + '%'"></div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-label">{{ t('total_questions', lang)|default('Total Questions') }}</div>
                                                <div class="stat-value" x-text="progressData?.category_progress?.tests?.total_questions || 0"></div>
                                            </div>
                                        </div>
                                        <div class="category-progress-bar-detailed">
                                            <div class="progress" style="height: 8px; border-radius: 4px; background-color: #f0f0f0;">
                                                <div class="progress-bar" 
                                                     :style="{width: (progressData?.category_progress?.tests?.progress_percent || 0) + '%', backgroundColor: progressData?.category_progress?.tests?.color || '#667eea'}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Terms Category -->
                            <div class="accordion-item" x-show="progressData && progressData.category_progress">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" :class="{ 'collapsed': !categoryAccordionOpen.terms }" 
                                            @click="categoryAccordionOpen.terms = !categoryAccordionOpen.terms"
                                            :aria-expanded="categoryAccordionOpen.terms ? 'true' : 'false'">
                                        <i class="bi" :class="progressData?.category_progress?.terms?.icon || 'bi-journal-text'" 
                                           :style="{color: progressData?.category_progress?.terms?.color || '#f093fb'}" 
                                           style="font-size: 1.2rem; margin-right: 0.75rem;"></i>
                                        <span x-text="(lang === 'ru' || lang === 'uk') ? (progressData?.category_progress?.terms?.name || 'Термины') : (progressData?.category_progress?.terms?.name_en || 'Terms')"></span>
                                        <span class="badge ms-auto me-2" 
                                              :style="{backgroundColor: progressData?.category_progress?.terms?.color || '#f093fb', color: 'white'}">
                                            <span x-text="(progressData?.category_progress?.terms?.progress_percent || 0) + '%'"></span>
                                        </span>
                                    </button>
                                </h2>
                                <div class="accordion-collapse collapse" :class="{ 'show': categoryAccordionOpen.terms }">
                                    <div class="accordion-body">
                                        <div class="category-stats-grid">
                                            <div class="stat-item">
                                                <div class="stat-label">{{ t('total_studied', lang)|default('Total Studied') }}</div>
                                                <div class="stat-value" x-text="progressData?.category_progress?.terms?.total_studied || 0"></div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-label">{{ t('studied_today', lang)|default('Studied Today') }}</div>
                                                <div class="stat-value" x-text="progressData?.category_progress?.terms?.studied_today || 0"></div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-label">{{ t('mastered', lang)|default('Mastered') }}</div>
                                                <div class="stat-value" x-text="progressData?.category_progress?.terms?.mastered || 0"></div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-label">{{ t('total_available', lang)|default('Total Available') }}</div>
                                                <div class="stat-value" x-text="progressData?.category_progress?.terms?.total_available || 0"></div>
                                            </div>
                                        </div>
                                        <div class="category-progress-bar-detailed">
                                            <div class="progress" style="height: 8px; border-radius: 4px; background-color: #f0f0f0;">
                                                <div class="progress-bar" 
                                                     :style="{width: (progressData?.category_progress?.terms?.progress_percent || 0) + '%', backgroundColor: progressData?.category_progress?.terms?.color || '#f093fb'}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- English Reading Category -->
                            <div class="accordion-item" x-show="progressData && progressData.category_progress">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" :class="{ 'collapsed': !categoryAccordionOpen.english }" 
                                            @click="categoryAccordionOpen.english = !categoryAccordionOpen.english"
                                            :aria-expanded="categoryAccordionOpen.english ? 'true' : 'false'">
                                        <i class="bi" :class="progressData?.category_progress?.english?.icon || 'bi-book'" 
                                           :style="{color: progressData?.category_progress?.english?.color || '#4facfe'}" 
                                           style="font-size: 1.2rem; margin-right: 0.75rem;"></i>
                                        <span x-text="(lang === 'ru' || lang === 'uk') ? (progressData?.category_progress?.english?.name || 'Английский') : (progressData?.category_progress?.english?.name_en || 'English Reading')"></span>
                                        <span class="badge ms-auto me-2" 
                                              :style="{backgroundColor: progressData?.category_progress?.english?.color || '#4facfe', color: 'white'}">
                                            <span x-text="(progressData?.category_progress?.english?.progress_percent || 0) + '%'"></span>
                                        </span>
                                    </button>
                                </h2>
                                <div class="accordion-collapse collapse" :class="{ 'show': categoryAccordionOpen.english }">
                                    <div class="accordion-body">
                                        <div class="category-stats-grid">
                                            <div class="stat-item">
                                                <div class="stat-label">{{ t('passages_completed', lang)|default('Passages Completed') }}</div>
                                                <div class="stat-value" x-text="progressData?.category_progress?.english?.total_completed || 0"></div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-label">{{ t('completed_today', lang)|default('Completed Today') }}</div>
                                                <div class="stat-value" x-text="progressData?.category_progress?.english?.completed_today || 0"></div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-label">{{ t('average_score', lang)|default('Average Score') }}</div>
                                                <div class="stat-value" x-text="(progressData?.category_progress?.english?.avg_score || 0) + '%'"></div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-label">{{ t('total_available', lang)|default('Total Available') }}</div>
                                                <div class="stat-value" x-text="progressData?.category_progress?.english?.total_available || 0"></div>
                                            </div>
                                        </div>
                                        <div class="category-progress-bar-detailed">
                                            <div class="progress" style="height: 8px; border-radius: 4px; background-color: #f0f0f0;">
                                                <div class="progress-bar" 
                                                     :style="{width: (progressData?.category_progress?.english?.progress_percent || 0) + '%', backgroundColor: progressData?.category_progress?.english?.color || '#4facfe'}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Virtual Patients Category -->
                            <div class="accordion-item" x-show="progressData && progressData.category_progress">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" :class="{ 'collapsed': !categoryAccordionOpen.vp }" 
                                            @click="categoryAccordionOpen.vp = !categoryAccordionOpen.vp"
                                            :aria-expanded="categoryAccordionOpen.vp ? 'true' : 'false'">
                                        <i class="bi" :class="progressData?.category_progress?.virtual_patients?.icon || 'bi-heart-pulse-fill'" 
                                           :style="{color: progressData?.category_progress?.virtual_patients?.color || '#fa709a'}" 
                                           style="font-size: 1.2rem; margin-right: 0.75rem;"></i>
                                        <span x-text="(lang === 'ru' || lang === 'uk') ? (progressData?.category_progress?.virtual_patients?.name || 'Виртуальные пациенты') : (progressData?.category_progress?.virtual_patients?.name_en || 'Virtual Patients')"></span>
                                        <span class="badge ms-auto me-2" 
                                              :style="{backgroundColor: progressData?.category_progress?.virtual_patients?.color || '#fa709a', color: 'white'}">
                                            <span x-text="(progressData?.category_progress?.virtual_patients?.progress_percent || 0) + '%'"></span>
                                        </span>
                                    </button>
                                </h2>
                                <div class="accordion-collapse collapse" :class="{ 'show': categoryAccordionOpen.vp }">
                                    <div class="accordion-body">
                                        <div class="category-stats-grid">
                                            <div class="stat-item">
                                                <div class="stat-label">{{ t('scenarios_completed', lang)|default('Scenarios Completed') }}</div>
                                                <div class="stat-value" x-text="progressData?.category_progress?.virtual_patients?.total_completed || 0"></div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-label">{{ t('completed_today', lang)|default('Completed Today') }}</div>
                                                <div class="stat-value" x-text="progressData?.category_progress?.virtual_patients?.completed_today || 0"></div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-label">{{ t('average_score', lang)|default('Average Score') }}</div>
                                                <div class="stat-value" x-text="(progressData?.category_progress?.virtual_patients?.avg_score || 0) + '%'"></div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="stat-label">{{ t('total_available', lang)|default('Total Available') }}</div>
                                                <div class="stat-value" x-text="progressData?.category_progress?.virtual_patients?.total_available || 0"></div>
                                            </div>
                                        </div>
                                        <div class="category-progress-bar-detailed">
                                            <div class="progress" style="height: 8px; border-radius: 4px; background-color: #f0f0f0;">
                                                <div class="progress-bar" 
                                                     :style="{width: (progressData?.category_progress?.virtual_patients?.progress_percent || 0) + '%', backgroundColor: progressData?.category_progress?.virtual_patients?.color || '#fa709a'}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Study activity chart -->
                    <div class="activity-section">
                        <h3><i class="bi bi-calendar3"></i> {{ t('study_activity', lang)|default('Study Activity') }} ({{ t('last_30_days', lang)|default('last 30 days') }})</h3>
                        
                        <!-- Weekly activity heatmap -->
                        <div class="activity-heatmap">
                            <template x-for="day in last30Days" :key="day.date">
                                <div class="activity-day"
                                     :class="getActivityClass(day.questions)"
                                     :title="day.date + ': ' + day.questions + ' vragen'">
                                </div>
                            </template>
                        </div>
                        
                        <div class="activity-legend">
                            <span>Minder</span>
                            <div class="legend-colors">
                                <div class="legend-box level-0"></div>
                                <div class="legend-box level-1"></div>
                                <div class="legend-box level-2"></div>
                                <div class="legend-box level-3"></div>
                                <div class="legend-box level-4"></div>
                            </div>
                            <span>{{ t('more', lang)|default('More') }}</span>
                        </div>
                    </div>
                    
                    <!-- Recent sessions -->
                    <div class="sessions-section">
                        <h3><i class="bi bi-list-ul"></i> {{ t('recent_sessions', lang)|default('Recent Sessions') }}</h3>
                        
                        <div class="sessions-list">
                            <template x-for="session in recentSessions" :key="session.id">
                                <div class="session-item">
                                    <div class="session-icon">
                                        <i class="bi bi-play-circle-fill"></i>
                                    </div>
                                    <div class="session-info">
                                        <div class="session-title" x-text="session.title"></div>
                                        <div class="session-meta" x-text="session.date + ' • ' + session.questions + ' {{ t('questions', lang)|default('questions') }} • ' + session.accuracy + '% {{ t('correct', lang)|default('correct') }}'"></div>
                                    </div>
                                    <div class="session-badge" :class="session.accuracy >= 80 ? 'badge-success' : 'badge-warning'" x-text="session.accuracy + '%'"></div>
                                </div>
                            </template>
                            
                            <!-- Empty state -->
                            <div x-show="recentSessions.length === 0" class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p>{{ t('no_sessions_completed', lang)|default('No sessions completed yet') }}</p>
                                <button class="btn-primary" @click="showIndividualPlanTab()">
                                    {{ t('start_first_session', lang)|default('Start your first session') }} →
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Achievement badges -->
                    <div class="achievements-section">
                        <h3><i class="bi bi-award"></i> {{ t('achievements', lang)|default('Achievements') }}</h3>
                        
                        <div class="badges-grid">
                            
                            <!-- Streak badges -->
                            <div class="badge-item" :class="dailyStreak >= 7 ? 'earned' : 'locked'">
                                <div class="badge-animation-container">
                                    <lottie-player
                                        src="{{ url_for('static', filename='animations/flame.json') }}"
                                        background="transparent"
                                        :speed="dailyStreak >= 7 ? '1' : '0.5'"
                                        :style="dailyStreak >= 7 ? 'width: 80px; height: 80px;' : 'width: 80px; height: 80px; opacity: 0.3; filter: grayscale(100%);'"
                                        loop
                                        autoplay>
                                    </lottie-player>
                                    <div x-show="dailyStreak < 7" class="lock-overlay">
                                        <i class="bi bi-lock-fill"></i>
                                    </div>
                                </div>
                                <div class="badge-name">7 {{ t('days_streak', lang)|default('days streak') }}</div>
                                <div class="badge-requirement" x-show="dailyStreak < 7" x-text="'{{ t('more', lang)|default('More') }} ' + (7 - dailyStreak) + ' {{ t('days', lang)|default('days') }}'"></div>
                            </div>
                            
                            <div class="badge-item" :class="dailyStreak >= 30 ? 'earned' : 'locked'">
                                <div class="badge-animation-container">
                                    <lottie-player
                                        src="{{ url_for('static', filename='animations/fist.json') }}"
                                        background="transparent"
                                        :speed="dailyStreak >= 30 ? '1' : '0.5'"
                                        :style="dailyStreak >= 30 ? 'width: 80px; height: 80px;' : 'width: 80px; height: 80px; opacity: 0.3; filter: grayscale(100%);'"
                                        loop
                                        autoplay>
                                    </lottie-player>
                                    <div x-show="dailyStreak < 30" class="lock-overlay">
                                        <i class="bi bi-lock-fill"></i>
                                    </div>
                                </div>
                                <div class="badge-name">30 {{ t('days_streak', lang)|default('days streak') }}</div>
                                <div class="badge-requirement" x-show="dailyStreak < 30" x-text="'{{ t('more', lang)|default('More') }} ' + (30 - dailyStreak) + ' {{ t('days', lang)|default('days') }}'"></div>
                            </div>
                            
                            <!-- Questions badges -->
                            <div class="badge-item" :class="totalQuestionsAnswered >= 100 ? 'earned' : 'locked'">
                                <div class="badge-animation-container">
                                    <lottie-player
                                        src="{{ url_for('static', filename='animations/arm.json') }}"
                                        background="transparent"
                                        :speed="totalQuestionsAnswered >= 100 ? '1' : '0.5'"
                                        :style="totalQuestionsAnswered >= 100 ? 'width: 80px; height: 80px;' : 'width: 80px; height: 80px; opacity: 0.3; filter: grayscale(100%);'"
                                        loop
                                        autoplay>
                                    </lottie-player>
                                    <div x-show="totalQuestionsAnswered < 100" class="lock-overlay">
                                        <i class="bi bi-lock-fill"></i>
                                    </div>
                                </div>
                                <div class="badge-name">100 {{ t('questions', lang)|default('questions') }}</div>
                                <div class="badge-requirement" x-show="totalQuestionsAnswered < 100" x-text="totalQuestionsAnswered + '/100 {{ t('questions', lang)|default('questions') }}'"></div>
                            </div>
                            
                            <div class="badge-item" :class="totalQuestionsAnswered >= 500 ? 'earned' : 'locked'">
                                <div class="badge-animation-container">
                                    <lottie-player
                                        src="{{ url_for('static', filename='animations/brain.json') }}"
                                        background="transparent"
                                        :speed="totalQuestionsAnswered >= 500 ? '1' : '0.5'"
                                        :style="totalQuestionsAnswered >= 500 ? 'width: 80px; height: 80px;' : 'width: 80px; height: 80px; opacity: 0.3; filter: grayscale(100%);'"
                                        loop
                                        autoplay>
                                    </lottie-player>
                                    <div x-show="totalQuestionsAnswered < 500" class="lock-overlay">
                                        <i class="bi bi-lock-fill"></i>
                                    </div>
                                </div>
                                <div class="badge-name">500 {{ t('questions', lang)|default('questions') }}</div>
                                <div class="badge-requirement" x-show="totalQuestionsAnswered < 500" x-text="totalQuestionsAnswered + '/500 {{ t('questions', lang)|default('questions') }}'"></div>
                            </div>
                            
                        </div>
                    </div>
                    
                </div>
                
            </div>
            
            <!-- ПРАВАЯ КОЛОНКА: ОПИСАНИЕ -->
            <div class="sidebar-description" 
                 :class="{'tour-highlight': tourActive && tourStep === 3}"
                 @planner-day-selected.window="plannerSelectedDayPlan = $event.detail">
                <!-- План на выбранный день (для Planner) -->
                <div x-show="activeTab === 'planner' && plannerSelectedDayPlan" class="daily-plan-details">
                <div class="description-card">
                        <h3>
                            <i class="bi bi-calendar-check-fill"></i>
                            <span>{{ t('day', lang)|default('Day') }} <span x-text="plannerSelectedDayPlan?.study_day"></span></span>
                        </h3>
                        
                        <div x-show="plannerSelectedDayPlan?.is_big_test_day" style="padding: 1rem; background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); border-radius: 8px; color: white; margin: 1rem 0;">
                            <h4 style="margin: 0 0 0.5rem 0; color: white;">
                                <i class="bi bi-star-fill"></i> {{ t('big_test', lang)|default('BIG Test') }}
                            </h4>
                            <p style="margin: 0; opacity: 0.95;">
                                {{ t('big_test_description', lang)|default('Comprehensive test with 60 questions from your last 2 weeks of study') }}
                            </p>
                        </div>
                        
                        <div x-show="!plannerSelectedDayPlan?.is_big_test_day && plannerSelectedDayPlan?.tasks">
                            <h4 style="margin-top: 1rem; color: #1a202c;">{{ t('tasks_for_day', lang)|default('Tasks for day:') }}</h4>
                            <ul style="list-style: none; padding: 0;">
                                <template x-for="task in (plannerSelectedDayPlan?.tasks || [])" :key="task.type">
                                    <li style="padding: 0.75rem; margin: 0.5rem 0; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem;">
                                        <i :class="`bi bi-${getPlannerTaskIcon(task.type)}`" style="color: var(--primary-color); font-size: 1.25rem;"></i>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: #1a202c;" x-text="task.title"></div>
                                            <div style="font-size: 0.875rem; color: #666;" x-text="`${task.progress} / ${task.target}`"></div>
                                        </div>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- ARCHIVE INFO (для правой колонки) -->
                <div x-show="activeTab === 'archive'" 
                     class="description-card archive-info">
                    <h3>
                        <i class="bi bi-archive-fill"></i>
                        <span>{{ t('archive', lang)|default('Archive') }}</span>
                    </h3>
                    <p>{{ t('archive_description', lang)|default('View all your completed learning activities. Review past English passages, studied terms, medical tests, and virtual patients. Filter, search, and revisit your learning history.') }}</p>
                    
                    <!-- Статистика по категориям -->
                    <div x-show="$store.archive?.stats" class="archive-sidebar-stats">
                        <h4 style="margin-top: 1.5rem; margin-bottom: 1rem; color: #1a202c; font-size: 1rem;">
                            <i class="bi bi-graph-up"></i> {{ t('statistics', lang)|default('Statistics') }}
                        </h4>
                        
                        <div class="sidebar-stat-item">
                            <div class="sidebar-stat-icon" style="background: linear-gradient(135deg, #3ECDC1 0%, #32A39A 100%);">
                                <i class="bi bi-book"></i>
                            </div>
                            <div class="sidebar-stat-info">
                                <div class="sidebar-stat-label">{{ t('english_passages', lang)|default('English Passages') }}</div>
                                <div class="sidebar-stat-value" x-text="$store.archive?.stats?.english?.total || 0"></div>
                                <div class="sidebar-stat-avg" x-text="'Avg: ' + ($store.archive?.stats?.english?.avg_score || 0) + '%'"></div>
                            </div>
                        </div>
                        
                        <div class="sidebar-stat-item">
                            <div class="sidebar-stat-icon" style="background: linear-gradient(135deg, #6C5CE7 0%, #5A4FCF 100%);">
                                <i class="bi bi-card-text"></i>
                            </div>
                            <div class="sidebar-stat-info">
                                <div class="sidebar-stat-label">{{ t('dutch_terms', lang)|default('Dutch Terms') }}</div>
                                <div class="sidebar-stat-value" x-text="$store.archive?.stats?.terms?.total || 0"></div>
                                <div class="sidebar-stat-avg" x-text="'Mastery: ' + ($store.archive?.stats?.terms?.avg_mastery || 0)"></div>
                            </div>
                        </div>
                        
                        <div class="sidebar-stat-item">
                            <div class="sidebar-stat-icon" style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);">
                                <i class="bi bi-clipboard-check"></i>
                            </div>
                            <div class="sidebar-stat-info">
                                <div class="sidebar-stat-label">{{ t('medical_tests', lang)|default('Medical Tests') }}</div>
                                <div class="sidebar-stat-value" x-text="$store.archive?.stats?.tests?.total || 0"></div>
                                <div class="sidebar-stat-avg" x-text="'Avg: ' + ($store.archive?.stats?.tests?.avg_score || 0) + '%'"></div>
                            </div>
                        </div>
                        
                        <div class="sidebar-stat-item">
                            <div class="sidebar-stat-icon" style="background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);">
                                <i class="bi bi-person-badge"></i>
                            </div>
                            <div class="sidebar-stat-info">
                                <div class="sidebar-stat-label">{{ t('virtual_patients', lang)|default('Virtual Patients') }}</div>
                                <div class="sidebar-stat-value" x-text="$store.archive?.stats?.virtual_patients?.total || 0"></div>
                                <div class="sidebar-stat-avg" x-text="'Avg: ' + ($store.archive?.stats?.virtual_patients?.avg_score || 0) + '%'"></div>
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 1.5rem; margin-bottom: 1rem; color: #1a202c; font-size: 1rem;">
                        💡 {{ t('how_to_use', lang)|default('How to use') }}
                    </h4>
                    <ul style="list-style: none; padding: 0;">
                        <template x-for="tip in getTabTips('archive')" :key="tip">
                            <li style="padding: 0.5rem 0; color: #64748b; font-size: 0.9rem;">
                                <i class="bi bi-check-circle" style="color: #3ECDC1; margin-right: 0.5rem;"></i>
                                <span x-text="tip"></span>
                            </li>
                        </template>
                    </ul>
                </div>

                <!-- Обычные подсказки (для других вкладок) -->
                <div x-show="(activeTab !== 'planner' && activeTab !== 'archive') || (activeTab === 'planner' && !plannerSelectedDayPlan)" class="description-card">
                    <h3>
                        <i :class="`bi bi-${getTabIcon(activeTab)}`"></i>
                        <span x-text="getTabTitle(activeTab)"></span>
                    </h3>
                    <p x-text="getTabDescription(activeTab)"></p>
                    
                    <h4>💡 {{ t('how_to_use', lang)|default('How to use') }}</h4>
                    <ul>
                        <template x-for="tip in getTabTips(activeTab)" :key="tip">
                            <li x-text="tip"></li>
                        </template>
                    </ul>
                </div>
            </div>
            
        </div>
        
    </div>

    <script>
        function learningMapApp() {
            // Launch date: October 13, 2025 00:00
            const launchDate = new Date('2025-10-13T00:00:00');
            const now = new Date();
            const isLaunched = now >= launchDate;
            
                // Получаем параметр tab из URL
                const urlParams = new URLSearchParams(window.location.search);
                const tabParam = urlParams.get('tab');
                const reloadParam = urlParams.get('reload');
                const validTabs = ['irt', 'premium', 'individual', 'games', 'progress', 'planner', 'archive'];
                const tourParam = urlParams.get('tour');
                const resetTourParam = urlParams.get('reset_tour');
                
                let shouldLaunchTour = false;
                let shouldAutoStartTour = false;
                
                // Получаем состояние тура из базы данных (передается с сервера)
                // ВАЖНО: Это начальное значение, но мы также проверим через API для актуальности
                // Используем явное приведение к boolean для надежности
                const serverTourCompletedRaw = {% if current_user.is_authenticated and current_user.learning_map_tour_completed %}true{% else %}false{% endif %};
                let serverTourCompleted = serverTourCompletedRaw === true;
                const isAuthenticated = JSON.parse(`{{ "true" if current_user.is_authenticated else "false" }}`);
                
                // Проверяем localStorage для неавторизованных пользователей
                let localStorageTourCompleted = false;
                try {
                    const storedTourState = localStorage.getItem('learningMapTourCompleted');
                    localStorageTourCompleted = storedTourState === 'true';
                } catch (e) {
                    // Игнорируем ошибки localStorage
                }
                
                // Финальное состояние тура: для авторизованных - БД + localStorage (приоритет БД)
                // Для неавторизованных - только localStorage
                // ВАЖНО: Для авторизованных пользователей проверяем актуальный статус через API синхронно
                // Но также учитываем localStorage как резервный вариант
                let tourCompleted = isAuthenticated ? serverTourCompleted : localStorageTourCompleted;
                
                // ДОПОЛНИТЕЛЬНАЯ ПРОВЕРКА: Если в localStorage есть значение "completed", 
                // используем его как резервный вариант даже для авторизованных пользователей
                // Это защита на случай, если API не ответил или БД недоступна
                if (isAuthenticated && localStorageTourCompleted && !serverTourCompleted) {
                    // Если localStorage говорит "completed", но БД еще не обновилась - используем localStorage
                    // Это может произойти сразу после сохранения, до обновления БД
                    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                        console.log('⚠️ Using localStorage value as fallback (DB might not be updated yet)');
                    }
                    tourCompleted = true;
                }
                
                // Для авторизованных пользователей делаем синхронную проверку статуса через API
                // Это критично, чтобы получить актуальное значение из БД перед определением shouldLaunchTour
                if (isAuthenticated && !resetTourParam && tourParam !== '1') {
                    // Используем синхронный XMLHttpRequest для получения статуса тура
                    try {
                        const xhr = new XMLHttpRequest();
                        xhr.open('GET', `/{{ lang }}/learning-map/api/tour/status`, false); // false = синхронный запрос
                        // Добавляем CSRF токен если нужно
                        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
                        if (csrfToken) {
                            xhr.setRequestHeader('X-CSRFToken', csrfToken);
                        }
                        xhr.send();
                        if (xhr.status === 200) {
                            const data = JSON.parse(xhr.responseText);
                            if (data.success && data.tour_completed !== undefined) {
                                tourCompleted = data.tour_completed;
                                serverTourCompleted = data.tour_completed;
                                
                                // Синхронизируем localStorage с БД (БД имеет приоритет)
                                if (data.tour_completed !== localStorageTourCompleted) {
                                    try {
                                        localStorage.setItem('learningMapTourCompleted', data.tour_completed ? 'true' : 'false');
                                    } catch (e) {
                                        // Игнорируем ошибки синхронизации
                                    }
                                }
                                
                                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                                    console.log('✅ Tour status loaded from API and synced with localStorage:', tourCompleted);
                                }
                            }
                        } else {
                            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                                console.warn('⚠️ Failed to fetch tour status, status:', xhr.status);
                                // Если API не ответил, используем localStorage как fallback
                                if (localStorageTourCompleted) {
                                    tourCompleted = true;
                                    console.log('⚠️ Using localStorage value as fallback (API failed)');
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('Could not fetch tour status synchronously, using template/localStorage value:', e);
                        // Используем значение из шаблона или localStorage как fallback
                        if (localStorageTourCompleted) {
                            tourCompleted = true;
                            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                                console.log('⚠️ Using localStorage value as fallback (sync request failed)');
                            }
                        }
                    }
                }
                
                // Отладочное логирование (только в development)
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    console.log('🔍 Tour Debug Info:', {
                        isAuthenticated,
                        serverTourCompleted,
                        localStorageTourCompleted,
                        finalTourCompleted: tourCompleted,
                        tourParam,
                        resetTourParam,
                    });
                }
                
                // Если есть параметр reset_tour, сбрасываем состояние тура
                if (resetTourParam === '1') {
                    if (isAuthenticated) {
                        // Сбрасываем в БД через API
                        fetch(`/{{ lang }}/learning-map/api/tour/status`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ completed: false })
                        }).then(() => {
                            console.log('✅ Tour state reset in database');
                            // Также очищаем localStorage
                            try {
                                localStorage.removeItem('learningMapTourCompleted');
                            } catch (e) {}
                        }).catch(e => console.warn('Could not reset tour state:', e));
                    } else {
                        // Сбрасываем в localStorage
                        try {
                            localStorage.removeItem('learningMapTourCompleted');
                            console.log('✅ Tour state reset in localStorage');
                        } catch (e) {
                            console.warn('Could not reset tour state in localStorage:', e);
                        }
                    }
                    // Принудительно показываем тур
                    shouldLaunchTour = true;
                    shouldAutoStartTour = false;
                } else {
                    // Проверяем завершенность тура
                    shouldLaunchTour = !tourCompleted;
                }
                
                // URL параметр tour=1 имеет приоритет над всеми остальными
                if (tourParam === '1') {
                    shouldLaunchTour = true;
                    shouldAutoStartTour = true;
                }
                
                // Финальное логирование
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    console.log('🎯 Final Tour Decision:', {
                        shouldLaunchTour,
                        shouldAutoStartTour,
                        reason: resetTourParam === '1' ? 'reset_tour parameter' : 
                                tourParam === '1' ? 'tour=1 parameter' :
                                isAuthenticated ? (serverTourCompleted ? 'already completed in DB' : 'not completed in DB') :
                                'not authenticated, checking localStorage'
                    });
                }
                
                // Приоритет: URL параметр > localStorage > дефолт
                let initialTab = 'individual';
                
                // Проверяем премиум статус пользователя (для проверки доступа к premium)
                const isPremiumUser = JSON.parse(`{{ "true" if current_user.is_authenticated and current_user.is_premium_active else "false" }}`);
                
                // 1. Проверяем URL параметр (имеет наивысший приоритет)
                if (tabParam && validTabs.includes(tabParam)) {
                    // Если пользователь пытается открыть premium, но не премиум - перенаправляем
                    if (tabParam === 'premium' && !isPremiumUser) {
                        console.warn('User attempted to access premium tab without premium status');
                        initialTab = 'individual'; // Перенаправляем на individual
                    } else {
                        initialTab = tabParam;
                    }
                    // Сохраняем в localStorage при загрузке из URL
                    try {
                        localStorage.setItem('learningMapActiveTab', initialTab);
                    } catch (e) {
                        console.warn('Could not save to localStorage:', e);
                    }
                } else {
                    // 2. Если нет URL параметра, пытаемся загрузить из localStorage
                    try {
                        const savedTab = localStorage.getItem('learningMapActiveTab');
                        if (savedTab && validTabs.includes(savedTab)) {
                            // Проверяем доступ к premium при загрузке из localStorage
                            if (savedTab === 'premium' && !isPremiumUser) {
                                console.warn('Saved tab was premium but user is not premium, defaulting to individual');
                                initialTab = 'individual';
                            } else {
                                initialTab = savedTab;
                            }
                        }
                    } catch (e) {
                        console.warn('Could not read from localStorage:', e);
                    }
                }
                
                console.log('URL params:', window.location.search);
                console.log('Tab param:', tabParam);
                console.log('Reload param:', reloadParam);
                console.log('Initial tab:', initialTab);
                
                // Force tab switch if reload=true
                let finalTab = initialTab;
                if (reloadParam === 'true' && tabParam) {
                    console.log('Force switching to tab:', tabParam);
                    // Проверяем доступ к premium при принудительной перезагрузке
                    if (tabParam === 'premium' && !isPremiumUser) {
                        console.warn('Force reload to premium denied - user not premium');
                        finalTab = 'individual';
                    } else {
                        finalTab = tabParam;
                    }
                }
            
            // Базовые доступные вкладки
            const baseEnabledTabs = ['irt', 'individual', 'progress', 'games', 'planner', 'archive'];
            
            // Добавляем premium только для премиум пользователей
            const enabledTabsList = [...baseEnabledTabs];
            if (isPremiumUser) {
                enabledTabsList.push('premium');
            }
            
            return {
                activeTab: finalTab,
                isStartingDiagnostic: false,
                isLaunched: false, // ВСЕГДА false - блокируем все кроме IRT и Games
                launchDate: launchDate,
                // Enabled tabs (IRT, Individual, Progress, Games, и Premium только для премиум)
                enabledTabs: enabledTabsList,
                
                // Planner state
                plannerSelectedDayPlan: null,
                
                tourActive: false,
                tourStep: 0,
                showTourOverlay: shouldLaunchTour,
                tourAutoStart: shouldAutoStartTour,
                tourAutoStartTimer: null,
                dontShowTourAgain: false,
                tourCompleted: tourCompleted, // Локальное состояние завершенности тура
                
                // Инициализация: проверяем актуальный статус тура из БД и localStorage при загрузке
                async initTourStatus() {
                    const isAuthenticated = JSON.parse(`{{ "true" if current_user.is_authenticated else "false" }}`);
                    
                    // Сначала проверяем localStorage (быстро и надежно)
                    let localStorageCompleted = false;
                    try {
                        const stored = localStorage.getItem('learningMapTourCompleted');
                        if (stored !== null) {
                            localStorageCompleted = stored === 'true';
                        }
                    } catch (e) {
                        console.warn('Could not read from localStorage:', e);
                    }
                    
                    // Если в localStorage тур завершен, сразу обновляем состояние
                    if (localStorageCompleted) {
                        this.tourCompleted = true;
                        console.log('✅ Tour completed (from localStorage)');
                    }
                    
                    if (isAuthenticated) {
                        // Для авторизованных пользователей также проверяем БД
                        try {
                            const response = await fetch(`/{{ lang }}/learning-map/api/tour/status`);
                            const data = await response.json();
                            if (data.success && data.tour_completed !== undefined) {
                                const wasCompleted = this.tourCompleted;
                                this.tourCompleted = data.tour_completed;
                                
                                // Синхронизируем localStorage с БД (БД имеет приоритет)
                                if (data.tour_completed !== localStorageCompleted) {
                                    try {
                                        localStorage.setItem('learningMapTourCompleted', data.tour_completed ? 'true' : 'false');
                                        console.log('🔄 Synced localStorage with database');
                                    } catch (e) {
                                        // Игнорируем ошибки синхронизации
                                    }
                                }
                                
                                console.log('🔍 initTourStatus: tour status from API:', {
                                    wasCompleted,
                                    nowCompleted: this.tourCompleted,
                                    localStorageCompleted,
                                    showTourOverlay: this.showTourOverlay
                                });
                                
                                // Если тур уже завершен, скрываем оверлей
                                if (this.tourCompleted && this.showTourOverlay) {
                                    console.log('✅ Hiding tour overlay - tour already completed');
                                    this.showTourOverlay = false;
                                    this.tourAutoStart = false;
                                }
                            }
                        } catch (e) {
                            console.warn('Could not fetch tour status from API:', e);
                            // Если API не ответил, используем значение из localStorage
                            if (localStorageCompleted) {
                                console.log('⚠️ Using localStorage value as fallback (API failed)');
                                this.tourCompleted = true;
                            }
                        }
                    } else {
                        // Для неавторизованных пользователей используем только localStorage
                        this.tourCompleted = localStorageCompleted;
                    }
                },
                
                async persistTourState(completed) {
                    const isAuthenticated = JSON.parse(`{{ "true" if current_user.is_authenticated else "false" }}`);
                    
                    console.log('💾 persistTourState called:', { completed, isAuthenticated });
                    
                    // Обновляем локальное состояние сразу
                    this.tourCompleted = completed;
                    
                    // КРИТИЧНО: Сначала сохраняем в localStorage (быстро и надежно)
                    // Это гарантирует, что состояние сохранится даже если API запрос упадет
                    try {
                        localStorage.setItem('learningMapTourCompleted', completed ? 'true' : 'false');
                        console.log('✅ Tour state saved to localStorage:', completed);
                    } catch (localStorageError) {
                        console.warn('Could not persist tour state to localStorage:', localStorageError);
                    }
                    
                    if (isAuthenticated) {
                        // Для авторизованных пользователей также сохраняем в БД
                        try {
                            const lang = '{{ lang }}';
                            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                                             document.querySelector('input[name="csrf_token"]')?.value;
                            
                            const response = await fetch(`/${lang}/learning-map/api/tour/status`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken || ''
                                },
                                body: JSON.stringify({ 
                                    completed: completed,
                                    csrf_token: csrfToken || ''  // Также передаем в теле запроса для before_request hook
                                })
                            });
                            
                            if (!response.ok) {
                                const errorText = await response.text();
                                console.error('❌ Failed to save tour state to server:', response.status, errorText);
                                // НЕ выбрасываем ошибку - localStorage уже сохранен, это достаточно
                                console.log('⚠️ Tour state saved to localStorage only (server save failed)');
                            } else {
                                const result = await response.json();
                                console.log('✅ Tour state saved to server:', result);
                                
                                // Обновляем локальное состояние на основе ответа сервера
                                if (result.success && result.tour_completed !== undefined) {
                                    this.tourCompleted = result.tour_completed;
                                    // Также обновляем localStorage на основе ответа сервера для синхронизации
                                    try {
                                        localStorage.setItem('learningMapTourCompleted', result.tour_completed ? 'true' : 'false');
                                    } catch (e) {
                                        // Игнорируем ошибки localStorage при обновлении
                                    }
                                    console.log('✅ Tour state updated locally and in localStorage:', this.tourCompleted);
                                }
                            }
                        } catch (e) {
                            console.warn('Could not persist tour state to server:', e);
                            // localStorage уже сохранен выше, так что это не критично
                            console.log('⚠️ Tour state saved to localStorage only (server request failed)');
                        }
                    }
                    // Для неавторизованных пользователей localStorage уже сохранен выше
                },
                lockScroll(shouldLock) {
                    try {
                        if (document && document.body) {
                            if (shouldLock) {
                                document.body.classList.add('tour-active');
                            } else {
                                document.body.classList.remove('tour-active');
                            }
                        }
                    } catch (e) {
                        console.warn('Failed to toggle body scroll for tour:', e);
                    }
                },
                startTour(autoLaunch) {
                    if (this.tourAutoStartTimer) {
                        clearTimeout(this.tourAutoStartTimer);
                        this.tourAutoStartTimer = null;
                    }
                    
                    this.tourAutoStart = false;
                    this.showTourOverlay = false;
                    
                    if (this.activeTab !== 'individual') {
                        this.selectTab('individual');
                    }
                    
                    this.lockScroll(true);
                    this.tourActive = true;
                    this.tourStep = 1;
                    
                    // НЕ сохраняем состояние здесь - только в endTour() или skipTour()
                    // Это позволяет пользователю пройти тур, даже если чекбокс отмечен
                    
                    const behavior = autoLaunch ? 'auto' : 'smooth';
                    this.$nextTick(() => {
                        this.scrollToTourTarget(this.tourStep, behavior);
                    });
                },
                nextTourStep() {
                    if (this.tourStep < 6) {
                        this.tourStep += 1;
                        this.$nextTick(() => {
                            this.scrollToTourTarget(this.tourStep);
                        });
                    } else {
                        this.endTour();
                    }
                },
                prevTourStep() {
                    if (this.tourStep > 1) {
                        this.tourStep -= 1;
                        this.$nextTick(() => {
                            this.scrollToTourTarget(this.tourStep);
                        });
                    }
                },
                async endTour() {
                    this.tourActive = false;
                    this.tourStep = 0;
                    this.tourAutoStart = false;
                    this.showTourOverlay = false;
                    
                    // Если пользователь прошел весь тур до конца, всегда сохраняем как завершенный
                    // Чекбокс "Не показывать снова" означает, что пользователь не хочет видеть тур вообще
                    // Но если тур завершен, он не должен показываться автоматически в любом случае
                    await this.persistTourState(true);
                    
                    // Убеждаемся, что оверлей скрыт после сохранения
                    this.showTourOverlay = false;
                    
                    this.lockScroll(false);
                },
                async skipTour() {
                    if (this.tourAutoStartTimer) {
                        clearTimeout(this.tourAutoStartTimer);
                        this.tourAutoStartTimer = null;
                    }
                    this.tourAutoStart = false;
                    this.showTourOverlay = false;
                    this.tourActive = false;
                    this.tourStep = 0;
                    
                    // Если чекбокс отмечен, сохраняем состояние как завершенное (больше не показывать)
                    if (this.dontShowTourAgain) {
                        console.log('💾 Saving tour state: completed=true (dontShowTourAgain checked)');
                        await this.persistTourState(true);
                        // Убеждаемся, что оверлей скрыт после сохранения
                        this.showTourOverlay = false;
                        console.log('✅ Tour state saved, overlay hidden');
                    } else {
                        console.log('⏭️ Tour skipped but dontShowTourAgain not checked, state not saved');
                    }
                    // Если чекбокс не отмечен, не сохраняем состояние (можно показать снова)
                    
                    this.lockScroll(false);
                },
                restartTour() {
                    this.persistTourState(false);
                    this.startTour(false);
                },
                scrollToTourTarget(step, behavior) {
                    try {
                        const scrollBehavior = behavior || 'smooth';
                        const selectors = {
                            1: '.learning-tabs',
                            2: '.daily-plan-card',
                            3: '.sidebar-description',
                            4: '.learning-tabs',
                            5: '.navbar-nav .nav-link[href*="knowledge-base"]',
                            6: '#languageDropdown'
                        };
                        
                        const selector = selectors[step];
                        if (!selector) {
                            return;
                        }
                        
                        const target = document.querySelector(selector);
                        if (!target) {
                            return;
                        }
                        
                        const rect = target.getBoundingClientRect();
                        const offset = window.pageYOffset + rect.top - 160;
                        
                        window.scrollTo({
                            top: offset > 0 ? offset : 0,
                            behavior: scrollBehavior
                        });
                    } catch (e) {
                        console.warn('Failed to scroll to tour target:', e);
                    }
                },
                // Real user statistics
                userStats: {
                    activeModules: 0,
                    totalLearningTime: '0h',
                    avgScore: 0,
                    irtTestsCompleted: 0,
                    totalLessonsCompleted: 0,
                    totalLessonsStarted: 0,
                    avgIrtScore: 0,
                    testAttempts: 0,
                    lastActivity: null
                },
                gamesStats: {
                    sudoku: { games_played: 0, best_time: null, difficulty_completed: {easy: false, medium: false, hard: false} },
                    memory: { games_played: 0, best_time: null, difficulty_completed: {easy: false, medium: false, hard: false} },
                    quiz: { games_played: 0, best_score: 0, categories_completed: [] },
                    achievements: { total: 0, completed: 0, progress: 0 },
                    leaderboard: { user_rank: null, total_users: 0, user_score: 0 }
                },
                statsLoaded: false,
                gamesStatsLoaded: false,
                
                // Individual Plan data
                dailyStreak: 0,
                dailyTasks: {
                    new_questions: 0,
                    reviews_due: 0,
                    total_tasks: 0,
                    estimated_time: 0,
                    goal: 20
                },
                questionsToday: 0,
                categories: [],
                expandedCategories: [],
                overallProgress: 0,
                timeInvested: 0,
                timeInvestedHours: 0,
                timeInvestedMinutes: 0,
                timeTodayHours: 0,
                timeTodayMinutes: 0,
                retentionRate: 0,
                diagnosticCompleted: JSON.parse(`{{ "true" if diagnostic_completed else "false" }}`),
                diagnosticRequired: JSON.parse(`{{ "true" if diagnostic_required else "false" }}`),
                individualPlanDataLoaded: false,
                
                // Countdown timer data
                timeUntilMidnight: { hours: 0, minutes: 0, seconds: 0 },
                countdownInterval: null,
                
                // Celebration data
                showCelebration: false,
                celebrationAnimation: '',
                celebrationMessage: '',
                
                // Progress tab data
                totalQuestionsAnswered: 0,
                recentSessions: [],
                last30Days: [],
                
                // Category accordion state
                categoryAccordionOpen: {
                    tests: false,
                    terms: false,
                    english: false,
                    vp: false
                },
                
                // Progress data object
                progressData: {},
                
                // Loading flags
                isLoadingProgress: false,
                
                // Language (from template or default)
                lang: '{{ lang|default("en") }}',
                
                // Premium filter
                premiumFilter: 'all', // 'all', 'tests', 'terms', 'english', 'vp'
                
                async loadUserStats() {
                    try {
                        const currentLang = document.querySelector('html').getAttribute('lang') || 'en';
                        const response = await fetch(`/${currentLang}/api/user-statistics`);
                        
                        if (!response.ok) {
                            if (response.status === 429) {
                                // Rate limit exceeded - show user-friendly message
                                console.warn('Rate limit exceeded for user statistics, retrying in 2 seconds...');
                                setTimeout(() => this.loadUserStats(), 2000);
                                return;
                            }
                            console.error('Failed to fetch statistics:', response.status, response.statusText);
                            this.statsLoaded = true; // Mark as loaded to prevent UI issues
                            return;
                        }
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            this.userStats = {
                                activeModules: data.statistics.active_modules || 0,
                                totalLearningTime: data.statistics.total_learning_time || '0h',
                                avgScore: data.statistics.avg_score || 0,
                                irtTestsCompleted: data.statistics.irt_tests_completed || 0,
                                totalLessonsCompleted: data.statistics.total_lessons_completed || 0,
                                totalLessonsStarted: data.statistics.total_lessons_started || 0,
                                avgIrtScore: data.statistics.avg_irt_score || 0,
                                testAttempts: data.statistics.test_attempts || 0,
                                lastActivity: data.statistics.last_activity || null
                            };
                            this.statsLoaded = true;
                        }
                    } catch (error) {
                        console.error('Failed to load user statistics:', error);
                        this.statsLoaded = true; // Mark as loaded to prevent UI issues
                    }
                },
                async loadGamesStats() {
                    try {
                        const currentLang = document.querySelector('html').getAttribute('lang') || 'en';
                        const response = await fetch(`/${currentLang}/api/games-statistics`);
                        const data = await response.json();
                        
                        if (data.success) {
                            this.gamesStats = {
                                sudoku: data.statistics.games.sudoku,
                                memory: data.statistics.games.memory,
                                quiz: data.statistics.games.quiz,
                                achievements: data.statistics.achievements,
                                leaderboard: data.statistics.leaderboard
                            };
                            this.gamesStatsLoaded = true;
                        }
                    } catch (error) {
                        console.error('Failed to load games statistics:', error);
                    }
                },
                updateCountdown() {
                    // Calculate time until midnight (UTC)
                    const now = new Date();
                    const midnight = new Date(now);
                    midnight.setUTCHours(24, 0, 0, 0); // Next midnight in UTC
                    
                    const diff = midnight - now;
                    
                    if (diff <= 0) {
                        // Already past midnight, reset to next day
                        this.timeUntilMidnight = { hours: 0, minutes: 0, seconds: 0 };
                        return;
                    }
                    
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    
                    this.timeUntilMidnight = { hours, minutes, seconds };
                },
                
                formatCountdown() {
                    const h = String(this.timeUntilMidnight.hours).padStart(2, '0');
                    const m = String(this.timeUntilMidnight.minutes).padStart(2, '0');
                    const s = String(this.timeUntilMidnight.seconds).padStart(2, '0');
                    return `${h}:${m}:${s}`;
                },
                
                startCountdown() {
                    // Update immediately
                    this.updateCountdown();
                    
                    // Update every second
                    if (this.countdownInterval) {
                        clearInterval(this.countdownInterval);
                    }
                    this.countdownInterval = setInterval(() => {
                        this.updateCountdown();
                    }, 1000);
                },
                
                // Cleanup countdown on component destroy
                destroy() {
                    if (this.countdownInterval) {
                        clearInterval(this.countdownInterval);
                        this.countdownInterval = null;
                    }
                    if (this.tourAutoStartTimer) {
                        clearTimeout(this.tourAutoStartTimer);
                        this.tourAutoStartTimer = null;
                    }
                    this.lockScroll(false);
                },
                
                async init() {
                    console.log('🚀 Learning Map initialized');
                    console.log('Initial activeTab:', this.activeTab);
                    
                    // Проверяем актуальный статус тура из БД перед загрузкой остальных данных
                    // Это гарантирует, что тур не показывается, если он уже был завершен
                    await this.initTourStatus();
                    
                    // КРИТИЧНО: Если тур завершен, принудительно скрываем оверлей и отменяем автозапуск
                    if (this.tourCompleted) {
                        console.log('✅ Tour is completed - forcing overlay and autostart to false');
                        this.showTourOverlay = false;
                        this.tourAutoStart = false;
                        if (this.tourAutoStartTimer) {
                            clearTimeout(this.tourAutoStartTimer);
                            this.tourAutoStartTimer = null;
                        }
                    }
                    
                    // Start countdown timer
                    this.startCountdown();
                    
                    // Load user statistics first
                    await this.loadUserStats();
                    
                    // Add delay between API calls to prevent rate limiting
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // Games statistics не загружаем, так как не показываем статистику игр
                    
                    // Initialize time variables
                    this.timeInvested = 0;
                    this.timeInvestedHours = 0;
                    this.timeInvestedMinutes = 0;
                    this.timeTodayHours = 0;
                    this.timeTodayMinutes = 0;
                    
                    // Initialize last30Days with empty data
                    this.last30Days = this.generateLast30Days();
                    
                    // Load daily tasks from planner (synchronized)
                    await this.loadDailyTasksFromPlanner();
                    
                    // Load Individual Plan data if that's the active tab
                    if (this.activeTab === 'individual') {
                        console.log('Loading individual plan data...');
                        // Add delay before loading individual plan data
                        setTimeout(() => {
                            this.loadIndividualPlanData();
                            this.loadTodayProgress();
                        }, 300);
                    }
                    
                    // Load Progress data if that's the active tab
                    if (this.activeTab === 'progress') {
                        console.log('Loading progress data on init...');
                        // Add delay before loading progress data
                        setTimeout(() => {
                            if (!this.isLoadingProgress) {
                                this.loadProgressData();
                            }
                        }, 300);
                    }
                    
                    if (this.showTourOverlay && this.tourAutoStart) {
                        this.tourAutoStartTimer = setTimeout(() => {
                            this.startTour(true);
                        }, 900);
                    }
                },
                selectTab(tab) {
                    console.log('Selecting tab:', tab);
                    if (!this.enabledTabs.includes(tab)) {
                        this.showComingSoonModal(tab);
                        return;
                    }
                    
                    // Сохраняем выбранную вкладку в localStorage
                    try {
                        localStorage.setItem('learningMapActiveTab', tab);
                        console.log('💾 Saved tab to localStorage:', tab);
                    } catch (e) {
                        console.warn('Could not save to localStorage:', e);
                    }
                    
                    this.activeTab = tab;
                    console.log('Active tab set to:', this.activeTab);
                    
                    // ✅ ВСЕГДА перезагружать данные при переключении (только если еще не загружаются)
                    if (tab === 'progress') {
                        console.log('🔄 Refreshing progress data...');
                        // Проверяем, не загружается ли уже
                        if (!this.isLoadingProgress) {
                            this.loadProgressData();
                        } else {
                            console.log('⏳ Progress data is already loading, will reload after current request completes');
                            // Отменяем предыдущий запрос и начинаем новый через небольшую задержку
                            setTimeout(() => {
                                if (!this.isLoadingProgress) {
                                    this.loadProgressData();
                                }
                            }, 500);
                        }
                    } else if (tab === 'individual') {
                        console.log('🔄 Refreshing individual plan data...');
                        this.loadIndividualPlanData();
                    }
                },
                showComingSoonModal(tab) {
                    const tabNames = {
                        'virtual': 'Virtual Patients',
                        'individual': 'Individual Learning',
                        'progress': 'Progress Tracking',
                        'planner': 'Learning Planner'
                    };
                    
                    this.showNotification(
                        `${tabNames[tab]} is coming soon!`,
                        'info'
                    );
                },
                modules: {
                    'irt': [
                        // Модули скрыты - используем карточки тестов вместо них
                    ],
                    'virtual': [
                        { id: 4, title: 'Case #1', subtitle: 'Emergency', icon: 'heart-pulse-fill', progress: 100, completed: 5, total: 5 }
                    ],
                    'individual': [
                        // No module cards for Individual Plan - it has its own custom layout
                    ],
                    'games': [
                        { 
                            id: 7, 
                            title: 'Super Mentora', 
                            subtitle: '8-Bit Action', 
                            icon: 'controller', 
                            url: '/games/dentist-dash',
                            featured: true
                        },
                        { 
                            id: 8, 
                            title: 'Sudoku', 
                            subtitle: 'Classic', 
                            icon: 'grid-3x3-gap-fill', 
                            url: '/games/sudoku' 
                        },
                        { 
                            id: 9, 
                            title: 'Medical Memory', 
                            subtitle: 'Match Terms', 
                            icon: 'bullseye', 
                            url: '/games/memory' 
                        },
                        { 
                            id: 10, 
                            title: 'Quick Quiz', 
                            subtitle: 'Fast Questions', 
                            icon: 'lightning-charge-fill', 
                            url: '/games/quiz' 
                        }
                    ],
                    'progress': [
                        { id: 10, title: 'Overall', subtitle: 'Loading...', icon: 'graph-up', progress: 0, completed: 0, total: 100 },
                        { id: 11, title: 'This Week', subtitle: 'Loading...', icon: 'calendar-week', progress: 0, completed: 0, total: 20 },
                        { id: 12, title: 'Study Time', subtitle: 'Loading...', icon: 'clock-fill', progress: 0, completed: 0, total: 0 }
                    ],
                    'planner': [
                        { id: 13, title: 'Today', subtitle: '3 tasks', icon: 'calendar-check', progress: 66, completed: 2, total: 3 },
                        { id: 14, title: 'This Week', subtitle: '10 tasks', icon: 'calendar-week', progress: 40, completed: 4, total: 10 },
                        { id: 15, title: 'Upcoming', subtitle: 'Schedule', icon: 'calendar-event', progress: 0, completed: 0, total: 5 }
                    ]
                },
                get displayModules() { return this.modules[this.activeTab] || []; },
                get currentProgress() {
                    if (this.activeTab === 'irt') {
                        // Для IRT считаем прогресс на основе модулей
                    const mods = this.displayModules;
                        return mods.length ? Math.round(mods.reduce((s, m) => s + (typeof m.progress === 'function' ? m.progress() : m.progress), 0) / mods.length) : 0;
                    } else if (this.activeTab === 'games') {
                        // Для игр не показываем прогресс
                        return 0;
                    } else {
                        // Для остальных табов используем статические данные
                        const mods = this.displayModules;
                        return mods.length ? Math.round(mods.reduce((s, m) => s + (typeof m.progress === 'function' ? m.progress() : m.progress), 0) / mods.length) : 0;
                    }
                },
                get completedModules() { 
                    if (this.activeTab === 'irt') {
                        return this.displayModules.filter(m => (typeof m.progress === 'function' ? m.progress() : m.progress) === 100).length;
                    } else if (this.activeTab === 'games') {
                        return 0; // Не показываем статистику для игр
                    } else {
                        return this.displayModules.filter(m => (typeof m.progress === 'function' ? m.progress() : m.progress) === 100).length;
                    }
                },
                get totalModules() { 
                    if (this.activeTab === 'irt') {
                        return this.displayModules.length; // Все IRT модули
                    } else if (this.activeTab === 'games') {
                        return 3; // sudoku, memory, quiz
                    } else {
                        return this.displayModules.length;
                    }
                },
                get activeModules() { return this.displayModules.filter(m => m.progress > 0 && m.progress < 100).length; },
                get dailyProgressPercent() {
                    return Math.min(100, (this.questionsToday / this.dailyTasks.goal) * 100);
                },
                get completedTabs() {
                    // Для примера: 2 таба завершено (IRT, Virtual)
                    return 2;
                },
                getTabIcon(tab) {
                    return { 
                        'irt': 'cpu-fill', 
                        'premium': 'star-fill', 
                        'individual': 'person-fill',
                        'games': 'controller',
                        'progress': 'graph-up',
                        'planner': 'calendar-check-fill',
                        'archive': 'archive-fill'
                    }[tab] || 'circle';
                },
                getTabTitle(tab) {
                    return { 
                        'irt': 'IRT Adaptive Learning (Beta)', 
                        'premium': 'Premium Access', 
                        'individual': 'Individual Learning',
                        'games': 'Gamification & Achievements',
                        'progress': 'Your Progress',
                        'planner': 'Learning Planner',
                        'archive': '{{ t("archive", lang)|default("Archive") }}'
                    }[tab] || 'Unknown';
                },
                getTabDescription(tab) {
                    const descriptions = { 
                        'irt': '{{ t("irt_description", lang)|default("🧪 BETA: Choose your test format - Quick Test (30 questions) for rapid assessment, Full Test (60 questions) for comprehensive evaluation, or Learning Mode (30 questions with explanations) to study while testing. All tests use adaptive IRT technology.") }}',
                        'premium': '{{ t("premium_description", lang)|default("⭐ Premium Access: Unlimited access to all learning materials. Practice with all questions, terms, virtual patients, and English reading passages. Filter by categories and study without restrictions.") }}',
                        'individual': '{{ t("individual_description", lang)|default("Personalized learning modules tailored to your needs. Study at your own pace with comprehensive materials and interactive exercises. After a short diagnostic we build your daily plan. If something felt off the first time, open the IRT tab and retake the quick diagnostic so the system recalibrates and focuses on the areas you missed.") }}',           
                        'games': '{{ t("games_description", lang)|default("Relax and improve your cognitive skills with fun games! Play Sudoku for logic training, Medical Memory to learn terminology, or Quick Quiz for fast knowledge checks. Earn achievements and compete on the leaderboard!") }}',
                        'progress': '{{ t("progress_description", lang)|default("Track your learning journey with detailed analytics. Monitor your performance across all modules, see your study time, and identify areas for improvement.") }}',
                        'planner': '{{ t("planner_description", lang)|default("Plan your learning schedule effectively. Set daily and weekly goals, track deadlines, and stay organized with our intelligent learning planner.") }}',
                        'archive': '{{ t("archive_description", lang)|default("View all your completed learning activities. Review past English passages, studied terms, medical tests, and virtual patients. Filter, search, and revisit your learning history.") }}'
                    };
                    
                    if (!this.isLaunched && !this.enabledTabs.includes(tab)) {
                        return `{{ t('feature_coming_soon', lang)|default('This feature is coming soon!') }} ${descriptions[tab] || ''}`;
                    }
                    
                    return descriptions[tab] || '';
                },
                getTabTips(tab) {
                    const tips = { 
                        'irt': ['{{ t("tip_click_test_card", lang)|default("Click on any test card to start") }}', '{{ t("tip_quick_test", lang)|default("Quick Test (30q) - fast knowledge check") }}', '{{ t("tip_full_test", lang)|default("Full Test (60q) - comprehensive assessment") }}', '{{ t("tip_learning_mode", lang)|default("Learning Mode (30q) - study with instant feedback") }}'],
                        'virtual': ['{{ t("tip_read_patient_history", lang)|default("Read patient history carefully before making decisions") }}', '{{ t("tip_multiple_scenarios", lang)|default("Each case has multiple scenarios and outcomes") }}', '{{ t("tip_review_feedback", lang)|default("Review feedback to improve your clinical reasoning") }}'],
                        'individual': ['{{ t("tip_choose_modules", lang)|default("Choose modules based on your learning goals") }}', '{{ t("tip_complete_quizzes", lang)|default("Complete quizzes to reinforce your knowledge") }}', '{{ t("tip_unlock_modules", lang)|default("Unlock new modules by progressing through the curriculum") }}', '{{ t("tip_retake_diagnostic", lang)|default("If something felt off, open the IRT tab and repeat the quick diagnostic to refresh your plan") }}'],                                                          
                        'games': ['{{ t("tip_play_sudoku", lang)|default("Play Sudoku to improve logical thinking") }}', '{{ t("tip_medical_memory", lang)|default("Medical Memory helps learn terminology quickly") }}', '{{ t("tip_quick_quiz", lang)|default("Quick Quiz tests your knowledge in seconds") }}', '{{ t("tip_earn_achievements", lang)|default("Earn achievements and climb the leaderboard") }}', '{{ t("tip_take_breaks", lang)|default("Take breaks with games to refresh your mind") }}'],
                        'progress': ['{{ t("tip_review_statistics", lang)|default("Review your statistics regularly") }}', '{{ t("tip_set_goals", lang)|default("Set weekly and monthly goals") }}', '{{ t("tip_track_time", lang)|default("Track time spent on each learning activity") }}', '{{ t("tip_identify_weak_areas", lang)|default("Identify weak areas and focus on improvement") }}'],
                        'planner': ['{{ t("tip_schedule_sessions", lang)|default("Schedule study sessions in advance") }}', '{{ t("tip_set_reminders", lang)|default("Set reminders for important deadlines") }}', '{{ t("tip_balance_activities", lang)|default("Balance different types of learning activities") }}', '{{ t("tip_review_plan", lang)|default("Review and adjust your plan weekly") }}'],
                        'archive': ['{{ t("tip_filter_archive", lang)|default("Use filters to find specific items") }}', '{{ t("tip_search_archive", lang)|default("Search by name or category") }}', '{{ t("tip_revisit_content", lang)|default("Revisit completed content to reinforce learning") }}', '{{ t("tip_track_progress", lang)|default("Track your learning history and progress") }}']
                    };
                    
                    if (!this.isLaunched && !this.enabledTabs.includes(tab)) {
                        return ['{{ t("feature_coming_soon", lang)|default("This feature is coming soon") }}', '{{ t("stay_tuned", lang)|default("Stay tuned for updates") }}', '{{ t("check_back_later", lang)|default("Check back later") }}'];
                    }
                    
                    return tips[tab] || [];
                },
                getPlannerTaskIcon(taskType) {
                    const icons = {
                        'diagnostic_test': 'clipboard-check',
                        'flashcards': 'card-text',
                        'virtual_patient': 'person-badge',
                        'english_reading': 'book',
                        'memory': 'bullseye',
                        'big_test': 'clipboard-check'
                    };
                    return icons[taskType] || 'circle';
                },
                async startDiagnostic(diagnosticType) {
                    if (this.isStartingDiagnostic) return;
                    
                    this.isStartingDiagnostic = true;
                    
                    try {
                        // Показываем уведомление о начале
                        const notification = this.showNotification(`{{ t('starting_diagnostic', lang)|default('Starting') }} ${diagnosticType} {{ t('diagnostic', lang)|default('diagnostic') }}...`, 'info');
                        
                        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
                        console.log('CSRF Token:', csrfToken ? 'Found' : 'Missing');
                        console.log('Diagnostic Type:', diagnosticType);
                        
                        // Отправляем запрос на сервер
                        const response = await fetch('/big-diagnostic/start', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken || ''
                            },
                            body: JSON.stringify({
                                diagnostic_type: diagnosticType
                            })
                        });
                        
                        console.log('Response status:', response.status);
                        
                        const data = await response.json();
                        console.log('Response data:', data);
                        
                        if (data.success) {
                            // Успешно запустили диагностику - перенаправляем
                            window.location.href = data.redirect_url;
                        } else if (data.error === 'active_session') {
                            // Уже есть активная сессия
                            this.showNotification('{{ t("active_diagnostic_session", lang)|default("You already have an active diagnostic session") }}', 'warning');
                            if (data.session_info) {
                                window.location.href = `/big-diagnostic/question/${data.session_info.id}`;
                            }
                        } else {
                            // Ошибка
                            console.error('Diagnostic error:', data.error, data);
                            this.showNotification(data.error || '{{ t("failed_to_start_diagnostic", lang)|default("Failed to start diagnostic") }}', 'error');
                        }
                    } catch (error) {
                        console.error('Error starting diagnostic:', error);
                        this.showNotification('{{ t("failed_to_start_diagnostic_try_again", lang)|default("Failed to start diagnostic. Please try again.") }}', 'error');
                    } finally {
                        this.isStartingDiagnostic = false;
                    }
                },
                showNotification(message, type = 'info') {
                    // Простая система уведомлений
                    const notification = document.createElement('div');
                    notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} alert-dismissible fade show position-fixed`;
                    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    notification.innerHTML = `
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // Автоматически скрываем через 5 секунд
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 5000);
                    
                    return notification;
                },
                startIRTTest(questionCount) {
                    // Запуск IRT теста с заданным количеством вопросов
                    console.log(`Starting IRT test with ${questionCount} questions`);
                    
                    // КРИТИЧНО: Проверяем, прошёл ли пользователь диагностику
                    // IRT тесты - это диагностика, поэтому их можно запускать всегда
                    // Но если это первый раз, лучше направить на диагностику
                    
                    // Определяем тип теста на основе количества вопросов
                    let diagnosticType = 'quick_30';
                    if (questionCount === 60) {
                        diagnosticType = 'full_60';
                    }
                    
                    // Запускаем тест
                    this.startDiagnostic(diagnosticType);
                },
                startLearningMode() {
                    // Запуск обучающего режима (30 вопросов с объяснениями)
                    console.log('Starting learning mode with explanations');
                    this.startDiagnostic('learning_30');
                },
                
                // Premium functions
                startPremiumTest(type) {
                    const lang = this.lang || 'en';
                    let diagnosticType = 'quick_30';
                    if (type === 'full') {
                        diagnosticType = 'full_60';
                    } else if (type === 'learning') {
                        diagnosticType = 'learning_30';
                    }
                    // Premium mode - no restrictions, all questions available
                    window.location.href = `/${lang}/diagnostic/start?diagnostic_type=${diagnosticType}&premium=true`;
                },
                
                startPremiumTerms() {
                    // КРИТИЧНО: Проверяем диагностику перед запуском терминов
                    if (!this.diagnosticCompleted) {
                        alert('Для изучения терминов необходимо сначала пройти диагностический тест.');
                        this.startDiagnostic('quick_30');
                        return;
                    }
                    // Redirect to flashcards daily session with premium access
                    window.location.href = `/flashcards/daily-session?premium=true`;
                },
                
                startPremiumEnglish() {
                    // КРИТИЧНО: Проверяем диагностику перед запуском английского
                    if (!this.diagnosticCompleted) {
                        alert('Для чтения английских текстов необходимо сначала пройти диагностический тест.');
                        this.startDiagnostic('quick_30');
                        return;
                    }
                    // Redirect to English reading with premium access
                    window.location.href = `/english/practice?premium=true`;
                },
                
                startPremiumVP() {
                    // КРИТИЧНО: Проверяем диагностику перед запуском виртуальных пациентов
                    if (!this.diagnosticCompleted) {
                        alert('Для работы с виртуальными пациентами необходимо сначала пройти диагностический тест.');
                        this.startDiagnostic('quick_30');
                        return;
                    }
                    // Redirect to virtual patients with premium access
                    window.location.href = `/virtual-patients?premium=true`;
                },
                
                // Individual Plan methods
                toggleCategory(categoryId) {
                    const index = this.expandedCategories.indexOf(categoryId);
                    if (index > -1) {
                        this.expandedCategories.splice(index, 1);
                    } else {
                        this.expandedCategories.push(categoryId);
                    }
                },
                
                getProgressClass(percentage) {
                    if (percentage >= 80) return 'progress-high';
                    if (percentage >= 60) return 'progress-medium';
                    return 'progress-low';
                },
                
                async startDailySession() {
                    // If data not loaded yet, load it first
                    if (!this.individualPlanDataLoaded) {
                        await this.loadIndividualPlanData();
                    }
                    
                    // Загрузить VP данные если ещё не загружены
                    if (!this.vpStats) {
                        await this.loadVirtualPatientData();
                    }
                    
                    // Require diagnostic before first daily flow launch
                    if (!this.diagnosticCompleted) {
                        this.diagnosticRequired = true;
                        return this.startDiagnostic('quick_30');
                    }
                    
                    // Перейти на daily session start page (новая страница)
                    // которая показывает flow: тесты → слова → виртуальный пациент
                    window.location.href = '/learning-map/daily-session-flow';
                },
                
                getCategoryIcon(categoryName) {
                    // Map category names to Bootstrap Icons
                    const iconMap = {
                        'Clinical Foundations': 'bi-hospital',
                        'Medical Sciences': 'bi-capsule',
                        'Diagnostics & Imaging': 'bi-gear',
                        'Basic Sciences': 'bi-mortarboard',
                        'Research & Methodology': 'bi-graph-up',
                        'Clinical Practice': 'bi-person-badge',
                        'Professional Development': 'bi-award'
                    };
                    return iconMap[categoryName] || 'bi-folder';
                },
                
                focusOnCategory(categoryId) {
                    // Start practice focused on this category
                    console.log('🎯 Starting category focus practice:', categoryId);
                    
                    fetch(`/api/individual-plan/focus-category/${categoryId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            console.log('✅ Category practice started:', data);
                            // Redirect to practice
                            window.location.href = data.redirect_url;
                        } else {
                            alert('Error: ' + (data.error || 'Unknown error'));
                            console.error('❌ Failed to start category practice:', data);
                        }
                    })
                    .catch(err => {
                        alert('Error starting practice: ' + err.message);
                        console.error('❌ Category focus error:', err);
                    });
                },
                
                async loadIndividualPlanData() {
                    try {
                        // Fetch daily tasks with rate limit handling
                        const tasksResponse = await fetch('/api/individual-plan/daily-tasks');
                        if (tasksResponse.status === 429) {
                            console.warn('Rate limit exceeded for daily tasks, retrying in 1 second...');
                            setTimeout(() => this.loadIndividualPlanData(), 1000);
                            return;
                        }
                        const tasksData = await tasksResponse.json();
                        this.dailyTasks = tasksData.tasks;
                        
                        // Add small delay between API calls to prevent rate limiting
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        // Fetch progress summary with rate limit handling
                        const progressResponse = await fetch('/api/individual-plan/progress');
                        if (progressResponse.status === 429) {
                            console.warn('Rate limit exceeded for progress, retrying in 1 second...');
                            setTimeout(() => this.loadIndividualPlanData(), 1000);
                            return;
                        }
                        const progressData = await progressResponse.json();
                        
                        // Get questions_today from progressData (it has the correct count)
                        this.questionsToday = progressData.questions_today || 0;
                        
                        if (Object.prototype.hasOwnProperty.call(progressData, 'diagnostic_completed')) {
                            this.diagnosticCompleted = Boolean(progressData.diagnostic_completed);
                            this.diagnosticRequired = !this.diagnosticCompleted;
                        }
                        
                        this.dailyStreak = progressData.daily_streak || 0;
                        this.categories = progressData.categories || [];
                        this.overallProgress = progressData.overall_progress || 0;
                        this.timeInvested = progressData.time_invested || 0; // Store in minutes
                        this.timeInvestedHours = progressData.time_invested_hours || 0;
                        this.timeInvestedMinutes = progressData.time_invested_minutes || 0;
                        this.timeTodayHours = progressData.time_today_hours || 0;
                        this.timeTodayMinutes = progressData.time_today_minutes || 0;
                        this.retentionRate = Math.round(progressData.retention_rate || 0);
                        
                        // Mark data as loaded
                        this.individualPlanDataLoaded = true;
                        
                        // Check for celebrations after data is loaded
                        this.$nextTick(() => {
                            this.checkForCelebrations();
                        });
                    } catch (error) {
                        console.error('Error loading Individual Plan data:', error);
                        // Even on error, mark as loaded to prevent infinite waiting
                        this.individualPlanDataLoaded = true;
                    }
                },
                
                // Progress tab methods
                async loadProgressData() {
                    // Защита от множественных одновременных вызовов
                    if (this.isLoadingProgress) {
                        console.log('⏳ Progress data is already loading, skipping...');
                        return;
                    }
                    
                    this.isLoadingProgress = true;
                    
                    // Таймаут для защиты от зависших запросов (10 секунд)
                    const timeoutId = setTimeout(() => {
                        if (this.isLoadingProgress) {
                            console.warn('⏱️ Progress data loading timeout, resetting flag...');
                            this.isLoadingProgress = false;
                            this.showNotification('Loading timeout. Please try again.', 'warning');
                        }
                    }, 10000);
                    
                    try {
                        // Fetch progress data с таймаутом
                        const controller = new AbortController();
                        const fetchTimeout = setTimeout(() => controller.abort(), 8000); // 8 секунд на запрос
                        
                        const response = await fetch('/api/individual-plan/progress', {
                            signal: controller.signal
                        });
                        
                        clearTimeout(fetchTimeout);
                        clearTimeout(timeoutId);
                        
                        // Проверяем статус ответа
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        
                        console.log('📊 Progress data loaded:', data);
                        
                        // ✅ Обновить Alpine.js состояние
                        this.progressData = data;
                        this.completedLessons = data.completed_lessons || 0;
                        this.totalXp = data.total_xp || 0;
                        this.currentStreak = data.current_streak || 0;
                        this.progressPercent = data.overall_progress || 0;
                        
                        // Update progress metrics
                        this.totalQuestionsAnswered = data.questions_total || data.questions_today || 0; // Use questions_total for all questions, fallback to questions_today
                        this.recentSessions = data.recent_sessions || [];
                        this.last30Days = data.activity_last_30_days || this.generateLast30Days();
                        
                        console.log('📊 Last30Days data:', this.last30Days);
                        console.log('📊 Last30Days length:', this.last30Days.length);
                        
                        // Also update Individual Plan data for consistency
                        this.dailyStreak = data.daily_streak || 0;
                        this.categories = data.categories || [];
                        this.overallProgress = data.overall_progress || 0;
                        
                        // Initialize category progress data
                        if (data.category_progress) {
                            if (!this.progressData) {
                                this.progressData = {};
                            }
                            this.progressData.category_progress = data.category_progress;
                        }
                        
                        this.timeInvested = data.time_invested || 0; // Store in minutes
                        this.timeInvestedHours = data.time_invested_hours || 0;
                        this.timeInvestedMinutes = data.time_invested_minutes || 0;
                        this.timeTodayHours = data.time_today_hours || 0;
                        this.timeTodayMinutes = data.time_today_minutes || 0;
                        
                        // DEBUG: Log streak
                        console.log('🔍 DAILY STREAK DEBUG:', {
                            'data.daily_streak': data.daily_streak,
                            'this.dailyStreak': this.dailyStreak,
                            'activity_last_30_days last 3': data.activity_last_30_days?.slice(-3)
                        });
                        
                        // Update progress tab modules
                        this.modules['progress'][0].subtitle = this.overallProgress + '%';
                        this.modules['progress'][0].progress = this.overallProgress;
                        this.modules['progress'][0].completed = this.overallProgress;
                        
                        // Use questions_total for "This Week" instead of questionsToday
                        const questionsThisWeek = data.questions_total || this.questionsToday || 0;
                        this.modules['progress'][1].subtitle = questionsThisWeek + ' questions';
                        this.modules['progress'][1].progress = this.dailyProgressPercent;
                        this.modules['progress'][1].completed = questionsThisWeek;
                        this.modules['progress'][1].total = this.dailyTasks.goal;
                        
                        this.modules['progress'][2].subtitle = (this.timeInvestedHours || 0) + 'h ' + (this.timeInvestedMinutes || 0) + 'min';
                        
                    } catch (error) {
                        clearTimeout(timeoutId);
                        console.error('❌ Failed to load progress:', error);
                        
                        // Generate empty 30 days on error
                        this.last30Days = this.generateLast30Days();
                        
                        // Показываем сообщение об ошибке пользователю только если это не abort
                        if (error.name !== 'AbortError') {
                            this.showNotification(
                                'Failed to load progress data. Please try again.',
                                'error'
                            );
                        } else {
                            console.log('⏱️ Progress data fetch was aborted (timeout)');
                        }
                    } finally {
                        // Всегда сбрасываем флаг загрузки
                        this.isLoadingProgress = false;
                    }
                },
                
                generateLast30Days() {
                    // Generate last 30 days with 0 questions
                    const days = [];
                    const today = new Date();
                    for (let i = 29; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(date.getDate() - i);
                        days.push({
                            date: date.toISOString().split('T')[0],
                            questions: 0
                        });
                    }
                    return days;
                },
                
                getActivityClass(questions) {
                    if (questions === 0) return 'level-0';
                    if (questions <= 5) return 'level-1';
                    if (questions <= 10) return 'level-2';
                    if (questions <= 20) return 'level-3';
                    return 'level-4';
                },
                
                // Celebration methods
                triggerCelebration(type) {
                    // Different animations for different achievements
                    const celebrations = {
                        'streak_7': {
                            animation: '/static/animations/flame.json',
                            message: '🔥 7 {{ t("days_streak", lang)|default("days streak") }}! {{ t("you_are_on_the_right_track", lang)|default("You are on the right track!") }}'
                        },
                        'streak_14': {
                            animation: '/static/animations/fist.json',
                            message: '💪 2 {{ t("weeks_streak", lang)|default("weeks streak") }}! {{ t("amazing", lang)|default("Amazing!") }}'
                        },
                        'streak_30': {
                            animation: '/static/animations/arm.json',
                            message: '🏆 30 {{ t("days_streak", lang)|default("days streak") }}! {{ t("you_are_a_legend", lang)|default("You are a legend!") }}'
                        },
                        'goal_met': {
                            animation: '/static/animations/fist.json',
                            message: '🎯 {{ t("daily_goal_achieved", lang)|default("Daily goal achieved") }}! {{ t("well_done", lang)|default("Well done!") }}'
                        },
                        'category_complete': {
                            animation: '/static/animations/arm.json',
                            message: '✅ {{ t("category_completed", lang)|default("Category completed") }}! {{ t("perfect", lang)|default("Perfect!") }}'
                        }
                    };
                    
                    const config = celebrations[type];
                    
                    if (config) {
                        this.celebrationMessage = config.message;
                        this.showCelebration = true;
                        
                        // Load Lottie animation using lottie-player web component
                        this.$nextTick(() => {
                            const container = document.getElementById('celebration-lottie');
                            if (container) {
                                // Clear previous animation
                                container.innerHTML = '';
                                
                                // Create lottie-player element
                                const player = document.createElement('lottie-player');
                                player.setAttribute('src', config.animation);
                                player.setAttribute('background', 'transparent');
                                player.setAttribute('speed', '1');
                                player.setAttribute('loop', '');
                                player.setAttribute('autoplay', '');
                                player.style.width = '200px';
                                player.style.height = '200px';
                                
                                container.appendChild(player);
                            }
                        });
                        
                        // Auto-hide after 3 seconds
                        setTimeout(() => {
                            this.showCelebration = false;
                        }, 3000);
                    }
                },
                
                checkForCelebrations() {
                    // Check streak milestones
                    if (this.dailyStreak === 7) {
                        this.triggerCelebration('streak_7');
                    } else if (this.dailyStreak === 14) {
                        this.triggerCelebration('streak_14');
                    } else if (this.dailyStreak === 30) {
                        this.triggerCelebration('streak_30');
                    }
                },

                // ============================================================
                // VIRTUAL PATIENT FUNCTIONS
                // ============================================================
                
                vpLoading: false,
                vpSessionActive: false,
                todayVPScenario: null,
                vpStats: null,
                vpStatsDetailed: null,
                recentVPSessions: [],
                
                async loadVirtualPatientData() {
                    this.vpLoading = true;
                    try {
                        // Загрузить today's VP scenario
                        const scenarioResponse = await fetch('/api/vp/daily-scenario');
                        if (!scenarioResponse.ok) {
                            console.error('❌ VP daily-scenario request failed:', scenarioResponse.status, scenarioResponse.statusText);
                            this.todayVPScenario = null;
                            this.vpLoading = false;
                            return;
                        }
                        const scenarioData = await scenarioResponse.json();
                        
                        if (scenarioData.success && scenarioData.scenario) {
                            console.log('✅ VP scenario loaded:', scenarioData.scenario);
                            this.todayVPScenario = {
                                id: scenarioData.scenario.id,
                                title: scenarioData.scenario.title,
                                description: scenarioData.scenario.description,
                                difficulty: scenarioData.scenario.difficulty,
                                specialty: scenarioData.scenario.specialty,
                                estimated_time: scenarioData.scenario.estimated_time || 20,
                                max_score: scenarioData.scenario.max_score || 100
                            };
                        } else {
                            console.log('❌ No VP scenario available:', scenarioData.message || 'Unknown error');
                            this.todayVPScenario = null;
                        }
                        
                        // Загрузить VP статистику
                        const statsResponse = await fetch('/api/vp/my-statistics');
                        const statsData = await statsResponse.json();
                        
                        if (statsData.success && statsData.statistics) {
                            const stats = statsData.statistics;
                            this.vpStats = {
                                completed_today: stats.completed_attempts > 0 ? 1 : 0,
                                completed_week: stats.completed_attempts
                            };
                            
                            this.vpStatsDetailed = {
                                total_completed: stats.completed_attempts,
                                average_score: Math.round(stats.average_score),
                                streak: 0, // можно добавить позже в backend
                                progress_percentage: Math.round((stats.completed_attempts / 10) * 100) // assume 10 scenarios per course
                            };
                            
                            this.recentVPSessions = stats.recent_attempts || [];
                        }
                    } catch (error) {
                        console.error('Error loading VP data:', error);
                    } finally {
                        this.vpLoading = false;
                    }
                },
                
                async startVirtualPatientSession(scenarioId) {
                    // КРИТИЧНО: Проверяем диагностику перед запуском виртуальных пациентов
                    if (!this.diagnosticCompleted) {
                        alert('Для работы с виртуальными пациентами необходимо сначала пройти диагностический тест.');
                        this.startDiagnostic('quick_30');
                        return;
                    }
                    
                    try {
                        // 1. Создать attempt
                        const attemptResponse = await fetch('/api/vp/start-attempt', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ scenario_id: scenarioId })
                        });
                        
                        const attemptData = await attemptResponse.json();
                        
                        if (!attemptData.success) {
                            alert('Ошибка при начале сессии');
                            return;
                        }
                        
                        const attemptId = attemptData.attempt_id;
                        
                        // 2. Перейти на страницу диалога
                        console.log('Redirecting to dialogue page with attempt_id:', attemptId);
                        window.location.href = `/learning-map/daily-session/dialogue/${attemptId}`;
                        
                    } catch (error) {
                        console.error('Error starting VP session:', error);
                        alert('Ошибка при запуске сессии');
                    }
                },
                
                formatDate(dateString) {
                    if (!dateString) return '--';
                    const date = new Date(dateString);
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    if (date.toDateString() === today.toDateString()) {
                        return 'Vandaag';
                    } else if (date.toDateString() === yesterday.toDateString()) {
                        return 'Gisteren';
                    } else {
                        return date.toLocaleDateString('nl-NL', { month: 'short', day: 'numeric' });
                    }
                },
                
                getScoreLevel(percentage) {
                    if (percentage >= 80) return 'excellent';
                    if (percentage >= 60) return 'good';
                    if (percentage >= 40) return 'needs-improvement';
                    return 'poor';
                },
                
                // Вызвать загрузку VP данных когда открывается Individual Plan tab
                async showIndividualPlanTab() {
                    // Это вызовется когда пользователь кликнет на Individual Plan вкладку
                    this.activeTab = 'individual';
                    
                    // Загрузить VP данные если ещё не загружены
                    if (!this.vpStats) {
                        await this.loadVirtualPatientData();
                    }
                    
                    // Загрузить прогресс дня
                    await this.loadTodayProgress();
                },

                // ===== SIMPLIFIED DAILY FLOW PROPERTIES =====
                // Daily tasks from rotation (synchronized with planner)
                dailyTasksData: null,
                currentStudyDay: 1,
                
                testsCompleted: false,
                testsInProgress: false,
                testsProgress: 0,
                termsCompleted: false,
                termsInProgress: false,
                termsProgress: 0,
                vpCompleted: false,
                vpInProgress: false,
                englishCompleted: false,
                englishInProgress: false,
                memoryCompleted: false,
                memoryInProgress: false,
                todayScore: 0,
                studyTimeToday: '0 min',

                // ===== SIMPLIFIED DAILY FLOW METHODS =====
                getTodayStatus() {
                    if (this.vpCompleted) return 'completed';
                    if (this.testsInProgress || this.termsInProgress || this.vpInProgress) return 'in-progress';
                    return 'pending';
                },

                getTodayCompletionPercentage() {
                    if (!this.dailyTasksData || !this.dailyTasksData.tasks) {
                        return 0;
                    }
                    const total = this.dailyTasksData.tasks.length;
                    if (total === 0) return 0;
                    const completed = this.dailyTasksData.tasks.filter(task => this.getTaskCompleted(task.type)).length;
                    return Math.round((completed / total) * 100);
                },
                
                getTaskCompleted(taskType) {
                    switch(taskType) {
                        case 'diagnostic_test':
                        case 'big_test':
                            return this.testsCompleted;
                        case 'flashcards':
                            return this.termsCompleted;
                        case 'virtual_patient':
                            return this.vpCompleted;
                        case 'english_reading':
                            return this.englishCompleted;
                        case 'memory':
                            return this.memoryCompleted;
                        default:
                            return false;
                    }
                },
                
                getTaskInProgress(taskType) {
                    switch(taskType) {
                        case 'diagnostic_test':
                        case 'big_test':
                            return this.testsInProgress;
                        case 'flashcards':
                            return this.termsInProgress;
                        case 'virtual_patient':
                            return this.vpInProgress;
                        case 'english_reading':
                            return this.englishInProgress;
                        case 'memory':
                            return this.memoryInProgress;
                        default:
                            return false;
                    }
                },
                
                getTaskProgress(taskType) {
                    switch(taskType) {
                        case 'diagnostic_test':
                        case 'big_test':
                            return this.testsProgress;
                        case 'flashcards':
                            return this.termsProgress;
                        case 'virtual_patient':
                            return this.vpCompleted ? 1 : 0;
                        case 'english_reading':
                            return this.englishCompleted ? 1 : 0;
                        case 'memory':
                            return this.memoryCompleted ? 1 : 0;
                        default:
                            return 0;
                    }
                },
                
                getTaskProgressText(task) {
                    if (task.type === 'flashcards') {
                        return `${this.termsProgress} / ${task.target}`;
                    } else if (task.type === 'diagnostic_test' || task.type === 'big_test') {
                        return `${this.testsProgress} / ${task.target}`;
                    } else {
                        return `${this.getTaskProgress(task.type)} / ${task.target}`;
                    }
                },
                
                getTaskDescription(task) {
                    if (task.type === 'big_test') {
                        return '60 vragen uit laatste 2 weken';
                    } else if (task.type === 'diagnostic_test') {
                        return task.title.includes('Intensief') ? '20 adaptieve vragen' : '10 adaptieve vragen';
                    } else if (task.type === 'flashcards') {
                        return `${task.target} medische woorden`;
                    } else if (task.type === 'virtual_patient') {
                        return 'Praktische casus - diagnose en behandeling';
                    } else if (task.type === 'english_reading') {
                        return 'Engels lezen';
                    } else if (task.type === 'memory') {
                        return 'Memory spel';
                    }
                    return '';
                },
                
                areAllTasksCompleted() {
                    if (!this.dailyTasksData || !this.dailyTasksData.tasks) {
                        return false;
                    }
                    return this.dailyTasksData.tasks.every(task => this.getTaskCompleted(task.type));
                },

                startTask(taskType) {
                    if (taskType === 'diagnostic_test' || taskType === 'big_test') {
                        if (taskType === 'big_test') {
                            // BIG test - 60 questions
                            window.location.href = '/big-diagnostic/start?type=big_test';
                        } else {
                            // Regular diagnostic test
                            if (!this.diagnosticCompleted) {
                                this.diagnosticRequired = true;
                                return this.startDiagnostic('quick_30');
                            }
                            window.location.href = '/learning-map/daily-session';
                        }
                    } else if (taskType === 'flashcards') {
                        window.location.href = '/flashcards/daily-session';
                    } else if (taskType === 'virtual_patient') {
                        this.startVirtualPatient();
                    } else if (taskType === 'english_reading') {
                        window.location.href = '/english/practice';
                    } else if (taskType === 'memory') {
                        window.location.href = '/games/memory?auto_start=true';
                    }
                },

                async startOrContinueTests() {
                    if (!this.diagnosticCompleted) {
                        this.diagnosticRequired = true;
                        return this.startDiagnostic('quick_30');
                    }
                    // Initialize daily session (server sets plan/session in Flask session)
                    window.location.href = '/learning-map/daily-session';
                },

                async startOrContinueTerms() {
                    // Redirect to terms/flashcards page
                    window.location.href = '/flashcards/daily-session';
                },

                async startVirtualPatient() {
                    // КРИТИЧНО: Проверяем диагностику перед запуском виртуальных пациентов
                    if (!this.diagnosticCompleted) {
                        alert('Для работы с виртуальными пациентами необходимо сначала пройти диагностический тест.');
                        this.startDiagnostic('quick_30');
                        return;
                    }
                    
                    // Start virtual patient session
                    console.log('Start VP clicked, todayVPScenario:', this.todayVPScenario);
                    
                    if (!this.todayVPScenario) {
                        console.log('No VP scenario, trying to load...');
                        await this.loadVirtualPatientData();
                    }
                    
                    if (this.todayVPScenario) {
                        console.log('Starting VP session with scenario:', this.todayVPScenario);
                        await this.startVirtualPatientSession(this.todayVPScenario.id);
                    } else {
                        console.log('Still no VP scenario available');
                        alert('Geen patiënt beschikbaar vandaag');
                    }
                },

                async repeatTests() {
                    // Reset tests and start again
                    this.testsCompleted = false;
                    this.testsInProgress = true;
                    await this.startOrContinueTests();
                },

                async repeatTerms() {
                    // Reset terms and start again
                    this.termsCompleted = false;
                    this.termsInProgress = true;
                    await this.startOrContinueTerms();
                },

                async repeatVirtualPatient() {
                    // Reset VP and start again
                    this.vpCompleted = false;
                    this.vpInProgress = true;
                    await this.startVirtualPatient();
                },

                async loadDailyTasksFromPlanner() {
                    try {
                        const response = await fetch('/api/daily-tasks');
                        if (!response.ok) {
                            console.error('Failed to load daily tasks:', response.status);
                            this.dailyTasksData = null;
                            return;
                        }
                        
                        const data = await response.json();
                        if (data.success && data.tasks && data.tasks.tasks) {
                            this.dailyTasksData = data.tasks;
                            this.currentStudyDay = data.study_day || 1;
                            
                            // Обновляем состояние задач на основе данных из планировщика
                            this.updateTasksFromPlanner(data.tasks);
                        } else {
                            // Если задачи не загружены, устанавливаем null
                            this.dailyTasksData = null;
                            console.warn('Daily tasks data is missing or invalid:', data);
                        }
                    } catch (error) {
                        console.error('Error loading daily tasks from planner:', error);
                        this.dailyTasksData = null;
                    }
                },
                
                updateTasksFromPlanner(tasksData) {
                    // Обновляем состояние задач на основе данных из планировщика
                    if (!tasksData || !tasksData.tasks) {
                        return;
                    }
                    
                    // Сбрасываем все задачи
                    this.testsCompleted = false;
                    this.testsInProgress = false;
                    this.testsProgress = 0;
                    this.termsCompleted = false;
                    this.termsInProgress = false;
                    this.termsProgress = 0;
                    this.vpCompleted = false;
                    this.vpInProgress = false;
                    this.englishCompleted = false;
                    this.englishInProgress = false;
                    this.memoryCompleted = false;
                    this.memoryInProgress = false;
                    
                    // Обновляем на основе задач из планировщика
                    tasksData.tasks.forEach((task) => {
                        if (task.type === 'diagnostic_test' || task.type === 'big_test') {
                            this.testsCompleted = task.completed || false;
                            this.testsInProgress = !task.completed && task.progress > 0;
                            this.testsProgress = task.progress || 0;
                        } else if (task.type === 'flashcards') {
                            this.termsCompleted = task.completed || false;
                            this.termsInProgress = !task.completed && task.progress > 0;
                            this.termsProgress = task.progress || 0;
                        } else if (task.type === 'virtual_patient') {
                            this.vpCompleted = task.completed || false;
                            this.vpInProgress = !task.completed && task.progress > 0;
                        } else if (task.type === 'english_reading') {
                            this.englishCompleted = task.completed || false;
                            this.englishInProgress = !task.completed && task.progress > 0;
                        } else if (task.type === 'memory') {
                            this.memoryCompleted = task.completed || false;
                            this.memoryInProgress = !task.completed && task.progress > 0;
                        }
                    });
                },

                async loadTodayProgress() {
                    try {
                        console.log('Loading today progress...');
                        const response = await fetch('/api/daily-progress');
                        console.log('Response status:', response.status);
                        
                        if (response.status === 200) {
                            const data = await response.json();
                            console.log('Response data:', data);
                            
                            if (data.success) {
                                const progress = data.progress;
                                
                                // Update test progress
                                this.testsCompleted = progress.tests.completed;
                                this.testsInProgress = progress.tests.in_progress;
                                this.testsProgress = progress.tests.progress;
                                
                                // Update terms progress
                                this.termsCompleted = progress.terms.completed;
                                this.termsInProgress = progress.terms.in_progress;
                                this.termsProgress = progress.terms.progress;
                                
                                // Update VP progress
                                this.vpCompleted = progress.virtual_patient.completed;
                                this.vpInProgress = progress.virtual_patient.in_progress;
                                
                                // Update stats
                                this.todayScore = progress.today_score;
                                this.studyTimeToday = progress.study_time;
                                
                                console.log('Progress loaded successfully:', progress);
                                
                                // После загрузки прогресса обновляем задачи из планировщика
                                await this.loadDailyTasksFromPlanner();
                            } else {
                                console.error('Failed to load progress:', data.message);
                            }
                        } else if (response.status === 401) {
                            console.log('User not authenticated, using default values');
                            // Пользователь не авторизован, используем значения по умолчанию
                        } else {
                            console.error('HTTP error:', response.status);
                        }
                    } catch (error) {
                        console.error('Error loading today progress:', error);
                    }
                }
            }
        }
    </script>
    
    <!-- JavaScript для правильной работы dropdown на мобильных -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация всех dropdown меню
            var dropdowns = document.querySelectorAll('.dropdown-toggle');
            
            dropdowns.forEach(function(dropdown) {
                dropdown.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    var menu = this.nextElementSibling;
                    var isOpen = menu.style.display === 'block';
                    
                    // Закрываем все другие меню
                    document.querySelectorAll('.dropdown-menu').forEach(function(otherMenu) {
                        if (otherMenu !== menu) {
                            otherMenu.style.display = 'none';
                        }
                    });
                    
                    // Переключаем текущее меню
                    menu.style.display = isOpen ? 'none' : 'block';
                });
            });
            
            // Закрываем меню при клике вне его
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown')) {
                    document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
                        menu.style.display = 'none';
                    });
                }
            });
            
            // Для мобильных устройств - дополнительные настройки
            function isMobile() {
                return window.innerWidth <= 767;
            }
            
            // При изменении размера экрана
            window.addEventListener('resize', function() {
                if (!isMobile()) {
                    // На десктопе возвращаем стандартное поведение
                    document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
                        menu.style.display = '';
                    });
                }
            });
            
            // Инициализация при загрузке
            if (isMobile()) {
                document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
                    menu.style.display = 'none';
                });
            }
        });
        
        // Дополнительная инициализация для карты обучения (не переопределяет base.html)
        document.addEventListener('DOMContentLoaded', function() {
            // Проверяем, что dropdowns уже инициализированы в base.html
            setTimeout(function() {
                var languageDropdown = document.getElementById('languageDropdown');
                var userDropdown = document.getElementById('userDropdown');
                
                if (languageDropdown) {
                    // Проверяем, что dropdown работает
                    if (!bootstrap.Dropdown.getInstance(languageDropdown)) {
                        new bootstrap.Dropdown(languageDropdown);
                    }
                }
                
                if (userDropdown) {
                    // Проверяем, что dropdown работает
                    if (!bootstrap.Dropdown.getInstance(userDropdown)) {
                        new bootstrap.Dropdown(userDropdown);
                    }
                }
            }, 100); // Небольшая задержка, чтобы base.html успел инициализироваться
        });
    </script>
    
    <!-- Progress Sync Script -->
    <script src="{{ url_for('static', filename='js/sync-progress.js') }}"></script>
    <script>
        // Daily Tasks Rotation Logic
        async function loadDailyTasks() {
            try {
                const response = await fetch('/api/daily-tasks');
                if (!response.ok) {
                    console.error('Failed to load daily tasks');
                    return;
                }
                const data = await response.json();
                
                const container = document.getElementById('dailyTasksContainer');
                if (!container) return;
                
                container.innerHTML = '';
                
                // Show cycle info
                const cycleInfo = document.createElement('div');
                cycleInfo.className = 'cycle-info';
                cycleInfo.innerHTML = `
                    <p class="cycle-day">Dag ${data.cycle_day} van 3</p>
                    <div class="cycle-progress">
                        <div class="cycle-progress-bar" style="width: ${data.progress}%"></div>
                    </div>
                    <p class="cycle-text">${data.progress}% voltooid</p>
                `;
                container.appendChild(cycleInfo);
                
                // Show tasks
                data.tasks.forEach(task => {
                    const taskCard = document.createElement('div');
                    taskCard.className = `task-card ${task.completed ? 'completed' : ''}`;
                    taskCard.innerHTML = `
                        <div class="task-icon">
                            <i class="bi bi-${task.icon}"></i>
                        </div>
                        <div class="task-info">
                            <h4>${task.title}</h4>
                            <p>${task.progress} / ${task.target} ${task.type === 'flashcards' ? 'termen' : task.type === 'diagnostic_test' ? 'vragen' : 'sessie'}</p>
                        </div>
                        <div class="task-status">
                            ${task.completed 
                                ? '<i class="bi bi-check-circle-fill text-success"></i>' 
                                : '<button class="btn-start-task">Start</button>'
                            }
                        </div>
                    `;
                    
                    if (!task.completed) {
                        const startBtn = taskCard.querySelector('.btn-start-task');
                        if (startBtn) {
                            startBtn.addEventListener('click', () => {
                                startTask(task.type);
                            });
                        }
                    }
                    
                    container.appendChild(taskCard);
                });
            } catch (error) {
                console.error('Error loading daily tasks:', error);
            }
        }
        
        function startTask(type) {
            const routes = {
                'diagnostic_test': '/big-diagnostic/start',
                'flashcards': '/flashcards/study',
                'virtual_patient': '/virtual-patient/daily',
                'english_reading': '/english/practice',
                'memory': '/games/memory?auto_start=true'
            };
            
            const route = routes[type];
            if (route) {
                window.location.href = route;
            } else {
                console.error('Unknown task type:', type);
            }
        }
        
        // Load daily tasks on page load (optional - uncomment to enable)
        // document.addEventListener('DOMContentLoaded', loadDailyTasks);

        // Disable debug logs on production for this page
        (function(){
        var methods = ['log','warn','error'];
        for (var i=0;i<methods.length;i++){
          try {
            (function(m){
              var original = console[m];
              console[m] = function(){ /* disabled in production */ };
            })(methods[i]);
          } catch(e) {}
        }
      })();
      
      // Planner Calendar Function
        function plannerCalendar() {
            return {
                studyDays: [],
                selectedDay: null,
                selectedDayPlan: null,
                currentCycleInfo: null,
                loading: true,
                error: null,
                
                async init() {
                    await this.loadPlans();
                },
                
                async loadPlans() {
                    this.loading = true;
                    this.error = null;
                    
                    try {
                        const response = await fetch('/api/calendar-plan/upcoming-plans?days=28');
                        if (!response.ok) {
                            throw new Error('Failed to load plans');
                        }
                        
                        const data = await response.json();
                        
                        if (data.success && data.plans) {
                            // Сохраняем информацию о текущем цикле
                            this.currentCycleInfo = data.current_cycle_info || null;
                            
                            // Преобразуем объект plans в массив и сортируем по дням
                            this.studyDays = Object.values(data.plans).sort((a, b) => a.study_day - b.study_day);
                            
                            // Устанавливаем текущий день как выбранный
                            const today = this.studyDays.find(d => d.is_today);
                            if (today) {
                                this.selectedDay = today.study_day;
                                this.selectedDayPlan = today;
                                // Обновляем глобальный state в learningMapApp
                                this.updateGlobalPlannerState(today);
                            } else {
                                // Если нет текущего дня, выбираем первый активный день
                                const firstActive = this.studyDays.find(d => !d.is_locked);
                                if (firstActive) {
                                    this.selectedDay = firstActive.study_day;
                                    this.selectedDayPlan = firstActive;
                                    this.updateGlobalPlannerState(firstActive);
                                }
                            }
                        } else {
                            this.error = data.error || 'Failed to load plans';
                        }
                    } catch (error) {
                        console.error('Error loading plans:', error);
                        this.error = 'Error loading plans. Please try again later.';
                    } finally {
                        this.loading = false;
                    }
                },
                
                selectDay(studyDay) {
                    const day = this.studyDays.find(d => d.study_day === studyDay);
                    if (day && day.is_locked) {
                        // Не позволяем выбирать заблокированные дни
                        return;
                    }
                    
                    this.selectedDay = studyDay;
                    this.selectedDayPlan = day;
                    
                    // Обновляем глобальный state в learningMapApp
                    this.updateGlobalPlannerState(this.selectedDayPlan);
                },
                
                updateGlobalPlannerState(dayPlan) {
                    // Используем событие для обновления plannerSelectedDayPlan в learningMapApp
                    try {
                        // Отправляем событие, которое будет перехвачено в learningMapApp
                        window.dispatchEvent(new CustomEvent('planner-day-selected', { detail: dayPlan }));
                    } catch (e) {
                        console.warn('Could not update global planner state:', e);
                    }
                },
                
                getTaskIcon(taskType) {
                    const icons = {
                        'diagnostic_test': 'clipboard-check',
                        'flashcards': 'card-text',
                        'virtual_patient': 'person-badge',
                        'english_reading': 'book',
                        'memory': 'bullseye',
                        'big_test': 'clipboard-check'
                    };
                    return icons[taskType] || 'circle';
                },
                
                getCycleDescription(descriptionKey) {
                    // Получаем язык из глобальной переменной или из data-атрибута
                    const lang = window.currentLang || 'nl';
                    
                    const descriptions = {
                        'nl': {
                            'cycle_basic_description': 'Basis niveau - Focus op algemene kennis en fundamentele vaardigheden',
                            'cycle_adaptive_description': 'Adaptief niveau - Focus op zwakke punten, +20% doelen',
                            'cycle_advanced_description': 'Geavanceerd niveau - Complexe taken, +50% doelen',
                            'cycle_expert_description': 'Expert niveau - Complexe cases, +100% doelen'
                        },
                        'en': {
                            'cycle_basic_description': 'Basic level - Focus on general knowledge and fundamental skills',
                            'cycle_adaptive_description': 'Adaptive level - Focus on weak areas, +20% goals',
                            'cycle_advanced_description': 'Advanced level - Complex tasks, +50% goals',
                            'cycle_expert_description': 'Expert level - Complex cases, +100% goals'
                        },
                        'ru': {
                            'cycle_basic_description': 'Базовый уровень - Фокус на общих знаниях и базовых навыках',
                            'cycle_adaptive_description': 'Адаптивный уровень - Фокус на слабых местах, +20% целей',
                            'cycle_advanced_description': 'Продвинутый уровень - Сложные задачи, +50% целей',
                            'cycle_expert_description': 'Экспертный уровень - Сложные кейсы, +100% целей'
                        }
                    };
                    
                    return descriptions[lang]?.[descriptionKey] || descriptions['en'][descriptionKey] || '';
                }
          };
      }
      
      // Make plannerCalendar available globally for Alpine.js
      if (typeof Alpine !== 'undefined') {
          Alpine.data('plannerCalendar', plannerCalendar);
      }

      // Archive Store (глобальное состояние для правой колонки)
      if (typeof Alpine !== 'undefined') {
          Alpine.store('archive', {
              stats: null
          });
      }

      // Archive Component
      function archiveComponent() {
          return {
              activeCategory: 'english',
              items: [],
              stats: null,
              loading: false,
              searchQuery: '',
              sortBy: 'date',
              sortOrder: 'desc',
              pagination: null,
              
              async init() {
                  console.log('Archive component initialized');
                  await this.loadStats();
                  await this.loadItems();
              },
              
              async loadStats() {
                  try {
                      const response = await fetch('/api/archive/stats');
                      if (response.ok) {
                          const data = await response.json();
                          if (data.success) {
                              this.stats = data.stats;
                              if (typeof Alpine !== 'undefined' && Alpine.store('archive')) {
                                  Alpine.store('archive').stats = data.stats;
                              }
                          }
                      }
                  } catch (error) {
                      console.error('Error loading archive stats:', error);
                  }
              },
              
              async loadItems() {
                  this.loading = true;
                  try {
                      const params = new URLSearchParams({
                          page: this.pagination?.page || 1,
                          per_page: 12,
                          sort_by: this.sortBy,
                          sort_order: this.sortOrder
                      });
                      
                      if (this.searchQuery) {
                          params.append('search', this.searchQuery);
                      }
                      
                      const endpoint = `/api/archive/${this.activeCategory}`;
                      const response = await fetch(`${endpoint}?${params}`);
                      
                      if (!response.ok) {
                          throw new Error('Failed to load items');
                      }
                      
                      const data = await response.json();
                      if (data.success) {
                          this.items = data.items || [];
                          this.pagination = data.pagination || null;
                      }
                  } catch (error) {
                      console.error('Error loading archive items:', error);
                      this.items = [];
                  } finally {
                      this.loading = false;
                  }
              },
              
              changePage(page) {
                  if (!this.pagination) return;
                  if (page >= 1 && page <= this.pagination.pages) {
                      this.pagination.page = page;
                      this.loadItems();
                  }
              },
              
              viewItem(item) {
                  if (item.type === 'english' && item.passage_id) {
                      window.location.href = `/english/practice?passage_id=${item.passage_id}`;
                  } else if (item.type === 'terms' && item.term_id) {
                      window.location.href = `/flashcards/study?term_id=${item.term_id}`;
                  } else if (item.type === 'tests' && item.id) {
                      window.location.href = `/big-diagnostic/results/${item.id}`;
                  } else if (item.type === 'virtual_patients' && item.scenario_id) {
                      window.location.href = `/virtual-patient/${item.scenario_id}`;
                  }
              },
              
              formatScore(item) {
                  if (item.score_percentage !== undefined) {
                      return item.score_percentage + '%';
                  } else if (item.score !== undefined) {
                      return item.score + '%';
                  } else if (item.accuracy !== undefined) {
                      return item.accuracy + '%';
                  }
                  return 'N/A';
              },
              
              getScoreClass(score) {
                  if (score >= 80) return 'score-high';
                  if (score >= 60) return 'score-medium';
                  return 'score-low';
              },
              
              getCategoryLabel() {
                  switch(this.activeCategory) {
                      case 'english': return 'English';
                      case 'terms': return 'Terms';
                      case 'tests': return 'Tests';
                      case 'virtual-patients': return 'VP';
                      default: return 'Item';
                  }
              },
              
              formatDate(dateString) {
                  if (!dateString) return 'N/A';
                  const date = new Date(dateString);
                  return date.toLocaleDateString('nl-NL', { 
                      month: 'short', 
                      day: 'numeric' 
                  });
              },
              
              formatTime(seconds) {
                  if (!seconds) return '0m';
                  const minutes = Math.floor(seconds / 60);
                  const secs = seconds % 60;
                  if (minutes > 0) {
                      return `${minutes}m`;
                  }
                  return `${secs}s`;
              }
          };
      }
      
      // Make archiveComponent available globally for Alpine.js
      if (typeof Alpine !== 'undefined') {
          Alpine.data('archiveComponent', archiveComponent);
      }
      
    </script>
</body>
</html>