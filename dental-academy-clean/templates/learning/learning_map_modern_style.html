<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{{ t('learning_map', lang)|default('Learning Map') }} - {{ t('modern_style', lang)|default('Modern Style') }}</title>
    
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Flag Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@6.6.6/css/flag-icons.min.css" />
    
    <!-- Bootstrap JS (load first) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Lottie Player Web Component -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@2.0.2/dist/lottie-player.js"></script>
    
    <!-- Alpine.js (load last) -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --secondary-color: #6366f1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow-x: hidden;
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 50%, #dbeafe 100%);
            min-height: 100vh;
            position: relative;
        }

        /* ===== МОРФИРУЮЩИЕ ФОРМЫ ===== */
        .morphing-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
            pointer-events: none;
        }

        .shape {
            position: absolute;
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            filter: blur(60px);
            opacity: 0.2;
            animation: morph 20s ease-in-out infinite;
        }

        .shape-1 {
            width: 400px;
            height: 400px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            top: -10%;
            left: -10%;
            animation-duration: 25s;
        }

        .shape-2 {
            width: 500px;
            height: 500px;
            background: linear-gradient(45deg, #4834d4, #686de0);
            top: 40%;
            right: -15%;
            animation-duration: 30s;
            animation-delay: -10s;
        }

        .shape-3 {
            width: 350px;
            height: 350px;
            background: linear-gradient(45deg, #00d2d3, #54a0ff);
            bottom: -10%;
            left: 40%;
            animation-duration: 35s;
            animation-delay: -20s;
        }

        @keyframes morph {
            0%, 100% {
                border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
                transform: translate(0, 0) rotate(0deg);
            }
            25% {
                border-radius: 70% 30% 50% 50% / 30% 30% 70% 70%;
                transform: translate(50px, 50px) rotate(90deg);
            }
            50% {
                border-radius: 50% 60% 30% 40% / 60% 30% 70% 40%;
                transform: translate(0, 100px) rotate(180deg);
            }
            75% {
                border-radius: 60% 40% 60% 40% / 70% 50% 50% 50%;
                transform: translate(-50px, 50px) rotate(270deg);
            }
        }

        /* ===== ШАПКА (идентичная оригинальной из _header.html) ===== */
        
        /* ПОЛНОЕ ПЕРЕОПРЕДЕЛЕНИЕ BOOTSTRAP СТИЛЕЙ */
        header.modern-header {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            height: 70px !important;
            min-height: 70px !important;
            max-height: 70px !important;
            z-index: 1000 !important;
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px) !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1) !important;
            display: flex !important;
            align-items: center !important;
            padding: 0 !important;
            margin: 0 !important;
            overflow: visible !important;
        }

        header.modern-header nav.navbar {
            width: 100% !important;
            height: 100% !important;
            min-height: 100% !important;
            max-height: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-wrap: nowrap !important;
        }

        header.modern-header nav.navbar .container {
            width: 100% !important;
            max-width: 1200px !important;
            height: 100% !important;
            min-height: 100% !important;
            max-height: 100% !important;
            margin: 0 auto !important;
            padding: 0 1.5rem !important;
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            flex-wrap: nowrap !important;
            flex-direction: row !important;
        }

        header.modern-header .navbar-brand {
            display: flex !important;
            align-items: center !important;
            height: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
            flex-shrink: 0 !important;
            order: 1 !important;
            text-decoration: none;
            transition: transform 0.3s ease;
        }

        header.modern-header .navbar-brand:hover {
            transform: scale(1.05);
        }

        header.modern-header .navbar-brand img {
            height: 40px !important;
            width: auto !important;
            max-height: 40px !important;
            object-fit: contain !important;
            transition: all 0.3s ease;
        }

        header.modern-header .navbar-brand:hover img {
            filter: brightness(1.1);
        }

        header.modern-header .navbar-collapse {
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            flex: 1 !important;
            height: 100% !important;
            margin: 0 1rem !important;
            flex-wrap: nowrap !important;
            flex-direction: row !important;
            order: 2 !important;
        }

        header.modern-header .navbar-nav {
            display: flex !important;
            align-items: center !important;
            flex-direction: row !important;
            height: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            list-style: none !important;
            flex-wrap: nowrap !important;
            gap: 0.5rem !important;
        }

        header.modern-header .navbar-nav .nav-item {
            display: flex !important;
            align-items: center !important;
            height: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        header.modern-header .navbar-nav .nav-link {
            display: flex !important;
            align-items: center !important;
            height: auto !important;
            padding: 0.5rem 1rem !important;
            margin: 0 !important;
            color: #64748b !important;
            text-decoration: none !important;
            border-radius: 8px !important;
            transition: all 0.3s ease !important;
            white-space: nowrap !important;
            flex-shrink: 0 !important;
            font-weight: 500;
            position: relative;
        }

        header.modern-header .navbar-nav .nav-link::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transform: translateX(-50%);
            transition: width 0.3s ease;
        }

        header.modern-header .navbar-nav .nav-link:hover {
            color: #3b82f6 !important;
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        header.modern-header .navbar-nav .nav-link:hover::before {
            width: 80%;
        }

        header.modern-header .navbar-nav .nav-link.active {
            color: #3b82f6 !important;
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        header.modern-header .navbar-nav .nav-link.active::before {
            width: 80%;
        }

        header.modern-header .navbar-actions {
            display: flex !important;
            align-items: center !important;
            height: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            gap: 0.5rem !important;
            flex-wrap: nowrap !important;
            flex-direction: row !important;
            flex-shrink: 0 !important;
        }

        header.modern-header .dropdown {
            position: relative !important;
            z-index: 9999 !important;
        }

        header.modern-header .btn,
        header.modern-header .language-btn-modern,
        header.modern-header .user-btn-modern {
            display: flex !important;
            align-items: center !important;
            height: auto !important;
            padding: 0.5rem 1rem !important;
            margin: 0 !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            border-radius: 8px !important;
            background: rgba(255, 255, 255, 0.8) !important;
            color: #333 !important;
            text-decoration: none !important;
            transition: all 0.3s ease !important;
            white-space: nowrap !important;
            flex-shrink: 0 !important;
            cursor: pointer !important;
            pointer-events: auto !important;
        }

        header.modern-header .btn:hover,
        header.modern-header .language-btn-modern:hover,
        header.modern-header .user-btn-modern:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 1) !important;
        }

        header.modern-header .dropdown-menu {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            backdrop-filter: blur(10px);
            padding: 0.5rem;
            margin-top: 0.5rem;
            animation: dropdownSlide 0.3s ease;
            min-width: 220px;
            z-index: 10000 !important;
            position: absolute !important;
            max-height: 70vh !important;
            overflow-y: auto !important;
        }
        

        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        header.modern-header .dropdown-item {
            color: #64748b;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
            text-decoration: none;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        header.modern-header .dropdown-item:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            transform: translateX(5px);
        }

        header.modern-header .dropdown-item.active {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
        }

        header.modern-header .dropdown-item.text-danger {
            color: #ef4444;
        }

        header.modern-header .dropdown-item.text-danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        header.modern-header .dropdown-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            margin-bottom: 0.5rem;
        }

        header.modern-header .dropdown-divider {
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin: 0.5rem 0;
        }

        header.modern-header .navbar-toggler {
            display: none !important;
            order: 3 !important;
            border: none;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            width: 40px;
            height: 40px;
            position: relative;
            transition: all 0.3s ease;
        }

        header.modern-header .navbar-toggler:focus {
            box-shadow: none;
        }

        header.modern-header .hamburger-line {
            display: block;
            width: 20px;
            height: 2px;
            background: #1e293b;
            margin: 4px auto;
            transition: all 0.3s ease;
            border-radius: 1px;
        }

        header.modern-header .navbar-toggler:not(.collapsed) .hamburger-line:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        header.modern-header .navbar-toggler:not(.collapsed) .hamburger-line:nth-child(2) {
            opacity: 0;
        }

        header.modern-header .navbar-toggler:not(.collapsed) .hamburger-line:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -6px);
        }

        /* Мобильные устройства */
        @media (max-width: 992px) {
            header.modern-header {
                height: 60px !important;
                min-height: 60px !important;
                max-height: 60px !important;
            }
            
            header.modern-header .navbar-brand img {
                height: 32px !important;
                max-height: 32px !important;
            }
            
            header.modern-header .navbar-toggler {
                display: block !important;
            }
            
            header.modern-header .navbar-collapse {
                position: absolute !important;
                top: 100% !important;
                left: 0 !important;
                right: 0 !important;
                background: rgba(255, 255, 255, 0.98) !important;
                backdrop-filter: blur(20px) !important;
                border-radius: 0 0 16px 16px !important;
                padding: 1rem !important;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
                flex-direction: column !important;
                align-items: stretch !important;
                height: auto !important;
                z-index: 1001 !important;
                display: none !important;
            }
            
            header.modern-header .navbar-collapse.show {
                display: flex !important;
            }
            
            header.modern-header .navbar-nav {
                flex-direction: column !important;
                width: 100% !important;
                height: auto !important;
                gap: 0.5rem !important;
            }
            
            header.modern-header .navbar-actions {
                flex-direction: column !important;
                width: 100% !important;
                height: auto !important;
                margin-top: 1rem !important;
                padding-top: 1rem !important;
                border-top: 1px solid rgba(0, 0, 0, 0.1) !important;
            }
        }

        /* ПЛАНШЕТЫ (768px - 1024px) */
        @media (min-width: 768px) and (max-width: 1024px) {
            header.modern-header {
                height: 65px !important;
            }
            
            header.modern-header .navbar-brand img {
                height: 36px !important;
            }
            
            header.modern-header .navbar-collapse {
                position: static !important;
                display: flex !important;
                flex-direction: row !important;
                background: transparent !important;
                backdrop-filter: none !important;
                border-radius: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
                height: 100% !important;
                z-index: auto !important;
            }
            
            header.modern-header .navbar-nav {
                flex-direction: row !important;
                height: 100% !important;
                gap: 0.25rem !important;
            }
            
            header.modern-header .navbar-actions {
                flex-direction: row !important;
                height: 100% !important;
                margin-top: 0 !important;
                padding-top: 0 !important;
                border-top: none !important;
                gap: 0.25rem !important;
            }
            
            header.modern-header .navbar-toggler {
                display: none !important;
            }
            
            header.modern-header .nav-link,
            header.modern-header .btn {
                padding: 0.4rem 0.8rem !important;
                font-size: 0.9rem !important;
            }
        }

        /* ТОЛЬКО ТЕЛЕФОНЫ (до 768px) */
        @media (max-width: 767px) {
            header.modern-header {
                height: 60px !important;
            }
            
            header.modern-header .navbar-brand img {
                height: 32px !important;
            }
            
            header.modern-header .navbar-toggler {
                display: block !important;
            }
            
            header.modern-header .navbar-collapse {
                position: absolute !important;
                top: 100% !important;
                left: 0 !important;
                right: 0 !important;
                background: rgba(255, 255, 255, 0.98) !important;
                backdrop-filter: blur(20px) !important;
                border-radius: 0 0 16px 16px !important;
                padding: 1rem !important;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1) !important;
                flex-direction: column !important;
                align-items: stretch !important;
                height: auto !important;
                z-index: 1001 !important;
                display: none !important;
            }
            
            header.modern-header .navbar-collapse.show {
                display: flex !important;
            }
            
            /* ИСПРАВЛЕНИЕ ДЛЯ МОБИЛЬНЫХ DROPDOWN */
            header.modern-header .dropdown-menu {
                position: static !important;
                width: 100% !important;
                margin-top: 0.5rem !important;
                border: none !important;
                box-shadow: none !important;
                max-height: none !important;
                overflow-y: visible !important;
                background: transparent !important;
                backdrop-filter: none !important;
                padding: 0 !important;
                animation: none !important;
            }
            
            /* КАСТОМНОЕ МЕНЮ ЯЗЫКОВ - ПОКАЗЫВАЕМ ВСЕ */
            header.modern-header .language-dropdown .dropdown-menu {
                position: static !important;
                width: 100% !important;
                margin-top: 0.5rem !important;
                border: none !important;
                box-shadow: none !important;
                max-height: none !important;
                overflow-y: visible !important;
                background: transparent !important;
                backdrop-filter: none !important;
                padding: 0 !important;
                animation: none !important;
            }
            
            /* ЛИШНИЕ ЯЗЫКИ НА МОБИЛЬНЫХ - ПОКАЗЫВАЕМ ВСЕ */
            header.modern-header .language-menu {
                max-height: none !important;
                overflow-y: visible !important;
                height: auto !important;
            }
            
            /* КОМПАКТНЫЕ ЭЛЕМЕНТЫ ДЛЯ МОБИЛЬНЫХ */
            header.modern-header .dropdown-item {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.85rem !important;
                margin-bottom: 0.2rem !important;
                border-radius: 6px !important;
                background: rgba(255, 255, 255, 0.9) !important;
                border: 1px solid rgba(0, 0, 0, 0.05) !important;
                display: flex !important;
                align-items: center !important;
                gap: 0.5rem !important;
            }
            
            header.modern-header .dropdown-item:hover {
                background: rgba(59, 130, 246, 0.1) !important;
                border-color: rgba(59, 130, 246, 0.2) !important;
            }
            
            header.modern-header .dropdown-item.active {
                background: linear-gradient(135deg, #3b82f6, #8b5cf6) !important;
                color: white !important;
                border-color: transparent !important;
            }
            
            /* УБИРАЕМ ОГРАНИЧЕНИЕ ВЫСОТЫ ДЛЯ МОБИЛЬНЫХ */
            header.modern-header .dropdown {
                max-height: none !important;
                overflow: visible !important;
            }
        }

        /* ===== КОНТЕЙНЕР ===== */
        .learning-map-container {
            position: relative;
            z-index: 2;
            margin-top: 70px;
            min-height: calc(100vh - 70px);
            padding: 2rem;
            max-width: 1800px;
            margin-left: auto;
            margin-right: auto;
        }

        /* ===== ПРАВИЛЬНЫЙ 2-КОЛОНОЧНЫЙ LAYOUT ===== */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            align-items: start;
        }

        /* Левая колонка */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* Правая колонка - sticky */
        .sidebar-description {
            position: sticky;
            top: 90px;
            height: fit-content;
        }

        /* Узлы на блоке (как на скриншоте) */
        .learning-tabs {
            position: relative;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 4.5rem 1.5rem 1.5rem 1.5rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-top: 50px;
        }

        .tabs-container {
            position: absolute;
            top: -42px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1.5rem;
            z-index: 10;
        }

        .tab-circle {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.4s ease;
        }

        .tab-circle:hover .circle-button {
            transform: scale(1.1);
        }

        .circle-button {
            width: 85px;
            height: 85px;
            border-radius: 50%;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s ease;
            position: relative;
        }

        .tab-circle:nth-child(1) .circle-button { background: linear-gradient(135deg, #a855f7, #6366f1); }
        .tab-circle:nth-child(2) .circle-button { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
        .tab-circle:nth-child(3) .circle-button { background: linear-gradient(135deg, #f97316, #dc2626); }
        .tab-circle:nth-child(4) .circle-button { background: linear-gradient(135deg, #ec4899, #f43f5e); }
        .tab-circle:nth-child(5) .circle-button { background: linear-gradient(135deg, #eab308, #f97316); }
        .tab-circle:nth-child(6) .circle-button { background: linear-gradient(135deg, #22c55e, #16a34a); }

        .circle-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .circle-button i {
            font-size: 2rem;
            color: white;
        }

        .circle-glow {
            position: absolute;
            inset: -15px;
            border-radius: 50%;
            opacity: 0;
            filter: blur(20px);
            transition: opacity 0.4s ease;
            z-index: -1;
        }

        .tab-circle:nth-child(1) .circle-glow { background: linear-gradient(135deg, #a855f7, #6366f1); }
        .tab-circle:nth-child(2) .circle-glow { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
        .tab-circle:nth-child(3) .circle-glow { background: linear-gradient(135deg, #f97316, #dc2626); }
        .tab-circle:nth-child(4) .circle-glow { background: linear-gradient(135deg, #ec4899, #f43f5e); }
        .tab-circle:nth-child(5) .circle-glow { background: linear-gradient(135deg, #eab308, #f97316); }
        .tab-circle:nth-child(6) .circle-glow { background: linear-gradient(135deg, #22c55e, #16a34a); }

        .tab-circle.active .circle-glow {
            opacity: 0.7;
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 0.9; }
        }

        .tab-status-badge {
            position: absolute;
            top: -3px;
            right: -3px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: #22c55e;
            border: 2px solid rgba(15, 23, 42, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .tab-status-badge i {
            font-size: 0.75rem !important;
        }

        .tab-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: #64748b;
            text-align: center;
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
        }

        .beta-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.15rem 0.4rem;
            font-size: 0.6rem;
            font-weight: 800;
            letter-spacing: 0.5px;
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
            border-radius: 8px;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
            animation: betaPulse 2s ease-in-out infinite;
        }

        @keyframes betaPulse {
            0%, 100% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.05); opacity: 1; }
        }

        .tab-circle.active .tab-label {
            color: #3b82f6;
        }

        .tab-circle.disabled {
            cursor: not-allowed;
        }

        .tab-circle.disabled .circle-button {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tab-circle.disabled:hover .circle-button {
            transform: none;
        }

        .tab-circle.disabled .circle-glow {
            opacity: 0 !important;
        }

        /* Карточки 3x2 или 4x1 для игр */
        .cards-area {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }
        
        /* Для игр - 4 карточки в ряд */
        .cards-area:has(.info-card[data-games="true"]) {
            grid-template-columns: repeat(4, 1fr);
        }

        .info-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 1.75rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            min-height: 180px;
        }

        .test-card {
            position: relative;
            overflow: hidden;
            border: none;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
        }

        .test-card .card-icon {
            background: rgba(255, 255, 255, 0.2) !important;
            color: white !important;
        }

        .test-card .play-badge {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            animation: playPulse 2s ease-in-out infinite;
        }

        @keyframes playPulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        .info-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .info-card.clickable-card {
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .info-card.clickable-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 40px rgba(59, 130, 246, 0.2);
        }

        .play-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .info-card.clickable-card:hover .play-badge {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }

        /* Banner card styles */
        .info-card.banner-card {
            min-height: 280px;
            overflow: hidden;
            position: relative;
        }

        .info-card.banner-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 50px rgba(59, 130, 246, 0.3);
        }

        .game-banner {
            transition: all 0.3s ease;
        }

        .info-card.banner-card:hover .game-banner {
            transform: scale(1.02);
        }

        /* Games banner styles */
        .games-banner {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .games-banner:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .card-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            flex-shrink: 0;
        }

        .card-icon.progress { background: linear-gradient(135deg, #3b82f6, #06b6d4); }
        .card-icon.legend { background: linear-gradient(135deg, #8b5cf6, #6366f1); }
        .card-icon.stats { background: linear-gradient(135deg, #f59e0b, #ef4444); }
        .card-icon.module { background: linear-gradient(135deg, #22c55e, #16a34a); }

        .card-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: #1e293b;
        }

        .card-subtitle {
            font-size: 0.85rem;
            color: #64748b;
        }

        .progress-percentage {
            font-weight: 700;
            color: #3b82f6;
            font-size: 1.5rem;
        }

        .progress-bar-container {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 999px;
            margin: 0.5rem 0;
        }

        .progress-bar {
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, #3b82f6, #06b6d4);
            transition: width 0.5s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: #64748b;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            color: #64748b;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .stats-row:last-child {
            border-bottom: none;
        }

        .stats-label {
            color: #64748b;
            font-size: 0.9rem;
        }

        .stats-value {
            font-weight: 700;
            color: #1e293b;
            font-size: 1.1rem;
        }

        /* Описание */
        .description-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .description-card h3 {
            color: #1e293b;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .description-card h3 i {
            font-size: 1.75rem;
            color: #3b82f6;
        }

        .description-card p {
            color: #64748b;
            line-height: 1.7;
            margin-bottom: 1rem;
        }

        .description-card h4 {
            color: #1e293b;
            font-size: 1.125rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        /* IRT Diagnostic Styles */
        .irt-actions {
            background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(59, 130, 246, 0.1);
        }

        .irt-actions .btn {
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .irt-actions .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .irt-actions .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .irt-actions .btn-outline-primary {
            border: 2px solid #3b82f6;
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        .irt-actions .btn-outline-primary:hover {
            background: #3b82f6;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .irt-actions .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .diagnostic-options h5 {
            color: #374151;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .diagnostic-options .btn small {
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .description-card ul {
            list-style: none;
            padding: 0;
        }

        .description-card ul li {
            color: #64748b;
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .description-card ul li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #22c55e;
            font-weight: bold;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .sidebar-description {
                position: static;
            }
        }

        @media (max-width: 768px) {
            /* Контейнер карты обучения */
            .learning-map-container {
                padding: 1rem;
                margin-top: 60px;
            }
            
            /* Узлы - горизонтальная прокрутка для мобильных */
            .learning-tabs {
                padding: 3rem 0 1rem 0;
                margin-top: 30px;
                overflow: visible;
            }
            
            .tabs-container {
                top: -30px;
                left: 0;
                transform: none;
                gap: 1rem;
                flex-wrap: nowrap;
                justify-content: flex-start;
                overflow-x: auto;
                overflow-y: visible;
                padding: 0 1rem 1rem 1rem;
                width: 100%;
                /* Плавная прокрутка */
                scroll-behavior: smooth;
                -webkit-overflow-scrolling: touch;
                /* Скрываем scrollbar но оставляем функциональность */
                scrollbar-width: none; /* Firefox */
                -ms-overflow-style: none; /* IE and Edge */
            }
            
            .tabs-container::-webkit-scrollbar {
                display: none; /* Chrome, Safari, Opera */
            }
            
            /* Индикатор прокрутки - убран */
            /* .learning-tabs::after {
                content: '← Свайп →';
                position: absolute;
                bottom: 0.5rem;
                left: 50%;
                transform: translateX(-50%);
                font-size: 0.7rem;
                color: #94a3b8;
                opacity: 0.6;
                pointer-events: none;
            } */
            
            .tab-circle {
                margin: 0;
                flex-shrink: 0;
            }
            
            .circle-button {
                width: 65px;
                height: 65px;
            }
            
            .circle-inner {
                width: 57px;
                height: 57px;
            }
            
            .circle-button i {
                font-size: 1.6rem;
            }
            
            .circle-glow {
                width: 75px;
                height: 75px;
            }
            
            .tab-status-badge {
                width: 22px;
                height: 22px;
                top: -5px;
                right: -5px;
            }
            
            .tab-status-badge i {
                font-size: 0.7rem !important;
            }
            
            .tab-label {
                font-size: 0.75rem;
                margin-top: 0.35rem;
                white-space: nowrap;
            }
            
            /* Карточки - одна колонка */
            .cards-area {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            /* Для игр на мобильных - 2 колонки */
            .cards-area:has(.info-card[data-games="true"]) {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .info-card {
                min-height: 150px;
            }
            
            /* Описание */
            .description-card {
                padding: 1.5rem;
            }
            
            .description-card h3 {
                font-size: 1.25rem;
            }
            
            .description-card h4 {
                font-size: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            /* Компактные узлы для маленьких экранов */
            .circle-button {
                width: 55px;
                height: 55px;
            }
            
            .circle-inner {
                width: 48px;
                height: 48px;
            }
            
            .circle-button i {
                font-size: 1.4rem;
            }
            
            .circle-glow {
                width: 65px;
                height: 65px;
            }
            
            .tab-label {
                font-size: 0.7rem;
            }
            
            .tabs-container {
                gap: 0.75rem;
            }
        }

        /* ===== INDIVIDUAL PLAN STYLES ===== */
        .individual-plan-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .plan-header h2 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #1a202c;
        }

        .streak-widget {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            padding: 12px 20px;
            border-radius: 12px;
            color: white;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        .streak-animation {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        
        .streak-info {
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .streak-icon {
            font-size: 24px;
            color: #ff6b6b;
        }

        .streak-count {
            font-size: 24px;
            font-weight: bold;
        }

        .streak-label {
            font-size: 14px;
        }

        .daily-tasks-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .daily-tasks-card h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #1a202c;
        }

        .tasks-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 20px 0;
        }

        .task-stat {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .task-icon {
            font-size: 32px;
            color: var(--primary-color, #3b82f6);
        }

        .task-info strong {
            display: block;
            font-size: 24px;
            color: #0066cc;
            font-weight: 700;
        }

        .task-info small {
            color: #6c757d;
            font-size: 0.85rem;
        }

        .daily-progress {
            margin: 20px 0;
        }

        .progress-bar {
            height: 12px;
            background: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0066cc, #4ca0ff);
            transition: width 0.3s ease;
        }

        .progress-text {
            margin-top: 8px;
            text-align: center;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .btn-large {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #0066cc, #4ca0ff);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-large:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
        }

        .categories-section {
            margin: 32px 0;
        }

        .categories-section h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #1a202c;
        }

        .categories-accordion {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .category-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .category-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .category-header:hover {
            background: #f8f9fa;
        }

        .category-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .category-icon {
            font-size: 28px;
        }

        .category-info h4 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1a202c;
        }

        .category-info small {
            color: #6c757d;
            font-size: 0.85rem;
        }

        .category-stats {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .progress-percent {
            font-size: 18px;
            font-weight: 600;
        }

        .progress-high { color: #28a745; }
        .progress-medium { color: #ffc107; }
        .progress-low { color: #dc3545; }

        .category-content {
            padding: 16px 20px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .category-progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .category-content p {
            margin: 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 32px;
        }

        .stat-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .stat-icon {
            font-size: 32px;
            color: var(--primary-color, #3b82f6);
        }

        .category-icon {
            font-size: 28px;
            color: var(--text-muted, #6c757d);
        }

        .stat-card strong {
            display: block;
            font-size: 24px;
            color: #0066cc;
            font-weight: 700;
        }

        .stat-card small {
            color: #6c757d;
            font-size: 0.85rem;
        }

        /* Mobile responsive for Individual Plan */
        @media (max-width: 768px) {
            .tasks-summary,
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .plan-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .individual-plan-container {
                padding: 15px;
            }

            .daily-tasks-card {
                padding: 20px;
            }

            .task-stat {
                padding: 12px;
            }

            .task-icon {
                font-size: 24px;
            }

            .task-info strong {
                font-size: 20px;
            }
        }

        /* ===== PROGRESS TAB STYLES ===== */
        .progress-dashboard {
            width: 100%;
            max-width: 1400px; /* Wide max-width for desktop */
            margin: 0 auto;
            padding: 20px;
        }

        .progress-header {
            margin-bottom: 32px;
        }

        .progress-header h2 {
            font-size: 32px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .subtitle {
            color: #6c757d;
            font-size: 16px;
        }

        /* Metrics Grid - RESPONSIVE */
        .metrics-grid {
            display: grid;
            gap: 16px;
            margin-bottom: 40px;
            /* Mobile: 1 column */
            grid-template-columns: 1fr;
        }

        @media (min-width: 576px) {
            .metrics-grid {
                /* Small screens: 2 columns */
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 992px) {
            .metrics-grid {
                /* Desktop: 4 columns */
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .metric-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 24px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .metric-card.primary {
            background: linear-gradient(135deg, rgba(0,102,204,0.1), white);
            border-left: 4px solid #0066cc;
        }

        .metric-card.accent {
            background: linear-gradient(135deg, rgba(255,107,107,0.1), white);
            border-left: 4px solid #ff6b6b;
        }

        .metric-card.success {
            background: linear-gradient(135deg, rgba(40,167,69,0.1), white);
            border-left: 4px solid #28a745;
        }

        .metric-card.info {
            background: linear-gradient(135deg, rgba(23,162,184,0.1), white);
            border-left: 4px solid #17a2b8;
        }

        .metric-icon i {
            font-size: 40px;
        }

        .metric-card.primary .metric-icon i { color: #0066cc; }
        .metric-card.success .metric-icon i { color: #28a745; }
        .metric-card.info .metric-icon i { color: #17a2b8; }

        .metric-info {
            display: flex;
            flex-direction: column;
        }

        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #212529;
            line-height: 1;
        }

        .metric-label {
            font-size: 14px;
            color: #6c757d;
            margin-top: 4px;
        }

        /* Categories Progress */
        .categories-progress-section {
            margin-bottom: 40px;
        }

        .categories-progress-section h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .categories-list {
            display: grid;
            gap: 16px;
            /* Mobile: 1 column */
            grid-template-columns: 1fr;
        }

        @media (min-width: 992px) {
            .categories-list {
                /* Desktop: 2 columns */
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .category-progress-item {
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }

        .category-progress-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .category-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .category-name {
            font-weight: 600;
            font-size: 16px;
        }

        .category-percentage {
            font-weight: bold;
            font-size: 18px;
        }

        .category-progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .category-meta {
            font-size: 14px;
            color: #6c757d;
        }

        /* Activity Heatmap */
        .activity-section {
            margin-bottom: 40px;
        }

        .activity-section h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .activity-heatmap {
            display: grid;
            grid-template-columns: repeat(auto-fill, 16px);
            gap: 4px;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            max-width: 100%;
        }

        @media (min-width: 992px) {
            .activity-heatmap {
                /* Desktop: bigger squares */
                grid-template-columns: repeat(auto-fill, 20px);
            }
        }

        .activity-day {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            background: #e9ecef;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        @media (min-width: 992px) {
            .activity-day {
                width: 20px;
                height: 20px;
            }
        }

        .activity-day:hover {
            transform: scale(1.2);
        }

        .activity-day.level-0 { background: #ebedf0; }
        .activity-day.level-1 { background: #c6e48b; }
        .activity-day.level-2 { background: #7bc96f; }
        .activity-day.level-3 { background: #239a3b; }
        .activity-day.level-4 { background: #196127; }

        .activity-legend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 12px;
            color: #6c757d;
        }

        .legend-colors {
            display: flex;
            gap: 4px;
        }

        .legend-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-box.level-0 { background: #ebedf0; }
        .legend-box.level-1 { background: #c6e48b; }
        .legend-box.level-2 { background: #7bc96f; }
        .legend-box.level-3 { background: #239a3b; }
        .legend-box.level-4 { background: #196127; }

        /* Sessions List */
        .sessions-section {
            margin-bottom: 40px;
        }

        .sessions-section h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .sessions-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .session-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }

        .session-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .session-icon i {
            font-size: 32px;
            color: #0066cc;
        }

        .session-info {
            flex: 1;
        }

        .session-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .session-meta {
            font-size: 14px;
            color: #6c757d;
        }

        .session-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .badge-success {
            background: rgba(40,167,69,0.1);
            color: #28a745;
        }

        .badge-warning {
            background: rgba(255,193,7,0.1);
            color: #ffc107;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .empty-state i {
            font-size: 64px;
            color: #dee2e6;
            margin-bottom: 16px;
        }

        .empty-state p {
            color: #6c757d;
            margin-bottom: 20px;
        }

        .empty-state .btn-primary {
            padding: 12px 24px;
            background: linear-gradient(135deg, #0066cc, #4ca0ff);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .empty-state .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,102,204,0.3);
        }

        /* Achievements */
        .achievements-section {
            margin-bottom: 40px;
        }

        .achievements-section h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .badges-grid {
            display: grid;
            gap: 20px;
            /* Mobile: 2 columns */
            grid-template-columns: repeat(2, 1fr);
        }

        @media (min-width: 576px) {
            .badges-grid {
                /* Tablet: 3 columns */
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 992px) {
            .badges-grid {
                /* Desktop: 4 columns */
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .badge-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.2s ease;
        }

        .badge-item:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .badge-item.locked {
            opacity: 0.4;
        }

        .badge-item.earned {
            background: linear-gradient(135deg, rgba(255,215,0,0.1), white);
            border: 2px solid #ffd700;
        }

        .badge-animation-container {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .lock-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 50%;
            backdrop-filter: blur(2px);
        }

        .lock-overlay i {
            font-size: 32px;
            color: #adb5bd;
        }

        .badge-item.earned .lock-overlay {
            display: none;
        }

        .badge-name {
            margin-top: 12px;
            font-weight: 600;
            font-size: 14px;
        }

        .badge-requirement {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }

        .badge-progress {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
        }

        /* Old badge-locked class - kept for backwards compatibility */
        .badge-locked {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 50%;
        }

        .badge-locked i {
            font-size: 32px;
            color: #adb5bd;
        }

        /* Fix for dropdown menus in header */
        .dropdown-menu {
            display: none;
        }
        
        .dropdown-menu.show {
            display: block !important;
        }
        
        .dropdown-toggle::after {
            display: none;
        }
        
        /* Ensure dropdown menus are visible when shown */
        .dropdown-menu[data-bs-popper] {
            display: block !important;
        }
        
        /* Mobile responsive for Progress tab */
        @media (max-width: 768px) {
            .progress-dashboard {
                padding: 15px;
                max-width: 600px; /* Constrain width on mobile */
            }

            .progress-header h2 {
                font-size: 24px;
            }

            .metric-card {
                padding: 16px;
            }

            .metric-value {
                font-size: 24px;
            }

            .activity-heatmap {
                grid-template-columns: repeat(auto-fill, 12px);
                gap: 3px;
                padding: 15px;
            }

            .activity-day {
                width: 12px;
                height: 12px;
            }
        }

        /* Tablet responsive */
        @media (min-width: 769px) and (max-width: 1199px) {
            .progress-dashboard {
                max-width: 900px; /* Medium width on tablet */
            }
        }

        /* ===== BEAUTIFUL MODAL STYLES ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.2s ease;
            padding: 20px;
            overflow-y: auto;
        }
        
        /* Celebration Overlay */
        .celebration-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            cursor: pointer;
        }

        .celebration-content {
            text-align: center;
            animation: scaleIn 0.5s ease;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .celebration-content h3 {
            color: white;
            font-size: 24px;
            margin-top: 20px;
            animation: fadeIn 0.5s ease 0.3s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 20px;
            color: #6c757d;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f8f9fa;
            color: #000;
        }

        .modal-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #0066cc, #4ca0ff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .modal-icon i {
            font-size: 40px;
            color: white;
        }

        .modal-card h3 {
            text-align: center;
            font-size: 28px;
            margin-bottom: 16px;
            color: #212529;
        }

        .modal-description {
            text-align: center;
            color: #6c757d;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 32px;
        }

        .modal-features {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
            padding: 24px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .feature {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            text-align: center;
        }

        .feature i {
            font-size: 28px;
            color: #0066cc;
        }

        .feature span {
            font-size: 14px;
            color: #495057;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 14px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary {
            background: #e9ecef;
            color: #495057;
        }

        .btn-secondary:hover {
            background: #dee2e6;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0066cc, #4ca0ff);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 102, 204, 0.3);
        }

        /* Mobile responsive */
        @media (max-width: 576px) {
            .modal-overlay {
                padding: 10px;
                align-items: flex-start;
                padding-top: 80px;
            }
            
            .modal-card {
                padding: 20px 15px;
                max-width: 100%;
                width: 100%;
                margin: 0;
                border-radius: 16px;
            }
            
            .modal-icon {
                width: 60px;
                height: 60px;
                margin-bottom: 16px;
            }
            
            .modal-icon i {
                font-size: 30px;
            }
            
            .modal-card h3 {
                font-size: 22px;
                margin-bottom: 12px;
            }
            
            .modal-description {
                font-size: 14px;
                margin-bottom: 20px;
            }
            
            .modal-features {
                flex-direction: column;
                gap: 12px;
                padding: 16px;
                margin-bottom: 20px;
            }
            
            .feature {
                flex-direction: row;
                justify-content: flex-start;
                text-align: left;
                gap: 12px;
            }
            
            .feature i {
                font-size: 20px;
                min-width: 20px;
            }
            
            .feature span {
                font-size: 13px;
            }
            
            .modal-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .modal-buttons button {
                padding: 12px 20px;
                font-size: 15px;
            }
        }
        
        /* Extra small screens (iPhone SE) */
        @media (max-width: 375px) {
            .modal-overlay {
                padding: 5px;
                padding-top: 70px;
            }
            
            .modal-card {
                padding: 15px 12px;
                border-radius: 12px;
            }
            
            .modal-icon {
                width: 50px;
                height: 50px;
                margin-bottom: 12px;
            }
            
            .modal-icon i {
                font-size: 24px;
            }
            
            .modal-card h3 {
                font-size: 20px;
                margin-bottom: 10px;
            }
            
            .modal-description {
                font-size: 13px;
                margin-bottom: 16px;
            }
            
            .modal-features {
                padding: 12px;
                margin-bottom: 16px;
                gap: 8px;
            }
            
            .feature {
                gap: 8px;
            }
            
            .feature i {
                font-size: 18px;
                min-width: 18px;
            }
            
            .feature span {
                font-size: 12px;
            }
            
            .modal-buttons button {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Морфирующие формы -->
    <div class="morphing-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>

    <!-- Header (идентичная оригинальной) -->
    <header class="modern-header">
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <!-- Logo -->
                <a class="navbar-brand" href="/en/">
                    <div class="logo-container">
                        <img class="logo logo-light" src="/static/images/logo.png" alt="Mentora" height="40" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div class="logo-text" style="display:none; font-size: 1.5rem; font-weight: 800; color: #1e293b;">MENTORA</div>
                    </div>
                </a>
                
                <!-- Mobile Toggle -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-controls="navbarMain" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                    <span class="hamburger-line"></span>
                </button>
                
                <!-- Navigation -->
                <div class="collapse navbar-collapse" id="navbarMain">
                    <ul class="navbar-nav me-auto">
                        <!-- Home -->
                        <li class="nav-item">
                            <a class="nav-link" href="/{{ lang }}/">{{ t('home', lang)|default('Home') }}</a>
                        </li>
                        
                        <!-- Learning Map -->
                        <li class="nav-item">
                            <a class="nav-link active" href="/{{ lang }}/learning-map">{{ t('learning_map', lang)|default('Learning Map') }}</a>
                        </li>
                        
                        <!-- Knowledge Base -->
                        <li class="nav-item">
                            <a class="nav-link" href="/{{ lang }}/knowledge-base">{{ t('knowledge_base', lang)|default('Knowledge Base') }}</a>
                        </li>
                        
                        <!-- Community -->
                        <li class="nav-item">
                            <a class="nav-link" href="/{{ lang }}/community">{{ t('community', lang)|default('Community') }}</a>
                        </li>
                        
                        <!-- About BIG -->
                        <li class="nav-item">
                            <a class="nav-link" href="/{{ lang }}/big-info">{{ t('about_big', lang)|default('About BIG') }}</a>
                        </li>
                    </ul>
                    
                    <!-- Right Side Actions -->
                    <div class="navbar-actions d-flex align-items-center">
                        <!-- Language Dropdown -->
                        <div class="dropdown me-3 language-dropdown" style="position: relative; z-index: 9999;">
                            <button class="btn language-btn-modern" 
                                    type="button" id="languageDropdown" data-bs-toggle="dropdown" aria-expanded="false"
                                    title="{{ t('language', lang)|default('Language') }}: {{ lang|upper }}">
                                <span class="language-icon"><i class="bi bi-globe2"></i></span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end language-menu" aria-labelledby="languageDropdown">
                                {% from "includes/_macros.html" import language_url %}
                                <li><a class="dropdown-item {% if lang == 'nl' %}active{% endif %}" href="{{ language_url('nl') }}"><span class="fi fi-nl me-2"></span> Nederlands{% if lang == 'nl' %} <i class="bi bi-check-lg ms-1"></i>{% endif %}</a></li>
                                <li><a class="dropdown-item {% if lang == 'en' %}active{% endif %}" href="{{ language_url('en') }}"><span class="fi fi-gb me-2"></span> English{% if lang == 'en' %} <i class="bi bi-check-lg ms-1"></i>{% endif %}</a></li>
                                <li><a class="dropdown-item {% if lang == 'es' %}active{% endif %}" href="{{ language_url('es') }}"><span class="fi fi-es me-2"></span> Español{% if lang == 'es' %} <i class="bi bi-check-lg ms-1"></i>{% endif %}</a></li>
                                <li><a class="dropdown-item {% if lang == 'pt' %}active{% endif %}" href="{{ language_url('pt') }}"><span class="fi fi-pt me-2"></span> Português{% if lang == 'pt' %} <i class="bi bi-check-lg ms-1"></i>{% endif %}</a></li>
                                <li><a class="dropdown-item {% if lang == 'uk' %}active{% endif %}" href="{{ language_url('uk') }}"><span class="fi fi-ua me-2"></span> Українська{% if lang == 'uk' %} <i class="bi bi-check-lg ms-1"></i>{% endif %}</a></li>
                                <li><a class="dropdown-item {% if lang == 'fa' %}active{% endif %}" href="{{ language_url('fa') }}"><span class="fi fi-ir me-2"></span> فارسی{% if lang == 'fa' %} <i class="bi bi-check-lg ms-1"></i>{% endif %}</a></li>
                                <li><a class="dropdown-item {% if lang == 'tr' %}active{% endif %}" href="{{ language_url('tr') }}"><span class="fi fi-tr me-2"></span> Türkçe{% if lang == 'tr' %} <i class="bi bi-check-lg ms-1"></i>{% endif %}</a></li>
                                <li><a class="dropdown-item {% if lang == 'ru' %}active{% endif %}" href="{{ language_url('ru') }}"><span class="fi fi-ru me-2"></span> Русский{% if lang == 'ru' %} <i class="bi bi-check-lg ms-1"></i>{% endif %}</a></li>
                            </ul>
                        </div>
                        
                        <!-- User Menu -->
                        <div class="dropdown" style="position: relative; z-index: 1002;">
                            <button class="btn user-btn-modern" 
                                    type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false"
                                    title="User Menu">
                                <span class="user-icon"><i class="bi bi-person-circle"></i></span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end user-dropdown" aria-labelledby="userDropdown">
                                <!-- User Info Header -->
                                <li class="dropdown-header">
                                    <i class="bi bi-person-badge fs-5 me-1"></i> <strong>{{ current_user.get_display_name() if current_user.is_authenticated else 'Dr. John Doe' }}</strong>
                                    <br>
                                    <small class="text-muted">
                                        {% if current_user.is_authenticated and current_user.profession == 'tandarts' %}
                                            {{ t('dentist', lang)|default('Dentist') }}
                                        {% elif current_user.is_authenticated and current_user.profession == 'huisarts' %}
                                            {{ t('general_practitioner', lang)|default('General Practitioner') }}
                                        {% else %}
                                            {{ t('medical_professional', lang)|default('Medical Professional') }}
                                        {% endif %}
                                    </small>
                                </li>
                                
                                <li><hr class="dropdown-divider"></li>
                                
                                <!-- Profile -->
                                <li><a class="dropdown-item" href="/en/profile">
                                    <i class="bi bi-person-gear fs-5 me-2"></i>
                                    Edit profile
                                </a></li>
                                
                                <li><hr class="dropdown-divider"></li>
                                
                                <!-- Logout -->
                                <li><a class="dropdown-item text-danger" href="{{ url_for('auth.logout', lang='en') }}">
                                    <i class="bi bi-box-arrow-right fs-5 me-2"></i>
                                    Logout
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main -->
    <div x-data="learningMapApp()" x-init="init()" class="learning-map-container">
        
        <div class="main-layout">
            
            <!-- ЛЕВАЯ КОЛОНКА: УЗЛЫ + КАРТОЧКИ -->
            <div class="left-column">
                
                <!-- Узлы на блоке -->
                <div class="learning-tabs">
                    <div class="tabs-container">
                        <!-- Individual Tab - Always Enabled (FIRST) -->
                        <div class="tab-circle" :class="{ 'active': activeTab === 'individual' }" @click="selectTab('individual')">
                            <div class="circle-button">
                                <div class="circle-glow"></div>
                                <div class="circle-inner"><i class="bi bi-person-fill"></i></div>
                                <div class="tab-status-badge" style="background: #22c55e;"><i class="bi bi-check-circle-fill"></i></div>
                            </div>
                            <div class="tab-label">
                                {{ t('individual_plan', lang)|default('Individual') }}
                                <span class="beta-badge">{{ t('beta', lang)|default('BETA') }}</span>
                            </div>
                        </div>

                        <!-- IRT Tab - Always Enabled -->
                        <div class="tab-circle" :class="{ 'active': activeTab === 'irt' }" @click="selectTab('irt')">
                            <div class="circle-button">
                                <div class="circle-glow"></div>
                                <div class="circle-inner"><i class="bi bi-cpu-fill"></i></div>
                                <div class="tab-status-badge" style="background: #22c55e;"><i class="bi bi-check-circle-fill"></i></div>
                            </div>
                            <div class="tab-label">
                                {{ t('irt', lang)|default('IRT') }}
                                <span class="beta-badge">{{ t('beta', lang)|default('BETA') }}</span>
                            </div>
                        </div>

                        <!-- Virtual Tab - Disabled until launch -->
                        <div class="tab-circle" :class="{ 'active': activeTab === 'virtual', 'disabled': !isLaunched }" @click="selectTab('virtual')">
                            <div class="circle-button" :style="!isLaunched ? 'opacity: 0.5; cursor: not-allowed;' : ''">
                                <div class="circle-glow"></div>
                                <div class="circle-inner"><i class="bi bi-people-fill"></i></div>
                                <div class="tab-status-badge" :style="!isLaunched ? 'background: #94a3b8;' : ''"><i class="bi bi-lock-fill" x-show="!isLaunched"></i><i class="bi bi-play-fill" x-show="isLaunched"></i></div>
                            </div>
                            <div class="tab-label">{{ t('virtual', lang)|default('Virtual') }}</div>
                        </div>

                        <!-- Games Tab - Always Enabled -->
                        <div class="tab-circle" :class="{ 'active': activeTab === 'games' }" @click="selectTab('games')">
                            <div class="circle-button">
                                <div class="circle-glow"></div>
                                <div class="circle-inner"><i class="bi bi-controller"></i></div>
                                <div class="tab-status-badge" style="background: #22c55e;"><i class="bi bi-check-circle-fill"></i></div>
                            </div>
                            <div class="tab-label">{{ t('games', lang)|default('Games') }}</div>
                        </div>

                        <!-- Progress Tab - Always Enabled -->
                        <div class="tab-circle" :class="{ 'active': activeTab === 'progress' }" @click="selectTab('progress')">
                            <div class="circle-button">
                                <div class="circle-glow"></div>
                                <div class="circle-inner"><i class="bi bi-graph-up"></i></div>
                            </div>
                            <div class="tab-label">{{ t('progress', lang)|default('Progress') }}</div>
                        </div>

                        <!-- Planner Tab - Disabled until launch -->
                        <div class="tab-circle" :class="{ 'active': activeTab === 'planner', 'disabled': !isLaunched }" @click="selectTab('planner')">
                            <div class="circle-button" :style="!isLaunched ? 'opacity: 0.5; cursor: not-allowed;' : ''">
                                <div class="circle-glow"></div>
                                <div class="circle-inner"><i class="bi bi-calendar-check-fill"></i></div>
                                <div class="tab-status-badge" style="background: #94a3b8;"><i class="bi bi-lock-fill"></i></div>
                            </div>
                            <div class="tab-label">{{ t('planner', lang)|default('Planner') }}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Карточки -->
                <div class="cards-area" x-show="activeTab !== 'individual'">
                    
                    <!-- IRT Test Cards -->
                    <div class="info-card test-card" x-show="activeTab === 'irt'" @click="startIRTTest(30)" style="cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <div class="card-header" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                            <div class="card-icon" style="background: rgba(255,255,255,0.2);"><i class="bi bi-lightning-charge-fill"></i></div>
                            <div>
                                <div class="card-title" style="color: white;">{{ t('quick_test', lang)|default('Quick Test') }}</div>
                                <div class="card-subtitle" style="color: rgba(255,255,255,0.9);">30 {{ t('questions', lang)|default('questions') }}</div>
                            </div>
                        </div>
                        <div style="padding: 1rem 0;">
                            <p style="margin: 0; font-size: 0.9rem; color: rgba(255,255,255,0.95);">
                                {{ t('quick_test_description', lang)|default('Fast knowledge check. Results shown at the end.') }}
                            </p>
                        </div>
                        <div class="play-badge" style="background: rgba(255,255,255,0.3);">
                            <i class="bi bi-play-circle-fill"></i>
                        </div>
                    </div>

                    <div class="info-card test-card" x-show="activeTab === 'irt'" @click="startIRTTest(60)" style="cursor: pointer; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                        <div class="card-header" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                            <div class="card-icon" style="background: rgba(255,255,255,0.2);"><i class="bi bi-speedometer2"></i></div>
                            <div>
                                <div class="card-title" style="color: white;">{{ t('full_test', lang)|default('Full Test') }}</div>
                                <div class="card-subtitle" style="color: rgba(255,255,255,0.9);">60 questions</div>
                            </div>
                        </div>
                        <div style="padding: 1rem 0;">
                            <p style="margin: 0; font-size: 0.9rem; color: rgba(255,255,255,0.95);">
                                Comprehensive assessment covering all domains.
                            </p>
                        </div>
                        <div class="play-badge" style="background: rgba(255,255,255,0.3);">
                            <i class="bi bi-play-circle-fill"></i>
                        </div>
                    </div>

                    <div class="info-card test-card" x-show="activeTab === 'irt'" @click="startLearningMode()" style="cursor: pointer; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                        <div class="card-header" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                            <div class="card-icon" style="background: rgba(255,255,255,0.2);"><i class="bi bi-book-fill"></i></div>
                            <div>
                                <div class="card-title" style="color: white;">{{ t('learning_mode', lang)|default('Learning Mode') }}</div>
                                <div class="card-subtitle" style="color: rgba(255,255,255,0.9);">30 questions with explanations</div>
                            </div>
                        </div>
                        <div style="padding: 1rem 0;">
                            <p style="margin: 0; font-size: 0.9rem; color: rgba(255,255,255,0.95);">
                                Study mode: see correct answer and explanation after each question.
                            </p>
                        </div>
                        <div class="play-badge" style="background: rgba(255,255,255,0.3);">
                            <i class="bi bi-play-circle-fill"></i>
                        </div>
                    </div>

                    <!-- Games Cards (for games tab) -->
                    <template x-for="module in displayModules" :key="module.id" x-show="activeTab === 'games'">
                        <div class="info-card" 
                             :class="{ 'clickable-card': module.url }" 
                             @click="module.url ? window.location.href = module.url : null"
                             :style="module.url ? 'cursor: pointer;' : ''"
                             data-games="true">
                            <div class="card-header">
                                <div class="card-icon module"><i :class="`bi bi-${module.icon}`"></i></div>
                                <div>
                                    <div class="card-title" x-text="module.title"></div>
                                    <div class="card-subtitle" x-text="module.subtitle"></div>
                                </div>
                            </div>
                            <div x-show="module.url" class="play-badge">
                                <i class="bi bi-play-circle-fill"></i>
                            </div>
                        </div>
                    </template>

                </div>
                
                <!-- Баннер для игр (под играми) -->
                <div x-show="activeTab === 'games'" class="games-banner" @click="window.location.href = '/games/dentist-dash'" style="
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
                    border-radius: 20px;
                    padding: 1.5rem;
                    margin-top: 2rem;
                    border: 1px solid rgba(255, 255, 255, 0.1);
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
                    position: relative;
                    overflow: hidden;
                    min-height: 120px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                ">
                    <!-- Твое изображение -->
                    <img src="/static/images/superment.png" 
                         alt="Super Mentora Banner" 
                         style="
                            width: 100%;
                            max-width: 600px;
                            height: auto;
                            border-radius: 12px;
                            cursor: pointer;
                            transition: transform 0.3s ease;
                         "
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                         onmouseover="this.style.transform='scale(1.02)'"
                         onmouseout="this.style.transform='scale(1)'">
                    
                    <!-- Fallback если изображение не найдено -->
                    <div style="display: none; width: 100%; max-width: 600px; height: 100px; background: linear-gradient(45deg, #0a0a0a 0%, #1a0a0a 50%, #2a0a00 100%); border: 2px solid #444; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-family: 'Courier New', monospace; color: #fff; text-align: center; padding: 1rem;">
                        <div>
                            <div style="font-size: 14px; font-weight: bold; margin-bottom: 0.5rem;">
                                <span style="color: #ff0000; font-style: italic;">SUPER</span>
                                <span style="margin: 0 8px; color: #fff;">MENTORA</span>
                            </div>
                            <div style="font-size: 10px; line-height: 1.2;">
                                Epic 8-bit platformer with Mario & Contra gameplay!<br>
                                Jump, dash, shoot, explore caves with lava & bats!<br>
                                Features RAMBO character in jungle mode! 💪
                            </div>
                        </div>
                    </div>
                </div>

                <!-- INDIVIDUAL PLAN TAB CONTENT -->
                <div x-show="activeTab === 'individual'" class="individual-plan-container">
                    
                    <!-- Header with Streak -->
                    <div class="plan-header">
                        <h2>{{ t('daily_study_plan', lang)|default('Your Daily Study Plan') }}</h2>
                        <div class="streak-widget">
                            <!-- Animated fire icon with Lottie -->
                            <div class="streak-animation">
                                <lottie-player
                                    x-show="dailyStreak > 0"
                                    src="{{ url_for('static', filename='animations/flame.json') }}"
                                    background="transparent"
                                    speed="1"
                                    style="width: 48px; height: 48px;"
                                    loop
                                    autoplay>
                                </lottie-player>
                                <i x-show="dailyStreak === 0" 
                                   class="bi bi-fire streak-icon" 
                                   style="font-size: 32px; color: #ff6b6b;"></i>
                            </div>
                            <div class="streak-info">
                                <span class="streak-count" x-text="dailyStreak"></span>
                                <span class="streak-label">dagen streak</span>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Tasks Card -->
                    <div class="daily-tasks-card">
                        <h3><i class="bi bi-book"></i> Vandaag te doen</h3>
                        
                        <div class="tasks-summary">
                            <div class="task-stat">
                                <i class="bi bi-plus-circle task-icon"></i>
                                <div class="task-info">
                                    <strong x-text="dailyTasks.new_questions"></strong>
                                    <small>nieuwe vragen</small>
                                </div>
                            </div>
                            
                            <div class="task-stat">
                                <i class="bi bi-arrow-repeat task-icon"></i>
                                <div class="task-info">
                                    <strong x-text="dailyTasks.reviews_due"></strong>
                                    <small>herhalingen</small>
                                </div>
                            </div>
                            
                            <div class="task-stat">
                                <i class="bi bi-clock task-icon"></i>
                                <div class="task-info">
                                    <strong x-text="'~' + dailyTasks.estimated_time"></strong>
                                    <small>minuten</small>
                                </div>
                            </div>
                        </div>

                        <div class="daily-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" :style="'width: ' + dailyProgressPercent + '%'"></div>
                            </div>
                            <p class="progress-text" x-text="questionsToday + '/' + dailyTasks.goal + ' vragen vandaag'"></p>
                        </div>

                        <button class="btn-primary btn-large" @click="startDailySession">
                            Start dagelijkse sessie →
                        </button>
                    </div>

                    <!-- Categories Progress - MAIN FEATURE -->
                    <div class="categories-section">
                        <h3><i class="bi bi-bar-chart-fill"></i> Voortgang per categorie</h3>
                        
                        <div class="categories-accordion">
                            <template x-for="category in categories" :key="category.id">
                                <div class="category-card">
                                    <div class="category-header" @click="toggleCategory(category.id)">
                                        <div class="category-info">
                                            <i :class="'bi ' + getCategoryIcon(category.name)" class="category-icon"></i>
                                            <div>
                                                <h4 x-text="category.name"></h4>
                                                <small x-text="category.domains_count + ' domeinen'"></small>
                                            </div>
                                        </div>
                                        <div class="category-stats">
                                            <span class="progress-percent" :class="getProgressClass(category.percentage)" x-text="category.percentage + '%'"></span>
                                            <i class="bi" :class="expandedCategories.includes(category.id) ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
                                        </div>
                                    </div>
                                    
                                    <!-- Expanded content -->
                                    <div x-show="expandedCategories.includes(category.id)" class="category-content">
                                        <div class="category-progress-bar">
                                            <div class="progress-fill" 
                                                 :style="'width: ' + category.percentage + '%; background-color: ' + category.color">
                                            </div>
                                        </div>
                                        <p x-text="category.completed_domains + '/' + category.domains_count + ' domeinen voltooid'"></p>
                                        
                                        <!-- Optional: Show weak domains in this category -->
                                        <button class="btn-secondary btn-sm" @click="focusOnCategory(category.id)">
                                            Focus op deze categorie
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Overall Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <i class="bi bi-graph-up stat-icon"></i>
                            <div>
                                <strong x-text="overallProgress + '%'"></strong>
                                <small>totaal voortgang</small>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <i class="bi bi-clock-history stat-icon"></i>
                            <div>
                                <strong x-text="timeInvested"></strong>
                                <small>uur geïnvesteerd</small>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <i class="bi bi-bullseye stat-icon"></i>
                            <div>
                                <strong x-text="retentionRate + '%'"></strong>
                                <small>retentie rate</small>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Diagnostic Modal -->
                    <div x-show="showQuickDiagnosticModal" style="display: none;" class="modal-overlay" @click.self="closeModal">
                        <div class="modal-card">
                            <button class="modal-close" @click="closeModal">
                                <i class="bi bi-x-lg"></i>
                            </button>
                            
                            <div class="modal-icon">
                                <i class="bi bi-speedometer2"></i>
                            </div>
                            
                            <h3>{{ t('quick_diagnostic_test', lang)|default('Quick Diagnostic Test') }}</h3>
                            
                            <p class="modal-description">
                                {{ t('diagnostic_test_description', lang)|default('To create your personal learning plan, we first need a quick diagnostic test.') }}
                            </p>
                            
                            <div class="modal-features">
                                <div class="feature">
                                    <i class="bi bi-clock"></i>
                                    <span>20 {{ t('minutes', lang)|default('minutes') }}</span>
                                </div>
                                <div class="feature">
                                    <i class="bi bi-list-check"></i>
                                    <span>30 {{ t('questions', lang)|default('questions') }}</span>
                                </div>
                                <div class="feature">
                                    <i class="bi bi-graph-up"></i>
                                    <span>{{ t('identify_weak_points', lang)|default('Identify weak points') }}</span>
                                </div>
                            </div>
                            
                            <div class="modal-buttons">
                                <button class="btn-secondary" @click="closeModal">
                                    {{ t('later', lang)|default('Later') }}
                                </button>
                                <button class="btn-primary" @click="startQuickDiagnostic">
                                    {{ t('start_test', lang)|default('Start test') }} →
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Celebration Overlay -->
                    <div x-show="showCelebration" 
                         class="celebration-overlay" 
                         @click="showCelebration = false"
                         style="display: none;">
                        <div class="celebration-content" @click.stop>
                            <div id="celebration-lottie" style="width: 200px; height: 200px; margin: 0 auto;"></div>
                            <h3 x-text="celebrationMessage" style="margin-top: 20px;"></h3>
                        </div>
                    </div>

                </div>

                <!-- ============================================ -->
                <!-- PROGRESS TAB CONTENT -->
                <!-- ============================================ -->
                <div x-show="activeTab === 'progress'" class="progress-dashboard">
                    
                    <!-- Header with overall stats -->
                    <div class="progress-header">
                        <h2><i class="bi bi-graph-up"></i> {{ t('your_progress', lang)|default('Your Progress') }}</h2>
                        <p class="subtitle">{{ t('overview_learning_results', lang)|default('Overview of your learning results') }}</p>
                    </div>
                    
                    <!-- Key metrics cards -->
                    <div class="metrics-grid">
                        
                        <!-- Total Progress -->
                        <div class="metric-card primary">
                            <div class="metric-icon">
                                <lottie-player
                                    src="{{ url_for('static', filename='animations/arm.json') }}"
                                    background="transparent"
                                    speed="0.5"
                                    style="width: 60px; height: 60px;"
                                    loop
                                    autoplay>
                                </lottie-player>
                            </div>
                            <div class="metric-info">
                                <span class="metric-value" x-text="overallProgress + '%'"></span>
                                <span class="metric-label">{{ t('total_progress', lang)|default('Total Progress') }}</span>
                            </div>
                        </div>
                        
                        <!-- Streak -->
                        <div class="metric-card accent">
                            <div class="metric-icon">
                                <lottie-player
                                    x-show="dailyStreak > 0"
                                    src="{{ url_for('static', filename='animations/flame.json') }}"
                                    background="transparent"
                                    speed="1"
                                    style="width: 60px; height: 60px;"
                                    loop
                                    autoplay>
                                </lottie-player>
                                <i x-show="dailyStreak === 0" class="bi bi-fire" style="font-size: 40px; color: #ff6b6b;"></i>
                            </div>
                            <div class="metric-info">
                                <span class="metric-value" x-text="dailyStreak"></span>
                                <span class="metric-label">{{ t('days_streak', lang)|default('Days Streak') }}</span>
                            </div>
                        </div>
                        
                        <!-- Questions answered -->
                        <div class="metric-card success">
                            <div class="metric-icon">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                            <div class="metric-info">
                                <span class="metric-value" x-text="totalQuestionsAnswered"></span>
                                <span class="metric-label">{{ t('questions_answered', lang)|default('Questions Answered') }}</span>
                            </div>
                        </div>
                        
                        <!-- Study time -->
                        <div class="metric-card info">
                            <div class="metric-icon">
                                <i class="bi bi-clock-history"></i>
                            </div>
                            <div class="metric-info">
                                <span class="metric-value" x-text="timeInvested + 'h'"></span>
                                <span class="metric-label">{{ t('study_time', lang)|default('Study Time') }}</span>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Categories progress breakdown -->
                    <div class="categories-progress-section">
                        <h3><i class="bi bi-bar-chart-line"></i> {{ t('progress_per_category', lang)|default('Progress per Category') }}</h3>
                        
                        <div class="categories-list">
                            <template x-for="category in categories" :key="category.id">
                                <div class="category-progress-item">
                                    <div class="category-header-row">
                                        <span class="category-name" x-text="category.name"></span>
                                        <span class="category-percentage" :class="getProgressClass(category.percentage)" x-text="category.percentage + '%'"></span>
                                    </div>
                                    <div class="category-progress-bar">
                                        <div class="progress-fill" 
                                             :style="{width: category.percentage + '%', backgroundColor: category.color}">
                                        </div>
                                    </div>
                                    <div class="category-meta">
                                        <span x-text="category.completed_domains + '/' + category.domains_count + ' {{ t('completed', lang)|default('completed') }}'"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Study activity chart -->
                    <div class="activity-section">
                        <h3><i class="bi bi-calendar3"></i> {{ t('study_activity', lang)|default('Study Activity') }} ({{ t('last_30_days', lang)|default('last 30 days') }})</h3>
                        
                        <!-- Weekly activity heatmap -->
                        <div class="activity-heatmap">
                            <template x-for="day in last30Days" :key="day.date">
                                <div class="activity-day"
                                     :class="getActivityClass(day.questions)"
                                     :title="day.date + ': ' + day.questions + ' vragen'">
                                </div>
                            </template>
                        </div>
                        
                        <div class="activity-legend">
                            <span>Minder</span>
                            <div class="legend-colors">
                                <div class="legend-box level-0"></div>
                                <div class="legend-box level-1"></div>
                                <div class="legend-box level-2"></div>
                                <div class="legend-box level-3"></div>
                                <div class="legend-box level-4"></div>
                            </div>
                            <span>{{ t('more', lang)|default('More') }}</span>
                        </div>
                    </div>
                    
                    <!-- Recent sessions -->
                    <div class="sessions-section">
                        <h3><i class="bi bi-list-ul"></i> {{ t('recent_sessions', lang)|default('Recent Sessions') }}</h3>
                        
                        <div class="sessions-list">
                            <template x-for="session in recentSessions" :key="session.id">
                                <div class="session-item">
                                    <div class="session-icon">
                                        <i class="bi bi-play-circle-fill"></i>
                                    </div>
                                    <div class="session-info">
                                        <div class="session-title" x-text="session.title"></div>
                                        <div class="session-meta" x-text="session.date + ' • ' + session.questions + ' {{ t('questions', lang)|default('questions') }} • ' + session.accuracy + '% {{ t('correct', lang)|default('correct') }}'"></div>
                                    </div>
                                    <div class="session-badge" :class="session.accuracy >= 80 ? 'badge-success' : 'badge-warning'" x-text="session.accuracy + '%'"></div>
                                </div>
                            </template>
                            
                            <!-- Empty state -->
                            <div x-show="recentSessions.length === 0" class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p>{{ t('no_sessions_completed', lang)|default('No sessions completed yet') }}</p>
                                <button class="btn-primary" @click="activeTab = 'individual'">
                                    {{ t('start_first_session', lang)|default('Start your first session') }} →
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Achievement badges -->
                    <div class="achievements-section">
                        <h3><i class="bi bi-award"></i> {{ t('achievements', lang)|default('Achievements') }}</h3>
                        
                        <div class="badges-grid">
                            
                            <!-- Streak badges -->
                            <div class="badge-item" :class="dailyStreak >= 7 ? 'earned' : 'locked'">
                                <div class="badge-animation-container">
                                    <lottie-player
                                        src="{{ url_for('static', filename='animations/flame.json') }}"
                                        background="transparent"
                                        :speed="dailyStreak >= 7 ? '1' : '0.5'"
                                        :style="dailyStreak >= 7 ? 'width: 80px; height: 80px;' : 'width: 80px; height: 80px; opacity: 0.3; filter: grayscale(100%);'"
                                        loop
                                        autoplay>
                                    </lottie-player>
                                    <div x-show="dailyStreak < 7" class="lock-overlay">
                                        <i class="bi bi-lock-fill"></i>
                                    </div>
                                </div>
                                <div class="badge-name">7 {{ t('days_streak', lang)|default('days streak') }}</div>
                                <div class="badge-requirement" x-show="dailyStreak < 7" x-text="'{{ t('more', lang)|default('More') }} ' + (7 - dailyStreak) + ' {{ t('days', lang)|default('days') }}'"></div>
                            </div>
                            
                            <div class="badge-item" :class="dailyStreak >= 30 ? 'earned' : 'locked'">
                                <div class="badge-animation-container">
                                    <lottie-player
                                        src="{{ url_for('static', filename='animations/fist.json') }}"
                                        background="transparent"
                                        :speed="dailyStreak >= 30 ? '1' : '0.5'"
                                        :style="dailyStreak >= 30 ? 'width: 80px; height: 80px;' : 'width: 80px; height: 80px; opacity: 0.3; filter: grayscale(100%);'"
                                        loop
                                        autoplay>
                                    </lottie-player>
                                    <div x-show="dailyStreak < 30" class="lock-overlay">
                                        <i class="bi bi-lock-fill"></i>
                                    </div>
                                </div>
                                <div class="badge-name">30 {{ t('days_streak', lang)|default('days streak') }}</div>
                                <div class="badge-requirement" x-show="dailyStreak < 30" x-text="'{{ t('more', lang)|default('More') }} ' + (30 - dailyStreak) + ' {{ t('days', lang)|default('days') }}'"></div>
                            </div>
                            
                            <!-- Questions badges -->
                            <div class="badge-item" :class="totalQuestionsAnswered >= 100 ? 'earned' : 'locked'">
                                <div class="badge-animation-container">
                                    <lottie-player
                                        src="{{ url_for('static', filename='animations/arm.json') }}"
                                        background="transparent"
                                        :speed="totalQuestionsAnswered >= 100 ? '1' : '0.5'"
                                        :style="totalQuestionsAnswered >= 100 ? 'width: 80px; height: 80px;' : 'width: 80px; height: 80px; opacity: 0.3; filter: grayscale(100%);'"
                                        loop
                                        autoplay>
                                    </lottie-player>
                                    <div x-show="totalQuestionsAnswered < 100" class="lock-overlay">
                                        <i class="bi bi-lock-fill"></i>
                                    </div>
                                </div>
                                <div class="badge-name">100 {{ t('questions', lang)|default('questions') }}</div>
                                <div class="badge-requirement" x-show="totalQuestionsAnswered < 100" x-text="totalQuestionsAnswered + '/100 {{ t('questions', lang)|default('questions') }}'"></div>
                            </div>
                            
                            <div class="badge-item" :class="totalQuestionsAnswered >= 500 ? 'earned' : 'locked'">
                                <div class="badge-animation-container">
                                    <lottie-player
                                        src="{{ url_for('static', filename='animations/brain.json') }}"
                                        background="transparent"
                                        :speed="totalQuestionsAnswered >= 500 ? '1' : '0.5'"
                                        :style="totalQuestionsAnswered >= 500 ? 'width: 80px; height: 80px;' : 'width: 80px; height: 80px; opacity: 0.3; filter: grayscale(100%);'"
                                        loop
                                        autoplay>
                                    </lottie-player>
                                    <div x-show="totalQuestionsAnswered < 500" class="lock-overlay">
                                        <i class="bi bi-lock-fill"></i>
                                    </div>
                                </div>
                                <div class="badge-name">500 {{ t('questions', lang)|default('questions') }}</div>
                                <div class="badge-requirement" x-show="totalQuestionsAnswered < 500" x-text="totalQuestionsAnswered + '/500 {{ t('questions', lang)|default('questions') }}'"></div>
                            </div>
                            
                        </div>
                    </div>
                    
                </div>
                
            </div>
            
            <!-- ПРАВАЯ КОЛОНКА: ОПИСАНИЕ -->
            <div class="sidebar-description">
                <div class="description-card">
                    <h3>
                        <i :class="`bi bi-${getTabIcon(activeTab)}`"></i>
                        <span x-text="getTabTitle(activeTab)"></span>
                    </h3>
                    <p x-text="getTabDescription(activeTab)"></p>
                    
                    <h4>💡 {{ t('how_to_use', lang)|default('How to use') }}</h4>
                    <ul>
                        <template x-for="tip in getTabTips(activeTab)" :key="tip">
                            <li x-text="tip"></li>
                        </template>
                    </ul>
                </div>
            </div>
            
        </div>
        
    </div>

    <script>
        function learningMapApp() {
            // Launch date: October 13, 2025 00:00
            const launchDate = new Date('2025-10-13T00:00:00');
            const now = new Date();
            const isLaunched = now >= launchDate;
            
            // Получаем параметр tab из URL
            const urlParams = new URLSearchParams(window.location.search);
            const tabParam = urlParams.get('tab');
            const validTabs = ['irt', 'virtual', 'individual', 'games', 'progress', 'planner'];
            const initialTab = validTabs.includes(tabParam) ? tabParam : 'individual';
            
            return {
                activeTab: initialTab,
                isStartingDiagnostic: false,
                isLaunched: false, // ВСЕГДА false - блокируем все кроме IRT и Games
                launchDate: launchDate,
                // Enabled tabs (IRT, Individual, Progress, and Games)
                enabledTabs: ['irt', 'individual', 'progress', 'games'], // IRT, Individual Plan, Progress, и Games доступны
                // Real user statistics
                userStats: {
                    activeModules: 0,
                    totalLearningTime: '0h',
                    avgScore: 0,
                    irtTestsCompleted: 0,
                    totalLessonsCompleted: 0,
                    totalLessonsStarted: 0,
                    avgIrtScore: 0,
                    testAttempts: 0,
                    lastActivity: null
                },
                gamesStats: {
                    sudoku: { games_played: 0, best_time: null, difficulty_completed: {easy: false, medium: false, hard: false} },
                    memory: { games_played: 0, best_time: null, difficulty_completed: {easy: false, medium: false, hard: false} },
                    quiz: { games_played: 0, best_score: 0, categories_completed: [] },
                    achievements: { total: 0, completed: 0, progress: 0 },
                    leaderboard: { user_rank: null, total_users: 0, user_score: 0 }
                },
                statsLoaded: false,
                gamesStatsLoaded: false,
                
                // Individual Plan data
                dailyStreak: 0,
                dailyTasks: {
                    new_questions: 0,
                    reviews_due: 0,
                    total_tasks: 0,
                    estimated_time: 0,
                    goal: 20
                },
                questionsToday: 0,
                categories: [],
                expandedCategories: [],
                overallProgress: 0,
                timeInvested: 0,
                retentionRate: 0,
                showQuickDiagnosticModal: false,
                individualPlanDataLoaded: false,
                
                // Celebration data
                showCelebration: false,
                celebrationAnimation: '',
                celebrationMessage: '',
                
                // Progress tab data
                totalQuestionsAnswered: 0,
                recentSessions: [],
                last30Days: [],
                
                async loadUserStats() {
                    try {
                        const currentLang = document.querySelector('html').getAttribute('lang') || 'en';
                        const response = await fetch(`/${currentLang}/api/user-statistics`);
                        
                        if (!response.ok) {
                            console.error('Failed to fetch statistics:', response.status, response.statusText);
                            this.statsLoaded = true; // Mark as loaded to prevent UI issues
                            return;
                        }
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            this.userStats = {
                                activeModules: data.statistics.active_modules || 0,
                                totalLearningTime: data.statistics.total_learning_time || '0h',
                                avgScore: data.statistics.avg_score || 0,
                                irtTestsCompleted: data.statistics.irt_tests_completed || 0,
                                totalLessonsCompleted: data.statistics.total_lessons_completed || 0,
                                totalLessonsStarted: data.statistics.total_lessons_started || 0,
                                avgIrtScore: data.statistics.avg_irt_score || 0,
                                testAttempts: data.statistics.test_attempts || 0,
                                lastActivity: data.statistics.last_activity || null
                            };
                            this.statsLoaded = true;
                        }
                    } catch (error) {
                        console.error('Failed to load user statistics:', error);
                        this.statsLoaded = true; // Mark as loaded to prevent UI issues
                    }
                },
                async loadGamesStats() {
                    try {
                        const currentLang = document.querySelector('html').getAttribute('lang') || 'en';
                        const response = await fetch(`/${currentLang}/api/games-statistics`);
                        const data = await response.json();
                        
                        if (data.success) {
                            this.gamesStats = {
                                sudoku: data.statistics.games.sudoku,
                                memory: data.statistics.games.memory,
                                quiz: data.statistics.games.quiz,
                                achievements: data.statistics.achievements,
                                leaderboard: data.statistics.leaderboard
                            };
                            this.gamesStatsLoaded = true;
                        }
                    } catch (error) {
                        console.error('Failed to load games statistics:', error);
                    }
                },
                init() {
                    this.loadUserStats();
                    // Games statistics не загружаем, так как не показываем статистику игр
                    
                    // Initialize last30Days with empty data
                    this.last30Days = this.generateLast30Days();
                    
                    // Load Individual Plan data if that's the active tab
                    if (this.activeTab === 'individual') {
                        this.loadIndividualPlanData();
                    }
                },
                selectTab(tab) {
                    if (!this.enabledTabs.includes(tab)) {
                        this.showComingSoonModal(tab);
                        return;
                    }
                    this.activeTab = tab;
                    
                    // ✅ ВСЕГДА перезагружать данные при переключении
                    if (tab === 'progress') {
                        console.log('🔄 Refreshing progress data...');
                        this.loadProgressData();
                    } else if (tab === 'individual') {
                        console.log('🔄 Refreshing individual plan data...');
                        this.loadIndividualPlanData();
                    }
                },
                showComingSoonModal(tab) {
                    const tabNames = {
                        'virtual': 'Virtual Patients',
                        'individual': 'Individual Learning',
                        'progress': 'Progress Tracking',
                        'planner': 'Learning Planner'
                    };
                    
                    this.showNotification(
                        `${tabNames[tab]} is coming soon!`,
                        'info'
                    );
                },
                modules: {
                    'irt': [
                        // Модули скрыты - используем карточки тестов вместо них
                    ],
                    'virtual': [
                        { id: 4, title: 'Case #1', subtitle: 'Emergency', icon: 'heart-pulse-fill', progress: 100, completed: 5, total: 5 }
                    ],
                    'individual': [
                        // No module cards for Individual Plan - it has its own custom layout
                    ],
                    'games': [
                        { 
                            id: 7, 
                            title: 'Super Mentora', 
                            subtitle: '8-Bit Action', 
                            icon: 'controller', 
                            url: '/games/dentist-dash',
                            featured: true
                        },
                        { 
                            id: 8, 
                            title: 'Sudoku', 
                            subtitle: 'Classic', 
                            icon: 'grid-3x3-gap-fill', 
                            url: '/games/sudoku' 
                        },
                        { 
                            id: 9, 
                            title: 'Medical Memory', 
                            subtitle: 'Match Terms', 
                            icon: 'bullseye', 
                            url: '/games/memory' 
                        },
                        { 
                            id: 10, 
                            title: 'Quick Quiz', 
                            subtitle: 'Fast Questions', 
                            icon: 'lightning-charge-fill', 
                            url: '/games/quiz' 
                        }
                    ],
                    'progress': [
                        { id: 10, title: 'Overall', subtitle: 'Loading...', icon: 'graph-up', progress: 0, completed: 0, total: 100 },
                        { id: 11, title: 'This Week', subtitle: 'Loading...', icon: 'calendar-week', progress: 0, completed: 0, total: 20 },
                        { id: 12, title: 'Study Time', subtitle: 'Loading...', icon: 'clock-fill', progress: 0, completed: 0, total: 0 }
                    ],
                    'planner': [
                        { id: 13, title: 'Today', subtitle: '3 tasks', icon: 'calendar-check', progress: 66, completed: 2, total: 3 },
                        { id: 14, title: 'This Week', subtitle: '10 tasks', icon: 'calendar-week', progress: 40, completed: 4, total: 10 },
                        { id: 15, title: 'Upcoming', subtitle: 'Schedule', icon: 'calendar-event', progress: 0, completed: 0, total: 5 }
                    ]
                },
                get displayModules() { return this.modules[this.activeTab] || []; },
                get currentProgress() {
                    if (this.activeTab === 'irt') {
                        // Для IRT считаем прогресс на основе модулей
                    const mods = this.displayModules;
                        return mods.length ? Math.round(mods.reduce((s, m) => s + (typeof m.progress === 'function' ? m.progress() : m.progress), 0) / mods.length) : 0;
                    } else if (this.activeTab === 'games') {
                        // Для игр не показываем прогресс
                        return 0;
                    } else {
                        // Для остальных табов используем статические данные
                        const mods = this.displayModules;
                        return mods.length ? Math.round(mods.reduce((s, m) => s + (typeof m.progress === 'function' ? m.progress() : m.progress), 0) / mods.length) : 0;
                    }
                },
                get completedModules() { 
                    if (this.activeTab === 'irt') {
                        return this.displayModules.filter(m => (typeof m.progress === 'function' ? m.progress() : m.progress) === 100).length;
                    } else if (this.activeTab === 'games') {
                        return 0; // Не показываем статистику для игр
                    } else {
                        return this.displayModules.filter(m => (typeof m.progress === 'function' ? m.progress() : m.progress) === 100).length;
                    }
                },
                get totalModules() { 
                    if (this.activeTab === 'irt') {
                        return this.displayModules.length; // Все IRT модули
                    } else if (this.activeTab === 'games') {
                        return 3; // sudoku, memory, quiz
                    } else {
                        return this.displayModules.length;
                    }
                },
                get activeModules() { return this.displayModules.filter(m => m.progress > 0 && m.progress < 100).length; },
                get dailyProgressPercent() {
                    return Math.min(100, (this.questionsToday / this.dailyTasks.goal) * 100);
                },
                get completedTabs() {
                    // Для примера: 2 таба завершено (IRT, Virtual)
                    return 2;
                },
                getTabIcon(tab) {
                    return { 
                        'irt': 'cpu-fill', 
                        'virtual': 'people-fill', 
                        'individual': 'person-fill',
                        'games': 'controller',
                        'progress': 'graph-up',
                        'planner': 'calendar-check-fill'
                    }[tab] || 'circle';
                },
                getTabTitle(tab) {
                    return { 
                        'irt': 'IRT Adaptive Learning (Beta)', 
                        'virtual': 'Virtual Patients', 
                        'individual': 'Individual Learning',
                        'games': 'Gamification & Achievements',
                        'progress': 'Your Progress',
                        'planner': 'Learning Planner'
                    }[tab] || 'Unknown';
                },
                getTabDescription(tab) {
                    const descriptions = { 
                        'irt': '{{ t("irt_description", lang)|default("🧪 BETA: Choose your test format - Quick Test (30 questions) for rapid assessment, Full Test (60 questions) for comprehensive evaluation, or Learning Mode (30 questions with explanations) to study while testing. All tests use adaptive IRT technology.") }}',
                        'virtual': '{{ t("virtual_description", lang)|default("Practice with realistic virtual patient cases. Apply your knowledge in simulated clinical scenarios and improve your decision-making skills.") }}',
                        'individual': '{{ t("individual_description", lang)|default("Personalized learning modules tailored to your needs. Study at your own pace with comprehensive materials and interactive exercises.") }}',
                        'games': '{{ t("games_description", lang)|default("Relax and improve your cognitive skills with fun games! Play Sudoku for logic training, Medical Memory to learn terminology, or Quick Quiz for fast knowledge checks. Earn achievements and compete on the leaderboard!") }}',
                        'progress': '{{ t("progress_description", lang)|default("Track your learning journey with detailed analytics. Monitor your performance across all modules, see your study time, and identify areas for improvement.") }}',
                        'planner': '{{ t("planner_description", lang)|default("Plan your learning schedule effectively. Set daily and weekly goals, track deadlines, and stay organized with our intelligent learning planner.") }}'
                    };
                    
                    if (!this.isLaunched && !this.enabledTabs.includes(tab)) {
                        return `{{ t('feature_coming_soon', lang)|default('This feature is coming soon!') }} ${descriptions[tab] || ''}`;
                    }
                    
                    return descriptions[tab] || '';
                },
                getTabTips(tab) {
                    const tips = { 
                        'irt': ['{{ t("tip_click_test_card", lang)|default("Click on any test card to start") }}', '{{ t("tip_quick_test", lang)|default("Quick Test (30q) - fast knowledge check") }}', '{{ t("tip_full_test", lang)|default("Full Test (60q) - comprehensive assessment") }}', '{{ t("tip_learning_mode", lang)|default("Learning Mode (30q) - study with instant feedback") }}'],
                        'virtual': ['{{ t("tip_read_patient_history", lang)|default("Read patient history carefully before making decisions") }}', '{{ t("tip_multiple_scenarios", lang)|default("Each case has multiple scenarios and outcomes") }}', '{{ t("tip_review_feedback", lang)|default("Review feedback to improve your clinical reasoning") }}'],
                        'individual': ['{{ t("tip_choose_modules", lang)|default("Choose modules based on your learning goals") }}', '{{ t("tip_complete_quizzes", lang)|default("Complete quizzes to reinforce your knowledge") }}', '{{ t("tip_unlock_modules", lang)|default("Unlock new modules by progressing through the curriculum") }}'],
                        'games': ['{{ t("tip_play_sudoku", lang)|default("Play Sudoku to improve logical thinking") }}', '{{ t("tip_medical_memory", lang)|default("Medical Memory helps learn terminology quickly") }}', '{{ t("tip_quick_quiz", lang)|default("Quick Quiz tests your knowledge in seconds") }}', '{{ t("tip_earn_achievements", lang)|default("Earn achievements and climb the leaderboard") }}', '{{ t("tip_take_breaks", lang)|default("Take breaks with games to refresh your mind") }}'],
                        'progress': ['{{ t("tip_review_statistics", lang)|default("Review your statistics regularly") }}', '{{ t("tip_set_goals", lang)|default("Set weekly and monthly goals") }}', '{{ t("tip_track_time", lang)|default("Track time spent on each learning activity") }}', '{{ t("tip_identify_weak_areas", lang)|default("Identify weak areas and focus on improvement") }}'],
                        'planner': ['{{ t("tip_schedule_sessions", lang)|default("Schedule study sessions in advance") }}', '{{ t("tip_set_reminders", lang)|default("Set reminders for important deadlines") }}', '{{ t("tip_balance_activities", lang)|default("Balance different types of learning activities") }}', '{{ t("tip_review_plan", lang)|default("Review and adjust your plan weekly") }}']
                    };
                    
                    if (!this.isLaunched && !this.enabledTabs.includes(tab)) {
                        return ['{{ t("feature_coming_soon", lang)|default("This feature is coming soon") }}', '{{ t("stay_tuned", lang)|default("Stay tuned for updates") }}', '{{ t("check_back_later", lang)|default("Check back later") }}'];
                    }
                    
                    return tips[tab] || [];
                },
                async startDiagnostic(diagnosticType) {
                    if (this.isStartingDiagnostic) return;
                    
                    this.isStartingDiagnostic = true;
                    
                    try {
                        // Показываем уведомление о начале
                        const notification = this.showNotification(`{{ t('starting_diagnostic', lang)|default('Starting') }} ${diagnosticType} {{ t('diagnostic', lang)|default('diagnostic') }}...`, 'info');
                        
                        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
                        console.log('CSRF Token:', csrfToken ? 'Found' : 'Missing');
                        console.log('Diagnostic Type:', diagnosticType);
                        
                        // Отправляем запрос на сервер
                        const response = await fetch('/big-diagnostic/start', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken || ''
                            },
                            body: JSON.stringify({
                                diagnostic_type: diagnosticType
                            })
                        });
                        
                        console.log('Response status:', response.status);
                        
                        const data = await response.json();
                        console.log('Response data:', data);
                        
                        if (data.success) {
                            // Успешно запустили диагностику - перенаправляем
                            window.location.href = data.redirect_url;
                        } else if (data.error === 'active_session') {
                            // Уже есть активная сессия
                            this.showNotification('{{ t("active_diagnostic_session", lang)|default("You already have an active diagnostic session") }}', 'warning');
                            if (data.session_info) {
                                window.location.href = `/big-diagnostic/question/${data.session_info.id}`;
                            }
                        } else {
                            // Ошибка
                            console.error('Diagnostic error:', data.error, data);
                            this.showNotification(data.error || '{{ t("failed_to_start_diagnostic", lang)|default("Failed to start diagnostic") }}', 'error');
                        }
                    } catch (error) {
                        console.error('Error starting diagnostic:', error);
                        this.showNotification('{{ t("failed_to_start_diagnostic_try_again", lang)|default("Failed to start diagnostic. Please try again.") }}', 'error');
                    } finally {
                        this.isStartingDiagnostic = false;
                    }
                },
                showNotification(message, type = 'info') {
                    // Простая система уведомлений
                    const notification = document.createElement('div');
                    notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} alert-dismissible fade show position-fixed`;
                    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                    notification.innerHTML = `
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    // Автоматически скрываем через 5 секунд
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 5000);
                    
                    return notification;
                },
                startIRTTest(questionCount) {
                    // Запуск IRT теста с заданным количеством вопросов
                    console.log(`Starting IRT test with ${questionCount} questions`);
                    
                    // Определяем тип теста на основе количества вопросов
                    let diagnosticType = 'quick_30';
                    if (questionCount === 60) {
                        diagnosticType = 'full_60';
                    }
                    
                    // Запускаем тест
                    this.startDiagnostic(diagnosticType);
                },
                startLearningMode() {
                    // Запуск обучающего режима (30 вопросов с объяснениями)
                    console.log('Starting learning mode with explanations');
                    this.startDiagnostic('learning_30');
                },
                
                // Individual Plan methods
                toggleCategory(categoryId) {
                    const index = this.expandedCategories.indexOf(categoryId);
                    if (index > -1) {
                        this.expandedCategories.splice(index, 1);
                    } else {
                        this.expandedCategories.push(categoryId);
                    }
                },
                
                getProgressClass(percentage) {
                    if (percentage >= 80) return 'progress-high';
                    if (percentage >= 60) return 'progress-medium';
                    return 'progress-low';
                },
                
                async startDailySession() {
                    // If data not loaded yet, load it first
                    if (!this.individualPlanDataLoaded) {
                        await this.loadIndividualPlanData();
                    }
                    
                    // Check if user has done Quick Diagnostic
                    if (this.overallProgress === 0) {
                        // Show modal to start Quick Diagnostic first
                        this.showQuickDiagnosticModal = true;
                    } else {
                        // Has diagnostic - start daily practice with selected questions
                        window.location.href = '/learning-map/daily-session';
                    }
                },
                
                getCategoryIcon(categoryName) {
                    // Map category names to Bootstrap Icons
                    const iconMap = {
                        'Clinical Foundations': 'bi-hospital',
                        'Medical Sciences': 'bi-capsule',
                        'Diagnostics & Imaging': 'bi-gear',
                        'Basic Sciences': 'bi-mortarboard',
                        'Research & Methodology': 'bi-graph-up',
                        'Clinical Practice': 'bi-person-badge',
                        'Professional Development': 'bi-award'
                    };
                    return iconMap[categoryName] || 'bi-folder';
                },
                
                focusOnCategory(categoryId) {
                    // Start practice focused on this category
                    console.log('🎯 Starting category focus practice:', categoryId);
                    
                    fetch(`/api/individual-plan/focus-category/${categoryId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            console.log('✅ Category practice started:', data);
                            // Redirect to practice
                            window.location.href = data.redirect_url;
                        } else {
                            alert('Error: ' + (data.error || 'Unknown error'));
                            console.error('❌ Failed to start category practice:', data);
                        }
                    })
                    .catch(err => {
                        alert('Error starting practice: ' + err.message);
                        console.error('❌ Category focus error:', err);
                    });
                },
                
                startQuickDiagnostic() {
                    // Close modal and start Quick Diagnostic (30q)
                    this.showQuickDiagnosticModal = false;
                    // Redirect to Quick Test route (bypasses old template)
                    window.location.href = '/big-diagnostic/quick-test';
                },
                
                closeModal() {
                    this.showQuickDiagnosticModal = false;
                },
                
                async loadIndividualPlanData() {
                    try {
                        // Fetch daily tasks
                        const tasksResponse = await fetch('/api/individual-plan/daily-tasks');
                        const tasksData = await tasksResponse.json();
                        this.dailyTasks = tasksData.tasks;
                        
                        // Fetch progress summary
                        const progressResponse = await fetch('/api/individual-plan/progress');
                        const progressData = await progressResponse.json();
                        
                        // Get questions_today from progressData (it has the correct count)
                        this.questionsToday = progressData.questions_today || 0;
                        
                        this.dailyStreak = progressData.daily_streak || 0;
                        this.categories = progressData.categories || [];
                        this.overallProgress = progressData.overall_progress || 0;
                        this.timeInvested = Math.round((progressData.time_invested || 0) / 60); // Convert to hours
                        this.retentionRate = Math.round(progressData.retention_rate || 0);
                        
                        // Mark data as loaded
                        this.individualPlanDataLoaded = true;
                        
                        // Check for celebrations after data is loaded
                        this.$nextTick(() => {
                            this.checkForCelebrations();
                        });
                    } catch (error) {
                        console.error('Error loading Individual Plan data:', error);
                        // Even on error, mark as loaded to prevent infinite waiting
                        this.individualPlanDataLoaded = true;
                    }
                },
                
                // Progress tab methods
                async loadProgressData() {
                    try {
                        // Fetch progress data
                        const response = await fetch('/api/individual-plan/progress');
                        const data = await response.json();
                        
                        console.log('📊 Progress data loaded:', data);
                        
                        // ✅ Обновить Alpine.js состояние
                        this.progressData = data;
                        this.completedLessons = data.completed_lessons || 0;
                        this.totalXp = data.total_xp || 0;
                        this.currentStreak = data.current_streak || 0;
                        this.progressPercent = data.overall_progress || 0;
                        
                        // Update progress metrics
                        this.totalQuestionsAnswered = data.questions_total || data.questions_today || 0; // Use questions_total for all questions, fallback to questions_today
                        this.recentSessions = data.recent_sessions || [];
                        this.last30Days = data.activity_last_30_days || this.generateLast30Days();
                        
                        console.log('📊 Last30Days data:', this.last30Days);
                        console.log('📊 Last30Days length:', this.last30Days.length);
                        
                        // Also update Individual Plan data for consistency
                        this.dailyStreak = data.daily_streak || 0;
                        this.categories = data.categories || [];
                        this.overallProgress = data.overall_progress || 0;
                        this.timeInvested = data.time_invested_hours || Math.round((data.time_invested || 0) / 60); // Use hours directly or convert from minutes
                        
                        // DEBUG: Log streak
                        console.log('🔍 DAILY STREAK DEBUG:', {
                            'data.daily_streak': data.daily_streak,
                            'this.dailyStreak': this.dailyStreak,
                            'activity_last_30_days last 3': data.activity_last_30_days?.slice(-3)
                        });
                        
                        // Update progress tab modules
                        this.modules['progress'][0].subtitle = this.overallProgress + '%';
                        this.modules['progress'][0].progress = this.overallProgress;
                        this.modules['progress'][0].completed = this.overallProgress;
                        
                        // Use questions_total for "This Week" instead of questionsToday
                        const questionsThisWeek = data.questions_total || this.questionsToday || 0;
                        this.modules['progress'][1].subtitle = questionsThisWeek + ' questions';
                        this.modules['progress'][1].progress = this.dailyProgressPercent;
                        this.modules['progress'][1].completed = questionsThisWeek;
                        this.modules['progress'][1].total = this.dailyTasks.goal;
                        
                        this.modules['progress'][2].subtitle = this.timeInvested + 'h';
                        
                    } catch (error) {
                        console.error('❌ Failed to load progress:', error);
                        // Generate empty 30 days on error
                        this.last30Days = this.generateLast30Days();
                    }
                },
                
                generateLast30Days() {
                    // Generate last 30 days with 0 questions
                    const days = [];
                    const today = new Date();
                    for (let i = 29; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(date.getDate() - i);
                        days.push({
                            date: date.toISOString().split('T')[0],
                            questions: 0
                        });
                    }
                    return days;
                },
                
                getActivityClass(questions) {
                    if (questions === 0) return 'level-0';
                    if (questions <= 5) return 'level-1';
                    if (questions <= 10) return 'level-2';
                    if (questions <= 20) return 'level-3';
                    return 'level-4';
                },
                
                // Celebration methods
                triggerCelebration(type) {
                    // Different animations for different achievements
                    const celebrations = {
                        'streak_7': {
                            animation: '/static/animations/flame.json',
                            message: '🔥 7 {{ t("days_streak", lang)|default("days streak") }}! {{ t("you_are_on_the_right_track", lang)|default("You are on the right track!") }}'
                        },
                        'streak_14': {
                            animation: '/static/animations/fist.json',
                            message: '💪 2 {{ t("weeks_streak", lang)|default("weeks streak") }}! {{ t("amazing", lang)|default("Amazing!") }}'
                        },
                        'streak_30': {
                            animation: '/static/animations/arm.json',
                            message: '🏆 30 {{ t("days_streak", lang)|default("days streak") }}! {{ t("you_are_a_legend", lang)|default("You are a legend!") }}'
                        },
                        'goal_met': {
                            animation: '/static/animations/fist.json',
                            message: '🎯 {{ t("daily_goal_achieved", lang)|default("Daily goal achieved") }}! {{ t("well_done", lang)|default("Well done!") }}'
                        },
                        'category_complete': {
                            animation: '/static/animations/arm.json',
                            message: '✅ {{ t("category_completed", lang)|default("Category completed") }}! {{ t("perfect", lang)|default("Perfect!") }}'
                        }
                    };
                    
                    const config = celebrations[type];
                    
                    if (config) {
                        this.celebrationMessage = config.message;
                        this.showCelebration = true;
                        
                        // Load Lottie animation using lottie-player web component
                        this.$nextTick(() => {
                            const container = document.getElementById('celebration-lottie');
                            if (container) {
                                // Clear previous animation
                                container.innerHTML = '';
                                
                                // Create lottie-player element
                                const player = document.createElement('lottie-player');
                                player.setAttribute('src', config.animation);
                                player.setAttribute('background', 'transparent');
                                player.setAttribute('speed', '1');
                                player.setAttribute('loop', '');
                                player.setAttribute('autoplay', '');
                                player.style.width = '200px';
                                player.style.height = '200px';
                                
                                container.appendChild(player);
                            }
                        });
                        
                        // Auto-hide after 3 seconds
                        setTimeout(() => {
                            this.showCelebration = false;
                        }, 3000);
                    }
                },
                
                checkForCelebrations() {
                    // Check streak milestones
                    if (this.dailyStreak === 7) {
                        this.triggerCelebration('streak_7');
                    } else if (this.dailyStreak === 14) {
                        this.triggerCelebration('streak_14');
                    } else if (this.dailyStreak === 30) {
                        this.triggerCelebration('streak_30');
                    }
                }
            }
        }
    </script>
    
    <!-- JavaScript для правильной работы dropdown на мобильных -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Инициализация всех dropdown меню
            var dropdowns = document.querySelectorAll('.dropdown-toggle');
            
            dropdowns.forEach(function(dropdown) {
                dropdown.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    var menu = this.nextElementSibling;
                    var isOpen = menu.style.display === 'block';
                    
                    // Закрываем все другие меню
                    document.querySelectorAll('.dropdown-menu').forEach(function(otherMenu) {
                        if (otherMenu !== menu) {
                            otherMenu.style.display = 'none';
                        }
                    });
                    
                    // Переключаем текущее меню
                    menu.style.display = isOpen ? 'none' : 'block';
                });
            });
            
            // Закрываем меню при клике вне его
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown')) {
                    document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
                        menu.style.display = 'none';
                    });
                }
            });
            
            // Для мобильных устройств - дополнительные настройки
            function isMobile() {
                return window.innerWidth <= 767;
            }
            
            // При изменении размера экрана
            window.addEventListener('resize', function() {
                if (!isMobile()) {
                    // На десктопе возвращаем стандартное поведение
                    document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
                        menu.style.display = '';
                    });
                }
            });
            
            // Инициализация при загрузке
            if (isMobile()) {
                document.querySelectorAll('.dropdown-menu').forEach(function(menu) {
                    menu.style.display = 'none';
                });
            }
        });
        
        // Дополнительная инициализация для карты обучения (не переопределяет base.html)
        document.addEventListener('DOMContentLoaded', function() {
            // Проверяем, что dropdowns уже инициализированы в base.html
            setTimeout(function() {
                var languageDropdown = document.getElementById('languageDropdown');
                var userDropdown = document.getElementById('userDropdown');
                
                if (languageDropdown) {
                    // Проверяем, что dropdown работает
                    if (!bootstrap.Dropdown.getInstance(languageDropdown)) {
                        new bootstrap.Dropdown(languageDropdown);
                    }
                }
                
                if (userDropdown) {
                    // Проверяем, что dropdown работает
                    if (!bootstrap.Dropdown.getInstance(userDropdown)) {
                        new bootstrap.Dropdown(userDropdown);
                    }
                }
            }, 100); // Небольшая задержка, чтобы base.html успел инициализироваться
        });
    </script>
    
    <!-- Progress Sync Script -->
    <script src="{{ url_for('static', filename='js/sync-progress.js') }}"></script>
</body>
</html>