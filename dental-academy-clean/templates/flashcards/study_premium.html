{% extends "base.html" %}

{% block title %}Study - {{ category|title }}{% endblock %}

{% block content %}
<div class="premium-study-container" x-data="premiumFlashcardStudy()" x-cloak>
    <!-- Session Stats Header -->
    <div class="session-header">
        <div class="header-left">
            <a href="{{ url_for('flashcards.categories') }}" class="back-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </a>
            <div class="category-name">{{ category|title }}</div>
        </div>
        
        <div class="session-stats">
            <div class="stat" title="Streak">
                <span class="emoji">üî•</span>
                <span class="value" x-text="streak">0</span>
            </div>
            <div class="stat" title="Session XP">
                <span class="emoji">‚≠ê</span>
                <span class="value" x-text="'+' + sessionXP">+0</span>
            </div>
            <div class="stat progress-stat" title="Progress">
                <span class="emoji">üìä</span>
                <span class="value" x-text="currentIndex + 1 + '/' + terms.length"></span>
            </div>
        </div>
    </div>

    <!-- Progress Bar (Duolingo style) -->
    <div class="progress-bar-container">
        <div class="progress-bar">
            <div class="progress-fill" :style="{ width: (currentIndex / terms.length * 100) + '%' }"></div>
        </div>
    </div>

    <!-- Main Study Area -->
    <div class="study-area">
        {% if terms|length > 0 %}
        
        <!-- Flashcard Container -->
        <div class="flashcard-container" 
             @touchstart="startSwipe($event)" 
             @touchmove="moveSwipe($event)" 
             @touchend="endSwipe($event)"
             @mousedown="startSwipe($event)"
             @mousemove="moveSwipe($event)"
             @mouseup="endSwipe($event)"
             @mouseleave="endSwipe($event)">
            
            <!-- Card with Swipe Transform -->
            <div class="card-wrapper" :style="{ 
                transform: `translateX(${swipeOffset}px) rotateZ(${swipeOffset * 0.05}deg)`,
                opacity: 1 - Math.abs(swipeOffset) / 300
            }">
                
                <!-- Flip Card -->
                <div class="flip-card" :class="{ 'flipped': isFlipped }" @click="flipCard()">
                    <!-- Front Side (Dutch) -->
                    <div class="flip-card-front">
                        <div class="card-content">
                            <div class="language-badge">Dutch</div>
                            <p class="term" x-text="currentTerm.term_nl"></p>
                            <p class="tap-hint">üëÜ Tap to reveal</p>
                        </div>
                    </div>

                    <!-- Back Side (Translation) -->
                    <div class="flip-card-back">
                        <div class="card-content">
                            <div class="language-badge">{{ current_user.language|upper }}</div>
                            <p class="translation" x-text="currentTerm['term_' + userLanguage]"></p>
                            <p v-if="currentTerm.definition" class="definition" x-text="currentTerm.definition"></p>
                        </div>
                    </div>
                </div>

                <!-- Swipe Indicators -->
                <div class="swipe-indicators" x-show="!isFlipped">
                    <div class="indicator left" x-show="swipeOffset < -50">‚ùå Swipe to forget</div>
                    <div class="indicator right" x-show="swipeOffset > 50">‚úÖ Swipe to remember</div>
                </div>
            </div>
        </div>

        <!-- Confidence Rating Buttons (Visible when flipped) -->
        <div class="rating-buttons" x-show="isFlipped" x-transition:enter.duration.300ms>
            <button @click="submitReview(1)" class="rating-btn rating-again" 
                    @mouseenter="hoverRating = 1" 
                    @mouseleave="hoverRating = null"
                    :class="{ 'hovered': hoverRating === 1 }">
                <span class="rating-emoji">üò∞</span>
                <span class="rating-label">Again</span>
                <span class="rating-subtitle">Tomorrow</span>
            </button>

            <button @click="submitReview(2)" class="rating-btn rating-hard" 
                    @mouseenter="hoverRating = 2" 
                    @mouseleave="hoverRating = null"
                    :class="{ 'hovered': hoverRating === 2 }">
                <span class="rating-emoji">üòê</span>
                <span class="rating-label">Hard</span>
                <span class="rating-subtitle">3 days</span>
            </button>

            <button @click="submitReview(3)" class="rating-btn rating-good" 
                    @mouseenter="hoverRating = 3" 
                    @mouseleave="hoverRating = null"
                    :class="{ 'hovered': hoverRating === 3 }">
                <span class="rating-emoji">üòä</span>
                <span class="rating-label">Good</span>
                <span class="rating-subtitle">1 week</span>
            </button>

            <button @click="submitReview(4)" class="rating-btn rating-easy" 
                    @mouseenter="hoverRating = 4" 
                    @mouseleave="hoverRating = null"
                    :class="{ 'hovered': hoverRating === 4 }">
                <span class="rating-emoji">ü§©</span>
                <span class="rating-label">Easy</span>
                <span class="rating-subtitle">2 weeks</span>
            </button>
        </div>

        <!-- Keyboard Hints -->
        <div class="keyboard-hints">
            <p>‚å®Ô∏è Keyboard: <kbd>SPACE</kbd> Flip | <kbd>1</kbd><kbd>2</kbd><kbd>3</kbd><kbd>4</kbd> Rate</p>
        </div>

        {% else %}
        <div class="empty-state">
            <div class="empty-icon">üìö</div>
            <h2>No terms available</h2>
            <a href="{{ url_for('flashcards.categories') }}" class="btn btn-primary">Back to Categories</a>
        </div>
        {% endif %}
    </div>

    <!-- Particles Container -->
    <div class="particles-container"></div>

    <!-- Session Complete Modal -->
    <div class="session-modal" x-show="sessionComplete" x-cloak @click.self="closeSession()">
        <div class="modal-content" x-transition:enter.scale.origin.center.duration.300ms>
            <div class="modal-header">
                <div class="celebration-emoji">üéâ</div>
                <h2>Session Complete!</h2>
            </div>

            <div class="session-stats-grid">
                <div class="stat-card">
                    <div class="stat-emoji">‚úÖ</div>
                    <div class="stat-label">Reviewed</div>
                    <div class="stat-value" x-text="termsStudied"></div>
                </div>

                <div class="stat-card">
                    <div class="stat-emoji">‚≠ê</div>
                    <div class="stat-label">XP Earned</div>
                    <div class="stat-value" x-text="sessionXP"></div>
                </div>

                <div class="stat-card">
                    <div class="stat-emoji">üéØ</div>
                    <div class="stat-label">Accuracy</div>
                    <div class="stat-value" x-text="Math.round((correctAnswers / termsStudied * 100)) + '%'"></div>
                </div>

                <div class="stat-card">
                    <div class="stat-emoji">‚è±Ô∏è</div>
                    <div class="stat-label">Time</div>
                    <div class="stat-value" x-text="formatTime(sessionDuration)"></div>
                </div>
            </div>

            <div class="modal-actions">
                <a href="{{ url_for('flashcards.categories') }}" class="btn btn-secondary">
                    Back to Categories
                </a>
                <button @click="continueSession()" class="btn btn-primary">
                    Continue Learning
                </button>
            </div>
        </div>
    </div>

    <!-- Feedback Toast -->
    <div class="feedback-toast" x-show="showFeedback" x-cloak :class="'feedback-' + feedbackType">
        <span x-text="feedbackMessage"></span>
    </div>
</div>

<script>
function premiumFlashcardStudy() {
    return {
        // Data
        terms: {{ terms|tojson|safe }},
        userLanguage: '{{ current_user.language or "en" }}',
        currentIndex: 0,
        isFlipped: false,
        sessionXP: 0,
        sessionComplete: false,
        termsStudied: 0,
        correctAnswers: 0,
        streak: 0,
        
        // Swipe
        swipeOffset: 0,
        swipeStart: 0,
        swiping: false,
        
        // Feedback
        showFeedback: false,
        feedbackMessage: '',
        feedbackType: 'success',
        hoverRating: null,
        
        // Timing
        sessionStart: Date.now(),
        sessionDuration: 0,

        get currentTerm() {
            return this.terms[this.currentIndex] || {};
        },

        flipCard() {
            if (!this.swiping) {
                this.isFlipped = !this.isFlipped;
                this.playSound('flip');
            }
        },

        // Swipe handlers
        startSwipe(e) {
            if (this.sessionComplete) return;
            this.swipeStart = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            this.swiping = true;
        },

        moveSwipe(e) {
            if (!this.swiping) return;
            const currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
            this.swipeOffset = currentX - this.swipeStart;
        },

        endSwipe(e) {
            if (!this.swiping) return;
            this.swiping = false;

            // Left swipe (forget)
            if (this.swipeOffset < -100) {
                this.submitReview(1);
            }
            // Right swipe (remember)
            else if (this.swipeOffset > 100) {
                this.submitReview(3);
            }
            // Reset
            else {
                this.swipeOffset = 0;
            }
        },

        async submitReview(confidence) {
            try {
                const response = await fetch(`/flashcards/review/${this.currentTerm.id}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        quality: confidence,
                        time_spent: Math.random() * 30 + 10
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Update stats
                    this.sessionXP += data.xp_earned;
                    this.termsStudied += 1;
                    if (confidence >= 3) {
                        this.correctAnswers++;
                        this.streak++;
                    } else {
                        this.streak = 0;
                    }

                    // Show feedback
                    const messages = {
                        1: "üò∞ You'll see this again tomorrow",
                        2: "üòê Got it, keep practicing",
                        3: "üòä Great job!",
                        4: "ü§© Perfect! Well done!"
                    };
                    
                    this.feedbackMessage = messages[confidence] || 'Nice!';
                    this.feedbackType = confidence >= 3 ? 'success' : 'neutral';
                    this.showFeedback = true;

                    // Animate
                    this.playSound(confidence >= 3 ? 'success' : 'neutral');
                    if (confidence >= 3) this.createParticles();

                    // Move to next
                    setTimeout(() => {
                        if (this.currentIndex < this.terms.length - 1) {
                            this.currentIndex++;
                            this.isFlipped = false;
                            this.swipeOffset = 0;
                        } else {
                            this.sessionComplete = true;
                            this.sessionDuration = Math.round((Date.now() - this.sessionStart) / 1000);
                        }
                        this.showFeedback = false;
                    }, 600);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        },

        createParticles() {
            const container = document.querySelector('.particles-container');
            if (!container) return;

            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.innerHTML = ['‚ú®', '‚≠ê', 'üéâ', 'üí´'][Math.floor(Math.random() * 4)];
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                container.appendChild(particle);

                setTimeout(() => particle.remove(), 2000);
            }
        },

        playSound(type) {
            // Optional: Add sound effects using Web Audio API or preloaded audio
            // This is a placeholder for future sound implementation
            if (type === 'flip') {
                // Subtle flip sound
            } else if (type === 'success') {
                // Success sound
            }
        },

        formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}m ${secs}s`;
        },

        continueSession() {
            window.location.reload();
        },

        closeSession() {
            window.location.href = "{{ url_for('flashcards.categories') }}";
        }
    };
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
    const app = document.querySelector('[x-data]')?.__x?.getUnobservedData?.();
    if (!app) return;

    if (e.code === 'Space') {
        e.preventDefault();
        app.flipCard();
    }
    if (e.key === '1') app.submitReview(1);
    if (e.key === '2') app.submitReview(2);
    if (e.key === '3') app.submitReview(3);
    if (e.key === '4') app.submitReview(4);
});
</script>

<style>
/* General */
.premium-study-container {
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* Session Header */
.session-header {
    max-width: 900px;
    margin: 0 auto 16px auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    backdrop-filter: blur(10px);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.header-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.back-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    transition: all 0.3s;
}

.back-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateX(-2px);
}

.category-name {
    font-size: 20px;
    font-weight: 600;
}

.session-stats {
    display: flex;
    gap: 24px;
}

.stat {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
}

.stat .emoji {
    font-size: 20px;
}

.stat .value {
    font-size: 16px;
    min-width: 24px;
}

/* Progress Bar */
.progress-bar-container {
    max-width: 900px;
    margin: 0 auto 24px auto;
    padding: 0 20px;
}

.progress-bar {
    height: 4px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 2px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4ade80, #22c55e);
    border-radius: 2px;
    transition: width 0.3s ease;
    box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
}

/* Study Area */
.study-area {
    max-width: 900px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
}

/* Flashcard Container */
.flashcard-container {
    width: 100%;
    max-width: 600px;
    margin-bottom: 40px;
    perspective: 1000px;
    cursor: grab;
    user-select: none;
}

.flashcard-container:active {
    cursor: grabbing;
}

.card-wrapper {
    transition: transform 0.1s ease-out;
}

/* Flip Card */
.flip-card {
    width: 100%;
    aspect-ratio: 16 / 9;
    perspective: 1000px;
    position: relative;
    cursor: pointer;
}

.flip-card-front,
.flip-card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 20px;
    padding: 40px;
    transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.flip-card-front {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    transform: rotateY(0deg);
}

.flip-card-back {
    background: linear-gradient(135deg, #764ba2 0%, #f093fb 100%);
    color: white;
    transform: rotateY(180deg);
}

.flip-card.flipped .flip-card-front {
    transform: rotateY(180deg);
}

.flip-card.flipped .flip-card-back {
    transform: rotateY(0deg);
}

.card-content {
    text-align: center;
    pointer-events: none;
}

.language-badge {
    display: inline-block;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    opacity: 0.8;
    margin-bottom: 20px;
    text-transform: uppercase;
}

.term {
    margin: 0;
    font-size: 48px;
    font-weight: 700;
    line-height: 1.2;
    margin-bottom: 16px;
}

.translation {
    margin: 0;
    font-size: 40px;
    font-weight: 600;
    line-height: 1.2;
    margin-bottom: 12px;
}

.definition {
    margin: 0;
    font-size: 14px;
    opacity: 0.9;
    line-height: 1.4;
}

.tap-hint {
    margin: 20px 0 0 0;
    font-size: 14px;
    opacity: 0.8;
}

/* Swipe Indicators */
.swipe-indicators {
    position: absolute;
    bottom: 20px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    padding: 0 20px;
    pointer-events: none;
}

.indicator {
    font-size: 24px;
    font-weight: 600;
    animation: pulse 0.6s ease-in-out infinite;
}

.indicator.left {
    color: rgba(255, 107, 107, 0.8);
    text-align: left;
}

.indicator.right {
    color: rgba(81, 207, 102, 0.8);
    text-align: right;
}

/* Rating Buttons */
.rating-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    width: 100%;
    max-width: 600px;
    margin-bottom: 24px;
}

.rating-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px 12px;
    background: rgba(255, 255, 255, 0.15);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    color: white;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.rating-btn:hover,
.rating-btn.hovered {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.5);
    transform: translateY(-2px);
}

.rating-again:hover {
    border-color: #ff6b6b;
    background: rgba(255, 107, 107, 0.1);
}

.rating-hard:hover {
    border-color: #ffa940;
    background: rgba(255, 169, 64, 0.1);
}

.rating-good:hover {
    border-color: #ffc107;
    background: rgba(255, 193, 7, 0.1);
}

.rating-easy:hover {
    border-color: #51cf66;
    background: rgba(81, 207, 102, 0.1);
}

.rating-emoji {
    font-size: 28px;
}

.rating-label {
    font-size: 14px;
}

.rating-subtitle {
    font-size: 11px;
    opacity: 0.7;
}

/* Keyboard Hints */
.keyboard-hints {
    text-align: center;
    color: rgba(255, 255, 255, 0.7);
    font-size: 13px;
    margin-top: 16px;
}

.keyboard-hints kbd {
    background: rgba(255, 255, 255, 0.1);
    padding: 3px 8px;
    border-radius: 4px;
    font-family: monospace;
    border: 1px solid rgba(255, 255, 255, 0.2);
    margin: 0 2px;
}

/* Particles */
.particles-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
    z-index: 1000;
}

.particle {
    position: fixed;
    font-size: 24px;
    animation: particle-animation 2s ease-out forwards;
    z-index: 1000;
}

@keyframes particle-animation {
    0% {
        opacity: 1;
        transform: translate(0, 0) scale(1);
    }
    100% {
        opacity: 0;
        transform: translate(var(--tx, 100px), var(--ty, -100px)) scale(0);
    }
}

/* Session Complete Modal */
.session-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.modal-content {
    background: white;
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    max-width: 500px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
    margin-bottom: 32px;
}

.celebration-emoji {
    font-size: 60px;
    margin-bottom: 16px;
    display: block;
    animation: bounce 0.6s ease-in-out;
}

.modal-content h2 {
    margin: 0;
    font-size: 32px;
    color: #1f2937;
    font-weight: 700;
}

/* Session Stats Grid */
.session-stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin-bottom: 32px;
}

.stat-card {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
}

.stat-emoji {
    font-size: 32px;
    margin-bottom: 8px;
}

.stat-label {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 8px;
    font-weight: 600;
    text-transform: uppercase;
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #667eea;
}

/* Modal Actions */
.modal-actions {
    display: flex;
    gap: 12px;
    flex-direction: column;
}

.btn {
    padding: 14px 24px;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
}

.btn-secondary {
    background: #e5e7eb;
    color: #374151;
}

.btn-secondary:hover {
    background: #d1d5db;
}

/* Feedback Toast */
.feedback-toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    padding: 16px 24px;
    border-radius: 12px;
    font-weight: 600;
    z-index: 999;
    animation: slideUp 0.3s ease-out;
}

.feedback-success {
    background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);
    color: white;
}

.feedback-neutral {
    background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
    color: white;
}

/* Animations */
@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

@keyframes bounce {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

@keyframes pulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}

/* Empty State */
.empty-state {
    text-align: center;
    color: white;
    padding: 60px 20px;
}

.empty-icon {
    font-size: 64px;
    margin-bottom: 16px;
}

.empty-state h2 {
    margin: 0 0 24px 0;
    font-size: 28px;
    font-weight: 700;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .premium-study-container {
        padding: 12px;
    }

    .session-header {
        padding: 12px 16px;
        margin-bottom: 12px;
    }

    .category-name {
        font-size: 16px;
    }

    .session-stats {
        gap: 12px;
    }

    .stat .value {
        font-size: 14px;
    }

    .flip-card-front,
    .flip-card-back {
        padding: 24px;
    }

    .term {
        font-size: 32px;
    }

    .translation {
        font-size: 28px;
    }

    .rating-buttons {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .rating-btn {
        padding: 14px 10px;
        font-size: 12px;
    }

    .rating-emoji {
        font-size: 24px;
    }

    .modal-content {
        padding: 24px;
        margin: 20px;
    }

    .session-stats-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }

    .session-stats-grid .stat-card:nth-child(n+3) {
        display: grid;
        grid-template-columns: 1fr 1fr;
    }
}

[x-cloak] {
    display: none !important;
}
</style>

<!-- Alpine.js -->
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
{% endblock %}
