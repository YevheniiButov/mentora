{% extends "assessment/base_diagnostic.html" %}

{% block title %}–í–æ–ø—Ä–æ—Å {{ question_num }} –∏–∑ {{ total_questions }}{% endblock %}

{% block description %}BIG –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ - –≤–æ–ø—Ä–æ—Å {{ question_num }} –∏–∑ {{ total_questions }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/compact-diagnostic.css') }}">
{% endblock %}

{% block content %}
<div class="diagnostic-container">
  
  <!-- –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π header -->
  <header class="compact-header">
    <div class="progress-mini">
      <span class="counter">{{ question_num }}/{{ total_questions }}</span>
      <div class="progress-line">
        <div class="fill" style="width: {{ (question_num/total_questions*100)|round }}%"></div>
                    </div>
      <span class="timer" id="timer">
                        <span id="minutes">--</span>:<span id="seconds">--</span>
                    </span>
                </div>
  </header>
  
  <!-- –°–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="question-main" id="question-main">
            <div class="question-card">
      <h2 class="question-text" id="question-text">
        {{ question.text }}
      </h2>
      
      <div class="options-container" id="options-container">
        {% for option in question.options %}
        <label class="option-compact" data-option-index="{{ loop.index0 }}">
          <input type="radio" name="answer" value="{{ loop.index0 }}" data-option-letter="{{ ['A','B','C','D'][loop.index0] }}">
          <span class="option-ui">
            <span class="letter">{{ ['A','B','C','D'][loop.index0] }}</span>
            <span class="text">{{ option }}</span>
          </span>
        </label>
                    {% endfor %}
                </div>
            </div>
  </main>
        
  <!-- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
  <footer class="nav-footer">
            {% if question_num > 1 %}
    <button class="btn-exit" onclick="previousQuestion()">
      <i class="fas fa-arrow-left"></i>
      <span>–ù–∞–∑–∞–¥</span>
            </button>
            {% else %}
    <button class="btn-exit" onclick="exitDiagnostic()">
      <i class="fas fa-times"></i>
      <span>–í—ã–π—Ç–∏</span>
            </button>
            {% endif %}
            
    <div class="confidence-control">
      <label>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</label>
      <input type="range" min="1" max="5" value="3" class="confidence-slider" id="confidence-slider">
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ -->
            <button class="btn-finish" onclick="forceFinishDiagnostic()" style="margin-right: 10px;">
      <i class="fas fa-stop"></i>
      <span>–ó–∞–≤–µ—Ä—à–∏—Ç—å</span>
            </button>
            
            {% if question_num < total_questions %}
    <button class="btn-next" id="next-btn" disabled onclick="nextQuestion()">
      <span>–î–∞–ª–µ–µ</span>
      <i class="fas fa-arrow-right"></i>
            </button>
            {% else %}
    <button class="btn-next" id="finish-btn" disabled onclick="finishAssessment()">
      <span>–ó–∞–≤–µ—Ä—à–∏—Ç—å</span>
      <i class="fas fa-check"></i>
            </button>
            {% endif %}
  </footer>

</div>
{% endblock %}

{% block extra_js %}
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let selectedOption = null;
let timerInterval = null;
let startTime = Date.now();
let timeLimit = {{ remaining_time | default(3600) | int }};
let confidenceLevel = 3;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    try {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–æ–ø—Ä–æ—Å–∞...');
        initializeQuestionPage();
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å
    {% if existing_answer %}
    const savedAnswer = {{ existing_answer.user_answer | default('null') }};
    if (savedAnswer !== null) {
            selectOption(document.querySelectorAll('.option-compact')[savedAnswer], savedAnswer);
    }
    {% endif %}
        
        console.log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–æ–ø—Ä–æ—Å–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:', error);
    }
});

function initializeQuestionPage() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–µ—Ä–∞
    initTimer();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    bindEventHandlers();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    initKeyboardNavigation();
    
    // –ê–¥–∞–ø—Ç–∞—Ü–∏—è layout
    adaptQuestionLayout();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–∞—á–∞–ª—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    setTimeout(() => {
        const questionMain = document.querySelector('.question-main');
        if (questionMain) {
            questionMain.scrollTop = 0;
        }
        window.scrollTo(0, 0);
    }, 100);
}

function bindEventHandlers() {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞
    document.querySelectorAll('.option-compact').forEach((option, index) => {
        const radio = option.querySelector('input[type="radio"]');
        
        radio.addEventListener('change', () => {
            selectOption(option, index);
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        option.setAttribute('tabindex', '0');
        option.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                radio.checked = true;
                selectOption(option, index);
            }
        });
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª–∞–π–¥–µ—Ä–∞ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
    const confidenceSlider = document.getElementById('confidence-slider');
    if (confidenceSlider) {
        confidenceSlider.addEventListener('input', (e) => {
            confidenceLevel = parseInt(e.target.value);
            updateConfidenceIndicator();
        });
    }
}

function selectOption(element, index) {
    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
    document.querySelectorAll('.option-compact').forEach(opt => {
        opt.classList.remove('selected');
    });
    
    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
    element.classList.add('selected');
    selectedOption = index;
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–î–∞–ª–µ–µ" –∏–ª–∏ "–ó–∞–≤–µ—Ä—à–∏—Ç—å"
        const nextBtn = document.getElementById('next-btn');
    const finishBtn = document.getElementById('finish-btn');
    
    if (nextBtn) nextBtn.disabled = false;
    if (finishBtn) finishBtn.disabled = false;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–∫—Ç–∏–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
    addHapticFeedback();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
    updateConfidenceIndicator();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä–æ–ª–ª–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –Ω–µ–≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –≤–∞—Ä–∏–∞–Ω—Ç—É
    setTimeout(() => scrollToNextOption(), 100);
}

function updateConfidenceIndicator() {
    const confidenceSlider = document.getElementById('confidence-slider');
    if (confidenceSlider && selectedOption !== null) {
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –æ—Ç–≤–µ—Ç–∞
        confidenceSlider.value = Math.max(confidenceLevel, 4);
        confidenceLevel = parseInt(confidenceSlider.value);
    }
}

function scrollToNextOption() {
    const nextOption = document.querySelector('.option-compact:not(.selected)');
    if (nextOption) {
        nextOption.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

function adaptQuestionLayout() {
    const container = document.querySelector('.question-main');
    const questionCard = document.querySelector('.question-card');
    
    if (!container || !questionCard) return;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    const totalHeight = questionCard.scrollHeight;
    const viewHeight = container.clientHeight;
    
    if (totalHeight > viewHeight * 0.8) {
        // –í–∫–ª—é—á–∞–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º
        container.classList.add('compact-mode');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
    const options = document.querySelectorAll('.option-ui .text');
    let hasLongOptions = false;
    
    options.forEach(option => {
        if (option.textContent.length > 100) {
            hasLongOptions = true;
        }
    });
    
    if (hasLongOptions) {
        container.classList.add('long-options');
    }
}

function initTimer() {
    function updateTimer() {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const remaining = timeLimit - elapsed;
        
        if (remaining <= 0) {
            clearInterval(timerInterval);
            finishAssessment();
            return;
        }
        
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        
        const minutesEl = document.getElementById('minutes');
        const secondsEl = document.getElementById('seconds');
        
        if (minutesEl) minutesEl.textContent = minutes;
        if (secondsEl) secondsEl.textContent = seconds.toString().padStart(2, '0');
        
        // –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
        const timerEl = document.getElementById('timer');
        if (timerEl) {
            timerEl.className = 'timer';
            if (remaining <= 300) { // 5 –º–∏–Ω—É—Ç
                timerEl.classList.add('danger');
            } else if (remaining <= 600) { // 10 –º–∏–Ω—É—Ç
                timerEl.classList.add('warning');
            }
        }
    }
    
    updateTimer();
    timerInterval = setInterval(updateTimer, 1000);
}

function initKeyboardNavigation() {
    document.addEventListener('keydown', (e) => {
        // –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∞–º–∏
        if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
            e.preventDefault();
            navigateOptions(e.key === 'ArrowUp' ? -1 : 1);
        }
        
        // Enter –¥–ª—è –≤—ã–±–æ—Ä–∞
        if (e.key === 'Enter' && selectedOption !== null) {
            e.preventDefault();
            const nextBtn = document.getElementById('next-btn');
            const finishBtn = document.getElementById('finish-btn');
            
            if (nextBtn && !nextBtn.disabled) {
                nextQuestion();
            } else if (finishBtn && !finishBtn.disabled) {
                finishAssessment();
            }
        }
        
        // –¶–∏—Ñ—Ä—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞
        if (e.key >= '1' && e.key <= '4') {
            const optionIndex = parseInt(e.key) - 1;
            const options = document.querySelectorAll('.option-compact');
            if (options[optionIndex]) {
                const radio = options[optionIndex].querySelector('input[type="radio"]');
                radio.checked = true;
                selectOption(options[optionIndex], optionIndex);
            }
        }
    });
}

function navigateOptions(direction) {
    const options = document.querySelectorAll('.option-compact');
    const currentIndex = selectedOption !== null ? selectedOption : -1;
    let nextIndex = currentIndex + direction;
    
    if (nextIndex < 0) nextIndex = options.length - 1;
    if (nextIndex >= options.length) nextIndex = 0;
    
    const radio = options[nextIndex].querySelector('input[type="radio"]');
    radio.checked = true;
    selectOption(options[nextIndex], nextIndex);
    options[nextIndex].focus();
}

function addHapticFeedback() {
    if ('vibrate' in navigator) {
        navigator.vibrate(50);
    }
}

function previousQuestion() {
    window.history.back();
}

function nextQuestion() {
    if (selectedOption === null) return;
    
    submitAnswer().then((result) => {
        if (result && result.success) {
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
            window.location.href = '{{ url_for("diagnostic.show_question", session_id=session_id) }}';
        }
    }).catch((error) => {
        console.error('Error in nextQuestion:', error);
    });
}

function finishAssessment() {
    if (selectedOption === null) return;
    
    submitAnswer().then((result) => {
        if (result && result.success) {
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
            window.location.href = '{{ url_for("diagnostic.show_results", session_id=session_id) }}';
        }
    }).catch((error) => {
        console.error('Error in finishAssessment:', error);
    });
}

function forceFinishDiagnostic() {
    showModal('–ó–∞–≤–µ—Ä—à–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É', 
        '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É? –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –æ—Å–Ω–æ–≤–∞–Ω—ã –Ω–∞ —É–∂–µ –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö.', [
        { text: '–û—Ç–º–µ–Ω–∞', class: 'btn-secondary', onclick: hideModal },
        { text: '–ó–∞–≤–µ—Ä—à–∏—Ç—å', class: 'btn-primary', onclick: () => {
            hideModal();
            completeDiagnostic();
        }}
    ]);
}

async function completeDiagnostic() {
    showLoading('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...');
    
    try {
        const response = await fetch('{{ url_for("diagnostic.complete_session", session_id=session_id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });
        
        hideLoading();
        
        if (response.ok) {
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
            window.location.href = '{{ url_for("diagnostic.show_results", session_id=session_id) }}';
        } else {
            const data = await response.json();
            throw new Error(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏');
        }
        
    } catch (error) {
        hideLoading();
        console.error('Error completing diagnostic:', error);
        showModal('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏', [
            { text: 'OK', class: 'btn-primary', onclick: hideModal }
        ]);
    }
}

async function submitAnswer() {
    if (selectedOption === null) return;
    
    showLoading('–û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞...');
    
    try {
    const formData = new FormData();
        formData.append('answer', selectedOption);
        formData.append('confidence', confidenceLevel);
    formData.append('csrf_token', '{{ csrf_token() }}');
    
        const response = await fetch('{{ url_for("diagnostic.submit_answer", session_id=session_id) }}', {
        method: 'POST',
        body: formData
        });
        
        hideLoading();
        
        // –ï—Å–ª–∏ —ç—Ç–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º (—Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω)
        if (response.redirected && response.url && response.url.includes('/results/')) {
            window.location.href = response.url;
            return;
        }
        
        // –ï—Å–ª–∏ —ç—Ç–æ JSON –æ—Ç–≤–µ—Ç —Å –æ—à–∏–±–∫–æ–π
        if (response.headers.get('content-type')?.includes('application/json')) {
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }
            return data;
        }
        
        // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω—ã–π —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç, –ù–ï –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –Ω–∞–∂–º–µ—Ç "–î–∞–ª–µ–µ" –∏–ª–∏ "–ó–∞–≤–µ—Ä—à–∏—Ç—å"
        if (response.ok) {
            console.log('–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ');
            return { success: true };
        } else {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
    } catch (error) {
        hideLoading();
        console.error('Error submitting answer:', error);
        showModal('–û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞', [
            { text: 'OK', class: 'btn-primary', onclick: hideModal }
        ]);
        throw error;
    }
}

function exitDiagnostic() {
    showModal('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞', 
        '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏? –í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.', [
        { text: '–û—Ç–º–µ–Ω–∞', class: 'btn-secondary', onclick: hideModal },
        { text: '–í—ã–π—Ç–∏', class: 'btn-error', onclick: () => {
            hideModal();
        window.location.href = '{{ url_for("dashboard.index") }}';
        }}
    ]);
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω (–µ—Å–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ –±–∞–∑–æ–≤–æ–º —à–∞–±–ª–æ–Ω–µ)
function showModal(title, message, buttons = []) {
    // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>${title}</h3>
            <p>${message}</p>
            <div class="modal-buttons">
                ${buttons.map(btn => `<button class="${btn.class}" onclick="${btn.onclick}">${btn.text}</button>`).join('')}
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function hideModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

function showLoading(message) {
    const loading = document.createElement('div');
    loading.className = 'loading-overlay';
    loading.innerHTML = `<div class="loading-spinner">${message}</div>`;
    document.body.appendChild(loading);
}

function hideLoading() {
    const loading = document.querySelector('.loading-overlay');
    if (loading) {
        loading.remove();
    }
}

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', () => {
    if (timerInterval) {
        clearInterval(timerInterval);
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
window.addEventListener('resize', () => {
    setTimeout(adaptQuestionLayout, 100);
});
</script>

<style>
/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: white;
    padding: 24px;
    border-radius: 12px;
    max-width: 400px;
    width: 90%;
    text-align: center;
}

.modal-content h3 {
    margin: 0 0 16px 0;
    color: #2d3748;
}

.modal-content p {
    margin: 0 0 24px 0;
    color: #4a5568;
    line-height: 1.5;
}

.modal-buttons {
    display: flex;
    gap: 12px;
    justify-content: center;
}

.modal-buttons button {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}

.modal-buttons .btn-primary {
    background: #3ECDC1;
    color: white;
}

.modal-buttons .btn-secondary {
    background: #e2e8f0;
    color: #4a5568;
}

.modal-buttons .btn-error {
    background: #f56565;
    color: white;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.loading-spinner {
    background: white;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
}

.loading-spinner::before {
    content: '';
    width: 20px;
    height: 20px;
    border: 2px solid #e2e8f0;
    border-top: 2px solid #3ECDC1;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è */
.btn-finish {
    background: #e53e3e;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background-color 0.2s;
}

.btn-finish:hover {
    background: #c53030;
}

.btn-finish:active {
    background: #9b2c2c;
}
</style>
{% endblock %}
