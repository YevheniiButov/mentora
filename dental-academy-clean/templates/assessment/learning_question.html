{% extends "assessment/base_diagnostic.html" %}

{% block title %}Learning Mode - Question {{ session.questions_answered + 1 }}{% endblock %}

{% block description %}Learning Mode with Explanations{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/compact-diagnostic.css') }}">
<style>
.learning-feedback {
    margin-top: 12px;
    padding: 12px 16px;
    border-radius: var(--radius-md);
    display: none;
    animation: fadeIn 0.2s ease;
    font-size: 14px;
}

.feedback-correct {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
}

.feedback-incorrect {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
}

.feedback-title {
    font-weight: 600;
    font-size: 14px;
    margin: 0 0 6px 0;
    display: flex;
    align-items: center;
    gap: 6px;
}

.feedback-answer {
    font-size: 13px;
    margin: 0 0 8px 0;
    opacity: 0.95;
}

.feedback-explanation {
    margin: 8px 0 0 0;
    padding: 10px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 6px;
    font-size: 13px;
    line-height: 1.5;
    border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.option-correct {
    background: #10b981 !important;
    color: white !important;
    border: 2px solid #059669 !important;
}

.option-incorrect {
    background: #ef4444 !important;
    color: white !important;
    border: 2px solid #dc2626 !important;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}

{% block content %}
<div class="diagnostic-container">
  
  <!-- Compact header -->
  <header class="compact-header">
    <div class="progress-mini">
      <span class="counter">{{ session.questions_answered + 1 }}/{{ session.get_session_data().get('estimated_total_questions', 30) }}</span>
      <div class="progress-line">
        <div class="fill" style="width: {{ ((session.questions_answered + 1) / session.get_session_data().get('estimated_total_questions', 30) * 100)|round }}%"></div>
      </div>
      <span class="timer" id="timer">
        <span id="minutes">--</span>:<span id="seconds">--</span>
      </span>
    </div>
  </header>
  
  <!-- Question content -->
  <main class="question-main" id="question-main">
    <div class="question-card">
      <h2 class="question-text" id="question-text">
        {{ question.text }}
      </h2>
      
      <div class="options-container" id="options-container">
        {% for option in question.options %}
        <label class="option-compact" data-option-index="{{ loop.index0 }}">
          <input type="radio" name="answer" value="{{ loop.index0 }}" data-option-letter="{{ ['A','B','C','D','E'][loop.index0] }}">
          <span class="option-ui">
            <span class="letter">{{ ['A','B','C','D','E'][loop.index0] }}</span>
            <span class="text">{{ option }}</span>
          </span>
        </label>
        {% endfor %}
      </div>

      <!-- Learning feedback area -->
      <div id="learning-feedback" class="learning-feedback">
        <div class="feedback-title" id="feedback-title"></div>
        <div class="feedback-answer" id="feedback-answer"></div>
        <div class="feedback-explanation" id="feedback-explanation"></div>
      </div>
    </div>
  </main>
        
  <!-- Fixed navigation -->
  <footer class="nav-footer">
    <button class="btn-exit" onclick="exitDiagnostic()">
      <i class="fas fa-times"></i>
      <span>Exit</span>
    </button>
    
    <button class="btn-next" id="submit-btn" disabled onclick="submitAnswer()">
      <span>Submit</span>
      <i class="fas fa-arrow-right"></i>
    </button>
    
    <button class="btn-next" id="next-btn" style="display: none;" onclick="nextQuestion()">
      <span id="next-btn-text">Next</span>
      <i class="fas fa-arrow-right"></i>
    </button>
  </footer>

</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let selectedOption = null;
let timerInterval = null;
let startTime = Date.now();
let isAnswered = false;

// Page initialization
document.addEventListener('DOMContentLoaded', function() {
    try {
        initializeQuestionPage();
        console.log('Learning question page initialized');
    } catch (error) {
        console.error('Error initializing page:', error);
    }
});

function initializeQuestionPage() {
    // Initialize option selection
    initializeOptions();
    
    // Start timer
    startTimer();
    
    console.log('Learning mode initialized for session {{ session.id }}');
}

function initializeOptions() {
    const options = document.querySelectorAll('.option-compact');
    const submitBtn = document.getElementById('submit-btn');
    
    options.forEach(option => {
        option.addEventListener('click', function() {
            if (isAnswered) return; // Don't allow changes after answering
            
            // Remove selection from all options
            options.forEach(opt => opt.classList.remove('selected'));
            
            // Select this option
            this.classList.add('selected');
            const input = this.querySelector('input[type="radio"]');
            input.checked = true;
            selectedOption = input.value;
            
            // Enable submit button
            submitBtn.disabled = false;
            
            console.log('Selected option:', selectedOption);
        });
    });
}

function startTimer() {
    const timerEl = document.getElementById('timer');
    if (!timerEl) return;
    
    const minutes = timerEl.querySelector('#minutes');
    const seconds = timerEl.querySelector('#seconds');
    
    timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        
        minutes.textContent = String(mins).padStart(2, '0');
        seconds.textContent = String(secs).padStart(2, '0');
    }, 1000);
}

async function submitAnswer() {
    if (selectedOption === null || isAnswered) {
        alert('Please select an answer.');
        return;
    }
    
    isAnswered = true;
    const submitBtn = document.getElementById('submit-btn');
    const nextBtn = document.getElementById('next-btn');
    submitBtn.disabled = true;
    
    const sessionId = {{ session.id }};
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    
    try {
        console.log('Submitting answer:', selectedOption);
        
        const response = await fetch(`/big-diagnostic/learning-answer/${sessionId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ answer_id: parseInt(selectedOption) })
        });
        
        const data = await response.json();
        console.log('Server response:', data);
        
        if (data.success) {
            // Show feedback
            showFeedback(data);
            
            // Disable all options
            const options = document.querySelectorAll('.option-compact input');
            options.forEach(opt => opt.disabled = true);
            
            // Hide submit, show next
            submitBtn.style.display = 'none';
            nextBtn.style.display = 'block';
            
            // Set next button behavior
            if (data.completed) {
                document.getElementById('next-btn-text').textContent = 'View Results';
                nextBtn.onclick = () => window.location.href = data.results_url;
            } else {
                document.getElementById('next-btn-text').textContent = 'Next';
                nextBtn.onclick = () => window.location.href = data.next_question_url;
            }
        } else {
            alert(data.error || 'An error occurred.');
            isAnswered = false;
            submitBtn.disabled = false;
        }
    } catch (error) {
        console.error('Error submitting answer:', error);
        alert('An error occurred while submitting your answer.');
        isAnswered = false;
        submitBtn.disabled = false;
    }
}

function showFeedback(data) {
    const feedbackBox = document.getElementById('learning-feedback');
    const feedbackTitle = document.getElementById('feedback-title');
    const feedbackAnswer = document.getElementById('feedback-answer');
    const feedbackExplanation = document.getElementById('feedback-explanation');
    
    // Set title and class
    if (data.is_correct) {
        feedbackBox.className = 'learning-feedback feedback-correct';
        feedbackTitle.innerHTML = '<i class="fas fa-check-circle"></i> Correct!';
    } else {
        feedbackBox.className = 'learning-feedback feedback-incorrect';
        feedbackTitle.innerHTML = '<i class="fas fa-times-circle"></i> Incorrect!';
    }
    
    // Set correct answer
    feedbackAnswer.textContent = `Correct answer: ${['A','B','C','D','E'][data.correct_answer]}`;
    
    // Set explanation
    feedbackExplanation.textContent = data.explanation || 'No explanation available.';
    
    // Highlight options
    const options = document.querySelectorAll('.option-compact');
    options.forEach((option, index) => {
        if (index === data.correct_answer) {
            option.classList.add('option-correct');
        }
        if (String(selectedOption) === String(index) && !data.is_correct) {
            option.classList.add('option-incorrect');
        }
    });
    
    // Show feedback
    feedbackBox.style.display = 'block';
}

function nextQuestion() {
    // This will be set by the submitAnswer function
}

function exitDiagnostic() {
    if (confirm('Are you sure you want to exit? Your progress will be saved.')) {
        window.location.href = '/{{ lang }}/learning-map';
    }
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (timerInterval) {
        clearInterval(timerInterval);
    }
});
</script>
{% endblock %}
