{% extends "admin/base.html" %}

{% block title %}{{ contact.full_name }} - –ö–æ–Ω—Ç–∞–∫—Ç - Mentora{% endblock %}

{% block extra_css %}
<style>
.contact-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
}

.contact-avatar-large {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 2.5rem;
    border: 4px solid rgba(255,255,255,0.3);
}

.info-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
}

.status-badge {
    padding: 8px 16px;
    border-radius: 25px;
    font-size: 0.9rem;
    font-weight: 500;
}

.status-lead { background: #ffc107; color: #000; }
.status-prospect { background: #17a2b8; color: #fff; }
.status-client { background: #28a745; color: #fff; }
.status-inactive { background: #6c757d; color: #fff; }

.followup-card {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.followup-warning {
    background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
}

.followup-ok {
    background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%);
}

.timeline-item {
    position: relative;
    padding-left: 30px;
    margin-bottom: 20px;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #007bff;
}

.timeline-item::after {
    content: '';
    position: absolute;
    left: 5px;
    top: 12px;
    width: 2px;
    height: calc(100% + 8px);
    background: #dee2e6;
}

.timeline-item:last-child::after {
    display: none;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Contact Header -->
    <div class="contact-header">
        <div class="row align-items-center">
            <div class="col-md-2">
                <div class="contact-avatar-large">
                    {{ contact.full_name[0].upper() }}
                </div>
            </div>
            <div class="col-md-6">
                <h1 class="h2 mb-2">{{ contact.full_name }}</h1>
                <p class="mb-1">{{ contact.email }}</p>
                {% if contact.phone %}
                <p class="mb-0">{{ contact.phone }}</p>
                {% endif %}
            </div>
            <div class="col-md-4 text-end">
                <span class="status-badge status-{{ contact.contact_status }}">
                    {{ contact.status_display }}
                </span>
                <br><br>
                <a href="{{ url_for('admin.crm_contacts') }}" class="btn btn-light">
                    <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
                </a>
            </div>
        </div>
    </div>

    <!-- Follow-up Alert -->
    {% if contact.next_followup_date %}
        {% set days_until = contact.days_until_followup %}
        <div class="followup-card {% if days_until < 0 %}{% elif days_until <= 3 %}followup-warning{% else %}followup-ok{% endif %}">
            <div class="d-flex align-items-center">
                <i class="bi bi-calendar-check me-3" style="font-size: 1.5rem;"></i>
                <div>
                    <strong>–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç:</strong> {{ contact.next_followup_date.strftime('%d.%m.%Y') }}
                    {% if days_until < 0 %}
                        <span class="badge bg-danger ms-2">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –Ω–∞ {{ -days_until }} –¥–Ω–µ–π</span>
                    {% elif days_until == 0 %}
                        <span class="badge bg-warning ms-2">–°–µ–≥–æ–¥–Ω—è</span>
                    {% elif days_until <= 3 %}
                        <span class="badge bg-warning ms-2">–ß–µ—Ä–µ–∑ {{ days_until }} –¥–Ω—è</span>
                    {% else %}
                        <span class="badge bg-success ms-2">–ß–µ—Ä–µ–∑ {{ days_until }} –¥–Ω–µ–π</span>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}

    <div class="row">
        <!-- Contact Information -->
        <div class="col-md-8">
            <form method="POST" action="{{ url_for('admin.crm_contact_update', contact_id=contact.id) }}">
                <div class="info-card">
                    <h5 class="mb-3">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="full_name" class="form-label">–ü–æ–ª–Ω–æ–µ –∏–º—è</label>
                                <input type="text" class="form-control" id="full_name" name="full_name" 
                                       value="{{ contact.full_name }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       value="{{ contact.email }}" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="phone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <input type="tel" class="form-control" id="phone" name="phone" 
                                       value="{{ contact.phone or '' }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="workplace" class="form-label">–ú–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã</label>
                                <input type="text" class="form-control" id="workplace" name="workplace" 
                                       value="{{ contact.workplace or '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="info-card">
                    <h5 class="mb-3">üë®‚Äç‚öïÔ∏è –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="profession_id" class="form-label">–ü—Ä–æ—Ñ–µ—Å—Å–∏—è</label>
                                <select class="form-select" id="profession_id" name="profession_id">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é</option>
                                    {% for profession in professions %}
                                    <option value="{{ profession.id }}" 
                                            {% if contact.profession_id == profession.id %}selected{% endif %}>
                                        {{ profession.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="big_number" class="form-label">BIG –Ω–æ–º–µ—Ä</label>
                                <input type="text" class="form-control" id="big_number" name="big_number" 
                                       value="{{ contact.big_number or '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="info-card">
                    <h5 class="mb-3">üìä CRM –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="contact_status" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                                <select class="form-select" id="contact_status" name="contact_status">
                                    <option value="lead" {% if contact.contact_status == 'lead' %}selected{% endif %}>–õ–∏–¥</option>
                                    <option value="prospect" {% if contact.contact_status == 'prospect' %}selected{% endif %}>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç</option>
                                    <option value="client" {% if contact.contact_status == 'client' %}selected{% endif %}>–ö–ª–∏–µ–Ω—Ç</option>
                                    <option value="inactive" {% if contact.contact_status == 'inactive' %}selected{% endif %}>–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="lead_source" class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫ –ª–∏–¥–∞</label>
                                <select class="form-select" id="lead_source" name="lead_source">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫</option>
                                    <option value="website" {% if contact.lead_source == 'website' %}selected{% endif %}>–í–µ–±-—Å–∞–π—Ç</option>
                                    <option value="referral" {% if contact.lead_source == 'referral' %}selected{% endif %}>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</option>
                                    <option value="digid" {% if contact.lead_source == 'digid' %}selected{% endif %}>DigiD</option>
                                    <option value="social_media" {% if contact.lead_source == 'social_media' %}selected{% endif %}>–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏</option>
                                    <option value="advertising" {% if contact.lead_source == 'advertising' %}selected{% endif %}>–†–µ–∫–ª–∞–º–∞</option>
                                    <option value="other" {% if contact.lead_source == 'other' %}selected{% endif %}>–î—Ä—É–≥–æ–µ</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="assigned_to" class="form-label">–ù–∞–∑–Ω–∞—á–µ–Ω –Ω–∞</label>
                                <select class="form-select" id="assigned_to" name="assigned_to">
                                    <option value="">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</option>
                                    {% for admin in admin_users %}
                                    <option value="{{ admin.id }}" 
                                            {% if contact.assigned_to == admin.id %}selected{% endif %}>
                                        {{ admin.get_display_name() }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="next_followup_date" class="form-label">–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç</label>
                                <input type="date" class="form-control" id="next_followup_date" name="next_followup_date" 
                                       value="{{ contact.next_followup_date.strftime('%Y-%m-%d') if contact.next_followup_date else '' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="info-card">
                    <h5 class="mb-3">üìù –ó–∞–º–µ—Ç–∫–∏</h5>
                    <div class="mb-3">
                        <textarea class="form-control" id="notes" name="notes" rows="5" 
                                  placeholder="–î–æ–±–∞–≤—å—Ç–µ –∑–∞–º–µ—Ç–∫–∏ –æ –∫–æ–Ω—Ç–∞–∫—Ç–µ...">{{ contact.notes or '' }}</textarea>
                    </div>
                </div>

                <div class="text-end">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-check-lg"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                </div>
            </form>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Contact Timeline -->
            <div class="info-card">
                <h5 class="mb-3">üìÖ –ò—Å—Ç–æ—Ä–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞</h5>
                <div class="timeline-item">
                    <strong>–ö–æ–Ω—Ç–∞–∫—Ç —Å–æ–∑–¥–∞–Ω</strong>
                    <br>
                    <small class="text-muted">{{ contact.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                </div>
                {% if contact.last_contact_date %}
                <div class="timeline-item">
                    <strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç</strong>
                    <br>
                    <small class="text-muted">{{ contact.last_contact_date.strftime('%d.%m.%Y %H:%M') }}</small>
                </div>
                {% endif %}
                {% if contact.next_followup_date %}
                <div class="timeline-item">
                    <strong>–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç</strong>
                    <br>
                    <small class="text-muted">{{ contact.next_followup_date.strftime('%d.%m.%Y') }}</small>
                </div>
                {% endif %}
            </div>

            <!-- Analytics -->
            <div class="info-card">
                <h5 class="mb-3">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h5>
                <div class="mb-2">
                    <strong>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong><br>
                    <span class="text-muted">{{ contact.registration_date.strftime('%d.%m.%Y %H:%M') }}</span>
                </div>
                {% if contact.registration_source %}
                <div class="mb-2">
                    <strong>–ò—Å—Ç–æ—á–Ω–∏–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</strong><br>
                    <span class="text-muted">{{ contact.registration_source }}</span>
                </div>
                {% endif %}
                {% if contact.first_visit_country %}
                <div class="mb-2">
                    <strong>–°—Ç—Ä–∞–Ω–∞ –ø–µ—Ä–≤–æ–≥–æ –≤–∏–∑–∏—Ç–∞:</strong><br>
                    <span class="text-muted">{{ contact.first_visit_country }}</span>
                </div>
                {% endif %}
                {% if contact.device_type %}
                <div class="mb-2">
                    <strong>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:</strong><br>
                    <span class="text-muted">{{ contact.device_type }}</span>
                </div>
                {% endif %}
                {% if contact.browser %}
                <div class="mb-2">
                    <strong>–ë—Ä–∞—É–∑–µ—Ä:</strong><br>
                    <span class="text-muted">{{ contact.browser }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Quick Actions -->
            <div class="info-card">
                <h5 class="mb-3">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h5>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="markAsContacted()">
                        <i class="bi bi-telephone"></i> –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ —Å–≤—è–∑–∞–Ω–Ω—ã–π
                    </button>
                    <button class="btn btn-outline-success" onclick="scheduleFollowup()">
                        <i class="bi bi-calendar-plus"></i> –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–≤–æ–Ω–æ–∫
                    </button>
                    <button class="btn btn-outline-info" onclick="sendEmail()">
                        <i class="bi bi-envelope"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å email
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function markAsContacted() {
    // Set last contact date to now
    const now = new Date().toISOString().split('T')[0];
    document.getElementById('next_followup_date').value = now;
    
    // Show success message
    alert('–ö–æ–Ω—Ç–∞–∫—Ç –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ —Å–≤—è–∑–∞–Ω–Ω—ã–π. –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.');
}

function scheduleFollowup() {
    // Set follow-up date to 7 days from now
    const futureDate = new Date();
    futureDate.setDate(futureDate.getDate() + 7);
    const dateString = futureDate.toISOString().split('T')[0];
    document.getElementById('next_followup_date').value = dateString;
    
    alert('–°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ ' + dateString + '. –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.');
}

function sendEmail() {
    const email = '{{ contact.email }}';
    window.open('mailto:' + email, '_blank');
}

// Auto-save form data to localStorage
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const inputs = form.querySelectorAll('input, select, textarea');
    
    // Load saved data
    inputs.forEach(input => {
        const saved = localStorage.getItem('contact_' + input.name);
        if (saved && !input.value) {
            input.value = saved;
        }
    });
    
    // Save data on change
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            localStorage.setItem('contact_' + this.name, this.value);
        });
    });
    
    // Clear saved data on form submit
    form.addEventListener('submit', function() {
        inputs.forEach(input => {
            localStorage.removeItem('contact_' + input.name);
        });
    });
});
</script>
{% endblock %}
