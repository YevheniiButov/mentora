{% extends "admin/base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π Dashboard - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å{% endblock %}

{% block extra_css %}
<style>
.analytics-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border-left: 5px solid #667eea;
}

.metric-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    text-align: center;
    transition: transform 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-3px);
}

.metric-card.users {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.metric-card.contacts {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
}

.metric-card.professions {
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
    color: #333;
}

.metric-card.visits {
    background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
}

.metric-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.metric-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.chart-container {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    height: 400px;
}

.chart-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 20px;
    text-align: center;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.country-item {
    background: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 4px solid #28a745;
    transition: transform 0.3s ease;
}

.country-item:hover {
    transform: translateY(-2px);
}

.country-header {
    display: flex;
    justify-content-between;
    align-items-center;
    margin-bottom: 10px;
}

.country-name {
    font-weight: 600;
    color: #333;
}

.country-count {
    font-size: 1.2rem;
    font-weight: bold;
    color: #667eea;
}

.profession-item {
    background: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 4px solid #17a2b8;
    transition: transform 0.3s ease;
}

.profession-item:hover {
    transform: translateY(-2px);
}

.profession-header {
    display: flex;
    justify-content-between;
    align-items-center;
    margin-bottom: 10px;
}

.profession-name {
    font-weight: 600;
    color: #333;
}

.profession-count {
    font-size: 1.2rem;
    font-weight: bold;
    color: #17a2b8;
}

.device-item {
    background: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 4px solid #ffc107;
    transition: transform 0.3s ease;
}

.device-item:hover {
    transform: translateY(-2px);
}

.device-header {
    display: flex;
    justify-content-between;
    align-items-center;
    margin-bottom: 10px;
}

.device-name {
    font-weight: 600;
    color: #333;
}

.device-count {
    font-size: 1.2rem;
    font-weight: bold;
    color: #ffc107;
}

.conversion-item {
    background: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 4px solid #6f42c1;
    transition: transform 0.3s ease;
}

.conversion-item:hover {
    transform: translateY(-2px);
}

.conversion-header {
    display: flex;
    justify-content-between;
    align-items-center;
    margin-bottom: 10px;
}

.conversion-country {
    font-weight: 600;
    color: #333;
}

.conversion-rate {
    font-size: 1.2rem;
    font-weight: bold;
    color: #6f42c1;
}

.progress-bar {
    height: 8px;
    border-radius: 4px;
    background: #e9ecef;
    overflow: hidden;
    margin-top: 10px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 200px;
}

.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">üìä –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π Dashboard</h1>
            <p class="text-muted">–î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, —Å—Ç—Ä–∞–Ω–∞–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è–º</p>
        </div>
        <div>
            <button class="btn btn-primary" onclick="refreshAnalytics()">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
            </button>
            <button class="btn btn-success" onclick="exportData()">
                üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
            </button>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="stats-grid">
        <div class="metric-card users">
            <div class="metric-value">{{ total_users }}</div>
            <div class="metric-label">üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        </div>
        <div class="metric-card contacts">
            <div class="metric-value">{{ total_contacts }}</div>
            <div class="metric-label">üìá –í—Å–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>
        </div>
        <div class="metric-card professions">
            <div class="metric-value">{{ total_professions }}</div>
            <div class="metric-label">üë®‚Äç‚öïÔ∏è –ü—Ä–æ—Ñ–µ—Å—Å–∏–π</div>
        </div>
        <div class="metric-card visits">
            <div class="metric-value">{{ total_visits }}</div>
            <div class="metric-label">üåê –í—Å–µ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏–π</div>
        </div>
    </div>

    <!-- Period Statistics -->
    <div class="stats-grid">
        <div class="metric-card">
            <div class="metric-value">{{ new_users_30d }}</div>
            <div class="metric-label">üë• –ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (30 –¥–Ω–µ–π)</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ new_contacts_30d }}</div>
            <div class="metric-label">üìá –ù–æ–≤—ã—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ (30 –¥–Ω–µ–π)</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ visits_30d }}</div>
            <div class="metric-label">üåê –ü–æ—Å–µ—â–µ–Ω–∏–π (30 –¥–Ω–µ–π)</div>
        </div>
    </div>

    <div class="row">
        <!-- Charts -->
        <div class="col-lg-8">
            <!-- Users Growth Chart -->
            <div class="chart-container">
                <div class="chart-title">üìà –†–æ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –º–µ—Å—è—Ü–∞–º</div>
                <canvas id="usersChart"></canvas>
            </div>

            <!-- Contacts Growth Chart -->
            <div class="chart-container">
                <div class="chart-title">üìá –†–æ—Å—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º</div>
                <canvas id="contactsChart"></canvas>
            </div>
        </div>

        <!-- Top Countries -->
        <div class="col-lg-4">
            <div class="analytics-card">
                <h3 class="mb-4">üåç –¢–æ–ø —Å—Ç—Ä–∞–Ω—ã –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º</h3>
                
                {% if top_countries %}
                    {% for country, count in top_countries %}
                    <div class="country-item">
                        <div class="country-header">
                            <div class="country-name">{{ country }}</div>
                            <div class="country-count">{{ count }}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ (count / top_countries[0][1] * 100) if top_countries else 0 }}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-globe fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å—Ç—Ä–∞–Ω–∞–º</h5>
                        <p class="text-muted">–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Top Professions -->
        <div class="col-lg-6">
            <div class="analytics-card">
                <h3 class="mb-4">üë®‚Äç‚öïÔ∏è –¢–æ–ø –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏</h3>
                
                {% if top_professions %}
                    {% for profession, count in top_professions %}
                    <div class="profession-item">
                        <div class="profession-header">
                            <div class="profession-name">{{ profession }}</div>
                            <div class="profession-count">{{ count }}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ (count / top_professions[0][1] * 100) if top_professions else 0 }}%; background: linear-gradient(90deg, #17a2b8, #138496);"></div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-user-md fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è–º</h5>
                        <p class="text-muted">–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–π</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Device Statistics -->
        <div class="col-lg-6">
            <div class="analytics-card">
                <h3 class="mb-4">üì± –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º</h3>
                
                {% if device_stats %}
                    {% for category, count in device_stats %}
                    <div class="device-item">
                        <div class="device-header">
                            <div class="device-name">
                                {% if category == 'mobile' %}üì± –ú–æ–±–∏–ª—å–Ω—ã–µ
                                {% elif category == 'desktop' %}üíª –î–µ—Å–∫—Ç–æ–ø
                                {% elif category == 'tablet' %}üì± –ü–ª–∞–Ω—à–µ—Ç—ã
                                {% else %}{{ category }}{% endif %}
                            </div>
                            <div class="device-count">{{ count }}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: {{ (count / device_stats[0][1] * 100) if device_stats else 0 }}%; background: linear-gradient(90deg, #ffc107, #e0a800);"></div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-mobile-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º</h5>
                        <p class="text-muted">–î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Country Conversion -->
    {% if country_conversion %}
    <div class="row">
        <div class="col-lg-12">
            <div class="analytics-card">
                <h3 class="mb-4">üéØ –ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∞–º</h3>
                
                <div class="row">
                    {% for country, rate, users in country_conversion %}
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="conversion-item">
                            <div class="conversion-header">
                                <div class="conversion-country">{{ country }}</div>
                                <div class="conversion-rate">{{ "%.1f"|format(rate) }}%</div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ rate }}%; background: linear-gradient(90deg, #6f42c1, #5a32a3);"></div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">{{ users }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function refreshAnalytics() {
    location.reload();
}

function exportData() {
    const format = prompt('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞:\n1. JSON\n2. CSV', '1');
    if (format === '1') {
        window.open('{{ url_for("analytics.api_export", report_type="summary") }}?format=json', '_blank');
    } else if (format === '2') {
        window.open('{{ url_for("analytics.api_export", report_type="summary") }}?format=csv', '_blank');
    }
}

// Load chart data
document.addEventListener('DOMContentLoaded', function() {
    loadChartData();
});

function loadChartData() {
    fetch('{{ url_for("analytics.api_charts_overview") }}')
        .then(response => response.json())
        .then(data => {
            createUsersChart(data.monthly_users);
            createContactsChart(data.monthly_contacts);
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
            showChartError();
        });
}

function createUsersChart(data) {
    const ctx = document.getElementById('usersChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(item => item.month),
            datasets: [{
                label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                data: data.map(item => item.count),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    });
}

function createContactsChart(data) {
    const ctx = document.getElementById('contactsChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(item => item.month),
            datasets: [{
                label: '–ö–æ–Ω—Ç–∞–∫—Ç—ã',
                data: data.map(item => item.count),
                backgroundColor: 'rgba(23, 162, 184, 0.8)',
                borderColor: '#17a2b8',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    });
}

function showChartError() {
    document.querySelectorAll('.chart-container canvas').forEach(canvas => {
        const container = canvas.parentElement;
        container.innerHTML = `
            <div class="loading-spinner">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5 class="text-muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h5>
                    <p class="text-muted">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤</p>
                </div>
            </div>
        `;
    });
}

// Add hover effects
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.country-item, .profession-item, .device-item, .conversion-item').forEach(item => {
        item.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
        });
    });
});

// Auto-refresh every 10 minutes
setTimeout(function() {
    location.reload();
}, 600000);
</script>
{% endblock %}
