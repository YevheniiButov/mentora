{% extends "admin/base.html" %}

{% block title %}Аналитика диагностики - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2">Аналитика диагностики</h1>
        </div>
        <div class="col-auto">
            <form method="get" class="d-inline">
                <select class="form-select" name="timeframe" onchange="this.form.submit()">
                    <option value="7" {% if time_frame == '7' %}selected{% endif %}>Последние 7 дней</option>
                    <option value="30" {% if time_frame == '30' %}selected{% endif %}>Последние 30 дней</option>
                    <option value="90" {% if time_frame == '90' %}selected{% endif %}>Последние 90 дней</option>
                    <option value="all" {% if time_frame == 'all' %}selected{% endif %}>Все время</option>
                </select>
            </form>
            <button class="btn btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#calibrateModal">
                <i class="bi bi-gear"></i> Калибровка IRT
            </button>
        </div>
    </div>

    <!-- Основные метрики -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">Всего сессий</h6>
                    <h3>{{ total_sessions }}</h3>
                    <div class="progress" style="height: 5px;">
                        <div class="progress-bar bg-success" style="width: {{ (completed_sessions/total_sessions*100) if total_sessions > 0 else 0 }}%"></div>
                    </div>
                    <small class="text-muted">{{ completed_sessions }} завершено</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">Покрытие IRT</h6>
                    <h3>{{ (irt_stats.questions_with_irt / irt_stats.total_questions * 100)|round(1) if irt_stats.total_questions > 0 else 0 }}%</h3>
                    <div class="progress" style="height: 5px;">
                        <div class="progress-bar bg-info" style="width: {{ (irt_stats.questions_with_irt / irt_stats.total_questions * 100) if irt_stats.total_questions > 0 else 0 }}%"></div>
                    </div>
                    <small class="text-muted">{{ irt_stats.questions_with_irt }} из {{ irt_stats.total_questions }} вопросов</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">Калибровано</h6>
                    <h3>{{ irt_stats.calibrated_questions }}</h3>
                    <small class="text-muted">вопросов с реальными данными</small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">Средняя сложность</h6>
                    <h3>{{ irt_stats.avg_difficulty|round(2) }}</h3>
                    <small class="text-muted">дискриминация: {{ irt_stats.avg_discrimination|round(2) }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Графики -->
    <div class="row mb-4">
        <!-- Распределение способностей -->
        <div class="col-xl-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Распределение способностей</h5>
                </div>
                <div class="card-body">
                    <canvas id="abilityChart" height="150"></canvas>
                </div>
            </div>
        </div>

        <!-- Типы диагностики -->
        <div class="col-xl-6 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Типы диагностики</h5>
                </div>
                <div class="card-body">
                    <canvas id="sessionTypesChart" height="150"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Статистика по доменам -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Анализ по доменам</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Домен</th>
                                    <th>Средняя способность</th>
                                    <th>Слабых результатов</th>
                                    <th>Всего протестировано</th>
                                    <th>Визуализация</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in domain_stats %}
                                <tr>
                                    <td><strong>{{ stat.domain }}</strong></td>
                                    <td>
                                        <span class="badge {% if stat.avg_ability < -0.5 %}bg-danger{% elif stat.avg_ability < 0 %}bg-warning{% else %}bg-success{% endif %}">
                                            {{ stat.avg_ability|round(2) }}
                                        </span>
                                    </td>
                                    <td>{{ stat.weak_count }}</td>
                                    <td>{{ stat.total_tested }}</td>
                                    <td>
                                        <div class="progress" style="height: 20px; width: 200px;">
                                            <div class="progress-bar {% if stat.avg_ability < -0.5 %}bg-danger{% elif stat.avg_ability < 0 %}bg-warning{% else %}bg-success{% endif %}" 
                                                 style="width: {{ ((stat.avg_ability + 3) / 6 * 100)|round }}%">
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Проблемные вопросы -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Вопросы с экстремальными параметрами</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#difficult">
                                Очень сложные
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#easy">
                                Очень легкие
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#lowdisc">
                                Низкая дискриминация
                            </a>
                        </li>
                    </ul>
                    
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="difficult">
                            <div class="list-group">
                                {% for item in extreme_questions if item.type == 'difficult' %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>ID: {{ item.question.id }}</strong>
                                            <p class="mb-0 text-truncate" style="max-width: 600px;">
                                                {{ item.question.text[:100] }}...
                                            </p>
                                        </div>
                                        <div>
                                            <span class="badge bg-danger">{{ item.value|round(2) }}</span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="easy">
                            <div class="list-group">
                                {% for item in extreme_questions if item.type == 'easy' %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>ID: {{ item.question.id }}</strong>
                                            <p class="mb-0 text-truncate" style="max-width: 600px;">
                                                {{ item.question.text[:100] }}...
                                            </p>
                                        </div>
                                        <div>
                                            <span class="badge bg-success">{{ item.value|round(2) }}</span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="tab-pane fade" id="lowdisc">
                            <div class="list-group">
                                {% for item in extreme_questions if item.type == 'low_discrimination' %}
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <strong>ID: {{ item.question.id }}</strong>
                                            <p class="mb-0 text-truncate" style="max-width: 600px;">
                                                {{ item.question.text[:100] }}...
                                            </p>
                                        </div>
                                        <div>
                                            <span class="badge bg-warning">{{ item.value|round(2) }}</span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal калибровки -->
<div class="modal fade" id="calibrateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Калибровка IRT параметров</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Калибровка обновит IRT параметры всех вопросов на основе накопленной статистики ответов.</p>
                <p class="text-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    Процесс может занять несколько минут при большом количестве вопросов.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <form action="{{ url_for('admin.calibrate_irt') }}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-gear"></i> Запустить калибровку
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// График распределения способностей
const abilityData = {
    labels: {{ ability_distribution|map(attribute='ability_range')|list|tojson }},
    datasets: [{
        label: 'Количество пользователей',
        data: {{ ability_distribution|map(attribute='count')|list|tojson }},
        backgroundColor: 'rgba(54, 162, 235, 0.5)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
    }]
};

new Chart(document.getElementById('abilityChart'), {
    type: 'bar',
    data: abilityData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: { beginAtZero: true }
        }
    }
});

// График типов диагностики
const sessionTypesData = {
    labels: {{ session_types_stats|map(attribute='session_type')|list|tojson }},
    datasets: [{
        label: 'Количество сессий',
        data: {{ session_types_stats|map(attribute='count')|list|tojson }},
        backgroundColor: [
            'rgba(255, 99, 132, 0.5)',
            'rgba(54, 162, 235, 0.5)',
            'rgba(255, 206, 86, 0.5)',
            'rgba(75, 192, 192, 0.5)'
        ]
    }]
};

new Chart(document.getElementById('sessionTypesChart'), {
    type: 'doughnut',
    data: sessionTypesData,
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});
</script>
{% endblock %} 