{% extends "admin/base.html" %}

{% block title %}–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ - Communication Hub{% endblock %}

{% block extra_css %}
<style>
.email-item {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    border-left: 4px solid #e9ecef;
    transition: all 0.3s ease;
}

.email-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.email-item.crm_lead { border-left-color: #ffc107; }
.email-item.crm_follow_up { border-left-color: #17a2b8; }
.email-item.crm_welcome { border-left-color: #28a745; }
.email-item.notification { border-left-color: #6f42c1; }
.email-item.custom { border-left-color: #6c757d; }

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.status-sent { background: #d1ecf1; color: #0c5460; }
.status-delivered { background: #d4edda; color: #155724; }
.status-opened { background: #fff3cd; color: #856404; }
.status-clicked { background: #f8d7da; color: #721c24; }
.status-failed { background: #f5c6cb; color: #721c24; }

.filter-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">üì¨ –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏</h1>
            <p class="text-muted">–í—Å–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø–∏—Å—å–º–∞ –∏ –∏—Ö —Å—Ç–∞—Ç—É—Å—ã</p>
        </div>
        <div>
            <a href="{{ url_for('communication.dashboard') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-card">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label for="type" class="form-label">–¢–∏–ø –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label>
                <select class="form-select" id="type" name="type">
                    <option value="all" {% if recipient_type == 'all' %}selected{% endif %}>–í—Å–µ</option>
                    <option value="user" {% if recipient_type == 'user' %}selected{% endif %}>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                    <option value="contact" {% if recipient_type == 'contact' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç—ã</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="email_type" class="form-label">–¢–∏–ø –ø–∏—Å—å–º–∞</label>
                <select class="form-select" id="email_type" name="email_type">
                    <option value="all" {% if email_type == 'all' %}selected{% endif %}>–í—Å–µ</option>
                    <option value="crm_lead" {% if email_type == 'crm_lead' %}selected{% endif %}>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã</option>
                    <option value="crm_follow_up" {% if email_type == 'crm_follow_up' %}selected{% endif %}>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</option>
                    <option value="crm_welcome" {% if email_type == 'crm_welcome' %}selected{% endif %}>–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ</option>
                    <option value="notification" {% if email_type == 'notification' %}selected{% endif %}>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</option>
                    <option value="custom" {% if email_type == 'custom' %}selected{% endif %}>–ö–∞—Å—Ç–æ–º–Ω—ã–µ</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select class="form-select" id="status" name="status">
                    <option value="all" {% if status == 'all' %}selected{% endif %}>–í—Å–µ</option>
                    <option value="sent" {% if status == 'sent' %}selected{% endif %}>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</option>
                    <option value="delivered" {% if status == 'delivered' %}selected{% endif %}>–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</option>
                    <option value="opened" {% if status == 'opened' %}selected{% endif %}>–û—Ç–∫—Ä—ã—Ç–æ</option>
                    <option value="clicked" {% if status == 'clicked' %}selected{% endif %}>–ö–ª–∏–∫–Ω—É—Ç–æ</option>
                    <option value="failed" {% if status == 'failed' %}selected{% endif %}>–û—à–∏–±–∫–∞</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="search" class="form-label">–ü–æ–∏—Å–∫</label>
                <input type="text" class="form-control" id="search" name="search" 
                       value="{{ search }}" placeholder="Email, —Ç–µ–º–∞, –∏–º—è...">
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                </button>
                <a href="{{ url_for('communication.history') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-circle"></i> –°–±—Ä–æ—Å–∏—Ç—å
                </a>
            </div>
        </form>
    </div>

    <!-- Email List -->
    {% if emails.items %}
        {% for email in emails.items %}
        <div class="email-item {{ email.email_type }}">
            <div class="row">
                <div class="col-md-8">
                    <h6 class="mb-1">{{ email.subject }}</h6>
                    <p class="mb-1 text-muted">
                        <strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> {{ email.recipient_name or email.recipient_email }}
                        <span class="badge bg-{{ 'primary' if email.recipient_type == 'user' else 'info' }} ms-2">
                            {{ email.recipient_type }}
                        </span>
                    </p>
                    <small class="text-muted">
                        <strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> {{ email.sender_name or '–°–∏—Å—Ç–µ–º–∞' }} ‚Ä¢ 
                        <strong>–¢–∏–ø:</strong> {{ email.email_type }} ‚Ä¢ 
                        <strong>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:</strong> {{ email.sent_at.strftime('%d.%m.%Y %H:%M') }}
                    </small>
                </div>
                <div class="col-md-4 text-end">
                    <span class="status-badge status-{{ email.status }}">{{ email.status }}</span>
                    {% if email.external_id %}
                    <br><small class="text-muted">ID: {{ email.external_id[:8] }}...</small>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Pagination -->
        {% if emails.pages > 1 %}
        <nav aria-label="Email history pagination">
            <ul class="pagination justify-content-center">
                {% if emails.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('communication.history', page=emails.prev_num, type=recipient_type, email_type=email_type, status=status, search=search) }}">
                        –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                    </a>
                </li>
                {% endif %}
                
                {% for page_num in emails.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != emails.page %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('communication.history', page=page_num, type=recipient_type, email_type=email_type, status=status, search=search) }}">
                                {{ page_num }}
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% endif %}
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                {% endfor %}
                
                {% if emails.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('communication.history', page=emails.next_num, type=recipient_type, email_type=email_type, status=status, search=search) }}">
                        –°–ª–µ–¥—É—é—â–∞—è
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    {% else %}
        <div class="text-center py-5">
            <i class="bi bi-envelope" style="font-size: 4rem; color: #dee2e6;"></i>
            <h4 class="text-muted mt-3">–ü–∏—Å—å–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
            <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –ø–∏—Å—å–º–æ</p>
            <a href="{{ url_for('communication.send_email') }}" class="btn btn-primary">
                <i class="bi bi-envelope-plus"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}
