{% extends "admin/base.html" %}

{% block title %}–û—Ç–ø—Ä–∞–≤–∏—Ç—å Email - Communication Hub{% endblock %}

{% block extra_css %}
<style>
.recipient-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
    cursor: pointer;
}

.recipient-card:hover {
    border-color: #3ECDC1;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.recipient-card.selected {
    border-color: #3ECDC1;
    background-color: #f8f9fa;
}

.template-card {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
    cursor: pointer;
}

.template-card:hover {
    border-color: #17a2b8;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.template-card.selected {
    border-color: #17a2b8;
    background-color: #f8f9fa;
}

.email-preview {
    background: white;
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #e9ecef;
    min-height: 400px;
}

.recipient-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å Email</h1>
            <p class="text-muted">–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º</p>
        </div>
        <div>
            <a href="{{ url_for('communication.dashboard') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Recipients and Templates -->
        <div class="col-md-4">
            <!-- Recipients -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">üë• –ü–æ–ª—É—á–∞—Ç–µ–ª–∏</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="recipientType" id="allRecipients" value="all" checked>
                            <label class="btn btn-outline-primary" for="allRecipients">–í—Å–µ</label>
                            
                            <input type="radio" class="btn-check" name="recipientType" id="usersOnly" value="users">
                            <label class="btn btn-outline-primary" for="usersOnly">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</label>
                            
                            <input type="radio" class="btn-check" name="recipientType" id="contactsOnly" value="contacts">
                            <label class="btn btn-outline-primary" for="contactsOnly">–ö–æ–Ω—Ç–∞–∫—Ç—ã</label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <input type="text" class="form-control" id="recipientSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π...">
                    </div>
                    
                    <div id="recipientsList" style="max-height: 300px; overflow-y: auto;">
                        <!-- Recipients will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Templates -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìù –®–∞–±–ª–æ–Ω—ã</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <select class="form-select" id="templateType">
                            <option value="all">–í—Å–µ —Ç–∏–ø—ã</option>
                            <option value="crm_lead">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã</option>
                            <option value="crm_follow_up">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</option>
                            <option value="crm_welcome">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ</option>
                            <option value="notification">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</option>
                            <option value="custom">–ö–∞—Å—Ç–æ–º–Ω—ã–µ</option>
                        </select>
                    </div>
                    
                    <div id="templatesList" style="max-height: 300px; overflow-y: auto;">
                        <!-- Templates will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Email Form -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">‚úâÔ∏è –°–æ–∑–¥–∞—Ç—å –ø–∏—Å—å–º–æ</h5>
                </div>
                <div class="card-body">
                    <form id="emailForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="emailType" class="form-label">–¢–∏–ø –ø–∏—Å—å–º–∞</label>
                                    <select class="form-select" id="emailType" required>
                                        <option value="custom">–ö–∞—Å—Ç–æ–º–Ω–æ–µ –ø–∏—Å—å–º–æ</option>
                                        <option value="crm_lead">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–º—É –∫–ª–∏–µ–Ω—Ç—É</option>
                                        <option value="crm_follow_up">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</option>
                                        <option value="crm_welcome">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ</option>
                                        <option value="notification">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="emailSubject" class="form-label">–¢–µ–º–∞ –ø–∏—Å—å–º–∞</label>
                                    <input type="text" class="form-control" id="emailSubject" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="emailMessage" class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                            <textarea class="form-control" id="emailMessage" rows="8" required></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="actionUrl" class="form-label">–°—Å—ã–ª–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                    <input type="url" class="form-control" id="actionUrl" placeholder="https://example.com">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="actionText" class="form-label">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                    <input type="text" class="form-control" id="actionText" placeholder="–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ">
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <div>
                                <span id="selectedRecipientsCount" class="badge bg-secondary">0 –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –≤—ã–±—Ä–∞–Ω–æ</span>
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-secondary me-2" onclick="previewEmail()">
                                    <i class="bi bi-eye"></i> –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-send"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Email Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–∏—Å—å–º–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="emailPreview" class="email-preview">
                    <!-- Email preview will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
                <button type="button" class="btn btn-primary" onclick="sendEmailFromPreview()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedRecipients = [];
let selectedTemplate = null;

// Load recipients
function loadRecipients() {
    const recipientType = document.querySelector('input[name="recipientType"]:checked').value;
    const search = document.getElementById('recipientSearch').value;
    
    fetch(`/admin/communication/api/recipients?type=${recipientType}&search=${search}`)
        .then(response => response.json())
        .then(data => {
            const recipientsList = document.getElementById('recipientsList');
            recipientsList.innerHTML = '';
            
            data.recipients.forEach(recipient => {
                const recipientCard = document.createElement('div');
                recipientCard.className = 'recipient-card';
                recipientCard.dataset.recipientId = recipient.id;
                recipientCard.dataset.recipientType = recipient.type;
                
                recipientCard.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="recipient-avatar me-3">
                            ${recipient.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${recipient.name}</h6>
                            <small class="text-muted">${recipient.email}</small>
                            <br><small class="badge bg-${recipient.type === 'user' ? 'primary' : 'info'}">${recipient.type}</small>
                        </div>
                    </div>
                `;
                
                recipientCard.addEventListener('click', function() {
                    toggleRecipient(recipient.id, recipient.type, this);
                });
                
                recipientsList.appendChild(recipientCard);
            });
        });
}

// Load templates
function loadTemplates() {
    const templateType = document.getElementById('templateType').value;
    
    fetch(`/admin/communication/api/templates?type=${templateType}`)
        .then(response => response.json())
        .then(data => {
            const templatesList = document.getElementById('templatesList');
            templatesList.innerHTML = '';
            
            data.templates.forEach(template => {
                const templateCard = document.createElement('div');
                templateCard.className = 'template-card';
                templateCard.dataset.templateId = template.id;
                
                templateCard.innerHTML = `
                    <h6 class="mb-1">${template.name}</h6>
                    <p class="mb-1 text-muted">${template.subject}</p>
                    <small class="badge bg-secondary">${template.email_type}</small>
                `;
                
                templateCard.addEventListener('click', function() {
                    selectTemplate(template, this);
                });
                
                templatesList.appendChild(templateCard);
            });
        });
}

// Toggle recipient selection
function toggleRecipient(recipientId, recipientType, element) {
    const index = selectedRecipients.findIndex(r => r.id === recipientId && r.type === recipientType);
    
    if (index > -1) {
        selectedRecipients.splice(index, 1);
        element.classList.remove('selected');
    } else {
        selectedRecipients.push({id: recipientId, type: recipientType});
        element.classList.add('selected');
    }
    
    updateSelectedRecipientsCount();
}

// Select template
function selectTemplate(template, element) {
    // Remove previous selection
    document.querySelectorAll('.template-card').forEach(card => card.classList.remove('selected'));
    
    // Add selection to current element
    element.classList.add('selected');
    selectedTemplate = template;
    
    // Fill form with template data
    document.getElementById('emailType').value = template.email_type;
    document.getElementById('emailSubject').value = template.subject;
    document.getElementById('emailMessage').value = template.message;
    if (template.action_url) document.getElementById('actionUrl').value = template.action_url;
    if (template.action_text) document.getElementById('actionText').value = template.action_text;
}

// Update selected recipients count
function updateSelectedRecipientsCount() {
    const count = selectedRecipients.length;
    const badge = document.getElementById('selectedRecipientsCount');
    badge.textContent = `${count} –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π –≤—ã–±—Ä–∞–Ω–æ`;
    badge.className = count > 0 ? 'badge bg-primary' : 'badge bg-secondary';
}

// Preview email
function previewEmail() {
    if (selectedRecipients.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π');
        return;
    }
    
    // Create preview content
    const preview = document.getElementById('emailPreview');
    preview.innerHTML = `
        <div class="text-center">
            <h4>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–∏—Å—å–º–∞</h4>
            <p class="text-muted">–ü–∏—Å—å–º–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${selectedRecipients.length} –ø–æ–ª—É—á–∞—Ç–µ–ª—è–º</p>
            <hr>
            <h5>${document.getElementById('emailSubject').value}</h5>
            <div class="mt-3">
                ${document.getElementById('emailMessage').value.replace(/\n/g, '<br>')}
            </div>
        </div>
    `;
    
    new bootstrap.Modal(document.getElementById('previewModal')).show();
}

// Send email from preview
function sendEmailFromPreview() {
    document.getElementById('emailForm').dispatchEvent(new Event('submit'));
}

// Form submission
document.getElementById('emailForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (selectedRecipients.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π');
        return;
    }
    
    const subject = document.getElementById('emailSubject').value;
    const message = document.getElementById('emailMessage').value;
    const emailType = document.getElementById('emailType').value;
    const actionUrl = document.getElementById('actionUrl').value;
    const actionText = document.getElementById('actionText').value;
    
    // Send emails to all selected recipients
    let sentCount = 0;
    let failedCount = 0;
    
    selectedRecipients.forEach(recipient => {
        const data = {
            recipient_type: recipient.type,
            recipient_id: recipient.id,
            subject: subject,
            message: message,
            email_type: emailType,
            action_url: actionUrl,
            action_text: actionText
        };
        
        fetch('/admin/communication/send-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                sentCount++;
            } else {
                failedCount++;
            }
            
            // Check if all emails are processed
            if (sentCount + failedCount === selectedRecipients.length) {
                if (failedCount === 0) {
                    alert(`–í—Å–µ –ø–∏—Å—å–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ! (${sentCount})`);
                    window.location.href = '/admin/communication/';
                } else {
                    alert(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${sentCount}, –û—à–∏–±–æ–∫: ${failedCount}`);
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            failedCount++;
        });
    });
});

// Event listeners
document.querySelectorAll('input[name="recipientType"]').forEach(radio => {
    radio.addEventListener('change', loadRecipients);
});

document.getElementById('recipientSearch').addEventListener('input', loadRecipients);
document.getElementById('templateType').addEventListener('change', loadTemplates);

// Load initial data
loadRecipients();
loadTemplates();
</script>
{% endblock %}
