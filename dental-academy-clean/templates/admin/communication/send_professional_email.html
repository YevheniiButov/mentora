{% extends "admin/base.html" %}

{% block title %}–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π Email - Communication Hub{% endblock %}

{% block extra_css %}
<style>
.professional-email-container {
    max-width: 1200px;
    margin: 0 auto;
}

.template-selector {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.template-card {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.template-card:hover {
    border-color: #667eea;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    transform: translateY(-2px);
}

.template-card.selected {
    border-color: #667eea;
    background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);
}

.template-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.template-card.selected::before {
    opacity: 1;
}

.template-icon {
    font-size: 2.5rem;
    margin-bottom: 15px;
    color: #667eea;
}

.template-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 10px;
}

.template-description {
    color: #666;
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 15px;
}

.template-features {
    list-style: none;
    padding: 0;
    margin: 0;
}

.template-features li {
    color: #555;
    font-size: 0.85rem;
    margin-bottom: 5px;
    padding-left: 20px;
    position: relative;
}

.template-features li::before {
    content: '‚úì';
    position: absolute;
    left: 0;
    color: #28a745;
    font-weight: bold;
}

.recipient-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.recipient-search {
    margin-bottom: 20px;
}

.recipient-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
}

.recipient-card {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.recipient-card:hover {
    border-color: #3ECDC1;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.recipient-card.selected {
    border-color: #3ECDC1;
    background-color: #f8f9fa;
}

.recipient-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 5px;
}

.recipient-email {
    color: #666;
    font-size: 0.9rem;
}

.recipient-type {
    display: inline-block;
    background: #e9ecef;
    color: #495057;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    margin-top: 8px;
}

.email-composer {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.form-group {
    margin-bottom: 20px;
}

.form-label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
    display: block;
}

.form-control {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.btn-send {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.btn-send:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.btn-send:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.preview-section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.email-preview-frame {
    width: 100%;
    height: 600px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    background: #f8f9fa;
}

.loading-spinner {
    display: none;
    text-align: center;
    padding: 20px;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #667eea;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.alert {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.alert-success {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.alert-error {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.selected-count {
    background: #667eea;
    color: white;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-left: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="professional-email-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π Email</h1>
        <a href="{{ url_for('communication.dashboard') }}" class="btn btn-outline-secondary">
            ‚Üê –ù–∞–∑–∞–¥ –∫ –¥–∞—à–±–æ—Ä–¥—É
        </a>
    </div>

    <!-- –®–∞–≥ 1: –í—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞ -->
    <div class="template-selector">
        <h3 class="mb-3">üé® –®–∞–≥ 1: –í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω</h3>
        <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è –≤–∞—à–µ–≥–æ email</p>
        
        <div class="template-grid">
            <div class="template-card" data-template="welcome">
                <div class="template-icon">üëã</div>
                <div class="template-title">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ</div>
                <div class="template-description">
                    –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É Mentora
                </div>
                <ul class="template-features">
                    <li>–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</li>
                    <li>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—á–∞–ª—É —Ä–∞–±–æ—Ç—ã</li>
                    <li>–°—Å—ã–ª–∫–∏ –Ω–∞ –≤–∞–∂–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã</li>
                </ul>
            </div>

            <div class="template-card" data-template="follow_up">
                <div class="template-icon">üìû</div>
                <div class="template-title">Follow-up –ø–∏—Å—å–º–æ</div>
                <div class="template-description">
                    –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –æ–±—â–µ–Ω–∏—è —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
                </div>
                <ul class="template-features">
                    <li>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥</li>
                    <li>–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏</li>
                    <li>–ü—Ä—è–º—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã</li>
                </ul>
            </div>

            <div class="template-card" data-template="reminder">
                <div class="template-icon">‚è∞</div>
                <div class="template-title">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</div>
                <div class="template-description">
                    –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –¥–µ–¥–ª–∞–π–Ω–∞—Ö, –∑–∞–Ω—è—Ç–∏—è—Ö –∏ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö
                </div>
                <ul class="template-features">
                    <li>–í–∞–∂–Ω—ã–µ –¥–∞—Ç—ã</li>
                    <li>–ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã</li>
                    <li>–°—Å—ã–ª–∫–∏ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª—ã</li>
                </ul>
            </div>

            <div class="template-card" data-template="notification">
                <div class="template-icon">üîî</div>
                <div class="template-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>
                <div class="template-description">
                    –°–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –≤–∞–∂–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                </div>
                <ul class="template-features">
                    <li>–†–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</li>
                    <li>–ß–µ—Ç–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</li>
                    <li>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞</li>
                </ul>
            </div>

            <div class="template-card" data-template="campaign">
                <div class="template-icon">üì¢</div>
                <div class="template-title">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–∞—è –∫–∞–º–ø–∞–Ω–∏—è</div>
                <div class="template-description">
                    –ú–∞—Å—Å–æ–≤—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏ –∏ –Ω–æ–≤–æ—Å—Ç—è–º–∏
                </div>
                <ul class="template-features">
                    <li>–ü—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω</li>
                    <li>CTA –∫–Ω–æ–ø–∫–∏</li>
                    <li>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –æ—Ç–∑—ã–≤—ã</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- –®–∞–≥ 2: –í—ã–±–æ—Ä –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π -->
    <div class="recipient-section">
        <h3 class="mb-3">üë• –®–∞–≥ 2: –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π</h3>
        <p class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ email</p>
        
        <div class="recipient-search">
            <input type="text" id="recipientSearch" class="form-control" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ email...">
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <label class="form-check-label">
                    <input type="radio" name="recipientType" value="user" checked class="form-check-input">
                    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
                </label>
                <label class="form-check-label ms-3">
                    <input type="radio" name="recipientType" value="contact" class="form-check-input">
                    –ö–æ–Ω—Ç–∞–∫—Ç—ã
                </label>
            </div>
            <div>
                <span class="selected-count" id="selectedCount">0 –≤—ã–±—Ä–∞–Ω–æ</span>
            </div>
        </div>
        
        <div class="recipient-grid" id="recipientGrid">
            <!-- –ü–æ–ª—É—á–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </div>
    </div>

    <!-- –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ email -->
    <div class="email-composer">
        <h3 class="mb-3">‚úèÔ∏è –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ email</h3>
        
        <div class="form-group">
            <label class="form-label">–¢–µ–º–∞ –ø–∏—Å—å–º–∞</label>
            <input type="text" id="emailSubject" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –ø–∏—Å—å–º–∞...">
        </div>
        
        <div class="form-group">
            <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —à–∞–±–ª–æ–Ω–∞</label>
            <textarea id="templateData" class="form-control" rows="6" placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):&#10;{&#10;  &quot;custom_message&quot;: &quot;–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ&quot;,&#10;  &quot;action_url&quot;: &quot;https://example.com&quot;,&#10;  &quot;sender_name&quot;: &quot;–í–∞—à–µ –∏–º—è&quot;&#10;}"></textarea>
            <small class="text-muted">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</small>
        </div>
        
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <button type="button" id="previewBtn" class="btn btn-outline-primary">
                    üëÅÔ∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
                </button>
            </div>
            <div>
                <button type="button" id="sendBtn" class="btn-send" disabled>
                    üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å Email
                </button>
            </div>
        </div>
    </div>

    <!-- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä -->
    <div class="preview-section" id="previewSection" style="display: none;">
        <h3 class="mb-3">üëÅÔ∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</h3>
        <div class="loading-spinner" id="previewLoading">
            <div class="spinner"></div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞...</p>
        </div>
        <iframe id="emailPreview" class="email-preview-frame" style="display: none;"></iframe>
    </div>
</div>

<script>
let selectedTemplate = null;
let selectedRecipients = [];
let currentRecipients = [];

// –í—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞
document.querySelectorAll('.template-card').forEach(card => {
    card.addEventListener('click', function() {
        document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
        this.classList.add('selected');
        selectedTemplate = this.dataset.template;
        updateSendButton();
    });
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
function loadRecipients(type) {
    fetch(`/admin/communication/api/recipients?type=${type}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentRecipients = data.recipients;
                renderRecipients();
            }
        })
        .catch(error => {
            console.error('Error loading recipients:', error);
        });
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
function renderRecipients() {
    const grid = document.getElementById('recipientGrid');
    const searchTerm = document.getElementById('recipientSearch').value.toLowerCase();
    
    const filteredRecipients = currentRecipients.filter(recipient => 
        recipient.name.toLowerCase().includes(searchTerm) ||
        recipient.email.toLowerCase().includes(searchTerm)
    );
    
    grid.innerHTML = filteredRecipients.map(recipient => `
        <div class="recipient-card" data-id="${recipient.id}">
            <div class="recipient-name">${recipient.name}</div>
            <div class="recipient-email">${recipient.email}</div>
            <span class="recipient-type">${recipient.type}</span>
        </div>
    `).join('');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
    document.querySelectorAll('.recipient-card').forEach(card => {
        card.addEventListener('click', function() {
            const id = parseInt(this.dataset.id);
            if (selectedRecipients.includes(id)) {
                selectedRecipients = selectedRecipients.filter(rid => rid !== id);
                this.classList.remove('selected');
            } else {
                selectedRecipients.push(id);
                this.classList.add('selected');
            }
            updateSelectedCount();
            updateSendButton();
        });
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
function updateSelectedCount() {
    const count = selectedRecipients.length;
    document.getElementById('selectedCount').textContent = `${count} –≤—ã–±—Ä–∞–Ω–æ`;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
function updateSendButton() {
    const sendBtn = document.getElementById('sendBtn');
    const canSend = selectedTemplate && selectedRecipients.length > 0 && 
                   document.getElementById('emailSubject').value.trim();
    sendBtn.disabled = !canSend;
}

// –ü–æ–∏—Å–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
document.getElementById('recipientSearch').addEventListener('input', renderRecipients);

// –°–º–µ–Ω–∞ —Ç–∏–ø–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
document.querySelectorAll('input[name="recipientType"]').forEach(radio => {
    radio.addEventListener('change', function() {
        if (this.checked) {
            selectedRecipients = [];
            updateSelectedCount();
            updateSendButton();
            loadRecipients(this.value);
        }
    });
});

// –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
document.getElementById('previewBtn').addEventListener('click', function() {
    if (!selectedTemplate || selectedRecipients.length === 0) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π');
        return;
    }
    
    const previewSection = document.getElementById('previewSection');
    const previewLoading = document.getElementById('previewLoading');
    const emailPreview = document.getElementById('emailPreview');
    
    previewSection.style.display = 'block';
    previewLoading.style.display = 'block';
    emailPreview.style.display = 'none';
    
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    setTimeout(() => {
        previewLoading.style.display = 'none';
        emailPreview.style.display = 'block';
        // emailPreview.src = '/admin/communication/preview-email?template=' + selectedTemplate;
    }, 1000);
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ email
document.getElementById('sendBtn').addEventListener('click', function() {
    if (!selectedTemplate || selectedRecipients.length === 0) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π');
        return;
    }
    
    const subject = document.getElementById('emailSubject').value.trim();
    if (!subject) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –ø–∏—Å—å–º–∞');
        return;
    }
    
    let templateData = {};
    try {
        const templateDataText = document.getElementById('templateData').value.trim();
        if (templateDataText) {
            templateData = JSON.parse(templateDataText);
        }
    } catch (e) {
        alert('–û—à–∏–±–∫–∞ –≤ JSON –¥–∞–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–∞: ' + e.message);
        return;
    }
    
    const recipientType = document.querySelector('input[name="recipientType"]:checked').value;
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º email –∫–∞–∂–¥–æ–º—É –ø–æ–ª—É—á–∞—Ç–µ–ª—é
    let sentCount = 0;
    let errorCount = 0;
    
    this.disabled = true;
    this.textContent = 'üìß –û—Ç–ø—Ä–∞–≤–∫–∞...';
    
    selectedRecipients.forEach((recipientId, index) => {
        const data = {
            recipient_type: recipientType,
            recipient_id: recipientId,
            email_type: selectedTemplate,
            subject: subject,
            template_data: templateData
        };
        
        fetch('/admin/communication/send-professional-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                sentCount++;
            } else {
                errorCount++;
                console.error('Error sending email:', result.error);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã
            if (sentCount + errorCount === selectedRecipients.length) {
                this.disabled = false;
                this.textContent = 'üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å Email';
                
                if (errorCount === 0) {
                    alert(`‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${sentCount} email!`);
                    // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
                    selectedRecipients = [];
                    selectedTemplate = null;
                    document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
                    document.querySelectorAll('.recipient-card').forEach(c => c.classList.remove('selected'));
                    document.getElementById('emailSubject').value = '';
                    document.getElementById('templateData').value = '';
                    updateSelectedCount();
                    updateSendButton();
                } else {
                    alert(`‚ö†Ô∏è –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${sentCount} email, –æ—à–∏–±–æ–∫: ${errorCount}`);
                }
            }
        })
        .catch(error => {
            errorCount++;
            console.error('Error:', error);
            
            if (sentCount + errorCount === selectedRecipients.length) {
                this.disabled = false;
                this.textContent = 'üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å Email';
                alert(`‚ö†Ô∏è –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${sentCount} email, –æ—à–∏–±–æ–∫: ${errorCount}`);
            }
        });
    });
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–º—ã
document.getElementById('emailSubject').addEventListener('input', updateSendButton);

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
loadRecipients('user');
</script>
{% endblock %}
