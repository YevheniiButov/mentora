{% extends "admin/base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω - Communication Hub{% endblock %}

{% block extra_css %}
<style>
.form-card {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-top: 4px solid #3ECDC1;
}

.preview-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-top: 4px solid #17a2b8;
}

.stats-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-top: 4px solid #28a745;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω</h1>
            <p class="text-muted">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ "{{ template.name }}"</p>
        </div>
        <div>
            <a href="{{ url_for('communication.templates') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Form -->
        <div class="col-md-8">
            <div class="form-card">
                <form method="POST">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ *</label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       value="{{ template.name }}" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email_type" class="form-label">–¢–∏–ø –ø–∏—Å—å–º–∞ *</label>
                                <select class="form-select" id="email_type" name="email_type" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                                    <option value="crm_lead" {% if template.email_type == 'crm_lead' %}selected{% endif %}>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã</option>
                                    <option value="crm_follow_up" {% if template.email_type == 'crm_follow_up' %}selected{% endif %}>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</option>
                                    <option value="crm_welcome" {% if template.email_type == 'crm_welcome' %}selected{% endif %}>–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ</option>
                                    <option value="notification" {% if template.email_type == 'notification' %}selected{% endif %}>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</option>
                                    <option value="custom" {% if template.email_type == 'custom' %}selected{% endif %}>–ö–∞—Å—Ç–æ–º–Ω—ã–µ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="description" name="description" rows="2" 
                                  placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞">{{ description }}</textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="subject" class="form-label">–¢–µ–º–∞ –ø–∏—Å—å–º–∞ *</label>
                        <input type="text" class="form-control" id="subject" name="subject" 
                               value="{{ template.subject }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="message" class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ *</label>
                        <textarea class="form-control" id="message" name="message" rows="8" required
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è. –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å HTML —Ç–µ–≥–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.">{{ template.html_content }}</textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="action_url" class="form-label">–°—Å—ã–ª–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏</label>
                                <input type="url" class="form-control" id="action_url" name="action_url" 
                                       value="{{ action_url }}" placeholder="https://example.com">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="action_text" class="form-label">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏</label>
                                <input type="text" class="form-control" id="action_text" name="action_text" 
                                       value="{{ action_text }}" placeholder="–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ">
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('communication.templates') }}" class="btn btn-outline-secondary">
                            –û—Ç–º–µ–Ω–∞
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Preview and Stats -->
        <div class="col-md-4">
            <div class="preview-card mb-3">
                <h5 class="mb-3">üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h5>
                <div id="preview-content">
                    <h6 class="text-primary">{{ template.name }}</h6>
                    <p><strong>–¢–µ–º–∞:</strong> {{ template.subject }}</p>
                    <div class="border p-2 rounded bg-light">{{ template.html_content[:200] }}{% if template.html_content|length > 200 %}...{% endif %}</div>
                    {% if action_url and action_text %}
                    <div class="mt-2"><a href="{{ action_url }}" class="btn btn-sm btn-primary">{{ action_text }}</a></div>
                    {% endif %}
                </div>
            </div>

            <div class="stats-card">
                <h5 class="mb-3">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="h4 text-primary">{{ template.sent_count }}</div>
                        <small class="text-muted">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</small>
                    </div>
                    <div class="col-6">
                        <div class="h4 text-success">{{ template.created_at.strftime('%d.%m') }}</div>
                        <small class="text-muted">–°–æ–∑–¥–∞–Ω</small>
                    </div>
                </div>
                <hr>
                <div class="text-center">
                    <small class="text-muted">
                        –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {{ template.updated_at.strftime('%d.%m.%Y %H:%M') }}
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Live preview
function updatePreview() {
    const name = document.getElementById('name').value;
    const subject = document.getElementById('subject').value;
    const message = document.getElementById('message').value;
    const actionUrl = document.getElementById('action_url').value;
    const actionText = document.getElementById('action_text').value;
    
    let preview = '';
    
    if (name) {
        preview += `<h6 class="text-primary">${name}</h6>`;
    }
    
    if (subject) {
        preview += `<p><strong>–¢–µ–º–∞:</strong> ${subject}</p>`;
    }
    
    if (message) {
        preview += `<div class="border p-2 rounded bg-light">${message.replace(/\n/g, '<br>')}</div>`;
    }
    
    if (actionUrl && actionText) {
        preview += `<div class="mt-2"><a href="${actionUrl}" class="btn btn-sm btn-primary">${actionText}</a></div>`;
    }
    
    document.getElementById('preview-content').innerHTML = preview;
}

// Add event listeners
document.getElementById('name').addEventListener('input', updatePreview);
document.getElementById('subject').addEventListener('input', updatePreview);
document.getElementById('message').addEventListener('input', updatePreview);
document.getElementById('action_url').addEventListener('input', updatePreview);
document.getElementById('action_text').addEventListener('input', updatePreview);
</script>
{% endblock %}

