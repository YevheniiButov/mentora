{% extends "admin/base.html" %}

{% block title %}Email Inbox - Communication Hub{% endblock %}

{% block extra_css %}
<style>
/* Inbox Styles */
.inbox-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.inbox-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    color: white;
}

.inbox-header h1 {
    margin: 0;
    font-size: 2rem;
}

.inbox-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
    margin-bottom: 5px;
}

.stat-label {
    color: #6c757d;
    font-size: 0.9rem;
}

.inbox-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 15px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.filters {
    display: flex;
    gap: 15px;
    align-items: center;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-group label {
    font-size: 0.8rem;
    color: #6c757d;
    font-weight: 500;
}

.filter-group select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 0.9rem;
}

.fetch-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.3s;
}

.fetch-btn:hover {
    background: #218838;
}

.fetch-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

.email-list {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
}

.email-item {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid #eee;
    transition: background 0.3s;
    cursor: pointer;
}

.email-item:hover {
    background: #f8f9fa;
}

.email-item.unread {
    background: #f0f8ff;
    border-left: 4px solid #667eea;
}

.email-item.important {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
}

.email-item.spam {
    background: #f8d7da;
    border-left: 4px solid #dc3545;
}

.email-checkbox {
    margin-right: 15px;
}

.email-sender {
    min-width: 200px;
    font-weight: 500;
    color: #2c3e50;
}

.email-subject {
    flex: 1;
    margin: 0 20px;
    color: #495057;
}

.email-date {
    min-width: 120px;
    text-align: right;
    color: #6c757d;
    font-size: 0.9rem;
}

.email-actions {
    min-width: 100px;
    display: flex;
    gap: 5px;
    margin-left: 15px;
}

.action-btn {
    background: none;
    border: none;
    padding: 5px;
    border-radius: 3px;
    cursor: pointer;
    color: #6c757d;
    transition: all 0.3s;
}

.action-btn:hover {
    background: #e9ecef;
    color: #495057;
}

.action-btn.important {
    color: #ffc107;
}

.action-btn.important.active {
    color: #ffc107;
    background: #fff3cd;
}

.action-btn.spam {
    color: #dc3545;
}

.action-btn.spam.active {
    color: #dc3545;
    background: #f8d7da;
}

.action-btn.delete {
    color: #dc3545;
}

.action-btn.reply {
    color: #28a745;
}

.pagination {
    display: flex;
    justify-content: center;
    margin-top: 30px;
}

.pagination .page-link {
    padding: 8px 12px;
    margin: 0 2px;
    border: 1px solid #ddd;
    border-radius: 5px;
    color: #667eea;
    text-decoration: none;
    transition: all 0.3s;
}

.pagination .page-link:hover {
    background: #667eea;
    color: white;
}

.pagination .page-link.active {
    background: #667eea;
    color: white;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 20px;
    color: #dee2e6;
}

/* Responsive */
@media (max-width: 768px) {
    .inbox-controls {
        flex-direction: column;
        gap: 15px;
    }
    
    .filters {
        flex-wrap: wrap;
    }
    
    .email-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .email-sender, .email-subject, .email-date {
        min-width: auto;
        width: 100%;
    }
    
    .email-actions {
        margin-left: 0;
        width: 100%;
        justify-content: flex-end;
    }
}
</style>
{% endblock %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<div class="inbox-container">
    <!-- Header -->
    <div class="inbox-header">
        <div>
            <h1><i class="fas fa-inbox"></i> Email Inbox</h1>
            <p>Manage incoming emails from your POP/IMAP server</p>
        </div>
        <div>
            <a href="{{ url_for('communication.hub') }}" class="btn btn-light">
                <i class="fas fa-arrow-left"></i> Back to Hub
            </a>
        </div>
    </div>
    
    <!-- Statistics -->
    <div class="inbox-stats">
        <div class="stat-card">
            <div class="stat-number">{{ stats.total }}</div>
            <div class="stat-label">Total Emails</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.unread }}</div>
            <div class="stat-label">Unread</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.important }}</div>
            <div class="stat-label">Important</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ stats.spam }}</div>
            <div class="stat-label">Spam</div>
        </div>
    </div>
    
    <!-- Controls -->
    <div class="inbox-controls">
        <div class="filters">
            <div class="filter-group">
                <label>Category</label>
                <select id="categoryFilter" onchange="applyFilters()">
                    <option value="all" {% if current_category == 'all' %}selected{% endif %}>All Categories</option>
                    <option value="support" {% if current_category == 'support' %}selected{% endif %}>Support</option>
                    <option value="sales" {% if current_category == 'sales' %}selected{% endif %}>Sales</option>
                    <option value="general" {% if current_category == 'general' %}selected{% endif %}>General</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Status</label>
                <select id="statusFilter" onchange="applyFilters()">
                    <option value="all" {% if current_status == 'all' %}selected{% endif %}>All Emails</option>
                    <option value="unread" {% if current_status == 'unread' %}selected{% endif %}>Unread</option>
                    <option value="important" {% if current_status == 'important' %}selected{% endif %}>Important</option>
                    <option value="spam" {% if current_status == 'spam' %}selected{% endif %}>Spam</option>
                </select>
            </div>
        </div>
        <button class="fetch-btn" onclick="fetchEmails()" id="fetchBtn">
            <i class="fas fa-sync"></i> Fetch New Emails
        </button>
    </div>
    
    <!-- Email List -->
    <div class="email-list">
        {% if emails.items %}
            {% for email in emails.items %}
            <div class="email-item {% if not email.is_read %}unread{% endif %} {% if email.is_important %}important{% endif %} {% if email.is_spam %}spam{% endif %}" 
                 onclick="viewEmail({{ email.id }})">
                <div class="email-checkbox">
                    <input type="checkbox" onclick="event.stopPropagation()">
                </div>
                <div class="email-sender">
                    {{ email.sender_name or email.sender_email }}
                </div>
                <div class="email-subject">
                    {{ email.subject }}
                    {% if email.has_attachments %}
                        <i class="fas fa-paperclip" title="Has attachments"></i>
                    {% endif %}
                    {% if email.is_replied %}
                        <i class="fas fa-reply" title="Replied"></i>
                    {% endif %}
                </div>
                <div class="email-date">
                    {{ email.date_received.strftime('%d.%m.%Y %H:%M') }}
                </div>
                <div class="email-actions" onclick="event.stopPropagation()">
                    <button class="action-btn important {% if email.is_important %}active{% endif %}" 
                            onclick="toggleImportant({{ email.id }})" title="Mark as important">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="action-btn spam {% if email.is_spam %}active{% endif %}" 
                            onclick="toggleSpam({{ email.id }})" title="Mark as spam">
                        <i class="fas fa-ban"></i>
                    </button>
                    <button class="action-btn reply" onclick="replyEmail({{ email.id }})" title="Reply">
                        <i class="fas fa-reply"></i>
                    </button>
                    <button class="action-btn delete" onclick="deleteEmail({{ email.id }})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h3>No emails found</h3>
                <p>Click "Fetch New Emails" to retrieve emails from your server</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Pagination -->
    {% if emails.pages > 1 %}
    <div class="pagination">
        {% if emails.has_prev %}
            <a href="{{ url_for('communication.inbox', page=emails.prev_num, category=current_category, status=current_status) }}" class="page-link">
                <i class="fas fa-chevron-left"></i> Previous
            </a>
        {% endif %}
        
        {% for page_num in emails.iter_pages() %}
            {% if page_num %}
                {% if page_num != emails.page %}
                    <a href="{{ url_for('communication.inbox', page=page_num, category=current_category, status=current_status) }}" class="page-link">{{ page_num }}</a>
                {% else %}
                    <span class="page-link active">{{ page_num }}</span>
                {% endif %}
            {% else %}
                <span class="page-link">...</span>
            {% endif %}
        {% endfor %}
        
        {% if emails.has_next %}
            <a href="{{ url_for('communication.inbox', page=emails.next_num, category=current_category, status=current_status) }}" class="page-link">
                Next <i class="fas fa-chevron-right"></i>
            </a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function applyFilters() {
    const category = document.getElementById('categoryFilter').value;
    const status = document.getElementById('statusFilter').value;
    
    const url = new URL(window.location);
    url.searchParams.set('category', category);
    url.searchParams.set('status', status);
    url.searchParams.set('page', '1');
    
    window.location.href = url.toString();
}

function fetchEmails() {
    const btn = document.getElementById('fetchBtn');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching...';
    
    fetch('{{ url_for("communication.fetch_emails") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Successfully fetched ${data.count} new emails!`);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to fetch emails'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while fetching emails');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

function viewEmail(emailId) {
    window.location.href = `{{ url_for('communication.view_email', email_id=0) }}`.replace('0', emailId);
}

function toggleImportant(emailId) {
    fetch(`{{ url_for('communication.mark_important', email_id=0) }}`.replace('0', emailId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to update email'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}

function toggleSpam(emailId) {
    fetch(`{{ url_for('communication.mark_spam', email_id=0) }}`.replace('0', emailId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to update email'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}

function replyEmail(emailId) {
    window.location.href = `{{ url_for('communication.reply_email', email_id=0) }}`.replace('0', emailId);
}

function deleteEmail(emailId) {
    if (confirm('Are you sure you want to delete this email?')) {
        fetch(`{{ url_for('communication.delete_email', email_id=0) }}`.replace('0', emailId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to delete email'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
    }
}
</script>
{% endblock %}
