{% extends "admin/base.html" %}

{% block title %}–ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ - Communication Hub{% endblock %}

{% block extra_css %}
<style>
.bulk-email-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.email-editor-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-top: 20px;
}

@media (max-width: 1200px) {
    .email-editor-layout {
        grid-template-columns: 1fr;
    }
}

.editor-panel {
    background: white;
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.preview-panel {
    background: white;
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    position: sticky;
    top: 20px;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
}

.form-section {
    margin-bottom: 30px;
    padding-bottom: 30px;
    border-bottom: 1px solid #e2e8f0;
}

.form-section:last-child {
    border-bottom: none;
}

.form-section h3 {
    color: #1a202c;
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-section h3 i {
    color: #3ECDC1;
    font-size: 1.5rem;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    color: #4a5568;
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 0.95rem;
}

.form-group input[type="text"],
.form-group input[type="url"],
.form-group textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    font-family: inherit;
}

.form-group input[type="text"]:focus,
.form-group input[type="url"]:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #3ECDC1;
    box-shadow: 0 0 0 3px rgba(62, 205, 193, 0.1);
}

.form-group textarea {
    min-height: 100px;
    resize: vertical;
}

.form-group small {
    display: block;
    color: #718096;
    font-size: 0.85rem;
    margin-top: 6px;
}

.recipient-selector {
    background: #f8fafc;
    border-radius: 12px;
    padding: 20px;
    margin-top: 15px;
}

.recipient-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    margin-bottom: 10px;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.recipient-option:hover {
    border-color: #3ECDC1;
    background: #f0fdfa;
}

.recipient-option input[type="radio"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #3ECDC1;
}

.recipient-option label {
    flex: 1;
    cursor: pointer;
    margin: 0;
    font-weight: 500;
}

.recipient-option .badge {
    background: #3ECDC1;
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.custom-emails-input {
    margin-top: 15px;
}

.custom-emails-input textarea {
    min-height: 120px;
    font-family: monospace;
    font-size: 0.9rem;
}

.preview-frame {
    width: 100%;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    background: #f5f7fa;
    min-height: 600px;
}

.preview-frame iframe {
    width: 100%;
    height: 600px;
    border: none;
    background: white;
}

.action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
    padding-top: 30px;
    border-top: 2px solid #e2e8f0;
}

.btn {
    flex: 1;
    padding: 16px 24px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.btn-primary {
    background: linear-gradient(135deg, #3ECDC1 0%, #32A39A 100%);
    color: white;
    box-shadow: 0 4px 16px rgba(62, 205, 193, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(62, 205, 193, 0.4);
}

.btn-secondary {
    background: #e2e8f0;
    color: #4a5568;
}

.btn-secondary:hover {
    background: #cbd5e1;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.loading-overlay.active {
    display: flex;
}

.loading-spinner {
    background: white;
    padding: 40px;
    border-radius: 16px;
    text-align: center;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3ECDC1;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.alert {
    padding: 16px 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.alert-warning {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.value-prop-items {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.value-prop-item {
    display: flex;
    gap: 10px;
    align-items: flex-start;
}

.value-prop-item input {
    flex: 1;
}

.value-prop-item button {
    padding: 10px 16px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.value-prop-item button:hover {
    background: #dc2626;
}

.add-item-btn {
    padding: 10px 20px;
    background: #3ECDC1;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    margin-top: 10px;
    transition: all 0.3s ease;
}

.add-item-btn:hover {
    background: #32A39A;
    transform: translateY(-2px);
}
</style>
{% endblock %}

{% block content %}
<div class="bulk-email-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-0">üìß –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</h1>
            <p class="text-muted mb-0">–°–æ–∑–¥–∞–π—Ç–µ –∫—Ä–∞—Å–∏–≤–æ–µ –ø–∏—Å—å–º–æ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —á–µ—Ä–µ–∑ Resend</p>
        </div>
        <a href="{{ url_for('communication.hub') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –≤ Hub
        </a>
    </div>

    <div id="alert-container"></div>

    <form id="bulkEmailForm">
        <div class="email-editor-layout">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –†–µ–¥–∞–∫—Ç–æ—Ä -->
            <div class="editor-panel">
                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="form-section">
                    <h3><i class="bi bi-envelope"></i> –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    
                    <div class="form-group">
                        <label for="subject">–¢–µ–º–∞ –ø–∏—Å—å–º–∞ *</label>
                        <input type="text" id="subject" name="subject" required 
                               value="üéØ –ù–∞—á–Ω–∏—Ç–µ —Å–≤–æ–π –ø—É—Ç—å –∫ —É—Å–ø–µ—Ö—É"
                               placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –ø–∏—Å—å–º–∞">
                        <small>–¢–µ–º–∞ –ø–∏—Å—å–º–∞, –∫–æ—Ç–æ—Ä—É—é —É–≤–∏–¥—è—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª–∏</small>
                    </div>

                    <div class="form-group">
                        <label for="greeting_name">–ò–º—è –≤ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–∏</label>
                        <input type="text" id="greeting_name" name="greeting_name" 
                               value="–ò–≤–∞–Ω"
                               placeholder="–ò–º—è">
                        <small>–ò–º—è, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –≤ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ü—Ä–∏–≤–µ—Ç, –ò–≤–∞–Ω!")</small>
                    </div>
                </div>

                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                <div class="form-section">
                    <h3><i class="bi bi-type-h1"></i> –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∏—Å—å–º–∞</h3>
                    
                    <div class="form-group">
                        <label for="main_title">–ì–ª–∞–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
                        <input type="text" id="main_title" name="main_title" 
                               value="üéØ –ù–∞—á–Ω–∏—Ç–µ —Å–≤–æ–π –ø—É—Ç—å –∫ —É—Å–ø–µ—Ö—É"
                               placeholder="–ì–ª–∞–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫">
                        <small>–ë–æ–ª—å—à–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ –ø–∏—Å—å–º–∞</small>
                    </div>

                    <div class="form-group">
                        <label for="main_subtitle">–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
                        <input type="text" id="main_subtitle" name="main_subtitle" 
                               value="–ö–∞—Ä—Ç–∞ –û–±—É—á–µ–Ω–∏—è MENTORA –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å –≤–∞–º"
                               placeholder="–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫">
                        <small>–¢–µ–∫—Å—Ç –ø–æ–¥ –≥–ª–∞–≤–Ω—ã–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º</small>
                    </div>
                </div>

                <!-- –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ -->
                <div class="form-section">
                    <h3><i class="bi bi-text-paragraph"></i> –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ</h3>
                    
                    <div class="form-group">
                        <label for="intro_text">–í—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç</label>
                        <textarea id="intro_text" name="intro_text" rows="4"
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç...">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —ç–∫–∑–∞–º–µ–Ω—É BI-toets ‚Äî —ç—Ç–æ –≤–∞–∂–Ω—ã–π —à–∞–≥ –≤ –≤–∞—à–µ–π –∫–∞—Ä—å–µ—Ä–µ. –ú—ã —Å–æ–∑–¥–∞–ª–∏ –ö–∞—Ä—Ç—É –û–±—É—á–µ–Ω–∏—è MENTORA ‚Äî –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –ø—É—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º.</textarea>
                        <small>–û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç –ø–∏—Å—å–º–∞ –ø–æ—Å–ª–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è</small>
                    </div>
                </div>

                <!-- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ -->
                <div class="form-section">
                    <h3><i class="bi bi-star"></i> –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞</h3>
                    
                    <div class="form-group">
                        <label for="value_prop_title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤</label>
                        <input type="text" id="value_prop_title" name="value_prop_title" 
                               value="üí° –ü–æ—á–µ–º—É —Å—Ç–æ–∏—Ç –Ω–∞—á–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:"
                               placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
                    </div>

                    <div class="form-group">
                        <label>–°–ø–∏—Å–æ–∫ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤</label>
                        <div class="value-prop-items" id="valuePropItems">
                            <div class="value-prop-item">
                                <input type="text" class="value-prop-input" 
                                       value="–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ ‚Äî —Å–∏—Å—Ç–µ–º–∞ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –≤–∞—à —É—Ä–æ–≤–µ–Ω—å"
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ">
                                <button type="button" class="remove-item-btn" onclick="removeValuePropItem(this)">√ó</button>
                            </div>
                            <div class="value-prop-item">
                                <input type="text" class="value-prop-input" 
                                       value="–≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ ‚Äî —á–µ—Ç–∫–∏–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å"
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ">
                                <button type="button" class="remove-item-btn" onclick="removeValuePropItem(this)">√ó</button>
                            </div>
                            <div class="value-prop-item">
                                <input type="text" class="value-prop-input" 
                                       value="–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ‚Äî –≤–∏–¥–∏—Ç–µ —Å–≤–æ–π —Ä–æ—Å—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ">
                                <button type="button" class="remove-item-btn" onclick="removeValuePropItem(this)">√ó</button>
                            </div>
                            <div class="value-prop-item">
                                <input type="text" class="value-prop-input" 
                                       value="–ì–∏–±–∫–æ—Å—Ç—å ‚Äî —É—á–∏—Ç–µ—Å—å –≤ —Å–≤–æ–µ–º —Ç–µ–º–ø–µ, –∫–æ–≥–¥–∞ —É–¥–æ–±–Ω–æ"
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ">
                                <button type="button" class="remove-item-btn" onclick="removeValuePropItem(this)">√ó</button>
                            </div>
                        </div>
                        <button type="button" class="add-item-btn" onclick="addValuePropItem()">
                            <i class="bi bi-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ
                        </button>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–∑—ã–≤–∞ –∫ –¥–µ–π—Å—Ç–≤–∏—é -->
                <div class="form-section">
                    <h3><i class="bi bi-cursor-click"></i> –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–∑—ã–≤–∞ –∫ –¥–µ–π—Å—Ç–≤–∏—é</h3>
                    
                    <div class="form-group">
                        <label for="cta_text">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏</label>
                        <input type="text" id="cta_text" name="cta_text" 
                               value="üöÄ –û—Ç–∫—Ä—ã—Ç—å –ö–∞—Ä—Ç—É –û–±—É—á–µ–Ω–∏—è"
                               placeholder="–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏">
                    </div>

                    <div class="form-group">
                        <label for="cta_url">URL –∫–Ω–æ–ø–∫–∏</label>
                        <input type="url" id="cta_url" name="cta_url" 
                               value="https://bigmentor.nl/learning-map"
                               placeholder="https://example.com">
                    </div>
                </div>

                <!-- –ú–æ—Ç–∏–≤–∞—Ü–∏—è -->
                <div class="form-section">
                    <h3><i class="bi bi-heart"></i> –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫</h3>
                    
                    <div class="form-group">
                        <label for="motivation_title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ—Ç–∏–≤–∞—Ü–∏–∏</label>
                        <input type="text" id="motivation_title" name="motivation_title" 
                               value="üí™ –ù–∞—á–Ω–∏—Ç–µ —Å –º–∞–ª–æ–≥–æ"
                               placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
                    </div>

                    <div class="form-group">
                        <label for="motivation_text">–¢–µ–∫—Å—Ç –º–æ—Ç–∏–≤–∞—Ü–∏–∏</label>
                        <textarea id="motivation_text" name="motivation_text" rows="3"
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç...">–ù–µ –Ω—É–∂–Ω–æ —Å—Ä–∞–∑—É –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –≤—Å–µ –º–æ–¥—É–ª–∏. –ù–∞—á–Ω–∏—Ç–µ —Å 15-20 –º–∏–Ω—É—Ç –≤ –¥–µ–Ω—å ‚Äî —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å –∏ –≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å.</textarea>
                    </div>
                </div>

                <!-- –ü–æ–ª—É—á–∞—Ç–µ–ª–∏ -->
                <div class="form-section">
                    <h3><i class="bi bi-people"></i> –ü–æ–ª—É—á–∞—Ç–µ–ª–∏</h3>
                    
                    <div class="recipient-selector">
                        <div class="recipient-option">
                            <input type="radio" id="recipient_all" name="recipient_type" value="all" checked>
                            <label for="recipient_all">–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</label>
                            <span class="badge">{{ total_users }}</span>
                        </div>
                        
                        <div class="recipient-option">
                            <input type="radio" id="recipient_users" name="recipient_type" value="users">
                            <label for="recipient_users">–¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</label>
                            <span class="badge">{{ total_users }}</span>
                        </div>
                        
                        <div class="recipient-option">
                            <input type="radio" id="recipient_marketing" name="recipient_type" value="users">
                            <label for="recipient_marketing">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —Å–æ–≥–ª–∞—Å–∏–µ–º –Ω–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥</label>
                            <span class="badge">{{ users_with_marketing }}</span>
                            <input type="hidden" id="filter_marketing_consent" name="filter_marketing_consent" value="false">
                        </div>
                        
                        <div class="recipient-option">
                            <input type="radio" id="recipient_contacts" name="recipient_type" value="contacts">
                            <label for="recipient_contacts">–¢–æ–ª—å–∫–æ –∫–æ–Ω—Ç–∞–∫—Ç—ã</label>
                            <span class="badge">{{ total_contacts }}</span>
                        </div>
                        
                        <div class="recipient-option">
                            <input type="radio" id="recipient_custom" name="recipient_type" value="custom">
                            <label for="recipient_custom">–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ email</label>
                        </div>
                    </div>

                    <div class="custom-emails-input" id="customEmailsInput" style="display: none;">
                        <label for="recipient_emails">–°–ø–∏—Å–æ–∫ email (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label>
                        <textarea id="recipient_emails" name="recipient_emails" rows="6"
                                  placeholder="user1@example.com&#10;user2@example.com&#10;user3@example.com"></textarea>
                        <small>–í–≤–µ–¥–∏—Ç–µ email –∞–¥—Ä–µ—Å–∞, –ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É</small>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div class="action-buttons">
                    <button type="button" class="btn btn-secondary" onclick="updatePreview()">
                        <i class="bi bi-eye"></i> –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é
                    </button>
                    <button type="submit" class="btn btn-primary" id="sendBtn">
                        <i class="bi bi-send"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
                    </button>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –ü—Ä–µ–≤—å—é -->
            <div class="preview-panel">
                <h3 class="mb-3">
                    <i class="bi bi-eye" style="color: #3ECDC1;"></i> –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–∏—Å—å–º–∞
                </h3>
                <div class="preview-frame">
                    <iframe id="previewFrame" src="about:blank"></iframe>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <p>–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å–µ–º...</p>
        <small>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</small>
    </div>
</div>

<script>
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é
function updatePreview() {
    const formData = new FormData(document.getElementById('bulkEmailForm'));
    const data = {};
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
    for (let [key, value] of formData.entries()) {
        if (key === 'value_prop_items') {
            if (!data[key]) data[key] = [];
            data[key].push(value);
        } else {
            data[key] = value;
        }
    }
    
    // –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
    const valuePropItems = [];
    document.querySelectorAll('.value-prop-input').forEach(input => {
        if (input.value.trim()) {
            valuePropItems.push(input.value.trim());
        }
    });
    data.value_prop_items = valuePropItems;
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø—Ä–µ–≤—å—é
    fetch('{{ url_for("communication.bulk_email") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            ...data,
            preview: true
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success && result.html) {
            const iframe = document.getElementById('previewFrame');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(result.html);
            iframeDoc.close();
        }
    })
    .catch(error => {
        console.error('Error updating preview:', error);
    });
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
function addValuePropItem() {
    const container = document.getElementById('valuePropItems');
    const newItem = document.createElement('div');
    newItem.className = 'value-prop-item';
    newItem.innerHTML = `
        <input type="text" class="value-prop-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ">
        <button type="button" class="remove-item-btn" onclick="removeValuePropItem(this)">√ó</button>
    `;
    container.appendChild(newItem);
}

// –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
function removeValuePropItem(btn) {
    btn.parentElement.remove();
}

// –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –ø–æ–ª—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö email
document.querySelectorAll('input[name="recipient_type"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const customInput = document.getElementById('customEmailsInput');
        const marketingConsent = document.getElementById('filter_marketing_consent');
        
        if (this.value === 'custom') {
            customInput.style.display = 'block';
        } else {
            customInput.style.display = 'none';
        }
        
        if (this.id === 'recipient_marketing') {
            marketingConsent.value = 'true';
        } else {
            marketingConsent.value = 'false';
        }
    });
});

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
const autoUpdateFields = ['subject', 'greeting_name', 'main_title', 'main_subtitle', 
                          'intro_text', 'value_prop_title', 'cta_text', 'cta_url', 
                          'motivation_title', 'motivation_text'];
autoUpdateFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
        field.addEventListener('input', debounce(updatePreview, 500));
    }
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('value-prop-input')) {
        debounce(updatePreview, 500)();
    }
});

// Debounce —Ñ—É–Ω–∫—Ü–∏—è
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
document.getElementById('bulkEmailForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
    const valuePropItems = [];
    document.querySelectorAll('.value-prop-input').forEach(input => {
        if (input.value.trim()) {
            valuePropItems.push(input.value.trim());
        }
    });
    data.value_prop_items = valuePropItems;
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞
    if (data.recipient_type === 'users' && document.getElementById('recipient_marketing').checked) {
        data.filter_marketing_consent = true;
    } else {
        data.filter_marketing_consent = false;
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö email
    if (data.recipient_type === 'custom') {
        const emailsText = data.recipient_emails || '';
        data.recipient_emails = emailsText.split('\n').map(email => email.trim()).filter(email => email);
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    document.getElementById('loadingOverlay').classList.add('active');
    document.getElementById('sendBtn').disabled = true;
    
    try {
        const response = await fetch('{{ url_for("communication.bulk_email") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        document.getElementById('loadingOverlay').classList.remove('active');
        document.getElementById('sendBtn').disabled = false;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        const alertContainer = document.getElementById('alert-container');
        if (result.success) {
            alertContainer.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i>
                    <div>
                        <strong>–£—Å–ø–µ—à–Ω–æ!</strong> ${result.message}
                        <br><small>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${result.sent}, –ù–µ —É–¥–∞–ª–æ—Å—å: ${result.failed || 0}</small>
                    </div>
                </div>
            `;
        } else {
            alertContainer.innerHTML = `
                <div class="alert alert-error">
                    <i class="bi bi-x-circle"></i>
                    <div>
                        <strong>–û—à–∏–±–∫–∞!</strong> ${result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–∞'}
                    </div>
                </div>
            `;
        }
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –∞–ª–µ—Ä—Ç—É
        alertContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
    } catch (error) {
        document.getElementById('loadingOverlay').classList.remove('active');
        document.getElementById('sendBtn').disabled = false;
        
        document.getElementById('alert-container').innerHTML = `
            <div class="alert alert-error">
                <i class="bi bi-x-circle"></i>
                <div>
                    <strong>–û—à–∏–±–∫–∞!</strong> ${error.message}
                </div>
            </div>
        `;
    }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–µ–≤—å—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
});
</script>
{% endblock %}

