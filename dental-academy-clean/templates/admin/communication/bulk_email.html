{% extends "admin/base.html" %}

{% block title %}–ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ - Communication Hub{% endblock %}

{% block extra_css %}
<style>
.bulk-email-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.email-editor-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-top: 20px;
}

@media (max-width: 1200px) {
    .email-editor-layout {
        grid-template-columns: 1fr;
    }
}

.editor-panel {
    background: white;
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.preview-panel {
    background: white;
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    position: sticky;
    top: 20px;
    max-height: calc(100vh - 40px);
    overflow-y: auto;
}

.form-section {
    margin-bottom: 30px;
    padding-bottom: 30px;
    border-bottom: 1px solid #e2e8f0;
}

.form-section:last-child {
    border-bottom: none;
}

.form-section h3 {
    color: #1a202c;
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-section h3 i {
    color: #3ECDC1;
    font-size: 1.5rem;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    color: #4a5568;
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 0.95rem;
}

.form-group input[type="text"],
.form-group input[type="url"],
.form-group input[type="file"],
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    font-family: inherit;
}

.form-group input[type="text"]:focus,
.form-group input[type="url"]:focus,
.form-group input[type="file"]:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: #3ECDC1;
    box-shadow: 0 0 0 3px rgba(62, 205, 193, 0.1);
}

.form-group textarea {
    min-height: 100px;
    resize: vertical;
}

.form-group small {
    display: block;
    color: #718096;
    font-size: 0.85rem;
    margin-top: 6px;
}

.recipient-selector {
    background: #f8fafc;
    border-radius: 12px;
    padding: 20px;
    margin-top: 15px;
}

.recipient-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    margin-bottom: 10px;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.recipient-option:hover {
    border-color: #3ECDC1;
    background: #f0fdfa;
}

.recipient-option input[type="radio"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #3ECDC1;
}

.recipient-option label {
    flex: 1;
    cursor: pointer;
    margin: 0;
    font-weight: 500;
}

.recipient-option .badge {
    background: #3ECDC1;
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.custom-emails-input {
    margin-top: 15px;
}

.custom-emails-input textarea {
    min-height: 120px;
    font-family: monospace;
    font-size: 0.9rem;
}

.preview-frame {
    width: 100%;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
    background: #f5f7fa;
    min-height: 600px;
}

.preview-frame iframe {
    width: 100%;
    height: 600px;
    border: none;
    background: white;
}

.action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
    padding-top: 30px;
    border-top: 2px solid #e2e8f0;
}

.btn {
    flex: 1;
    padding: 16px 24px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.btn-primary {
    background: linear-gradient(135deg, #3ECDC1 0%, #32A39A 100%);
    color: white;
    box-shadow: 0 4px 16px rgba(62, 205, 193, 0.3);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(62, 205, 193, 0.4);
}

.btn-secondary {
    background: #e2e8f0;
    color: #4a5568;
}

.btn-secondary:hover {
    background: #cbd5e1;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.loading-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}

.loading-overlay.active {
    display: flex;
}

.loading-spinner {
    background: white;
    padding: 40px;
    border-radius: 16px;
    text-align: center;
}

.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3ECDC1;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.alert {
    padding: 16px 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.alert-success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.alert-error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.alert-warning {
    background: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.value-prop-items {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.value-prop-item {
    display: flex;
    gap: 10px;
    align-items: flex-start;
}

.value-prop-item input {
    flex: 1;
}

.value-prop-item button {
    padding: 10px 16px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.value-prop-item button:hover {
    background: #dc2626;
}

.add-item-btn {
    padding: 10px 20px;
    background: #3ECDC1;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    margin-top: 10px;
    transition: all 0.3s ease;
}

.add-item-btn:hover {
    background: #32A39A;
    transform: translateY(-2px);
}
</style>
{% endblock %}

{% block content %}
<div class="bulk-email-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-0">üìß –ú–∞—Å—Å–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞</h1>
            <p class="text-muted mb-0">–°–æ–∑–¥–∞–π—Ç–µ –∫—Ä–∞—Å–∏–≤–æ–µ –ø–∏—Å—å–º–æ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —á–µ—Ä–µ–∑ Resend</p>
        </div>
        <a href="{{ url_for('communication.hub') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –≤ Hub
        </a>
    </div>

    <div id="alert-container"></div>

    <form id="bulkEmailForm" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="email-editor-layout">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –†–µ–¥–∞–∫—Ç–æ—Ä -->
            <div class="editor-panel">
                <!-- –í—ã–±–æ—Ä —à–∞–±–ª–æ–Ω–∞ -->
                <div class="form-section">
                    <h3><i class="bi bi-file-earmark-text"></i> –®–∞–±–ª–æ–Ω –ø–∏—Å—å–º–∞</h3>
                    
                    <div class="form-group">
                        <label for="email_template_type">–¢–∏–ø —à–∞–±–ª–æ–Ω–∞</label>
                        <select id="email_template_type" name="email_template_type" class="form-control">
                            <option value="universal">–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω</option>
                            <option value="learning_map_welcome">Learning Map Welcome (—Å GIF)</option>
                        </select>
                        <small>–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –ø–∏—Å—å–º–∞. Learning Map Welcome –≤–∫–ª—é—á–∞–µ—Ç GIF –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω.</small>
                    </div>

                    <div class="form-group" id="gifUploadGroup" style="display: none;">
                        <label for="gif_file">GIF —Ñ–∞–π–ª –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è</label>
                        <input type="file" id="gif_file" name="gif_file" accept="image/gif">
                        <small>–ó–∞–≥—Ä—É–∑–∏—Ç–µ GIF —Ñ–∞–π–ª –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –≤ –ø–∏—Å—å–º–æ (—Ç–æ–ª—å–∫–æ –¥–ª—è Learning Map Welcome)</small>
                    </div>

                    <div class="form-group" id="welcomeCtaGroup" style="display: none;">
                        <label for="cta_url_welcome">URL –∫–Ω–æ–ø–∫–∏ "Open Your Learning Map"</label>
                        <input type="url" id="cta_url_welcome" name="cta_url" 
                               value="https://bigmentor.nl/en/learning-map"
                               placeholder="https://bigmentor.nl/en/learning-map">
                        <small>URL –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏–∑—ã–≤–∞ –∫ –¥–µ–π—Å—Ç–≤–∏—é –≤ welcome –ø–∏—Å—å–º–µ</small>
                    </div>
                </div>

                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                <div class="form-section">
                    <h3><i class="bi bi-envelope"></i> –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                    
                    <div class="form-group">
                        <label for="subject">–¢–µ–º–∞ –ø–∏—Å—å–º–∞ *</label>
                        <input type="text" id="subject" name="subject" required 
                               value="Your Learning Map is Ready"
                               placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –ø–∏—Å—å–º–∞">
                        <small>–¢–µ–º–∞ –ø–∏—Å—å–º–∞, –∫–æ—Ç–æ—Ä—É—é —É–≤–∏–¥—è—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª–∏</small>
                    </div>

                    <div class="form-group">
                        <label for="greeting_name">–ò–º—è –≤ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–∏</label>
                        <input type="text" id="greeting_name" name="greeting_name" 
                               value="there"
                               placeholder="–ò–º—è –∏–ª–∏ 'there'">
                        <small>–ò–º—è, –∫–æ—Ç–æ—Ä–æ–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –≤ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Hi there!" –∏–ª–∏ "Hi John!")</small>
                    </div>
                </div>

                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
                <div class="form-section">
                    <h3><i class="bi bi-type-h1"></i> –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∏—Å—å–º–∞</h3>
                    
                    <div class="form-group">
                        <label for="main_title">–ì–ª–∞–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
                        <input type="text" id="main_title" name="main_title" 
                               value="üéØ –ù–∞—á–Ω–∏—Ç–µ —Å–≤–æ–π –ø—É—Ç—å –∫ —É—Å–ø–µ—Ö—É"
                               placeholder="–ì–ª–∞–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫">
                        <small>–ë–æ–ª—å—à–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ –ø–∏—Å—å–º–∞</small>
                    </div>

                    <div class="form-group">
                        <label for="main_subtitle">–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
                        <input type="text" id="main_subtitle" name="main_subtitle" 
                               value="–ö–∞—Ä—Ç–∞ –û–±—É—á–µ–Ω–∏—è MENTORA –≥–æ—Ç–æ–≤–∞ –ø–æ–º–æ—á—å –≤–∞–º"
                               placeholder="–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫">
                        <small>–¢–µ–∫—Å—Ç –ø–æ–¥ –≥–ª–∞–≤–Ω—ã–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º</small>
                    </div>
                </div>

                <!-- –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ -->
                <div class="form-section">
                    <h3><i class="bi bi-text-paragraph"></i> –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ</h3>
                    
                    <div class="form-group">
                        <label for="intro_text">–í—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç</label>
                        <textarea id="intro_text" name="intro_text" rows="4"
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç...">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —ç–∫–∑–∞–º–µ–Ω—É BI-toets ‚Äî —ç—Ç–æ –≤–∞–∂–Ω—ã–π —à–∞–≥ –≤ –≤–∞—à–µ–π –∫–∞—Ä—å–µ—Ä–µ. –ú—ã —Å–æ–∑–¥–∞–ª–∏ –ö–∞—Ä—Ç—É –û–±—É—á–µ–Ω–∏—è MENTORA ‚Äî –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –ø—É—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º.</textarea>
                        <small>–û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç –ø–∏—Å—å–º–∞ –ø–æ—Å–ª–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è</small>
                    </div>
                </div>

                <!-- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ -->
                <div class="form-section">
                    <h3><i class="bi bi-star"></i> –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞</h3>
                    
                    <div class="form-group">
                        <label for="value_prop_title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤</label>
                        <input type="text" id="value_prop_title" name="value_prop_title" 
                               value="üí° –ü–æ—á–µ–º—É —Å—Ç–æ–∏—Ç –Ω–∞—á–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å:"
                               placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
                    </div>

                    <div class="form-group">
                        <label>–°–ø–∏—Å–æ–∫ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤</label>
                        <div class="value-prop-items" id="valuePropItems">
                            <div class="value-prop-item">
                                <input type="text" class="value-prop-input" 
                                       value="–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ ‚Äî —Å–∏—Å—Ç–µ–º–∞ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –≤–∞—à —É—Ä–æ–≤–µ–Ω—å"
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ">
                                <button type="button" class="remove-item-btn" onclick="removeValuePropItem(this)">√ó</button>
                            </div>
                            <div class="value-prop-item">
                                <input type="text" class="value-prop-input" 
                                       value="–≠–∫–æ–Ω–æ–º–∏—è –≤—Ä–µ–º–µ–Ω–∏ ‚Äî —á–µ—Ç–∫–∏–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –∫–∞–∂–¥—ã–π –¥–µ–Ω—å"
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ">
                                <button type="button" class="remove-item-btn" onclick="removeValuePropItem(this)">√ó</button>
                            </div>
                            <div class="value-prop-item">
                                <input type="text" class="value-prop-input" 
                                       value="–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ‚Äî –≤–∏–¥–∏—Ç–µ —Å–≤–æ–π —Ä–æ—Å—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ">
                                <button type="button" class="remove-item-btn" onclick="removeValuePropItem(this)">√ó</button>
                            </div>
                            <div class="value-prop-item">
                                <input type="text" class="value-prop-input" 
                                       value="–ì–∏–±–∫–æ—Å—Ç—å ‚Äî —É—á–∏—Ç–µ—Å—å –≤ —Å–≤–æ–µ–º —Ç–µ–º–ø–µ, –∫–æ–≥–¥–∞ —É–¥–æ–±–Ω–æ"
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ">
                                <button type="button" class="remove-item-btn" onclick="removeValuePropItem(this)">√ó</button>
                            </div>
                        </div>
                        <button type="button" class="add-item-btn" onclick="addValuePropItem()">
                            <i class="bi bi-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ
                        </button>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–∑—ã–≤–∞ –∫ –¥–µ–π—Å—Ç–≤–∏—é -->
                <div class="form-section">
                    <h3><i class="bi bi-cursor-click"></i> –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–∑—ã–≤–∞ –∫ –¥–µ–π—Å—Ç–≤–∏—é</h3>
                    
                    <div class="form-group">
                        <label for="cta_text">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏</label>
                        <input type="text" id="cta_text" name="cta_text" 
                               value="üöÄ –û—Ç–∫—Ä—ã—Ç—å –ö–∞—Ä—Ç—É –û–±—É—á–µ–Ω–∏—è"
                               placeholder="–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏">
                    </div>

                    <div class="form-group">
                        <label for="cta_url">URL –∫–Ω–æ–ø–∫–∏</label>
                        <input type="url" id="cta_url" name="cta_url" 
                               value="https://bigmentor.nl/learning-map"
                               placeholder="https://example.com">
                    </div>
                </div>

                <!-- –ú–æ—Ç–∏–≤–∞—Ü–∏—è -->
                <div class="form-section">
                    <h3><i class="bi bi-heart"></i> –ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫</h3>
                    
                    <div class="form-group">
                        <label for="motivation_title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ—Ç–∏–≤–∞—Ü–∏–∏</label>
                        <input type="text" id="motivation_title" name="motivation_title" 
                               value="üí™ –ù–∞—á–Ω–∏—Ç–µ —Å –º–∞–ª–æ–≥–æ"
                               placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
                    </div>

                    <div class="form-group">
                        <label for="motivation_text">–¢–µ–∫—Å—Ç –º–æ—Ç–∏–≤–∞—Ü–∏–∏</label>
                        <textarea id="motivation_text" name="motivation_text" rows="3"
                                  placeholder="–í–≤–µ–¥–∏—Ç–µ –º–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç...">–ù–µ –Ω—É–∂–Ω–æ —Å—Ä–∞–∑—É –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –≤—Å–µ –º–æ–¥—É–ª–∏. –ù–∞—á–Ω–∏—Ç–µ —Å 15-20 –º–∏–Ω—É—Ç –≤ –¥–µ–Ω—å ‚Äî —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á—Ç–æ–±—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å –∏ –≤–∏–¥–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å.</textarea>
                    </div>
                </div>

                <!-- –ü–æ–ª—É—á–∞—Ç–µ–ª–∏ -->
                <div class="form-section">
                    <h3><i class="bi bi-people"></i> –ü–æ–ª—É—á–∞—Ç–µ–ª–∏</h3>
                    
                    <div class="recipient-selector">
                        <div class="recipient-option">
                            <input type="radio" id="recipient_all" name="recipient_type" value="all" checked>
                            <label for="recipient_all">–í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</label>
                            <span class="badge">{{ total_users }}</span>
                        </div>
                        
                        <div class="recipient-option">
                            <input type="radio" id="recipient_users" name="recipient_type" value="users">
                            <label for="recipient_users">–¢–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</label>
                            <span class="badge">{{ total_users }}</span>
                        </div>
                        
                        <div class="recipient-option">
                            <input type="radio" id="recipient_marketing" name="recipient_type" value="users">
                            <label for="recipient_marketing">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å —Å–æ–≥–ª–∞—Å–∏–µ–º –Ω–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥</label>
                            <span class="badge">{{ users_with_marketing }}</span>
                            <input type="hidden" id="filter_marketing_consent" name="filter_marketing_consent" value="false">
                        </div>
                        
                        <div class="recipient-option">
                            <input type="radio" id="recipient_contacts" name="recipient_type" value="contacts">
                            <label for="recipient_contacts">–¢–æ–ª—å–∫–æ –∫–æ–Ω—Ç–∞–∫—Ç—ã</label>
                            <span class="badge">{{ total_contacts }}</span>
                        </div>
                        
                        <div class="recipient-option">
                            <input type="radio" id="recipient_custom" name="recipient_type" value="custom">
                            <label for="recipient_custom">–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ email</label>
                        </div>
                        
                        <div class="recipient-option">
                            <input type="radio" id="recipient_selected" name="recipient_type" value="selected">
                            <label for="recipient_selected">–í—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</label>
                        </div>
                    </div>

                    <div class="custom-emails-input" id="customEmailsInput" style="display: none;">
                        <label for="recipient_emails">–°–ø–∏—Å–æ–∫ email (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)</label>
                        <textarea id="recipient_emails" name="recipient_emails" rows="6"
                                  placeholder="user1@example.com&#10;user2@example.com&#10;user3@example.com"></textarea>
                        <small>–í–≤–µ–¥–∏—Ç–µ email –∞–¥—Ä–µ—Å–∞, –ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É</small>
                    </div>

                    <div class="selected-users-input" id="selectedUsersInput" style="display: none; margin-top: 20px;">
                        <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Å–ø–∏—Å–∫–∞:</label>
                        <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-top: 8px;">
                            <div style="margin-bottom: 8px;">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllUsers()">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllUsers()">–°–Ω—è—Ç—å –≤—ã–±–æ—Ä</button>
                            </div>
                            {% for user in all_users %}
                            <div style="padding: 8px; border-bottom: 1px solid #f1f5f9;">
                                <label style="display: flex; align-items: center; cursor: pointer; margin: 0;">
                                    <input type="checkbox" name="selected_user_ids" value="{{ user.id }}" 
                                           class="user-checkbox" style="margin-right: 8px;">
                                    <span>{{ user.email }}</span>
                                    {% if user.first_name or user.last_name %}
                                    <span style="color: #64748b; margin-left: 8px;">({{ user.first_name }} {{ user.last_name }})</span>
                                    {% endif %}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        <small>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–º –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ</small>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                <div class="action-buttons">
                    <button type="button" class="btn btn-secondary" onclick="updatePreview()">
                        <i class="bi bi-eye"></i> –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–≤—å—é
                    </button>
                    <button type="submit" class="btn btn-primary" id="sendBtn">
                        <i class="bi bi-send"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
                    </button>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –ü—Ä–µ–≤—å—é -->
            <div class="preview-panel">
                <h3 class="mb-3">
                    <i class="bi bi-eye" style="color: #3ECDC1;"></i> –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–∏—Å—å–º–∞
                </h3>
                <div class="preview-frame">
                    <iframe id="previewFrame" src="about:blank"></iframe>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <p>–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å–µ–º...</p>
        <small>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</small>
    </div>
</div>

<script>
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é
function updatePreview() {
    const formData = new FormData(document.getElementById('bulkEmailForm'));
    const data = {};
    
    // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã (–∏—Å–∫–ª—é—á–∞–µ–º —Ñ–∞–π–ª—ã –¥–ª—è –ø—Ä–µ–≤—å—é)
    for (let [key, value] of formData.entries()) {
        if (key === 'gif_file') {
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ñ–∞–π–ª –¥–ª—è –ø—Ä–µ–≤—å—é (–±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω placeholder)
            continue;
        }
        if (key === 'value_prop_items') {
            if (!data[key]) data[key] = [];
            data[key].push(value);
        } else {
            data[key] = value;
        }
    }
    
    // –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
    const valuePropItems = [];
    document.querySelectorAll('.value-prop-input').forEach(input => {
        if (input.value.trim()) {
            valuePropItems.push(input.value.trim());
        }
    });
    data.value_prop_items = valuePropItems;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ –ø—Ä–µ–≤—å—é
    data.preview = true;
    
    // –î–ª—è learning_map_welcome —à–∞–±–ª–æ–Ω–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ GIF –∏ –±–µ—Ä–µ–º CTA URL
    if (data.email_template_type === 'learning_map_welcome') {
        const gifFile = document.getElementById('gif_file').files[0];
        data.has_gif = !!gifFile;
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø–æ–ª–µ –¥–ª—è welcome —à–∞–±–ª–æ–Ω–∞
        const welcomeCtaUrl = document.getElementById('cta_url_welcome');
        if (welcomeCtaUrl) {
            data.cta_url = welcomeCtaUrl.value || 'https://bigmentor.nl/en/learning-map';
        }
    }
    
    // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                     document.querySelector('input[name="csrf_token"]')?.value || 
                     '{{ csrf_token() }}';
    
    // –î–æ–±–∞–≤–ª—è–µ–º CSRF —Ç–æ–∫–µ–Ω –≤ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ (Flask-WTF –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫, –∏ —Ç–µ–ª–æ)
    data.csrf_token = csrfToken;
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø—Ä–µ–≤—å—é
    fetch('{{ url_for("communication.bulk_email") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            return response.text().then(text => {
                console.error('Server returned non-JSON response:', text.substring(0, 200));
                throw new Error('Server returned HTML instead of JSON. Check server logs.');
            });
        }
        return response.json();
    })
    .then(result => {
        if (result.success && result.html) {
            const iframe = document.getElementById('previewFrame');
            // –ó–∞–º–µ–Ω—è–µ–º CID –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ placeholder –¥–ª—è preview –≤ –±—Ä–∞—É–∑–µ—Ä–µ
            // CID —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ email –∫–ª–∏–µ–Ω—Ç–∞—Ö, –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å placeholder
            let previewHtml = result.html;
            // –ó–∞–º–µ–Ω—è–µ–º cid: –Ω–∞ placeholder –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (SVG placeholder)
            previewHtml = previewHtml.replace(/src="cid:([^"]+)"/g, (match, cid) => {
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π SVG placeholder
                const svgPlaceholder = encodeURIComponent(`
                    <svg width="600" height="300" xmlns="http://www.w3.org/2000/svg">
                        <rect width="100%" height="100%" fill="#f0f0f0"/>
                        <text x="50%" y="50%" font-family="Arial, sans-serif" font-size="14" fill="#999999" 
                              text-anchor="middle" dominant-baseline="middle">
                            Image will appear here in email
                        </text>
                    </svg>
                `.trim());
                return `src="data:image/svg+xml,${svgPlaceholder}" alt="Image placeholder" style="max-width: 100%; height: auto;"`;
            });
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º srcdoc –≤–º–µ—Å—Ç–æ document.write –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞
            iframe.srcdoc = previewHtml;
        } else {
            console.error('Preview generation failed:', result.error || 'Unknown error');
            const iframe = document.getElementById('previewFrame');
            iframe.srcdoc = `
                <div style="padding: 20px; color: #dc3545;">
                    <h3>–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞</h3>
                    <p>${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error updating preview:', error);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        const iframe = document.getElementById('previewFrame');
        iframe.srcdoc = `
            <div style="padding: 20px; color: #dc3545;">
                <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞</h3>
                <p>${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>
                <p style="font-size: 12px; color: #666;">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π</p>
            </div>
        `;
    });
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
function addValuePropItem() {
    const container = document.getElementById('valuePropItems');
    const newItem = document.createElement('div');
    newItem.className = 'value-prop-item';
    newItem.innerHTML = `
        <input type="text" class="value-prop-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ">
        <button type="button" class="remove-item-btn" onclick="removeValuePropItem(this)">√ó</button>
    `;
    container.appendChild(newItem);
}

// –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
function removeValuePropItem(btn) {
    btn.parentElement.remove();
}

// –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –ø–æ–ª—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö email –∏ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
document.querySelectorAll('input[name="recipient_type"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const customInput = document.getElementById('customEmailsInput');
        const selectedInput = document.getElementById('selectedUsersInput');
        const marketingConsent = document.getElementById('filter_marketing_consent');
        
        if (this.value === 'custom') {
            customInput.style.display = 'block';
            selectedInput.style.display = 'none';
        } else if (this.value === 'selected') {
            customInput.style.display = 'none';
            selectedInput.style.display = 'block';
        } else {
            customInput.style.display = 'none';
            selectedInput.style.display = 'none';
        }
        
        if (this.id === 'recipient_marketing') {
            marketingConsent.value = 'true';
        } else {
            marketingConsent.value = 'false';
        }
    });
});

// –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –ø–æ–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ GIF –∏ –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —à–∞–±–ª–æ–Ω–∞
document.getElementById('email_template_type').addEventListener('change', function() {
    const gifUploadGroup = document.getElementById('gifUploadGroup');
    const isWelcomeTemplate = this.value === 'learning_map_welcome';
    
    const welcomeCtaGroup = document.getElementById('welcomeCtaGroup');
    
    if (isWelcomeTemplate) {
        gifUploadGroup.style.display = 'block';
        welcomeCtaGroup.style.display = 'block';
        // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ welcome —à–∞–±–ª–æ–Ω–µ
        document.querySelectorAll('.form-section').forEach(section => {
            const h3 = section.querySelector('h3');
            if (h3) {
                const text = h3.textContent || h3.innerText;
                // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –Ω—É–∂–Ω—ã –¥–ª—è welcome —à–∞–±–ª–æ–Ω–∞
                if (text.includes('–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–∏—Å—å–º–∞') || 
                    text.includes('–í—Å—Ç—É–ø–ª–µ–Ω–∏–µ') || 
                    text.includes('–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞') || 
                    text.includes('–ú–æ—Ç–∏–≤–∞—Ü–∏–æ–Ω–Ω—ã–π –±–ª–æ–∫') ||
                    text.includes('–ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–∑—ã–≤–∞ –∫ –¥–µ–π—Å—Ç–≤–∏—é')) {
                    section.style.display = 'none';
                }
            }
        });
    } else {
        gifUploadGroup.style.display = 'none';
        welcomeCtaGroup.style.display = 'none';
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–∫—Ü–∏–∏ –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞
        document.querySelectorAll('.form-section').forEach(section => {
            section.style.display = 'block';
        });
    }
    updatePreview();
});

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤—Å–µ—Ö/—Å–Ω—è—Ç–∏—è –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function selectAllUsers() {
    document.querySelectorAll('.user-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
}

function deselectAllUsers() {
    document.querySelectorAll('.user-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
}

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–µ–π
const autoUpdateFields = ['subject', 'greeting_name', 'main_title', 'main_subtitle', 
                          'intro_text', 'value_prop_title', 'cta_text', 'cta_url', 
                          'motivation_title', 'motivation_text'];
autoUpdateFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
        field.addEventListener('input', debounce(updatePreview, 500));
    }
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('value-prop-input')) {
        debounce(updatePreview, 500)();
    }
});

// Debounce —Ñ—É–Ω–∫—Ü–∏—è
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
document.getElementById('bulkEmailForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    // –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
    const valuePropItems = [];
    document.querySelectorAll('.value-prop-input').forEach(input => {
        if (input.value.trim()) {
            valuePropItems.push(input.value.trim());
        }
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –≤ FormData
    valuePropItems.forEach(item => {
        formData.append('value_prop_items', item);
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞
    if (formData.get('recipient_type') === 'users' && document.getElementById('recipient_marketing').checked) {
        formData.set('filter_marketing_consent', 'true');
    } else {
        formData.set('filter_marketing_consent', 'false');
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö email
    if (formData.get('recipient_type') === 'custom') {
        const emailsText = formData.get('recipient_emails') || '';
        const emails = emailsText.split('\n').map(email => email.trim()).filter(email => email);
        formData.delete('recipient_emails');
        emails.forEach(email => formData.append('recipient_emails', email));
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    if (formData.get('recipient_type') === 'selected') {
        const selectedIds = [];
        document.querySelectorAll('.user-checkbox:checked').forEach(checkbox => {
            selectedIds.push(checkbox.value);
        });
        formData.delete('selected_user_ids');
        selectedIds.forEach(id => formData.append('selected_user_ids', id));
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    document.getElementById('loadingOverlay').classList.add('active');
    document.getElementById('sendBtn').disabled = true;
    
    try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º FormData –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ñ–∞–π–ª–æ–≤
        const response = await fetch('{{ url_for("communication.bulk_email") }}', {
            method: 'POST',
            body: formData  // FormData –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π Content-Type —Å boundary
        });
        
        const result = await response.json();
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        document.getElementById('loadingOverlay').classList.remove('active');
        document.getElementById('sendBtn').disabled = false;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        const alertContainer = document.getElementById('alert-container');
        if (result.success) {
            alertContainer.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i>
                    <div>
                        <strong>–£—Å–ø–µ—à–Ω–æ!</strong> ${result.message}
                        <br><small>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${result.sent}, –ù–µ —É–¥–∞–ª–æ—Å—å: ${result.failed || 0}</small>
                    </div>
                </div>
            `;
        } else {
            alertContainer.innerHTML = `
                <div class="alert alert-error">
                    <i class="bi bi-x-circle"></i>
                    <div>
                        <strong>–û—à–∏–±–∫–∞!</strong> ${result.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–∞'}
                    </div>
                </div>
            `;
        }
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –∞–ª–µ—Ä—Ç—É
        alertContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
    } catch (error) {
        document.getElementById('loadingOverlay').classList.remove('active');
        document.getElementById('sendBtn').disabled = false;
        
        document.getElementById('alert-container').innerHTML = `
            <div class="alert alert-error">
                <i class="bi bi-x-circle"></i>
                <div>
                    <strong>–û—à–∏–±–∫–∞!</strong> ${error.message}
                </div>
            </div>
        `;
    }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–µ–≤—å—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
});
</script>
{% endblock %}

