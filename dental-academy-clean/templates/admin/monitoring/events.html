{% extends "admin/base.html" %}

{% block title %}System Events{% endblock %}

{% block extra_css %}
<style>
    .event-entry {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #e9ecef;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.2s;
    }
    
    .event-entry:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .event-entry.critical { border-left-color: #dc3545; }
    .event-entry.error { border-left-color: #fd7e14; }
    .event-entry.warning { border-left-color: #ffc107; }
    .event-entry.info { border-left-color: #17a2b8; }
    
    .event-entry.resolved {
        opacity: 0.6;
    }
    
    .event-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }
    
    .event-title {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.25rem;
    }
    
    .event-meta {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }
    
    .event-message {
        background: #f8f9fa;
        border-radius: 4px;
        padding: 0.75rem;
        margin-top: 0.5rem;
        font-size: 0.9rem;
        white-space: pre-wrap;
    }
    
    .event-traceback {
        background: #1e1e1e;
        color: #d4d4d4;
        border-radius: 4px;
        padding: 1rem;
        margin-top: 0.5rem;
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
        display: none;
    }
    
    .event-traceback.show {
        display: block;
    }
    
    .severity-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .severity-critical { background: #dc3545; color: white; }
    .severity-error { background: #fd7e14; color: white; }
    .severity-warning { background: #ffc107; color: #212529; }
    .severity-info { background: #17a2b8; color: white; }
    
    .event-type-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
        background: #e9ecef;
        color: #495057;
        border-radius: 3px;
    }
    
    .search-form {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .filter-badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
    }
    
    .filter-badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .filter-badge.active {
        background: #007bff;
        color: white;
    }
    
    .filter-badge:not(.active) {
        background: #e9ecef;
        color: #495057;
    }
    
    .filter-badge:not(.active):hover {
        background: #dee2e6;
    }
    
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }
    
    .resolve-btn {
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem;
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
        .event-header {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .event-meta {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .stats-cards {
            grid-template-columns: 1fr;
        }
        
        .search-form .row {
            margin: 0;
        }
        
        .search-form .col-md-6,
        .search-form .col-md-2 {
            margin-bottom: 0.5rem;
        }
        
        .event-entry {
            padding: 0.75rem;
        }
        
        .event-title {
            font-size: 0.95rem;
        }
        
        .event-message {
            font-size: 0.85rem;
        }
        
        .filter-badges {
            gap: 0.25rem;
        }
        
        .filter-badge {
            font-size: 0.75rem;
            padding: 0.3rem 0.6rem;
        }
        
        .d-flex.justify-content-between {
            flex-direction: column;
            gap: 1rem;
        }
        
        .d-flex.justify-content-between > div {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">üîç System Events Monitor</h1>
                <div>
                    <a href="{{ url_for('monitoring.dashboard') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                    <a href="{{ url_for('monitoring.logs') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-file-text"></i> Registration Logs
                    </a>
                </div>
            </div>
            
            <!-- Search and Filters -->
            <div class="search-form">
                <form method="GET" action="{{ url_for('monitoring.events') }}" class="row g-3">
                    <div class="col-md-6">
                        <input type="text" 
                               class="form-control" 
                               name="search" 
                               placeholder="Search by title, message, email..." 
                               value="{{ search }}">
                    </div>
                    <div class="col-md-2">
                        <select name="type" class="form-select">
                            <option value="all" {% if event_type == 'all' %}selected{% endif %}>All Types</option>
                            <option value="error" {% if event_type == 'error' %}selected{% endif %}>Errors</option>
                            <option value="login" {% if event_type == 'login' %}selected{% endif %}>Logins</option>
                            <option value="registration" {% if event_type == 'registration' %}selected{% endif %}>Registrations</option>
                            <option value="warning" {% if event_type == 'warning' %}selected{% endif %}>Warnings</option>
                            <option value="info" {% if event_type == 'info' %}selected{% endif %}>Info</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select name="severity" class="form-select">
                            <option value="all" {% if severity == 'all' %}selected{% endif %}>All Severities</option>
                            <option value="critical" {% if severity == 'critical' %}selected{% endif %}>Critical</option>
                            <option value="error" {% if severity == 'error' %}selected{% endif %}>Error</option>
                            <option value="warning" {% if severity == 'warning' %}selected{% endif %}>Warning</option>
                            <option value="info" {% if severity == 'info' %}selected{% endif %}>Info</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select name="resolved" class="form-select">
                            <option value="all" {% if resolved == 'all' %}selected{% endif %}>All</option>
                            <option value="false" {% if resolved == 'false' %}selected{% endif %}>Unresolved</option>
                            <option value="true" {% if resolved == 'true' %}selected{% endif %}>Resolved</option>
                        </select>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Search
                        </button>
                        <a href="{{ url_for('monitoring.events') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Clear
                        </a>
                    </div>
                </form>
            </div>
            
            <!-- Statistics -->
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-value">{{ total_events }}</div>
                    <div class="stat-label">Total Events</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #dc3545;">
                    <div class="stat-value" style="color: #dc3545;">
                        {{ events|selectattr('severity', 'equalto', 'critical')|list|length }}
                    </div>
                    <div class="stat-label">Critical</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #fd7e14;">
                    <div class="stat-value" style="color: #fd7e14;">
                        {{ events|selectattr('severity', 'equalto', 'error')|list|length }}
                    </div>
                    <div class="stat-label">Errors</div>
                </div>
                <div class="stat-card" style="border-left: 4px solid #ffc107;">
                    <div class="stat-value" style="color: #ffc107;">
                        {{ events|selectattr('severity', 'equalto', 'warning')|list|length }}
                    </div>
                    <div class="stat-label">Warnings</div>
                </div>
            </div>
            
            <!-- Events List -->
            {% if error %}
            <div class="alert alert-danger">
                <strong>Error:</strong> {{ error }}
            </div>
            {% endif %}
            
            {% if events %}
            <div class="events-list">
                {% for event in events %}
                <div class="event-entry {{ event.severity }} {% if event.resolved %}resolved{% endif %}" data-event-id="{{ event.id }}">
                    <div class="event-header">
                        <div style="flex: 1;">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <span class="severity-badge severity-{{ event.severity }}">{{ event.severity }}</span>
                                <span class="event-type-badge">{{ event.event_type }}</span>
                                {% if event.resolved %}
                                <span class="badge bg-success">Resolved</span>
                                {% endif %}
                                {% if event.email_sent %}
                                <span class="badge bg-info">Email Sent</span>
                                {% endif %}
                            </div>
                            <div class="event-title">{{ event.title }}</div>
                            {% if event.message %}
                            <div class="event-message">{{ event.message }}</div>
                            {% endif %}
                            {% if event.error_traceback %}
                            <button class="btn btn-sm btn-outline-secondary mt-2" onclick="toggleTraceback({{ event.id }})">
                                <i class="bi bi-code-slash"></i> Show Traceback
                            </button>
                            <div class="event-traceback" id="traceback-{{ event.id }}">{{ event.error_traceback }}</div>
                            {% endif %}
                        </div>
                        <div>
                            {% if not event.resolved %}
                            <button class="btn btn-sm btn-success resolve-btn" onclick="resolveEvent({{ event.id }})">
                                <i class="bi bi-check-circle"></i> Resolve
                            </button>
                            {% else %}
                            <button class="btn btn-sm btn-warning resolve-btn" onclick="unresolveEvent({{ event.id }})">
                                <i class="bi bi-x-circle"></i> Unresolve
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    <div class="event-meta">
                        <span><i class="bi bi-clock"></i> {{ event.created_at.strftime('%Y-%m-%d %H:%M:%S UTC') if event.created_at else 'N/A' }}</span>
                        {% if event.user_email %}
                        <span><i class="bi bi-person"></i> {{ event.user_email }}</span>
                        {% elif event.user_id %}
                        <span><i class="bi bi-person"></i> User ID: {{ event.user_id }}</span>
                        {% endif %}
                        {% if event.ip_address %}
                        <span><i class="bi bi-globe"></i> {{ event.ip_address }}</span>
                        {% endif %}
                        {% if event.request_url %}
                        <span><i class="bi bi-link-45deg"></i> <a href="{{ event.request_url }}" target="_blank">{{ event.request_url[:50] }}...</a></span>
                        {% endif %}
                        <a href="{{ url_for('monitoring.event_detail', event_id=event.id) }}" class="text-decoration-none">
                            <i class="bi bi-eye"></i> View Details
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination -->
            {% if total_pages > 1 %}
            <nav aria-label="Events pagination">
                <ul class="pagination">
                    {% if page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('monitoring.events', page=page-1, type=event_type, severity=severity, resolved=resolved, search=search) }}">Previous</a>
                    </li>
                    {% endif %}
                    
                    {% for p in range(1, total_pages + 1) %}
                    {% if p == page %}
                    <li class="page-item active">
                        <span class="page-link">{{ p }}</span>
                    </li>
                    {% elif p <= 3 or p > total_pages - 3 or (p >= page - 1 and p <= page + 1) %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('monitoring.events', page=p, type=event_type, severity=severity, resolved=resolved, search=search) }}">{{ p }}</a>
                    </li>
                    {% elif p == 4 or p == total_pages - 3 %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                    {% endfor %}
                    
                    {% if page < total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('monitoring.events', page=page+1, type=event_type, severity=severity, resolved=resolved, search=search) }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
            
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No events found matching your criteria.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function toggleTraceback(eventId) {
    const traceback = document.getElementById('traceback-' + eventId);
    traceback.classList.toggle('show');
}

function resolveEvent(eventId) {
    if (!confirm('Mark this event as resolved?')) return;
    
    fetch(`/admin/monitoring/events/${eventId}/resolve`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to resolve event'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to resolve event');
    });
}

function unresolveEvent(eventId) {
    if (!confirm('Mark this event as unresolved?')) return;
    
    fetch(`/admin/monitoring/events/${eventId}/unresolve`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to unresolve event'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to unresolve event');
    });
}
</script>
{% endblock %}

