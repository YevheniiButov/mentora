{% extends "admin/base_admin.html" %}

{% block title %}Diagnostic Scheduler Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-clock me-2"></i>
                    Diagnostic Scheduler Dashboard
                </h1>
                <div>
                    <form method="POST" action="{{ url_for('admin.run_scheduler_check') }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-play me-2"></i>
                            Run Scheduler Check
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                Overdue Reassessments
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.overdue_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Critical Priority
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.critical_priority }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-fire fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                High Priority
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.high_priority }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-arrow-up fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Total Recommendations
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.recommendations_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overdue Reassessments -->
    {% if overdue %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Overdue Diagnostic Reassessments
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="overdueTable">
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Plan ID</th>
                                    <th>Days Overdue</th>
                                    <th>Current Ability</th>
                                    <th>Target Ability</th>
                                    <th>Weak Domains</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in overdue %}
                                <tr>
                                    <td>{{ item.user_id }}</td>
                                    <td>{{ item.plan_id }}</td>
                                    <td>
                                        <span class="badge bg-danger">{{ item.overdue_days }} days</span>
                                    </td>
                                    <td>{{ "%.2f"|format(item.current_ability) }}</td>
                                    <td>{{ "%.2f"|format(item.target_ability) }}</td>
                                    <td>
                                        {% if item.weak_domains %}
                                            {% for domain in item.weak_domains[:3] %}
                                                <span class="badge bg-warning me-1">{{ domain }}</span>
                                            {% endfor %}
                                            {% if item.weak_domains|length > 3 %}
                                                <span class="badge bg-secondary">+{{ item.weak_domains|length - 3 }}</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">None</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form method="POST" action="{{ url_for('admin.update_plan_schedule', plan_id=item.plan_id) }}" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-sm btn-primary">
                                                <i class="fas fa-sync-alt me-1"></i>
                                                Update Schedule
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Recommendations -->
    {% if recommendations %}
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Diagnostic Reassessment Recommendations
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="recommendationsTable">
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Priority</th>
                                    <th>Recommended Date</th>
                                    <th>Reason</th>
                                    <th>Confidence</th>
                                    <th>Current Ability</th>
                                    <th>Weak Domains</th>
                                    <th>Activity Score</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for rec in recommendations %}
                                <tr>
                                    <td>{{ rec.user_id }}</td>
                                    <td>
                                        {% if rec.priority.value == 'critical' %}
                                            <span class="badge bg-danger">Critical</span>
                                        {% elif rec.priority.value == 'high' %}
                                            <span class="badge bg-warning">High</span>
                                        {% elif rec.priority.value == 'medium' %}
                                            <span class="badge bg-info">Medium</span>
                                        {% else %}
                                            <span class="badge bg-success">Low</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ rec.recommended_date.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ rec.reason }}</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar" role="progressbar" 
                                                 style="width: {{ (rec.confidence * 100)|int }}%"
                                                 aria-valuenow="{{ (rec.confidence * 100)|int }}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                                {{ (rec.confidence * 100)|int }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ "%.2f"|format(rec.current_ability) }}</td>
                                    <td>{{ rec.weak_domains_count }}</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-success" role="progressbar" 
                                                 style="width: {{ (rec.study_activity_score * 100)|int }}%"
                                                 aria-valuenow="{{ (rec.study_activity_score * 100)|int }}" 
                                                 aria-valuemin="0" aria-valuemax="100">
                                                {{ (rec.study_activity_score * 100)|int }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <form method="POST" action="{{ url_for('admin.update_plan_schedule', plan_id=rec.plan_id) }}" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit" class="btn btn-sm btn-primary">
                                                <i class="fas fa-sync-alt me-1"></i>
                                                Update
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- No Data Message -->
    {% if not overdue and not recommendations %}
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body text-center py-5">
                    <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                    <h5 class="text-success">All Good!</h5>
                    <p class="text-muted">No overdue reassessments or pending recommendations found.</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- DataTables Scripts -->
<script>
$(document).ready(function() {
    $('#overdueTable').DataTable({
        "order": [[2, "desc"]], // Sort by days overdue
        "pageLength": 10,
        "language": {
            "search": "Search overdue:",
            "lengthMenu": "Show _MENU_ overdue items per page",
            "info": "Showing _START_ to _END_ of _TOTAL_ overdue items"
        }
    });

    $('#recommendationsTable').DataTable({
        "order": [[1, "asc"], [2, "asc"]], // Sort by priority, then date
        "pageLength": 15,
        "language": {
            "search": "Search recommendations:",
            "lengthMenu": "Show _MENU_ recommendations per page",
            "info": "Showing _START_ to _END_ of _TOTAL_ recommendations"
        }
    });
});
</script>
{% endblock %} 