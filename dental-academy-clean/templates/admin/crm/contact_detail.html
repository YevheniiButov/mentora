{% extends "admin/base.html" %}

{% block title %}{{ contact.full_name }} - –î–µ—Ç–∞–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞{% endblock %}

{% block extra_css %}
<style>
.contact-detail-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border-left: 5px solid #667eea;
}

.contact-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 25px;
}

.contact-name {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 10px;
}

.contact-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
}

.contact-status {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
    margin-top: 15px;
    display: inline-block;
}

.contact-status.lead {
    background: #fff3cd;
    color: #856404;
}

.contact-status.prospect {
    background: #d1ecf1;
    color: #0c5460;
}

.contact-status.active {
    background: #d4edda;
    color: #155724;
}

.contact-status.converted {
    background: #e2e3e5;
    color: #383d41;
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.info-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
}

.info-section h5 {
    color: #667eea;
    margin-bottom: 15px;
    font-weight: 600;
}

.info-item {
    display: flex;
    justify-content-between;
    align-items-center;
    padding: 8px 0;
    border-bottom: 1px solid #e9ecef;
}

.info-item:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: 600;
    color: #495057;
}

.info-value {
    color: #333;
    text-align: right;
    word-break: break-word;
}

.activity-item {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 4px solid #667eea;
    transition: transform 0.3s ease;
}

.activity-item:hover {
    transform: translateY(-2px);
}

.activity-header {
    display: flex;
    justify-content-between;
    align-items-center;
    margin-bottom: 15px;
}

.activity-type {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
}

.activity-time {
    color: #666;
    font-size: 0.9rem;
}

.activity-description {
    color: #555;
    line-height: 1.6;
    margin-bottom: 10px;
}

.activity-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin-top: 15px;
}

.activity-meta-item {
    background: #f8f9fa;
    padding: 8px 12px;
    border-radius: 6px;
    text-align: center;
}

.activity-meta-label {
    font-size: 0.8rem;
    color: #666;
    margin-bottom: 2px;
}

.activity-meta-value {
    font-weight: 600;
    color: #333;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.stat-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 4px solid #667eea;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
    margin-bottom: 5px;
}

.stat-label {
    color: #666;
    font-size: 0.9rem;
}

.action-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 20px;
}

.action-btn {
    padding: 10px 20px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
}

.action-btn.primary {
    background: #667eea;
    color: white;
}

.action-btn.primary:hover {
    background: #5a6fd8;
    color: white;
}

.action-btn.success {
    background: #28a745;
    color: white;
}

.action-btn.success:hover {
    background: #218838;
    color: white;
}

.action-btn.warning {
    background: #ffc107;
    color: #333;
}

.action-btn.warning:hover {
    background: #e0a800;
    color: #333;
}

.action-btn.info {
    background: #17a2b8;
    color: white;
}

.action-btn.info:hover {
    background: #138496;
    color: white;
}

.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -22px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #667eea;
    border: 3px solid white;
    box-shadow: 0 0 0 3px #e9ecef;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">üë§ –î–µ—Ç–∞–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞</h1>
            <p class="text-muted">–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç–∞–∫—Ç–µ –∏ –µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
        </div>
        <div>
            <a href="{{ url_for('crm.contacts') }}" class="btn btn-secondary">
                ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
            </a>
            <a href="{{ url_for('crm.contact_edit', contact_id=contact.id) }}" class="btn btn-primary">
                ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </a>
        </div>
    </div>

    <!-- Contact Header -->
    <div class="contact-header">
        <div class="contact-name">{{ contact.full_name }}</div>
        <div class="contact-subtitle">
            {% if contact.profession %}
                üë®‚Äç‚öïÔ∏è {{ contact.profession.name }}
            {% endif %}
            {% if contact.country %}
                | üåç {{ contact.country }}
            {% endif %}
        </div>
        <div class="contact-status {{ contact.contact_status }}">
            {{ contact.status_display }}
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ total_activities }}</div>
            <div class="stat-label">–í—Å–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ activities_this_month }}</div>
            <div class="stat-label">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">
                {% if contact.days_since_last_contact %}
                    {{ contact.days_since_last_contact }}
                {% else %}
                    -
                {% endif %}
            </div>
            <div class="stat-label">–î–Ω–µ–π —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">
                {% if contact.lead_score %}
                    {{ contact.lead_score }}
                {% else %}
                    -
                {% endif %}
            </div>
            <div class="stat-label">–û—Ü–µ–Ω–∫–∞ –ª–∏–¥–∞</div>
        </div>
    </div>

    <div class="row">
        <!-- Contact Information -->
        <div class="col-lg-6">
            <div class="contact-detail-card">
                <h3 class="mb-4">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                
                <div class="info-grid">
                    <div class="info-section">
                        <h5>üë§ –õ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h5>
                        <div class="info-item">
                            <span class="info-label">–ü–æ–ª–Ω–æ–µ –∏–º—è:</span>
                            <span class="info-value">{{ contact.full_name }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email:</span>
                            <span class="info-value">{{ contact.email }}</span>
                        </div>
                        {% if contact.phone %}
                        <div class="info-item">
                            <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                            <span class="info-value">{{ contact.phone }}</span>
                        </div>
                        {% endif %}
                        {% if contact.date_of_birth %}
                        <div class="info-item">
                            <span class="info-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</span>
                            <span class="info-value">{{ contact.date_of_birth.strftime('%d.%m.%Y') }}</span>
                        </div>
                        {% endif %}
                        {% if contact.gender %}
                        <div class="info-item">
                            <span class="info-label">–ü–æ–ª:</span>
                            <span class="info-value">{{ contact.gender }}</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="info-section">
                        <h5>üåç –ê–¥—Ä–µ—Å</h5>
                        <div class="info-item">
                            <span class="info-label">–°—Ç—Ä–∞–Ω–∞:</span>
                            <span class="info-value">{{ contact.country }}</span>
                        </div>
                        {% if contact.city %}
                        <div class="info-item">
                            <span class="info-label">–ì–æ—Ä–æ–¥:</span>
                            <span class="info-value">{{ contact.city }}</span>
                        </div>
                        {% endif %}
                        {% if contact.address %}
                        <div class="info-item">
                            <span class="info-label">–ê–¥—Ä–µ—Å:</span>
                            <span class="info-value">{{ contact.address }}</span>
                        </div>
                        {% endif %}
                        {% if contact.postal_code %}
                        <div class="info-item">
                            <span class="info-label">–ü–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å:</span>
                            <span class="info-value">{{ contact.postal_code }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Professional Information -->
            <div class="contact-detail-card">
                <h3 class="mb-4">üë®‚Äç‚öïÔ∏è –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                
                <div class="info-section">
                    {% if contact.profession %}
                    <div class="info-item">
                        <span class="info-label">–ü—Ä–æ—Ñ–µ—Å—Å–∏—è:</span>
                        <span class="info-value">{{ contact.profession.name }}</span>
                    </div>
                    {% endif %}
                    {% if contact.current_job_title %}
                    <div class="info-item">
                        <span class="info-label">–¢–µ–∫—É—â–∞—è –¥–æ–ª–∂–Ω–æ—Å—Ç—å:</span>
                        <span class="info-value">{{ contact.current_job_title }}</span>
                    </div>
                    {% endif %}
                    {% if contact.current_employer %}
                    <div class="info-item">
                        <span class="info-label">–¢–µ–∫—É—â–∏–π —Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å:</span>
                        <span class="info-value">{{ contact.current_employer }}</span>
                    </div>
                    {% endif %}
                    {% if contact.years_of_experience %}
                    <div class="info-item">
                        <span class="info-label">–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã:</span>
                        <span class="info-value">{{ contact.years_of_experience }} –ª–µ—Ç</span>
                    </div>
                    {% endif %}
                    {% if contact.education_level %}
                    <div class="info-item">
                        <span class="info-label">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ:</span>
                        <span class="info-value">{{ contact.education_level }}</span>
                    </div>
                    {% endif %}
                    {% if contact.university %}
                    <div class="info-item">
                        <span class="info-label">–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç:</span>
                        <span class="info-value">{{ contact.university }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Activities and Tasks -->
        <div class="col-lg-6">
            <!-- Recent Activities -->
            <div class="contact-detail-card">
                <h3 class="mb-4">üìà –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                
                {% if activities %}
                    <div class="timeline">
                        {% for activity in activities %}
                        <div class="timeline-item">
                            <div class="activity-item">
                                <div class="activity-header">
                                    <div class="activity-type">{{ activity.activity_display }}</div>
                                    <div class="activity-time">{{ activity.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
                                </div>
                                
                                {% if activity.subject %}
                                <div class="activity-description">
                                    <strong>{{ activity.subject }}</strong>
                                </div>
                                {% endif %}
                                
                                {% if activity.description %}
                                <div class="activity-description">
                                    {{ activity.description }}
                                </div>
                                {% endif %}
                                
                                <div class="activity-meta">
                                    {% if activity.duration %}
                                    <div class="activity-meta-item">
                                        <div class="activity-meta-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                                        <div class="activity-meta-value">{{ activity.duration }} –º–∏–Ω</div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if activity.outcome %}
                                    <div class="activity-meta-item">
                                        <div class="activity-meta-label">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
                                        <div class="activity-meta-value">{{ activity.outcome }}</div>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="activity-meta-item">
                                        <div class="activity-meta-label">–°—Ç–∞—Ç—É—Å</div>
                                        <div class="activity-meta-value">{{ activity.status_display }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-history fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h5>
                        <p class="text-muted">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç–∞ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</p>
                    </div>
                {% endif %}
            </div>

            <!-- Upcoming Tasks -->
            {% if upcoming_tasks %}
            <div class="contact-detail-card">
                <h3 class="mb-4">üìÖ –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –∑–∞–¥–∞—á–∏</h3>
                
                {% for task in upcoming_tasks %}
                <div class="activity-item">
                    <div class="activity-header">
                        <div class="activity-type">{{ task.activity_display }}</div>
                        <div class="activity-time">
                            {% if task.scheduled_at %}
                                {{ task.scheduled_at.strftime('%d.%m.%Y %H:%M') }}
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if task.subject %}
                    <div class="activity-description">
                        <strong>{{ task.subject }}</strong>
                    </div>
                    {% endif %}
                    
                    {% if task.description %}
                    <div class="activity-description">
                        {{ task.description }}
                    </div>
                    {% endif %}
                    
                    <div class="activity-meta">
                        <div class="activity-meta-item">
                            <div class="activity-meta-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</div>
                            <div class="activity-meta-value">{{ task.priority }}</div>
                        </div>
                        <div class="activity-meta-item">
                            <div class="activity-meta-label">–°—Ç–∞—Ç—É—Å</div>
                            <div class="activity-meta-value">{{ task.status_display }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Notes -->
            {% if contact.notes %}
            <div class="contact-detail-card">
                <h3 class="mb-4">üìù –ó–∞–º–µ—Ç–∫–∏</h3>
                <div class="info-section">
                    <div style="white-space: pre-wrap; line-height: 1.6;">{{ contact.notes }}</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <a href="{{ url_for('crm.contact_edit', contact_id=contact.id) }}" class="action-btn success">
            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
        </a>
        <button class="action-btn info" onclick="createActivity({{ contact.id }})">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
        </button>
        <button class="action-btn warning" onclick="updateStatus({{ contact.id }}, '{{ contact.contact_status }}')">
            üìä –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å
        </button>
        <a href="{{ url_for('crm.contacts') }}" class="action-btn primary">
            ‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function createActivity(contactId) {
    const activityType = prompt('–¢–∏–ø –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:\n1. –ó–≤–æ–Ω–æ–∫\n2. Email\n3. –í—Å—Ç—Ä–µ—á–∞\n4. –ó–∞–º–µ—Ç–∫–∞\n5. –ó–∞–¥–∞—á–∞', '4');
    
    if (activityType) {
        const typeMap = {
            '1': 'call',
            '2': 'email',
            '3': 'meeting',
            '4': 'note',
            '5': 'task'
        };
        
        const selectedType = typeMap[activityType];
        if (selectedType) {
            const subject = prompt('–¢–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:');
            if (subject) {
                const description = prompt('–û–ø–∏—Å–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:');
                
                const data = {
                    contact_id: contactId,
                    activity_type: selectedType,
                    subject: subject,
                    description: description,
                    status: 'completed'
                };
                
                fetch('{{ url_for("crm.api_activity_create") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
                        location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏');
                });
            }
        }
    }
}

function updateStatus(contactId, currentStatus) {
    const statuses = {
        'lead': '–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç',
        'prospect': '–ê–∫—Ç–∏–≤–Ω—ã–π',
        'active': '–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π',
        'converted': '–õ–∏–¥'
    };
    
    const newStatus = prompt(`–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: ${statuses[currentStatus]}\n\n–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:\n1. –õ–∏–¥\n2. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç\n3. –ê–∫—Ç–∏–≤–Ω—ã–π\n4. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π`, '1');
    
    if (newStatus) {
        const statusMap = {
            '1': 'lead',
            '2': 'prospect',
            '3': 'active',
            '4': 'converted'
        };
        
        const selectedStatus = statusMap[newStatus];
        if (selectedStatus) {
            fetch(`{{ url_for('crm.api_contact_update_status', contact_id=0) }}`.replace('0', contactId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: selectedStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('–°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–∞–∫—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
            });
        }
    }
}

// Add hover effects
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.activity-item, .stat-card').forEach(item => {
        item.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
        });
    });
});
</script>
{% endblock %}
