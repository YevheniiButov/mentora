{% extends "admin/base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å{% endblock %}

{% block extra_css %}
<style>
.database-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border-left: 5px solid #667eea;
}

.metric-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 15px;
    text-align: center;
    transition: transform 0.3s ease;
}

.metric-card:hover {
    transform: translateY(-3px);
}

.metric-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.metric-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.backup-card {
    background: white;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 4px solid #28a745;
}

.backup-card.failed {
    border-left-color: #dc3545;
}

.backup-card.pending {
    border-left-color: #ffc107;
}

.backup-header {
    display: flex;
    justify-content-between;
    align-items: center;
    margin-bottom: 10px;
}

.backup-name {
    font-weight: 600;
    color: #333;
}

.backup-status {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.backup-status.completed {
    background: #d4edda;
    color: #155724;
}

.backup-status.failed {
    background: #f8d7da;
    color: #721c24;
}

.backup-status.pending {
    background: #fff3cd;
    color: #856404;
}

.backup-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.backup-detail {
    text-align: center;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 6px;
}

.backup-detail-value {
    font-weight: bold;
    color: #667eea;
}

.backup-detail-label {
    font-size: 0.8rem;
    color: #666;
    margin-top: 2px;
}

.action-buttons {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.action-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    margin-right: 10px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    color: white;
    text-decoration: none;
}

.action-btn.danger {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
}

.action-btn.success {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.action-btn.warning {
    background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
    color: #333;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.progress-bar {
    height: 8px;
    border-radius: 4px;
    background: #e9ecef;
    overflow: hidden;
    margin-top: 10px;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2);
    border-radius: 4px;
    transition: width 0.3s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">üóÑÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö</h1>
            <p class="text-muted">–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ë–î</p>
        </div>
        <div>
            <button class="action-btn" onclick="createBackup()">
                üíæ –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
            </button>
            <button class="action-btn success" onclick="exportData()">
                üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
            </button>
        </div>
    </div>

    <!-- Database Statistics -->
    <div class="stats-grid">
        <div class="metric-card">
            <div class="metric-value">{{ total_users }}</div>
            <div class="metric-label">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ total_contacts }}</div>
            <div class="metric-label">üìá –ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ total_professions }}</div>
            <div class="metric-label">üë®‚Äç‚öïÔ∏è –ü—Ä–æ—Ñ–µ—Å—Å–∏–∏</div>
        </div>
        <div class="metric-card">
            <div class="metric-value">{{ total_analytics_events }}</div>
            <div class="metric-label">üìà –°–æ–±—ã—Ç–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <h5 class="mb-3">üõ†Ô∏è –î–µ–π—Å—Ç–≤–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö</h5>
        <button class="action-btn" onclick="createBackup()">
            üíæ –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
        </button>
        <button class="action-btn success" onclick="exportData()">
            üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        </button>
        <button class="action-btn warning" onclick="optimizeDatabase()">
            ‚ö° –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ë–î
        </button>
        <button class="action-btn danger" onclick="cleanupOldData()">
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
        </button>
        <button class="action-btn" onclick="checkIntegrity()">
            üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å
        </button>
    </div>

    <div class="row">
        <!-- Recent Backups -->
        <div class="col-lg-8">
            <div class="database-card">
                <h3 class="mb-4">üì¶ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏</h3>
                
                {% if recent_backups %}
                    {% for backup in recent_backups %}
                    <div class="backup-card {{ backup.status }}">
                        <div class="backup-header">
                            <div class="backup-name">{{ backup.backup_name }}</div>
                            <div class="backup-status {{ backup.status }}">
                                {% if backup.status == 'completed' %}‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ
                                {% elif backup.status == 'failed' %}‚ùå –û—à–∏–±–∫–∞
                                {% elif backup.status == 'pending' %}‚è≥ –í –ø—Ä–æ—Ü–µ—Å—Å–µ
                                {% else %}{{ backup.status }}{% endif %}
                            </div>
                        </div>
                        
                        <div class="backup-details">
                            <div class="backup-detail">
                                <div class="backup-detail-value">{{ backup.backup_type }}</div>
                                <div class="backup-detail-label">–¢–∏–ø</div>
                            </div>
                            <div class="backup-detail">
                                <div class="backup-detail-value">
                                    {% if backup.file_size %}
                                        {{ "%.1f"|format(backup.file_size / 1024 / 1024) }} MB
                                    {% else %}
                                        -
                                    {% endif %}
                                </div>
                                <div class="backup-detail-label">–†–∞–∑–º–µ—Ä</div>
                            </div>
                            <div class="backup-detail">
                                <div class="backup-detail-value">
                                    {% if backup.tables_count %}{{ backup.tables_count }}{% else %}-{% endif %}
                                </div>
                                <div class="backup-detail-label">–¢–∞–±–ª–∏—Ü—ã</div>
                            </div>
                            <div class="backup-detail">
                                <div class="backup-detail-value">
                                    {% if backup.records_count %}{{ backup.records_count }}{% else %}-{% endif %}
                                </div>
                                <div class="backup-detail-label">–ó–∞–ø–∏—Å–∏</div>
                            </div>
                            <div class="backup-detail">
                                <div class="backup-detail-value">
                                    {% if backup.backup_duration %}
                                        {{ "%.1f"|format(backup.backup_duration) }}—Å
                                    {% else %}
                                        -
                                    {% endif %}
                                </div>
                                <div class="backup-detail-label">–í—Ä–µ–º—è</div>
                            </div>
                            <div class="backup-detail">
                                <div class="backup-detail-value">
                                    {{ backup.started_at.strftime('%d.%m.%Y %H:%M') }}
                                </div>
                                <div class="backup-detail-label">–°–æ–∑–¥–∞–Ω–æ</div>
                            </div>
                        </div>
                        
                        {% if backup.error_message %}
                        <div class="mt-2">
                            <small class="text-danger">–û—à–∏–±–∫–∞: {{ backup.error_message }}</small>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-database fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">–ù–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π</h5>
                        <p class="text-muted">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –¥–ª—è –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö</p>
                        <button class="action-btn" onclick="createBackup()">
                            üíæ –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Backup Statistics -->
        <div class="col-lg-4">
            <div class="database-card">
                <h3 class="mb-4">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π</h3>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small>–í—Å–µ–≥–æ –∫–æ–ø–∏–π</small>
                        <small>{{ total_backups }}</small>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 100%"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small>–£—Å–ø–µ—à–Ω—ã—Ö</small>
                        <small>{{ successful_backups }}</small>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ (successful_backups / total_backups * 100) if total_backups > 0 else 0 }}%"></div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small>–° –æ—à–∏–±–∫–∞–º–∏</small>
                        <small>{{ failed_backups }}</small>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: {{ (failed_backups / total_backups * 100) if total_backups > 0 else 0 }}%; background: #dc3545;"></div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h6>
                    <ul class="list-unstyled small text-muted">
                        <li>‚Ä¢ –°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏</li>
                        <li>‚Ä¢ –•—Ä–∞–Ω–∏—Ç–µ –∫–æ–ø–∏–∏ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ</li>
                        <li>‚Ä¢ –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö</li>
                        <li>‚Ä¢ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function createBackup() {
    if (confirm('–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö?')) {
        fetch('{{ url_for("admin.create_database_backup") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏');
        });
    }
}

function exportData() {
    alert('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
}

function optimizeDatabase() {
    if (confirm('–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö? –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.')) {
        alert('–§—É–Ω–∫—Ü–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ë–î –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
    }
}

function cleanupOldData() {
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) {
        alert('–§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
    }
}

function checkIntegrity() {
    alert('–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –ë–î –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
}

// Auto-refresh every 30 seconds
setTimeout(function() {
    location.reload();
}, 30000);
</script>
{% endblock %}
