{% extends "admin/base.html" %}

{% block title %}Registration Analytics - Admin Panel{% endblock %}

{% block styles %}
{{ super() }}
<style>
.analytics-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
}

.metric-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    margin-bottom: 1rem;
}

.metric-number {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.metric-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.conversion-rate {
    font-size: 1.2rem;
    font-weight: 600;
    margin-top: 0.5rem;
}

.table-container {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.visitor-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #eee;
}

.visitor-item:last-child {
    border-bottom: none;
}

.visitor-info {
    flex: 1;
}

.visitor-email {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.25rem;
}

.visitor-details {
    font-size: 0.85rem;
    color: #666;
}

.visitor-status {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-completed {
    background: #d4edda;
    color: #155724;
}

.status-abandoned {
    background: #f8d7da;
    color: #721c24;
}

.status-partial {
    background: #fff3cd;
    color: #856404;
}

.filter-controls {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">📊 Registration Analytics</h1>
                <div class="btn-group" role="group">
                    <a href="?days=1" class="btn btn-outline-primary {% if days == 1 %}active{% endif %}">1 Day</a>
                    <a href="?days=7" class="btn btn-outline-primary {% if days == 7 %}active{% endif %}">7 Days</a>
                    <a href="?days=30" class="btn btn-outline-primary {% if days == 30 %}active{% endif %}">30 Days</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    {% if summary %}
    <div class="row">
        {% for page_data in summary %}
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="analytics-card">
                <h4 class="mb-3">{{ page_data.page_type.replace('_', ' ').title() }}</h4>
                
                <div class="row">
                    <div class="col-6">
                        <div class="metric-card">
                            <div class="metric-number">{{ page_data.total_visits }}</div>
                            <div class="metric-label">Total Visits</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-card">
                            <div class="metric-number">{{ page_data.unique_visitors }}</div>
                            <div class="metric-label">Unique Visitors</div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-6">
                        <div class="metric-card">
                            <div class="metric-number">{{ page_data.email_entries }}</div>
                            <div class="metric-label">Email Entries</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-card">
                            <div class="metric-number">{{ page_data.successful_registrations }}</div>
                            <div class="metric-label">Completed</div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="conversion-rate text-center">
                        <div>Email → Form: {{ "%.1f"|format(page_data.email_to_form_rate) }}%</div>
                        <div>Form → Success: {{ "%.1f"|format(page_data.form_to_success_rate) }}%</div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Recent Visitors with Email -->
    <div class="row">
        <div class="col-12">
            <div class="analytics-card">
                <h4 class="mb-3">📧 Recent Visitors with Email</h4>
                
                {% if recent_visitors %}
                <div class="table-container">
                    {% for visitor in recent_visitors %}
                    <div class="visitor-item">
                        <div class="visitor-info">
                            <div class="visitor-email">{{ visitor.email_entered }}</div>
                            <div class="visitor-details">
                                {{ visitor.page_type.replace('_', ' ').title() }} • 
                                {{ visitor.ip_address }} • 
                                {{ visitor.entry_time.strftime('%Y-%m-%d %H:%M') }}
                                {% if visitor.country %}• {{ visitor.country }}{% endif %}
                            </div>
                        </div>
                        <div>
                            {% if visitor.registration_completed %}
                                <span class="visitor-status status-completed">Completed</span>
                            {% elif visitor.form_abandoned %}
                                <span class="visitor-status status-abandoned">Abandoned</span>
                            {% elif visitor.email_entered %}
                                <span class="visitor-status status-partial">Email Only</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-inbox fs-1"></i>
                    <p class="mt-2">No visitors with email entries found for the selected period.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Detailed Visitor Information -->
    {% if all_visitors %}
    <div class="row">
        <div class="col-12">
            <div class="analytics-card">
                <h4 class="mb-3">👥 Detailed Visitor Information</h4>
                <p class="text-muted mb-3">Complete visitor data with timestamps, IP addresses, and actions</p>
                
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>IP Address</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Page Type</th>
                                <th>Country</th>
                                <th>Form Started</th>
                                <th>Form Abandoned</th>
                                <th>Registration Completed</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for visitor in all_visitors %}
                            <tr>
                                <td>
                                    <small>{{ visitor.entry_time.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                </td>
                                <td>
                                    <code>{{ visitor.ip_address }}</code>
                                </td>
                                <td>
                                    {% if visitor.first_name_entered or visitor.last_name_entered %}
                                        <span class="badge bg-primary">
                                            {{ visitor.first_name_entered or '' }} {{ visitor.last_name_entered or '' }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if visitor.email_entered %}
                                        <span class="badge bg-success">{{ visitor.email_entered }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ visitor.page_type.replace('_', ' ').title() }}</span>
                                </td>
                                <td>
                                    {% if visitor.country %}
                                        <span class="badge bg-secondary">{{ visitor.country }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if visitor.form_started %}
                                        <i class="bi bi-check-circle text-success"></i>
                                    {% else %}
                                        <i class="bi bi-x-circle text-muted"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if visitor.form_abandoned %}
                                        <i class="bi bi-exclamation-triangle text-warning"></i>
                                    {% else %}
                                        <i class="bi bi-x-circle text-muted"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if visitor.registration_completed %}
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                    {% else %}
                                        <i class="bi bi-x-circle text-muted"></i>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary btn-sm" onclick="showVisitorDetails({{ visitor.id }})">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- IP Address Statistics -->
    {% if ip_stats %}
    <div class="row">
        <div class="col-12">
            <div class="analytics-card">
                <h4 class="mb-3">🌐 IP Address Statistics</h4>
                <p class="text-muted mb-3">Top IP addresses with visit counts and conversion rates</p>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>IP Address</th>
                                <th>Total Visits</th>
                                <th>Email Entries</th>
                                <th>Completed Registrations</th>
                                <th>Conversion Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ip_stat in ip_stats %}
                            <tr>
                                <td><code>{{ ip_stat.ip_address }}</code></td>
                                <td>{{ ip_stat.visits }}</td>
                                <td>{{ ip_stat.email_entries }}</td>
                                <td>{{ ip_stat.completed }}</td>
                                <td>
                                    {% if ip_stat.visits > 0 %}
                                        {{ "%.1f"|format((ip_stat.completed / ip_stat.visits * 100)) }}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Hourly Statistics -->
    {% if hourly_stats %}
    <div class="row">
        <div class="col-12">
            <div class="analytics-card">
                <h4 class="mb-3">⏰ Hourly Activity</h4>
                <p class="text-muted mb-3">Visitor activity by hour of day</p>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Hour</th>
                                <th>Total Visits</th>
                                <th>Completed Registrations</th>
                                <th>Conversion Rate</th>
                                <th>Activity Level</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for hour_stat in hourly_stats %}
                            <tr>
                                <td>{{ "%.0f"|format(hour_stat.hour) }}:00</td>
                                <td>{{ hour_stat.visits }}</td>
                                <td>{{ hour_stat.completed }}</td>
                                <td>
                                    {% if hour_stat.visits > 0 %}
                                        {{ "%.1f"|format((hour_stat.completed / hour_stat.visits * 100)) }}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </td>
                                <td>
                                    {% set activity_level = (hour_stat.visits / 10) * 100 %}
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" style="width: {{ activity_level }}%">
                                            {{ hour_stat.visits }}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Daily Statistics -->
    {% if daily_stats %}
    <div class="row">
        <div class="col-12">
            <div class="analytics-card">
                <h4 class="mb-3">📈 Daily Statistics</h4>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Page Type</th>
                                <th>Visits</th>
                                <th>Unique</th>
                                <th>Email Entries</th>
                                <th>Form Starts</th>
                                <th>Abandoned</th>
                                <th>Completed</th>
                                <th>Conversion</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in daily_stats %}
                            <tr>
                                <td>{{ stat.date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ stat.page_type.replace('_', ' ').title() }}</td>
                                <td>{{ stat.visits }}</td>
                                <td>{{ stat.unique_visitors }}</td>
                                <td>{{ stat.email_entries }}</td>
                                <td>{{ stat.form_starts }}</td>
                                <td>{{ stat.form_abandonments }}</td>
                                <td>{{ stat.successful_registrations }}</td>
                                <td>
                                    {% if stat.form_starts > 0 %}
                                        {{ "%.1f"|format((stat.successful_registrations / stat.form_starts * 100)) }}%
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Country Statistics -->
    {% if country_stats %}
    <div class="row">
        <div class="col-lg-6">
            <div class="analytics-card">
                <h4 class="mb-3">🌍 Top Countries</h4>
                
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Country</th>
                                <th>Visits</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for country_stat in country_stats %}
                            <tr>
                                <td>{{ country_stat.country or 'Unknown' }}</td>
                                <td>{{ country_stat.visits }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Auto-refresh every 5 minutes
setInterval(function() {
    location.reload();
}, 300000);

// Function to show visitor details
function showVisitorDetails(visitorId) {
    // Create modal for visitor details
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'visitorDetailsModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Visitor Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading visitor details...</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Load visitor details via AJAX
    fetch(`/admin/visitor-details/${visitorId}`)
        .then(response => response.text())
        .then(html => {
            modal.querySelector('.modal-body').innerHTML = html;
        })
        .catch(error => {
            modal.querySelector('.modal-body').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    Error loading visitor details: ${error.message}
                </div>
            `;
        });
    
    // Clean up modal when closed
    modal.addEventListener('hidden.bs.modal', function() {
        modal.remove();
    });
}

// Function to export data
function exportData(format) {
    const days = new URLSearchParams(window.location.search).get('days') || 7;
    window.open(`/admin/registration-analytics/export?format=${format}&days=${days}`, '_blank');
}
</script>
{% endblock %}
