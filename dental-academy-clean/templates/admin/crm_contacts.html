{% extends "admin/base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ - Mentora{% endblock %}

{% block extra_css %}
<style>
.contact-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
}

.contact-card:hover {
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-lead { background: #ffc107; color: #000; }
.status-prospect { background: #17a2b8; color: #fff; }
.status-client { background: #28a745; color: #fff; }
.status-inactive { background: #6c757d; color: #fff; }

.filter-section {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.contact-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 1.2rem;
}

.followup-badge {
    background: #dc3545;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
}

.followup-warning {
    background: #ffc107;
    color: #000;
}

.followup-ok {
    background: #28a745;
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏</h1>
            <p class="text-muted">CRM —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ –ª–∏–¥–∞–º–∏</p>
        </div>
        <div>
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-primary">
                <i class="bi bi-graph-up"></i> Dashboard
            </a>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addContactModal">
                <i class="bi bi-person-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-section">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label for="search" class="form-label">–ü–æ–∏—Å–∫</label>
                <input type="text" class="form-control" id="search" name="search" 
                       value="{{ search_query }}" placeholder="–ò–º—è, email, —Ç–µ–ª–µ—Ñ–æ–Ω...">
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select class="form-select" id="status" name="status">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="lead" {% if status_filter == 'lead' %}selected{% endif %}>–õ–∏–¥—ã</option>
                    <option value="prospect" {% if status_filter == 'prospect' %}selected{% endif %}>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã</option>
                    <option value="client" {% if status_filter == 'client' %}selected{% endif %}>–ö–ª–∏–µ–Ω—Ç—ã</option>
                    <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="profession" class="form-label">–ü—Ä–æ—Ñ–µ—Å—Å–∏—è</label>
                <select class="form-select" id="profession" name="profession">
                    <option value="all" {% if profession_filter == 'all' %}selected{% endif %}>–í—Å–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏</option>
                    {% for profession in professions %}
                    <option value="{{ profession.id }}" {% if profession_filter == profession.id|string %}selected{% endif %}>
                        {{ profession.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Contacts List -->
    {% if contacts and contacts.items %}
        {% for contact in contacts.items %}
        <div class="contact-card">
            <div class="row align-items-center">
                <div class="col-md-1">
                    <div class="contact-avatar">
                        {{ contact.full_name[0].upper() }}
                    </div>
                </div>
                <div class="col-md-3">
                    <h6 class="mb-1">{{ contact.full_name }}</h6>
                    <p class="text-muted mb-1">{{ contact.email }}</p>
                    {% if contact.phone %}
                    <small class="text-muted">{{ contact.phone }}</small>
                    {% endif %}
                </div>
                <div class="col-md-2">
                    {% if contact.profession %}
                    <span class="badge bg-info">{{ contact.profession.name }}</span>
                    {% else %}
                    <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω–∞</span>
                    {% endif %}
                    {% if contact.workplace %}
                    <br><small class="text-muted">{{ contact.workplace }}</small>
                    {% endif %}
                </div>
                <div class="col-md-2">
                    <span class="status-badge status-{{ contact.contact_status }}">
                        {{ contact.status_display }}
                    </span>
                    {% if contact.lead_source %}
                    <br><small class="text-muted">{{ contact.lead_source }}</small>
                    {% endif %}
                </div>
                <div class="col-md-2">
                    {% if contact.next_followup_date %}
                        {% set days_until = contact.days_until_followup %}
                        {% if days_until < 0 %}
                        <span class="followup-badge">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ {{ -days_until }}–¥</span>
                        {% elif days_until == 0 %}
                        <span class="followup-badge followup-warning">–°–µ–≥–æ–¥–Ω—è</span>
                        {% elif days_until <= 3 %}
                        <span class="followup-badge followup-warning">–ß–µ—Ä–µ–∑ {{ days_until }}–¥</span>
                        {% else %}
                        <span class="followup-badge followup-ok">–ß–µ—Ä–µ–∑ {{ days_until }}–¥</span>
                        {% endif %}
                    {% else %}
                    <span class="text-muted">–ù–µ—Ç –∑–∞–¥–∞—á</span>
                    {% endif %}
                </div>
                <div class="col-md-2 text-end">
                    <div class="btn-group btn-group-sm">
                        <a href="{{ url_for('admin.crm_contact_detail', contact_id=contact.id) }}" 
                           class="btn btn-outline-primary" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                            <i class="bi bi-eye"></i>
                        </a>
                        <button class="btn btn-outline-secondary" onclick="editContact({{ contact.id }})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="sendEmailToContact({{ contact.id }})" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å email">
                            <i class="bi bi-envelope"></i>
                        </button>
                    </div>
                    <br>
                    <small class="text-muted">{{ contact.created_at.strftime('%d.%m.%Y') }}</small>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Pagination -->
        {% if contacts.pages > 1 %}
        <nav aria-label="Contacts pagination">
            <ul class="pagination justify-content-center">
                {% if contacts.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('admin.crm_contacts', page=contacts.prev_num, status=status_filter, profession=profession_filter, search=search_query) }}">
                        –ü—Ä–µ–¥—ã–¥—É—â–∞—è
                    </a>
                </li>
                {% endif %}
                
                {% for page_num in contacts.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != contacts.page %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('admin.crm_contacts', page=page_num, status=status_filter, profession=profession_filter, search=search_query) }}">
                                {{ page_num }}
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item active">
                            <span class="page-link">{{ page_num }}</span>
                        </li>
                        {% endif %}
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                    {% endif %}
                {% endfor %}
                
                {% if contacts.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('admin.crm_contacts', page=contacts.next_num, status=status_filter, profession=profession_filter, search=search_query) }}">
                        –°–ª–µ–¥—É—é—â–∞—è
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}

    {% else %}
        <div class="text-center py-5">
            <i class="bi bi-people" style="font-size: 4rem; color: #dee2e6;"></i>
            <h4 class="text-muted mt-3">–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
            <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç</p>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addContactModal">
                <i class="bi bi-person-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç
            </button>
        </div>
    {% endif %}
</div>

<!-- Add Contact Modal -->
<div class="modal fade" id="addContactModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.crm_contacts') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="full_name" class="form-label">–ü–æ–ª–Ω–æ–µ –∏–º—è *</label>
                                <input type="text" class="form-control" id="full_name" name="full_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="phone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <input type="tel" class="form-control" id="phone" name="phone">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="profession_id" class="form-label">–ü—Ä–æ—Ñ–µ—Å—Å–∏—è</label>
                                <select class="form-select" id="profession_id" name="profession_id">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—é</option>
                                    {% for profession in professions %}
                                    <option value="{{ profession.id }}">{{ profession.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="workplace" class="form-label">–ú–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã</label>
                                <input type="text" class="form-control" id="workplace" name="workplace" placeholder="–ë–æ–ª—å–Ω–∏—Ü–∞, –∫–ª–∏–Ω–∏–∫–∞, —á–∞—Å—Ç–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞...">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contact_status" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                                <select class="form-select" id="contact_status" name="contact_status">
                                    <option value="lead">–õ–∏–¥</option>
                                    <option value="prospect">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç</option>
                                    <option value="client">–ö–ª–∏–µ–Ω—Ç</option>
                                    <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–π</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="lead_source" class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫ –ª–∏–¥–∞</label>
                                <select class="form-select" id="lead_source" name="lead_source">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫</option>
                                    <option value="website">–í–µ–±-—Å–∞–π—Ç</option>
                                    <option value="referral">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</option>
                                    <option value="digid">DigiD</option>
                                    <option value="social_media">–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏</option>
                                    <option value="advertising">–†–µ–∫–ª–∞–º–∞</option>
                                    <option value="other">–î—Ä—É–≥–æ–µ</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">–ó–∞–º–µ—Ç–∫–∏</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Send Email Modal -->
<div class="modal fade" id="sendEmailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–û—Ç–ø—Ä–∞–≤–∏—Ç—å email –∫–æ–Ω—Ç–∞–∫—Ç—É</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="emailForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="emailType" class="form-label">–¢–∏–ø –ø–∏—Å—å–º–∞</label>
                        <select class="form-select" id="emailType" required>
                            <option value="crm_lead">–ü–∏—Å—å–º–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–º—É –∫–ª–∏–µ–Ω—Ç—É</option>
                            <option value="crm_follow_up">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</option>
                            <option value="crm_welcome">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ</option>
                            <option value="custom">–ö–∞—Å—Ç–æ–º–Ω–æ–µ –ø–∏—Å—å–º–æ</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="emailSubject" class="form-label">–¢–µ–º–∞</label>
                        <input type="text" class="form-control" id="emailSubject" required>
                    </div>
                    <div class="mb-3">
                        <label for="emailMessage" class="form-label">–°–æ–æ–±—â–µ–Ω–∏–µ</label>
                        <textarea class="form-control" id="emailMessage" rows="10" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="actionUrl" class="form-label">–°—Å—ã–ª–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="url" class="form-control" id="actionUrl" placeholder="https://example.com">
                    </div>
                    <div class="mb-3">
                        <label for="actionText" class="form-label">–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="text" class="form-control" id="actionText" placeholder="–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å email</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function editContact(contactId) {
    // Redirect to contact detail page for editing
    window.location.href = `/admin/crm/contacts/${contactId}`;
}

function sendEmailToContact(contactId) {
    console.log('sendEmailToContact called with contactId:', contactId);
    // Set contact ID for email form
    const emailForm = document.getElementById('emailForm');
    if (!emailForm) {
        console.error('emailForm not found');
        alert('Email form not found');
        return;
    }
    emailForm.dataset.contactId = contactId;
    const modal = new bootstrap.Modal(document.getElementById('sendEmailModal'));
    modal.show();
}

// Email form submission
document.addEventListener('DOMContentLoaded', function() {
    const emailForm = document.getElementById('emailForm');
    if (emailForm) {
        emailForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const contactId = this.dataset.contactId;
            const subject = document.getElementById('emailSubject').value;
            const message = document.getElementById('emailMessage').value;
            const emailType = document.getElementById('emailType').value;
            const actionUrl = document.getElementById('actionUrl').value;
            const actionText = document.getElementById('actionText').value;
            
            const data = {
                subject: subject,
                message: message,
                email_type: emailType,
                contact_id: contactId
            };
            
            if (actionUrl) data.action_url = actionUrl;
            if (actionText) data.action_text = actionText;
            
            fetch('/admin/crm/contacts/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    bootstrap.Modal.getInstance(document.getElementById('sendEmailModal')).hide();
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email');
            });
        });
    } else {
        console.error('emailForm not found for event listener');
    }
});

// Auto-submit form on filter change
document.getElementById('status').addEventListener('change', function() {
    this.form.submit();
});

document.getElementById('profession').addEventListener('change', function() {
    this.form.submit();
});
</script>
{% endblock %}
