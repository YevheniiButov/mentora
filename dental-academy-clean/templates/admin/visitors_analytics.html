{% extends "admin/base.html" %}

{% block title %}Аналитика посетителей{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('admin.dashboard') }}">Dashboard</a></li>
<li class="breadcrumb-item active">Аналитика посетителей</li>
{% endblock %}

{% block content %}
{% if error_message %}
<div class="alert alert-warning" role="alert">
    <h4 class="alert-heading">⚠️ Ошибка загрузки данных</h4>
    <p>{{ error_message }}</p>
    <hr>
    <p class="mb-0">Показана базовая информация. Некоторые данные могут быть недоступны.</p>
</div>
{% endif %}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-graph-up me-2"></i>
        Аналитика посетителей
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('admin.visitors_analytics', timeframe='24h') }}" 
               class="btn btn-sm {% if time_filter == '24h' %}btn-primary{% else %}btn-outline-secondary{% endif %}">
                24 часа
            </a>
            <a href="{{ url_for('admin.visitors_analytics', timeframe='7d') }}" 
               class="btn btn-sm {% if time_filter == '7d' %}btn-primary{% else %}btn-outline-secondary{% endif %}">
                7 дней
            </a>
            <a href="{{ url_for('admin.visitors_analytics', timeframe='30d') }}" 
               class="btn btn-sm {% if time_filter == '30d' %}btn-primary{% else %}btn-outline-secondary{% endif %}">
                30 дней
            </a>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportData()">
                <i class="bi bi-download"></i> Экспорт
            </button>
            <a href="{{ url_for('admin.online_users') }}" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-people"></i> Онлайн пользователи
            </a>
        </div>
    </div>
</div>

<!-- Statistics Overview -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-primary shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                            Всего визитов
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ "{:,}".format(stats.total_visits) }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-eye fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-success shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                            Уникальные посетители
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ "{:,}".format(stats.unique_visitors) }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-person-circle fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-info shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                            Зарегистрированные
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ "{:,}".format(stats.registered_user_visits) }}
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-person-check fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card border-left-warning shadow h-100 py-2">
            <div class="card-body">
                <div class="row no-gutters align-items-center">
                    <div class="col mr-2">
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                            Показатель отказов
                        </div>
                        <div class="h5 mb-0 font-weight-bold text-gray-800">
                            {{ stats.bounce_rate }}%
                        </div>
                    </div>
                    <div class="col-auto">
                        <i class="bi bi-arrow-return-left fa-2x text-gray-300"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Hourly Activity Chart (for 24h view) -->
    {% if time_filter == '24h' and hourly_stats %}
    <div class="col-12 mb-4">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Активность по часам</h6>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="hourlyChart" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Popular Pages -->
    <div class="col-xl-6 col-lg-7">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Популярные страницы</h6>
            </div>
            <div class="card-body">
                {% if popular_pages %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Страница</th>
                                <th>Визиты</th>
                                <th>Уникальные</th>
                                <th>Доля</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for page in popular_pages %}
                            <tr>
                                <td>
                                    <code class="text-truncate d-inline-block" style="max-width: 300px;">
                                        {{ page.page_url }}
                                    </code>
                                </td>
                                <td>{{ "{:,}".format(page.visits) }}</td>
                                <td>{{ "{:,}".format(page.unique_visitors) }}</td>
                                <td>
                                    {% set percentage = (page.visits / stats.total_visits * 100) if stats.total_visits > 0 else 0 %}
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {{ percentage }}%"
                                             aria-valuenow="{{ percentage }}" 
                                             aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                    <small class="text-muted">{{ "%.1f"|format(percentage) }}%</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-file-earmark fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Нет данных о популярных страницах</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Geographic Distribution -->
    <div class="col-xl-6 col-lg-5">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">География посетителей</h6>
            </div>
            <div class="card-body">
                {% if countries %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Страна</th>
                                <th>Визиты</th>
                                <th>Доля</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for country in countries %}
                            <tr>
                                <td>
                                    <span class="flag-icon flag-icon-{{ country.country.lower() if country.country else 'unknown' }}"></span>
                                    {{ country.country or 'Неизвестно' }}
                                </td>
                                <td>{{ "{:,}".format(country.visits) }}</td>
                                <td>
                                    {% set percentage = (country.visits / stats.total_visits * 100) if stats.total_visits > 0 else 0 %}
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: {{ percentage }}%"
                                             aria-valuenow="{{ percentage }}" 
                                             aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                    <small class="text-muted">{{ "%.1f"|format(percentage) }}%</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-globe fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Нет географических данных</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Browser Statistics -->
    <div class="col-xl-6 col-lg-7">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Браузеры</h6>
            </div>
            <div class="card-body">
                {% if browsers %}
                <div class="table-responsive">
                    <table class="table">
                        <tbody>
                            {% for browser in browsers %}
                            <tr>
                                <td>
                                    {% if 'Chrome' in browser.browser %}
                                    <i class="bi bi-browser-chrome text-warning"></i>
                                    {% elif 'Firefox' in browser.browser %}
                                    <i class="bi bi-browser-firefox text-danger"></i>
                                    {% elif 'Safari' in browser.browser %}
                                    <i class="bi bi-browser-safari text-primary"></i>
                                    {% elif 'Edge' in browser.browser %}
                                    <i class="bi bi-browser-edge text-info"></i>
                                    {% else %}
                                    <i class="bi bi-browser-edge text-secondary"></i>
                                    {% endif %}
                                    {{ browser.browser or 'Неизвестно' }}
                                </td>
                                <td width="100">{{ "{:,}".format(browser.visits) }}</td>
                                <td width="150">
                                    {% set percentage = (browser.visits / stats.total_visits * 100) if stats.total_visits > 0 else 0 %}
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-info" role="progressbar" 
                                             style="width: {{ percentage }}%">
                                        </div>
                                    </div>
                                    <small class="text-muted">{{ "%.1f"|format(percentage) }}%</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-browser-edge fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Нет данных о браузерах</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Device Statistics -->
    <div class="col-xl-6 col-lg-5">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Устройства</h6>
            </div>
            <div class="card-body">
                {% if devices %}
                <div class="chart-container mb-3">
                    <canvas id="deviceChart" height="200"></canvas>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <tbody>
                            {% for device in devices %}
                            <tr>
                                <td>
                                    {% if device.device_type == 'mobile' %}
                                    <i class="bi bi-phone text-success"></i> Мобильные
                                    {% elif device.device_type == 'tablet' %}
                                    <i class="bi bi-tablet text-info"></i> Планшеты
                                    {% elif device.device_type == 'desktop' %}
                                    <i class="bi bi-laptop text-primary"></i> Компьютеры
                                    {% else %}
                                    <i class="bi bi-question-circle text-secondary"></i> {{ device.device_type or 'Неизвестно' }}
                                    {% endif %}
                                </td>
                                <td class="text-end">{{ "{:,}".format(device.visits) }}</td>
                                <td class="text-end">
                                    {% set percentage = (device.visits / stats.total_visits * 100) if stats.total_visits > 0 else 0 %}
                                    {{ "%.1f"|format(percentage) }}%
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-phone fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Нет данных об устройствах</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Time Period Selector -->
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Настройки отображения</h6>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <label for="timeRange" class="form-label">Период анализа:</label>
                <select class="form-select" id="timeRange" onchange="changeTimeRange()">
                    <option value="24h" {% if time_filter == '24h' %}selected{% endif %}>Последние 24 часа</option>
                    <option value="7d" {% if time_filter == '7d' %}selected{% endif %}>Последние 7 дней</option>
                    <option value="30d" {% if time_filter == '30d' %}selected{% endif %}>Последние 30 дней</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Экспорт данных:</label>
                <div>
                    <button class="btn btn-outline-secondary btn-sm me-2" onclick="exportData('csv')">
                        <i class="bi bi-file-earmark-spreadsheet"></i> CSV
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="exportData('json')">
                        <i class="bi bi-file-earmark-code"></i> JSON
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Change time range
function changeTimeRange() {
    const timeRange = document.getElementById('timeRange').value;
    window.location.href = `{{ url_for('admin.visitors_analytics') }}?timeframe=${timeRange}`;
}

// Export data
function exportData(format = 'csv') {
    const timeframe = '{{ time_filter }}';
    const url = `{{ url_for('admin.visitors_analytics') }}?timeframe=${timeframe}&export=${format}`;
    window.location.href = url;
}

// Hourly activity chart (for 24h view)
{% if time_filter == '24h' and hourly_stats %}
const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
const hourlyData = {{ hourly_stats | tojson }};

new Chart(hourlyCtx, {
    type: 'line',
    data: {
        labels: hourlyData.map(d => d.hour + ':00'),
        datasets: [{
            label: 'Визиты',
            data: hourlyData.map(d => d.visits),
            borderColor: '#4e73df',
            backgroundColor: 'rgba(78, 115, 223, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});
{% endif %}

// Device distribution chart
{% if devices %}
const deviceCtx = document.getElementById('deviceChart').getContext('2d');
const deviceData = {{ devices | tojson }};

const deviceLabels = [];
const deviceCounts = [];
const deviceColors = [];

// Проверяем, что deviceData является массивом
if (Array.isArray(deviceData)) {
    deviceData.forEach((item) => {
        // deviceData может быть массивом объектов {device_type, visits} или массивом кортежей [device, count]
        const device = item.device_type || item[0] || item;
        const count = item.visits || item[1] || 0;
        
        if (device === 'mobile') {
            deviceLabels.push('Мобильные');
            deviceColors.push('#28a745');
        } else if (device === 'tablet') {
            deviceLabels.push('Планшеты');
            deviceColors.push('#17a2b8');
        } else if (device === 'desktop') {
            deviceLabels.push('Компьютеры');
            deviceColors.push('#007bff');
        } else {
            deviceLabels.push(device || 'Неизвестно');
            deviceColors.push('#6c757d');
        }
        deviceCounts.push(count);
    });
}

new Chart(deviceCtx, {
    type: 'doughnut',
    data: {
        labels: deviceLabels,
        datasets: [{
            data: deviceCounts,
            backgroundColor: deviceColors,
            borderWidth: 2,
            borderColor: '#ffffff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
{% endif %}

// Auto-refresh every 5 minutes
setInterval(() => {
    location.reload();
}, 300000);

// Add loading state for export buttons
document.addEventListener('DOMContentLoaded', function() {
    const exportButtons = document.querySelectorAll('[onclick^="exportData"]');
    exportButtons.forEach(button => {
        button.addEventListener('click', function() {
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="bi bi-hourglass-split"></i> Экспорт...';
            this.disabled = true;
            
            setTimeout(() => {
                this.innerHTML = originalText;
                this.disabled = false;
            }, 3000);
        });
    });
});
</script>
{% endblock %}
