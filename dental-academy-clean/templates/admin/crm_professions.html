{% extends "admin/base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è–º–∏ - Mentora{% endblock %}

{% block extra_css %}
<style>
.profession-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
}

.profession-card:hover {
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.profession-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-right: 15px;
}

.profession-dental { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
.profession-medical { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
.profession-pharmacy { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
.profession-other { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }

.category-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.category-dental { background: #667eea; color: white; }
.category-medical { background: #f093fb; color: white; }
.category-pharmacy { background: #4facfe; color: white; }
.category-other { background: #43e97b; color: white; }

.big-required {
    background: #28a745;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
}

.big-not-required {
    background: #6c757d;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">üë®‚Äç‚öïÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è–º–∏</h1>
            <p class="text-muted">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–π –∏ –∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –¥–ª—è BIG —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</p>
        </div>
        <div>
            <a href="{{ url_for('admin.crm') }}" class="btn btn-outline-primary">
                <i class="bi bi-graph-up"></i> CRM Dashboard
            </a>
            <a href="{{ url_for('admin.crm_profession_create') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏—é
            </a>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ profession_stats|length }}</h4>
                            <p class="mb-0">–í—Å–µ–≥–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–π</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-briefcase" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ profession_stats|sum(attribute='contact_count') }}</h4>
                            <p class="mb-0">–í—Å–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-people" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ profession_stats|selectattr('profession.big_exam_required')|list|length }}</h4>
                            <p class="mb-0">–¢—Ä–µ–±—É—é—Ç BIG —ç–∫–∑–∞–º–µ–Ω</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-award" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ profession_stats|groupby('profession.category')|list|length }}</h4>
                            <p class="mb-0">–ö–∞—Ç–µ–≥–æ—Ä–∏–π</p>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-tags" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Professions List -->
    {% if profession_stats %}
        {% for stat in profession_stats %}
        <div class="profession-card">
            <div class="row align-items-center">
                <div class="col-md-1">
                    <div class="profession-icon profession-{{ stat.profession.category }}">
                        {% if stat.profession.category == 'dental' %}
                            ü¶∑
                        {% elif stat.profession.category == 'medical' %}
                            ü©∫
                        {% elif stat.profession.category == 'pharmacy' %}
                            üíä
                        {% else %}
                            üë®‚Äç‚öïÔ∏è
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    <h5 class="mb-1">{{ stat.profession.name }}</h5>
                    {% if stat.profession.name_nl %}
                    <p class="text-muted mb-1">{{ stat.profession.name_nl }}</p>
                    {% endif %}
                    <p class="mb-0">
                        <span class="category-badge category-{{ stat.profession.category }}">
                            {{ stat.profession.category }}
                        </span>
                        <span class="ms-2">{{ stat.profession.code }}</span>
                    </p>
                </div>
                <div class="col-md-2">
                    <div class="text-center">
                        <h4 class="mb-0 text-primary">{{ stat.contact_count }}</h4>
                        <small class="text-muted">–∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</small>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="text-center">
                        {% if stat.profession.big_exam_required %}
                        <span class="big-required">BIG —ç–∫–∑–∞–º–µ–Ω</span>
                        {% else %}
                        <span class="big-not-required">–ë–µ–∑ —ç–∫–∑–∞–º–µ–Ω–∞</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3 text-end">
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="viewProfession({{ stat.profession.id }})">
                            <i class="bi bi-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä
                        </button>
                        <button class="btn btn-outline-secondary" onclick="editProfession({{ stat.profession.id }})">
                            <i class="bi bi-pencil"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button class="btn btn-outline-info" onclick="viewContacts({{ stat.profession.id }})">
                            <i class="bi bi-people"></i> –ö–æ–Ω—Ç–∞–∫—Ç—ã
                        </button>
                    </div>
                    <br>
                    <small class="text-muted">
                        –°–æ–∑–¥–∞–Ω–æ: {{ stat.profession.created_at.strftime('%d.%m.%Y') }}
                    </small>
                </div>
            </div>
            
            {% if stat.profession.description %}
            <div class="row mt-3">
                <div class="col-12">
                    <div class="alert alert-light">
                        <strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ stat.profession.description }}
                    </div>
                </div>
            </div>
            {% endif %}
            
            {% if stat.profession.requirements %}
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-info">
                        <strong>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:</strong> {{ stat.profession.requirements }}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    {% else %}
        <div class="text-center py-5">
            <i class="bi bi-briefcase" style="font-size: 4rem; color: #dee2e6;"></i>
            <h4 class="text-muted mt-3">–ü—Ä–æ—Ñ–µ—Å—Å–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
            <p class="text-muted">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –ø—Ä–æ—Ñ–µ—Å—Å–∏—é –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å CRM</p>
            <a href="{{ url_for('admin.crm_profession_create') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏—é
            </a>
        </div>
    {% endif %}
</div>

<!-- Profession Detail Modal -->
<div class="modal fade" id="professionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="professionModalBody">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function viewProfession(professionId) {
    // Load profession details via AJAX
    fetch(`/admin/crm/professions/${professionId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('professionModalBody').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                        <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${data.name}</p>
                        <p><strong>–ö–æ–¥:</strong> ${data.code}</p>
                        <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${data.category}</p>
                        <p><strong>BIG —ç–∫–∑–∞–º–µ–Ω:</strong> ${data.big_exam_required ? '–¢—Ä–µ–±—É–µ—Ç—Å—è' : '–ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h6>
                        <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç–æ–≤:</strong> ${data.contact_count || 0}</p>
                        <p><strong>–°–æ–∑–¥–∞–Ω–æ:</strong> ${new Date(data.created_at).toLocaleDateString()}</p>
                    </div>
                </div>
                ${data.description ? `<div class="mt-3"><h6>–û–ø–∏—Å–∞–Ω–∏–µ</h6><p>${data.description}</p></div>` : ''}
                ${data.requirements ? `<div class="mt-3"><h6>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è</h6><p>${data.requirements}</p></div>` : ''}
            `;
            new bootstrap.Modal(document.getElementById('professionModal')).show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏');
        });
}

function editProfession(professionId) {
    // Redirect to edit page
    window.location.href = `/admin/crm/professions/${professionId}/edit`;
}

function viewContacts(professionId) {
    // Redirect to contacts page with profession filter
    window.location.href = `/admin/crm/contacts?profession=${professionId}`;
}

// Add some animations
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.profession-card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>
{% endblock %}
