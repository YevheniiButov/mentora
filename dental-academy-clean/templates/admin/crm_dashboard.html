{% extends "admin/base.html" %}

{% block title %}CRM Dashboard - Mentora{% endblock %}

{% block extra_css %}
<style>
.funnel-step {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    margin: 10px 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.funnel-step:hover {
    transform: translateY(-5px);
}

.funnel-step.leads { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); }
.funnel-step.prospects { background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%); }
.funnel-step.clients { background: linear-gradient(135deg, #48dbfb 0%, #0abde3 100%); }
.funnel-step.inactive { background: linear-gradient(135deg, #a4b0be 0%, #747d8c 100%); }

.metric-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
    margin-bottom: 20px;
}

.metric-value {
    font-size: 2.5rem;
    font-weight: bold;
    color: #007bff;
}

.metric-label {
    color: #6c757d;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.contact-item {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border-left: 4px solid #28a745;
    transition: all 0.3s ease;
}

.contact-item:hover {
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    transform: translateX(5px);
}

.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-lead { background: #ffc107; color: #000; }
.status-prospect { background: #17a2b8; color: #fff; }
.status-client { background: #28a745; color: #fff; }
.status-inactive { background: #6c757d; color: #fff; }

.chart-container {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.alert-overdue {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">üìä CRM Dashboard</h1>
            <p class="text-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º–∏ –∏ –≤–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂</p>
        </div>
        <div>
            <a href="{{ url_for('admin.crm_contacts') }}" class="btn btn-primary">
                <i class="bi bi-people"></i> –í—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã
            </a>
            <a href="{{ url_for('admin.crm_professions') }}" class="btn btn-outline-primary">
                <i class="bi bi-briefcase"></i> –ü—Ä–æ—Ñ–µ—Å—Å–∏–∏
            </a>
        </div>
    </div>

    <!-- Overdue Follow-ups Alert -->
    {% if overdue_followups > 0 %}
    <div class="alert-overdue">
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-3" style="font-size: 1.5rem;"></i>
            <div>
                <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –£ –≤–∞—Å {{ overdue_followups }} –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –ø–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞–º.
                <a href="{{ url_for('admin.crm_contacts') }}?status=lead" class="text-white text-decoration-underline ms-2">
                    –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å ‚Üí
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Sales Funnel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="chart-container">
                <h5 class="mb-3">üìà –í–æ—Ä–æ–Ω–∫–∞ –ø—Ä–æ–¥–∞–∂</h5>
                <div class="row">
                    <div class="col-md-3">
                        <div class="funnel-step leads">
                            <div class="metric-value">{{ leads }}</div>
                            <div class="metric-label">–õ–∏–¥—ã</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="funnel-step prospects">
                            <div class="metric-value">{{ prospects }}</div>
                            <div class="metric-label">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="funnel-step clients">
                            <div class="metric-value">{{ clients }}</div>
                            <div class="metric-label">–ö–ª–∏–µ–Ω—Ç—ã</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="funnel-step inactive">
                            <div class="metric-value">{{ inactive }}</div>
                            <div class="metric-label">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">{{ total_contacts }}</div>
                <div class="metric-label">–í—Å–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">{{ new_contacts_today }}</div>
                <div class="metric-label">–ù–æ–≤—ã—Ö —Å–µ–≥–æ–¥–Ω—è</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">{{ "%.1f"|format(conversion_rate) }}%</div>
                <div class="metric-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –∫–ª–∏–µ–Ω—Ç—ã</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">{{ overdue_followups }}</div>
                <div class="metric-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á</div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Recent Contacts -->
        <div class="col-md-6">
            <div class="chart-container">
                <h5 class="mb-3">üïí –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã</h5>
                {% if recent_contacts %}
                    {% for contact in recent_contacts %}
                    <div class="contact-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ contact.full_name }}</strong>
                                <br>
                                <small class="text-muted">{{ contact.email }}</small>
                                {% if contact.profession %}
                                <br>
                                <small class="text-info">{{ contact.profession.name }}</small>
                                {% endif %}
                            </div>
                            <div class="text-end">
                                <span class="status-badge status-{{ contact.contact_status }}">
                                    {{ contact.status_display }}
                                </span>
                                <br>
                                <small class="text-muted">
                                    {{ contact.created_at.strftime('%d.%m.%Y') }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted text-center py-4">–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</p>
                {% endif %}
            </div>
        </div>

        <!-- Lead Sources & Professions -->
        <div class="col-md-6">
            <!-- Lead Sources -->
            <div class="chart-container mb-4">
                <h5 class="mb-3">üìä –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –ª–∏–¥–æ–≤</h5>
                {% if lead_sources %}
                    {% for source in lead_sources %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>{{ source.lead_source or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</span>
                        <span class="badge bg-primary">{{ source.count }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted text-center py-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                {% endif %}
            </div>

            <!-- Profession Distribution -->
            <div class="chart-container">
                <h5 class="mb-3">üë®‚Äç‚öïÔ∏è –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏—è–º</h5>
                {% if profession_stats %}
                    {% for stat in profession_stats %}
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>{{ stat.name }}</span>
                        <span class="badge bg-success">{{ stat.count }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted text-center py-2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh dashboard every 5 minutes
setInterval(function() {
    location.reload();
}, 300000);

// Add some animations
document.addEventListener('DOMContentLoaded', function() {
    // Animate metric cards
    const cards = document.querySelectorAll('.metric-card, .funnel-step');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>
{% endblock %}
