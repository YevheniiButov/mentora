{% extends "base.html" %}

{% block title %}Email Test - Mentora{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">ü¶∑ Mentora - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Email</h4>
                </div>
                <div class="card-body">
                    <!-- Email Configuration Info -->
                    <div class="mb-4">
                        <h5>üìã –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</h5>
                        <div id="config-info" class="alert alert-info">
                            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...</p>
                        </div>
                    </div>

                    <!-- Test Email Form -->
                    <div class="mb-4">
                        <h5>üìß –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–∏—Å—å–º–∞</h5>
                        <form id="email-test-form">
                            <div class="mb-3">
                                <label for="recipient" class="form-label">Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label>
                                <input type="email" class="form-control" id="recipient" 
                                       value="xapstom@gmail.com"
                                       placeholder="example@email.com">
                                <div class="form-text">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –≤–∞—à email</div>
                            </div>
                            <button type="submit" class="btn btn-primary" id="send-btn">
                                <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ
                            </button>
                        </form>
                    </div>

                    <!-- Results -->
                    <div id="result" class="mt-4" style="display: none;">
                        <!-- Results will be shown here -->
                    </div>

                    <!-- Troubleshooting -->
                    <div class="mt-4">
                        <h5>üîß –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º</h5>
                        <div class="alert alert-warning">
                            <h6>–ï—Å–ª–∏ –ø–∏—Å—å–º–∞ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç:</h6>
                            <ol>
                                <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É "–°–ø–∞–º"</li>
                                <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ MAIL_SUPPRESS_SEND = False</li>
                                <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SMTP –≤ Brevo –ø–∞–Ω–µ–ª–∏</li>
                                <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–æ–º–µ–Ω –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –≤ Brevo</li>
                                <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏–º–∏—Ç—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç–µ</li>
                            </ol>
                        </div>
                    </div>

                    <!-- Alternative Tests -->
                    <div class="mt-4">
                        <h5>üõ†Ô∏è –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã</h5>
                        <p>–ï—Å–ª–∏ –≤–µ–±-—Ç–µ—Å—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ:</p>
                        <div class="bg-dark text-light p-3 rounded">
                            <code>cd "/Users/evgenijbutov/Desktop/demo/flask-app 2/dental-academy-clean"</code><br>
                            <code>python debug_email.py</code>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load configuration on page load
    loadEmailConfig();
    
    // Handle form submission
    document.getElementById('email-test-form').addEventListener('submit', function(e) {
        e.preventDefault();
        sendTestEmail();
    });
});

function loadEmailConfig() {
    fetch('/email-config')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayConfig(data.config);
            } else {
                document.getElementById('config-info').innerHTML = 
                    '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</p>';
            }
        })
        .catch(error => {
            console.error('Error loading config:', error);
            document.getElementById('config-info').innerHTML = 
                '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</p>';
        });
}

function displayConfig(config) {
    const configHtml = `
        <table class="table table-sm">
            <tr>
                <td><strong>MAIL_SERVER:</strong></td>
                <td>${config.MAIL_SERVER || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'}</td>
            </tr>
            <tr>
                <td><strong>MAIL_PORT:</strong></td>
                <td>${config.MAIL_PORT || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'}</td>
            </tr>
            <tr>
                <td><strong>MAIL_USE_TLS:</strong></td>
                <td>${config.MAIL_USE_TLS ? '‚úÖ –í–∫–ª—é—á–µ–Ω–æ' : '‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ'}</td>
            </tr>
            <tr>
                <td><strong>MAIL_USERNAME:</strong></td>
                <td>${config.MAIL_USERNAME || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'}</td>
            </tr>
            <tr>
                <td><strong>MAIL_DEFAULT_SENDER:</strong></td>
                <td>${config.MAIL_DEFAULT_SENDER || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'}</td>
            </tr>
            <tr class="${config.MAIL_SUPPRESS_SEND ? 'table-warning' : 'table-success'}">
                <td><strong>MAIL_SUPPRESS_SEND:</strong></td>
                <td>${config.MAIL_SUPPRESS_SEND ? '‚ö†Ô∏è –ü–æ–¥–∞–≤–ª–µ–Ω–æ (–ø–∏—Å—å–º–∞ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è)' : '‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞'}</td>
            </tr>
            <tr>
                <td><strong>FLASK_ENV:</strong></td>
                <td>${config.FLASK_ENV || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ'}</td>
            </tr>
        </table>
    `;
    
    document.getElementById('config-info').innerHTML = configHtml;
}

function sendTestEmail() {
    const recipient = document.getElementById('recipient').value;
    const sendBtn = document.getElementById('send-btn');
    const resultDiv = document.getElementById('result');
    
    // Disable button and show loading
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
    
    // Hide previous result
    resultDiv.style.display = 'none';
    
    fetch('/send-test-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            recipient: recipient
        })
    })
    .then(response => response.json())
    .then(data => {
        showResult(data);
    })
    .catch(error => {
        console.error('Error:', error);
        showResult({
            success: false,
            error: '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞'
        });
    })
    .finally(() => {
        // Re-enable button
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ –ø–∏—Å—å–º–æ';
    });
}

function showResult(data) {
    const resultDiv = document.getElementById('result');
    
    if (data.success) {
        resultDiv.innerHTML = `
            <div class="alert alert-success">
                <h5>‚úÖ –ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!</h5>
                <p>${data.message}</p>
                ${data.smtp_info ? `
                    <small>
                        SMTP: ${data.smtp_info.server}:${data.smtp_info.port}<br>
                        –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${data.smtp_info.suppress_send ? '–í–∫–ª—é—á–µ–Ω–æ' : '–û—Ç–∫–ª—é—á–µ–Ω–æ'}
                    </small>
                ` : ''}
                <hr>
                <p><strong>–ß—Ç–æ –¥–∞–ª—å—à–µ:</strong></p>
                <ul>
                    <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç–æ–≤—ã–π —è—â–∏–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</li>
                    <li>–ï—Å–ª–∏ –ø–∏—Å—å–º–∞ –Ω–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞–ø–∫—É "–°–ø–∞–º"</li>
                    <li>–ü–∏—Å—å–º–æ –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 1-2 –º–∏–Ω—É—Ç</li>
                </ul>
            </div>
        `;
    } else {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <h5>‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</h5>
                <p><strong>–û—à–∏–±–∫–∞:</strong> ${data.error}</p>
                ${data.error_type ? `<p><strong>–¢–∏–ø –æ—à–∏–±–∫–∏:</strong> ${data.error_type}</p>` : ''}
                <hr>
                <p><strong>–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:</strong></p>
                <ul>
                    <li>–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</li>
                    <li>–ü—Ä–æ–±–ª–µ–º—ã —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π Brevo</li>
                    <li>–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ Brevo</li>
                    <li>–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç–µ–≤—ã–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º</li>
                </ul>
            </div>
        `;
    }
    
    resultDiv.style.display = 'block';
}
</script>
{% endblock %}
