{% extends "base.html" %}

{% block title %}Карта участника Mentora{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/membership.css') }}">
{% endblock %}

{% block content %}
<div class="membership-container">
    <div class="membership-header">
        <h1>{{ t('your_membership_card', session.get('lang', 'nl')) | default('Uw Mentora Lidmaatschapskaart') }}</h1>
        <p class="membership-subtitle">{{ t('digital_card_subtitle', session.get('lang', 'nl')) | default('Digitale kaart voor medische professionals in Nederland') }}</p>
    </div>

    <div class="card-wrapper" id="membership-card">
        <!-- Membership Card -->
        <div class="membership-card" id="card-content">
            <!-- Top Section with Real Logo -->
            <div class="card-top">
                <div class="card-logo">
                    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Mentora" class="logo-img">
                </div>
            </div>

            <!-- Card Content -->
            <div class="card-content-grid">
                <!-- Left: Member Info -->
                <div class="member-info-section">
                    <h2 class="member-name">{{ current_user.get_display_name() }}</h2>
                    <p class="member-profession">
                        {% if current_user.profession == 'tandarts' %}{{ t('dentist', session.get('lang', 'nl')) | default('Tandarts') }}
                        {% elif current_user.profession == 'huisarts' %}{{ t('general_practitioner', session.get('lang', 'nl')) | default('Huisarts') }}
                        {% elif current_user.profession == 'verpleegkundige' %}{{ t('nurse', session.get('lang', 'nl')) | default('Verpleegkundige') }}
                        {% elif current_user.profession == 'apotheker' %}{{ t('pharmacist', session.get('lang', 'nl')) | default('Apotheker') }}
                        {% else %}{{ current_user.profession or 'Medical Professional' }}
                        {% endif %}
                    </p>
                    
                    <div class="member-details-box">
                        <p class="member-id"><strong>{{ t('member_id', session.get('lang', 'nl')) | default('Lid ID') }}:</strong> {{ current_user.member_id or 'MNT-XXXXX' }}</p>
                        <p class="validity-date"><strong>{{ t('valid_until', session.get('lang', 'nl')) | default('Geldig tot') }}:</strong> {{ current_user.membership_expires.strftime('%d/%m/%Y') if current_user.membership_expires else '31/12/2025' }}</p>
                        <p class="website">bigmentor.nl</p>
                    </div>
                </div>
                
                <!-- Right: QR Code -->
                <div class="qr-section">
                    <div class="qr-code-container">
                        {% if current_user.qr_code_path %}
                            <img src="{{ url_for('static', filename=current_user.qr_code_path) }}" 
                                 alt="QR Code" 
                                 class="qr-code no-optimize" 
                                 data-no-optimize="true"
                                 loading="eager">
                        {% else %}
                            <div class="qr-placeholder">
                                <i class="fas fa-qrcode" style="font-size: 3rem; color: #cbd5e0;"></i>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #a0aec0;">{{ t('qr_not_generated', session.get('lang', 'nl')) | default('QR niet gegenereerd') }}</p>
                            </div>
                        {% endif %}
                    </div>
                    <p class="qr-label">{{ t('scan_to_verify', session.get('lang', 'nl')) | default('Scan om te verifiëren') }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Privacy Settings -->
    <div class="privacy-section" style="margin-bottom: 2rem; padding: 1.5rem; background: #f9fafb; border-radius: 16px; border: 2px solid #e5e7eb;">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
            <div style="flex: 1; min-width: 250px;">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 1.1rem; color: #111827; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-shield-alt" style="color: #14b8a6;"></i>
                    {{ t('privacy_settings', session.get('lang', 'nl')) | default('Privacy Settings') }}
                </h3>
                <p style="margin: 0; font-size: 0.9rem; color: #6b7280;">
                    {{ t('allow_public_verification', session.get('lang', 'nl')) | default('Allow others to view my profile information when scanning my QR code') }}
                </p>
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="profile-public-toggle" 
                       {% if current_user.profile_public or current_user.profile_public is none %}checked{% endif %}
                       onchange="updatePrivacySettings(this.checked)">
                <span class="toggle-slider"></span>
            </label>
        </div>
        <p style="margin: 1rem 0 0 0; font-size: 0.85rem; color: #9ca3af; display: flex; align-items: start; gap: 0.5rem;">
            <i class="fas fa-info-circle" style="margin-top: 0.15rem; color: #14b8a6;"></i>
            <span>{{ t('privacy_note', session.get('lang', 'nl')) | default('When disabled, only your Member ID and verification status will be shown. Your name and other details will remain private.') }}</span>
        </p>
    </div>

    <!-- Download Buttons -->
    <div class="download-section">
        <button class="download-btn" id="download-png" onclick="downloadPNG()">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7,10 12,15 17,10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            {{ t('download_png', session.get('lang', 'nl')) | default('Download PNG') }}
        </button>
        <button class="download-btn" id="download-pdf" onclick="downloadPDF()">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14,2 14,8 20,8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10,9 9,9 8,9"></polyline>
            </svg>
            {{ t('download_pdf', session.get('lang', 'nl')) | default('Download PDF') }}
        </button>
        <button class="download-btn" id="regenerate-qr" onclick="regenerateQR()" style="background: linear-gradient(135deg, #14b8a6, #0d9488);">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"></path>
            </svg>
            {{ t('regenerate_qr', session.get('lang', 'nl')) | default('Update QR Code') }}
        </button>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <p>{{ t('generating_file', session.get('lang', 'nl')) | default('Bestand genereren...') }}</p>
    </div>
</div>

<!-- Include external libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/membership.js') }}"></script>

<style>
/* Toggle Switch Styling */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
    flex-shrink: 0;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #cbd5e0;
    transition: 0.3s;
    border-radius: 34px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
}

.toggle-switch input:checked + .toggle-slider {
    background: linear-gradient(135deg, #14b8a6, #0d9488);
}

.toggle-switch input:checked + .toggle-slider:before {
    transform: translateX(26px);
}

.toggle-switch input:focus + .toggle-slider {
    box-shadow: 0 0 1px #14b8a6;
}
</style>

<script>
// Function to update privacy settings
async function updatePrivacySettings(isPublic) {
    try {
        const response = await fetch('{{ url_for("membership.update_privacy") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ profile_public: isPublic })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show temporary success message
            const message = isPublic ? 
                '{{ t("profile_now_public", session.get("lang", "nl")) | default("Your profile is now visible to others") }}' :
                '{{ t("profile_now_private", session.get("lang", "nl")) | default("Your profile is now private") }}';
            
            // Create a temporary notification
            const notification = document.createElement('div');
            notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #14b8a6; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 9999; animation: slideIn 0.3s ease;';
            notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        } else {
            alert('{{ t("privacy_update_error", session.get("lang", "nl")) | default("Error updating privacy settings") }}');
            // Revert toggle
            document.getElementById('profile-public-toggle').checked = !isPublic;
        }
    } catch (error) {
        console.error('Error updating privacy:', error);
        alert('{{ t("privacy_update_error", session.get("lang", "nl")) | default("Error updating privacy settings") }}');
        // Revert toggle
        document.getElementById('profile-public-toggle').checked = !isPublic;
    }
}

// Function to regenerate QR code
async function regenerateQR() {
    const btn = document.getElementById('regenerate-qr');
    const originalText = btn.innerHTML;
    
    // Disable button and show loading
    btn.disabled = true;
    btn.innerHTML = '<div class="loading-spinner" style="width: 20px; height: 20px; margin: 0 auto;"></div>';
    
    try {
        const response = await fetch('{{ url_for("membership.regenerate_qr") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show success message
            alert('{{ t("qr_regenerated_success", session.get("lang", "nl")) | default("QR code successfully updated!") }}');
            // Reload page to show new QR code
            window.location.reload();
        } else {
            alert('{{ t("qr_regeneration_error", session.get("lang", "nl")) | default("Error updating QR code") }}: ' + (data.error || 'Unknown error'));
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    } catch (error) {
        console.error('Error regenerating QR:', error);
        alert('{{ t("qr_regeneration_error", session.get("lang", "nl")) | default("Error updating QR code") }}');
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}
</script>
{% endblock %}


