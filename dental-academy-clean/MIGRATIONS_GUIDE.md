# üîß –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ Alembic

## –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞ "Can't locate revision identified by 'XXX'"

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø):**

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```bash
python3 scripts/fix_migrations.py --force-sync
```

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç:
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å —Ñ–∞–π–ª–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–π
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î —Å —Ç–µ–∫—É—â–∏–º head
- –û–±—Ö–æ–¥–∏—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–º–∏ —Ä–µ–≤–∏–∑–∏—è–º–∏ –≤ —Ü–µ–ø–æ—á–∫–µ

**–†—É—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:**

–ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –Ω–µ –ø–æ–º–æ–≥, –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –Ω–∞–ø—Ä—è–º—É—é:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π head:**
```bash
flask db heads
```

2. **–û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É alembic_version –Ω–∞–ø—Ä—è–º—É—é:**
```python
python3 << 'EOF'
from app import app
from extensions import db
import sqlalchemy as sa

with app.app_context():
    head_rev = 'add_other_study_country_001'  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ç–µ–∫—É—â–∏–π head
    db.session.execute(sa.text("UPDATE alembic_version SET version_num = :rev"), {'rev': head_rev})
    db.session.commit()
    print(f'‚úÖ Updated to {head_rev}')
EOF
```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
flask db current
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:

```bash
# –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å (–Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç –Ω–∏—á–µ–≥–æ)
python3 scripts/fix_migrations.py --check-only

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ë–î —Å head
python3 scripts/fix_migrations.py --force-sync
```

## –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

### 1. –í–Ω–µ—Å–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –º–æ–¥–µ–ª—å (models.py)

–ù–∞–ø—Ä–∏–º–µ—Ä:
```python
other_study_country = db.Column(db.String(100), nullable=True)
```

### 2. –°–æ–∑–¥–∞–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é

```bash
flask db migrate -m "–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π"
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ:
- `revision` —É–Ω–∏–∫–∞–ª–µ–Ω
- `down_revision` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ä–µ–≤–∏–∑–∏—é (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á–µ—Ä–µ–∑ `flask db heads`)

### 4. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é

**–õ–æ–∫–∞–ª—å–Ω–æ:**
```bash
flask db upgrade
```

**–ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:**
```bash
flask db upgrade
```

## –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏

–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏:

```python
def _has_column(table_name: str, column_name: str) -> bool:
    bind = op.get_bind()
    inspector = sa.inspect(bind)
    columns = [c['name'] for c in inspector.get_columns(table_name)]
    return column_name in columns

def upgrade():
    if not _has_column('user', 'other_study_country'):
        op.add_column('user', sa.Column('other_study_country', sa.String(length=100), nullable=True))

def downgrade():
    if _has_column('user', 'other_study_country'):
        op.drop_column('user', 'other_study_country')
```

### –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏

**‚ö†Ô∏è –û—Å—Ç–æ—Ä–æ–∂–Ω–æ!** –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ –¥–∞–Ω–Ω—ã—Ö.

–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º:
```python
def downgrade():
    if _has_column('user', 'old_field'):
        op.drop_column('user', 'old_field')
```

## –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: "Can't locate revision identified by 'XXX'"

**–ü—Ä–∏—á–∏–Ω–∞:** –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ä–µ–≤–∏–∑–∏—è, –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç –≤ —Ñ–∞–π–ª–∞—Ö –º–∏–≥—Ä–∞—Ü–∏–π, –∏–ª–∏ —Ñ–∞–π–ª—ã –º–∏–≥—Ä–∞—Ü–∏–π —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ä–µ–≤–∏–∑–∏—é.

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –í–∞—Ä–∏–∞–Ω—Ç 1: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ë–î —Å —Ç–µ–∫—É—â–∏–º head
flask db stamp head

# –í–∞—Ä–∏–∞–Ω—Ç 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
python3 scripts/fix_migrations.py --force-sync
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: Multiple heads (–Ω–µ—Å–∫–æ–ª—å–∫–æ head-—Ä–µ–≤–∏–∑–∏–π)

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Å–∫–æ–ª—å–∫–æ –º–∏–≥—Ä–∞—Ü–∏–π –Ω–µ —Å–≤—è–∑–∞–Ω—ã –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º –≤ —Ü–µ–ø–æ—á–∫–µ.

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –°–æ–∑–¥–∞—Ç—å merge-–º–∏–≥—Ä–∞—Ü–∏—é
flask db merge -m "Merge multiple heads"

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å
flask db upgrade
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–µ–∂–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

**–ü—Ä–∏—á–∏–Ω–∞:** –ö–æ–ª–æ–Ω–∫–∏ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–±.

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ (—Å–º. "–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏")
flask db migrate -m "Add field X"

# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é, –¥–æ–±–∞–≤–∏–≤ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
# –ó–∞—Ç–µ–º –ø—Ä–∏–º–µ–Ω–∏—Ç—å
flask db upgrade
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

1. **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ª–æ–∫–∞–ª—å–Ω–æ** –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è** –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (add/drop column)
3. **–î–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø –ë–î** –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –º–∏–≥—Ä–∞—Ü–∏–π
4. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ downgrade** (–æ—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π) –ª–æ–∫–∞–ª—å–Ω–æ
5. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

```bash
# –¢–µ–∫—É—â–∞—è —Ä–µ–≤–∏–∑–∏—è –≤ –ë–î
flask db current

# –í—Å–µ head-—Ä–µ–≤–∏–∑–∏–∏
flask db heads

# –ò—Å—Ç–æ—Ä–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
flask db history

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ (—Å–∫—Ä–∏–ø—Ç)
python3 scripts/fix_migrations.py --check-only
```

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏

- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ
- [ ] `down_revision` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ä–µ–≤–∏–∑–∏—é
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è (–¥–ª—è add/drop)
- [ ] `downgrade()` —Ñ—É–Ω–∫—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ
- [ ] –°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø –ë–î (–¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)
- [ ] `flask db upgrade` –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ

