class TemplateLoader{constructor(editor,options={}){this.editor=editor;this.options={cacheEnabled: true,cacheTimeout: 5*60*1000,showPreview: true,autoSave: true,...options};this.templates=[];this.templateCache=new Map();this.currentTemplate=null;this.isLoading=false;this.init();}init(){this.createEnhancedUI();this.setupEventListeners();}createEnhancedUI(){const openFileExplorerBtn=document.getElementById('open-file-explorer');if(!openFileExplorerBtn){const buttonContainer=document.querySelector('.d-flex.gap-2.align-items-center');if(buttonContainer){const newButton=document.createElement('button');newButton.className='btn btn-outline-primary';newButton.id='open-file-explorer';newButton.title='Открыть проводник';newButton.innerHTML='<i class="bi bi-folder2"></i>Открыть проводник';buttonContainer.appendChild(newButton);}}}setupEventListeners(){document.addEventListener('click',(e)=>{if(e.target.id==='open-file-explorer'||e.target.closest('#open-file-explorer')){e.preventDefault();e.stopPropagation();if(window.fileExplorer){window.fileExplorer.open();}else{console.error('❌ FileExplorer instance not found');alert('Файловый проводник не инициализирован. Обновите страницу.');}}});}enableButtons(){const buttons=['undo-btn','redo-btn','preview-btn','save-btn'];buttons.forEach(btnId=>{const btn=document.getElementById(btnId);if(btn){btn.disabled=false;}});}updateStatus(type,text){const statusDot=document.getElementById('status-dot');const statusText=document.getElementById('status-text');if(statusDot&&statusText){statusDot.className=`status-dot ${type}`;statusText.textContent=text;}}showNotification(message,type='info'){const notification=document.createElement('div');notification.className=`notification ${type}`;notification.innerHTML=`<i class="bi bi-${type==='success' ? 'check-circle' : type==='error' ? 'exclamation-triangle' : 'info-circle'}"></i>${message}`;document.body.appendChild(notification);setTimeout(()=>{if(notification.parentElement){notification.remove();}},3000);}getCSRFToken(){return document.querySelector('meta[name="csrf-token"]')?.content||'';}getTemplateIcon(category){const icons={'core': 'file-earmark-text','learning': 'book','virtual_patient': 'person-heart','tests': 'question-circle','includes': 'code-slash'};return icons[category]||'file-earmark';}getCategoryName(category){const names={'core': 'Основные','learning': 'Обучение','virtual_patient': 'Виртуальный пациент','tests': 'Тесты','includes': 'Включения'};return names[category]||category;}destroy(){if(window.fileExplorer){window.fileExplorer.destroy();window.fileExplorer=null;}}}window.TemplateLoader=TemplateLoader;document.addEventListener('DOMContentLoaded',()=>{let attempts=0;const maxAttempts=20;const checkEditor=setInterval(()=>{attempts++;const editor=window.editor;const fileExplorer=typeof FileExplorer!=='undefined';if(editor&&editor.getComponents&&fileExplorer){clearInterval(checkEditor);window.templateLoader=new TemplateLoader(editor,{cacheEnabled: true,cacheTimeout: 5*60*1000,showPreview: true,autoSave: true});}else if(attempts>=maxAttempts){clearInterval(checkEditor);console.error('❌ Template Loader failed to initialize: editor or FileExplorer not found after maximum attempts');}},500);});