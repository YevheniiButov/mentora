console.log('üîß file-explorer.js loading...');class FileExplorer{constructor(options={}){console.log('üîß FileExplorer constructor called');this.options={apiBase: '/api/content-editor',modalId: 'fileExplorerModal',...options};this.currentPath='';this.visualEditor=null;this.currentFile=null;this.apiBase=this.options.apiBase;this.fileLoader=null;console.log('üîß FileExplorer constructor-window.currentLang:',window.currentLang);console.log('üîß FileExplorer constructor-apiBase:',this.apiBase);this.init();this.initializeFileLoader();}init(){console.log('üîß File Explorer initializing...');this.createModal();this.setupEventListeners();console.log('‚úÖ File Explorer initialized');}initializeFileLoader(){console.log('üîß Initializing Enhanced File Loader...');const initLoader=()=>{if(window.editor&&window.editor.Canvas&&window.EnhancedFileLoader){try{this.fileLoader=new window.EnhancedFileLoader(window.editor);console.log('‚úÖ Enhanced File Loader initialized in FileExplorer');return true;}catch(error){console.error('‚ùå Error creating EnhancedFileLoader:',error);return false;}}return false;};if(!initLoader()){const checkInterval=setInterval(()=>{if(initLoader()){clearInterval(checkInterval);}},100);setTimeout(()=>{clearInterval(checkInterval);console.warn('‚ö†Ô∏è EnhancedFileLoader initialization timeout in FileExplorer');},10000);}}createModal(){console.log('üîß Creating modal...');const existingModal=document.getElementById(this.options.modalId);if(existingModal){existingModal.remove();}const modalHTML=`<div class="modal fade file-explorer-modal" id="${this.options.modalId}" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="fas fa-folder-open me-2"></i>–§–∞–π–ª–æ–≤—ã–π –ø—Ä–æ–≤–æ–¥–Ω–∏–∫</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><!--Breadcrumbs –Ω–∞–≤–∏–≥–∞—Ü–∏—è--><div class="path-breadcrumbs"><nav aria-label="breadcrumb"><ol class="breadcrumb mb-0"><li class="breadcrumb-item"><a href="#" data-path="">–ö–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞</a></li></ol></nav></div><!--–û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–∞–π–ª–æ–≤--><div class="file-list"><div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...</p></div></div><!--–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞--><div class="file-preview" style="display: none;"><div class="preview-header"><h6>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–∞</h6></div><pre><code></code></pre></div></div></div></div></div>`;document.body.insertAdjacentHTML('beforeend',modalHTML);this.modal=document.getElementById(this.options.modalId);console.log('üîß Modal created:',this.modal);}setupEventListeners(){console.log('üîß Setting up event listeners...');this.modal.addEventListener('click',(e)=>{if(e.target.matches('.breadcrumb-item a')){e.preventDefault();const path=e.target.dataset.path||'';this.navigateTo(path);}});this.modal.addEventListener('click',(e)=>{const fileItem=e.target.closest('.file-item');if(!fileItem)return;const path=fileItem.dataset.path;if(!path)return;if(e.target.closest('.file-actions')){return;}if(fileItem.classList.contains('directory')){this.navigateTo(path);}else{const extension=path.toLowerCase().split('.').pop();if(extension==='html'||extension==='htm'){this.loadFileInEditor(path);}else{this.previewFile(path);}}});}open(){console.log('üîß Opening File Explorer...');if(typeof bootstrap==='undefined'){console.error('‚ùå Bootstrap not loaded');alert('Bootstrap –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤.');return;}const modal=new bootstrap.Modal(this.modal);modal.show();this.navigateTo('');}close(){const modal=bootstrap.Modal.getInstance(this.modal);if(modal){modal.hide();}}async navigateTo(path){console.log('üîß Navigating to:',path);this.currentPath=path;try{await this.loadCurrentPath();this.updateBreadcrumbs();}catch(error){console.error('‚ùå Navigation error:',error);this.showNotification('–û—à–∏–±–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏: '+error.message,'error');}}async loadCurrentPath(){const fileList=this.modal.querySelector('.file-list');fileList.innerHTML=`<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...</p></div>`;try{console.log('üîß FileExplorer-Making request to:',`${this.apiBase}/file-explorer?path=${this.currentPath}`);const response=await fetch(`${this.apiBase}/file-explorer?path=${this.currentPath}`,{headers:{'X-CSRFToken': this.getCSRFToken()}});if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`);}const data=await response.json();if(data.success){this.displayFiles(data.files);}else{throw new Error(data.error||'Failed to load files');}}catch(error){console.error('Error loading files:',error);fileList.innerHTML=`<div class="text-center py-4"><i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i><p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤</p><p class="text-muted">${error.message}</p></div>`;}}displayFiles(files){const fileList=this.modal.querySelector('.file-list');if(!fileList)return;if(!files||files.length===0){fileList.innerHTML=`<div class="text-center py-4"><i class="fas fa-folder-open fa-3x text-muted mb-3"></i><p class="text-muted">–ü–∞–ø–∫–∞ –ø—É—Å—Ç–∞</p></div>`;return;}const sortedFiles=files.sort((a,b)=>{if(a.type==='directory'&&b.type==='file')return-1;if(a.type==='file'&&b.type==='directory')return 1;return a.name.localeCompare(b.name);});let filesHtml='<div class="file-grid">';sortedFiles.forEach(file=>{const isHTML=file.extension==='.html'||file.extension==='.htm';const isEditable=file.editable;filesHtml+=`<div class="file-item ${file.type}" data-path="${file.path}"><div class="file-icon">${this.getFileIcon(file)}</div><div class="file-info"><div class="file-name" title="${file.name}">${file.name}</div>${file.size ? `<div class="file-size">${this.formatFileSize(file.size)}</div>` : ''}</div><div class="file-actions">${isHTML ? `<button class="btn btn-sm btn-primary me-1" onclick="window.fileExplorer.openVisualEditor('${file.path}')" title="–í–∏–∑—É–∞–ª—å–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"><i class="fas fa-palette"></i></button><button class="btn btn-sm btn-info me-1" onclick="window.fileExplorer.previewFullPage('${file.path}')" title="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã"><i class="fas fa-external-link-alt"></i></button>` : ''}${isEditable ? `<button class="btn btn-sm btn-outline-secondary me-1" onclick="window.fileExplorer.editTextFile('${file.path}')" title="–¢–µ–∫—Å—Ç–æ–≤–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"><i class="fas fa-code"></i></button>` : ''}<button class="btn btn-sm btn-outline-danger" onclick="window.fileExplorer.deleteFile('${file.path}')" title="–£–¥–∞–ª–∏—Ç—å"><i class="fas fa-trash"></i></button></div></div>`;});filesHtml+='</div>';fileList.innerHTML=filesHtml;}getFileIcon(file){if(file.type==='directory'){return '<i class="fas fa-folder"></i>';}const extension=file.extension?.toLowerCase();switch(extension){case '.html': case '.htm': return '<i class="fas fa-file-code"></i>';case '.css': return '<i class="fas fa-file-code"></i>';case '.js': return '<i class="fas fa-file-code"></i>';case '.json': return '<i class="fas fa-file-code"></i>';case '.png': case '.jpg': case '.jpeg': case '.gif': case '.svg': return '<i class="fas fa-file-image"></i>';default: return '<i class="fas fa-file"></i>';}}formatFileSize(bytes){if(!bytes)return '';const sizes=['Bytes','KB','MB','GB'];const i=Math.floor(Math.log(bytes)/Math.log(1024));return Math.round(bytes/Math.pow(1024,i)*100)/100+' '+sizes[i];}updateBreadcrumbs(){const breadcrumb=this.modal.querySelector('.breadcrumb');const pathParts=this.currentPath.split('/').filter(part=>part);let breadcrumbHTML=`<li class="breadcrumb-item"><a href="#" data-path="">–ö–æ—Ä–Ω–µ–≤–∞—è –ø–∞–ø–∫–∞</a></li>`;let currentPath='';pathParts.forEach((part,index)=>{currentPath+=(currentPath ? '/' : '')+part;const isLast=index===pathParts.length-1;breadcrumbHTML+=`<li class="breadcrumb-item ${isLast ? 'active' : ''}">${isLast ? part : `<a href="#" data-path="${currentPath}">${part}</a>`}</li>`;});breadcrumb.innerHTML=breadcrumbHTML;}async previewFile(path){console.log('üîß Previewing file:',path);try{const response=await fetch(`${this.apiBase}/template-content/${encodeURIComponent(path)}`,{headers:{'X-CSRFToken': this.getCSRFToken()}});if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`);}const data=await response.json();if(data.success){const previewWindow=window.open('','_blank');this.writeToPreviewWindow(previewWindow,data.content);}else{throw new Error(data.error||'Failed to load template');}}catch(error){console.error('Error previewing file:',error);this.showNotification('–û—à–∏–±–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞: '+error.message,'error');}}async loadFile(path){console.log('üîß Loading file:',path);try{const response=await fetch(`${this.apiBase}/template-content/${encodeURIComponent(path)}`,{headers:{'X-CSRFToken': this.getCSRFToken()}});if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`);}const data=await response.json();if(data.success&&this.editor){this.editor.setComponents('');this.editor.setStyle('');if(data.content){this.editor.setComponents(data.content);}this.close();this.showNotification('–®–∞–±–ª–æ–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω','success');const selectedTemplate=document.getElementById('selected-template');if(selectedTemplate){selectedTemplate.textContent=path.split('/').pop();}}else{throw new Error(data.error||'Failed to load template');}}catch(error){console.error('Error loading file:',error);this.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+error.message,'error');}}async loadFileInEditor(path){console.log('üîß Loading file with enhanced loader:',path);try{if(!this.fileLoader){console.warn('‚ö†Ô∏è Enhanced File Loader not ready,falling back to basic loading');return this.loadFileInEditorBasic(path);}const result=await this.fileLoader.loadFile(path);if(result.success){this.showNotification('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä','success');this.updateTemplateSelector(path);this.close();this.enableEditorControls();console.log('‚úÖ File loaded successfully via Enhanced File Loader');}else{throw new Error(result.error||'Failed to load file');}}catch(error){console.error('‚ùå Error loading file via Enhanced File Loader:',error);this.showNotification(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`,'error');console.log('üîÑ Falling back to basic file loading...');try{await this.loadFileInEditorBasic(path);}catch(fallbackError){console.error('‚ùå Fallback loading also failed:',fallbackError);this.showNotification('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞','error');}}}async loadFileInEditorBasic(path){console.log('üîß Basic file loading for:',path);try{const response=await fetch(`${this.apiBase}/template-content/${encodeURIComponent(path)}`,{headers:{'X-CSRFToken': this.getCSRFToken()}});if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`);}const data=await response.json();if(data.success&&window.editor){const{bodyHtml,cssContent}=this.parseBasicHTML(data.content);window.editor.setComponents('');window.editor.setStyle('');if(bodyHtml){window.editor.setComponents(bodyHtml);}if(cssContent){window.editor.setStyle(cssContent);}this.showNotification('–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω(–±–∞–∑–æ–≤—ã–π —Ä–µ–∂–∏–º)','warning');this.close();}else{throw new Error(data.error||'Failed to load template');}}catch(error){console.error('‚ùå Basic loading failed:',error);throw error;}}cleanJinjaFromHTML(htmlContent){return htmlContent .replace(/\{\{\s*url_for\(\s*['"]static['"],?\s*filename\s*=\s*['"]([^'"]+)['"]\s*\)\s*\}\}/g,'/static/$1').replace(/\{\{\s*url_for\(\s*['"]static['"],?\s*filename=['"]([^'"]+)['"]\s*\)\s*\}\}/g,'/static/$1').replace(/\{\%\s*.*?\s*\%\}/g,'').replace(/\{\{\s*[^}]*\s*\}\}/g,'').replace(/\{\%\s*if\s+.*?\%\}[\s\S]*?\{\%\s*endif\s*\%\}/g,'').replace(/\{\%\s*for\s+.*?\%\}[\s\S]*?\{\%\s*endfor\s*\%\}/g,'').replace(/href\s*=\s*["']\s*["']/g,'href="#"').replace(/src\s*=\s*["']\s*["']/g,'src="#"').replace(/action\s*=\s*["']\s*["']/g,'action="#"');}parseBasicHTML(htmlContent){const cleanedHtml=this.cleanJinjaFromHTML(htmlContent);const parser=new DOMParser();const doc=parser.parseFromString(cleanedHtml,'text/html');let cssContent='';let bodyHtml='';const styleTags=doc.querySelectorAll('style');styleTags.forEach(style=>{cssContent+=style.textContent+'\n';});if(doc.body){bodyHtml=doc.body.innerHTML;}return{bodyHtml,cssContent};}updateTemplateSelector(path){const selectedTemplate=document.getElementById('selected-template');if(selectedTemplate){const fileName=path.split('/').pop();selectedTemplate.textContent=fileName;selectedTemplate.title=path;}const editorTitle=document.querySelector('.editor-title');if(editorTitle){editorTitle.textContent=`–†–µ–¥–∞–∫—Ç–æ—Ä: ${path}`;}}enableEditorControls(){const controlButtons=[ 'save-btn','preview-btn','undo-btn','redo-btn','clear-btn' ];controlButtons.forEach(btnId=>{const btn=document.getElementById(btnId);if(btn){btn.disabled=false;btn.classList.remove('disabled');}});this.updateEditorStatus('ready','–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω-–≥–æ—Ç–æ–≤ –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é');}updateEditorStatus(type,message){const statusDot=document.getElementById('status-dot');const statusText=document.getElementById('status-text');if(statusDot&&statusText){statusDot.classList.remove('loading','ready','error','saving');statusDot.classList.add(type);statusText.textContent=message;}}async openVisualEditor(filePath){try{console.log('üé® Opening visual editor for:',filePath);const response=await fetch(`${this.apiBase}/template-content/${encodeURIComponent(filePath)}`);const data=await response.json();if(!data.success){throw new Error(data.message);}this.close();this.openGrapesJSEditor(filePath,data.content,{name: filePath.split('/').pop()});}catch(error){console.error('‚ùå Error opening visual editor:',error);alert(`–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞: ${error.message}`);}}openGrapesJSEditor(filePath,htmlContent,fileInfo){const editorModal=document.createElement('div');editorModal.className='modal fade';editorModal.id='visualEditorModal';editorModal.setAttribute('data-bs-backdrop','static');editorModal.innerHTML=`<div class="modal-dialog modal-fullscreen"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title"><i class="fas fa-palette me-2"></i>–í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä-${fileInfo.name}</h5><div class="header-actions"><button class="btn btn-light btn-sm me-2" id="save-visual-changes"><i class="fas fa-save"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="btn btn-light btn-sm me-2" id="preview-page"><i class="fas fa-eye"></i>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button><button class="btn btn-outline-light btn-sm" data-bs-dismiss="modal"><i class="fas fa-times"></i>–ó–∞–∫—Ä—ã—Ç—å</button></div></div><div class="modal-body p-0"><div id="visual-editor-container" style="height: calc(100vh-120px);"></div></div></div></div>`;document.body.appendChild(editorModal);const modal=new bootstrap.Modal(editorModal);modal.show();setTimeout(async()=>{await this.initGrapesJS(filePath,htmlContent,fileInfo);},500);editorModal.addEventListener('hidden.bs.modal',()=>{if(this.visualEditor){this.visualEditor.destroy();this.visualEditor=null;}editorModal.remove();});}async initGrapesJS(filePath,htmlContent,fileInfo){const container=document.getElementById('visual-editor-container');if(!container){console.error('‚ùå Visual editor container not found');return;}const{bodyHtml,cssContent,externalStyles,externalScripts}=this.parseFullHTMLContent(htmlContent);this.visualEditor=grapesjs.init({container: '#visual-editor-container',width: '100%',height: '100%',storageManager: false,panels:{defaults: [{id: 'basic-actions',el: '.panel__basic-actions',buttons: [{id: 'visibility',active: true,className: 'btn-toggle-borders',label: '<i class="fas fa-border-style"></i>',command: 'sw-visibility',},{id: 'export',className: 'btn-open-export',label: '<i class="fas fa-code"></i>',command: 'export-template',context: 'export-template',},{id: 'show-json',className: 'btn-show-json',label: '<i class="fas fa-file-code"></i>',context: 'show-json',command(editor){editor.Modal.setTitle('Components JSON').setContent(`<textarea style="width:100%;height: 250px;">${JSON.stringify(editor.getComponents(),null,2)}</textarea>`).open();},}],},{id: 'panel-devices',el: '.panel__devices',buttons: [{id: 'device-desktop',label: '<i class="fas fa-desktop"></i>',command: 'set-device-desktop',active: true,},{id: 'device-tablet',label: '<i class="fas fa-tablet-alt"></i>',command: 'set-device-tablet',},{id: 'device-mobile',label: '<i class="fas fa-mobile-alt"></i>',command: 'set-device-mobile',},],},]},deviceManager:{devices: [{name: 'Desktop',width: '',},{name: 'Tablet',width: '768px',widthMedia: '992px',},{name: 'Mobile',width: '320px',widthMedia: '768px',},]},blockManager:{appendTo: '.blocks-container',blocks: [{id: 'section',label: 'Section',content: `<section class="section"><div class="container"><div class="row"><div class="col"><h2>New Section</h2><p>Start editing this section...</p></div></div></div></section>`,category: 'Layout',media: '<i class="fas fa-square"></i>'},{id: 'text',label: 'Text',content: '<div data-gjs-type="text">Insert your text here</div>',category: 'Basic',media: '<i class="fas fa-font"></i>'},{id: 'image',label: 'Image',content:{type: 'image'},category: 'Basic',media: '<i class="fas fa-image"></i>'},{id: 'button',label: 'Button',content: '<a class="btn btn-primary">Click me</a>',category: 'Basic',media: '<i class="fas fa-hand-pointer"></i>'},{id: 'dental-hero',label: 'Dental Hero',content: `<section class="hero-section bg-primary text-white py-5"><div class="container"><div class="row align-items-center"><div class="col-md-6"><h1 class="display-4 fw-bold">–í–∞—à–∞ —É–ª—ã–±–∫–∞-–Ω–∞—à–∞ –∑–∞–±–æ—Ç–∞</h1><p class="lead">–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º –ø–æ–¥—Ö–æ–¥–æ–º</p><a href="#" class="btn btn-light btn-lg">–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –ø—Ä–∏–µ–º</a></div><div class="col-md-6"><img src="/static/images/dental-hero.jpg" class="img-fluid rounded" alt="–°—Ç–æ–º–∞—Ç–æ–ª–æ–≥–∏—è"></div></div></div></section>`,category: 'Dental',media: '<i class="fas fa-tooth"></i>'},{id: 'services-grid',label: 'Services Grid',content: `<section class="services-section py-5"><div class="container"><h2 class="text-center mb-5">–ù–∞—à–∏ —É—Å–ª—É–≥–∏</h2><div class="row"><div class="col-md-4 mb-4"><div class="service-card text-center p-4 border rounded"><i class="fas fa-tooth fa-3x text-primary mb-3"></i><h4>–õ–µ—á–µ–Ω–∏–µ –∫–∞—Ä–∏–µ—Å–∞</h4><p>–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –ª–µ—á–µ–Ω–∏—è –∫–∞—Ä–∏–µ—Å–∞</p></div></div><div class="col-md-4 mb-4"><div class="service-card text-center p-4 border rounded"><i class="fas fa-smile fa-3x text-primary mb-3"></i><h4>–û—Ç–±–µ–ª–∏–≤–∞–Ω–∏–µ</h4><p>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ—Ç–±–µ–ª–∏–≤–∞–Ω–∏–µ –∑—É–±–æ–≤</p></div></div><div class="col-md-4 mb-4"><div class="service-card text-center p-4 border rounded"><i class="fas fa-user-md fa-3x text-primary mb-3"></i><h4>–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</h4><p>–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞</p></div></div></div></div></section>`,category: 'Dental',media: '<i class="fas fa-th"></i>'}]},styleManager:{appendTo: '.styles-container',},layerManager:{appendTo: '.layers-container'},canvas:{styles: [ 'https: 'https: ],scripts: [ 'https: ]}});this.visualEditor.setComponents(bodyHtml);this.visualEditor.setStyle(cssContent);if(externalStyles.length>0||externalScripts.length>0){console.log('üîß Loading external resources:',{styles: externalStyles.length,scripts: externalScripts.length});await this.loadExternalResources(this.visualEditor,externalStyles,externalScripts);}this.setupDeviceCommands();this.setupSaveEvents(filePath,fileInfo);console.log('‚úÖ GrapesJS Visual Editor initialized');}parseHTMLContent(htmlContent){const parser=new DOMParser();const doc=parser.parseFromString(htmlContent,'text/html');let cssContent='';const styleTags=doc.querySelectorAll('style');styleTags.forEach(style=>{cssContent+=style.textContent+'\n';});const bodyContent=doc.body ? doc.body.innerHTML : htmlContent;return{bodyHtml: bodyContent,cssContent: cssContent};}parseFullHTMLContent(htmlContent){const cleanedHtml=this.cleanJinjaFromHTML(htmlContent);const parser=new DOMParser();const doc=parser.parseFromString(cleanedHtml,'text/html');let cssContent='';const styleTags=doc.querySelectorAll('style');styleTags.forEach(style=>{cssContent+=style.textContent+'\n';});let jsContent='';const scriptTags=doc.querySelectorAll('script');scriptTags.forEach(script=>{if(script.textContent.trim()){jsContent+=script.textContent+'\n';}});const externalStyles=[];const linkTags=doc.querySelectorAll('link[rel="stylesheet"]');linkTags.forEach(link=>{const href=link.href;if(href&&!href.includes('{{')&&!href.includes('}}')&&!href.includes('url_for')&&!href.includes('%7B%7B')&&!href.includes('%7D%7D')&&href!=='#'&&href!==window.location.href){try{new URL(href);externalStyles.push(href);}catch(e){console.warn('‚ö†Ô∏è Skipping invalid CSS URL:',href);}}else{console.warn('‚ö†Ô∏è Skipping Jinja2 template or invalid URL in CSS:',href);}});const externalScripts=[];const externalScriptTags=doc.querySelectorAll('script[src]');externalScriptTags.forEach(script=>{const src=script.src;if(src&&!src.includes('{{')&&!src.includes('}}')&&!src.includes('%7B%7B')&&!src.includes('%7D%7D')&&src!=='#'&&src!==window.location.href){externalScripts.push(src);}else{console.warn('‚ö†Ô∏è Skipping Jinja2 template or invalid URL in script:',src);}});const bodyContent=doc.body ? doc.body.innerHTML : htmlContent;return{bodyHtml: bodyContent,cssContent: cssContent,jsContent: jsContent,externalStyles: externalStyles,externalScripts: externalScripts};}async loadExternalResources(editor,externalStyles,externalScripts){if(externalStyles.length>0){console.log('üé® Loading external styles through ExternalCSSLoader...');try{if(!window.ExternalCSSLoader){console.warn('‚ö†Ô∏è ExternalCSSLoader not available,falling back to basic loading');this.loadExternalResourcesBasic(editor,externalStyles,externalScripts);return;}const cssLoader=new window.ExternalCSSLoader(editor);const cssHTML=externalStyles.map(url=>`<link rel="stylesheet" href="${url}">`).join('\n');await cssLoader.loadExternalCSSFromHTML(cssHTML);console.log('‚úÖ External CSS loaded through ExternalCSSLoader');}catch(error){console.warn('‚ö†Ô∏è ExternalCSSLoader failed,falling back to basic loading:',error);this.loadExternalResourcesBasic(editor,externalStyles,externalScripts);}}this.loadExternalScripts(editor,externalScripts);}loadExternalResourcesBasic(editor,externalStyles,externalScripts){if(externalStyles.length>0){try{const canvas=editor.Canvas.getFrameEl();if(canvas&&canvas.contentDocument){const canvasDoc=canvas.contentDocument;const head=canvasDoc.head;externalStyles.forEach(styleUrl=>{if(styleUrl&&!styleUrl.includes('{{')&&!styleUrl.includes('}}')&&!styleUrl.includes('%7B%7B')&&!styleUrl.includes('%7D%7D')&&styleUrl!=='#'&&styleUrl!==window.location.href){const link=canvasDoc.createElement('link');link.rel='stylesheet';link.href=styleUrl;link.onload=()=>console.log('‚úÖ External CSS loaded in canvas:',styleUrl);link.onerror=()=>console.warn('‚ùå Failed to load external CSS in canvas:',styleUrl);head.appendChild(link);}else{console.warn('‚ö†Ô∏è Skipping invalid style URL in editor:',styleUrl);}});}}catch(error){console.warn('‚ö†Ô∏è Could not load external styles:',error);}}this.loadExternalScripts(editor,externalScripts);}loadExternalScripts(editor,externalScripts){if(externalScripts.length>0){try{const canvas=editor.Canvas.getFrameEl();if(canvas&&canvas.contentDocument){const canvasDoc=canvas.contentDocument;const body=canvasDoc.body;externalScripts.forEach(scriptUrl=>{if(scriptUrl&&!scriptUrl.includes('{{')&&!scriptUrl.includes('}}')&&!scriptUrl.includes('%7B%7B')&&!scriptUrl.includes('%7D%7D')&&scriptUrl!=='#'&&scriptUrl!==window.location.href){const script=canvasDoc.createElement('script');script.src=scriptUrl;script.onload=()=>console.log('‚úÖ External script loaded in canvas:',scriptUrl);script.onerror=()=>console.warn('‚ùå Failed to load external script in canvas:',scriptUrl);body.appendChild(script);}else{console.warn('‚ö†Ô∏è Skipping invalid script URL in editor:',scriptUrl);}});}}catch(error){console.warn('‚ö†Ô∏è Could not load external scripts:',error);}}}loadJavaScript(editor,jsContent){if(!jsContent.trim())return;try{const scriptElement=document.createElement('script');scriptElement.textContent=jsContent;const canvas=editor.Canvas.getFrameEl();if(canvas&&canvas.contentDocument){const canvasDoc=canvas.contentDocument;const canvasScript=canvasDoc.createElement('script');canvasScript.textContent=jsContent;canvasDoc.body.appendChild(canvasScript);}console.log('‚úÖ JavaScript loaded in editor');}catch(error){console.warn('‚ö†Ô∏è Warning: Could not load JavaScript in editor:',error);}}setupDeviceCommands(){this.visualEditor.Commands.add('set-device-desktop',{run: editor=>editor.setDevice('Desktop')});this.visualEditor.Commands.add('set-device-tablet',{run: editor=>editor.setDevice('Tablet')});this.visualEditor.Commands.add('set-device-mobile',{run: editor=>editor.setDevice('Mobile')});}setupSaveEvents(filePath,fileInfo){const saveBtn=document.getElementById('save-visual-changes');const previewBtn=document.getElementById('preview-page');if(saveBtn){saveBtn.addEventListener('click',()=>{this.saveVisualChanges(filePath,fileInfo);});}if(previewBtn){previewBtn.addEventListener('click',()=>{this.previewVisualChanges();});}}async saveVisualChanges(filePath,fileInfo){if(!this.visualEditor)return;try{const saveBtn=document.getElementById('save-visual-changes');const originalText=saveBtn.innerHTML;saveBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';saveBtn.disabled=true;const htmlComponents=this.visualEditor.getHtml();const cssStyles=this.visualEditor.getCss();const fullHTML=this.buildFullHTML(htmlComponents,cssStyles,fileInfo);const response=await fetch(`${this.apiBase}/template-content/${encodeURIComponent(filePath)}`,{method: 'POST',headers:{'Content-Type': 'application/json','X-CSRFToken': this.getCSRFToken()},body: JSON.stringify({content: fullHTML})});const data=await response.json();if(!data.success){throw new Error(data.message);}this.showNotification('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!','success');console.log('‚úÖ Visual changes saved successfully');}catch(error){console.error('‚ùå Error saving visual changes:',error);this.showNotification(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`,'error');}finally{const saveBtn=document.getElementById('save-visual-changes');if(saveBtn){saveBtn.innerHTML='<i class="fas fa-save"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';saveBtn.disabled=false;}}}buildFullHTML(htmlComponents,cssStyles,fileInfo){const editor=window.editor;const externalStyles=editor?.getConfig()?.canvas?.styles||[];const externalScripts=editor?.getConfig()?.canvas?.scripts||[];const validStyles=externalStyles.filter(style=>style&&!style.includes('{{')&&!style.includes('}}'));const validScripts=externalScripts.filter(script=>script&&!script.includes('{{')&&!script.includes('}}'));const externalStylesHTML=validStyles .map(style=>`<link href="${style}" rel="stylesheet">`).join('\n ');const externalScriptsHTML=validScripts .map(script=>`<script src="${script}" async></script>`).join('\n ');return `<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>${fileInfo.name.replace('.html','')}</title><!--External Styles-->${externalStylesHTML}<!--Custom Styles--><style>${cssStyles}</style></head><body>${htmlComponents}<!--External Scripts-->${externalScriptsHTML}</body></html>`;}previewVisualChanges(){if(!this.visualEditor)return;const htmlComponents=this.visualEditor.getHtml();const cssStyles=this.visualEditor.getCss();const previewHTML=this.buildFullHTML(htmlComponents,cssStyles,{name: 'Preview'});const previewWindow=window.open('','_blank');this.writeToPreviewWindow(previewWindow,previewHTML);}async previewFullPage(filePath){try{const response=await fetch(`${this.apiBase}/template-content/${encodeURIComponent(filePath)}`);const data=await response.json();if(!data.success){throw new Error(data.message);}const previewWindow=window.open('','_blank');this.writeToPreviewWindow(previewWindow,data.content);}catch(error){console.error('‚ùå Error previewing page:',error);alert(`–û—à–∏–±–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞: ${error.message}`);}}async editTextFile(filePath){console.log('üìù Opening text editor for:',filePath);alert('–¢–µ–∫—Å—Ç–æ–≤—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');}async deleteFile(filePath){if(!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã,—á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª: ${filePath}?`)){return;}try{const response=await fetch(`${this.apiBase}/template-content/${encodeURIComponent(filePath)}`,{method: 'DELETE',headers:{'X-CSRFToken': this.getCSRFToken()}});const data=await response.json();if(!data.success){throw new Error(data.message);}this.loadCurrentPath();this.showNotification('–§–∞–π–ª —É–¥–∞–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ','success');}catch(error){console.error('‚ùå Error deleting file:',error);this.showNotification(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${error.message}`,'error');}}showNotification(message,type='info'){const notification=document.createElement('div');notification.className=`alert alert-${type==='error' ? 'danger' : type}alert-dismissible fade show position-fixed`;notification.style.cssText='top: 20px;right: 20px;z-index: 9999;min-width: 300px;';notification.innerHTML=` ${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;document.body.appendChild(notification);setTimeout(()=>{if(notification.parentNode){notification.remove();}},5000);}getCSRFToken(){return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')||'';}writeToPreviewWindow(previewWindow,htmlContent){try{const dataURL='data:text/html;charset=utf-8,'+encodeURIComponent(htmlContent);previewWindow.location.href=dataURL;console.log('‚úÖ Preview window updated using data URL(no document.write)');return;}catch(error){console.warn('‚ö†Ô∏è Data URL method failed,trying innerHTML:',error);}try{if(previewWindow&&previewWindow.document){previewWindow.document.open();previewWindow.document.close();const newDoc=previewWindow.document.implementation.createHTMLDocument('Preview');newDoc.documentElement.innerHTML=htmlContent;previewWindow.document.replaceChild(previewWindow.document.importNode(newDoc.documentElement,true),previewWindow.document.documentElement);console.log('‚úÖ Preview window updated safely with innerHTML');return;}}catch(error){console.warn('‚ö†Ô∏è innerHTML method failed:',error);}try{console.warn('‚ö†Ô∏è Using document.write as last resort');previewWindow.document.open();previewWindow.document.write(htmlContent);previewWindow.document.close();}catch(error){console.error('‚ùå All preview methods failed:',error);}}async saveEnhancedEditorChanges(filePath){const editor=window.editor;if(!editor){this.showNotification('–†–µ–¥–∞–∫—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω','error');return;}try{const htmlComponents=editor.getHtml();const cssStyles=editor.getCss();const fullHTML=this.buildFullHTML(htmlComponents,cssStyles,{name: filePath.split('/').pop()});const response=await fetch(`${this.apiBase}/template-content/${encodeURIComponent(filePath)}`,{method: 'POST',headers:{'Content-Type': 'application/json','X-CSRFToken': this.getCSRFToken()},body: JSON.stringify({content: fullHTML})});const data=await response.json();if(!data.success){throw new Error(data.message);}this.showNotification('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!','success');console.log('‚úÖ Enhanced editor changes saved successfully');}catch(error){console.error('‚ùå Error saving enhanced editor changes:',error);this.showNotification(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`,'error');}}}console.log('üîß FileExplorer class defined');window.fileExplorer=new FileExplorer();window.saveCurrentFile=()=>{if(window.fileExplorer&&window.fileExplorer.currentFile){window.fileExplorer.saveEnhancedEditorChanges(window.fileExplorer.currentFile);}else{console.warn('‚ö†Ô∏è No file is currently loaded for saving');}};console.log('‚úÖ FileExplorer class loaded and global instance created');