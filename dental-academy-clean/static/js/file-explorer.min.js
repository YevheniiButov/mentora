class FileExplorer{constructor(options={}){this.options={apiBase: '/api/content-editor',modalId: 'fileExplorerModal',...options};this.currentPath='';this.visualEditor=null;this.currentFile=null;this.apiBase=this.options.apiBase;this.fileLoader=null;this.init();this.initializeFileLoader();}init(){this.createModal();this.setupEventListeners();}initializeFileLoader(){const initLoader=()=>{if(window.editor&&window.editor.Canvas&&window.EnhancedFileLoader){try{this.fileLoader=new window.EnhancedFileLoader(window.editor);return true;}catch(error){console.error('❌ Error creating EnhancedFileLoader:',error);return false;}}return false;};if(!initLoader()){const checkInterval=setInterval(()=>{if(initLoader()){clearInterval(checkInterval);}},100);setTimeout(()=>{clearInterval(checkInterval);console.warn('⚠️ EnhancedFileLoader initialization timeout in FileExplorer');},10000);}}createModal(){const existingModal=document.getElementById(this.options.modalId);if(existingModal){existingModal.remove();}const modalHTML=`<div class="modal fade file-explorer-modal" id="${this.options.modalId}" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="fas fa-folder-open me-2"></i>Файловый проводник</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><!--Breadcrumbs навигация--><div class="path-breadcrumbs"><nav aria-label="breadcrumb"><ol class="breadcrumb mb-0"><li class="breadcrumb-item"><a href="#" data-path="">Корневая папка</a></li></ol></nav></div><!--Основной контейнер файлов--><div class="file-list"><div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>Загрузка файлов...</p></div></div><!--Контейнер для предпросмотра--><div class="file-preview" style="display: none;"><div class="preview-header"><h6>Предпросмотр файла</h6></div><pre><code></code></pre></div></div></div></div></div>`;document.body.insertAdjacentHTML('beforeend',modalHTML);this.modal=document.getElementById(this.options.modalId);}setupEventListeners(){this.modal.addEventListener('click',(e)=>{if(e.target.matches('.breadcrumb-item a')){e.preventDefault();const path=e.target.dataset.path||'';this.navigateTo(path);}});this.modal.addEventListener('click',(e)=>{const fileItem=e.target.closest('.file-item');if(!fileItem)return;const path=fileItem.dataset.path;if(!path)return;if(e.target.closest('.file-actions')){return;}if(fileItem.classList.contains('directory')){this.navigateTo(path);}else{const extension=path.toLowerCase().split('.').pop();if(extension==='html'||extension==='htm'){this.loadFileInEditor(path);}else{this.previewFile(path);}}});}open(){if(typeof bootstrap==='undefined'){console.error('❌ Bootstrap not loaded');alert('Bootstrap не загружен. Проверьте подключение скриптов.');return;}const modal=new bootstrap.Modal(this.modal);modal.show();this.navigateTo('');}close(){const modal=bootstrap.Modal.getInstance(this.modal);if(modal){modal.hide();}}async navigateTo(path){this.currentPath=path;try{await this.loadCurrentPath();this.updateBreadcrumbs();}catch(error){console.error('❌ Navigation error:',error);this.showNotification('Ошибка навигации: '+error.message,'error');}}async loadCurrentPath(){const fileList=this.modal.querySelector('.file-list');fileList.innerHTML=`<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i><p>Загрузка файлов...</p></div>`;try{const response=await fetch(`${this.apiBase}/file-explorer?path=${this.currentPath}`,{headers:{'X-CSRFToken': this.getCSRFToken()}});if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`);}const data=await response.json();if(data.success){this.displayFiles(data.files);}else{throw new Error(data.error||'Failed to load files');}}catch(error){console.error('Error loading files:',error);fileList.innerHTML=`<div class="text-center py-4"><i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i><p class="text-danger">Ошибка загрузки файлов</p><p class="text-muted">${error.message}</p></div>`;}}displayFiles(files){const fileList=this.modal.querySelector('.file-list');if(!fileList)return;if(!files||files.length===0){fileList.innerHTML=`<div class="text-center py-4"><i class="fas fa-folder-open fa-3x text-muted mb-3"></i><p class="text-muted">Папка пуста</p></div>`;return;}const sortedFiles=files.sort((a,b)=>{if(a.type==='directory'&&b.type==='file')return-1;if(a.type==='file'&&b.type==='directory')return 1;return a.name.localeCompare(b.name);});let filesHtml='<div class="file-grid">';sortedFiles.forEach(file=>{const isHTML=file.extension==='.html'||file.extension==='.htm';const isEditable=file.editable;filesHtml+=`<div class="file-item ${file.type}" data-path="${file.path}"><div class="file-icon">${this.getFileIcon(file)}</div><div class="file-info"><div class="file-name" title="${file.name}">${file.name}</div>${file.size ? `<div class="file-size">${this.formatFileSize(file.size)}</div>` : ''}</div><div class="file-actions">${isHTML ? `<button class="btn btn-sm btn-primary me-1" onclick="window.fileExplorer.openVisualEditor('${file.path}')" title="Визуальное редактирование"><i class="fas fa-palette"></i></button><button class="btn btn-sm btn-info me-1" onclick="window.fileExplorer.previewFullPage('${file.path}')" title="Предпросмотр страницы"><i class="fas fa-external-link-alt"></i></button>` : ''}${isEditable ? `<button class="btn btn-sm btn-outline-secondary me-1" onclick="window.fileExplorer.editTextFile('${file.path}')" title="Текстовое редактирование"><i class="fas fa-code"></i></button>` : ''}<button class="btn btn-sm btn-outline-danger" onclick="window.fileExplorer.deleteFile('${file.path}')" title="Удалить"><i class="fas fa-trash"></i></button></div></div>`;});filesHtml+='</div>';fileList.innerHTML=filesHtml;}getFileIcon(file){if(file.type==='directory'){return '<i class="fas fa-folder"></i>';}const extension=file.extension?.toLowerCase();switch(extension){case '.html': case '.htm': return '<i class="fas fa-file-code"></i>';case '.css': return '<i class="fas fa-file-code"></i>';case '.js': return '<i class="fas fa-file-code"></i>';case '.json': return '<i class="fas fa-file-code"></i>';case '.png': case '.jpg': case '.jpeg': case '.gif': case '.svg': return '<i class="fas fa-file-image"></i>';default: return '<i class="fas fa-file"></i>';}}formatFileSize(bytes){if(!bytes)return '';const sizes=['Bytes','KB','MB','GB'];const i=Math.floor(Math.log(bytes)/Math.log(1024));return Math.round(bytes/Math.pow(1024,i)*100)/100+' '+sizes[i];}updateBreadcrumbs(){const breadcrumb=this.modal.querySelector('.breadcrumb');const pathParts=this.currentPath.split('/').filter(part=>part);let breadcrumbHTML=`<li class="breadcrumb-item"><a href="#" data-path="">Корневая папка</a></li>`;let currentPath='';pathParts.forEach((part,index)=>{currentPath+=(currentPath ? '/' : '')+part;const isLast=index===pathParts.length-1;breadcrumbHTML+=`<li class="breadcrumb-item ${isLast ? 'active' : ''}">${isLast ? part : `<a href="#" data-path="${currentPath}">${part}</a>`}</li>`;});breadcrumb.innerHTML=breadcrumbHTML;}async previewFile(path){try{const response=await fetch(`${this.apiBase}/template-content/${encodeURIComponent(path)}`,{headers:{'X-CSRFToken': this.getCSRFToken()}});if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`);}const data=await response.json();if(data.success){const previewWindow=window.open('','_blank');this.writeToPreviewWindow(previewWindow,data.content);}else{throw new Error(data.error||'Failed to load template');}}catch(error){console.error('Error previewing file:',error);this.showNotification('Ошибка предпросмотра: '+error.message,'error');}}async loadFile(path){try{const response=await fetch(`${this.apiBase}/template-content/${encodeURIComponent(path)}`,{headers:{'X-CSRFToken': this.getCSRFToken()}});if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`);}const data=await response.json();if(data.success&&this.editor){this.editor.setComponents('');this.editor.setStyle('');if(data.content){this.editor.setComponents(data.content);}this.close();this.showNotification('Шаблон успешно загружен','success');const selectedTemplate=document.getElementById('selected-template');if(selectedTemplate){selectedTemplate.textContent=path.split('/').pop();}}else{throw new Error(data.error||'Failed to load template');}}catch(error){console.error('Error loading file:',error);this.showNotification('Ошибка загрузки: '+error.message,'error');}}async loadFileInEditor(path){try{if(!this.fileLoader){console.warn('⚠️ Enhanced File Loader not ready,falling back to basic loading');return this.loadFileInEditorBasic(path);}const result=await this.fileLoader.loadFile(path);if(result.success){this.showNotification('Файл успешно загружен в редактор','success');this.updateTemplateSelector(path);this.close();this.enableEditorControls();}else{throw new Error(result.error||'Failed to load file');}}catch(error){console.error('❌ Error loading file via Enhanced File Loader:',error);this.showNotification(`Ошибка загрузки: ${error.message}`,'error');try{await this.loadFileInEditorBasic(path);}catch(fallbackError){console.error('❌ Fallback loading also failed:',fallbackError);this.showNotification('Критическая ошибка загрузки файла','error');}}}async loadFileInEditorBasic(path){try{const response=await fetch(`${this.apiBase}/template-content/${encodeURIComponent(path)}`,{headers:{'X-CSRFToken': this.getCSRFToken()}});if(!response.ok){throw new Error(`HTTP ${response.status}: ${response.statusText}`);}const data=await response.json();if(data.success&&window.editor){const{bodyHtml,cssContent}=this.parseBasicHTML(data.content);window.editor.setComponents('');window.editor.setStyle('');if(bodyHtml){window.editor.setComponents(bodyHtml);}if(cssContent){window.editor.setStyle(cssContent);}this.showNotification('Файл загружен(базовый режим)','warning');this.close();}else{throw new Error(data.error||'Failed to load template');}}catch(error){console.error('❌ Basic loading failed:',error);throw error;}}cleanJinjaFromHTML(htmlContent){return htmlContent .replace(/\{\{\s*url_for\(\s*['"]static['"],?\s*filename\s*=\s*['"]([^'"]+)['"]\s*\)\s*\}\}/g,'/static/$1').replace(/\{\{\s*url_for\(\s*['"]static['"],?\s*filename=['"]([^'"]+)['"]\s*\)\s*\}\}/g,'/static/$1').replace(/\{\%\s*.*?\s*\%\}/g,'').replace(/\{\{\s*[^}]*\s*\}\}/g,'').replace(/\{\%\s*if\s+.*?\%\}[\s\S]*?\{\%\s*endif\s*\%\}/g,'').replace(/\{\%\s*for\s+.*?\%\}[\s\S]*?\{\%\s*endfor\s*\%\}/g,'').replace(/href\s*=\s*["']\s*["']/g,'href="#"').replace(/src\s*=\s*["']\s*["']/g,'src="#"').replace(/action\s*=\s*["']\s*["']/g,'action="#"');}parseBasicHTML(htmlContent){const cleanedHtml=this.cleanJinjaFromHTML(htmlContent);const parser=new DOMParser();const doc=parser.parseFromString(cleanedHtml,'text/html');let cssContent='';let bodyHtml='';const styleTags=doc.querySelectorAll('style');styleTags.forEach(style=>{cssContent+=style.textContent+'\n';});if(doc.body){bodyHtml=doc.body.innerHTML;}return{bodyHtml,cssContent};}updateTemplateSelector(path){const selectedTemplate=document.getElementById('selected-template');if(selectedTemplate){const fileName=path.split('/').pop();selectedTemplate.textContent=fileName;selectedTemplate.title=path;}const editorTitle=document.querySelector('.editor-title');if(editorTitle){editorTitle.textContent=`Редактор: ${path}`;}}enableEditorControls(){const controlButtons=[ 'save-btn','preview-btn','undo-btn','redo-btn','clear-btn' ];controlButtons.forEach(btnId=>{const btn=document.getElementById(btnId);if(btn){btn.disabled=false;btn.classList.remove('disabled');}});this.updateEditorStatus('ready','Файл загружен-готов к редактированию');}updateEditorStatus(type,message){const statusDot=document.getElementById('status-dot');const statusText=document.getElementById('status-text');if(statusDot&&statusText){statusDot.classList.remove('loading','ready','error','saving');statusDot.classList.add(type);statusText.textContent=message;}}async openVisualEditor(filePath){try{const response=await fetch(`${this.apiBase}/template-content/${encodeURIComponent(filePath)}`);const data=await response.json();if(!data.success){throw new Error(data.message);}this.close();this.openGrapesJSEditor(filePath,data.content,{name: filePath.split('/').pop()});}catch(error){console.error('❌ Error opening visual editor:',error);alert(`Ошибка открытия редактора: ${error.message}`);}}openGrapesJSEditor(filePath,htmlContent,fileInfo){const editorModal=document.createElement('div');editorModal.className='modal fade';editorModal.id='visualEditorModal';editorModal.setAttribute('data-bs-backdrop','static');editorModal.innerHTML=`<div class="modal-dialog modal-fullscreen"><div class="modal-content"><div class="modal-header bg-primary text-white"><h5 class="modal-title"><i class="fas fa-palette me-2"></i>Визуальный редактор-${fileInfo.name}</h5><div class="header-actions"><button class="btn btn-light btn-sm me-2" id="save-visual-changes"><i class="fas fa-save"></i>Сохранить</button><button class="btn btn-light btn-sm me-2" id="preview-page"><i class="fas fa-eye"></i>Предпросмотр</button><button class="btn btn-outline-light btn-sm" data-bs-dismiss="modal"><i class="fas fa-times"></i>Закрыть</button></div></div><div class="modal-body p-0"><div id="visual-editor-container" style="height: calc(100vh-120px);"></div></div></div></div>`;document.body.appendChild(editorModal);const modal=new bootstrap.Modal(editorModal);modal.show();setTimeout(async()=>{await this.initGrapesJS(filePath,htmlContent,fileInfo);},500);editorModal.addEventListener('hidden.bs.modal',()=>{if(this.visualEditor){this.visualEditor.destroy();this.visualEditor=null;}editorModal.remove();});}async initGrapesJS(filePath,htmlContent,fileInfo){const container=document.getElementById('visual-editor-container');if(!container){console.error('❌ Visual editor container not found');return;}const{bodyHtml,cssContent,externalStyles,externalScripts}=this.parseFullHTMLContent(htmlContent);this.visualEditor=grapesjs.init({container: '#visual-editor-container',width: '100%',height: '100%',storageManager: false,panels:{defaults: [{id: 'basic-actions',el: '.panel__basic-actions',buttons: [{id: 'visibility',active: true,className: 'btn-toggle-borders',label: '<i class="fas fa-border-style"></i>',command: 'sw-visibility',},{id: 'export',className: 'btn-open-export',label: '<i class="fas fa-code"></i>',command: 'export-template',context: 'export-template',},{id: 'show-json',className: 'btn-show-json',label: '<i class="fas fa-file-code"></i>',context: 'show-json',command(editor){editor.Modal.setTitle('Components JSON').setContent(`<textarea style="width:100%;height: 250px;">${JSON.stringify(editor.getComponents(),null,2)}</textarea>`).open();},}],},{id: 'panel-devices',el: '.panel__devices',buttons: [{id: 'device-desktop',label: '<i class="fas fa-desktop"></i>',command: 'set-device-desktop',active: true,},{id: 'device-tablet',label: '<i class="fas fa-tablet-alt"></i>',command: 'set-device-tablet',},{id: 'device-mobile',label: '<i class="fas fa-mobile-alt"></i>',command: 'set-device-mobile',},],},]},deviceManager:{devices: [{name: 'Desktop',width: '',},{name: 'Tablet',width: '768px',widthMedia: '992px',},{name: 'Mobile',width: '320px',widthMedia: '768px',},]},blockManager:{appendTo: '.blocks-container',blocks: [{id: 'section',label: 'Section',content: `<section class="section"><div class="container"><div class="row"><div class="col"><h2>New Section</h2><p>Start editing this section...</p></div></div></div></section>`,category: 'Layout',media: '<i class="fas fa-square"></i>'},{id: 'text',label: 'Text',content: '<div data-gjs-type="text">Insert your text here</div>',category: 'Basic',media: '<i class="fas fa-font"></i>'},{id: 'image',label: 'Image',content:{type: 'image'},category: 'Basic',media: '<i class="fas fa-image"></i>'},{id: 'button',label: 'Button',content: '<a class="btn btn-primary">Click me</a>',category: 'Basic',media: '<i class="fas fa-hand-pointer"></i>'},{id: 'dental-hero',label: 'Dental Hero',content: `<section class="hero-section bg-primary text-white py-5"><div class="container"><div class="row align-items-center"><div class="col-md-6"><h1 class="display-4 fw-bold">Ваша улыбка-наша забота</h1><p class="lead">Современная стоматология с индивидуальным подходом</p><a href="#" class="btn btn-light btn-lg">Записаться на прием</a></div><div class="col-md-6"><img src="/static/images/dental-hero.jpg" class="img-fluid rounded" alt="Стоматология"></div></div></div></section>`,category: 'Dental',media: '<i class="fas fa-tooth"></i>'},{id: 'services-grid',label: 'Services Grid',content: `<section class="services-section py-5"><div class="container"><h2 class="text-center mb-5">Наши услуги</h2><div class="row"><div class="col-md-4 mb-4"><div class="service-card text-center p-4 border rounded"><i class="fas fa-tooth fa-3x text-primary mb-3"></i><h4>Лечение кариеса</h4><p>Современные методы лечения кариеса</p></div></div><div class="col-md-4 mb-4"><div class="service-card text-center p-4 border rounded"><i class="fas fa-smile fa-3x text-primary mb-3"></i><h4>Отбеливание</h4><p>Профессиональное отбеливание зубов</p></div></div><div class="col-md-4 mb-4"><div class="service-card text-center p-4 border rounded"><i class="fas fa-user-md fa-3x text-primary mb-3"></i><h4>Консультация</h4><p>Бесплатная консультация специалиста</p></div></div></div></div></section>`,category: 'Dental',media: '<i class="fas fa-th"></i>'}]},styleManager:{appendTo: '.styles-container',},layerManager:{appendTo: '.layers-container'},canvas:{styles: [ 'https: 'https: ],scripts: [ 'https: ]}});this.visualEditor.setComponents(bodyHtml);this.visualEditor.setStyle(cssContent);if(externalStyles.length>0||externalScripts.length>0){await this.loadExternalResources(this.visualEditor,externalStyles,externalScripts);}this.setupDeviceCommands();this.setupSaveEvents(filePath,fileInfo);}parseHTMLContent(htmlContent){const parser=new DOMParser();const doc=parser.parseFromString(htmlContent,'text/html');let cssContent='';const styleTags=doc.querySelectorAll('style');styleTags.forEach(style=>{cssContent+=style.textContent+'\n';});const bodyContent=doc.body ? doc.body.innerHTML : htmlContent;return{bodyHtml: bodyContent,cssContent: cssContent};}parseFullHTMLContent(htmlContent){const cleanedHtml=this.cleanJinjaFromHTML(htmlContent);const parser=new DOMParser();const doc=parser.parseFromString(cleanedHtml,'text/html');let cssContent='';const styleTags=doc.querySelectorAll('style');styleTags.forEach(style=>{cssContent+=style.textContent+'\n';});let jsContent='';const scriptTags=doc.querySelectorAll('script');scriptTags.forEach(script=>{if(script.textContent.trim()){jsContent+=script.textContent+'\n';}});const externalStyles=[];const linkTags=doc.querySelectorAll('link[rel="stylesheet"]');linkTags.forEach(link=>{const href=link.href;if(href&&!href.includes('{{')&&!href.includes('}}')&&!href.includes('url_for')&&!href.includes('%7B%7B')&&!href.includes('%7D%7D')&&href!=='#'&&href!==window.location.href){try{new URL(href);externalStyles.push(href);}catch(e){console.warn('⚠️ Skipping invalid CSS URL:',href);}}else{console.warn('⚠️ Skipping Jinja2 template or invalid URL in CSS:',href);}});const externalScripts=[];const externalScriptTags=doc.querySelectorAll('script[src]');externalScriptTags.forEach(script=>{const src=script.src;if(src&&!src.includes('{{')&&!src.includes('}}')&&!src.includes('%7B%7B')&&!src.includes('%7D%7D')&&src!=='#'&&src!==window.location.href){externalScripts.push(src);}else{console.warn('⚠️ Skipping Jinja2 template or invalid URL in script:',src);}});const bodyContent=doc.body ? doc.body.innerHTML : htmlContent;return{bodyHtml: bodyContent,cssContent: cssContent,jsContent: jsContent,externalStyles: externalStyles,externalScripts: externalScripts};}async loadExternalResources(editor,externalStyles,externalScripts){if(externalStyles.length>0){try{if(!window.ExternalCSSLoader){console.warn('⚠️ ExternalCSSLoader not available,falling back to basic loading');this.loadExternalResourcesBasic(editor,externalStyles,externalScripts);return;}const cssLoader=new window.ExternalCSSLoader(editor);const cssHTML=externalStyles.map(url=>`<link rel="stylesheet" href="${url}">`).join('\n');await cssLoader.loadExternalCSSFromHTML(cssHTML);}catch(error){console.warn('⚠️ ExternalCSSLoader failed,falling back to basic loading:',error);this.loadExternalResourcesBasic(editor,externalStyles,externalScripts);}}this.loadExternalScripts(editor,externalScripts);}loadExternalResourcesBasic(editor,externalStyles,externalScripts){if(externalStyles.length>0){try{const canvas=editor.Canvas.getFrameEl();if(canvas&&canvas.contentDocument){const canvasDoc=canvas.contentDocument;const head=canvasDoc.head;externalStyles.forEach(styleUrl=>{if(styleUrl&&!styleUrl.includes('{{')&&!styleUrl.includes('}}')&&!styleUrl.includes('%7B%7B')&&!styleUrl.includes('%7D%7D')&&styleUrl!=='#'&&styleUrl!==window.location.href){const link=canvasDoc.createElement('link');link.rel='stylesheet';link.href=styleUrl;link.onload=()=>link.onerror=()=>console.warn('❌ Failed to load external CSS in canvas:',styleUrl);head.appendChild(link);}else{console.warn('⚠️ Skipping invalid style URL in editor:',styleUrl);}});}}catch(error){console.warn('⚠️ Could not load external styles:',error);}}this.loadExternalScripts(editor,externalScripts);}loadExternalScripts(editor,externalScripts){if(externalScripts.length>0){try{const canvas=editor.Canvas.getFrameEl();if(canvas&&canvas.contentDocument){const canvasDoc=canvas.contentDocument;const body=canvasDoc.body;externalScripts.forEach(scriptUrl=>{if(scriptUrl&&!scriptUrl.includes('{{')&&!scriptUrl.includes('}}')&&!scriptUrl.includes('%7B%7B')&&!scriptUrl.includes('%7D%7D')&&scriptUrl!=='#'&&scriptUrl!==window.location.href){const script=canvasDoc.createElement('script');script.src=scriptUrl;script.onload=()=>script.onerror=()=>console.warn('❌ Failed to load external script in canvas:',scriptUrl);body.appendChild(script);}else{console.warn('⚠️ Skipping invalid script URL in editor:',scriptUrl);}});}}catch(error){console.warn('⚠️ Could not load external scripts:',error);}}}loadJavaScript(editor,jsContent){if(!jsContent.trim())return;try{const scriptElement=document.createElement('script');scriptElement.textContent=jsContent;const canvas=editor.Canvas.getFrameEl();if(canvas&&canvas.contentDocument){const canvasDoc=canvas.contentDocument;const canvasScript=canvasDoc.createElement('script');canvasScript.textContent=jsContent;canvasDoc.body.appendChild(canvasScript);}}catch(error){console.warn('⚠️ Warning: Could not load JavaScript in editor:',error);}}setupDeviceCommands(){this.visualEditor.Commands.add('set-device-desktop',{run: editor=>editor.setDevice('Desktop')});this.visualEditor.Commands.add('set-device-tablet',{run: editor=>editor.setDevice('Tablet')});this.visualEditor.Commands.add('set-device-mobile',{run: editor=>editor.setDevice('Mobile')});}setupSaveEvents(filePath,fileInfo){const saveBtn=document.getElementById('save-visual-changes');const previewBtn=document.getElementById('preview-page');if(saveBtn){saveBtn.addEventListener('click',()=>{this.saveVisualChanges(filePath,fileInfo);});}if(previewBtn){previewBtn.addEventListener('click',()=>{this.previewVisualChanges();});}}async saveVisualChanges(filePath,fileInfo){if(!this.visualEditor)return;try{const saveBtn=document.getElementById('save-visual-changes');const originalText=saveBtn.innerHTML;saveBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i>Сохранение...';saveBtn.disabled=true;const htmlComponents=this.visualEditor.getHtml();const cssStyles=this.visualEditor.getCss();const fullHTML=this.buildFullHTML(htmlComponents,cssStyles,fileInfo);const response=await fetch(`${this.apiBase}/template-content/${encodeURIComponent(filePath)}`,{method: 'POST',headers:{'Content-Type': 'application/json','X-CSRFToken': this.getCSRFToken()},body: JSON.stringify({content: fullHTML})});const data=await response.json();if(!data.success){throw new Error(data.message);}this.showNotification('Изменения сохранены успешно!','success');}catch(error){console.error('❌ Error saving visual changes:',error);this.showNotification(`Ошибка сохранения: ${error.message}`,'error');}finally{const saveBtn=document.getElementById('save-visual-changes');if(saveBtn){saveBtn.innerHTML='<i class="fas fa-save"></i>Сохранить';saveBtn.disabled=false;}}}buildFullHTML(htmlComponents,cssStyles,fileInfo){const editor=window.editor;const externalStyles=editor?.getConfig()?.canvas?.styles||[];const externalScripts=editor?.getConfig()?.canvas?.scripts||[];const validStyles=externalStyles.filter(style=>style&&!style.includes('{{')&&!style.includes('}}'));const validScripts=externalScripts.filter(script=>script&&!script.includes('{{')&&!script.includes('}}'));const externalStylesHTML=validStyles .map(style=>`<link href="${style}" rel="stylesheet">`).join('\n ');const externalScriptsHTML=validScripts .map(script=>`<script src="${script}" async></script>`).join('\n ');return `<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>${fileInfo.name.replace('.html','')}</title><!--External Styles-->${externalStylesHTML}<!--Custom Styles--><style>${cssStyles}</style></head><body>${htmlComponents}<!--External Scripts-->${externalScriptsHTML}</body></html>`;}previewVisualChanges(){if(!this.visualEditor)return;const htmlComponents=this.visualEditor.getHtml();const cssStyles=this.visualEditor.getCss();const previewHTML=this.buildFullHTML(htmlComponents,cssStyles,{name: 'Preview'});const previewWindow=window.open('','_blank');this.writeToPreviewWindow(previewWindow,previewHTML);}async previewFullPage(filePath){try{const response=await fetch(`${this.apiBase}/template-content/${encodeURIComponent(filePath)}`);const data=await response.json();if(!data.success){throw new Error(data.message);}const previewWindow=window.open('','_blank');this.writeToPreviewWindow(previewWindow,data.content);}catch(error){console.error('❌ Error previewing page:',error);alert(`Ошибка предпросмотра: ${error.message}`);}}async editTextFile(filePath){alert('Текстовый редактор будет добавлен в следующем обновлении');}async deleteFile(filePath){if(!confirm(`Вы уверены,что хотите удалить файл: ${filePath}?`)){return;}try{const response=await fetch(`${this.apiBase}/template-content/${encodeURIComponent(filePath)}`,{method: 'DELETE',headers:{'X-CSRFToken': this.getCSRFToken()}});const data=await response.json();if(!data.success){throw new Error(data.message);}this.loadCurrentPath();this.showNotification('Файл удален успешно','success');}catch(error){console.error('❌ Error deleting file:',error);this.showNotification(`Ошибка удаления: ${error.message}`,'error');}}showNotification(message,type='info'){const notification=document.createElement('div');notification.className=`alert alert-${type==='error' ? 'danger' : type}alert-dismissible fade show position-fixed`;notification.style.cssText='top: 20px;right: 20px;z-index: 9999;min-width: 300px;';notification.innerHTML=` ${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;document.body.appendChild(notification);setTimeout(()=>{if(notification.parentNode){notification.remove();}},5000);}getCSRFToken(){return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')||'';}writeToPreviewWindow(previewWindow,htmlContent){try{const dataURL='data:text/html;charset=utf-8,'+encodeURIComponent(htmlContent);previewWindow.location.href=dataURL;return;}catch(error){console.warn('⚠️ Data URL method failed,trying innerHTML:',error);}try{if(previewWindow&&previewWindow.document){previewWindow.document.open();previewWindow.document.close();const newDoc=previewWindow.document.implementation.createHTMLDocument('Preview');newDoc.documentElement.innerHTML=htmlContent;previewWindow.document.replaceChild(previewWindow.document.importNode(newDoc.documentElement,true),previewWindow.document.documentElement);return;}}catch(error){console.warn('⚠️ innerHTML method failed:',error);}try{console.warn('⚠️ Using document.write as last resort');previewWindow.document.open();previewWindow.document.write(htmlContent);previewWindow.document.close();}catch(error){console.error('❌ All preview methods failed:',error);}}async saveEnhancedEditorChanges(filePath){const editor=window.editor;if(!editor){this.showNotification('Редактор не найден','error');return;}try{const htmlComponents=editor.getHtml();const cssStyles=editor.getCss();const fullHTML=this.buildFullHTML(htmlComponents,cssStyles,{name: filePath.split('/').pop()});const response=await fetch(`${this.apiBase}/template-content/${encodeURIComponent(filePath)}`,{method: 'POST',headers:{'Content-Type': 'application/json','X-CSRFToken': this.getCSRFToken()},body: JSON.stringify({content: fullHTML})});const data=await response.json();if(!data.success){throw new Error(data.message);}this.showNotification('Изменения сохранены успешно!','success');}catch(error){console.error('❌ Error saving enhanced editor changes:',error);this.showNotification(`Ошибка сохранения: ${error.message}`,'error');}}}window.fileExplorer=new FileExplorer();window.saveCurrentFile=()=>{if(window.fileExplorer&&window.fileExplorer.currentFile){window.fileExplorer.saveEnhancedEditorChanges(window.fileExplorer.currentFile);}else{console.warn('⚠️ No file is currently loaded for saving');}};