# –ù–æ–≤—ã–π Flow –¥–ª—è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–æ–≤—ã–π flow –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –ø–µ—Ä–µ–¥ –¥–æ—Å—Ç—É–ø–æ–º –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É.

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### 1. –ú–æ–¥–µ–ª—å User (`models.py`)

–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤–æ–µ –ø–æ–ª–µ:
```python
# Learning flow control
requires_diagnostic = db.Column(db.Boolean, default=True)  # Flag to redirect new users to diagnostic
```

### 2. DigiD –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (`routes/digid_routes.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `authenticate()`:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–∞–≥–∞ `requires_diagnostic`
- –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ `/big-diagnostic/choose-type`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π –∏–¥—É—Ç –Ω–∞ –∫–∞—Ä—Ç—É –æ–±—É—á–µ–Ω–∏—è

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `complete_registration()`:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–∞–≥–∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- –ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É

### 3. Dashboard (`routes/dashboard_routes.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `index()`:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–∞–≥–∞ `requires_diagnostic` –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å flash —Å–æ–æ–±—â–µ–Ω–∏–µ–º

### 4. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (`routes/diagnostic_routes.py`)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `show_results()`:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–≤–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ `requires_diagnostic = False`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ –æ–±—É—á–µ–Ω–∏—è
- –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ dashboard —Å –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ–º

## –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

–§–∞–π–ª: `migrations/versions/add_requires_diagnostic_field.py`

```python
def upgrade():
    # Add requires_diagnostic field to user table
    op.add_column('user', sa.Column('requires_diagnostic', sa.Boolean(), nullable=False, server_default='true'))

def downgrade():
    # Remove requires_diagnostic field from user table
    op.drop_column('user', 'requires_diagnostic')
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

–°–∫—Ä–∏–ø—Ç: `scripts/update_existing_users_diagnostic_flag.py`

```bash
python scripts/update_existing_users_diagnostic_flag.py
```

## –ù–æ–≤—ã–π Flow –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –î–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ DigiD** ‚Üí `/digid/login`
2. **–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è** ‚Üí `/digid/complete-registration`
3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–∞–≥–∞** ‚Üí `requires_diagnostic = True`
4. **–†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É** ‚Üí `/big-diagnostic/choose-type`
5. **–ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏** ‚Üí –í—ã–±–æ—Ä —Ç–∏–ø–∞ –∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞
6. **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏** ‚Üí –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –æ–±—É—á–µ–Ω–∏—è
7. **–†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ dashboard** ‚Üí `/dashboard` —Å –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ–º

### –î–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:

1. **–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É** ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–ª–∞–≥–∞ `requires_diagnostic`
2. **–ï—Å–ª–∏ –Ω–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏** ‚Üí –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
3. **–ï—Å–ª–∏ –µ—Å—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** ‚Üí –î–æ—Å—Ç—É–ø –∫ dashboard

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### 1. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
# –í production
flask db upgrade

# –ò–ª–∏ —á–µ—Ä–µ–∑ Python
python -c "from app import create_app; from models import db; app = create_app(); app.app_context().push(); db.create_all()"
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

```bash
python scripts/update_existing_users_diagnostic_flag.py
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ DigiD
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
3. –ü—Ä–æ–π—Ç–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –æ–±—É—á–µ–Ω–∏—è
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ dashboard

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏:

1. **–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:**
   - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É ‚úÖ

2. **–°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:**
   - –í—Ö–æ–¥ –≤ dashboard ‚Üí –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É ‚úÖ

3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π:**
   - –í—Ö–æ–¥ –≤ dashboard ‚Üí –î–æ—Å—Ç—É–ø –∫ dashboard ‚úÖ

4. **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:**
   - –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞ ‚Üí –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ ‚Üí –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ dashboard ‚úÖ

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã
- –ü—Ä–æ–≤–µ—Ä–∫–∞: —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Ñ–ª–∞–≥ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è
- –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –≤ —Ä–æ—É—Ç–∞—Ö

### 2. –û—à–∏–±–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞ –æ–±—É—á–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä–∫–∞: –ª–æ–≥–∏ –≤ `show_results()`
- –†–µ—à–µ–Ω–∏–µ: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –≤ –±–ª–æ–∫–µ try-catch

### 3. –ü—Ä–æ–±–ª–µ–º—ã —Å –º–∏–≥—Ä–∞—Ü–∏–µ–π
- –ü—Ä–æ–≤–µ—Ä–∫–∞: —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- –†–µ—à–µ–Ω–∏–µ: backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:

1. **–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**
   ```
   üîç DEBUG: User requires diagnostic - redirecting to diagnostic
   ```

2. **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:**
   ```
   üîç –û–¢–õ–ê–î–ö–ê: –≠—Ç–æ –ø–µ—Ä–≤–∞—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   üîç –û–¢–õ–ê–î–ö–ê: Learning plan created: {plan_id}
   ```

3. **–û—à–∏–±–∫–∏:**
   ```
   ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è learning plan: {error}
   ```

## –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

### 1. –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
flask db downgrade
```

### 2. –û—Ç–∫–∞—Ç –∫–æ–¥–∞

–í–µ—Ä–Ω—É—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–µ—Ä—Å–∏–∏ —Ñ–∞–π–ª–æ–≤:
- `models.py`
- `routes/digid_routes.py`
- `routes/dashboard_routes.py`
- `routes/diagnostic_routes.py`

---

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ  
**–î–∞—Ç–∞**: 2025-01-27  
**–í–µ—Ä—Å–∏—è**: 1.0 